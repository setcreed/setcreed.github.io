<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>k8s基本操作(简略) | 伊甸园</title><meta name="author" content="SetCreed"><meta name="copyright" content="SetCreed"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="1、kubeadm部署和rancher搭建服务器环境、kubeadm安装文档：https:&#x2F;&#x2F;kubernetes.io&#x2F;zh&#x2F;docs&#x2F; 常见的几种安装方式  1、手工把k8s各个组件下载下来，二进制安装和配置  2、使用kubeadm 工具（好比是写好的脚本）快速安装  3、使用类似rancher等工具可视化安装   机器：三台centos7.9 12345678910111213141516">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s基本操作(简略)">
<meta property="og:url" content="https://setcreed.github.io/posts/b404e8ed/index.html">
<meta property="og:site_name" content="伊甸园">
<meta property="og:description" content="1、kubeadm部署和rancher搭建服务器环境、kubeadm安装文档：https:&#x2F;&#x2F;kubernetes.io&#x2F;zh&#x2F;docs&#x2F; 常见的几种安装方式  1、手工把k8s各个组件下载下来，二进制安装和配置  2、使用kubeadm 工具（好比是写好的脚本）快速安装  3、使用类似rancher等工具可视化安装   机器：三台centos7.9 12345678910111213141516">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161954246.png">
<meta property="article:published_time" content="2022-02-24T15:38:07.000Z">
<meta property="article:modified_time" content="2022-02-24T15:38:07.000Z">
<meta property="article:author" content="SetCreed">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161954246.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://setcreed.github.io/posts/b404e8ed/index.html"><link rel="preconnect" href="//cdnjs.cloudflare.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.33/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章所描述的内容可能已经发生变化，请留意。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdnjs.cloudflare.com/ajax/libs/egjs-infinitegrid/4.11.1/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'k8s基本操作(简略)',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-02-24 23:38:07'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/custom/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/custom/icon.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="伊甸园" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/cloudnative/"><i class="fa-fw fas fa-cloud"></i><span> 云原生</span></a></li><li><a class="site-page child" href="/golang/"><i class="fa-fw fa-brands fa-golang"></i><span> Golang编程</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161954246.png')"><nav id="nav"><span id="blog-info"><a href="/" title="伊甸园"><span class="site-name">伊甸园</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/cloudnative/"><i class="fa-fw fas fa-cloud"></i><span> 云原生</span></a></li><li><a class="site-page child" href="/golang/"><i class="fa-fw fa-brands fa-golang"></i><span> Golang编程</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">k8s基本操作(简略)</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-02-24T15:38:07.000Z" title="发表于 2022-02-24 23:38:07">2022-02-24</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-02-24T15:38:07.000Z" title="更新于 2022-02-24 23:38:07">2022-02-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/k8s/">k8s</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>60分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="k8s基本操作(简略)"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="1、kubeadm部署和rancher搭建"><a href="#1、kubeadm部署和rancher搭建" class="headerlink" title="1、kubeadm部署和rancher搭建"></a>1、kubeadm部署和rancher搭建</h1><h2 id="服务器环境、kubeadm安装"><a href="#服务器环境、kubeadm安装" class="headerlink" title="服务器环境、kubeadm安装"></a>服务器环境、kubeadm安装</h2><p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/">https://kubernetes.io/zh/docs</a><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/">/</a></p>
<p>常见的几种安装方式</p>
<ul>
<li><p>1、手工把k8s各个组件下载下来，二进制安装和配置</p>
</li>
<li><p>2、使用kubeadm 工具（好比是写好的脚本）快速安装</p>
</li>
<li><p>3、使用类似rancher等工具可视化安装</p>
</li>
</ul>
<p>机器：三台centos7.9</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">增加普通用户，别tmd用root操作</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建用户 cwz。不要使用root赤裸裸操作服务器</span></span><br><span class="line">useradd cwz</span><br><span class="line">passwd cwz(自行输入密码）</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">给cwz赋予 sudo权限</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">vi /etc/sudoers   编辑这个文件</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">在这一行下加入</span></span><br><span class="line">root    ALL=(ALL)       ALL (这一行是原来有的)</span><br><span class="line">cwz  ALL=(ALL)       ALL （这一行是我们要加入的)</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">注意：保存的时候要键入 wq!  (因为这厮是只读文件)</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改主机名: hostnamectl</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改hosts文件。</span> </span><br><span class="line">sudo vi /etc/hosts # 给新主机增加127.0.0.1 。不然tmd 你去ping node1 显示的是局域网IP</span><br></pre></td></tr></table></figure>
<p>下载docker离线安装包<br>1、禁用 firewalld</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">systemctl stop firewalld &amp;&amp; systemctl disable firewalld</span><br></pre></td></tr></table></figure>
<p>2、禁用selinux (华为云 默认是禁用的，这步可以省略，getenforce 可以看状态。如果是开的，那么自行百度禁止掉)</p>
<p><a target="_blank" rel="noopener" href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/">https://download.docker.com/linux/centos/7/x86_64/stable/Packages/</a><br>目前我下载的是 19.03 版本 <a target="_blank" rel="noopener" href="https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-19.03.3-3.el7.x86_64.rpm">https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-19.03.3-3.el7.x86_64.rpm</a><br>下载好后 上传到 服务器上 你喜欢的位置（或者直接用wget 在服务器上下载，很快很丝滑)<br> 我的位置是 /home/cwz/tools/docker-ce-19.03.3-3.el7.x86_64.rpm<br>3、安装docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install docker-ce-19.03.3-3.el7.x86_64.rpm -y</span><br></pre></td></tr></table></figure>
<p> 耐心等待，不出意外 会出现2个错误：</p>
<ul>
<li>第一个错误： Requires: containerd.io &gt;= 1.2.2-3</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">我们可以到这里去下载 ：https://centos.pkgs.org/7/docker-ce-stable-x86_64/containerd.io-1.2.13-3.1.el7.x86_64.rpm.html （版本比它高是可以的）</span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">下载下来：</span></span><br><span class="line">wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/containerd.io-1.2.13-3.2.el7.x86_64.rpm</span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">手工安装：</span></span><br><span class="line">sudo yum install -y containerd.io-1.2.13-3.2.el7.x86_64.rpm</span><br></pre></td></tr></table></figure>
<ul>
<li>第二个错误： Requires: docker-ce-cli  </li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">于是我们 wget https://download.docker.com/linux/centos/7/x86_64/stable/Packages/docker-ce-cli-19.03.3-3.el7.x86_64.rpm</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">(注意：cli工具 要和 上面下载的docker-ce版本一致)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">接下来是安装cli:</span></span><br><span class="line">sudo yum install -y docker-ce-cli-19.03.3-3.el7.x86_64.rpm</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">搞定后，继续安装docker,也就是再执行一次：</span></span><br><span class="line">sudo yum install docker-ce-19.03.3-3.el7.x86_64.rpm -y</span><br></pre></td></tr></table></figure>
<p>4、设置用户组<br>docker安装时默认创建了docker用户组，将普通用户加入docker用户组就可以不使用sudo来操作docker</p>
<p>sudo usermod -aG docker  cwz<br>注意：光加入还不行，要么重新登录，要么执行  newgrp - docker  (改变当前用户的有效群组)</p>
<p>5、设置镜像加速：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;registry-mirrors&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;https://registry.docker-cn.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;https://cr.console.aliyun.com/&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;native.cgroupdriver=systemd&quot;</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>6、启动docker</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重启docker</span></span><br><span class="line">sudo systemctl daemon-reload  </span><br><span class="line">sudo systemctl restart docker </span><br></pre></td></tr></table></figure>
<p>安装 k8s文档：</p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/</a></p>
<p>使用国内源：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash"> <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span></span><br><span class="line">[kubernetes]</span><br><span class="line">name=Kubernetes</span><br><span class="line">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class="line">enabled=1</span><br><span class="line">gpgcheck=1</span><br><span class="line">repo_gpgcheck=1</span><br><span class="line">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class="line">        https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class="line">EOF</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash"><span class="string">yum makecache</span></span></span><br></pre></td></tr></table></figure>
<p>各个节点上都要执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install kubelet-1.18.6 kubeadm-1.18.6 kubectl-1.18.6</span><br></pre></td></tr></table></figure>
<p>搞定后 执行 rpm -aq kubelet kubectl kubeadm  看下列表，如果OK就是装好了</p>
<p>然后把kubelet 设置为开机启动</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl enable kubelet</span><br></pre></td></tr></table></figure>
<h2 id="kubeadm基本作用：初始化集群"><a href="#kubeadm基本作用：初始化集群" class="headerlink" title="kubeadm基本作用：初始化集群"></a>kubeadm基本作用：初始化集群</h2><p>kubeadm</p>
<p>主要有三个：Kubeadm init、kubeadm join、kubeadm token</p>
<ul>
<li>kubeadm init：集群的快速初始化，部署Master节点的各个组件</li>
<li>kubeadm join 节点加入到指定集群中</li>
<li>kubeadm token  管理用于加入集群时使用的认证令牌 (如list，create)</li>
<li>kubeadm reset 重置集群，如删除 构建文件以回到初始状态 </li>
</ul>
<p>使用systemd作为docker的cgroup driver</p>
<p>sudo vi /etc/docker/daemon.json  （没有则创建）</p>
<p> 加入</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">&quot;exec-opts&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="string">&quot;native.cgroupdriver=systemd&quot;</span><span class="punctuation">]</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>重启docker</p>
<p>systemctl daemon-reload  &amp;&amp; systemctl restart docker</p>
<p>确保执行这句命令docker info |grep Cgroup</p>
<p>出来的值是 systemd</p>
<p>关闭swap</p>
<p>1、暂时关闭SWAP，重启后恢复</p>
<p>  swapoff  -a</p>
<p>2、永久关闭SWAP</p>
<p>  sudo vi /etc/fstab</p>
<p>初始化集群：</p>
<p>在你 喜欢的机器上执行 (master)</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm init --kubernetes-version=v1.18.6 --image-repository registry.aliyuncs.com/google_containers</span><br></pre></td></tr></table></figure>
<p>关于token</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo kubeadm token list  #可以查看token 列表 </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">重新生成token (默认24小时有效期)</span></span><br><span class="line">sudo kubeadm token create  --print-join-command</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">其他节点加入（ 我们先不执行,先记下来）</span></span><br><span class="line">sudo kubeadm join 192.168.0.53:6443 --token yd38ha.1u9xsqsleyw7gjuc \</span><br><span class="line">    --discovery-token-ca-cert-hash sha256:2ef5f37cc530644ba1b6a5d99150af309e9c5d6a16933323ee18a7732811f3c1</span><br></pre></td></tr></table></figure>
<h2 id="安装网络组件（flannel）、加入子节点"><a href="#安装网络组件（flannel）、加入子节点" class="headerlink" title="安装网络组件（flannel）、加入子节点"></a>安装网络组件（flannel）、加入子节点</h2><p>CNI（Container Network Interface）</p>
<p>容器网络接口，为了让用户在容器创建或销毁时都能够更容易地配置容器网络。</p>
<p>常用的组件：</p>
<ul>
<li>Flannel(最基本的网络组件)</li>
<li>Calico(支持网络策略)</li>
<li>Canal（前两者的合体）</li>
<li>Weave（同样支持策略机制，还支持加密）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/202202242254358.png" alt=""></p>
<p>先采用flannel</p>
<p>github地址：<a target="_blank" rel="noopener" href="https://github.com/coreos/flannel">https</a><a target="_blank" rel="noopener" href="https://github.com/coreos/flannel">://</a><a target="_blank" rel="noopener" href="https://github.com/coreos/flannel">github.com/coreos/flannel</a></p>
<p>根据官网<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/，执行：">https://kubernetes.io/zh/docs/setup/production-environment/tools/kubeadm/install-kubeadm/，执行：</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">为了让你的 Linux 节点上的 iptables 能够正确地查看桥接流量，你需要确保在你的 sysctl 配置中将 net.bridge.bridge-nf-call-iptables 设置为 1</span></span><br><span class="line">sudo sysctl net.bridge.bridge-nf-call-iptables=1</span><br></pre></td></tr></table></figure>
<p>在主机上执行：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证</span></span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>
<p>可能有个错误：</p>
<p>failed to acquire lease: node “just1” pod cidr not assigned</p>
<p>通过执行kubectl —namespace kube-system logs kube-flannel-ds-2hpnq</p>
<p>可查看到 （我们需要和它一样的网段）</p>
<p>解决办法：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br><span class="line"></span><br><span class="line">在command节点 加入 </span><br><span class="line">- --allocate-node-cidrs=true</span><br><span class="line">- --cluster-cidr=10.244.0.0/16</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_">#</span><span class="language-bash">然后执行</span></span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<p>注意：可以借鉴完整的安装文档：<a target="_blank" rel="noopener" href="https://www.yuque.com/leifengyang/kubesphere/grw8se">https://www.yuque.com/leifengyang/kubesphere/grw8se</a></p>
<h2 id="kubernetes-dashboard部署"><a href="#kubernetes-dashboard部署" class="headerlink" title="kubernetes dashboard部署"></a>kubernetes dashboard部署</h2><p>概念：</p>
<p>官方提供的web管理界面,通过dashboard可以很方便地查看集群的各种资源.以及修改资源编排文件,对集群进行扩容操作,查看日志等</p>
<p>GitHub地址：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard">https://</a><a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard">github.com/kubernetes/dashboard</a></p>
<p>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.4/aio/deploy/recommended.yaml</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行完后 验证下</span> </span><br><span class="line">kubectl get pods --all-namespaces</span><br></pre></td></tr></table></figure>
<p>访问UI</p>
<p>kubectl proxy</p>
<p>kubectl proxy为访问k8s apiserver的REST api建立反代，提供统一入口进行访问控制、监控、管理，在代理中管理后端，在代理中进行认证等。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --address=0.0.0.0 --port=9090 --accept-hosts=<span class="string">&#x27;^*$&#x27;</span></span><br></pre></td></tr></table></figure>
<p>可以直接调用api</p>
<p><a target="_blank" rel="noopener" href="http://ip:9090/api/v1/namespaces/kube-system/services">http://ip:9090/api/v1/namespaces/kube-system/services</a></p>
<p>进入界面：</p>
<p><a target="_blank" rel="noopener" href="http://121.36.252.154:9090/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy">http://121.36.252.154:9090/api/v1/namespaces/kubernetes-dashboard/services/https:kubernetes-dashboard:/proxy</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/202202242255568.png" alt=""></p>
<p>创建对应的ServiceCount，对于文档：<a target="_blank" rel="noopener" href="https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md">https://github.com/kubernetes/dashboard/blob/master/docs/user/access-control/creating-sample-user.md</a></p>
<p>创建一个文件夹 譬如叫做/home/cwz/dashboard</p>
<p>创建2个文件 ,第一个db_account.yaml:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>
<p>第二个文件 db_role.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cluster-admin</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">admin-user</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br></pre></td></tr></table></figure>
<p>在/home/cwz/dashboard 下执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl apply -f .</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">然后再执行</span></span><br><span class="line">kubectl -n kubernetes-dashboard describe secret $(kubectl -n kubernetes-dashboard get secret | grep admin-user | awk &#x27;&#123;print $1&#125;&#x27;)</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">你会看到token</span></span><br></pre></td></tr></table></figure>
<p>不过到这一步还是不能登陆，因为默认只能localhost或127 能登陆</p>
<p>简单的解决方案是 直接暴露NodePort访问</p>
<p>创建文件 db_svc.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8443</span></span><br><span class="line">      <span class="attr">nodePort:</span> <span class="number">30043</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">kubernetes-dashboard</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>
<p>最后执行：kubectl apply -f .</p>
<h2 id="部署rancher作为管理系统（导入）"><a href="#部署rancher作为管理系统（导入）" class="headerlink" title="部署rancher作为管理系统（导入）"></a>部署rancher作为管理系统（导入）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo docker run -d --restart=unless-stopped -p 8080:80 -p 8443:443 -v /home/cwz/rancher:/var/lib/rancher/ rancher/rancher:v2.4.16</span><br></pre></td></tr></table></figure>
<p>别忘了 <strong>8080</strong> 和 <strong>8443</strong> 安全组开放</p>
<p>集群导入</p>
<p>设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create clusterrolebinding cluster-admin-binding --clusterrole cluster-admin --user kubernetes-admin(这个用户名要去配置文件找)</span><br></pre></td></tr></table></figure>
<p>根据提示设置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --insecure -sfL https://192.168.0.106:8443/v3/import/pclwnv429cf4fznp74vfrblsr9w9f4fdvv6gckmtzh6k4tslls66g5.yaml | kubectl apply -f -</span><br></pre></td></tr></table></figure>
<h2 id="修正、安装Helm、nginx-ingress"><a href="#修正、安装Helm、nginx-ingress" class="headerlink" title="修正、安装Helm、nginx-ingress"></a>修正、安装Helm、nginx-ingress</h2><p>rancher导入完集群，可能会有一些小坑</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161956594.png" alt=""></p>
<p>kubectl get cs —查看集群监控状况 </p>
<p>解决办法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在master</span></span><br><span class="line">sudo vi /etc/kubernetes/manifests/kube-scheduler.yaml</span><br><span class="line">sudo vi /etc/kubernetes/manifests/kube-controller-manager.yaml</span><br><span class="line"></span><br><span class="line">把 --port=0  删掉</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后重启</span></span><br><span class="line">systemctl restart kubelet</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/202202242256047.png" alt=""></p>
<p>可能需要去除maste节点污点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#去除污点NoSchedule，最后一个&quot;-&quot;代表删除</span></span><br><span class="line">kubectl taint nodes k8s-master node-role.kubernetes.io/master:NoSchedule-</span><br></pre></td></tr></table></figure>
<p>安装 helm</p>
<p><a target="_blank" rel="noopener" href="https://github.com/helm/helm/releases/tag/v3.4.0">https://github.com/helm/helm/releases/tag/v3.4.0</a></p>
<p>安装nginx-ingress：</p>
<p>使用老版本 nginx3.8.tar.gz</p>
<p>随便装一下：helm install my-nginx ingress-nginx/ingress-nginx </p>
<p>然后肯定会报错，然后 两条命令：</p>
<ul>
<li>kubectl logs pod名称</li>
<li>kubectl describe pod 你的pod名称 （这里会看到具体的错误）</li>
</ul>
<p>发现 k8s.gcr.io/ingress-nginx/controller:v0.41.0  这个镜像无法下载</p>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker pull giantswarm/ingress-nginx-controller:v0.41.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后改tag</span></span><br><span class="line">docker tag giantswarm/ingress-nginx-controller:v0.41.0 k8s.gcr.io/ingress-nginx/controller:v0.41.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删之前的tag </span></span><br><span class="line">docker rmi giantswarm/ingress-nginx-controller:v0.41.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后删掉刚才的安装  helm delete my-nginx ，然后再继续其他内容</span></span><br></pre></td></tr></table></figure>
<h1 id="2、k8s认证和授权"><a href="#2、k8s认证和授权" class="headerlink" title="2、k8s认证和授权"></a>2、k8s认证和授权</h1><h2 id="认识k8s的用户账号-生成证书"><a href="#认识k8s的用户账号-生成证书" class="headerlink" title="认识k8s的用户账号:生成证书"></a>认识k8s的用户账号:生成证书</h2><p>K8S里两种账户类型</p>
<p>UserCount ——- 用户账号</p>
<p>也就是集群外部访问时使用的用户。最常见的就是kubectl命令就是作为kubernetes-admin用户来执行，k8s本身不记录这些账号.</p>
<p>认证的方式: 先学习默认认证方式：客户端证书 </p>
<p>创建客户端证书</p>
<p>首先假设你装好了openssl (没装执行 sudo yum install openssl openssl-devel)</p>
<ul>
<li>创建一个文件夹叫做 ua/cwz</li>
<li>创建一个文件夹叫做 ua/cwz</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行：</span></span><br><span class="line">openssl genrsa -out client.key 2048    <span class="comment">#(这一步是生成客户端私钥)</span></span><br><span class="line">openssl req -new -key client.key -out client.csr -subj <span class="string">&quot;/CN=cwz&quot;</span></span><br><span class="line">  <span class="comment"># (根据私钥生成csr， /CN指定了用户名cwz)</span></span><br><span class="line"></span><br><span class="line">sudo openssl x509 -req -<span class="keyword">in</span> client.csr -CA /etc/kubernetes/pki/ca.crt -CAkey /etc/kubernetes/pki/ca.key -CAcreateserial -out client.crt -days 365</span><br><span class="line"><span class="comment"># (根据k8s的CA证书生成我们用户的客户端证书)</span></span><br></pre></td></tr></table></figure>
<h2 id="用户账号-2-使用证书初步请求API、设置上下文"><a href="#用户账号-2-使用证书初步请求API、设置上下文" class="headerlink" title="用户账号(2):使用证书初步请求API、设置上下文"></a>用户账号(2):使用证书初步请求API、设置上下文</h2><p>最简单的请求 方式还是：</p>
<ul>
<li>kubectl get endpoints 查看下endpoint</li>
<li>curl —cert ./client.crt —key ./client.key —cacert /etc/kubernetes/pki/ca.crt -s <a target="_blank" rel="noopener" href="https://192.168.0.53:6443/api">https://192.168.0.53:6443/api</a></li>
</ul>
<p>其中 可以用 —insecure 代替 —cacert /etc/kubernetes/pki/ca.crt 从而忽略服务端证书验证</p>
<p>证书反解：</p>
<p>如果你忘了证书设置的CN(Common name)是啥 可以用下面的命令搞定</p>
<p>openssl x509 -noout -subject -in client.crt</p>
<p>接下来要干的事情：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">把client.crt加入到~/.kube/config，执行kubectl命令时切换成我们的用户(虽然现在其实没啥权限)</span><br><span class="line"></span><br><span class="line">kubectl config --kubeconfig=/home/cwz/.kube/config set-credentials cwz  --client-certificate=/home/cwz/ua/cwz/client.crt --client-key=/home/cwz/ua/cwz/client.key</span><br><span class="line"><span class="comment"># 这一步把用户设置进去了</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个context(上下文)</span></span><br><span class="line">kubectl config --kubeconfig=/home/cwz/.kube/config set-context user_context --cluster=kubernetes  --user=cwz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定当前上下文是：</span></span><br><span class="line">kubectl config --kubeconfig=/home/cwz/.kube/config use-context user_context</span><br><span class="line"></span><br><span class="line">kubectl config current-context</span><br></pre></td></tr></table></figure>
<h2 id="入门Role和RoleBinding、创建一个角色"><a href="#入门Role和RoleBinding、创建一个角色" class="headerlink" title="入门Role和RoleBinding、创建一个角色"></a>入门Role和RoleBinding、创建一个角色</h2><p>我们把 cwz这个用户(usercount)加入到 kubectl config中</p>
<p>并且用了 kubectl config  use-context user_context 来切换上下文。</p>
<p>切回管理员可以这么干：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl config  use-context kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<p>相关概念：</p>
<ul>
<li>Role 角色：它可以包含一堆权限。用于授予对单个命名空间的资源访问</li>
<li>RoleBinding  顾名思义，将用户和角色进行绑定</li>
<li>kubectl get role —all-namespaces</li>
</ul>
<p>接下来我们要干的事</p>
<p>我们希望让cwz这个用户能查看pod </p>
<p>我们创建一个文件叫做：mypod_role.yaml</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kind: Role</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">metadata:</span><br><span class="line">  namespace: default</span><br><span class="line">  name: mypod</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">  resources: [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  verbs: [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>关于apiVersion 查文档：<a target="_blank" rel="noopener" href="https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#role-v1-rbac-authorization-k8s-io">https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#role-v1-rbac-authorization-k8s-io</a></p>
<p>关于资源，可以用 这个命令查看：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl api-resources -o wide</span><br></pre></td></tr></table></figure>
<p>譬如role有 对应的操作如下：</p>
<p>create delete deletecollection  get   list    patch    update  watch</p>
<p>创建  删除    批量删除     获取 列表  合并变更  更新   监听</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">执行下面的内容，则完成角色的创建</span><br><span class="line">kubectl apply -f mypod_role.yaml</span><br><span class="line"></span><br><span class="line">kubectl get role -n default ----查看下</span><br><span class="line"></span><br><span class="line">kubectl delete role mypod   (不加-n  默认就是default)</span><br></pre></td></tr></table></figure>
<h2 id="用户和角色进行绑定-RoleBinding"><a href="#用户和角色进行绑定-RoleBinding" class="headerlink" title="用户和角色进行绑定(RoleBinding)"></a>用户和角色进行绑定(RoleBinding)</h2><p>操作环境：</p>
<p>将node1上的kubeconfig文件拷贝到node2上，这样node2就是管理员账号了。</p>
<p>接下来我们来绑定</p>
<p>第一种方式： 命令行 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl create rolebinding mypodbinding  -n default  --role mypod --user cwz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接下来可以 切换</span></span><br><span class="line"><span class="comment"># 我们的普通用户是 </span></span><br><span class="line">kubectl config use-context user_context</span><br><span class="line"></span><br><span class="line"><span class="comment"># 管理员是: </span></span><br><span class="line">kubectl config use-context  kubernetes-admin@kubernetes</span><br></pre></td></tr></table></figure>
<p>第二种，创建一个文件 譬如叫做mypod_rolebinding.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypodrolebinding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cwz</span></span><br></pre></td></tr></table></figure>
<p>kubectl请求 apiServer时候会辨别出用户名是什么，然后根据名字去rolebinding中查找，如果查到有角色，再去匹配是否符合当前的操作</p>
<h2 id="ClusterRole和RoleBinding"><a href="#ClusterRole和RoleBinding" class="headerlink" title="ClusterRole和RoleBinding"></a>ClusterRole和RoleBinding</h2><p>可以管理集群中多个 namespace,就需要使用到clusterrole</p>
<p>绑定既可以使用RoleBinding，也可以使用ClusterRoleBinding ( 两者效果不同)</p>
<p>之前创建Role的文件:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>clustrole文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod-cluster</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;*&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;pods&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>之前创建的绑定：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypodrolebinding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cwz</span></span><br></pre></td></tr></table></figure>
<p>现在创建绑定，需要改一下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypodrolebinding-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod-cluster</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cwz</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kubectl get rolebinding -n kube-system</span><br><span class="line"></span><br><span class="line">kubectl delete rolebinding mypodrolebinding-cluster -n kube-system</span><br><span class="line"></span><br><span class="line">clusterrole+clusterrolebinding</span><br><span class="line"></span><br><span class="line">clusterrole+clusterrolebinding</span><br></pre></td></tr></table></figure>
<p>删掉之前创建的role、rolebinding</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 删除命令</span></span><br><span class="line">kubectl delete rolebinding mypodrolebinding-cluster -n kube-system</span><br><span class="line">kubectl delete rolebinding mypodrolebinding</span><br><span class="line">kubectl delete role mypod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 只保留一个 clusterrole --------mypod-cluster</span></span><br></pre></td></tr></table></figure>
<p>vim mypod-clusterrolebinding.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod-clusterrolebinding</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mypod-cluster</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"> <span class="bullet">-</span> <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">   <span class="attr">kind:</span> <span class="string">User</span></span><br><span class="line">   <span class="attr">name:</span> <span class="string">cwz</span></span><br></pre></td></tr></table></figure>
<h2 id="配置使用token的方式请求API-UserAccount"><a href="#配置使用token的方式请求API-UserAccount" class="headerlink" title="配置使用token的方式请求API(UserAccount)"></a>配置使用token的方式请求API(UserAccount)</h2><p>其实 假设我们要请求API， 还可以使用token的方式</p>
<p>curl <a target="_blank" rel="noopener" href="https://192.168.0.53:6443">https://192.168.0.53:6443</a>  这是不可以访问的</p>
<p>接下来我们设置一个 token</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 生成token</span></span><br><span class="line">   <span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">od</span> -An -t x | <span class="built_in">tr</span> -d <span class="string">&#x27; &#x27;</span>      <span class="comment"># (&#x27; &#x27;之间有个空格)</span></span><br><span class="line"></span><br><span class="line">kubectl config set-credentials cwz --token=4e2f6f4250a43ce94426b6264dad2609</span><br></pre></td></tr></table></figure>
<p>找个获取pod的api试一试</p>
<p><a target="_blank" rel="noopener" href="https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/">https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#</a><a target="_blank" rel="noopener" href="https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/">role-v1-rbac-authorization-k8s-io</a></p>
<p>curl -H “Authorization: Bearer 4e2f6f4250a43ce94426b6264dad2609” <a target="_blank" rel="noopener" href="https://192.168.0.53:6443/api/v1/namespaces/default/pods">https://192.168.0.53:6443/api/v1/namespaces/default/pods</a> —insecure</p>
<p>默认情况下还是没用的</p>
<p>curl —cert ./client.crt —key ./client.key —cacert /etc/kubernetes/pki/ca.crt -s <a target="_blank" rel="noopener" href="https://192.168.0.53:6443/api/v1/namespaces/default/pods">https://192.168.0.53:6443/api/v1/namespaces/default/pods</a></p>
<p>修改api-server的启动参数</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建</span></span><br><span class="line">sudo vi /etc/kubernetes/pki/token_auth </span><br><span class="line"><span class="comment"># 塞入如下内容</span></span><br><span class="line">4e2f6f4250a43ce94426b6264dad2609,cwz,1001</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后是修改api-server启动参数</span></span><br><span class="line"></span><br><span class="line">sudo vi /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">加入  --token-auth-file=/etc/kubernetes/pki/token_auth</span><br></pre></td></tr></table></figure>
<h2 id="ServiceAccount入门-1-创建账号"><a href="#ServiceAccount入门-1-创建账号" class="headerlink" title="ServiceAccount入门(1):创建账号"></a>ServiceAccount入门(1):创建账号</h2><p>创建一个ServiceAccount</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看 是这样的：</span></span><br><span class="line">kubectl get sa -n xxxx  (不写-n 就是默认default)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建</span></span><br><span class="line">kubectl  create  serviceaccount   mysa</span><br></pre></td></tr></table></figure>
<p>每个namespace都会有一个默认的 default账号，且sa局限在自己所属的namespace中。而UserAccount是可以跨ns的</p>
<p>kubectl describe sa mysa </p>
<p>k8s会在secrets 里面保存一个token</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161957790.png" alt=""></p>
<p>kubectl describe  secret mysa-token-bgh9b</p>
<p>也可以使用yaml方式创建：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  create  serviceaccount  mysa  -o  yaml  --dry-run=client</span><br></pre></td></tr></table></figure>
<p>进阶一下，可以这样：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  create  serviceaccount  mysa  -o  yaml  --dry-run=client &gt; mysa.yaml</span><br></pre></td></tr></table></figure>
<h2 id="ServiceAccount入门-2-赋予权限、外部访问API"><a href="#ServiceAccount入门-2-赋予权限、外部访问API" class="headerlink" title="ServiceAccount入门(2):赋予权限、外部访问API"></a>ServiceAccount入门(2):赋予权限、外部访问API</h2><p>使用之前创建的sa账号 mysa访问api</p>
<p>绑定角色 mypod-cluster：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 此权限可以查看pods列表</span></span><br><span class="line">kubectl create clusterrolebinding mysa-crb --clusterrole=mypod-cluster --serviceaccount=default:mysa</span><br></pre></td></tr></table></figure>
<p>装个工具 jq：是一个轻量级的json处理命令。可以对json数据进行分片、过滤、映射和转换 jq . 对json数据进行格式化输出</p>
<p>sudo yum install jq -y</p>
<p>分解命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#分解命令</span></span><br><span class="line">kubectl get sa  mysa</span><br><span class="line"></span><br><span class="line">kubectl get sa  mysa -o json</span><br><span class="line"></span><br><span class="line">kubectl get sa  mysa -o json | jq  <span class="string">&#x27;.secrets[0].name&#x27;</span></span><br><span class="line"></span><br><span class="line">kubectl get sa  mysa -o json | jq -Mr <span class="string">&#x27;.secrets[0].name&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 假设得到的值是mysa-token-vxwrn</span></span><br><span class="line"></span><br><span class="line">kubectl get secret  mysa-token-vxwrn</span><br><span class="line"></span><br><span class="line">kubectl get secret mysa-token-vxwrn -o json | jq -Mr <span class="string">&#x27;.data.token&#x27;</span></span><br><span class="line"></span><br><span class="line">kubectl get secret  mysa-token-vxwrn -o json | jq -Mr <span class="string">&#x27;.data.token&#x27;</span> | <span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure>
<p>连起来命令就是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret  $(kubectl get sa  mysa -o json | jq -Mr <span class="string">&#x27;.secrets[0].name&#x27;</span>) -o json | jq -Mr <span class="string">&#x27;.data.token&#x27;</span> | <span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 设置成一个变量</span></span><br><span class="line">mysatoken=$(kubectl get secret  $(kubectl get sa  mysa -o json | jq -Mr <span class="string">&#x27;.secrets[0].name&#x27;</span></span><br><span class="line">) -o json | jq -Mr <span class="string">&#x27;.data.token&#x27;</span> | <span class="built_in">base64</span> -d)</span><br><span class="line"></span><br><span class="line">curl -H <span class="string">&quot;Authorization: Bearer <span class="variable">$mysatoken</span>&quot;</span> --insecure  https://172.17.16.9:6443/api/v1/namespaces/default/pods </span><br></pre></td></tr></table></figure>
<h2 id="ServiceAccount入门-3-在POD里访问k8s-API-token的方式"><a href="#ServiceAccount入门-3-在POD里访问k8s-API-token的方式" class="headerlink" title="ServiceAccount入门(3):在POD里访问k8s API(token的方式)"></a>ServiceAccount入门(3):在POD里访问k8s API(token的方式)</h2><p>vim myngx.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxtest</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>
<p>kubectl apply -f .</p>
<p>接下来：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">kubectl get pod </span><br><span class="line"></span><br><span class="line">可以看到pod列表 ，然后我们 进入 该容器</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> -it  myngx-58bddf9b8d-qmdq7 -- sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$KUBERNETES_SERVICE_HOST</span>   </span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$KUBERNETES_PORT_443_TCP_PORT</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$KUBERNETES_SERVICE_HOST</span>:<span class="variable">$KUBERNETES_PORT_443_TCP_PORT</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161957773.png" alt=""></p>
<p>保存到环境变量中：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">TOKEN=`<span class="built_in">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/token`</span><br><span class="line"></span><br><span class="line">APISERVER=<span class="string">&quot;https://<span class="variable">$KUBERNETES_SERVICE_HOST</span>:<span class="variable">$KUBERNETES_PORT_443_TCP_PORT</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p>请求：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --header <span class="string">&quot;Authorization: Bearer <span class="variable">$TOKEN</span>&quot;</span> --insecure -s <span class="variable">$APISERVER</span>/api</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161957926.png" alt=""></p>
<p>我们可以看到 上面是可以的，但下面不可以，因为default账号没有列出pods的权限:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --header <span class="string">&quot;Authorization: Bearer <span class="variable">$TOKEN</span>&quot;</span> --insecure -s <span class="variable">$APISERVER</span>/api/v1/namespaces/default/pods</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161958007.png" alt=""></p>
<p>要修改myngx.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spec:</span></span><br><span class="line">     <span class="attr">serviceAccountName:</span> <span class="string">mysa</span></span><br><span class="line">     <span class="attr">containers:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxtest</span></span><br><span class="line">         <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">         <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">         <span class="attr">ports:</span></span><br></pre></td></tr></table></figure>
<p>加上 serviceAccountName: mysa</p>
<p>kubectl -apply -f .    更新deployment</p>
<h2 id="ServiceAccount入门-4-在POD里访问k8s-API-token-证书的方式"><a href="#ServiceAccount入门-4-在POD里访问k8s-API-token-证书的方式" class="headerlink" title="ServiceAccount入门(4):在POD里访问k8s API(token+证书的方式)"></a>ServiceAccount入门(4):在POD里访问k8s API(token+证书的方式)</h2><p>更常用的方式是直接用证书</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 证书的位置：</span></span><br><span class="line">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># token的位置</span></span><br><span class="line"><span class="built_in">cat</span> /var/run/secrets/kubernetes.io/serviceaccount/token</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">curl --header <span class="string">&quot;Authorization: Bearer <span class="variable">$T</span></span></span><br><span class="line"><span class="string">OKEN&quot;</span>  --cacert ./ca.crt   -s <span class="variable">$APISERVER</span>/api</span><br></pre></td></tr></table></figure>
<h1 id="3、Pod和deployment"><a href="#3、Pod和deployment" class="headerlink" title="3、Pod和deployment"></a>3、Pod和deployment</h1><h2 id="Pod入门、看文档的方式、创建Pod"><a href="#Pod入门、看文档的方式、创建Pod" class="headerlink" title="Pod入门、看文档的方式、创建Pod"></a>Pod入门、看文档的方式、创建Pod</h2><p>pod</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161959631.png" alt=""></p>
<p>好处：</p>
<ul>
<li>方便部署、扩展和收缩、方便调度等，反正各种方便</li>
<li>Pod中的容器共享数据和网络空间，统一的资源管理与分配（想想第二章我们讲的ServiceCount）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161959261.png" alt=""></p>
<p>pause容器作用</p>
<ul>
<li>扮演Pid=1的，回收僵尸进程</li>
<li>基于Linux的namespace的共享</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161959389.png" alt=""></p>
<p>文档：<a target="_blank" rel="noopener" href="https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#pod-v1-core">https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/#pod-v1-core</a></p>
<p>创建pod</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:1.18-alpine&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod xxxx  查看pod详细</span><br><span class="line"></span><br><span class="line">kubectl logs   xxx 查看日志</span><br><span class="line"></span><br><span class="line">kubectl <span class="built_in">exec</span> -it xxx  -- sh  //进入pod</span><br></pre></td></tr></table></figure>
<p>尝试多容器运行，想当然的改成如下的yaml文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:1.18-alpine&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;alpine:3.12&quot;</span></span><br></pre></td></tr></table></figure>
<p>但是不行，alpine没有启动成功。这是因为nginx容器内置了entrypoint，但是alpine没有。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:1.18-alpine&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&quot;alpine&quot;</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo this is second &amp;&amp; sleep 3600&quot;</span>]</span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;alpine:3.12&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="配置数据卷-挂载主机目录、排坑方式"><a href="#配置数据卷-挂载主机目录、排坑方式" class="headerlink" title="配置数据卷:挂载主机目录、排坑方式"></a>配置数据卷:挂载主机目录、排坑方式</h2><p>基本格式：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">……</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:1.18-alpine&quot;</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br></pre></td></tr></table></figure>
<p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">https://kubernetes.io/zh/docs/concepts/storage/volumes</a><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">/</a></p>
<p>最简单  常用的类型 hostPath</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311162000848.png" alt=""></p>
<p>基本写法：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>
<p>完整的</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:1.18-alpine&quot;</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo this is second &amp;&amp; sleep 360000&quot;</span>]</span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;alpine:3.12&quot;</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">    <span class="attr">hostPath:</span></span><br><span class="line">      <span class="attr">path:</span> <span class="string">/home/cwz/data</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>
<h2 id="Pod和Deployment基本区别、创建deployment"><a href="#Pod和Deployment基本区别、创建deployment" class="headerlink" title="Pod和Deployment基本区别、创建deployment"></a>Pod和Deployment基本区别、创建deployment</h2><p>Pods：</p>
<ul>
<li>运行一组容器 、适合一次性开发</li>
<li>很少直接用于生产</li>
</ul>
<p>Deployment</p>
<ul>
<li>运行一组相同的Pod（副本水平扩展）、滚动更新</li>
<li>适合生产</li>
</ul>
<p>总结为：Deployment通过副本集管理和创建POD。</p>
<p>deployment </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>
<h2 id="两个容器共享文件夹"><a href="#两个容器共享文件夹" class="headerlink" title="两个容器共享文件夹"></a>两个容器共享文件夹</h2><p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">https://</a><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/">kubernetes.io/zh/docs/concepts/storage/volumes/</a></p>
<p>两个节点分别写入挂载点</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">volumeMounts:</span><br><span class="line">    - name: sharedata</span><br><span class="line">      mountPath: /data</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">volumes:</span><br><span class="line">  - name:  sharedata</span><br><span class="line">    emptyDir: &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>同一个pod内的容器都能读写EmptyDir中 文件。常用于临时空间、多容器共享，如日志或者tmp文件需要的临时目录</p>
<p>完整版：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sharedata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">alpine:3.12</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo this is alpine &amp;&amp; sleep 36000&quot;</span>]</span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sharedata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sharedata</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h2 id="init容器的基本使用"><a href="#init容器的基本使用" class="headerlink" title="init容器的基本使用"></a>init容器的基本使用</h2><p>在启动之前希望把数据库启动，数据库可能不在一个pod里，如果数据库没有启动，那这个pod就没有启动的必要</p>
<p>Init 容器是一种特殊容器，在 Pod 内的应用容器启动之前运行。Init 容器可以包括一些应用镜像中不存在的实用工具和安装脚本</p>
<p>Init 容器与普通的容器非常像，除了如下两点：</p>
<ul>
<li>它们总是运行到完成</li>
<li>每个都必须在下一个启动之前成功完成</li>
</ul>
<p>如果 Pod 的 Init 容器失败，kubelet 会不断地重启该 Init 容器直到该容器成功为止。 然而，如果 Pod 对应的 restartPolicy 值为 “Never”，Kubernetes 不会重新启动 Pod</p>
<p>文档地址：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/workloads/pods/init-containers">https://kubernetes.io/zh/docs/concepts/workloads/pods/init-containers</a></p>
<p>基本配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">initContainers:</span><br><span class="line">  - name: init-mydb</span><br><span class="line">    image: alpine:3.12</span><br><span class="line">    command: [&#x27;sh&#x27;, &#x27;-c&#x27;, &#x27;echo wait for db &amp;&amp; sleep 35 &amp;&amp; echo done&#x27;]</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-mydb</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">alpine:3.12</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;echo wait for db &amp;&amp; sleep 35 &amp;&amp; echo done&#x27;</span>]</span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sharedata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">alpine:3.12</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo this is alpine &amp;&amp; sleep 36000&quot;</span>]</span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sharedata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">sharedata</span></span><br><span class="line">          <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<h1 id="4、Deployment和ConfigMap"><a href="#4、Deployment和ConfigMap" class="headerlink" title="4、Deployment和ConfigMap"></a>4、Deployment和ConfigMap</h1><h2 id="ConfigMap-1-基本创建、环境变量引用"><a href="#ConfigMap-1-基本创建、环境变量引用" class="headerlink" title="ConfigMap(1)基本创建、环境变量引用"></a>ConfigMap(1)基本创建、环境变量引用</h2><p>基本概念</p>
<ul>
<li>ConfigMap 是一种 API 对象，用来将非机密性的数据保存到健值对中。使用时可以用作环境变量、命令行参数或者存储卷中的配置文件。</li>
<li>ConfigMap 将您的环境配置信息和 容器镜像 解耦，便于应用配置的修改。当您需要储存机密信息时可以使用 Secret 对象。</li>
</ul>
<p>使用的场景：</p>
<ul>
<li>容器 entrypoint 的命令行参数</li>
<li>容器的环境变量</li>
<li>映射成文件</li>
<li>编写代码在 Pod 中运行，使用 Kubernetes API 来读取 ConfigMap</li>
</ul>
<p>基本命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 获取列表</span></span><br><span class="line">kubectl get cm</span><br></pre></td></tr></table></figure>
<p>创建一个cm </p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mycm</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="comment"># 每一个键对应一个简单的值,以字符串的形式体现</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line">  <span class="attr">userage:</span> <span class="string">&quot;19&quot;</span></span><br></pre></td></tr></table></figure>
<p>也可以这样，一键对应多行值</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line">  <span class="attr">userage:</span> <span class="string">&quot;19“</span></span><br><span class="line"><span class="string">  user.info: |</span></span><br><span class="line"><span class="string">    name=cwz</span></span><br><span class="line"><span class="string">    age=19</span></span><br></pre></td></tr></table></figure>
<p>删除之前的deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">env:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USER_NAME</span></span><br><span class="line">    <span class="attr">valueFrom:</span></span><br><span class="line">      <span class="attr">configMapKeyRef:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">mycm</span>           <span class="comment">#  ConfigMap的名称</span></span><br><span class="line">      <span class="attr">key:</span> <span class="string">username</span> <span class="comment"># 需要取值的键</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">testvalue</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USERNAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">mycm</span>           <span class="comment">#  ConfigMap的名称</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">username</span> <span class="comment"># 需要取值的键</span></span><br></pre></td></tr></table></figure>
<h2 id="ConfigMap-2-映射成单文件"><a href="#ConfigMap-2-映射成单文件" class="headerlink" title="ConfigMap(2)映射成单文件"></a>ConfigMap(2)映射成单文件</h2><p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes">https://</a><a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes">kubernetes.io/zh/docs/concepts/storage/volumes</a></p>
<p>挂载：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">    <span class="attr">mountPath:</span> <span class="string">/data</span></span><br></pre></td></tr></table></figure>
<p>写卷：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mycm</span></span><br><span class="line">    <span class="attr">items:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">user.info</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">user.txt</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">testvalue</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USERNAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">mycm</span>           <span class="comment">#  ConfigMap的名称</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">username</span> <span class="comment"># 需要取值的键</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mycm</span></span><br><span class="line">            <span class="attr">items:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">user.info</span></span><br><span class="line">                <span class="attr">path:</span> <span class="string">user.txt</span></span><br></pre></td></tr></table></figure>
<h2 id="ConfigMap-3-全部映射文件和subpath"><a href="#ConfigMap-3-全部映射文件和subpath" class="headerlink" title="ConfigMap(3)全部映射文件和subpath"></a>ConfigMap(3)全部映射文件和subpath</h2><p>如果我们不指定具体的key，像这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">  <span class="attr">configMap:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mycm</span></span><br></pre></td></tr></table></figure>
<p>这时你会发现，所有文件都被 映射进去了，文件名就是key名</p>
<p>现在需求：不指定key 。也想挂载其中一个配置</p>
<p>参考文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/volumes/#using-path">https://kubernetes.io/zh/docs/concepts/storage/volumes/#using-path</a></p>
<p>用于指定所引用的卷内的子路径，而不是其根路径</p>
<p>修改：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/data/user.txt</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">    <span class="attr">subPath:</span> <span class="string">user.info</span></span><br><span class="line"></span><br><span class="line"><span class="string">.....</span></span><br><span class="line"></span><br><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">mycm</span></span><br></pre></td></tr></table></figure>
<p>完整：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data/user.txt</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">user.info</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">testvalue</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USERNAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">mycm</span>           <span class="comment">#  ConfigMap的名称</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">username</span> <span class="comment"># 需要取值的键</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0655</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mycm</span></span><br><span class="line"><span class="comment">#            items:</span></span><br><span class="line"><span class="comment">#              - key: user.info</span></span><br><span class="line"><span class="comment">#                path: user.txt</span></span><br></pre></td></tr></table></figure>
<h2 id="ConfigMap：用程序读取-体外"><a href="#ConfigMap：用程序读取-体外" class="headerlink" title="ConfigMap：用程序读取(体外)"></a>ConfigMap：用程序读取(体外)</h2><p>体外：就是程序在k8s集群外</p>
<p>体内：就是程序在k8s集群内部pod在一起</p>
<p>开启api代理：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl proxy --address=<span class="string">&#x27;0.0.0.0&#x27;</span> --accept-hosts=<span class="string">&#x27;^*$&#x27;</span> --port=8009</span><br></pre></td></tr></table></figure>
<p>8009请自行安全组 开放</p>
<p>下载k8s对应版本的包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get k8s.io/client-go@v0.18.6</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/kubernetes&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/rest&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getClient</span><span class="params">()</span></span> *kubernetes.Clientset&#123;</span><br><span class="line">    config:=&amp;rest.Config&#123;</span><br><span class="line">        Host:<span class="string">&quot;http://124.70.204.12:8009&quot;</span>,</span><br><span class="line">     &#125;</span><br><span class="line">    c,err:=kubernetes.NewForConfig(config)</span><br><span class="line">    <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">       cm,err:=getClient().CoreV1().ConfigMaps(<span class="string">&quot;default&quot;</span>).</span><br><span class="line">           Get(context.Background(),<span class="string">&quot;mycm&quot;</span>,v1.GetOptions&#123;&#125;)</span><br><span class="line">       <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">           log.Fatal(err)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span> k,v:=<span class="keyword">range</span> cm.Data&#123;</span><br><span class="line">           fmt.Printf(<span class="string">&quot;key=%s,value=%s\n&quot;</span>,k,v)</span><br><span class="line">       &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看文档：<a target="_blank" rel="noopener" href="https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/">https://v1-18.docs.kubernetes.io/docs/reference/generated/kubernetes-api/v1.18/</a></p>
<h2 id="ConfigMap：用程序读取-体内"><a href="#ConfigMap：用程序读取-体内" class="headerlink" title="ConfigMap：用程序读取(体内)"></a>ConfigMap：用程序读取(体内)</h2><p>之前学RBAC学到：</p>
<ul>
<li>token 在这个位置/var/run/secrets/kubernetes.io/serviceaccount/token</li>
<li>APISERVER的地址这么拼接：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://$KUBERNETES_SERVICE_HOST:$KUBERNETES_PORT_443_TCP_PORT</span><br></pre></td></tr></table></figure>
<p>证书的位置在:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span><br></pre></td></tr></table></figure>
<p>此时我们需要创建一个 账户：</p>
<ul>
<li>注意体内是：ServiceAccount 账户， (体外是UserAccount)</li>
<li>这个账户需要对ConfigMap拥有权限</li>
</ul>
<p>cmuser.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cmuser</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cmrole</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;configmaps&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;list&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cmclusterrolebinding</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cmrole</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cmuser</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br></pre></td></tr></table></figure>
<p>cmtest.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cdmtest</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">cmtest</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">cmtest</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">cmuser</span></span><br><span class="line">      <span class="attr">nodeName:</span> <span class="string">node2</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmtest</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">alpine:3.12</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/app/cmtest&quot;</span>]</span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/home/cwz/goapi</span></span><br><span class="line">            <span class="attr">type:</span> <span class="string">Directory</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/apis/meta/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/kubernetes&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/rest&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> api_server <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> token <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 拼凑一些变量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    api_server=fmt.Sprintf(<span class="string">&quot;https://%s:%s&quot;</span>,</span><br><span class="line">        os.Getenv(<span class="string">&quot;KUBERNETES_SERVICE_HOST&quot;</span>),os.Getenv(<span class="string">&quot;KUBERNETES_PORT_443_TCP_PORT&quot;</span>))</span><br><span class="line">     f,err:=os.Open(<span class="string">&quot;/var/run/secrets/kubernetes.io/serviceaccount/token&quot;</span>)</span><br><span class="line">     <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">         log.Fatal(err)</span><br><span class="line">     &#125;</span><br><span class="line">     b,_:=ioutil.ReadAll(f)</span><br><span class="line">     token=<span class="type">string</span>(b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getClient</span><span class="params">()</span></span> *kubernetes.Clientset&#123;</span><br><span class="line">    config:=&amp;rest.Config&#123;</span><br><span class="line">        <span class="comment">//Host:&quot;http://124.70.204.12:8009&quot;,</span></span><br><span class="line">        Host:api_server,</span><br><span class="line">        BearerToken:token,</span><br><span class="line">        TLSClientConfig:rest.TLSClientConfig&#123;CAFile:<span class="string">&quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&quot;</span>&#125;,</span><br><span class="line">     &#125;</span><br><span class="line">    c,err:=kubernetes.NewForConfig(config)</span><br><span class="line">    <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">       cm,err:=getClient().CoreV1().ConfigMaps(<span class="string">&quot;default&quot;</span>).</span><br><span class="line">           Get(context.Background(),<span class="string">&quot;mycm&quot;</span>,v1.GetOptions&#123;&#125;)</span><br><span class="line">       <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">           log.Fatal(err)</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">for</span> k,v:=<span class="keyword">range</span> cm.Data&#123;</span><br><span class="line">              fmt.Printf(<span class="string">&quot;key=%s,value=%s\n&quot;</span>,k,v)</span><br><span class="line">       &#125;</span><br><span class="line">      <span class="keyword">select</span> &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ConfigMap：调用API监控cm的变化"><a href="#ConfigMap：调用API监控cm的变化" class="headerlink" title="ConfigMap：调用API监控cm的变化"></a>ConfigMap：调用API监控cm的变化</h2><p>基本代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">fact:=informers.NewSharedInformerFactory(getClient(), <span class="number">0</span>)</span><br><span class="line">cmInformer:=fact.Core().V1().ConfigMaps()</span><br><span class="line">cmInformer.Informer().AddEventHandler(&amp;CmHandler&#123;&#125;)</span><br><span class="line"></span><br><span class="line">fact.Start(wait.NeverStop)</span><br><span class="line"><span class="keyword">select</span> &#123;&#125;</span><br></pre></td></tr></table></figure>
<p>回调：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CmHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(this *CmHandler)</span></span> OnAdd(obj <span class="keyword">interface</span>&#123;&#125;)&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(this *CmHandler)</span></span> OnUpdate(oldObj, newObj <span class="keyword">interface</span>&#123;&#125;)&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(this *CmHandler)</span></span>    OnDelete(obj <span class="keyword">interface</span>&#123;&#125;)&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>完整代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/apimachinery/pkg/util/wait&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/informers&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/kubernetes&quot;</span></span><br><span class="line">    <span class="string">&quot;k8s.io/client-go/rest&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">//var api_server string</span></span><br><span class="line"><span class="comment">//var token string</span></span><br><span class="line"><span class="comment">//func init() &#123;</span></span><br><span class="line"><span class="comment">//    api_server=fmt.Sprintf(&quot;https://%s:%s&quot;,</span></span><br><span class="line"><span class="comment">//        os.Getenv(&quot;KUBERNETES_SERVICE_HOST&quot;),os.Getenv(&quot;KUBERNETES_PORT_443_TCP_PORT&quot;))</span></span><br><span class="line"><span class="comment">//    f,err:=os.Open(&quot;/var/run/secrets/kubernetes.io/serviceaccount/token&quot;)</span></span><br><span class="line"><span class="comment">//    if err!=nil&#123;</span></span><br><span class="line"><span class="comment">//        log.Fatal(err)</span></span><br><span class="line"><span class="comment">//     &#125;</span></span><br><span class="line"><span class="comment">//    b,_:=ioutil.ReadAll(f)</span></span><br><span class="line"><span class="comment">//    token=string(b)</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getClient</span><span class="params">()</span></span> *kubernetes.Clientset&#123;</span><br><span class="line">    config:=&amp;rest.Config&#123;</span><br><span class="line">        Host:<span class="string">&quot;http://124.70.204.12:8009&quot;</span>,</span><br><span class="line">        <span class="comment">//Host:api_server,</span></span><br><span class="line">        <span class="comment">//BearerToken:token,</span></span><br><span class="line">        <span class="comment">//TLSClientConfig:rest.TLSClientConfig&#123;CAFile:&quot;/var/run/secrets/kubernetes.io/serviceaccount/ca.crt&quot;&#125;,</span></span><br><span class="line">     &#125;</span><br><span class="line">    c,err:=kubernetes.NewForConfig(config)</span><br><span class="line">    <span class="keyword">if</span> err!=<span class="literal">nil</span>&#123;</span><br><span class="line">        log.Fatal(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> c</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> CmHandler <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(this *CmHandler)</span></span> OnAdd(obj <span class="keyword">interface</span>&#123;&#125;)&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(this *CmHandler)</span></span> OnUpdate(oldObj, newObj <span class="keyword">interface</span>&#123;&#125;)&#123;</span><br><span class="line">     <span class="keyword">if</span> newObj.(*v1.ConfigMap).Name==<span class="string">&quot;mycm&quot;</span>&#123;</span><br><span class="line">         log.Println(<span class="string">&quot;mycm发生了变化&quot;</span>)</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span><span class="params">(this *CmHandler)</span></span>    OnDelete(obj <span class="keyword">interface</span>&#123;&#125;)&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">       <span class="comment">//cm,err:=getClient().CoreV1().ConfigMaps(&quot;default&quot;).</span></span><br><span class="line">       <span class="comment">//    Get(context.Background(),&quot;mycm&quot;,v1.GetOptions&#123;&#125;)</span></span><br><span class="line">       <span class="comment">//if err!=nil&#123;</span></span><br><span class="line">       <span class="comment">//    log.Fatal(err)</span></span><br><span class="line">       <span class="comment">//&#125;</span></span><br><span class="line">       <span class="comment">//for k,v:=range cm.Data&#123;</span></span><br><span class="line">       <span class="comment">//       fmt.Printf(&quot;key=%s,value=%s\n&quot;,k,v)</span></span><br><span class="line">       <span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line">    fact:=informers.NewSharedInformerFactory(getClient(), <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    cmInformer:=fact.Core().V1().ConfigMaps()</span><br><span class="line">    cmInformer.Informer().AddEventHandler(&amp;CmHandler&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    fact.Start(wait.NeverStop)</span><br><span class="line">    <span class="keyword">select</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="5、Deployment和Secret"><a href="#5、Deployment和Secret" class="headerlink" title="5、Deployment和Secret"></a>5、Deployment和Secret</h1><h2 id="入门和无脑创建（Opaque）"><a href="#入门和无脑创建（Opaque）" class="headerlink" title="入门和无脑创建（Opaque）"></a>入门和无脑创建（Opaque）</h2><p>官方定义：</p>
<ul>
<li>Secret 对象类型用来保存敏感信息，例如密码、OAuth 令牌和 SSH 密钥。 将这些信息放在 secret 中比放在 Pod 的定义或者 容器镜像 中来说更加安全和灵活。 参阅 Secret 设计文档 获取更多详细信息。</li>
<li>Secret 是一种包含少量敏感信息例如密码、令牌或密钥的对象。 这样的信息可能会被放在 Pod 规约中或者镜像中。 用户可以创建 Secret，同时系统也创建了一些 Secret。</li>
</ul>
<p>类型：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311162002376.png" alt=""></p>
<p>先试一把：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line">  <span class="attr">pass:</span> <span class="string">&quot;123&quot;</span></span><br></pre></td></tr></table></figure>
<p>这样肯定报错</p>
<p>我们需要 先base64编码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> cwz | <span class="built_in">base64</span> &amp;&amp; <span class="built_in">echo</span> 123 | <span class="built_in">base64</span> </span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">&quot;Y3d6Cg==&quot;</span></span><br><span class="line">  <span class="attr">pass:</span> <span class="string">&quot;MTIzCg==&quot;</span></span><br></pre></td></tr></table></figure>
<p>或者可以这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">Opaque</span></span><br><span class="line"><span class="attr">stringData:</span></span><br><span class="line">  <span class="attr">user:</span> <span class="string">&quot;zhangsan&quot;</span></span><br><span class="line">  <span class="attr">pass:</span> <span class="string">&quot;123456&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="命令获取secret内容、挂载文件"><a href="#命令获取secret内容、挂载文件" class="headerlink" title="命令获取secret内容、挂载文件"></a>命令获取secret内容、挂载文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看命令</span></span><br><span class="line">kubectl get secret mysecret -o yaml</span><br><span class="line"></span><br><span class="line">kubectl get secret mysecret -o json</span><br></pre></td></tr></table></figure>
<p>还可以使用 jsonpath</p>
<p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/reference/kubectl/jsonpath/">https://kubernetes.io/zh/docs/reference/kubectl/jsonpath/</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311162002918.png" alt=""></p>
<p>环境变量使用:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USER</span></span><br><span class="line">  <span class="attr">valueFrom:</span></span><br><span class="line">    <span class="attr">secretKeyRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="attr">key:</span> <span class="string">user</span></span><br></pre></td></tr></table></figure>
<p>挂载：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">users</span></span><br><span class="line">  <span class="attr">secret:</span></span><br><span class="line">    <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br></pre></td></tr></table></figure>
<p>完整的myngx.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data/user.txt</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">user.info</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">users</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/users</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TEST</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">testvalue</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USERNAME</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                <span class="attr">configMapKeyRef:</span></span><br><span class="line">                  <span class="attr">name:</span> <span class="string">mycm</span>           <span class="comment">#  ConfigMap的名称</span></span><br><span class="line">                  <span class="attr">key:</span> <span class="string">username</span> <span class="comment"># 需要取值的键</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">USER</span></span><br><span class="line">              <span class="attr">valueFrom:</span></span><br><span class="line">                 <span class="attr">secretKeyRef:</span></span><br><span class="line">                    <span class="attr">name:</span> <span class="string">mysecret</span></span><br><span class="line">                    <span class="attr">key:</span> <span class="string">user</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">users</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0655</span></span><br><span class="line">            <span class="attr">secretName:</span> <span class="string">mysecret</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cmdata</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0655</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">mycm</span></span><br></pre></td></tr></table></figure>
<h2 id="secret进行basic-auth认证-1-手工配置"><a href="#secret进行basic-auth认证-1-手工配置" class="headerlink" title="secret进行basic-auth认证(1):手工配置"></a>secret进行basic-auth认证(1):手工配置</h2><p>先看下手工配nginx 认证咋配</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">  <span class="attribute">auth_basic</span>      <span class="string">&quot;xxxxooooo&quot;</span>;</span><br><span class="line">  <span class="attribute">auth_basic_user_file</span> conf/htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中密码 我们常用的是 :</p>
<ul>
<li>通过apache的工具htpasswd或者openssl passwd命令生成</li>
<li>htpasswd提供了一个变种的MD5加密算法(apr1)</li>
</ul>
<p>安装工具:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install httpd-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># Apache的Web服务器内置的工具,用于创建和更新储存用户名和用户基本认证的密码文件</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建一个密码文件</span></span><br><span class="line">htpasswd -c auth cwz</span><br><span class="line"><span class="comment"># 这时产生了一个 auth文件,</span></span><br><span class="line"><span class="comment"># cwz:$apr1$NuppuOgl$KKdJiOggDAglu9.y0P0G80</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 再添加一个  用户(此时不用-c参数)</span></span><br><span class="line">htpasswd  auth lisi</span><br></pre></td></tr></table></figure>
<p>我们搞成一个ConfigMap，名称叫做bauth，然后把刚才的内容 拷贝进去</p>
<p>使用的镜像是 nginx:1.18-alpine，默认配置文件在/etc/nginx/nginx.conf，其中 主配置文件引用了 /etc/nginx/conf.d/default.conf 文件 </p>
<p>拷贝并修改：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">       <span class="attribute">auth_basic</span>      <span class="string">&quot;test auth&quot;</span>;</span><br><span class="line">       <span class="attribute">auth_basic_user_file</span> /etc/nginx/basicauth;</span><br><span class="line">        <span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">        <span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>把nginx配置也搞成ConfigMap，名字叫做ngx，值是上面拷贝的</p>
<p>挂载：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumeMounts:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">  <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d/default.conf</span></span><br><span class="line">  <span class="attr">subPath:</span> <span class="string">ngx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">basicauth</span></span><br><span class="line">  <span class="attr">mountPath:</span> <span class="string">/etc/nginx/basicauth</span></span><br><span class="line">  <span class="attr">subPath:</span> <span class="string">auth</span></span><br></pre></td></tr></table></figure>
<p>卷：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">  <span class="attr">configMap:</span></span><br><span class="line">    <span class="attr">defaultMode:</span> <span class="number">0655</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nginxconfig</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">basicauth</span></span><br><span class="line">    <span class="attr">configMap:</span></span><br><span class="line">      <span class="attr">defaultMode:</span> <span class="number">0655</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">bauth</span></span><br></pre></td></tr></table></figure>
<p>完整myngx.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myngx</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/nginx/conf.d/default.conf</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">ngx</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">basicauth</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/etc/nginx/basicauth</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">auth</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0655</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">nginxconf</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">basicauth</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0655</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">bauth</span></span><br></pre></td></tr></table></figure>
<p>访问测试：curl —basic -u cwz:123456 <a target="_blank" rel="noopener" href="http://10.244.2.85">http://10.244.2.85</a></p>
<h2 id="secret进行basic-auth认证-2-使用secret挂载"><a href="#secret进行basic-auth认证-2-使用secret挂载" class="headerlink" title="secret进行basic-auth认证(2):使用secret挂载"></a>secret进行basic-auth认证(2):使用secret挂载</h2><p>从文件的方式导入</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl  create secret generic secret-basic-auth  --from-file=auth</span><br></pre></td></tr></table></figure>
<h2 id="拉取私有镜像、创建Docker-Secret"><a href="#拉取私有镜像、创建Docker-Secret" class="headerlink" title="拉取私有镜像、创建Docker Secret"></a>拉取私有镜像、创建Docker Secret</h2><p>首先去 <a target="_blank" rel="noopener" href="https://hub.docker.com/signup">https://hub.docker.com/signup</a> 注册并登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull alpine:3.12 </span><br><span class="line"></span><br><span class="line">docker login  登录</span><br><span class="line"></span><br><span class="line">docker tag alpine:3.12 cwz/myalpine:3.12</span><br></pre></td></tr></table></figure>
<p>创建私有镜像仓库：<a target="_blank" rel="noopener" href="https://hub.docker.com/repository/create">https://</a><a target="_blank" rel="noopener" href="https://hub.docker.com/repository/create">hub.docker.com/repository/create</a></p>
<p>发布：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker push cwz/myalpine:3.12 </span><br></pre></td></tr></table></figure>
<p>接下来 把我们刚才打标签的tag给删掉 </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rmi cwz/myalpine:3.12</span><br></pre></td></tr></table></figure>
<p>写一个deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myalpine</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myalpine</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myalpine</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">          <span class="attr">image:</span> <span class="number">2441767409</span><span class="string">/myalpine:3.12</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo this is alpine &amp;&amp; sleep 36000&quot;</span>]</span><br></pre></td></tr></table></figure>
<p>创建secret</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret docker-registry dockerreg \</span><br><span class="line">  --docker-server=https://index.docker.io/v1/\</span><br><span class="line">  --docker-username=2441767409 \</span><br><span class="line">  --docker-password=xxxxx \</span><br><span class="line">  --docker-email=2441767409@qq.com</span><br></pre></td></tr></table></figure>
<p>内容解码：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get secret  dockerreg -o jsonpath=&#123;.data.*&#125; | <span class="built_in">base64</span> -d</span><br></pre></td></tr></table></figure>
<p>myalpine.yaml中加入配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">imagePullSecrets:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockerreg</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">myalpine</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myalpine</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myalpine</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alpine</span></span><br><span class="line">          <span class="attr">image:</span> <span class="number">2441767409</span><span class="string">/myalpine:3.12</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;echo this is alpine &amp;&amp; sleep 36000&quot;</span>]</span><br><span class="line">      <span class="attr">imagePullSecrets:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dockerreg</span></span><br></pre></td></tr></table></figure>
<h1 id="6、Deployment和Service"><a href="#6、Deployment和Service" class="headerlink" title="6、Deployment和Service"></a>6、Deployment和Service</h1><h2 id="创建一个最基本的Service、ClusterIP"><a href="#创建一个最基本的Service、ClusterIP" class="headerlink" title="创建一个最基本的Service、ClusterIP"></a>创建一个最基本的Service、ClusterIP</h2><p>Service的作用：</p>
<ul>
<li>一句话：提供负载均衡和服务自动发现</li>
</ul>
<p>先搞一个ConfigMap</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">h1:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">h1</span></span><br><span class="line">  <span class="attr">h2:</span> <span class="string">this</span> <span class="string">is</span> <span class="string">h2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">html</span></span><br></pre></td></tr></table></figure>
<p>写一个deployment</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">htmldata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/index.html</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">h1</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">htmldata</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">             <span class="attr">defaultMode:</span> <span class="number">0644</span></span><br><span class="line">             <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span>  <span class="comment">#service通过selector和pod建立关联</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<p>服务类型—-ClusterIP:</p>
<ul>
<li>ClusterIP：通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是默认的 ServiceType</li>
</ul>
<h2 id="Service负载均衡多个POD"><a href="#Service负载均衡多个POD" class="headerlink" title="Service负载均衡多个POD"></a>Service负载均衡多个POD</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">htmldata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/index.html</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">h1</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">htmldata</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">             <span class="attr">defaultMode:</span> <span class="number">0644</span></span><br><span class="line">             <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx2</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">htmldata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html/index.html</span></span><br><span class="line">              <span class="attr">subPath:</span> <span class="string">h2</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">htmldata</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">defaultMode:</span> <span class="number">0644</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">html</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span>  <span class="comment">#service通过selector和pod建立关联</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<p>标签匹配的</p>
<h2 id="宿主机访问k8s的Service的基本方法"><a href="#宿主机访问k8s的Service的基本方法" class="headerlink" title="宿主机访问k8s的Service的基本方法"></a>宿主机访问k8s的Service的基本方法</h2><p>安装工具：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install  bind-utils  -y</span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nslookup nginx-svc</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubectl get svc -n kube-system</span><br><span class="line"><span class="comment"># 查出clusterip</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/resolv.conf</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用于设置DNS服务器IP地址、DNS域名和设置主机的域名搜索顺序</span></span><br><span class="line"><span class="comment"># 我们加一个进去</span></span><br><span class="line"><span class="comment"># nameserver 10.96.0.10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后执行 </span></span><br><span class="line">nslookup nginx-svc.default.svc.cluster.local</span><br></pre></td></tr></table></figure>
<h2 id="无头Service初步入门"><a href="#无头Service初步入门" class="headerlink" title="无头Service初步入门"></a>无头Service初步入门</h2><p>所谓的无头服务</p>
<ul>
<li>通过指定 ClusterIP的值为“None”来创建 Headless Service</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">&quot;None&quot;</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">80</span></span><br><span class="line">  <span class="attr">selector:</span>  <span class="comment">#service通过selector和pod建立关联</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">nginx</span></span><br></pre></td></tr></table></figure>
<p>作用：</p>
<ul>
<li>有些程序 需要自己来决定到底 使用哪个IP</li>
<li>譬如golang 可以使用 net.LookupIP(“服务名”)，来获取 IP ,然后自己来决定到底使用哪个</li>
<li>StatefulSet 状态下。POD互相访问</li>
</ul>
<h2 id="kube-proxy、修改为ipvs模式"><a href="#kube-proxy、修改为ipvs模式" class="headerlink" title="kube-proxy、修改为ipvs模式"></a>kube-proxy、修改为ipvs模式</h2><p>外部通过NodePort、ClusterIP等方式访问服务</p>
<p>kube-proxy运行在每个node上，负责Pod网络代理，维护网络规则和四层负载均衡工作</p>
<p>查看监听的端口：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo netstat -ntlp | grep kube-proxy</span><br></pre></td></tr></table></figure>
<p>kube-proxy监听 10249 和 10256端口：对外提供/metrics和 /healthz的访问</p>
<p>查看配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe cm kube-proxy -n kube-system</span><br></pre></td></tr></table></figure>
<p>两个主要模式：</p>
<p>userspace（废除）、iptables或者IPVS</p>
<p>iptables：</p>
<ul>
<li>基于Linux内核，成熟稳定，并且能够和其他跟iptables协作的应用融洽相处</li>
<li>但我们的Service和Endpoint比较少，如千把个、几百个、几十个，那么iptables性能较高</li>
</ul>
<p>IPVS：</p>
<ul>
<li>基于Linux内核功能（负载均衡器）。IPVS模式下，kube-proxy使用IPVS负载均衡代替了iptables，使用优化的查找算法，而不是从列表中查找规则，在大规模场景下相对IPVS性能更好</li>
</ul>
<p>修改方法：</p>
<ul>
<li>在kube-system找到 cm（kube-proxy），修改mode</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs kube-proxy-l7hb9 -n kube-system | grep <span class="string">&quot;Using ipvs Proxier&quot;</span></span><br></pre></td></tr></table></figure>
<h1 id="7、PV和PVC"><a href="#7、PV和PVC" class="headerlink" title="7、PV和PVC"></a>7、PV和PVC</h1><h2 id="创建PV、Local方式、基本设置"><a href="#创建PV、Local方式、基本设置" class="headerlink" title="创建PV、Local方式、基本设置"></a>创建PV、Local方式、基本设置</h2><p>pv：</p>
<ul>
<li>全称是：PersistentVolume（持久化卷），是对底层的共享存储的一种抽象， 由管理员进行创建和配置。</li>
<li>然后由 卷插件 如local、NFS 等具体的底层技术来实现 </li>
</ul>
<p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes">https://kubernetes.io/zh/docs/concepts/storage/persistent-volumes/#types-of-persistent-volumes</a></p>
<p>创建一个：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">local-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">     <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/mnt/disks/ssd1</span></span><br></pre></td></tr></table></figure>
<p>capacity：</p>
<ul>
<li>它的单位有：P,T,G,M,K或 Pi,Ti,Gi,Mi,Ki 区别，加i的是以1024为换算单位</li>
<li>如 (1Mi)    1M=1024K=1024×1024byte        1M 则是1000*1000</li>
</ul>
<p>accessModes：</p>
<p>访问模式有：</p>
<ul>
<li>ReadWriteOnce — 卷可以被一个节点以读写方式挂载；</li>
<li>ReadOnlyMany — 卷可以被多个节点以只读方式挂载；</li>
<li>ReadWriteMany — 卷可以被多个节点以读写方式挂载。</li>
</ul>
<p>PersistentVolume 对象的回收策略：</p>
<p>Retained（保留）、Recycled（回收）或 Deleted（删除）</p>
<p>节点亲和性：</p>
<ul>
<li><p>之前我们调度节点时用过nodeSelector  ，设定标签进行匹配。这种方式过于”粗暴简单”。使用NodeAffinity来进行控制颗粒度更小（对于local模式 ，我们必须要设置）</p>
</li>
<li><p>软策略 (有最好，没有也无所谓)：</p>
</li>
</ul>
<p>如果没有满足调度要求的节点的话，就会忽略按正常调度preferredDuringSchedulingIgnoredDuringExecution</p>
<p>preferredDuringSchedulingRequiredDuringExecution (一旦后面标签改了，有满足条件的节点了，就会重新调度到该节点上)</p>
<ul>
<li>硬策略 </li>
</ul>
<p>如果没有满足条件的节点的话，就不断重试直到满足条件为止 requiredDuringSchedulingIgnoredDuringExecution （如果一开始满足的，后面node标签发生变化了，也无妨，继续运行）requiredDuringSchedulingRequiredDuringExecution（一旦变了，不符合条件了。则重新选择）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看标签 </span></span><br><span class="line">kubectl get node --show-labels=<span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 打标签语法</span></span><br><span class="line">kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt;</span><br><span class="line">kubectl label nodes node2 pv=<span class="built_in">local</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除语法</span></span><br><span class="line">kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;-</span><br><span class="line">kubectl label nodes node2 pv=<span class="built_in">local</span></span><br></pre></td></tr></table></figure>
<p>matchExpression</p>
<ul>
<li><p>In: label的值在某个列表中</p>
</li>
<li><p>NotIn：label的值不在某个列表中</p>
</li>
<li><p>Exists：某个label存在</p>
</li>
<li><p>DoesNotExist：某个label不存在</p>
</li>
<li><p>Gt：label的值大于某个值（字符串比较）</p>
</li>
<li><p>Lt：label的值小于某个值（字符串比较）</p>
</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">local-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Delete</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/home/cwz/data</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">pv</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">local</span></span><br></pre></td></tr></table></figure>
<h2 id="创建PVC、初步绑定PV-、POD挂载"><a href="#创建PVC、初步绑定PV-、POD挂载" class="headerlink" title="创建PVC、初步绑定PV 、POD挂载"></a>创建PVC、初步绑定PV 、POD挂载</h2><p>PVC(Persistent Volume Claim)</p>
<p>Persistent Volume提供存储资源(并实现)</p>
<p>Persistent Volume Claim 描述需要的存储标准，然后从现有PV中匹配或者动态建立新的资源，最后将两者进行绑定。</p>
<p>好比 </p>
<ul>
<li>PV是提供者，提供存储方式和容量 ( 销售费用1万)</li>
<li>PVC是消费者，消费容量 （它不需要关注用什么技术实现，绑定即可）</li>
</ul>
<p>绑定方式：</p>
<p>PV和PVC中</p>
<p>spec关键字段要匹配 。storageClassName字段必须一致 </p>
<p>PersistentVolume 对象的回收策略：Retained（保留）、Recycled（回收）或 Deleted（删除）</p>
<p>local-pv.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">local-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/home/cwz/data</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">pv</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">local</span></span><br></pre></td></tr></table></figure>
<p>pvc.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>
<p>ngx.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">ngx-pvc</span></span><br></pre></td></tr></table></figure>
<h2 id="StorageClass简单入门和创建"><a href="#StorageClass简单入门和创建" class="headerlink" title="StorageClass简单入门和创建"></a>StorageClass简单入门和创建</h2><p>理解为创建PV的模板  </p>
<p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/storage/storage-classes/">https://kubernetes.io/zh/docs/concepts/storage/storage-classes/</a></p>
<p>看个例子：</p>
<ul>
<li>provisioner:指的是卷插件 (如NFS，local)</li>
<li>reclaimPolicy: 回收策略。 </li>
<li>volumeBindingMode ：绑定模式</li>
<li>Immediate :一旦创建PVC 就绑定</li>
<li>WaitForFirstConsumer：就是延迟绑定，直到使用该 PVC 的 Pod 被创建</li>
<li>parameters：参数（不同的存储方式有N多个不同参数，这里不讲了。大家自行看文档）</li>
</ul>
<p>local-pv.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">local-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">local:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/home/cwz/data</span></span><br><span class="line">  <span class="attr">nodeAffinity:</span></span><br><span class="line">    <span class="attr">required:</span></span><br><span class="line">      <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">pv</span></span><br><span class="line">              <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">              <span class="attr">values:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="string">local</span></span><br></pre></td></tr></table></figure>
<p>pvc.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">local-storage</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br></pre></td></tr></table></figure>
<p>storageclass.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">local-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">Local</span></span><br><span class="line"><span class="attr">reclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line"><span class="attr">volumeBindingMode:</span> <span class="string">WaitForFirstConsumer</span></span><br></pre></td></tr></table></figure>
<p>ngx.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/data</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">mydata</span></span><br><span class="line">          <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">ngx-pvc</span></span><br></pre></td></tr></table></figure>
<h1 id="8、POD自动伸缩初步（HPA）"><a href="#8、POD自动伸缩初步（HPA）" class="headerlink" title="8、POD自动伸缩初步（HPA）"></a>8、POD自动伸缩初步（HPA）</h1><h2 id="HPA入门、部署metrics-server"><a href="#HPA入门、部署metrics-server" class="headerlink" title="HPA入门、部署metrics-server"></a>HPA入门、部署metrics-server</h2><p>HPA</p>
<p>Pod 水平自动扩缩（Horizontal Pod Autoscaler） 可以：</p>
<ul>
<li>基于 CPU 利用率自动扩缩 ReplicationController、Deployment、ReplicaSet 和 StatefulSet 中的 Pod 数量。</li>
<li>除了 CPU 利用率，也可以基于其他应程序提供的自定义度量指标 来执行自动扩缩。</li>
<li>Pod 自动扩缩不适用于无法扩缩的对象，比如 DaemonSet。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311162003515.png" alt=""></p>
<p>metrics-server：</p>
<ul>
<li>k8s里。可以通过Metrics-Server服务采集节点和Pod的内存、磁盘、CPU和网络的使用率等</li>
</ul>
<p>注意：</p>
<ul>
<li>Metrics API 只可以查询当前的度量数据，并不保存历史数据</li>
<li>Metrics API URI 为 /apis/metrics.k8s.io/ </li>
<li>必须部署 metrics-server 才能使用该 API，metrics-server 通过调用 Kubelet Summary API 获取数据</li>
</ul>
<p>部署方式：</p>
<p>官方告诉我们：</p>
<p>kubectl apply -f <a target="_blank" rel="noopener" href="https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml">https://github.com/kubernetes-sigs/metrics-server/releases/latest/download/components.yaml</a></p>
<p>components.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-admin:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-edit:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">rbac.authorization.k8s.io/aggregate-to-view:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:aggregated-metrics-reader</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nodes/stats</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">configmaps</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server-auth-reader</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">extension-apiserver-authentication-reader</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server:system:auth-delegator</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:auth-delegator</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">system:metrics-server</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">443</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">https</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">rollingUpdate:</span></span><br><span class="line">      <span class="attr">maxUnavailable:</span> <span class="number">0</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--cert-dir=/tmp</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--secure-port=4443</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-insecure-tls</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-preferred-address-types=InternalDNS,InternalIP,ExternalDNS,ExternalIP,Hostname</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--kubelet-use-node-status-port</span></span><br><span class="line">        <span class="comment">#image: k8s.gcr.io/metrics-server/metrics-server:v0.4.1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">bitnami/metrics-server:0.4.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/livez</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">https</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">4443</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">https</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">3</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/readyz</span></span><br><span class="line">            <span class="attr">port:</span> <span class="string">https</span></span><br><span class="line">            <span class="attr">scheme:</span> <span class="string">HTTPS</span></span><br><span class="line">          <span class="attr">periodSeconds:</span> <span class="number">10</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">readOnlyRootFilesystem:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsNonRoot:</span> <span class="literal">true</span></span><br><span class="line">          <span class="attr">runAsUser:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/tmp</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line">      <span class="attr">nodeSelector:</span></span><br><span class="line">        <span class="attr">kubernetes.io/os:</span> <span class="string">linux</span></span><br><span class="line">      <span class="attr">priorityClassName:</span> <span class="string">system-cluster-critical</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">metrics-server</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">emptyDir:</span> &#123;&#125;</span><br><span class="line">        <span class="attr">name:</span> <span class="string">tmp-dir</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiregistration.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">APIService</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">metrics-server</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">v1beta1.metrics.k8s.io</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">metrics.k8s.io</span></span><br><span class="line">  <span class="attr">groupPriorityMinimum:</span> <span class="number">100</span></span><br><span class="line">  <span class="attr">insecureSkipTLSVerify:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">metrics-server</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">version:</span> <span class="string">v1beta1</span></span><br><span class="line">  <span class="attr">versionPriority:</span> <span class="number">100</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">kubectl top pod</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建一个</span></span><br><span class="line">kubectl autoscale deployment ngx1 --min=2 --max=5 --cpu-percent=20</span><br></pre></td></tr></table></figure>
<h2 id="限制POD资源、创建HPA"><a href="#限制POD资源、创建HPA" class="headerlink" title="限制POD资源、创建HPA"></a>限制POD资源、创建HPA</h2><p>看一段配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">resources:</span></span><br><span class="line">  <span class="attr">requests:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;200m&quot;</span></span><br><span class="line">       <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span></span><br><span class="line">  <span class="attr">limits:</span></span><br><span class="line">    <span class="attr">cpu:</span> <span class="string">&quot;400m&quot;</span></span><br><span class="line">    <span class="attr">memory:</span> <span class="string">&quot;512Mi“</span></span><br></pre></td></tr></table></figure>
<p>requests来设置各容器需要的最小资源</p>
<p> limits用于限制运行时容器占用的资源</p>
<p> 1物理核=1000个微核(millicores)    1000m=1CPU</p>
<p>部署一个deployment</p>
<p>ngx.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">myweb</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeName:</span> <span class="string">just2</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web1test</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">alpine:3.12</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">command:</span> [<span class="string">&quot;/app/stress&quot;</span>]</span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/app</span></span><br><span class="line">          <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;200m&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;256Mi&quot;</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">&quot;400m&quot;</span></span><br><span class="line">              <span class="attr">memory:</span> <span class="string">&quot;512Mi&quot;</span></span><br><span class="line">          <span class="attr">ports:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/home/cwz/goapi</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">ClusterIP</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">      <span class="attr">targetPort:</span> <span class="number">8080</span></span><br><span class="line">  <span class="attr">selector:</span>  <span class="comment">#service通过selector和pod建立关联</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">myweb</span></span><br></pre></td></tr></table></figure>
<p>app代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line"></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    test:=<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;str&quot;</span>:<span class="string">&quot;requests来设置各容器需要的最小资源&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  r:=gin.New()</span><br><span class="line">  r.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(context *gin.Context)</span></span> &#123;</span><br><span class="line">      ret:=<span class="number">0</span></span><br><span class="line">      <span class="keyword">for</span> i:=<span class="number">0</span>;i&lt;=<span class="number">1000000</span>;i++&#123;</span><br><span class="line">          t:=<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;</span><br><span class="line">          b,_:=json.Marshal(test)</span><br><span class="line">          _=json.Unmarshal(b,t)</span><br><span class="line">          ret++</span><br><span class="line">    &#125;</span><br><span class="line">      context.JSON(<span class="number">200</span>,gin.H&#123;<span class="string">&quot;message&quot;</span>:ret&#125;)</span><br><span class="line">  &#125;)</span><br><span class="line">  r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>先装一个工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install httpd-tools</span><br><span class="line"></span><br><span class="line"><span class="comment"># 里面包含了一个 apache ab 工具  做简单压测</span></span><br><span class="line"></span><br><span class="line">ab -n 10000 -c 10  http://web1/</span><br></pre></td></tr></table></figure>
<p>创建一个</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 最简单是 使用命令直接创建</span></span><br><span class="line">kubectl autoscale deployment web1 --min=1 --max=5 --cpu-percent=20</span><br></pre></td></tr></table></figure>
<h2 id="yaml的方式创建HPA"><a href="#yaml的方式创建HPA" class="headerlink" title="yaml的方式创建HPA"></a>yaml的方式创建HPA</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># API版本</span></span><br><span class="line">kubectl api-versions | grep autoscaling</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">autoscaling/v1         <span class="comment">#只支持通过cpu伸缩</span></span><br><span class="line">autoscaling/v2beta1    <span class="comment">#支持通过cpu、内存 和自定义数据来进行伸缩。</span></span><br><span class="line">autoscaling/v2beta2     <span class="comment">#beta1的进一步 （一般用它）</span></span><br></pre></td></tr></table></figure>
<p>yaml配置方式：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">autoscaling/v2beta2</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">HorizontalPodAutoscaler</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">web1hpa</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">minReplicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">maxReplicas:</span> <span class="number">5</span></span><br><span class="line">  <span class="attr">scaleTargetRef:</span></span><br><span class="line">    <span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">web1</span></span><br><span class="line">  <span class="attr">metrics:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">          <span class="attr">averageUtilization:</span> <span class="number">50</span>   <span class="comment">#使用率</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">Utilization</span></span><br><span class="line">          <span class="attr">averageUtilization:</span> <span class="number">50</span>   <span class="comment">#使用率</span></span><br></pre></td></tr></table></figure>
<p>使用量：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">metrics:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cpu</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">AverageValue</span></span><br><span class="line">          <span class="attr">averageValue:</span> <span class="string">230m</span>   <span class="comment">#使用量</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">type:</span> <span class="string">Resource</span></span><br><span class="line">      <span class="attr">resource:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">memory</span></span><br><span class="line">        <span class="attr">target:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">AverageValue</span></span><br><span class="line">          <span class="attr">averageValue:</span> <span class="string">400m</span>   <span class="comment">#使用量</span></span><br></pre></td></tr></table></figure>
<p>关于自定义指标：</p>
<ul>
<li>自定义指标 比较主流的方式是使用prometheus</li>
</ul>
<p>大概有几项需要安装:</p>
<ul>
<li><p>node-exporter：prometheus的export，收集Node级别的监控数据</p>
</li>
<li><p>prometheus：监控服务端，从node-exporter拉数据并存储为时序数据。</p>
</li>
<li><p>kube-state-metrics：将prometheus中可以用PromQL查询到的指标数据转换成k8s对应的数据</p>
</li>
<li><p>k8s-prometheus-adpater：聚合进apiserver，即custom-metrics-apiserver实现(也可以用自定义CRD来实现)</p>
</li>
</ul>
<h1 id="9、CRD和Controller"><a href="#9、CRD和Controller" class="headerlink" title="9、CRD和Controller"></a>9、CRD和Controller</h1><h2 id="什么是CRD、创建一个自己的资源"><a href="#什么是CRD、创建一个自己的资源" class="headerlink" title="什么是CRD、创建一个自己的资源"></a>什么是CRD、创建一个自己的资源</h2><p>CRD：</p>
<ul>
<li>CRD  是 Kubernetes 的一种资源(CustomResourceDefinition )，允许我们基于它自定义新的资源类型.</li>
<li>值得注意的是：k8s所有的东西都叫做资源（Resource）</li>
<li>CRD就是 我们对自定义资源的定义</li>
</ul>
<p>crd.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="comment"># 名字必需与下面的 spec 字段匹配，并且格式为 &#x27;&lt;名称的复数形式&gt;.&lt;组名&gt;&#x27;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">proxies.extensions.just.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="comment"># 分组名，在REST API中也会用到的，格式是: /apis/分组名/CRD版本</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">extensions.just.com</span></span><br><span class="line">  <span class="comment"># 列举此 CustomResourceDefinition 所支持的版本</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="comment"># 是否有效</span></span><br><span class="line">      <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">schema:</span></span><br><span class="line">        <span class="attr">openAPIV3Schema:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">spec:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">properties:</span></span><br><span class="line">                <span class="attr">name:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">age:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">  <span class="comment"># 范围是属于namespace的 ,可以是 Namespaced 或 Cluster</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="comment"># 复数名</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">proxies</span></span><br><span class="line">    <span class="comment"># 单数名</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">proxy</span></span><br><span class="line">    <span class="comment"># 类型名</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">MyRoute</span></span><br><span class="line">    <span class="comment"># kind的简称，就像service的简称是svc</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mr</span></span><br></pre></td></tr></table></figure>
<p>crddep.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">extensions.just.com/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">MyRoute</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">mygw</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">19</span></span><br></pre></td></tr></table></figure>
<p>kubectl get mr</p>
<h2 id="控制器的基本概念"><a href="#控制器的基本概念" class="headerlink" title="控制器的基本概念"></a>控制器的基本概念</h2><p>概念：</p>
<ul>
<li>kubernetes控制器管理器是一个守护进程，内嵌随kubernetes一起发布的核心控制回路</li>
<li>具体的控制器通过API server监视集群的状态，并尝试进行更改以将当前状态转为期望状态。目前，kubernetes自带的控制器包括副本控制器、节点控制器、命名空间控制器和服务账号控制器等</li>
</ul>
<p>具体作用：</p>
<ul>
<li>控制器会监视资源的创建、更新、删除事件，并触发Reconcile函数作为响应。整个调整过程被称作 ”Reconcile Loop“ （调谐循环）或者 ”Sync Loop“ （同步循环）</li>
<li>如 RS  当收到一个关于ReplicaSet的事件或者关于ReplicaSet创建pod事件时，就会触发一个叫做 Reconcile的函数，利用该函数用来调整状态使之可以和期望状态匹配</li>
</ul>
<h1 id="10、调度器kube-scheduler入门"><a href="#10、调度器kube-scheduler入门" class="headerlink" title="10、调度器kube-scheduler入门"></a>10、调度器kube-scheduler入门</h1><h2 id="调度器概念、基本过程、插件组成"><a href="#调度器概念、基本过程、插件组成" class="headerlink" title="调度器概念、基本过程、插件组成"></a>调度器概念、基本过程、插件组成</h2><p>概念：</p>
<p>kube-scheduler是kuberbetes中的关键模块，扮演管家的角色遵从一套机制为pod提供调度服务</p>
<p>粗暴的POD调度流程：</p>
<ul>
<li>通过某个手法发布pod（一堆配置）、</li>
<li>ControllerManager会把pod加入待调度队列</li>
<li>scheduler开始干活，通过机制决定到底要调度到哪个node。然后写入etcd</li>
<li>被选上节点里的kubelet得到消息，开始干活（pull image这些，正式启动pod）</li>
</ul>
<p>scheduler是怎么样干活的：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311162004884.png" alt=""></p>
<p>然后有一堆插件来实现这些节点：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311162004326.png" alt=""></p>
<p>总结为两点：</p>
<ul>
<li>过滤<ul>
<li>譬如我们直接设置nodeName、或者标签匹配。这就是过滤</li>
</ul>
</li>
<li>打分<ul>
<li>调度器会给每一个可调度节点进行打分。最后，kube-scheduler会将pod调度到得分最高的弄node上。如果存在多个得分最高的node，kube-scheduler会从中随机选取一个</li>
</ul>
</li>
</ul>
<h2 id="NodeAffinity之节点选择器"><a href="#NodeAffinity之节点选择器" class="headerlink" title="NodeAffinity之节点选择器"></a>NodeAffinity之节点选择器</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311162005608.png" alt=""></p>
<h2 id="NodeAffinity之节点亲和性-入门级"><a href="#NodeAffinity之节点亲和性-入门级" class="headerlink" title="NodeAffinity之节点亲和性(入门级)"></a>NodeAffinity之节点亲和性(入门级)</h2><p>目前有两种类型的节点亲和性：</p>
<ul>
<li>requiredDuringSchedulingIgnoredDuringExecution  （必须满足）</li>
<li>preferredDuringSchedulingIgnoredDuringExecution （有最好，没有也无所谓）</li>
<li>可以视它们为“硬需求”和“软需求” </li>
</ul>
<p>示例：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">affinity:</span></span><br><span class="line">       <span class="attr">nodeAffinity:</span></span><br><span class="line">         <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">           <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">             <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                 <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                   <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                   <span class="attr">values:</span></span><br><span class="line">                     <span class="bullet">-</span> <span class="string">ngx</span></span><br></pre></td></tr></table></figure>
<p>文档：<a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector">https://kubernetes.io/zh/docs/concepts/scheduling-eviction/assign-pod-node/#nodeselector</a></p>
<p>ngx.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">nodeAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="attr">nodeSelectorTerms:</span></span><br><span class="line">              <span class="bullet">-</span> <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">ngx</span></span><br><span class="line">          <span class="attr">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">weight:</span> <span class="number">1</span></span><br><span class="line">              <span class="attr">preference:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">age</span></span><br><span class="line">                  <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                  <span class="attr">values:</span></span><br><span class="line">                   <span class="bullet">-</span> <span class="string">&quot;19&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>
<h2 id="调度之节点污点和容忍度"><a href="#调度之节点污点和容忍度" class="headerlink" title="调度之节点污点和容忍度"></a>调度之节点污点和容忍度</h2><p>节点亲和性 使 Pod 被吸引到一类特定的节点。 </p>
<p> Taint（污点）则相反，它使节点能够排斥一类特定的 Pod。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看指定节点上的污点:</span></span><br><span class="line">kubectl describe node just1 | grep Taints</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311162007290.png" alt=""></p>
<p>三种类型：</p>
<ul>
<li>NoSchedule ：一定不能被调度。</li>
<li>PreferNoSchedule：尽量不要调度。</li>
<li>NoExecute：不仅不会调度，还会驱逐Node上已有的Pod。</li>
</ul>
<p>内置污点：</p>
<ul>
<li>node.kubernetes.io/not-ready：节点未准备好。这相当于节点状态 Ready 的值为 “False”。</li>
<li>node.kubernetes.io/unreachable：节点控制器访问不到节点. 这相当于节点状态 Ready 的值为 “Unknown”。</li>
<li>node.kubernetes.io/out-of-disk：节点磁盘耗尽。</li>
<li>node.kubernetes.io/memory-pressure：节点存在内存压力。</li>
<li>node.kubernetes.io/disk-pressure：节点存在磁盘压力。</li>
<li>node.kubernetes.io/network-unavailable：节点网络不可用。</li>
<li>node.kubernetes.io/unschedulable: 节点不可调度。</li>
<li>node.cloudprovider.kubernetes.io/uninitialized：如果 kubelet 启动时指定了一个 “外部” 云平台驱动， 它将给当前节点添加一个污点将其标志为不可用。在 cloud-controller-manager 的一个控制器初始化这个节点后，kubelet 将删除这个污点。</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打污点</span></span><br><span class="line">kubectl taint node just1 name=cwz:NoSchedule</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除该污点</span></span><br><span class="line">kubectl taint node just1 name:NoSchedule-</span><br></pre></td></tr></table></figure>
<p>接下来尝试调度</p>
<p>环境是这样的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">首先</span><br><span class="line"></span><br><span class="line">我有个两个节点</span><br><span class="line"></span><br><span class="line">1、just1  拥有标签app=ngx  拥有一个污点 是name=cwz</span><br><span class="line"></span><br><span class="line">2、just2 没有上述标签</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">发布一个deployment 。节点亲和性 是 app in ngx</span><br></pre></td></tr></table></figure>
<p>添加容忍度：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">tolerations:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;name&quot;</span></span><br><span class="line">         <span class="attr">operator:</span> <span class="string">&quot;Equal&quot;</span></span><br><span class="line">         <span class="attr">value:</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line">         <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="POD亲和性的基本设置"><a href="#POD亲和性的基本设置" class="headerlink" title="POD亲和性的基本设置"></a>POD亲和性的基本设置</h2><p>概念：</p>
<ul>
<li>Pod 间亲和性与反亲和性使你可以 基于已经在节点上运行的 Pod 的标签 来约束 Pod 可以调度到的节点，而不是基于节点上的标签</li>
</ul>
<p>官方说明：</p>
<ul>
<li>Pod 间亲和性与反亲和性需要大量的处理，这可能会显著减慢大规模集群中的调度。 因此不建议在超过数百个节点的集群中使用它们。</li>
</ul>
<p>ngx.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ngx1</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">ngx1</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">nodeName:</span> <span class="string">just1</span></span><br><span class="line"><span class="comment">#      affinity:</span></span><br><span class="line"><span class="comment">#        nodeAffinity:</span></span><br><span class="line"><span class="comment">#          requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="comment">#            nodeSelectorTerms:</span></span><br><span class="line"><span class="comment">#              - matchExpressions:</span></span><br><span class="line"><span class="comment">#                  - key: app</span></span><br><span class="line"><span class="comment">#                    operator: In</span></span><br><span class="line"><span class="comment">#                    values:</span></span><br><span class="line"><span class="comment">#                      - ngx</span></span><br><span class="line"><span class="comment">#          preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line"><span class="comment">#            - weight: 1</span></span><br><span class="line"><span class="comment">#              preference:</span></span><br><span class="line"><span class="comment">#                matchExpressions:</span></span><br><span class="line"><span class="comment">#                - key: age</span></span><br><span class="line"><span class="comment">#                  operator: In</span></span><br><span class="line"><span class="comment">#                  values:</span></span><br><span class="line"><span class="comment">#                   - &quot;19&quot;</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx1</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>
<p>ngx2.yaml：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ngx2</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">ngx2</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">ngx2</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">affinity:</span></span><br><span class="line">        <span class="attr">podAffinity:</span></span><br><span class="line">          <span class="attr">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">labelSelector:</span></span><br><span class="line">                <span class="attr">matchExpressions:</span></span><br><span class="line">                  <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">app</span></span><br><span class="line">                    <span class="attr">operator:</span> <span class="string">In</span></span><br><span class="line">                    <span class="attr">values:</span></span><br><span class="line">                      <span class="bullet">-</span> <span class="string">ngx1</span></span><br><span class="line">              <span class="attr">topologyKey:</span> <span class="string">name</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ngx2</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">nginx:1.18-alpine</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br></pre></td></tr></table></figure>
<h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><p>初始化集群：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers  --kubernetes-version=1.20.2 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12  </span><br></pre></td></tr></table></figure>
<p>清除主机污点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>
<p>给工作节点打标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node just2 node-role.kubernetes.io/node=node</span><br></pre></td></tr></table></figure>
<h1 id="重新安装k8s"><a href="#重新安装k8s" class="headerlink" title="重新安装k8s"></a>重新安装k8s</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机执行 驱散</span></span><br><span class="line">kubectl drain justnode2--delete-local-data --force</span><br><span class="line">kubectl delete nodes justnode2 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># reset 需要每台机器执行</span></span><br><span class="line">sudo kubeadm reset</span><br><span class="line">sudo <span class="built_in">rm</span> -rf /etc/cni/net.d</span><br><span class="line">sudo iptables -F</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载之前装的kubeadm</span></span><br><span class="line">sudo yum -y remove kubelet-1.22.3 kubeadm-1.22.3 kubectl-1.22.3</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 卸载docker</span></span><br><span class="line">sudo yum -y remove docker-ce docker-ce-cli containerd</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/systemd/system/docker.service.d</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/systemd/system/docker.service</span><br><span class="line"><span class="built_in">rm</span> -rf /var/lib/docker</span><br><span class="line"><span class="built_in">rm</span> -rf /var/run/docker</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/local/docker</span><br><span class="line"><span class="built_in">rm</span> -rf /etc/docker</span><br><span class="line"><span class="built_in">rm</span> -rf /usr/bin/docker* /usr/bin/containerd* /usr/bin/runc /usr/bin/ctr</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 确保 firewalld、SElinux、swap全部关闭 禁用</span></span><br><span class="line">yum install -y yum-utils</span><br><span class="line">yum-config-manager --add-repo https://download.docker.com/linux/centos/docker-ce.repo</span><br><span class="line">yum install containerd -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置containerd 配置文件</span></span><br><span class="line">containerd config default &gt; /etc/containerd/config.toml <span class="comment"># 释放出一个默认配置文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改这个配置文件</span></span><br><span class="line">sandbox_image = <span class="string">&quot;registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.6&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改加速地址</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors]</span><br><span class="line">  [plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.registry.mirrors.<span class="string">&quot;docker.io&quot;</span>]</span><br><span class="line">    endpoint = [<span class="string">&quot;https://dockerproxy.com&quot;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># cgroup</span></span><br><span class="line">[plugins.<span class="string">&quot;io.containerd.grpc.v1.cri&quot;</span>.containerd.runtimes.runc.options]</span><br><span class="line">  SystemdCgroup = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl daemon-reload &amp;&amp; systemctl restart containerd &amp;&amp; systemctl <span class="built_in">enable</span> containerd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装crictl</span></span><br><span class="line"><span class="comment"># 需要与k8s版本对应</span></span><br><span class="line">wget https://github.com/kubernetes-sigs/cri-tools/releases/download/v1.24.2/crictl-v1.24.2-linux-amd64.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 简单配置crictl</span></span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/crictl.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">runtime-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">image-endpoint: unix:///run/containerd/containerd.sock</span></span><br><span class="line"><span class="string">timeout: 10</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装k8s了</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入源</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF&gt;&gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class="line"><span class="string">[kubernetes]</span></span><br><span class="line"><span class="string">name=Kubernetes</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class="line"><span class="string">enabled=1</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">repo_gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span></span><br><span class="line"><span class="string">       http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum -y install kubelet-1.24.2 kubeadm-1.24.2 kubectl-1.24.2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 允许数据包转发</span></span><br><span class="line">vim /etc/sysctl.d/k8s.conf</span><br><span class="line">加入或修改 如下4项</span><br><span class="line">net.ipv4.ip_forward = 1</span><br><span class="line">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class="line">net.bridge.bridge-nf-call-iptables = 1</span><br><span class="line">net.bridge.bridge-nf-call-arptables = 1</span><br><span class="line"></span><br><span class="line">modprobe br_netfilter</span><br><span class="line">sysctl --system</span><br><span class="line"></span><br><span class="line"><span class="comment"># 把kubelet设置为开机启动</span></span><br><span class="line">systemctl <span class="built_in">enable</span> kubelet</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化集群</span></span><br><span class="line">kubeadm init --image-repository registry.cn-hangzhou.aliyuncs.com/google_containers --kubernetes-version=1.28.2 --pod-network-cidr=10.244.0.0/16 --service-cidr=10.96.0.0/12 --cri-socket=unix:///run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 加入工作节点</span></span><br><span class="line">kubeadm <span class="built_in">join</span> 172.17.16.9:6443 --token 6f1uk3.mlwq38qizo60eev1 \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:110c723f99def7107ad1ce8cf2e063ea551064d945ec6558200879f386e7d0ff --cri-socket=unix:///run/containerd/containerd.sock</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 这时候退出root，使用普通账号</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装flannel</span></span><br></pre></td></tr></table></figure>
<p>ctr和crictl</p>
<p>containerd相比于docker，多了namespace概念，每个image和container都会在各自的namespace下可见</p>
<p>所以ctr 要查询应该:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctr -n k8s.io images list</span><br></pre></td></tr></table></figure>
<p>清除污点：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl taint nodes --all node-role.kubernetes.io/master-</span><br></pre></td></tr></table></figure>
<p>打标签：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl label node just2 node-role.kubernetes.io/node=node</span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://setcreed.github.io">SetCreed</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://setcreed.github.io/posts/b404e8ed/">https://setcreed.github.io/posts/b404e8ed/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://setcreed.github.io" target="_blank">伊甸园</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post_share"><div class="social-share" data-image="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311161954246.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/9475de17/" title="Ubuntu-Server"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311041112473.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Ubuntu-Server</div></div></a></div><div class="next-post pull-right"><a href="/posts/9ae73bd8/" title="那些读过的书"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311041106234.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">那些读过的书</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/4f91bd66/" title="kube-apiserver更改鉴权方式"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-10.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-27</div><div class="title">kube-apiserver更改鉴权方式</div></div></a></div><div><a href="/posts/fec34943/" title="kube-apiserver本地启动"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-12.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-27</div><div class="title">kube-apiserver本地启动</div></div></a></div><div><a href="/posts/d9ca3d6f/" title="kubernetes容器运行时"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-10.jpeg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2023-11-04</div><div class="title">kubernetes容器运行时</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">SetCreed</div><div class="author-info__description">读书、写代码、看电影</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/setcreed"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/img/qq.jpg" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/img/wechat_account.jpg" target="_blank" title="微信"><i class="fab fa-weixin"></i></a><a class="social-icon" href="https://github.com/setcreed" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:cwzdzg@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#1%E3%80%81kubeadm%E9%83%A8%E7%BD%B2%E5%92%8Crancher%E6%90%AD%E5%BB%BA"><span class="toc-number">1.</span> <span class="toc-text">1、kubeadm部署和rancher搭建</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%8E%AF%E5%A2%83%E3%80%81kubeadm%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text">服务器环境、kubeadm安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubeadm%E5%9F%BA%E6%9C%AC%E4%BD%9C%E7%94%A8%EF%BC%9A%E5%88%9D%E5%A7%8B%E5%8C%96%E9%9B%86%E7%BE%A4"><span class="toc-number">1.2.</span> <span class="toc-text">kubeadm基本作用：初始化集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E7%BD%91%E7%BB%9C%E7%BB%84%E4%BB%B6%EF%BC%88flannel%EF%BC%89%E3%80%81%E5%8A%A0%E5%85%A5%E5%AD%90%E8%8A%82%E7%82%B9"><span class="toc-number">1.3.</span> <span class="toc-text">安装网络组件（flannel）、加入子节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubernetes-dashboard%E9%83%A8%E7%BD%B2"><span class="toc-number">1.4.</span> <span class="toc-text">kubernetes dashboard部署</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2rancher%E4%BD%9C%E4%B8%BA%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F%EF%BC%88%E5%AF%BC%E5%85%A5%EF%BC%89"><span class="toc-number">1.5.</span> <span class="toc-text">部署rancher作为管理系统（导入）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%AD%A3%E3%80%81%E5%AE%89%E8%A3%85Helm%E3%80%81nginx-ingress"><span class="toc-number">1.6.</span> <span class="toc-text">修正、安装Helm、nginx-ingress</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#2%E3%80%81k8s%E8%AE%A4%E8%AF%81%E5%92%8C%E6%8E%88%E6%9D%83"><span class="toc-number">2.</span> <span class="toc-text">2、k8s认证和授权</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A4%E8%AF%86k8s%E7%9A%84%E7%94%A8%E6%88%B7%E8%B4%A6%E5%8F%B7-%E7%94%9F%E6%88%90%E8%AF%81%E4%B9%A6"><span class="toc-number">2.1.</span> <span class="toc-text">认识k8s的用户账号:生成证书</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%B4%A6%E5%8F%B7-2-%E4%BD%BF%E7%94%A8%E8%AF%81%E4%B9%A6%E5%88%9D%E6%AD%A5%E8%AF%B7%E6%B1%82API%E3%80%81%E8%AE%BE%E7%BD%AE%E4%B8%8A%E4%B8%8B%E6%96%87"><span class="toc-number">2.2.</span> <span class="toc-text">用户账号(2):使用证书初步请求API、设置上下文</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8Role%E5%92%8CRoleBinding%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%A7%92%E8%89%B2"><span class="toc-number">2.3.</span> <span class="toc-text">入门Role和RoleBinding、创建一个角色</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%92%8C%E8%A7%92%E8%89%B2%E8%BF%9B%E8%A1%8C%E7%BB%91%E5%AE%9A-RoleBinding"><span class="toc-number">2.4.</span> <span class="toc-text">用户和角色进行绑定(RoleBinding)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ClusterRole%E5%92%8CRoleBinding"><span class="toc-number">2.5.</span> <span class="toc-text">ClusterRole和RoleBinding</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E4%BD%BF%E7%94%A8token%E7%9A%84%E6%96%B9%E5%BC%8F%E8%AF%B7%E6%B1%82API-UserAccount"><span class="toc-number">2.6.</span> <span class="toc-text">配置使用token的方式请求API(UserAccount)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceAccount%E5%85%A5%E9%97%A8-1-%E5%88%9B%E5%BB%BA%E8%B4%A6%E5%8F%B7"><span class="toc-number">2.7.</span> <span class="toc-text">ServiceAccount入门(1):创建账号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceAccount%E5%85%A5%E9%97%A8-2-%E8%B5%8B%E4%BA%88%E6%9D%83%E9%99%90%E3%80%81%E5%A4%96%E9%83%A8%E8%AE%BF%E9%97%AEAPI"><span class="toc-number">2.8.</span> <span class="toc-text">ServiceAccount入门(2):赋予权限、外部访问API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceAccount%E5%85%A5%E9%97%A8-3-%E5%9C%A8POD%E9%87%8C%E8%AE%BF%E9%97%AEk8s-API-token%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">2.9.</span> <span class="toc-text">ServiceAccount入门(3):在POD里访问k8s API(token的方式)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ServiceAccount%E5%85%A5%E9%97%A8-4-%E5%9C%A8POD%E9%87%8C%E8%AE%BF%E9%97%AEk8s-API-token-%E8%AF%81%E4%B9%A6%E7%9A%84%E6%96%B9%E5%BC%8F"><span class="toc-number">2.10.</span> <span class="toc-text">ServiceAccount入门(4):在POD里访问k8s API(token+证书的方式)</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#3%E3%80%81Pod%E5%92%8Cdeployment"><span class="toc-number">3.</span> <span class="toc-text">3、Pod和deployment</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E5%85%A5%E9%97%A8%E3%80%81%E7%9C%8B%E6%96%87%E6%A1%A3%E7%9A%84%E6%96%B9%E5%BC%8F%E3%80%81%E5%88%9B%E5%BB%BAPod"><span class="toc-number">3.1.</span> <span class="toc-text">Pod入门、看文档的方式、创建Pod</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%95%B0%E6%8D%AE%E5%8D%B7-%E6%8C%82%E8%BD%BD%E4%B8%BB%E6%9C%BA%E7%9B%AE%E5%BD%95%E3%80%81%E6%8E%92%E5%9D%91%E6%96%B9%E5%BC%8F"><span class="toc-number">3.2.</span> <span class="toc-text">配置数据卷:挂载主机目录、排坑方式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pod%E5%92%8CDeployment%E5%9F%BA%E6%9C%AC%E5%8C%BA%E5%88%AB%E3%80%81%E5%88%9B%E5%BB%BAdeployment"><span class="toc-number">3.3.</span> <span class="toc-text">Pod和Deployment基本区别、创建deployment</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E5%AE%B9%E5%99%A8%E5%85%B1%E4%BA%AB%E6%96%87%E4%BB%B6%E5%A4%B9"><span class="toc-number">3.4.</span> <span class="toc-text">两个容器共享文件夹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#init%E5%AE%B9%E5%99%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8"><span class="toc-number">3.5.</span> <span class="toc-text">init容器的基本使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#4%E3%80%81Deployment%E5%92%8CConfigMap"><span class="toc-number">4.</span> <span class="toc-text">4、Deployment和ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap-1-%E5%9F%BA%E6%9C%AC%E5%88%9B%E5%BB%BA%E3%80%81%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%BC%95%E7%94%A8"><span class="toc-number">4.1.</span> <span class="toc-text">ConfigMap(1)基本创建、环境变量引用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap-2-%E6%98%A0%E5%B0%84%E6%88%90%E5%8D%95%E6%96%87%E4%BB%B6"><span class="toc-number">4.2.</span> <span class="toc-text">ConfigMap(2)映射成单文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap-3-%E5%85%A8%E9%83%A8%E6%98%A0%E5%B0%84%E6%96%87%E4%BB%B6%E5%92%8Csubpath"><span class="toc-number">4.3.</span> <span class="toc-text">ConfigMap(3)全部映射文件和subpath</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap%EF%BC%9A%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%AF%BB%E5%8F%96-%E4%BD%93%E5%A4%96"><span class="toc-number">4.4.</span> <span class="toc-text">ConfigMap：用程序读取(体外)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap%EF%BC%9A%E7%94%A8%E7%A8%8B%E5%BA%8F%E8%AF%BB%E5%8F%96-%E4%BD%93%E5%86%85"><span class="toc-number">4.5.</span> <span class="toc-text">ConfigMap：用程序读取(体内)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ConfigMap%EF%BC%9A%E8%B0%83%E7%94%A8API%E7%9B%91%E6%8E%A7cm%E7%9A%84%E5%8F%98%E5%8C%96"><span class="toc-number">4.6.</span> <span class="toc-text">ConfigMap：调用API监控cm的变化</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#5%E3%80%81Deployment%E5%92%8CSecret"><span class="toc-number">5.</span> <span class="toc-text">5、Deployment和Secret</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%A5%E9%97%A8%E5%92%8C%E6%97%A0%E8%84%91%E5%88%9B%E5%BB%BA%EF%BC%88Opaque%EF%BC%89"><span class="toc-number">5.1.</span> <span class="toc-text">入门和无脑创建（Opaque）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%91%BD%E4%BB%A4%E8%8E%B7%E5%8F%96secret%E5%86%85%E5%AE%B9%E3%80%81%E6%8C%82%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="toc-number">5.2.</span> <span class="toc-text">命令获取secret内容、挂载文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#secret%E8%BF%9B%E8%A1%8Cbasic-auth%E8%AE%A4%E8%AF%81-1-%E6%89%8B%E5%B7%A5%E9%85%8D%E7%BD%AE"><span class="toc-number">5.3.</span> <span class="toc-text">secret进行basic-auth认证(1):手工配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#secret%E8%BF%9B%E8%A1%8Cbasic-auth%E8%AE%A4%E8%AF%81-2-%E4%BD%BF%E7%94%A8secret%E6%8C%82%E8%BD%BD"><span class="toc-number">5.4.</span> <span class="toc-text">secret进行basic-auth认证(2):使用secret挂载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E7%A7%81%E6%9C%89%E9%95%9C%E5%83%8F%E3%80%81%E5%88%9B%E5%BB%BADocker-Secret"><span class="toc-number">5.5.</span> <span class="toc-text">拉取私有镜像、创建Docker Secret</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#6%E3%80%81Deployment%E5%92%8CService"><span class="toc-number">6.</span> <span class="toc-text">6、Deployment和Service</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84Service%E3%80%81ClusterIP"><span class="toc-number">6.1.</span> <span class="toc-text">创建一个最基本的Service、ClusterIP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Service%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E5%A4%9A%E4%B8%AAPOD"><span class="toc-number">6.2.</span> <span class="toc-text">Service负载均衡多个POD</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%BF%E4%B8%BB%E6%9C%BA%E8%AE%BF%E9%97%AEk8s%E7%9A%84Service%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%96%B9%E6%B3%95"><span class="toc-number">6.3.</span> <span class="toc-text">宿主机访问k8s的Service的基本方法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%A4%B4Service%E5%88%9D%E6%AD%A5%E5%85%A5%E9%97%A8"><span class="toc-number">6.4.</span> <span class="toc-text">无头Service初步入门</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kube-proxy%E3%80%81%E4%BF%AE%E6%94%B9%E4%B8%BAipvs%E6%A8%A1%E5%BC%8F"><span class="toc-number">6.5.</span> <span class="toc-text">kube-proxy、修改为ipvs模式</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#7%E3%80%81PV%E5%92%8CPVC"><span class="toc-number">7.</span> <span class="toc-text">7、PV和PVC</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAPV%E3%80%81Local%E6%96%B9%E5%BC%8F%E3%80%81%E5%9F%BA%E6%9C%AC%E8%AE%BE%E7%BD%AE"><span class="toc-number">7.1.</span> <span class="toc-text">创建PV、Local方式、基本设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAPVC%E3%80%81%E5%88%9D%E6%AD%A5%E7%BB%91%E5%AE%9APV-%E3%80%81POD%E6%8C%82%E8%BD%BD"><span class="toc-number">7.2.</span> <span class="toc-text">创建PVC、初步绑定PV 、POD挂载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#StorageClass%E7%AE%80%E5%8D%95%E5%85%A5%E9%97%A8%E5%92%8C%E5%88%9B%E5%BB%BA"><span class="toc-number">7.3.</span> <span class="toc-text">StorageClass简单入门和创建</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#8%E3%80%81POD%E8%87%AA%E5%8A%A8%E4%BC%B8%E7%BC%A9%E5%88%9D%E6%AD%A5%EF%BC%88HPA%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">8、POD自动伸缩初步（HPA）</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#HPA%E5%85%A5%E9%97%A8%E3%80%81%E9%83%A8%E7%BD%B2metrics-server"><span class="toc-number">8.1.</span> <span class="toc-text">HPA入门、部署metrics-server</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%90%E5%88%B6POD%E8%B5%84%E6%BA%90%E3%80%81%E5%88%9B%E5%BB%BAHPA"><span class="toc-number">8.2.</span> <span class="toc-text">限制POD资源、创建HPA</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yaml%E7%9A%84%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BAHPA"><span class="toc-number">8.3.</span> <span class="toc-text">yaml的方式创建HPA</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#9%E3%80%81CRD%E5%92%8CController"><span class="toc-number">9.</span> <span class="toc-text">9、CRD和Controller</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFCRD%E3%80%81%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E8%87%AA%E5%B7%B1%E7%9A%84%E8%B5%84%E6%BA%90"><span class="toc-number">9.1.</span> <span class="toc-text">什么是CRD、创建一个自己的资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8%E7%9A%84%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">9.2.</span> <span class="toc-text">控制器的基本概念</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#10%E3%80%81%E8%B0%83%E5%BA%A6%E5%99%A8kube-scheduler%E5%85%A5%E9%97%A8"><span class="toc-number">10.</span> <span class="toc-text">10、调度器kube-scheduler入门</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E5%99%A8%E6%A6%82%E5%BF%B5%E3%80%81%E5%9F%BA%E6%9C%AC%E8%BF%87%E7%A8%8B%E3%80%81%E6%8F%92%E4%BB%B6%E7%BB%84%E6%88%90"><span class="toc-number">10.1.</span> <span class="toc-text">调度器概念、基本过程、插件组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NodeAffinity%E4%B9%8B%E8%8A%82%E7%82%B9%E9%80%89%E6%8B%A9%E5%99%A8"><span class="toc-number">10.2.</span> <span class="toc-text">NodeAffinity之节点选择器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#NodeAffinity%E4%B9%8B%E8%8A%82%E7%82%B9%E4%BA%B2%E5%92%8C%E6%80%A7-%E5%85%A5%E9%97%A8%E7%BA%A7"><span class="toc-number">10.3.</span> <span class="toc-text">NodeAffinity之节点亲和性(入门级)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B0%83%E5%BA%A6%E4%B9%8B%E8%8A%82%E7%82%B9%E6%B1%A1%E7%82%B9%E5%92%8C%E5%AE%B9%E5%BF%8D%E5%BA%A6"><span class="toc-number">10.4.</span> <span class="toc-text">调度之节点污点和容忍度</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POD%E4%BA%B2%E5%92%8C%E6%80%A7%E7%9A%84%E5%9F%BA%E6%9C%AC%E8%AE%BE%E7%BD%AE"><span class="toc-number">10.5.</span> <span class="toc-text">POD亲和性的基本设置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%99%84%E5%BD%95"><span class="toc-number">11.</span> <span class="toc-text">附录</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%87%8D%E6%96%B0%E5%AE%89%E8%A3%85k8s"><span class="toc-number">12.</span> <span class="toc-text">重新安装k8s</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/4f91bd66/" title="kube-apiserver更改鉴权方式"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-10.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kube-apiserver更改鉴权方式"/></a><div class="content"><a class="title" href="/posts/4f91bd66/" title="kube-apiserver更改鉴权方式">kube-apiserver更改鉴权方式</a><time datetime="2024-02-27T14:17:38.000Z" title="发表于 2024-02-27 22:17:38">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/fec34943/" title="kube-apiserver本地启动"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-12.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kube-apiserver本地启动"/></a><div class="content"><a class="title" href="/posts/fec34943/" title="kube-apiserver本地启动">kube-apiserver本地启动</a><time datetime="2024-02-27T12:44:47.000Z" title="发表于 2024-02-27 20:44:47">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7b5f308e/" title="kubernetes组件之apiserver"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202402272048351.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kubernetes组件之apiserver"/></a><div class="content"><a class="title" href="/posts/7b5f308e/" title="kubernetes组件之apiserver">kubernetes组件之apiserver</a><time datetime="2024-02-27T12:36:09.000Z" title="发表于 2024-02-27 20:36:09">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d99f2ea2/" title="云原生软件开发模式"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-8.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="云原生软件开发模式"/></a><div class="content"><a class="title" href="/posts/d99f2ea2/" title="云原生软件开发模式">云原生软件开发模式</a><time datetime="2023-11-25T14:31:18.000Z" title="发表于 2023-11-25 22:31:18">2023-11-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b43710ac/" title="容器共享进程命名空间的应用"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-14.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="容器共享进程命名空间的应用"/></a><div class="content"><a class="title" href="/posts/b43710ac/" title="容器共享进程命名空间的应用">容器共享进程命名空间的应用</a><time datetime="2023-11-22T22:39:35.000Z" title="发表于 2023-11-23 06:39:35">2023-11-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By SetCreed</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.33/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/17.8.8/lazyload.iife.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><div class="js-pjax"><script>(() => {
  const initGitalk = () => {
    const gitalk = new Gitalk(Object.assign({
      clientID: '6cd6109276ef2f84ddf0',
      clientSecret: '0972659fc515f5ba9f2e4b120dc5af7211c5127f',
      repo: 'gitalk',
      owner: 'setcreed',
      admin: ['setcreed'],
      id: 'c6988af860f7bbcc608214bd2c645703',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  const loadGitalk = async() => {
    if (typeof Gitalk === 'function') initGitalk()
    else {
      await getCSS('https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.css')
      await getScript('https://cdnjs.cloudflare.com/ajax/libs/gitalk/1.8.0/gitalk.min.js')
      initGitalk()
    }
  }
  
  const commentCount = n => {
    const isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
    if (isCommentCount) {
      isCommentCount.textContent= n
    }
  }

  if ('Gitalk' === 'Gitalk' || !true) {
    if (true) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
    else loadGitalk()
  } else {
    window.loadOtherComment = loadGitalk
  }
})()</script></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>