<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>python核心 | 伊甸园</title><meta name="author" content="SetCreed"><meta name="copyright" content="SetCreed"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="python中一切皆对象函数和类也是对象，属于python的一等公民  赋值给一个变量 可以添加到集合对象中  可以作为参数传递给函数 可以当做函数的返回值  type、object和class之间的关系type可以生成一个类，可以返回对象的类型 1234567891011121314151617181920212223242526272829a &#x3D; 1b &#x3D; &quot;abc&quot;pri">
<meta property="og:type" content="article">
<meta property="og:title" content="python核心">
<meta property="og:url" content="https://setcreed.github.io/posts/c092dbc6/index.html">
<meta property="og:site_name" content="伊甸园">
<meta property="og:description" content="python中一切皆对象函数和类也是对象，属于python的一等公民  赋值给一个变量 可以添加到集合对象中  可以作为参数传递给函数 可以当做函数的返回值  type、object和class之间的关系type可以生成一个类，可以返回对象的类型 1234567891011121314151617181920212223242526272829a &#x3D; 1b &#x3D; &quot;abc&quot;pri">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-8.png">
<meta property="article:published_time" content="2022-03-03T16:01:36.000Z">
<meta property="article:modified_time" content="2023-11-15T12:39:46.979Z">
<meta property="article:author" content="SetCreed">
<meta property="article:tag" content="hexo、code、dream">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-8.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://setcreed.github.io/posts/c092dbc6/index.html"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章所描述的内容可能已经发生变化，请留意。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'python核心',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-15 20:39:46'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/custom/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/custom/icon.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="伊甸园" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">82</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-8.png')"><nav id="nav"><span id="blog-info"><a href="/" title="伊甸园"><span class="site-name">伊甸园</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">python核心</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2022-03-03T16:01:36.000Z" title="发表于 2022-03-04 00:01:36">2022-03-04</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">14.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>65分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="python核心"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="python中一切皆对象"><a href="#python中一切皆对象" class="headerlink" title="python中一切皆对象"></a>python中一切皆对象</h1><p>函数和类也是对象，属于python的一等公民</p>
<ul>
<li>赋值给一个变量</li>
<li>可以添加到集合对象中 </li>
<li>可以作为参数传递给函数</li>
<li>可以当做函数的返回值</li>
</ul>
<h1 id="type、object和class之间的关系"><a href="#type、object和class之间的关系" class="headerlink" title="type、object和class之间的关系"></a>type、object和class之间的关系</h1><p>type可以生成一个类，可以返回对象的类型</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">a = <span class="number">1</span></span><br><span class="line">b = <span class="string">&quot;abc&quot;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="number">1</span>))   <span class="comment"># &lt;class &#x27;int&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">int</span>))  <span class="comment"># &lt;class &#x27;type&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(b))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">str</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># type-&gt;int-&gt;1</span></span><br><span class="line"><span class="comment"># type-&gt;class-&gt;obj</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># object是最顶层的基类</span></span><br><span class="line"><span class="comment"># type也是一个类，同时type也是一个对象</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyStudent</span>(<span class="title class_ inherited__">Student</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">stu = Student()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(stu))     <span class="comment"># &lt;class &#x27;__main__.Student&#x27;&gt;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(Student)) <span class="comment"># &lt;class &#x27;type&#x27;&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">int</span>.__bases__)   <span class="comment"># (&lt;class &#x27;object&#x27;&gt;,)</span></span><br><span class="line"><span class="built_in">print</span>(Student.__bases__)    <span class="comment"># (&lt;class &#x27;object&#x27;&gt;,)</span></span><br><span class="line"><span class="built_in">print</span>(MyStudent.__bases__)    <span class="comment"># (&lt;class &#x27;__main__.Student&#x27;&gt;,)</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>.__bases__)  <span class="comment"># (&lt;class &#x27;object&#x27;&gt;,)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">object</span>.__bases__) <span class="comment"># ()</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">type</span>(<span class="built_in">object</span>)) <span class="comment"># (&lt;class &#x27;type&#x27;&gt;,)</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210208230840.png" alt=""></p>
<h1 id="魔法函数"><a href="#魔法函数" class="headerlink" title="魔法函数"></a>魔法函数</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MyVector</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        self.x = x</span><br><span class="line">        self.y = y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__add__</span>(<span class="params">self, other</span>):</span><br><span class="line">        re_vector = MyVector(self.x+other.x, self.y+other.y)</span><br><span class="line">        <span class="keyword">return</span> re_vector</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;x:&#123;x&#125;, y:&#123;y&#125;&quot;</span>.<span class="built_in">format</span>(x=self.x, y=self.y)</span><br><span class="line"></span><br><span class="line">first_vec = MyVector(<span class="number">1</span>,<span class="number">2</span>)</span><br><span class="line">second_vec = MyVector(<span class="number">3</span>,<span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(first_vec + second_vec)  <span class="comment"># x:4, y:6</span></span><br></pre></td></tr></table></figure>
<h1 id="抽象基类（abc模块）"><a href="#抽象基类（abc模块）" class="headerlink" title="抽象基类（abc模块）"></a>抽象基类（abc模块）</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Company</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, employee_list</span>):</span><br><span class="line">        self.employee = employee_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.employee)</span><br><span class="line"></span><br><span class="line">com = Company([<span class="string">&#x27;reese&#x27;</span>, <span class="string">&#x27;neo&#x27;</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在某些情况下希望判定某个对象的类型</span></span><br><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Sized</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(com, Sized))</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> abc</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CacheBase</span>(metaclass=abc.ABCMeta):</span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @abc.abstractmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">RedisCache</span>(<span class="title class_ inherited__">CacheBase</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">redis_cache = RedisCache()</span><br><span class="line"></span><br><span class="line"><span class="comment"># 会抛异常，强制你实现基类的get、set方法</span></span><br></pre></td></tr></table></figure>
<h1 id="python的自省机制"><a href="#python的自省机制" class="headerlink" title="python的自省机制"></a>python的自省机制</h1><p>自省是通过一定的机制查询到对象的内部结构</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>:</span><br><span class="line">    name = <span class="string">&quot;user&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span>(<span class="title class_ inherited__">Person</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, school_name</span>):</span><br><span class="line">        self.school_name = school_name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    user = Student(<span class="string">&quot;cwz&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(user.__dict__)</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"><span class="comment"># 输出：&#123;&#x27;school_name&#x27;: &#x27;cwz&#x27;&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="super-真的是调用父类的吗"><a href="#super-真的是调用父类的吗" class="headerlink" title="super()真的是调用父类的吗"></a>super()真的是调用父类的吗</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;A&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span>(<span class="title class_ inherited__">A</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;B&quot;</span>)</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">C</span>(<span class="title class_ inherited__">A</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;C&quot;</span>)</span><br><span class="line">        <span class="built_in">super</span>(C, self).__init__()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">D</span>(B, C):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;D&quot;</span>)</span><br><span class="line">        <span class="built_in">super</span>(D, self).__init__()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    D()</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 输出结果:</span></span><br><span class="line">D</span><br><span class="line">B</span><br><span class="line">C</span><br><span class="line">A</span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用super()函数的顺序 mro</span></span><br></pre></td></tr></table></figure>
<p>mixin模式特点：</p>
<ul>
<li>Mixin类功能单一</li>
<li>不和基类关联，可以和任意基类组合</li>
<li>在mixin中不要使用super这种用法</li>
</ul>
<h1 id="with语句"><a href="#with语句" class="headerlink" title="with语句"></a>with语句</h1><p>上下文管理协议</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Simple</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__enter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;enter&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> self</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__exit__</span>(<span class="params">self, exc_type, exc_val, exc_tb</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;exit&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_something</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;do something&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> Simple() <span class="keyword">as</span> simple:</span><br><span class="line">    simple.do_something()</span><br></pre></td></tr></table></figure>
<p>contextlib</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> contextlib</span><br><span class="line"></span><br><span class="line"><span class="meta">@contextlib.contextmanager</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">x</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start...&quot;</span>)</span><br><span class="line">    <span class="keyword">yield</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> test(<span class="number">1</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;进行中&quot;</span>)</span><br><span class="line">    </span><br><span class="line">start...</span><br><span class="line">进行中</span><br><span class="line">end...</span><br></pre></td></tr></table></figure>
<p>自定义序列类</p>
<p>python中序列类型的abc继承关系</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> abc</span><br></pre></td></tr></table></figure>
<h1 id="切片"><a href="#切片" class="headerlink" title="切片"></a>切片</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模式[start:end:step]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    其中，第一个数字start表示切片开始位置，默认为0；</span></span><br><span class="line"><span class="string">    第二个数字end表示切片截止（但不包含）位置（默认为列表长度）；</span></span><br><span class="line"><span class="string">    第三个数字step表示切片的步长（默认为1）。</span></span><br><span class="line"><span class="string">    当start为0时可以省略，当end为列表长度时可以省略，</span></span><br><span class="line"><span class="string">    当step为1时可以省略，并且省略步长时可以同时省略最后一个冒号。</span></span><br><span class="line"><span class="string">    另外，当step为负整数时，表示反向切片，这时start应该比end的值要大才行。</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line">aList = [<span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">11</span>, <span class="number">13</span>, <span class="number">15</span>, <span class="number">17</span>]</span><br><span class="line"><span class="built_in">print</span> (aList[::])  <span class="comment"># 返回包含原列表中所有元素的新列表</span></span><br><span class="line"><span class="built_in">print</span> (aList[::-<span class="number">1</span>])  <span class="comment"># 返回包含原列表中所有元素的逆序列表</span></span><br><span class="line"><span class="built_in">print</span> (aList[::<span class="number">2</span>])  <span class="comment"># 隔一个取一个，获取偶数位置的元素</span></span><br><span class="line"><span class="built_in">print</span> (aList[<span class="number">1</span>::<span class="number">2</span>])  <span class="comment"># 隔一个取一个，获取奇数位置的元素</span></span><br><span class="line"><span class="built_in">print</span> (aList[<span class="number">3</span>:<span class="number">6</span>])  <span class="comment"># 指定切片的开始和结束位置</span></span><br><span class="line">aList[<span class="number">0</span>:<span class="number">100</span>]  <span class="comment"># 切片结束位置大于列表长度时，从列表尾部截断</span></span><br><span class="line">aList[<span class="number">100</span>:]  <span class="comment"># 切片开始位置大于列表长度时，返回空列表</span></span><br><span class="line"></span><br><span class="line">aList[<span class="built_in">len</span>(aList):] = [<span class="number">9</span>]  <span class="comment"># 在列表尾部增加元素</span></span><br><span class="line">aList[:<span class="number">0</span>] = [<span class="number">1</span>, <span class="number">2</span>]  <span class="comment"># 在列表头部插入元素</span></span><br><span class="line">aList[<span class="number">3</span>:<span class="number">3</span>] = [<span class="number">4</span>]  <span class="comment"># 在列表中间位置插入元素</span></span><br><span class="line">aList[:<span class="number">3</span>] = [<span class="number">1</span>, <span class="number">2</span>]  <span class="comment"># 替换列表元素，等号两边的列表长度相等</span></span><br><span class="line">aList[<span class="number">3</span>:] = [<span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>]  <span class="comment"># 等号两边的列表长度也可以不相等</span></span><br><span class="line">aList[::<span class="number">2</span>] = [<span class="number">0</span>] * <span class="number">3</span>  <span class="comment"># 隔一个修改一个</span></span><br><span class="line"><span class="built_in">print</span> (aList)</span><br><span class="line">aList[::<span class="number">2</span>] = [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="string">&#x27;c&#x27;</span>]  <span class="comment"># 隔一个修改一个</span></span><br><span class="line">aList[::<span class="number">2</span>] = [<span class="number">1</span>,<span class="number">2</span>]  <span class="comment"># 左侧切片不连续，等号两边列表长度必须相等</span></span><br><span class="line">aList[:<span class="number">3</span>] = []  <span class="comment"># 删除列表中前3个元素</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">del</span> aList[:<span class="number">3</span>]  <span class="comment"># 切片元素连续</span></span><br><span class="line"><span class="keyword">del</span> aList[::<span class="number">2</span>]  <span class="comment"># 切片元素不连续，隔一个删一个</span></span><br></pre></td></tr></table></figure>
<h2 id="自定义可切片对象"><a href="#自定义可切片对象" class="headerlink" title="自定义可切片对象"></a>自定义可切片对象</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Group</span>:</span><br><span class="line">    <span class="comment"># 支持切片操作</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, group_name, company_name, staffs</span>):</span><br><span class="line">        self.group_name = group_name</span><br><span class="line">        self.company_name = company_name</span><br><span class="line">        self.staffs = staffs</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__reversed__</span>(<span class="params">self</span>):</span><br><span class="line">        self.staffs.reverse()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, item</span>):</span><br><span class="line">        cls = <span class="built_in">type</span>(self)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">isinstance</span>(item, <span class="built_in">slice</span>):</span><br><span class="line">            <span class="keyword">return</span> cls(group_name=self.group_name, company_name=self.company_name, staffs=self.staffs[item])</span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">isinstance</span>(item, numbers.Integral):</span><br><span class="line">            <span class="keyword">return</span> cls(group_name=self.group_name, company_name=self.company_name, staffs=[self.staffs[item]])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__len__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">len</span>(self.staffs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self.staffs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__contains__</span>(<span class="params">self, item</span>):</span><br><span class="line">        <span class="keyword">if</span> item <span class="keyword">in</span> self.staffs:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">staffs = [<span class="string">&quot;cwz&quot;</span>, <span class="string">&quot;reese&quot;</span>, <span class="string">&quot;neo&quot;</span>, <span class="string">&quot;setcreed&quot;</span>]</span><br><span class="line">group = Group(<span class="string">&quot;user&quot;</span>, <span class="string">&quot;imooc&quot;</span>, staffs)</span><br><span class="line"><span class="built_in">print</span>(group[:<span class="number">2</span>])</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(group))</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> group:</span><br><span class="line">    <span class="built_in">print</span>(user)</span><br><span class="line"><span class="built_in">reversed</span>(group)</span><br><span class="line"><span class="keyword">if</span> <span class="string">&quot;cwz&quot;</span> <span class="keyword">in</span> group:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;ok&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="bisect维护已排序序列"><a href="#bisect维护已排序序列" class="headerlink" title="bisect维护已排序序列"></a>bisect维护已排序序列</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> bisect</span><br><span class="line"></span><br><span class="line"><span class="comment"># 用来处理已排序的序列，；用来维持已排序的序列，升序</span></span><br><span class="line"></span><br><span class="line">inter_list = []</span><br><span class="line">bisect.insort(inter_list, <span class="number">3</span>)</span><br><span class="line">bisect.insort(inter_list, <span class="number">1</span>)</span><br><span class="line">bisect.insort(inter_list, <span class="number">5</span>)</span><br><span class="line">bisect.insort(inter_list, <span class="number">7</span>)</span><br><span class="line">bisect.insort(inter_list, <span class="number">0</span>)</span><br><span class="line"><span class="built_in">print</span>(inter_list)  <span class="comment"># [0, 1, 3, 5, 7]</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(bisect.bisect(inter_list, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<p>什么时候不使用列表</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> array</span><br><span class="line"></span><br><span class="line"><span class="comment"># array和list的一个重要区别，array只能存放指定的数据类型</span></span><br></pre></td></tr></table></figure>
<h1 id="列表推导式、生成器表达式、字典推导式"><a href="#列表推导式、生成器表达式、字典推导式" class="headerlink" title="列表推导式、生成器表达式、字典推导式"></a>列表推导式、生成器表达式、字典推导式</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#用简介的方式去遍历可迭代对象生成需要格式的列表</span></span><br><span class="line">int_list = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">qu_list = [item * item <span class="keyword">for</span> item <span class="keyword">in</span> int_list]</span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">type</span>(qu_list))</span><br><span class="line">int_list = [<span class="number">1</span>,<span class="number">2</span>,-<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line">qu_list = [item <span class="keyword">if</span> item &gt; <span class="number">0</span> <span class="keyword">else</span> <span class="built_in">abs</span>(item) <span class="keyword">for</span> item <span class="keyword">in</span> int_list]</span><br><span class="line"></span><br><span class="line"><span class="comment">#笛卡尔积</span></span><br><span class="line">int_list1 = [<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">int_list2 = [<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line">qu_list = [(first, second) <span class="keyword">for</span> first <span class="keyword">in</span> int_list1 <span class="keyword">for</span> second <span class="keyword">in</span> int_list2]</span><br><span class="line"></span><br><span class="line">my_dict = &#123;</span><br><span class="line">    <span class="string">&quot;key1&quot;</span>:<span class="string">&quot;bobby1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;key2&quot;</span>:<span class="string">&quot;bobby2&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># qu_list = [(key, value) for key, value in my_dict.items()]</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># qu_list2 = list(((key, value) for key, value in my_dict.items()))</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># for item in qu_list2:</span></span><br><span class="line"><span class="comment">#     print (item)</span></span><br><span class="line"></span><br><span class="line">int_list = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_item</span>(<span class="params">item</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">str</span>(item)</span><br><span class="line"></span><br><span class="line">int_dict = &#123;process_item(item):item <span class="keyword">for</span> item <span class="keyword">in</span> int_list&#125;</span><br><span class="line"><span class="comment">#列表生成式，第一：能用尽量用， 因为效率高</span></span><br><span class="line"><span class="built_in">print</span> (int_dict)</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="dict的abc继承关系"><a href="#dict的abc继承关系" class="headerlink" title="dict的abc继承关系"></a>dict的abc继承关系</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Mapping, MutableMapping</span><br><span class="line"><span class="comment"># dict属于mapping类似</span></span><br><span class="line"></span><br><span class="line">a = &#123;&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">isinstance</span>(a, MutableMapping))</span><br></pre></td></tr></table></figure>
<h2 id="dict的子类"><a href="#dict的子类" class="headerlink" title="dict的子类"></a>dict的子类</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> UserDict, defaultdict</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Mydict</span>(<span class="title class_ inherited__">UserDict</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__setitem__</span>(<span class="params">self, key, item</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__setitem__(key, item*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">my_dict = Mydict(one=<span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(my_dict)  <span class="comment"># &#123;&#x27;one&#x27;: 4&#125;</span></span><br></pre></td></tr></table></figure>
<h1 id="set和frozenset"><a href="#set和frozenset" class="headerlink" title="set和frozenset"></a>set和frozenset</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="built_in">frozenset</span>(<span class="string">&quot;abcd&quot;</span>)  <span class="comment"># frozenset可以作为dict的key</span></span><br></pre></td></tr></table></figure>
<h1 id="dict和set实现原理"><a href="#dict和set实现原理" class="headerlink" title="dict和set实现原理"></a>dict和set实现原理</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_list_data</span>(<span class="params">total_nums, target_nums</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从文件中读取数据，以list的方式返回</span></span><br><span class="line"><span class="string">    :param total_nums: 读取的数量</span></span><br><span class="line"><span class="string">    :param target_nums: 需要查询的数据的数量</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    all_data = []</span><br><span class="line">    target_data = []</span><br><span class="line">    file_name = <span class="string">&quot;G:/慕课网课程/AdvancePython/fbobject_idnew.txt&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, encoding=<span class="string">&quot;utf8&quot;</span>, mode=<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f_open:</span><br><span class="line">        <span class="keyword">for</span> count, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f_open):</span><br><span class="line">            <span class="keyword">if</span> count &lt; total_nums:</span><br><span class="line">                all_data.append(line)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(target_nums):</span><br><span class="line">        random_index = randint(<span class="number">0</span>, total_nums)</span><br><span class="line">        <span class="keyword">if</span> all_data[random_index] <span class="keyword">not</span> <span class="keyword">in</span> target_data:</span><br><span class="line">            target_data.append(all_data[random_index])</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(target_data) == target_nums:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> all_data, target_data</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_dict_data</span>(<span class="params">total_nums, target_nums</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从文件中读取数据，以dict的方式返回</span></span><br><span class="line"><span class="string">    :param total_nums: 读取的数量</span></span><br><span class="line"><span class="string">    :param target_nums: 需要查询的数据的数量</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    all_data = &#123;&#125;</span><br><span class="line">    target_data = []</span><br><span class="line">    file_name = <span class="string">&quot;G:/慕课网课程/AdvancePython/fbobject_idnew.txt&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(file_name, encoding=<span class="string">&quot;utf8&quot;</span>, mode=<span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> f_open:</span><br><span class="line">        <span class="keyword">for</span> count, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(f_open):</span><br><span class="line">            <span class="keyword">if</span> count &lt; total_nums:</span><br><span class="line">                all_data[line] = <span class="number">0</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    all_data_list = <span class="built_in">list</span>(all_data)</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> <span class="built_in">range</span>(target_nums):</span><br><span class="line">        random_index = randint(<span class="number">0</span>, total_nums-<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">if</span> all_data_list[random_index] <span class="keyword">not</span> <span class="keyword">in</span> target_data:</span><br><span class="line">            target_data.append(all_data_list[random_index])</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(target_data) == target_nums:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> all_data, target_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_test</span>(<span class="params">all_data, target_data</span>):</span><br><span class="line">    <span class="comment">#测试运行时间</span></span><br><span class="line">    test_times = <span class="number">100</span></span><br><span class="line">    total_times = <span class="number">0</span></span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(test_times):</span><br><span class="line">        find = <span class="number">0</span></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">for</span> data <span class="keyword">in</span> target_data:</span><br><span class="line">            <span class="keyword">if</span> data <span class="keyword">in</span> all_data:</span><br><span class="line">                find += <span class="number">1</span></span><br><span class="line">        last_time = time.time() - start_time</span><br><span class="line">        total_times += last_time</span><br><span class="line">    <span class="keyword">return</span> total_times/test_times</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># all_data, target_data = load_list_data(10000, 1000)</span></span><br><span class="line">    <span class="comment"># all_data, target_data = load_list_data(100000, 1000)</span></span><br><span class="line">    <span class="comment"># all_data, target_data = load_list_data(1000000, 1000)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment"># all_data, target_data = load_dict_data(10000, 1000)</span></span><br><span class="line">    <span class="comment"># all_data, target_data = load_dict_data(100000, 1000)</span></span><br><span class="line">    <span class="comment"># all_data, target_data = load_dict_data(1000000, 1000)</span></span><br><span class="line">    all_data, target_data = load_dict_data(<span class="number">2000000</span>, <span class="number">1000</span>)</span><br><span class="line">    last_time = find_test(all_data, target_data)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#dict查找的性能远远大于list</span></span><br><span class="line">    <span class="comment">#在list中随着list数据的增大 查找时间会增大</span></span><br><span class="line">    <span class="comment">#在dict中查找元素不会随着dict的增大而增大</span></span><br><span class="line">    <span class="built_in">print</span>(last_time)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1.  dict的key或者set的值 都必须是可以hash的</span></span><br><span class="line"><span class="comment">#不可变对象 都是可hash的， str， fronzenset， tuple，自己实现的类 __hash__</span></span><br><span class="line"><span class="comment">#2. dict的内存花销大，但是查询速度快， 自定义的对象 或者python内部的对象都是用dict包装的</span></span><br><span class="line"><span class="comment"># 3. dict的存储顺序和元素添加顺序有关</span></span><br><span class="line"><span class="comment"># 4. 添加数据有可能改变已有数据的顺序</span></span><br></pre></td></tr></table></figure>
<p>数组是一个连续的空间，不需要从头到尾遍历</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210215210226.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210215211649.png" alt=""></p>
<h1 id="python的变量"><a href="#python的变量" class="headerlink" title="python的变量"></a>python的变量</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#python和java中的变量本质不一样，python的变量实质上是一个指针 int str， 便利贴</span></span><br><span class="line"></span><br><span class="line">a = <span class="number">1</span></span><br><span class="line">a = <span class="string">&quot;abc&quot;</span></span><br><span class="line"><span class="comment">#1. a贴在1上面</span></span><br><span class="line"><span class="comment">#2. 先生成对象 然后贴便利贴</span></span><br><span class="line"></span><br><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>]</span><br><span class="line">b = a</span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">id</span>(a), <span class="built_in">id</span>(b))</span><br><span class="line"><span class="built_in">print</span> (a <span class="keyword">is</span> b)</span><br><span class="line"><span class="comment"># b.append(4)</span></span><br><span class="line"><span class="comment"># print (a)</span></span><br><span class="line"></span><br><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line">b = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">People</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">person = People()</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">type</span>(person) <span class="keyword">is</span> People:</span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;yes&quot;</span>)</span><br><span class="line"><span class="comment"># print(a == b)</span></span><br><span class="line"><span class="comment"># print (id(a), id(b))</span></span><br><span class="line"><span class="comment"># print (a is b)</span></span><br></pre></td></tr></table></figure>
<h2 id="一个经典的错误："><a href="#一个经典的错误：" class="headerlink" title="一个经典的错误："></a>一个经典的错误：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    a += b</span><br><span class="line">    <span class="keyword">return</span> a</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Company</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, staffs=[]</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.staffs = staffs</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, staff_name</span>):</span><br><span class="line">        self.staffs.append(staff_name)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">remove</span>(<span class="params">self, staff_name</span>):</span><br><span class="line">        self.staffs.remove(staff_name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    com1 = Company(<span class="string">&quot;com1&quot;</span>, [<span class="string">&quot;bobby1&quot;</span>, <span class="string">&quot;bobby2&quot;</span>])</span><br><span class="line">    com1.add(<span class="string">&quot;bobby3&quot;</span>)</span><br><span class="line">    com1.remove(<span class="string">&quot;bobby1&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> (com1.staffs)</span><br><span class="line"></span><br><span class="line">    com2 = Company(<span class="string">&quot;com2&quot;</span>)</span><br><span class="line">    com2.add(<span class="string">&quot;bobby&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(com2.staffs)</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span> (Company.__init__.__defaults__)</span><br><span class="line"></span><br><span class="line">    com3 = Company(<span class="string">&quot;com3&quot;</span>)</span><br><span class="line">    com3.add(<span class="string">&quot;bobby5&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> (com2.staffs)</span><br><span class="line">    <span class="built_in">print</span> (com3.staffs)</span><br><span class="line">    <span class="built_in">print</span> (com2.staffs <span class="keyword">is</span> com3.staffs)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># a = 1</span></span><br><span class="line">    <span class="comment"># b = 2</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># a = [1,2]</span></span><br><span class="line">    <span class="comment"># b = [3,4]</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># a = (1, 2)</span></span><br><span class="line">    <span class="comment"># b = (3, 4)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># c = add(a, b)</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># print(c)</span></span><br><span class="line">    <span class="comment"># print(a, b)</span></span><br></pre></td></tr></table></figure>
<h1 id="元类编程"><a href="#元类编程" class="headerlink" title="元类编程"></a>元类编程</h1><h2 id="property动态属性"><a href="#property动态属性" class="headerlink" title="property动态属性"></a>property动态属性</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime, date</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, birthday</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.birthday = birthday</span><br><span class="line">        self._age = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># def get_age(self):</span></span><br><span class="line">    <span class="comment">#     return datetime.now().year - self.birthday.year</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> datetime.now().year - self.birthday.year</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">self, value</span>):</span><br><span class="line">        self._age = value</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    user = User(<span class="string">&quot;cwz&quot;</span>, date(year=<span class="number">1994</span>, month=<span class="number">5</span>, day=<span class="number">10</span>))</span><br><span class="line">    user.age = <span class="number">30</span></span><br><span class="line">    <span class="built_in">print</span>(user._age)</span><br><span class="line">    <span class="built_in">print</span>(user.age)</span><br></pre></td></tr></table></figure>
<p><code>__getattr__</code>找不到属性触发，</p>
<p><code>__getattribute__</code> 不管有没有找到属性都会触发</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, birthday, info=&#123;&#125;</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.birthday = birthday</span><br><span class="line">        self.info = info</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getattr__</span>(<span class="params">self, item</span>):</span><br><span class="line">        <span class="keyword">return</span> self.info[item]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    user = User(<span class="string">&quot;cwz&quot;</span>, date(year=<span class="number">1994</span>, month=<span class="number">5</span>, day=<span class="number">10</span>), info=&#123;<span class="string">&quot;height&quot;</span>: <span class="number">178</span>&#125;)</span><br><span class="line">    <span class="built_in">print</span>(user.height)</span><br></pre></td></tr></table></figure>
<h2 id="属性描述符"><a href="#属性描述符" class="headerlink" title="属性描述符"></a>属性描述符</h2><p>举个例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name, birthday</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">        self.birthday = birthday</span><br><span class="line">        self._age = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> datetime.now().year - self.birthday.year</span><br><span class="line"></span><br><span class="line"><span class="meta">    @age.setter</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">age</span>(<span class="params">self, value</span>):</span><br><span class="line">        self._age = value</span><br></pre></td></tr></table></figure>
<p>如果要校验name是否是字符串类型，就需要<code>@age.setter</code>这样写重复的代码。</p>
<p>只要实现下面三个魔法方法中任意一个方法，就是属性描述符对象</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">IntField</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, instance, owner</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__set__</span>(<span class="params">self, instance, value</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delete__</span>(<span class="params">self, instance</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IntField</span>:</span><br><span class="line">    <span class="comment"># 数据属性描述符，实现了__get__和__set__</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, instance, owner</span>):</span><br><span class="line">        <span class="keyword">return</span> self.value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__set__</span>(<span class="params">self, instance, value</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, numbers.Integral):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;int value need&#x27;</span>)</span><br><span class="line">        self.value = value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__delete__</span>(<span class="params">self, instance</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NonDataField</span>:</span><br><span class="line">    <span class="comment"># 非数据属性描述符,只实现了__get__</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, instance, owner</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">  </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    age = IntField()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    user = User()</span><br><span class="line">    user.age = <span class="number">30</span></span><br><span class="line">    <span class="built_in">print</span>(user.age)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">如果user是某个类的实例，那么user.age（以及等价的getattr(user,’age’)）</span></span><br><span class="line"><span class="string">首先调用__getattribute__。如果类定义了__getattr__方法，</span></span><br><span class="line"><span class="string">那么在__getattribute__抛出 AttributeError 的时候就会调用到__getattr__，</span></span><br><span class="line"><span class="string">而对于描述符(__get__）的调用，则是发生在__getattribute__内部的。</span></span><br><span class="line"><span class="string">user = User(), 那么user.age 顺序如下：</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（1）如果“age”是出现在User或其基类的__dict__中， 且age是data descriptor (数据属性描述符)， 那么调用其__get__方法, 否则</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（2）如果“age”出现在user的__dict__中， 那么直接返回 obj.__dict__[‘age’]， 否则</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（3）如果“age”出现在User或其基类的__dict__中</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（3.1）如果age是non-data descriptor，那么调用其__get__方法， 否则</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（3.2）返回 __dict__[‘age’]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（4）如果User有__getattr__方法，调用__getattr__方法，否则</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">（5）抛出AttributeError</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<p>这样可以控制给对象赋值的行为</p>
<p><code>__new__</code>和<code>__init__</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot; in new &quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls)</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="built_in">print</span> (<span class="string">&quot; in init&quot;</span>)</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">a = <span class="built_in">int</span>()</span><br><span class="line"><span class="comment">#new 是用来控制对象的生成过程， 在对象生成之前</span></span><br><span class="line"><span class="comment">#init是用来完善对象的</span></span><br><span class="line"><span class="comment">#如果new方法不返回对象， 则不会调用init函数</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    user = User(name=<span class="string">&quot;bobby&quot;</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 函数动态创建类</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_class</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&quot;user&quot;</span>:</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;user&quot;</span></span><br><span class="line">        <span class="keyword">return</span> User</span><br><span class="line">    <span class="keyword">elif</span> name == <span class="string">&quot;company&quot;</span>:</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Company</span>:</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;company&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Company</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    my_class = create_class(<span class="string">&quot;user&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(my_class())</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#类也是对象，type创建类的类</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_class</span>(<span class="params">name</span>):</span><br><span class="line">    <span class="keyword">if</span> name == <span class="string">&quot;user&quot;</span>:</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">User</span>:</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;user&quot;</span></span><br><span class="line">        <span class="keyword">return</span> User</span><br><span class="line">    <span class="keyword">elif</span> name == <span class="string">&quot;company&quot;</span>:</span><br><span class="line">        <span class="keyword">class</span> <span class="title class_">Company</span>:</span><br><span class="line">            <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;company&quot;</span></span><br><span class="line">        <span class="keyword">return</span> Company</span><br><span class="line"></span><br><span class="line"><span class="comment">#type动态创建类</span></span><br><span class="line"><span class="comment"># User = type(&quot;User&quot;, (), &#123;&#125;)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">say</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;i am user&quot;</span></span><br><span class="line">    <span class="comment"># return self.name</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseClass</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">answer</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;i am baseclass&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MetaClass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls, *args, **kwargs)</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#什么是元类， 元类是创建类的类 对象&lt;-class(对象)&lt;-type</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(metaclass=MetaClass):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        self.name = name</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;user&quot;</span></span><br><span class="line"><span class="comment">#python中类的实例化过程，会首先寻找metaclass，通过metaclass去创建user类</span></span><br><span class="line"><span class="comment">#去创建类对象，实例</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># MyClass = create_class(&quot;user&quot;)</span></span><br><span class="line">    <span class="comment"># my_obj = MyClass()</span></span><br><span class="line">    <span class="comment"># print(type(my_obj))</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># User = type(&quot;User&quot;, (BaseClass, ), &#123;&quot;name&quot;:&quot;user&quot;, &quot;say&quot;:say&#125;)</span></span><br><span class="line">    my_obj = User(name=<span class="string">&quot;bobby&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(my_obj)</span><br></pre></td></tr></table></figure>
<h2 id="元类实现简单的ORM"><a href="#元类实现简单的ORM" class="headerlink" title="元类实现简单的ORM"></a>元类实现简单的ORM</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需求</span></span><br><span class="line"><span class="keyword">import</span> numbers</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Field</span>:</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">IntField</span>(<span class="title class_ inherited__">Field</span>):</span><br><span class="line">    <span class="comment"># 数据描述符</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, db_column, min_value=<span class="literal">None</span>, max_value=<span class="literal">None</span></span>):</span><br><span class="line">        self._value = <span class="literal">None</span></span><br><span class="line">        self.min_value = min_value</span><br><span class="line">        self.max_value = max_value</span><br><span class="line">        self.db_column = db_column</span><br><span class="line">        <span class="keyword">if</span> min_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(min_value, numbers.Integral):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;min_value must be int&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> min_value &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;min_value must be positive int&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> max_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(max_value, numbers.Integral):</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;max_value must be int&quot;</span>)</span><br><span class="line">            <span class="keyword">elif</span> max_value &lt; <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;max_value must be positive int&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> min_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> max_value <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">if</span> min_value &gt; max_value:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;min_value must be smaller than max_value&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, instance, owner</span>):</span><br><span class="line">        <span class="keyword">return</span> self._value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__set__</span>(<span class="params">self, instance, value</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, numbers.Integral):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;int value need&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> value &lt; self.min_value <span class="keyword">or</span> value &gt; self.max_value:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;value must between min_value and max_value&quot;</span>)</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CharField</span>(<span class="title class_ inherited__">Field</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, db_column, max_length=<span class="literal">None</span></span>):</span><br><span class="line">        self._value = <span class="literal">None</span></span><br><span class="line">        self.db_column = db_column</span><br><span class="line">        <span class="keyword">if</span> max_length <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;you must spcify max_lenth for charfiled&quot;</span>)</span><br><span class="line">        self.max_length = max_length</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__get__</span>(<span class="params">self, instance, owner</span>):</span><br><span class="line">        <span class="keyword">return</span> self._value</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__set__</span>(<span class="params">self, instance, value</span>):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">isinstance</span>(value, <span class="built_in">str</span>):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;string value need&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(value) &gt; self.max_length:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;value len excess len of max_length&quot;</span>)</span><br><span class="line">        self._value = value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ModelMetaClass</span>(<span class="title class_ inherited__">type</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__new__</span>(<span class="params">cls, name, bases, attrs, **kwargs</span>):</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">&quot;BaseModel&quot;</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls, name, bases, attrs, **kwargs)</span><br><span class="line">        fields = &#123;&#125;</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> attrs.items():</span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">isinstance</span>(value, Field):</span><br><span class="line">                fields[key] = value</span><br><span class="line">        attrs_meta = attrs.get(<span class="string">&quot;Meta&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">        _meta = &#123;&#125;</span><br><span class="line">        db_table = name.lower()</span><br><span class="line">        <span class="keyword">if</span> attrs_meta <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">            table = <span class="built_in">getattr</span>(attrs_meta, <span class="string">&quot;db_table&quot;</span>, <span class="literal">None</span>)</span><br><span class="line">            <span class="keyword">if</span> table <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                db_table = table</span><br><span class="line">        _meta[<span class="string">&quot;db_table&quot;</span>] = db_table</span><br><span class="line">        attrs[<span class="string">&quot;_meta&quot;</span>] = _meta</span><br><span class="line">        attrs[<span class="string">&quot;fields&quot;</span>] = fields</span><br><span class="line">        <span class="keyword">del</span> attrs[<span class="string">&quot;Meta&quot;</span>]</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__new__(cls, name, bases, attrs, **kwargs)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(metaclass=ModelMetaClass):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, *args, **kwargs</span>):</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> kwargs.items():</span><br><span class="line">            <span class="built_in">setattr</span>(self, key, value)</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>().__init__()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save</span>(<span class="params">self</span>):</span><br><span class="line">        fields = []</span><br><span class="line">        values = []</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> self.fields.items():</span><br><span class="line">            db_column = value.db_column</span><br><span class="line">            <span class="keyword">if</span> db_column <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                db_column = key.lower()</span><br><span class="line">            fields.append(db_column)</span><br><span class="line">            value = <span class="built_in">getattr</span>(self, key)</span><br><span class="line">            values.append(<span class="built_in">str</span>(value))</span><br><span class="line"></span><br><span class="line">        sql = <span class="string">&quot;insert &#123;db_table&#125;(&#123;fields&#125;) value(&#123;values&#125;)&quot;</span>.<span class="built_in">format</span>(db_table=self._meta[<span class="string">&quot;db_table&quot;</span>],</span><br><span class="line">                                                                   fields=<span class="string">&quot;,&quot;</span>.join(fields), values=<span class="string">&quot;,&quot;</span>.join(values))</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name = CharField(db_column=<span class="string">&quot;name&quot;</span>, max_length=<span class="number">10</span>)</span><br><span class="line">    age = IntField(db_column=<span class="string">&quot;age&quot;</span>, min_value=<span class="number">1</span>, max_value=<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        db_table = <span class="string">&quot;user&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    user = User(name=<span class="string">&quot;bobby&quot;</span>, age=<span class="number">28</span>)</span><br><span class="line">    <span class="comment"># user.name = &quot;bobby&quot;</span></span><br><span class="line">    <span class="comment"># user.age = 28</span></span><br><span class="line">    user.save()</span><br></pre></td></tr></table></figure>
<h1 id="python的迭代协议"><a href="#python的迭代协议" class="headerlink" title="python的迭代协议"></a>python的迭代协议</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#什么是迭代协议</span></span><br><span class="line"><span class="comment">#迭代器是什么？ 迭代器是访问集合内元素的一种方式， 一般用来遍历数据</span></span><br><span class="line"><span class="comment">#迭代器和以下标的访问方式不一样， 迭代器是不能返回的, 迭代器提供了一种惰性方式数据的方式</span></span><br><span class="line"><span class="comment">#[] list , __iter__</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterable, Iterator</span><br><span class="line">a = [<span class="number">1</span>,<span class="number">2</span>]</span><br><span class="line">iter_rator = <span class="built_in">iter</span>(a)</span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">isinstance</span>(a, Iterable))</span><br><span class="line"><span class="built_in">print</span> (<span class="built_in">isinstance</span>(iter_rator, Iterator))</span><br></pre></td></tr></table></figure>
<h2 id="迭代器和可迭代对象"><a href="#迭代器和可迭代对象" class="headerlink" title="迭代器和可迭代对象"></a>迭代器和可迭代对象</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Iterator</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Company</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, employee_list</span>):</span><br><span class="line">        self.employee = employee_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> MyIterator(self.employee)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># def __getitem__(self, item):</span></span><br><span class="line">    <span class="comment">#     return self.employee[item]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyIterator</span>(<span class="title class_ inherited__">Iterator</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, employee_list</span>):</span><br><span class="line">        self.iter_list = employee_list</span><br><span class="line">        self.index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__next__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment">#真正返回迭代值的逻辑</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            word = self.iter_list[self.index]</span><br><span class="line">        <span class="keyword">except</span> IndexError:</span><br><span class="line">            <span class="keyword">raise</span> StopIteration</span><br><span class="line">        self.index += <span class="number">1</span></span><br><span class="line">        <span class="keyword">return</span> word</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    company = Company([<span class="string">&quot;tom&quot;</span>, <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;jane&quot;</span>])</span><br><span class="line">    my_itor = <span class="built_in">iter</span>(company)</span><br><span class="line">    <span class="comment"># while True:</span></span><br><span class="line">    <span class="comment">#     try:</span></span><br><span class="line">    <span class="comment">#         print (next(my_itor))</span></span><br><span class="line">    <span class="comment">#     except StopIteration:</span></span><br><span class="line">    <span class="comment">#         pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># next(my_itor)</span></span><br><span class="line">    <span class="keyword">for</span> item <span class="keyword">in</span> company:</span><br><span class="line">        <span class="built_in">print</span> (item)</span><br></pre></td></tr></table></figure>
<h2 id="生成器的使用"><a href="#生成器的使用" class="headerlink" title="生成器的使用"></a>生成器的使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成器函数，函数里只要有yield关键字</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_func</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fib</span>(<span class="params">index</span>):</span><br><span class="line">    <span class="keyword">if</span> index &lt;= <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">return</span> fib(index-<span class="number">1</span>) + fib(index-<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fib2</span>(<span class="params">index</span>):</span><br><span class="line">    re_list = []</span><br><span class="line">    n,a,b = <span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n&lt;index:</span><br><span class="line">        re_list.append(b)</span><br><span class="line">        a,b = b, a+b</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> re_list</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_fib</span>(<span class="params">index</span>):</span><br><span class="line">    n,a,b = <span class="number">0</span>,<span class="number">0</span>,<span class="number">1</span></span><br><span class="line">    <span class="keyword">while</span> n&lt;index:</span><br><span class="line">        <span class="keyword">yield</span> b</span><br><span class="line">        a,b = b, a+b</span><br><span class="line">        n += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> data <span class="keyword">in</span> gen_fib(<span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span> (data)</span><br><span class="line"><span class="comment"># print (gen_fib(10))</span></span><br><span class="line"><span class="comment"># 斐波拉契 0 1 1 2 3 5 8</span></span><br><span class="line"><span class="comment">#惰性求值， 延迟求值提供了可能</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>():</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#生成器对象， python编译字节码的时候就产生了，</span></span><br><span class="line">    gen = gen_func()</span><br><span class="line">    <span class="keyword">for</span> value <span class="keyword">in</span> gen:</span><br><span class="line">        <span class="built_in">print</span> (value)</span><br><span class="line">    <span class="comment"># re = func()</span></span><br><span class="line">    <span class="comment"># pass</span></span><br></pre></td></tr></table></figure>
<h2 id="python是如何实现生成器的"><a href="#python是如何实现生成器的" class="headerlink" title="python是如何实现生成器的"></a>python是如何实现生成器的</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1.python中函数的工作原理</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line">frame = <span class="literal">None</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">foo</span>():</span><br><span class="line">    bar()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">bar</span>():</span><br><span class="line">    <span class="keyword">global</span> frame</span><br><span class="line">    frame = inspect.currentframe()</span><br><span class="line"></span><br><span class="line"><span class="comment">#python.exe会用一个叫做 PyEval_EvalFramEx(c函数)去执行foo函数， 首先会创建一个栈帧(stack frame)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">python一切皆对象，栈帧对象， 字节码对象</span></span><br><span class="line"><span class="string">当foo调用子函数 bar， 又会创建一个栈帧</span></span><br><span class="line"><span class="string">所有的栈帧都是分配在堆内存上，这就决定了栈帧可以独立于调用者存在</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="comment"># import dis</span></span><br><span class="line"><span class="comment"># print(dis.dis(foo))</span></span><br><span class="line"></span><br><span class="line">foo()</span><br><span class="line"><span class="built_in">print</span>(frame.f_code.co_name)</span><br><span class="line">caller_frame = frame.f_back</span><br><span class="line"><span class="built_in">print</span>(caller_frame.f_code.co_name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_func</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    name = <span class="string">&quot;bobby&quot;</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    age = <span class="number">30</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;imooc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> dis</span><br><span class="line">gen = gen_func()</span><br><span class="line"><span class="built_in">print</span> (dis.dis(gen))</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(gen.gi_frame.f_lasti)</span><br><span class="line"><span class="built_in">print</span>(gen.gi_frame.f_locals)</span><br><span class="line"><span class="built_in">next</span>(gen)</span><br><span class="line"><span class="built_in">print</span>(gen.gi_frame.f_lasti)</span><br><span class="line"><span class="built_in">print</span>(gen.gi_frame.f_locals)</span><br><span class="line"><span class="built_in">next</span>(gen)</span><br><span class="line"><span class="built_in">print</span>(gen.gi_frame.f_lasti)</span><br><span class="line"><span class="built_in">print</span>(gen.gi_frame.f_locals)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">company</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__getitem__</span>(<span class="params">self, item</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> UserList</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210216164600.png" alt=""></p>
<h2 id="生成器在UserList中的应用"><a href="#生成器在UserList中的应用" class="headerlink" title="生成器在UserList中的应用"></a>生成器在UserList中的应用</h2><h3 id="生成器读取大文件"><a href="#生成器读取大文件" class="headerlink" title="生成器读取大文件"></a>生成器读取大文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#500G, 特殊 一行</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">myreadlines</span>(<span class="params">f, newline</span>):</span><br><span class="line">  buf = <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">while</span> newline <span class="keyword">in</span> buf:</span><br><span class="line">      pos = buf.index(newline)</span><br><span class="line">      <span class="keyword">yield</span> buf[:pos]</span><br><span class="line">      buf = buf[pos + <span class="built_in">len</span>(newline):]</span><br><span class="line">    chunk = f.read(<span class="number">4096</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> chunk:</span><br><span class="line">      <span class="comment">#说明已经读到了文件结尾</span></span><br><span class="line">      <span class="keyword">yield</span> buf</span><br><span class="line">      <span class="keyword">break</span></span><br><span class="line">    buf += chunk</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&quot;input.txt&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> line <span class="keyword">in</span> myreadlines(f, <span class="string">&quot;&#123;|&#125;&quot;</span>):</span><br><span class="line">        <span class="built_in">print</span> (line)</span><br></pre></td></tr></table></figure>
<h1 id="socket编程"><a href="#socket编程" class="headerlink" title="socket编程"></a>socket编程</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210216203628.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line">server = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">server.bind((<span class="string">&#x27;0.0.0.0&#x27;</span>, <span class="number">8000</span>))</span><br><span class="line">server.listen()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">handle_sock</span>(<span class="params">sock, addr</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="built_in">print</span>(data.decode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">        re_data = <span class="built_in">input</span>()</span><br><span class="line">        sock.send(re_data.encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取从客户端发送的数据</span></span><br><span class="line"><span class="comment">#一次获取1k的数据</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    sock, addr = server.accept()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#用线程去处理新接收的连接(用户)</span></span><br><span class="line">    client_thread = threading.Thread(target=handle_sock, args=(sock, addr))</span><br><span class="line">    client_thread.start()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># data = sock.recv(1024)</span></span><br><span class="line">    <span class="comment"># print(data.decode(&quot;utf8&quot;))</span></span><br><span class="line">    <span class="comment"># re_data = input()</span></span><br><span class="line">    <span class="comment"># sock.send(re_data.encode(&quot;utf8&quot;))</span></span><br><span class="line">    <span class="comment"># server.close()</span></span><br><span class="line">    <span class="comment"># sock.close()</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># client</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line">client = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">client.connect((<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">8000</span>))</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    re_data = <span class="built_in">input</span>()</span><br><span class="line">    client.send(re_data.encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">    data = client.recv(<span class="number">1024</span>)</span><br><span class="line">    <span class="built_in">print</span>(data.decode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line"><span class="comment"># client.send(&quot;bobby&quot;.encode(&quot;utf8&quot;))</span></span><br><span class="line"><span class="comment"># data = client.recv(1024)</span></span><br><span class="line"><span class="comment"># print (data.decode(&quot;utf8&quot;))</span></span><br><span class="line"><span class="comment"># client.close()</span></span><br></pre></td></tr></table></figure>
<h2 id="socket模拟http请求"><a href="#socket模拟http请求" class="headerlink" title="socket模拟http请求"></a>socket模拟http请求</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#requests -&gt; urlib -&gt; socket</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment">#通过socket请求html</span></span><br><span class="line">    url = urlparse(url)</span><br><span class="line">    host = url.netloc</span><br><span class="line">    path = url.path</span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        path = <span class="string">&quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#建立socket连接</span></span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment"># client.setblocking(False)</span></span><br><span class="line">    client.connect((host, <span class="number">80</span>)) <span class="comment">#阻塞不会消耗cpu</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#不停的询问连接是否建立好， 需要while循环不停的去检查状态</span></span><br><span class="line">    <span class="comment">#做计算任务或者再次发起其他的连接请求</span></span><br><span class="line"></span><br><span class="line">    client.send(<span class="string">&quot;GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n&quot;</span>.<span class="built_in">format</span>(path, host).encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line"></span><br><span class="line">    data = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        d = client.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> d:</span><br><span class="line">            data += d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    data = data.decode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">    html_data = data.split(<span class="string">&quot;\r\n\r\n&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(html_data)</span><br><span class="line">    client.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">&quot;http://shop.projectsedu.com/goods/&#123;&#125;/&quot;</span>.<span class="built_in">format</span>(url)</span><br><span class="line">        get_url(url)</span><br><span class="line">    <span class="built_in">print</span>(time.time()-start_time)</span><br></pre></td></tr></table></figure>
<h1 id="python中的GIL"><a href="#python中的GIL" class="headerlink" title="python中的GIL"></a>python中的GIL</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#gil global interpreter lock （cpython）</span></span><br><span class="line"><span class="comment">#python中一个线程对应于c语言中的一个线程</span></span><br><span class="line"><span class="comment">#gil使得同一个时刻只有一个线程在一个cpu上执行字节码, 无法将多个线程映射到多个cpu上执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#gil会根据执行的字节码行数以及时间片释放gil，gil在遇到io的操作时候主动释放</span></span><br><span class="line"><span class="comment"># import dis</span></span><br><span class="line"><span class="comment"># def add(a):</span></span><br><span class="line"><span class="comment">#     a = a+1</span></span><br><span class="line"><span class="comment">#     return a</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># print(dis.dis(add))</span></span><br><span class="line"></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    <span class="comment">#1. dosomething1</span></span><br><span class="line">    <span class="comment">#2. io操作</span></span><br><span class="line">    <span class="comment"># 1. dosomething3</span></span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        total += <span class="number">1</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">desc</span>():</span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        total -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">thread1 = threading.Thread(target=add)</span><br><span class="line">thread2 = threading.Thread(target=desc)</span><br><span class="line">thread1.start()</span><br><span class="line">thread2.start()</span><br><span class="line"></span><br><span class="line">thread1.join()</span><br><span class="line">thread2.join()</span><br><span class="line"><span class="built_in">print</span>(total)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="python多线程编程"><a href="#python多线程编程" class="headerlink" title="python多线程编程"></a>python多线程编程</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#对于io操作来说，多线程和多进程性能差别不大</span></span><br><span class="line"><span class="comment">#1.通过Thread类实例化</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_detail_html</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;get detail html started&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;get detail html end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_detail_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;get detail url started&quot;</span>)</span><br><span class="line">    time.sleep(<span class="number">4</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;get detail url end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 通过继承Thread来实现多线程</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GetDetailHtml</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get detail html started&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get detail html end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GetDetailUrl</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=name)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get detail url started&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get detail url end&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>  __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    thread1 = GetDetailHtml(<span class="string">&quot;get_detail_html&quot;</span>)</span><br><span class="line">    thread2 = GetDetailUrl(<span class="string">&quot;get_detail_url&quot;</span>)</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    thread1.start()</span><br><span class="line">    thread2.start()</span><br><span class="line"></span><br><span class="line">    thread1.join()</span><br><span class="line">    thread2.join()</span><br><span class="line"></span><br><span class="line">    <span class="comment">#当主线程退出的时候， 子线程kill掉</span></span><br><span class="line">    <span class="built_in">print</span> (<span class="string">&quot;last time: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(time.time()-start_time))</span><br></pre></td></tr></table></figure>
<h2 id="线程通信方式-共享变量"><a href="#线程通信方式-共享变量" class="headerlink" title="线程通信方式- 共享变量"></a>线程通信方式- 共享变量</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#通过queue的方式进行线程间同步</span></span><br><span class="line"><span class="keyword">from</span> queue <span class="keyword">import</span> Queue</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_detail_html</span>(<span class="params">queue</span>):</span><br><span class="line">    <span class="comment">#爬取文章详情页</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        url = queue.get()</span><br><span class="line">        <span class="comment"># for url in detail_url_list:</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get detail html started&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get detail html end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_detail_url</span>(<span class="params">queue</span>):</span><br><span class="line">    <span class="comment"># 爬取文章列表页</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get detail url started&quot;</span>)</span><br><span class="line">        time.sleep(<span class="number">4</span>)</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">            queue.put(<span class="string">&quot;http://projectsedu.com/&#123;id&#125;&quot;</span>.<span class="built_in">format</span>(<span class="built_in">id</span>=i))</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;get detail url end&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 线程通信方式- 共享变量</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>  __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    detail_url_queue = Queue(maxsize=<span class="number">1000</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    thread_detail_url = threading.Thread(target=get_detail_url, args=(detail_url_queue,))</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>):</span><br><span class="line">        html_thread = threading.Thread(target=get_detail_html, args=(detail_url_queue,))</span><br><span class="line">        html_thread.start()</span><br><span class="line">    <span class="comment"># # thread2 = GetDetailUrl(&quot;get_detail_url&quot;)</span></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="comment"># thread_detail_url.start()</span></span><br><span class="line">    <span class="comment"># thread_detail_url1.start()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># thread1.join()</span></span><br><span class="line">    <span class="comment"># thread2.join()</span></span><br><span class="line">    detail_url_queue.task_done()</span><br><span class="line">    detail_url_queue.join()</span><br></pre></td></tr></table></figure>
<h2 id="线程同步Lock，Rlock-可重入锁"><a href="#线程同步Lock，Rlock-可重入锁" class="headerlink" title="线程同步Lock，Rlock(可重入锁)"></a>线程同步Lock，Rlock(可重入锁)</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Lock, RLock <span class="comment">#可重入的锁</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在同一个线程里面，可以连续调用多次acquire， 一定要注意acquire的次数要和release的次数相等</span></span><br><span class="line">total = <span class="number">0</span></span><br><span class="line">lock = RLock()</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>():</span><br><span class="line">    <span class="comment">#1. dosomething1</span></span><br><span class="line">    <span class="comment">#2. io操作</span></span><br><span class="line">    <span class="comment"># 1. dosomething3</span></span><br><span class="line">    <span class="keyword">global</span> lock</span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        lock.acquire()</span><br><span class="line">        lock.acquire()</span><br><span class="line">        total += <span class="number">1</span></span><br><span class="line">        lock.release()</span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">desc</span>():</span><br><span class="line">    <span class="keyword">global</span> total</span><br><span class="line">    <span class="keyword">global</span> lock</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1000000</span>):</span><br><span class="line">        lock.acquire()</span><br><span class="line">        total -= <span class="number">1</span></span><br><span class="line">        lock.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line">thread1 = threading.Thread(target=add)</span><br><span class="line">thread2 = threading.Thread(target=desc)</span><br><span class="line">thread1.start()</span><br><span class="line">thread2.start()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">thread1.join()</span><br><span class="line">thread2.join()</span><br><span class="line"><span class="built_in">print</span>(total)</span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 用锁会影响性能</span></span><br><span class="line"><span class="comment">#2. 锁会引起死锁</span></span><br><span class="line"><span class="comment">#死锁的情况 A（a，b）</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">A(a、b)</span></span><br><span class="line"><span class="string">acquire (a)</span></span><br><span class="line"><span class="string">acquire (b)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">B(a、b)</span></span><br><span class="line"><span class="string">acquire (a)</span></span><br><span class="line"><span class="string">acquire (b)</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="线程同步-Condition-条件变量-用于线程间复杂的同步"><a href="#线程同步-Condition-条件变量-用于线程间复杂的同步" class="headerlink" title="线程同步  Condition(条件变量)  用于线程间复杂的同步"></a>线程同步  Condition(条件变量)  用于线程间复杂的同步</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"></span><br><span class="line"><span class="comment">#条件变量， 用于复杂的线程间同步</span></span><br><span class="line"><span class="comment"># class XiaoAi(threading.Thread):</span></span><br><span class="line"><span class="comment">#     def __init__(self, lock):</span></span><br><span class="line"><span class="comment">#         super().__init__(name=&quot;小爱&quot;)</span></span><br><span class="line"><span class="comment">#         self.lock = lock</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     def run(self):</span></span><br><span class="line"><span class="comment">#         self.lock.acquire()</span></span><br><span class="line"><span class="comment">#         print(&quot;&#123;&#125; : 在 &quot;.format(self.name))</span></span><br><span class="line"><span class="comment">#         self.lock.release()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#         self.lock.acquire()</span></span><br><span class="line"><span class="comment">#         print(&quot;&#123;&#125; : 好啊 &quot;.format(self.name))</span></span><br><span class="line"><span class="comment">#         self.lock.release()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># class TianMao(threading.Thread):</span></span><br><span class="line"><span class="comment">#     def __init__(self, lock):</span></span><br><span class="line"><span class="comment">#         super().__init__(name=&quot;天猫精灵&quot;)</span></span><br><span class="line"><span class="comment">#         self.lock = lock</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     def run(self):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#         self.lock.acquire()</span></span><br><span class="line"><span class="comment">#         print(&quot;&#123;&#125; : 小爱同学 &quot;.format(self.name))</span></span><br><span class="line"><span class="comment">#         self.lock.release()</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#         self.lock.acquire()</span></span><br><span class="line"><span class="comment">#         print(&quot;&#123;&#125; : 我们来对古诗吧 &quot;.format(self.name))</span></span><br><span class="line"><span class="comment">#         self.lock.release()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#通过condition完成协同读诗</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">XiaoAi</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cond</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=<span class="string">&quot;小爱&quot;</span>)</span><br><span class="line">        self.cond = cond</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> self.cond:</span><br><span class="line">            self.cond.wait()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 在 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line">            self.cond.wait()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 好啊 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line">            self.cond.wait()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 君住长江尾 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line">            self.cond.wait()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 共饮长江水 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line">            self.cond.wait()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 此恨何时已 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line">            self.cond.wait()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 定不负相思意 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TianMao</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, cond</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__(name=<span class="string">&quot;天猫精灵&quot;</span>)</span><br><span class="line">        self.cond = cond</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">with</span> self.cond:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 小爱同学 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 我们来对古诗吧 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 我住长江头 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 日日思君不见君 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 此水几时休 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; : 只愿君心似我心 &quot;</span>.<span class="built_in">format</span>(self.name))</span><br><span class="line">            self.cond.notify()</span><br><span class="line">            self.cond.wait()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line">    cond = threading.Condition()</span><br><span class="line">    xiaoai = XiaoAi(cond)</span><br><span class="line">    tianmao = TianMao(cond)</span><br><span class="line"></span><br><span class="line">    <span class="comment">#启动顺序很重要</span></span><br><span class="line">    <span class="comment">#在调用with cond之后才能调用wait或者notify方法</span></span><br><span class="line">    <span class="comment">#condition有两层锁， 一把底层锁会在线程调用了wait方法的时候释放， 上面的锁会在每次调用wait的时候分配一把并放入到cond的等待队列中，等到notify方法的唤醒</span></span><br><span class="line">    xiaoai.start()</span><br><span class="line">    tianmao.start()</span><br></pre></td></tr></table></figure>
<h2 id="线程同步-Semaphore-使用"><a href="#线程同步-Semaphore-使用" class="headerlink" title="线程同步 - Semaphore 使用"></a>线程同步 - Semaphore 使用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Semaphore 是用于控制进入数量的锁</span></span><br><span class="line"><span class="comment">#文件， 读、写， 写一般只是用于一个线程写，读可以允许有多个</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#做爬虫</span></span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HtmlSpider</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url, sem</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.url = url</span><br><span class="line">        self.sem = sem</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        time.sleep(<span class="number">2</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;got html text success&quot;</span>)</span><br><span class="line">        self.sem.release()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UrlProducer</span>(threading.Thread):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, sem</span>):</span><br><span class="line">        <span class="built_in">super</span>().__init__()</span><br><span class="line">        self.sem = sem</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">run</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">            self.sem.acquire()  <span class="comment"># 🔓的数量减1</span></span><br><span class="line">            html_thread = HtmlSpider(<span class="string">&quot;https://baidu.com/&#123;&#125;&quot;</span>.<span class="built_in">format</span>(i), self.sem)</span><br><span class="line">            html_thread.start()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    sem = threading.Semaphore(<span class="number">3</span>)</span><br><span class="line">    url_producer = UrlProducer(sem)</span><br><span class="line">    url_producer.start()</span><br></pre></td></tr></table></figure>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed, wait, FIRST_COMPLETED</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> Future</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Pool</span><br><span class="line"></span><br><span class="line"><span class="comment">#未来对象，task的返回容器</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#线程池， 为什么要线程池</span></span><br><span class="line"><span class="comment">#主线程中可以获取某一个线程的状态或者某一个任务的状态，以及返回值</span></span><br><span class="line"><span class="comment">#当一个线程完成的时候我们主线程能立即知道</span></span><br><span class="line"><span class="comment">#futures可以让多线程和多进程编码接口一致</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">times</span>):</span><br><span class="line">    time.sleep(times)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;get page &#123;&#125; success&quot;</span>.<span class="built_in">format</span>(times))</span><br><span class="line">    <span class="keyword">return</span> times</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">executor = ThreadPoolExecutor(max_workers=<span class="number">2</span>)</span><br><span class="line"><span class="comment">#通过submit函数提交执行的函数到线程池中, submit 是立即返回</span></span><br><span class="line"><span class="comment"># task1 = executor.submit(get_html, (3))</span></span><br><span class="line"><span class="comment"># task2 = executor.submit(get_html, (2))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#要获取已经成功的task的返回</span></span><br><span class="line">urls = [<span class="number">3</span>,<span class="number">2</span>,<span class="number">4</span>]</span><br><span class="line">all_task = [executor.submit(get_html, (url)) <span class="keyword">for</span> url <span class="keyword">in</span> urls]</span><br><span class="line">wait(all_task, return_when=FIRST_COMPLETED)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;main&quot;</span>)</span><br><span class="line"><span class="comment"># for future in as_completed(all_task):</span></span><br><span class="line"><span class="comment">#     data = future.result()</span></span><br><span class="line"><span class="comment">#     print(&quot;get &#123;&#125; page&quot;.format(data))</span></span><br><span class="line"><span class="comment">#通过executor的map获取已经完成的task的值</span></span><br><span class="line"><span class="comment"># for data in executor.map(get_html, urls):</span></span><br><span class="line"><span class="comment">#     print(&quot;get &#123;&#125; page&quot;.format(data))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># #done方法用于判定某个任务是否完成</span></span><br><span class="line"><span class="comment"># print(task1.done())</span></span><br><span class="line"><span class="comment"># print(task2.cancel())</span></span><br><span class="line"><span class="comment"># time.sleep(3)</span></span><br><span class="line"><span class="comment"># print(task1.done())</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># #result方法可以获取task的执行结果</span></span><br><span class="line"><span class="comment"># print(task1.result())</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="多线程和多进程对比"><a href="#多线程和多进程对比" class="headerlink" title="多线程和多进程对比"></a>多线程和多进程对比</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor, as_completed</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ProcessPoolExecutor</span><br><span class="line"><span class="comment">#多进程编程</span></span><br><span class="line"><span class="comment">#耗cpu的操作，用多进程编程， 对于io操作来说， 使用多线程编程，进程切换代价要高于线程</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. 对于耗费cpu的操作，多进程优于多线程</span></span><br><span class="line"><span class="comment"># def fib(n):</span></span><br><span class="line"><span class="comment">#     if n&lt;=2:</span></span><br><span class="line"><span class="comment">#         return 1</span></span><br><span class="line"><span class="comment">#     return fib(n-1)+fib(n-2)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># if __name__ == &quot;__main__&quot;:</span></span><br><span class="line"><span class="comment">#     with ThreadPoolExecutor(3) as executor:</span></span><br><span class="line"><span class="comment">#         all_task = [executor.submit(fib, (num)) for num in range(25,40)]</span></span><br><span class="line"><span class="comment">#         start_time = time.time()</span></span><br><span class="line"><span class="comment">#         for future in as_completed(all_task):</span></span><br><span class="line"><span class="comment">#             data = future.result()</span></span><br><span class="line"><span class="comment">#             print(&quot;exe result: &#123;&#125;&quot;.format(data))</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#         print(&quot;last time is: &#123;&#125;&quot;.format(time.time()-start_time))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#2. 对于io操作来说，多线程优于多进程</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">random_sleep</span>(<span class="params">n</span>):</span><br><span class="line">    time.sleep(n)</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">with</span> ProcessPoolExecutor(<span class="number">3</span>) <span class="keyword">as</span> executor:</span><br><span class="line">        all_task = [executor.submit(random_sleep, (num)) <span class="keyword">for</span> num <span class="keyword">in</span> [<span class="number">2</span>]*<span class="number">30</span>]</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        <span class="keyword">for</span> future <span class="keyword">in</span> as_completed(all_task):</span><br><span class="line">            data = future.result()</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;exe result: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(data))</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;last time is: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(time.time()-start_time))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="multiprocessing-多进程编程"><a href="#multiprocessing-多进程编程" class="headerlink" title="multiprocessing 多进程编程"></a>multiprocessing 多进程编程</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># import os</span></span><br><span class="line"><span class="comment"># #fork只能用于linux/unix中</span></span><br><span class="line"><span class="comment"># pid = os.fork()</span></span><br><span class="line"><span class="comment"># print(&quot;bobby&quot;)</span></span><br><span class="line"><span class="comment"># if pid == 0:</span></span><br><span class="line"><span class="comment">#   print(&#x27;子进程 &#123;&#125; ，父进程是： &#123;&#125;.&#x27; .format(os.getpid(), os.getppid()))</span></span><br><span class="line"><span class="comment"># else:</span></span><br><span class="line"><span class="comment">#   print(&#x27;我是父进程：&#123;&#125;.&#x27;.format(pid))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> multiprocessing</span><br><span class="line"></span><br><span class="line"><span class="comment">#多进程编程</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">n</span>):</span><br><span class="line">    time.sleep(n)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;sub_progress success&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> n</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># progress = multiprocessing.Process(target=get_html, args=(2,))</span></span><br><span class="line">    <span class="comment"># print(progress.pid)</span></span><br><span class="line">    <span class="comment"># progress.start()</span></span><br><span class="line">    <span class="comment"># print(progress.pid)</span></span><br><span class="line">    <span class="comment"># progress.join()</span></span><br><span class="line">    <span class="comment"># print(&quot;main progress end&quot;)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#使用线程池</span></span><br><span class="line">    pool = multiprocessing.Pool(multiprocessing.cpu_count())</span><br><span class="line">    <span class="comment"># result = pool.apply_async(get_html, args=(3,))</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># #等待所有任务完成</span></span><br><span class="line">    <span class="comment"># pool.close()</span></span><br><span class="line">    <span class="comment"># pool.join()</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># print(result.get())</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#imap</span></span><br><span class="line">    <span class="comment"># for result in pool.imap(get_html, [1,5,3]):</span></span><br><span class="line">    <span class="comment">#     print(&quot;&#123;&#125; sleep success&quot;.format(result))</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> result <span class="keyword">in</span> pool.imap_unordered(get_html, [<span class="number">1</span>,<span class="number">5</span>,<span class="number">3</span>]):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;&#123;&#125; sleep success&quot;</span>.<span class="built_in">format</span>(result))</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="进程间通信"><a href="#进程间通信" class="headerlink" title="进程间通信"></a>进程间通信</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> multiprocessing <span class="keyword">import</span> Process, Queue, Pool, Manager, Pipe</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># def producer(queue):</span></span><br><span class="line"><span class="comment">#     queue.put(&quot;a&quot;)</span></span><br><span class="line"><span class="comment">#     time.sleep(2)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># def consumer(queue):</span></span><br><span class="line"><span class="comment">#     time.sleep(2)</span></span><br><span class="line"><span class="comment">#     data = queue.get()</span></span><br><span class="line"><span class="comment">#     print(data)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># if __name__ == &quot;__main__&quot;:</span></span><br><span class="line"><span class="comment">#     queue = Queue(10)</span></span><br><span class="line"><span class="comment">#     my_producer = Process(target=producer, args=(queue,))</span></span><br><span class="line"><span class="comment">#     my_consumer = Process(target=consumer, args=(queue,))</span></span><br><span class="line"><span class="comment">#     my_producer.start()</span></span><br><span class="line"><span class="comment">#     my_consumer.start()</span></span><br><span class="line"><span class="comment">#     my_producer.join()</span></span><br><span class="line"><span class="comment">#     my_consumer.join()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#共享全局变量通信</span></span><br><span class="line"><span class="comment">#共享全局变量不能适用于多进程编程，可以适用于多线程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># def producer(a):</span></span><br><span class="line"><span class="comment">#     a += 100</span></span><br><span class="line"><span class="comment">#     time.sleep(2)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># def consumer(a):</span></span><br><span class="line"><span class="comment">#     time.sleep(2)</span></span><br><span class="line"><span class="comment">#     print(a)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># if __name__ == &quot;__main__&quot;:</span></span><br><span class="line"><span class="comment">#     a = 1</span></span><br><span class="line"><span class="comment">#     my_producer = Process(target=producer, args=(a,))</span></span><br><span class="line"><span class="comment">#     my_consumer = Process(target=consumer, args=(a,))</span></span><br><span class="line"><span class="comment">#     my_producer.start()</span></span><br><span class="line"><span class="comment">#     my_consumer.start()</span></span><br><span class="line"><span class="comment">#     my_producer.join()</span></span><br><span class="line"><span class="comment">#     my_consumer.join()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#multiprocessing中的queue不能用于pool进程池</span></span><br><span class="line"><span class="comment">#pool中的进程间通信需要使用manager中的queue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def producer(queue):</span></span><br><span class="line"><span class="comment">#     queue.put(&quot;a&quot;)</span></span><br><span class="line"><span class="comment">#     time.sleep(2)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># def consumer(queue):</span></span><br><span class="line"><span class="comment">#     time.sleep(2)</span></span><br><span class="line"><span class="comment">#     data = queue.get()</span></span><br><span class="line"><span class="comment">#     print(data)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># if __name__ == &quot;__main__&quot;:</span></span><br><span class="line"><span class="comment">#     queue = Manager().Queue(10)</span></span><br><span class="line"><span class="comment">#     pool = Pool(2)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     pool.apply_async(producer, args=(queue,))</span></span><br><span class="line"><span class="comment">#     pool.apply_async(consumer, args=(queue,))</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     pool.close()</span></span><br><span class="line"><span class="comment">#     pool.join()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#通过pipe实现进程间通信</span></span><br><span class="line"><span class="comment">#pipe的性能高于queue</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># def producer(pipe):</span></span><br><span class="line"><span class="comment">#     pipe.send(&quot;bobby&quot;)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># def consumer(pipe):</span></span><br><span class="line"><span class="comment">#     print(pipe.recv())</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># if __name__ == &quot;__main__&quot;:</span></span><br><span class="line"><span class="comment">#     recevie_pipe, send_pipe = Pipe()</span></span><br><span class="line"><span class="comment">#     #pipe只能适用于两个进程</span></span><br><span class="line"><span class="comment">#     my_producer= Process(target=producer, args=(send_pipe, ))</span></span><br><span class="line"><span class="comment">#     my_consumer = Process(target=consumer, args=(recevie_pipe,))</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#     my_producer.start()</span></span><br><span class="line"><span class="comment">#     my_consumer.start()</span></span><br><span class="line"><span class="comment">#     my_producer.join()</span></span><br><span class="line"><span class="comment">#     my_consumer.join()</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_data</span>(<span class="params">p_dict, key, value</span>):</span><br><span class="line">    p_dict[key] = value</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    progress_dict = Manager().<span class="built_in">dict</span>()</span><br><span class="line">    <span class="keyword">from</span> queue <span class="keyword">import</span> PriorityQueue</span><br><span class="line"></span><br><span class="line">    first_progress = Process(target=add_data, args=(progress_dict, <span class="string">&quot;bobby1&quot;</span>, <span class="number">22</span>))</span><br><span class="line">    second_progress = Process(target=add_data, args=(progress_dict, <span class="string">&quot;bobby2&quot;</span>, <span class="number">23</span>))</span><br><span class="line"></span><br><span class="line">    first_progress.start()</span><br><span class="line">    second_progress.start()</span><br><span class="line">    first_progress.join()</span><br><span class="line">    second_progress.join()</span><br><span class="line"></span><br><span class="line">    <span class="built_in">print</span>(progress_dict)</span><br></pre></td></tr></table></figure>
<h1 id="协程"><a href="#协程" class="headerlink" title="协程"></a>协程</h1><p>并发、并行、同步、异步、阻塞、非阻塞</p>
<ul>
<li>并法是指一个时间段内，有几个程序在同一个cpu上运行，但是任意时刻只有一个程序在cpu上运行</li>
<li>并行是指任意时刻点上，有多个程序同时运行在多个cpu上</li>
<li>同步是指代码调用IO操作时，必须等待IO操作完成才返回的调用方式</li>
<li>异步是指代码调用IO操作时，不必等IO操作完成就返回的调用方式</li>
</ul>
<p>IO 多路复用 (select、poll 和 epoll)</p>
<p>C10k问题：是一个在1999年被提出的技术挑战，如何在一颗1GHz CPU，2G内存，1gbps网络环境下，让单台服务器同时为1万个客户端提供FTP服务</p>
<p>Unix下五种I/O模型</p>
<ul>
<li>阻塞式I/O</li>
<li>非阻塞式I/O</li>
<li>I/O复用</li>
<li>信号驱动式I/O</li>
<li>异步I/O(POSIX的aio_系列函数)</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210217205429.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210217205642.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210217210555.png" alt=""></p>
<p>调用select之后，操作系统会返回哪些文件句柄准备好了。select方法也是一个阻塞的方法，如果操作系统的文件句柄都没有准备好，就会阻塞住。select能够监听多个socket状态，只要有一个socket准备好就返回。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210217212400.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210217212439.png" alt=""></p>
<p>select、poll、epoll都是IO多路复用的机制。I/O多路复用就是通过一种机制一个进程可以监视多个描述符，一旦某个描述符就绪（一般是读就绪或者写就绪），能够通知程序进行相应的读写操作。但select、poll、epoll本质上都是同步I/O，因为他们都需要在读写事件就绪后自己负责进行读写，也就是说这个读写过程是阻塞的，而异步I/O则无需自己负责进行读写，异步I/O的实现会负责把数据从内核拷贝到用户空间。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210217213123.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210217213201.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210217213251.png" alt=""></p>
<p>epoll并不代表一定比select好<br>在并发高的情况下，连接活跃度不是很高， epoll比select<br>并发性不高，同时连接很活跃， select比epoll好</p>
<h2 id="通过非阻塞io实现http请求"><a href="#通过非阻塞io实现http请求" class="headerlink" title="通过非阻塞io实现http请求:"></a>通过非阻塞io实现http请求:</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. epoll并不代表一定比select好</span></span><br><span class="line"><span class="comment"># 在并发高的情况下，连接活跃度不是很高， epoll比select</span></span><br><span class="line"><span class="comment"># 并发性不高，同时连接很活跃， select比epoll好</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#通过非阻塞io实现http请求</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#使用非阻塞io完成http请求</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment">#通过socket请求html</span></span><br><span class="line">    url = urlparse(url)</span><br><span class="line">    host = url.netloc</span><br><span class="line">    path = url.path</span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        path = <span class="string">&quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#建立socket连接</span></span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    client.setblocking(<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client.connect((host, <span class="number">80</span>)) <span class="comment">#阻塞不会消耗cpu</span></span><br><span class="line">    <span class="keyword">except</span> BlockingIOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#不停的询问连接是否建立好， 需要while循环不停的去检查状态</span></span><br><span class="line">    <span class="comment">#做计算任务或者再次发起其他的连接请求</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            client.send(<span class="string">&quot;GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n&quot;</span>.<span class="built_in">format</span>(path, host).encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">except</span> OSError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    data = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            d = client.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">except</span> BlockingIOError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">if</span> d:</span><br><span class="line">            data += d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    data = data.decode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">    html_data = data.split(<span class="string">&quot;\r\n\r\n&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(html_data)</span><br><span class="line">    client.close()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    get_url(<span class="string">&quot;http://www.baidu.com&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="select-回调-事件循环"><a href="#select-回调-事件循环" class="headerlink" title="select+回调+事件循环"></a>select+回调+事件循环</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># select + 回调 + 事件循环</span></span><br><span class="line"><span class="comment">#  并发性高</span></span><br><span class="line"><span class="comment"># 使用单线程</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"><span class="keyword">from</span> selectors <span class="keyword">import</span> DefaultSelector, EVENT_READ, EVENT_WRITE</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">selector = DefaultSelector()</span><br><span class="line"><span class="comment">#使用select完成http请求</span></span><br><span class="line">urls = []</span><br><span class="line">stop = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Fetcher</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">connected</span>(<span class="params">self, key</span>):</span><br><span class="line">        selector.unregister(key.fd)</span><br><span class="line">        self.client.send(<span class="string">&quot;GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n&quot;</span>.<span class="built_in">format</span>(self.path, self.host).encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">        selector.register(self.client.fileno(), EVENT_READ, self.readable)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">readable</span>(<span class="params">self, key</span>):</span><br><span class="line">        d = self.client.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> d:</span><br><span class="line">            self.data += d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            selector.unregister(key.fd)</span><br><span class="line">            data = self.data.decode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">            html_data = data.split(<span class="string">&quot;\r\n\r\n&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">            <span class="built_in">print</span>(html_data)</span><br><span class="line">            self.client.close()</span><br><span class="line">            urls.remove(self.spider_url)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> urls:</span><br><span class="line">                <span class="keyword">global</span> stop</span><br><span class="line">                stop = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_url</span>(<span class="params">self, url</span>):</span><br><span class="line">        self.spider_url = url</span><br><span class="line">        url = urlparse(url)</span><br><span class="line">        self.host = url.netloc</span><br><span class="line">        self.path = url.path</span><br><span class="line">        self.data = <span class="string">b&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> self.path == <span class="string">&quot;&quot;</span>:</span><br><span class="line">            self.path = <span class="string">&quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 建立socket连接</span></span><br><span class="line">        self.client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">        self.client.setblocking(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.client.connect((self.host, <span class="number">80</span>))  <span class="comment"># 阻塞不会消耗cpu</span></span><br><span class="line">        <span class="keyword">except</span> BlockingIOError <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#注册</span></span><br><span class="line">        selector.register(self.client.fileno(), EVENT_WRITE, self.connected)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">loop</span>():</span><br><span class="line">    <span class="comment">#事件循环，不停的请求socket的状态并调用对应的回调函数</span></span><br><span class="line">    <span class="comment">#1. select本身是不支持register模式</span></span><br><span class="line">    <span class="comment">#2. socket状态变化以后的回调是由程序员完成的</span></span><br><span class="line">    <span class="keyword">while</span> <span class="keyword">not</span> stop:</span><br><span class="line">        ready = selector.select()</span><br><span class="line">        <span class="keyword">for</span> key, mask <span class="keyword">in</span> ready:</span><br><span class="line">            call_back = key.data</span><br><span class="line">            call_back(key)</span><br><span class="line">    <span class="comment">#回调+事件循环+select(poll\epoll)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    fetcher = Fetcher()</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">&quot;http://shop.projectsedu.com/goods/&#123;&#125;/&quot;</span>.<span class="built_in">format</span>(url)</span><br><span class="line">        urls.append(url)</span><br><span class="line">        fetcher = Fetcher()</span><br><span class="line">        fetcher.get_url(url)</span><br><span class="line">    loop()</span><br><span class="line">    <span class="built_in">print</span>(time.time()-start_time)</span><br><span class="line"></span><br><span class="line"><span class="comment"># def get_url(url):</span></span><br><span class="line"><span class="comment">#     #通过socket请求html</span></span><br><span class="line"><span class="comment">#     url = urlparse(url)</span></span><br><span class="line"><span class="comment">#     host = url.netloc</span></span><br><span class="line"><span class="comment">#     path = url.path</span></span><br><span class="line"><span class="comment">#     if path == &quot;&quot;:</span></span><br><span class="line"><span class="comment">#         path = &quot;/&quot;</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#     #建立socket连接</span></span><br><span class="line"><span class="comment">#     client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span></span><br><span class="line"><span class="comment">#     client.setblocking(False)</span></span><br><span class="line"><span class="comment">#     try:</span></span><br><span class="line"><span class="comment">#         client.connect((host, 80)) #阻塞不会消耗cpu</span></span><br><span class="line"><span class="comment">#     except BlockingIOError as e:</span></span><br><span class="line"><span class="comment">#         pass</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#     #不停的询问连接是否建立好， 需要while循环不停的去检查状态</span></span><br><span class="line"><span class="comment">#     #做计算任务或者再次发起其他的连接请求</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#     while True:</span></span><br><span class="line"><span class="comment">#         try:</span></span><br><span class="line"><span class="comment">#             client.send(&quot;GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n&quot;.format(path, host).encode(&quot;utf8&quot;))</span></span><br><span class="line"><span class="comment">#             break</span></span><br><span class="line"><span class="comment">#         except OSError as e:</span></span><br><span class="line"><span class="comment">#             pass</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#     data = b&quot;&quot;</span></span><br><span class="line"><span class="comment">#     while True:</span></span><br><span class="line"><span class="comment">#         try:</span></span><br><span class="line"><span class="comment">#             d = client.recv(1024)</span></span><br><span class="line"><span class="comment">#         except BlockingIOError as e:</span></span><br><span class="line"><span class="comment">#             continue</span></span><br><span class="line"><span class="comment">#         if d:</span></span><br><span class="line"><span class="comment">#             data += d</span></span><br><span class="line"><span class="comment">#         else:</span></span><br><span class="line"><span class="comment">#             break</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment">#     data = data.decode(&quot;utf8&quot;)</span></span><br><span class="line"><span class="comment">#     html_data = data.split(&quot;\r\n\r\n&quot;)[1]</span></span><br><span class="line"><span class="comment">#     print(html_data)</span></span><br><span class="line"><span class="comment">#     client.close()</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="回调之痛"><a href="#回调之痛" class="headerlink" title="回调之痛"></a>回调之痛</h2><ul>
<li>如果回调函数执行不正常该怎么办？</li>
<li>如果回调里面还要嵌套回调怎么办？要嵌套很多层怎么办？</li>
<li>如果嵌套了很多层，其中某个环节出错了会造成什么后果？</li>
<li>如果有个数据需要被每个回调都处理怎么办？</li>
<li>怎么使用当前函数中的局部变量？</li>
<li>…… </li>
</ul>
<p>可读性差、共享状态管理困难、异常处理困难</p>
<p>协程</p>
<p>C10M问题：如何利用8核心CPU，64G内存，在10gbps的网络上保持1000万并发连接</p>
<p>问题：</p>
<ul>
<li>回调模式编码复杂度高</li>
<li>同步编程的并法性不高</li>
<li>多线程编程需要线程间同步</li>
</ul>
<ul>
<li>采用同步的方式去编写异步的代码</li>
<li>使用单线程去切换任务</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment">#do someting 1</span></span><br><span class="line">    html = get_html(url) <span class="comment">#此处暂停，切换到另一个函数去执行</span></span><br><span class="line">    <span class="comment"># #parse html</span></span><br><span class="line">    urls = parse_url(html)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment">#do someting 1</span></span><br><span class="line">    html = get_html(url) <span class="comment">#此处暂停，切换到另一个函数去执行</span></span><br><span class="line">    <span class="comment"># #parse html</span></span><br><span class="line">    urls = parse_url(html)</span><br><span class="line"></span><br><span class="line"><span class="comment">#传统函数调用 过程 A-&gt;B-&gt;C</span></span><br><span class="line"><span class="comment">#我们需要一个可以暂停的函数，并且可以在适当的时候恢复该函数的继续执行</span></span><br><span class="line"><span class="comment">#出现了协程 -&gt; 有多个入口的函数， 可以暂停的函数， 可以暂停的函数(可以向暂停的地方传入值)</span></span><br></pre></td></tr></table></figure>
<p>生成器进阶-send、close和throw方法</p>
<p>生成器不只可以产出值，还可以传出值。</p>
<p>send方法：</p>
<ul>
<li>启动生成器的方式有两种，next()和send()</li>
<li>send方法可以传递值进入生成器内部，同时还可以重启生成器执行到下一个yield位置</li>
<li>在调用send发送非None值之前，我们必须启动一次生成器，方式有两种，1、gen.send(None)  2、next(gen)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen_func</span>():</span><br><span class="line">    <span class="comment"># 可以产出值，可以接收值(调用方传递进来的值)</span></span><br><span class="line">    html = <span class="keyword">yield</span> <span class="string">&quot;https://www.jd.com&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(html)</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    <span class="comment"># url = next(gen)</span></span><br><span class="line">    <span class="comment"># 在调用send发送非None值之前，我们必须启动一次生成器，方式有两种，1、gen.send(None)  2、next(gen)</span></span><br><span class="line">    gen.send(<span class="literal">None</span>)</span><br><span class="line">    <span class="comment"># 模拟页面内容</span></span><br><span class="line">    html_content = <span class="string">&quot;网址内容&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(gen.send(html_content))   <span class="comment"># send方法可以传递值进入生成器内部，同时还可以重启生成器执行到下一个yield位置</span></span><br><span class="line">    <span class="comment"># 启动生成器方式有两种，next(),  send()</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 输出结果：</span></span><br><span class="line">网址内容</span><br><span class="line"><span class="number">2</span></span><br></pre></td></tr></table></figure>
<p>close方法：</p>
<ul>
<li>会关闭生成器，RuntimeError: generator ignored GeneratorExit</li>
<li>这里抛出异常是向下执行yield抛出的。</li>
<li>不捕捉异常是不会抛错的，gen.close() 之后再next(gen)，会抛出StopIteration</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen_func</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&quot;https://www.baidu.com&quot;</span></span><br><span class="line">    <span class="keyword">except</span> GeneratorExit:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">next</span>(gen))</span><br><span class="line">    gen.close()  <span class="comment"># RuntimeError: generator ignored GeneratorExit</span></span><br><span class="line">    <span class="comment"># print(next(gen))</span></span><br></pre></td></tr></table></figure>
<p>throw方法：</p>
<ul>
<li>抛出异常，在当前yield抛出，必须要手动捕获异常，不像close方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen_func</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">yield</span> <span class="string">&quot;https://www.baidu.com&quot;</span></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">2</span></span><br><span class="line">    <span class="keyword">yield</span> <span class="number">3</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">next</span>(gen))</span><br><span class="line">    gen.throw(Exception, <span class="string">&quot;download error&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">next</span>(gen))</span><br></pre></td></tr></table></figure>
<h2 id="yield-from"><a href="#yield-from" class="headerlink" title="yield_from"></a>yield_from</h2><p>python3.3新加了yield from语法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> itertools <span class="keyword">import</span> chain</span><br><span class="line"></span><br><span class="line">my_list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">my_dict = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;reese&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> value <span class="keyword">in</span> chain(my_list, my_dict, <span class="built_in">range</span>(<span class="number">2</span>, <span class="number">5</span>)):</span><br><span class="line">    <span class="built_in">print</span>(value)</span><br></pre></td></tr></table></figure>
<p>chain可以传入任意可迭代对象。</p>
<p>自己实现chain:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">my_list = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">my_dict = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;reese&quot;</span>,</span><br><span class="line">    <span class="string">&quot;age&quot;</span>: <span class="number">18</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">my_chain</span>(<span class="params">*args, **kwargs</span>):</span><br><span class="line">    <span class="keyword">for</span> iterable_value <span class="keyword">in</span> args:</span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> iterable_value:</span><br><span class="line">            <span class="keyword">yield</span> value</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> my_chain(my_list, my_dict):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br></pre></td></tr></table></figure>
<p>yield from + 可迭代对象，举个例子说明yield from和yield的区别</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">g1</span>(<span class="params">iterable</span>):</span><br><span class="line">    <span class="keyword">yield</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">g2</span>(<span class="params">iterable</span>):</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> iterable</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> g1(<span class="built_in">range</span>(<span class="number">5</span>)):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> g2(<span class="built_in">range</span>(<span class="number">5</span>)):</span><br><span class="line">    <span class="built_in">print</span>(i)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 输入结果：</span></span><br><span class="line"><span class="built_in">range</span>(<span class="number">0</span>, <span class="number">5</span>)</span><br><span class="line"><span class="number">0</span></span><br><span class="line"><span class="number">1</span></span><br><span class="line"><span class="number">2</span></span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>
<p>yield from的一些概念:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">g1</span>(<span class="params">gen</span>):</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">from</span> gen</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    g = g1(<span class="number">1</span>)</span><br><span class="line">    g.send(<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="comment"># main是调用方，g1是委托生成器，gen是子生成器</span></span><br><span class="line"><span class="comment"># yield from 会在调用方与子生成器之间建立一个双向通道</span></span><br><span class="line"><span class="comment"># 传统写函数的时候，g1是一个调用函数，yield from理解为调用一个子函数，子函数的返回是返回个g1，在返回给main。现在有个yield from  直接在调用方main和gen之间建立了通道，main中的send直接发给了子生成器了</span></span><br></pre></td></tr></table></figure>
<p>yield from的用法：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">final_result = &#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子生成器，将外界传过来的值做保存</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">sales_sum</span>(<span class="params">pro_name</span>):</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    nums = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 不停地从外界接收值，放在nums和total里面</span></span><br><span class="line">        x = <span class="keyword">yield</span></span><br><span class="line">        <span class="built_in">print</span>(pro_name + <span class="string">&quot;销量: &quot;</span>, x)</span><br><span class="line">        <span class="comment"># 如果外界传过来的值是None，就退出循环</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> x:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        total += x</span><br><span class="line">        nums.append(x)</span><br><span class="line">    <span class="keyword">return</span> total, nums</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 委托生成器</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">middle</span>(<span class="params">key</span>):</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        final_result[key] = <span class="keyword">yield</span> <span class="keyword">from</span> sales_sum(key)</span><br><span class="line">        <span class="built_in">print</span>(key + <span class="string">&quot;销量统计完成！！&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    data_sets = &#123;</span><br><span class="line">        <span class="string">&quot;小明牌面膜&quot;</span>: [<span class="number">1200</span>, <span class="number">1500</span>, <span class="number">3000</span>],</span><br><span class="line">        <span class="string">&quot;小明牌手机&quot;</span>: [<span class="number">28</span>, <span class="number">55</span>, <span class="number">98</span>, <span class="number">108</span>],</span><br><span class="line">        <span class="string">&quot;小明牌大衣&quot;</span>: [<span class="number">280</span>, <span class="number">560</span>, <span class="number">778</span>, <span class="number">70</span>],</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> key, data_set <span class="keyword">in</span> data_sets.items():</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;start key:&quot;</span>, key)</span><br><span class="line">        m = middle(key)</span><br><span class="line">        m.send(<span class="literal">None</span>)  <span class="comment"># 预激middle协程，send是send到子生成器sales_sum中</span></span><br><span class="line">        <span class="keyword">for</span> value <span class="keyword">in</span> data_set:</span><br><span class="line">            m.send(value)  <span class="comment"># 给协程传递每一组的值</span></span><br><span class="line">        m.send(<span class="literal">None</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;final_result:&quot;</span>, final_result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>上面的代码中，如果将yield from直接替换成子生成器sales_num方法，会怎么样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">sales_sum</span>(<span class="params">pro_name</span>):</span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">    nums = []</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="comment"># 不停地从外界接收值，放在nums和total里面</span></span><br><span class="line">        x = <span class="keyword">yield</span></span><br><span class="line">        <span class="built_in">print</span>(pro_name + <span class="string">&quot;销量: &quot;</span>, x)</span><br><span class="line">        <span class="comment"># 如果外界传过来的值是None，就退出循环</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> x:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        total += x</span><br><span class="line">        nums.append(x)</span><br><span class="line">    <span class="keyword">return</span> total, nums</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    my_gen = sales_sum(<span class="string">&quot;小明牌手机&quot;</span>)</span><br><span class="line">    my_gen.send(<span class="literal">None</span>)</span><br><span class="line">    my_gen.send(<span class="number">1200</span>)</span><br><span class="line">    my_gen.send(<span class="number">1500</span>)</span><br><span class="line">    my_gen.send(<span class="number">3000</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        my_gen.send(<span class="literal">None</span>)</span><br><span class="line">    <span class="keyword">except</span> StopIteration <span class="keyword">as</span> e:</span><br><span class="line">        result = e.value</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br></pre></td></tr></table></figure>
<p>需要手动处理StopIteration异常，才能将处理的值返回到 final_result[key]这里。</p>
<p>yield from原理说明：</p>
<p>基础版：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#pep380规定了yield from</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. RESULT = yield from EXPR可以简化成下面这样</span></span><br><span class="line"><span class="comment">#一些说明</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">_i：子生成器，同时也是一个迭代器</span></span><br><span class="line"><span class="string">_y：子生成器生产的值</span></span><br><span class="line"><span class="string">_r：yield from 表达式最终的值</span></span><br><span class="line"><span class="string">_s：调用方通过send()发送的值</span></span><br><span class="line"><span class="string">_e：异常对象</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">_i = <span class="built_in">iter</span>(EXPR)      <span class="comment"># EXPR是一个可迭代对象，_i其实是子生成器；</span></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    _y = <span class="built_in">next</span>(_i)   <span class="comment"># 预激子生成器，把产出的第一个值存在_y中；</span></span><br><span class="line"><span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">    _r = _e.value   <span class="comment"># 如果抛出了`StopIteration`异常，那么就将异常对象的`value`属性保存到_r，这是最简单的情况的返回值；</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:    <span class="comment"># 尝试执行这个循环，委托生成器会阻塞；</span></span><br><span class="line">        _s = <span class="keyword">yield</span> _y   <span class="comment"># 生产子生成器的值，等待调用方`send()`值，发送过来的值将保存在_s中；</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _y = _i.send(_s)    <span class="comment"># 转发_s，并且尝试向下执行；</span></span><br><span class="line">        <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">            _r = _e.value       <span class="comment"># 如果子生成器抛出异常，那么就获取异常对象的`value`属性存到_r，退出循环，恢复委托生成器的运行；</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">RESULT = _r     <span class="comment"># _r就是整个yield from表达式返回的值。</span></span><br></pre></td></tr></table></figure>
<p>上面的过程只是处理一般的情况，可能还需要处理以下情况：</p>
<ul>
<li>子生成器可能只是一个迭代器，并不是一个作为协程的生成器，所以它不支持.throw()和.close()方法</li>
<li>如果子生成器支持.throw()和.close()方法，但是在子生成器内部，这两个方法都会抛出异常</li>
<li>调用方让子生成器自己抛出异常</li>
<li>当调用方使用next()或者.send(None)时，都要在子生成器上调用next()函数，当调用方使用.send()发送非 None 值时，才调用子生成器的.send()方法</li>
</ul>
<p>完整版逻辑：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">_i = <span class="built_in">iter</span>(EXPR)</span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    _y = <span class="built_in">next</span>(_i)</span><br><span class="line"><span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">    _r = _e.value</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="keyword">while</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            _s = <span class="keyword">yield</span> _y</span><br><span class="line">        <span class="keyword">except</span> GeneratorExit <span class="keyword">as</span> _e:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _m = _i.close</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">pass</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                _m()</span><br><span class="line">            <span class="keyword">raise</span> _e</span><br><span class="line">        <span class="keyword">except</span> BaseException <span class="keyword">as</span> _e:</span><br><span class="line">            _x = sys.exc_info()</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                _m = _i.throw</span><br><span class="line">            <span class="keyword">except</span> AttributeError:</span><br><span class="line">                <span class="keyword">raise</span> _e</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    _y = _m(*_x)</span><br><span class="line">                <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">                    _r = _e.value</span><br><span class="line">                    <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="keyword">if</span> _s <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                    _y = <span class="built_in">next</span>(_i)</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    _y = _i.send(_s)</span><br><span class="line">            <span class="keyword">except</span> StopIteration <span class="keyword">as</span> _e:</span><br><span class="line">                _r = _e.value</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">RESULT = _r</span><br></pre></td></tr></table></figure>
<ul>
<li>while 1上面的逻辑和前面的一致，都是先获取一个迭代器然后next()，处理StopIteration。但是在调用while 1的时候，可能从外部接收到GeneratorExit（可能直接按了ctrl+c），这里首先获取<code>_i</code>的close，但是<code>_i</code>可能只是一个迭代器不是生成器，这时候调用close属性会抛出AttributeError，这种情况会将它忽略掉。然后调用close()方法，raise掉异常。</li>
<li>还有BaseException是所有异常的父类，首先做了try，获取throw()方法。如果有throw()，调用之后会处理StopIteration</li>
<li>如果没有异常，在<code>_s</code>为None的时候就要调用next()，不为None就调用send方法，最后处理一下StopIteration</li>
</ul>
<p>总结一下关键点：</p>
<ul>
<li>子生成器生产的值，都是直接传给调用方的；调用方通过.send()发送的值都是直接传递给子生成器的；如果发送的是 None，会调用子生成器的<code>__next__()</code>方法，如果不是 None，会调用子生成器的.send()方法；</li>
<li>子生成器退出的时候，最后的return EXPR，会触发一个StopIteration(EXPR)异常；</li>
<li>yield from表达式的值，是子生成器终止时，传递给StopIteration异常的第一个参数；</li>
<li>如果调用的时候出现StopIteration异常，委托生成器会恢复运行，同时其他的异常会向上 “冒泡”；</li>
<li>传入委托生成器的异常里，除了GeneratorExit之外，其他的所有异常全部传递给子生成器的.throw()方法；如果调用.throw()的时候出现了StopIteration异常，那么就恢复委托生成器的运行，其他的异常全部向上 “冒泡”；</li>
<li>如果在委托生成器上调用.close()或传入GeneratorExit异常，会调用子生成器的.close()方法，没有的话就不调用。如果在调用.close()的时候抛出了异常，那么就向上 “冒泡”，否则的话委托生成器会抛出GeneratorExit异常。</li>
</ul>
<h2 id="async和await定义原生的协程"><a href="#async和await定义原生的协程" class="headerlink" title="async和await定义原生的协程"></a>async和await定义原生的协程</h2><ul>
<li>python为了将语义变得更加明确，就引入了async和await关键词用于定义原生的协程</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections.abc <span class="keyword">import</span> Awaitable</span><br><span class="line"></span><br><span class="line"><span class="comment"># Awaitable对象主要是实现了__await__方法</span></span><br><span class="line"><span class="comment"># async关键字定义的函数是实现了__await__方法的</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">downloader</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;url&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">download_url</span>(<span class="params">url</span>):</span><br><span class="line">    html = <span class="keyword">await</span> downloader(url)  <span class="comment"># await后面跟的是Awaitable对象，可以将await理解成yield from</span></span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    coro = download_url(<span class="string">&quot;https://www.baidu.com&quot;</span>)</span><br><span class="line">    <span class="comment"># next(coro)</span></span><br><span class="line">    coro.send(<span class="literal">None</span>)</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210224130145.png" alt=""></p>
<p>装饰器+生成器来实现协程，不建议</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210224130612.png" alt=""></p>
<h2 id="生成器是如何变成协程的："><a href="#生成器是如何变成协程的：" class="headerlink" title="生成器是如何变成协程的："></a>生成器是如何变成协程的：</h2><p>我们希望协程是能够用单线程来调度的，这样我们就不需要像线程一样让操作系统去调度。协程是由程序员自己去调度的，它没有深入到内核级别去进行调度，进程和线程都是内核级别的调度，而协程是函数级别的调度。我们希望协程是由自己来决定什么时候来调用，并且能够像写同步代码一样来编写异步代码。 而生成器就可以完成协程这样的功能。</p>
<p>生成器是有状态的：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#生成器是可以暂停的函数</span></span><br><span class="line"><span class="keyword">import</span> inspect</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">gen_func</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    gen = gen_func()</span><br><span class="line">    <span class="built_in">print</span>(inspect.getgeneratorstate(gen)) <span class="comment"># GEN_CREATED</span></span><br><span class="line">    <span class="built_in">next</span>(gen)</span><br><span class="line">    <span class="built_in">print</span>(inspect.getgeneratorstate(gen)) <span class="comment"># GEN_SUSPENDED</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="built_in">next</span>(gen)</span><br><span class="line">    <span class="keyword">except</span> StopIteration:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="built_in">print</span>(inspect.getgeneratorstate(gen))  <span class="comment"># GEN_CLOSED</span></span><br></pre></td></tr></table></figure>
<p>从上面的代码也可以看出来，生成器的很多功能就奠定了我们可以用生成器来实现协程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">gen_func</span>():</span><br><span class="line">    value = <span class="keyword">yield</span> <span class="number">1</span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cwz&quot;</span></span><br></pre></td></tr></table></figure>
<p>上面的代码中，value = yield 1有两层含义：</p>
<ul>
<li>第一，返回值给调用方</li>
<li>第二：调用方通过send方式返回值给gen</li>
</ul>
<p>其中有了这两层含义就可以看作是协程了，现在可以消费从外面传递进来的数据。之前的生成器只是一个生产者，只是yield值出去，现在变成了一个消费者，可以接收值进来做一个处理。这种模式就可以称作是协程了，再加上yield from，就更加是了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. 用同步的方式编写异步的代码， 在适当的时候暂停函数并在适当的时候启动函数</span></span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_socket_data</span>():</span><br><span class="line">    <span class="keyword">yield</span> <span class="string">&quot;bobby&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">downloader</span>(<span class="params">url</span>):</span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    client.setblocking(<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        client.connect((host, <span class="number">80</span>))  <span class="comment"># 阻塞不会消耗cpu</span></span><br><span class="line">    <span class="keyword">except</span> BlockingIOError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    selector.register(self.client.fileno(), EVENT_WRITE, self.connected)</span><br><span class="line">    source = <span class="keyword">yield</span> <span class="keyword">from</span> get_socket_data()</span><br><span class="line">    data = source.decode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">    html_data = data.split(<span class="string">&quot;\r\n\r\n&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(html_data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">download_html</span>(<span class="params">html</span>):</span><br><span class="line">    html = <span class="keyword">yield</span> <span class="keyword">from</span> downloader()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment">#协程的调度依然是 事件循环+协程模式 ，协程是单线程模式</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h1 id="asyncio并发编程"><a href="#asyncio并发编程" class="headerlink" title="asyncio并发编程"></a>asyncio并发编程</h1><p>asyncio模块介绍</p>
<ul>
<li><p>包含各种特定系统实现的模块化事件循环</p>
</li>
<li><p>传输和协议抽象</p>
</li>
<li>对TCP、UDP、SSL、子进程呢个、延时调用以及其他的具体支持</li>
<li>模仿futures模块但适用于事件循环使用的Future类</li>
<li>基于yield from的协议和任务，可以让你用顺序的方式编写并发代码</li>
<li>必须使用一个将产生阻塞IO的调用时，有接口可以把这个事件转移到线程池</li>
<li>模仿threading模块中的同步原语，可以用在单线程内的协程之间</li>
</ul>
<p>使用asyncio</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start get html&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end get html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(get_html(<span class="string">&quot;https://www.baidu.com&quot;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;use time：&quot;</span>, time.time() - start)</span><br></pre></td></tr></table></figure>
<p>模拟访问10个网页</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start get html&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end get html&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    start = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    tasks = [get_html(<span class="string">&quot;https://www.baidu.com&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;use time：&quot;</span>, time.time() - start)</span><br></pre></td></tr></table></figure>
<p>无论tasks是多少，需要的时间大概在3秒</p>
<p>异步编程中不能使用同步阻塞的代码，上述代码中如果<code>await asyncio.sleep(3)</code>换成了<code>time.sleep(3)</code>就不行了</p>
<p>获取返回值</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取协程的返回值</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start get html&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end get html&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    get_feature = asyncio.ensure_future(get_html(<span class="string">&quot;https://www.baidu.com&quot;</span>))</span><br><span class="line">    loop.run_until_complete(get_feature)</span><br><span class="line">    <span class="built_in">print</span>(get_feature.result())</span><br></pre></td></tr></table></figure>
<p>或者可以这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取协程的返回值</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start get html&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end get html&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    <span class="comment"># get_feature = asyncio.ensure_future(get_html(&quot;https://www.baidu.com&quot;))</span></span><br><span class="line">    task = loop.create_task(get_html(<span class="string">&quot;https://www.baidu.com&quot;</span>))</span><br><span class="line">    loop.run_until_complete(task)</span><br><span class="line">    <span class="built_in">print</span>(task.result())</span><br></pre></td></tr></table></figure>
<p>ensure_future最终还是调用的是create_task，将传递进来的协程包装成一个task，并且将协程注册到loop队列里面去。  ensure_future源码如下： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">ensure_future</span>(<span class="params">coro_or_future, *, loop=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Wrap a coroutine or an awaitable in a future.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    If the argument is a Future, it is returned directly.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> coroutines.iscoroutine(coro_or_future):</span><br><span class="line">        <span class="keyword">if</span> loop <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            loop = events.get_event_loop()</span><br><span class="line">        task = loop.create_task(coro_or_future)</span><br><span class="line">        <span class="keyword">if</span> task._source_traceback:</span><br><span class="line">            <span class="keyword">del</span> task._source_traceback[-<span class="number">1</span>]</span><br><span class="line">        <span class="keyword">return</span> task</span><br><span class="line">    <span class="keyword">elif</span> futures.isfuture(coro_or_future):</span><br><span class="line">        <span class="keyword">if</span> loop <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span> <span class="keyword">and</span> loop <span class="keyword">is</span> <span class="keyword">not</span> futures._get_loop(coro_or_future):</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&#x27;The future belongs to a different loop than &#x27;</span></span><br><span class="line">                             <span class="string">&#x27;the one specified as the loop argument&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span> coro_or_future</span><br><span class="line">    <span class="keyword">elif</span> inspect.isawaitable(coro_or_future):</span><br><span class="line">        <span class="keyword">return</span> ensure_future(_wrap_awaitable(coro_or_future), loop=loop)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> TypeError(<span class="string">&#x27;An asyncio.Future, a coroutine or an awaitable is &#x27;</span></span><br><span class="line">                        <span class="string">&#x27;required&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>协程结束之后加上自己的callback</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> functools <span class="keyword">import</span> partial</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取协程的返回值</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start get html&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">3</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end get html&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;cwz&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 协程结束之后可以callback</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">callback</span>(<span class="params">url, future</span>):</span><br><span class="line">    <span class="built_in">print</span>(future)  <span class="comment"># 这个future就是task</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;send email to cwz...&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    task = loop.create_task(get_html(<span class="string">&quot;https://www.baidu.com&quot;</span>))</span><br><span class="line">    task.add_done_callback(partial(callback, <span class="string">&quot;https://www.baidu.com&quot;</span>))</span><br><span class="line">    loop.run_until_complete(task)</span><br><span class="line">    <span class="built_in">print</span>(task.result())</span><br></pre></td></tr></table></figure>
<p>wait和gather：</p>
<p>gather更加高效，可以分组，可以将所有任务取消</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;start get url&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;end get url&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    start_time = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    tasks = [get_html(<span class="string">&quot;http://www.baidu.com&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">10</span>)]</span><br><span class="line"></span><br><span class="line">    <span class="comment"># gather和wait的区别</span></span><br><span class="line">    <span class="comment"># gather更加high-level</span></span><br><span class="line">    group1 = [get_html(<span class="string">&quot;http://projectsedu.com&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line">    group2 = [get_html(<span class="string">&quot;http://www.baidu.com&quot;</span>) <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>)]</span><br><span class="line">    group1 = asyncio.gather(*group1)</span><br><span class="line">    group2 = asyncio.gather(*group2)</span><br><span class="line">    group2.cancel()</span><br><span class="line">    loop.run_until_complete(asyncio.gather(group1, group2))</span><br><span class="line">    <span class="built_in">print</span>(time.time() - start_time)</span><br></pre></td></tr></table></figure>
<p>task取消:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#1. run_until_complete</span></span><br><span class="line"><span class="comment"># import asyncio</span></span><br><span class="line"><span class="comment"># loop = asyncio.get_event_loop()</span></span><br><span class="line"><span class="comment"># loop.run_forever()</span></span><br><span class="line"><span class="comment"># loop.run_until_complete()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#1. loop会被放到future中</span></span><br><span class="line"><span class="comment">#2. 取消future(task)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_html</span>(<span class="params">sleep_times</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;waiting&quot;</span>)</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(sleep_times)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;done after &#123;&#125;s&quot;</span>.<span class="built_in">format</span>(sleep_times))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    task1 = get_html(<span class="number">2</span>)</span><br><span class="line">    task2 = get_html(<span class="number">3</span>)</span><br><span class="line">    task3 = get_html(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">    tasks = [task1, task2, task3]</span><br><span class="line"></span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    <span class="keyword">except</span> KeyboardInterrupt <span class="keyword">as</span> e:</span><br><span class="line">        all_tasks = asyncio.Task.all_tasks()</span><br><span class="line">        <span class="keyword">for</span> task <span class="keyword">in</span> all_tasks:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;cancel task&quot;</span>)</span><br><span class="line">            <span class="built_in">print</span>(task.cancel())</span><br><span class="line">        loop.stop()</span><br><span class="line">        loop.run_forever()</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        loop.close()</span><br></pre></td></tr></table></figure>
<p>call_soon、call_at、call_later、call_soon_threadsafe</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">callback</span>(<span class="params">sleep_times, loop</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;success time &#123;&#125;&quot;</span>.<span class="built_in">format</span>(loop.time()))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">stoploop</span>(<span class="params">loop</span>):</span><br><span class="line">    loop.stop()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># call_later, call_at</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    now = loop.time()</span><br><span class="line">    loop.call_at(now + <span class="number">2</span>, callback, <span class="number">2</span>, loop)</span><br><span class="line">    loop.call_at(now + <span class="number">1</span>, callback, <span class="number">1</span>, loop)</span><br><span class="line">    loop.call_at(now + <span class="number">3</span>, callback, <span class="number">3</span>, loop)</span><br><span class="line">    <span class="comment"># loop.call_soon(stoploop, loop)</span></span><br><span class="line">    loop.call_soon(callback, <span class="number">4</span>, loop)</span><br><span class="line">    loop.run_forever()</span><br></pre></td></tr></table></figure>
<p>ThreadPollExecutor 和 asycio 完成阻塞 IO 请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用多线程：在协程中集成阻塞io</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment"># 通过socket请求html</span></span><br><span class="line">    url = urlparse(url)</span><br><span class="line">    host = url.netloc</span><br><span class="line">    path = url.path</span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        path = <span class="string">&quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立socket连接</span></span><br><span class="line">    client = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class="line">    <span class="comment"># client.setblocking(False)</span></span><br><span class="line">    client.connect((host, <span class="number">80</span>))  <span class="comment"># 阻塞不会消耗cpu</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 不停的询问连接是否建立好， 需要while循环不停的去检查状态</span></span><br><span class="line">    <span class="comment"># 做计算任务或者再次发起其他的连接请求</span></span><br><span class="line"></span><br><span class="line">    client.send(<span class="string">&quot;GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n&quot;</span>.<span class="built_in">format</span>(path, host).encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line"></span><br><span class="line">    data = <span class="string">b&quot;&quot;</span></span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        d = client.recv(<span class="number">1024</span>)</span><br><span class="line">        <span class="keyword">if</span> d:</span><br><span class="line">            data += d</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line"></span><br><span class="line">    data = data.decode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">    html_data = data.split(<span class="string">&quot;\r\n\r\n&quot;</span>)[<span class="number">1</span>]</span><br><span class="line">    <span class="built_in">print</span>(html_data)</span><br><span class="line">    client.close()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    executor = ThreadPoolExecutor(<span class="number">3</span>)</span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">&quot;http://shop.projectsedu.com/goods/&#123;&#125;/&quot;</span>.<span class="built_in">format</span>(url)</span><br><span class="line">        task = loop.run_in_executor(executor, get_url, url)</span><br><span class="line">        tasks.append(task)</span><br><span class="line">    loop.run_until_complete(asyncio.wait(tasks))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;last time:&#123;&#125;&quot;</span>.<span class="built_in">format</span>(time.time() - start_time))</span><br></pre></td></tr></table></figure>
<p>asyncio模拟http请求</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># asyncio 没有提供http协议的接口 aiohttp</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">get_url</span>(<span class="params">url</span>):</span><br><span class="line">    <span class="comment"># 通过socket请求html</span></span><br><span class="line">    url = urlparse(url)</span><br><span class="line">    host = url.netloc</span><br><span class="line">    path = url.path</span><br><span class="line">    <span class="keyword">if</span> path == <span class="string">&quot;&quot;</span>:</span><br><span class="line">        path = <span class="string">&quot;/&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 建立socket连接</span></span><br><span class="line">    reader, writer = <span class="keyword">await</span> asyncio.open_connection(host, <span class="number">80</span>)</span><br><span class="line">    writer.write(<span class="string">&quot;GET &#123;&#125; HTTP/1.1\r\nHost:&#123;&#125;\r\nConnection:close\r\n\r\n&quot;</span>.<span class="built_in">format</span>(path, host).encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line">    all_lines = []</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">for</span> raw_line <span class="keyword">in</span> reader:</span><br><span class="line">        data = raw_line.decode(<span class="string">&quot;utf8&quot;</span>)</span><br><span class="line">        all_lines.append(data)</span><br><span class="line">    html = <span class="string">&quot;\n&quot;</span>.join(all_lines)</span><br><span class="line">    <span class="keyword">return</span> html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    tasks = []</span><br><span class="line">    <span class="keyword">for</span> url <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">20</span>):</span><br><span class="line">        url = <span class="string">&quot;http://shop.projectsedu.com/goods/&#123;&#125;/&quot;</span>.<span class="built_in">format</span>(url)</span><br><span class="line">        tasks.append(asyncio.ensure_future(get_url(url)))</span><br><span class="line">    <span class="keyword">for</span> task <span class="keyword">in</span> asyncio.as_completed(tasks):</span><br><span class="line">        result = <span class="keyword">await</span> task</span><br><span class="line">        <span class="built_in">print</span>(result)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">    start_time = time.time()</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    loop.run_until_complete(main())</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;last time:&#123;&#125;&#x27;</span>.<span class="built_in">format</span>(time.time() - start_time))</span><br></pre></td></tr></table></figure>
<p>async with    调用了<code>__await__</code>和<code>__aenter__</code></p>
<p>aiohttp事项高并发爬虫</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># asyncio爬虫、去重、入库</span></span><br><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> aiohttp</span><br><span class="line"><span class="keyword">import</span> aiomysql</span><br><span class="line"><span class="keyword">from</span> pyquery <span class="keyword">import</span> PyQuery</span><br><span class="line"></span><br><span class="line">stopping = <span class="literal">False</span></span><br><span class="line">start_url = <span class="string">&quot;http://www.jobbole.com/xinwen/xwyd/&quot;</span></span><br><span class="line">waiting_urls = []  <span class="comment"># 待爬取的url</span></span><br><span class="line">seen_urls = <span class="built_in">set</span>()  <span class="comment"># 已经爬取过的url</span></span><br><span class="line"></span><br><span class="line">sem = asyncio.Semaphore(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">fetch</span>(<span class="params">url, session</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> sem:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">async</span> <span class="keyword">with</span> session.get(url) <span class="keyword">as</span> resp:</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">&quot;url status: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(resp.status))</span><br><span class="line">                <span class="keyword">if</span> resp.status <span class="keyword">in</span> [<span class="number">200</span>, <span class="number">201</span>]:</span><br><span class="line">                    data = <span class="keyword">await</span> resp.text()</span><br><span class="line">                    <span class="keyword">return</span> data</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="built_in">print</span>(e)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 解析是通过cpu完成的，不涉及到IO，不需要使用协程</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_urls</span>(<span class="params">html</span>):</span><br><span class="line">    urls = []</span><br><span class="line">    pq = PyQuery(html)</span><br><span class="line">    <span class="keyword">for</span> link <span class="keyword">in</span> pq.items(<span class="string">&quot;a&quot;</span>):</span><br><span class="line">        url = link.attr(<span class="string">&quot;href&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> url <span class="keyword">and</span> url.startswith(<span class="string">&quot;http&quot;</span>) <span class="keyword">and</span> url <span class="keyword">not</span> <span class="keyword">in</span> seen_urls:</span><br><span class="line">            urls.append(url)</span><br><span class="line">            waiting_urls.append(url)</span><br><span class="line">    <span class="keyword">return</span> urls</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从首页获取待爬取的url</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">init_urls</span>(<span class="params">url, session</span>):</span><br><span class="line">    html = <span class="keyword">await</span> fetch(url, session)</span><br><span class="line">    seen_urls.add(url)</span><br><span class="line">    extract_urls(html)  <span class="comment"># 从html中解析出所有的url</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">article_handler</span>(<span class="params">url, session, pool</span>):</span><br><span class="line">    <span class="comment"># 获取文章详情并解析入库</span></span><br><span class="line">    html = <span class="keyword">await</span> fetch(url, session)</span><br><span class="line">    seen_urls.add(url)</span><br><span class="line">    extract_urls(html)</span><br><span class="line">    pq = PyQuery(html)</span><br><span class="line">    title = pq(<span class="string">&quot;title&quot;</span>).text()</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> pool.acquire() <span class="keyword">as</span> conn:</span><br><span class="line">        <span class="keyword">async</span> <span class="keyword">with</span> conn.cursor() <span class="keyword">as</span> cur:</span><br><span class="line">            insert_sql = <span class="string">&quot;insert into article(title) values(&#x27;&#123;&#125;&#x27;) &quot;</span>.<span class="built_in">format</span>(title)</span><br><span class="line">            <span class="keyword">await</span> cur.execute(insert_sql)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从waiting_urls中获取url 然后启动协程去完成爬取的过程</span></span><br><span class="line"><span class="comment"># consumer可以不停的从waiting_urls中获取数据，启动协程之后扔到asyncio事件循环中来</span></span><br><span class="line"><span class="comment"># 然后从事件循环 队列中取出数据，取到数据之后创建协程，讲协程扔到asyncio中来，这个时候把asyncio看作协程池</span></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">consumer</span>(<span class="params">pool</span>):</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        <span class="keyword">while</span> <span class="keyword">not</span> stopping:</span><br><span class="line">            <span class="comment"># 如果这个协程消费的过快，生产者协程往里面放数据过慢的话，有可能会抛异常</span></span><br><span class="line">            <span class="keyword">if</span> <span class="built_in">len</span>(waiting_urls) == <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            url = waiting_urls.pop()  <span class="comment"># 取数据</span></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;start get url: &#123;&#125;&quot;</span>.<span class="built_in">format</span>(url))</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> re.<span class="keyword">match</span>(<span class="string">&quot;http://.*?jobbole.com/xinwen/xwyd/\d+/&quot;</span>, url):</span><br><span class="line">                <span class="comment"># 如果没有爬取过，直接提交一个协程</span></span><br><span class="line">                <span class="comment"># 这个协程负责获取url，解析这个url，并入库</span></span><br><span class="line">                <span class="keyword">if</span> url <span class="keyword">not</span> <span class="keyword">in</span> seen_urls:</span><br><span class="line">                    asyncio.ensure_future(article_handler(url, session, pool))</span><br><span class="line">                    <span class="keyword">await</span> asyncio.sleep(<span class="number">30</span>)</span><br><span class="line">                <span class="comment"># else:</span></span><br><span class="line">                <span class="comment">#     if url not in seen_urls:</span></span><br><span class="line">                <span class="comment">#         asyncio.ensure_future(init_urls(url, session))</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">loop</span>):</span><br><span class="line">    <span class="comment"># 等待mysql连接建立好</span></span><br><span class="line">    pool = <span class="keyword">await</span> aiomysql.create_pool(</span><br><span class="line">        host=<span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        port=<span class="number">3306</span>,</span><br><span class="line">        user=<span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        password=<span class="string">&#x27;123456&#x27;</span>,</span><br><span class="line">        db=<span class="string">&#x27;test1&#x27;</span>,</span><br><span class="line">        loop=loop,</span><br><span class="line">        charset=<span class="string">&#x27;utf8&#x27;</span>,</span><br><span class="line">        autocommit=<span class="literal">True</span></span><br><span class="line">    )</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> aiohttp.ClientSession() <span class="keyword">as</span> session:</span><br><span class="line">        html = <span class="keyword">await</span> fetch(start_url, session)</span><br><span class="line">        seen_urls.add(start_url)</span><br><span class="line">        extract_urls(html)</span><br><span class="line">    asyncio.ensure_future(consumer(pool))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    loop = asyncio.get_event_loop()</span><br><span class="line">    asyncio.ensure_future(main(loop))</span><br><span class="line">    loop.run_forever()</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>python并发的解决方案：</p>
<ul>
<li>tornado</li>
<li>twisted</li>
<li>gevent</li>
<li>asyncio </li>
</ul>
<p>tornado、twisted采用了python的生成器</p>
<p>gevent是通过C语言实现了底层的协程完成的，gevnet最大的问题是采用了猴子补丁，将很多python内置库进行了补丁，用起来会很简单，但是很多内部的异常很难捕捉到。</p>
<p>并发编程中，asyncio为什么会这么复杂？协程编程为什么比我们多进程多线程编程复杂很多？原因就是协程是由程序员自己来调度的，程序员自己来调度肯定不会让平常编码的人来调度，所以就出现了一些框架，像asyncio，主要就是来完成协程调度的同时还能让我们像编写同步代码的方式来编写异步代码。</p>
<p>我们平常在编写多进程多线程的代码时，线程调度和进程调度是由操作系统来完成的，操作系统对于我们很多程序员来说是一个黑盒，实际上操作系统在调度的过程中有非常多的逻辑，操作系统完成了这些逻辑，很多人又不会去接触操作系统的原理，所以操作系统本身的调度过程我们是不清楚的。而我们只要写出多线程就行了，但是协程不一样，协程编程模式由阻塞IO的编码方式直接转换成异步非阻塞的编码方式，这是一个很大的转变。在这个转变过程中，我们不得不里了解其中协程的调度过程。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://setcreed.github.io">SetCreed</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://setcreed.github.io/posts/c092dbc6/">https://setcreed.github.io/posts/c092dbc6/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://setcreed.github.io" target="_blank">伊甸园</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-8.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/9b4e6704/" title="django实战"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">django实战</div></div></a></div><div class="next-post pull-right"><a href="/posts/69b95a22/" title="python总结"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-15.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">python总结</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">SetCreed</div><div class="author-info__description">读书、写代码、看电影</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">82</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">35</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">26</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/setcreed"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/img/qq.jpg" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/img/wechat_account.jpg" target="_blank" title="微信"><i class="fab fa-weixin"></i></a><a class="social-icon" href="https://github.com/setcreed" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:cwzdzg@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E4%B8%AD%E4%B8%80%E5%88%87%E7%9A%86%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.</span> <span class="toc-text">python中一切皆对象</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#type%E3%80%81object%E5%92%8Cclass%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB"><span class="toc-number">2.</span> <span class="toc-text">type、object和class之间的关系</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%AD%94%E6%B3%95%E5%87%BD%E6%95%B0"><span class="toc-number">3.</span> <span class="toc-text">魔法函数</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8A%BD%E8%B1%A1%E5%9F%BA%E7%B1%BB%EF%BC%88abc%E6%A8%A1%E5%9D%97%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">抽象基类（abc模块）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E7%9A%84%E8%87%AA%E7%9C%81%E6%9C%BA%E5%88%B6"><span class="toc-number">5.</span> <span class="toc-text">python的自省机制</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#super-%E7%9C%9F%E7%9A%84%E6%98%AF%E8%B0%83%E7%94%A8%E7%88%B6%E7%B1%BB%E7%9A%84%E5%90%97"><span class="toc-number">6.</span> <span class="toc-text">super()真的是调用父类的吗</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#with%E8%AF%AD%E5%8F%A5"><span class="toc-number">7.</span> <span class="toc-text">with语句</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%87%E7%89%87"><span class="toc-number">8.</span> <span class="toc-text">切片</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%AF%E5%88%87%E7%89%87%E5%AF%B9%E8%B1%A1"><span class="toc-number">8.1.</span> <span class="toc-text">自定义可切片对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bisect%E7%BB%B4%E6%8A%A4%E5%B7%B2%E6%8E%92%E5%BA%8F%E5%BA%8F%E5%88%97"><span class="toc-number">8.2.</span> <span class="toc-text">bisect维护已排序序列</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%88%97%E8%A1%A8%E6%8E%A8%E5%AF%BC%E5%BC%8F%E3%80%81%E7%94%9F%E6%88%90%E5%99%A8%E8%A1%A8%E8%BE%BE%E5%BC%8F%E3%80%81%E5%AD%97%E5%85%B8%E6%8E%A8%E5%AF%BC%E5%BC%8F"><span class="toc-number">9.</span> <span class="toc-text">列表推导式、生成器表达式、字典推导式</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dict%E7%9A%84abc%E7%BB%A7%E6%89%BF%E5%85%B3%E7%B3%BB"><span class="toc-number">10.</span> <span class="toc-text">dict的abc继承关系</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#dict%E7%9A%84%E5%AD%90%E7%B1%BB"><span class="toc-number">10.1.</span> <span class="toc-text">dict的子类</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#set%E5%92%8Cfrozenset"><span class="toc-number">11.</span> <span class="toc-text">set和frozenset</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#dict%E5%92%8Cset%E5%AE%9E%E7%8E%B0%E5%8E%9F%E7%90%86"><span class="toc-number">12.</span> <span class="toc-text">dict和set实现原理</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E7%9A%84%E5%8F%98%E9%87%8F"><span class="toc-number">13.</span> <span class="toc-text">python的变量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%BB%8F%E5%85%B8%E7%9A%84%E9%94%99%E8%AF%AF%EF%BC%9A"><span class="toc-number">13.1.</span> <span class="toc-text">一个经典的错误：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%85%83%E7%B1%BB%E7%BC%96%E7%A8%8B"><span class="toc-number">14.</span> <span class="toc-text">元类编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#property%E5%8A%A8%E6%80%81%E5%B1%9E%E6%80%A7"><span class="toc-number">14.1.</span> <span class="toc-text">property动态属性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B1%9E%E6%80%A7%E6%8F%8F%E8%BF%B0%E7%AC%A6"><span class="toc-number">14.2.</span> <span class="toc-text">属性描述符</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%83%E7%B1%BB%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84ORM"><span class="toc-number">14.3.</span> <span class="toc-text">元类实现简单的ORM</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E7%9A%84%E8%BF%AD%E4%BB%A3%E5%8D%8F%E8%AE%AE"><span class="toc-number">15.</span> <span class="toc-text">python的迭代协议</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%AD%E4%BB%A3%E5%99%A8%E5%92%8C%E5%8F%AF%E8%BF%AD%E4%BB%A3%E5%AF%B9%E8%B1%A1"><span class="toc-number">15.1.</span> <span class="toc-text">迭代器和可迭代对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">15.2.</span> <span class="toc-text">生成器的使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#python%E6%98%AF%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E7%94%9F%E6%88%90%E5%99%A8%E7%9A%84"><span class="toc-number">15.3.</span> <span class="toc-text">python是如何实现生成器的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E5%9C%A8UserList%E4%B8%AD%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">15.4.</span> <span class="toc-text">生成器在UserList中的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E8%AF%BB%E5%8F%96%E5%A4%A7%E6%96%87%E4%BB%B6"><span class="toc-number">15.4.1.</span> <span class="toc-text">生成器读取大文件</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#socket%E7%BC%96%E7%A8%8B"><span class="toc-number">16.</span> <span class="toc-text">socket编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#socket%E6%A8%A1%E6%8B%9Fhttp%E8%AF%B7%E6%B1%82"><span class="toc-number">16.1.</span> <span class="toc-text">socket模拟http请求</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E4%B8%AD%E7%9A%84GIL"><span class="toc-number">17.</span> <span class="toc-text">python中的GIL</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E5%A4%9A%E7%BA%BF%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="toc-number">18.</span> <span class="toc-text">python多线程编程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1%E6%96%B9%E5%BC%8F-%E5%85%B1%E4%BA%AB%E5%8F%98%E9%87%8F"><span class="toc-number">18.1.</span> <span class="toc-text">线程通信方式- 共享变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5Lock%EF%BC%8CRlock-%E5%8F%AF%E9%87%8D%E5%85%A5%E9%94%81"><span class="toc-number">18.2.</span> <span class="toc-text">线程同步Lock，Rlock(可重入锁)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5-Condition-%E6%9D%A1%E4%BB%B6%E5%8F%98%E9%87%8F-%E7%94%A8%E4%BA%8E%E7%BA%BF%E7%A8%8B%E9%97%B4%E5%A4%8D%E6%9D%82%E7%9A%84%E5%90%8C%E6%AD%A5"><span class="toc-number">18.3.</span> <span class="toc-text">线程同步  Condition(条件变量)  用于线程间复杂的同步</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E5%90%8C%E6%AD%A5-Semaphore-%E4%BD%BF%E7%94%A8"><span class="toc-number">18.4.</span> <span class="toc-text">线程同步 - Semaphore 使用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B%E6%B1%A0"><span class="toc-number">18.5.</span> <span class="toc-text">线程池</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E7%BA%BF%E7%A8%8B%E5%92%8C%E5%A4%9A%E8%BF%9B%E7%A8%8B%E5%AF%B9%E6%AF%94"><span class="toc-number">18.6.</span> <span class="toc-text">多线程和多进程对比</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#multiprocessing-%E5%A4%9A%E8%BF%9B%E7%A8%8B%E7%BC%96%E7%A8%8B"><span class="toc-number">18.7.</span> <span class="toc-text">multiprocessing 多进程编程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E9%97%B4%E9%80%9A%E4%BF%A1"><span class="toc-number">18.8.</span> <span class="toc-text">进程间通信</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8D%8F%E7%A8%8B"><span class="toc-number">19.</span> <span class="toc-text">协程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E9%9D%9E%E9%98%BB%E5%A1%9Eio%E5%AE%9E%E7%8E%B0http%E8%AF%B7%E6%B1%82"><span class="toc-number">19.1.</span> <span class="toc-text">通过非阻塞io实现http请求:</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#select-%E5%9B%9E%E8%B0%83-%E4%BA%8B%E4%BB%B6%E5%BE%AA%E7%8E%AF"><span class="toc-number">19.2.</span> <span class="toc-text">select+回调+事件循环</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9E%E8%B0%83%E4%B9%8B%E7%97%9B"><span class="toc-number">19.3.</span> <span class="toc-text">回调之痛</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#yield-from"><span class="toc-number">19.4.</span> <span class="toc-text">yield_from</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#async%E5%92%8Cawait%E5%AE%9A%E4%B9%89%E5%8E%9F%E7%94%9F%E7%9A%84%E5%8D%8F%E7%A8%8B"><span class="toc-number">19.5.</span> <span class="toc-text">async和await定义原生的协程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E5%99%A8%E6%98%AF%E5%A6%82%E4%BD%95%E5%8F%98%E6%88%90%E5%8D%8F%E7%A8%8B%E7%9A%84%EF%BC%9A"><span class="toc-number">19.6.</span> <span class="toc-text">生成器是如何变成协程的：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#asyncio%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B"><span class="toc-number">20.</span> <span class="toc-text">asyncio并发编程</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/c9fd1d24/" title="运维开发所需要知道的Linux基本知识"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311050928440.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="运维开发所需要知道的Linux基本知识"/></a><div class="content"><a class="title" href="/posts/c9fd1d24/" title="运维开发所需要知道的Linux基本知识">运维开发所需要知道的Linux基本知识</a><time datetime="2023-11-04T14:27:22.000Z" title="发表于 2023-11-04 22:27:22">2023-11-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b2fa1aad/" title="Linux的Namespace和CGroup"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311050932278.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="Linux的Namespace和CGroup"/></a><div class="content"><a class="title" href="/posts/b2fa1aad/" title="Linux的Namespace和CGroup">Linux的Namespace和CGroup</a><time datetime="2023-11-04T12:39:28.000Z" title="发表于 2023-11-04 20:39:28">2023-11-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/afe9ffa9/" title="家用服务器搭建使用指南"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311032207863.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="家用服务器搭建使用指南"/></a><div class="content"><a class="title" href="/posts/afe9ffa9/" title="家用服务器搭建使用指南">家用服务器搭建使用指南</a><time datetime="2023-11-03T14:02:36.000Z" title="发表于 2023-11-03 22:02:36">2023-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7ac9a020/" title="k8s-informer深入学习"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s-informer深入学习"/></a><div class="content"><a class="title" href="/posts/7ac9a020/" title="k8s-informer深入学习">k8s-informer深入学习</a><time datetime="2022-12-01T09:56:52.000Z" title="发表于 2022-12-01 17:56:52">2022-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/89a3df7f/" title="go刷题基础篇"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="go刷题基础篇"/></a><div class="content"><a class="title" href="/posts/89a3df7f/" title="go刷题基础篇">go刷题基础篇</a><time datetime="2022-09-18T22:21:26.000Z" title="发表于 2022-09-19 06:21:26">2022-09-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By SetCreed</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://unpkg.com/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>