<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>01-go开发基础 | 伊甸园</title><meta name="author" content="SetCreed"><meta name="copyright" content="SetCreed"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="golang基础变量和常量如何定义变量单声明变量var名称类型是声明单个变量的语法  第一种，指定变量类型，声明后若不赋值，使用默认值  12var name stringname &#x3D;&quot;cwz&quot;  第二种，根据值自行判定变量类型(类型推断Type inference)  如果一个变量有一个初始值，Go将自动能够使用初始值来推断该变量的类型。因此，如果变量具有初始值，则可以省略变">
<meta property="og:type" content="article">
<meta property="og:title" content="01-go开发基础">
<meta property="og:url" content="https://setcreed.github.io/posts/5a8b0b1c/index.html">
<meta property="og:site_name" content="伊甸园">
<meta property="og:description" content="golang基础变量和常量如何定义变量单声明变量var名称类型是声明单个变量的语法  第一种，指定变量类型，声明后若不赋值，使用默认值  12var name stringname &#x3D;&quot;cwz&quot;  第二种，根据值自行判定变量类型(类型推断Type inference)  如果一个变量有一个初始值，Go将自动能够使用初始值来推断该变量的类型。因此，如果变量具有初始值，则可以省略变">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-12.png">
<meta property="article:published_time" content="2022-03-01T13:42:55.000Z">
<meta property="article:modified_time" content="2022-03-01T13:42:55.000Z">
<meta property="article:author" content="SetCreed">
<meta property="article:tag" content="hexo、code、dream">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-12.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://setcreed.github.io/posts/5a8b0b1c/index.html"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://unpkg.com/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章所描述的内容可能已经发生变化，请留意。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '01-go开发基础',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-01 21:42:55'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/custom/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/custom/icon.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="伊甸园" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/cloudnative/"><i class="fa-fw fas fa-cloud"></i><span> 云原生</span></a></li><li><a class="site-page child" href="/golang/"><i class="fa-fw fa-brands fa-golang"></i><span> Golang编程</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-12.png')"><nav id="nav"><span id="blog-info"><a href="/" title="伊甸园"><span class="site-name">伊甸园</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/cloudnative/"><i class="fa-fw fas fa-cloud"></i><span> 云原生</span></a></li><li><a class="site-page child" href="/golang/"><i class="fa-fw fa-brands fa-golang"></i><span> Golang编程</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">01-go开发基础</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-01T13:42:55.000Z" title="发表于 2022-03-01 21:42:55">2022-03-01</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-01T13:42:55.000Z" title="更新于 2022-03-01 21:42:55">2022-03-01</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">49.6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>214分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="01-go开发基础"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="golang基础"><a href="#golang基础" class="headerlink" title="golang基础"></a>golang基础</h1><h2 id="变量和常量"><a href="#变量和常量" class="headerlink" title="变量和常量"></a>变量和常量</h2><h3 id="如何定义变量"><a href="#如何定义变量" class="headerlink" title="如何定义变量"></a>如何定义变量</h3><h4 id="单声明变量"><a href="#单声明变量" class="headerlink" title="单声明变量"></a>单声明变量</h4><p>var名称类型是声明单个变量的语法</p>
<ul>
<li>第一种，指定变量类型，声明后若不赋值，使用默认值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="type">string</span></span><br><span class="line">name =<span class="string">&quot;cwz&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第二种，根据值自行判定变量类型(类型推断Type inference)</li>
</ul>
<p>如果一个变量有一个初始值，Go将自动能够使用初始值来推断该变量的类型。因此，如果变量具有初始值，则可以省略变量声明中的类型</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name =<span class="string">&quot;cwz&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>第三种，省略var, 注意 :=左侧的变量不应该是已经声明过的(多个变量同时声明时，至少保证一个是新变量)，否则会导致编译错误(简短声明)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">10</span></span><br><span class="line"><span class="keyword">var</span> b = <span class="number">10</span></span><br><span class="line">c := <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p><strong>这种方式只能被用在函数体内，而不可以用于全局变量的声明与赋值</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"><span class="keyword">var</span> a = <span class="string">&quot;cwz&quot;</span></span><br><span class="line"><span class="keyword">var</span> b <span class="type">string</span> = <span class="string">&quot;b&quot;</span></span><br><span class="line"><span class="keyword">var</span> c <span class="type">bool</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="built_in">println</span>(a, b, c)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="多声明变量"><a href="#多声明变量" class="headerlink" title="多声明变量"></a>多声明变量</h4><ul>
<li>第一种，以逗号分隔，声明与赋值分开，若不赋值，存在默认值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name1, name2, name3 <span class="keyword">type</span></span><br><span class="line">name1, name2, name3 = v1, v2, v3</span><br></pre></td></tr></table></figure>
<ul>
<li>第二种，直接赋值，下面的变量类型可以是不同的类型</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name1, name2, name3 = v1, v2, v3</span><br></pre></td></tr></table></figure>
<ul>
<li>第三种，集合类型</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age <span class="type">int</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>变量必须先定义才能使用</li>
<li>go语言是静态语言，要求变量的类型和赋值的类型必须一致</li>
<li>变量名不能冲突。同一个作用于域内不能冲突</li>
<li>简短定义方式，左边的变量名至少有一个是新的，而且不能定义全局变量</li>
<li>变量定义了就要使用，否则无法通过编译</li>
</ul>
<p>如果在相同的代码块中，我们不可以再次对于相同名称的变量使用初始化声明，例如：a := 20 就是不被允许的，编译器会提示错误 <code>no new  variables on left side of :=</code>，但是 a = 20 是可以的，因为这是给相同的变量赋予一个新的值。</p>
<p>单纯地给 a 赋值也是不够的，这个值必须被使用，所以使用在同一个作用域中，已存在同名的变量，之后的声明初始化会退化为赋值操作。但这个前提是，最少要有一个新的变量被定义，且在同一作用域，例如，下面的x就是新定义的变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    x := <span class="number">140</span></span><br><span class="line">    fmt.Println(&amp;x)</span><br><span class="line">    x, y := <span class="number">200</span>, <span class="string">&quot;abc&quot;</span></span><br><span class="line">    fmt.Println(&amp;x, x)</span><br><span class="line">    fmt.Print(y)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="匿名变量"><a href="#匿名变量" class="headerlink" title="匿名变量"></a>匿名变量</h4><p>在使用多重赋值时候，如果不需要在左值中接收变量，可以使用匿名变量<code>_</code>，python中也经常有这种用法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetData</span><span class="params">()</span></span> (<span class="type">int</span>, <span class="type">int</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">100</span>, <span class="number">200</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    a, _ := GetData()</span><br><span class="line">    _, b := GetData()</span><br><span class="line">    fmt.Println(a, b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="常量的定义"><a href="#常量的定义" class="headerlink" title="常量的定义"></a>常量的定义</h3><h4 id="常量"><a href="#常量" class="headerlink" title="常量"></a>常量</h4><p>常量是一个简单值的标识符，在程序运行时，不会被修改的量</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">显式类型定义： <span class="keyword">const</span> b <span class="type">string</span> = <span class="string">&quot;abc&quot;</span></span><br><span class="line">隐式类型定义： <span class="keyword">const</span> b = <span class="string">&quot;abc&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">const</span> LENGTH <span class="type">int</span> = <span class="number">10</span></span><br><span class="line">   <span class="keyword">const</span> WIDTH <span class="type">int</span> = <span class="number">5</span>   </span><br><span class="line">   <span class="keyword">var</span> area <span class="type">int</span></span><br><span class="line">   <span class="keyword">const</span> a, b, c = <span class="number">1</span>, <span class="literal">false</span>, <span class="string">&quot;str&quot;</span> <span class="comment">//多重赋值</span></span><br><span class="line"></span><br><span class="line">   area = LENGTH * WIDTH</span><br><span class="line">   fmt.Printf(<span class="string">&quot;面积为 : %d&quot;</span>, area)</span><br><span class="line">   fmt.Println(a, b, c)   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>常量可以作为枚举组成常量组：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Unknown = <span class="number">0</span></span><br><span class="line">    Female = <span class="number">1</span></span><br><span class="line">    Male = <span class="number">2</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>常量组中如不指定类型和初始化值，则与上一行非空常量值相同：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">const</span> (</span><br><span class="line">        x u· = <span class="number">16</span></span><br><span class="line">        y</span><br><span class="line">        s = <span class="string">&quot;abc&quot;</span></span><br><span class="line">        z</span><br><span class="line">    )</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T,%v\n&quot;</span>, y, y)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T,%v\n&quot;</span>, z, z)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出：</span></span><br><span class="line"><span class="type">uint16</span>,<span class="number">16</span></span><br><span class="line"><span class="type">string</span>,abc</span><br></pre></td></tr></table></figure>
<p>常量的注意事项：</p>
<ul>
<li>常量中的数据类型只可以是布尔型、数字型（整数型、浮点型和复数）和字符串型</li>
<li>不曾使用的常量，在编译的时候，是不会报错的</li>
</ul>
<h4 id="iota"><a href="#iota" class="headerlink" title="iota"></a>iota</h4><p>iota，是特殊常量，可以认为是一个可以被编译器修改的常量</p>
<p>iota 可以被用作枚举值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    a = <span class="literal">iota</span></span><br><span class="line">    b = <span class="literal">iota</span></span><br><span class="line">    c = <span class="literal">iota</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>第一个 iota 等于 0，每当 iota 在新的一行被使用时，它的值都会自动加 1；所以 a=0, b=1, c=2 可以简写为如下形式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    a = <span class="literal">iota</span></span><br><span class="line">    b</span><br><span class="line">    c</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">const</span> (</span><br><span class="line">            a = <span class="literal">iota</span>   <span class="comment">//0</span></span><br><span class="line">            b          <span class="comment">//1</span></span><br><span class="line">            c          <span class="comment">//2</span></span><br><span class="line">            d = <span class="string">&quot;ha&quot;</span>   <span class="comment">//独立值，iota += 1</span></span><br><span class="line">            e          <span class="comment">//&quot;ha&quot;   iota += 1</span></span><br><span class="line">            f = <span class="number">100</span>    <span class="comment">//iota +=1</span></span><br><span class="line">            g          <span class="comment">//100  iota +=1</span></span><br><span class="line">            h = <span class="literal">iota</span>   <span class="comment">//7,恢复计数</span></span><br><span class="line">            i          <span class="comment">//8</span></span><br><span class="line">    )</span><br><span class="line">    fmt.Println(a,b,c,d,e,f,g,h,i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 0 1 2 ha ha 100 100 7 8</span></span><br></pre></td></tr></table></figure>
<p>注意：</p>
<ul>
<li>如果中断iota自增，则必须显式恢复。且后续自增值按行序递增</li>
<li>自增默认是int类型，可以自行进行显示指定类型</li>
<li>数字常量不会分配存储空间，无须像变量那样通过内存寻址来取值，因此无法获取地址</li>
</ul>
<h2 id="go基本数据类型"><a href="#go基本数据类型" class="headerlink" title="go基本数据类型"></a>go基本数据类型</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210607091129.png" alt=""></p>
<h3 id="bool类型"><a href="#bool类型" class="headerlink" title="bool类型"></a>bool类型</h3><p>布尔型的值只可以是常量 true 或者 false。一个简单的例子：<code>var b bool = true</code></p>
<h3 id="数值类型"><a href="#数值类型" class="headerlink" title="数值类型"></a>数值类型</h3><h4 id="整数型"><a href="#整数型" class="headerlink" title="整数型"></a>整数型</h4><div class="table-container">
<table>
<thead>
<tr>
<th>类型</th>
<th>有无符号</th>
<th>长度</th>
</tr>
</thead>
<tbody>
<tr>
<td>int8</td>
<td>有</td>
<td>8 位  （-128 到 127）</td>
</tr>
<tr>
<td>int16</td>
<td>有</td>
<td>16位  （-32768 到 32767）</td>
</tr>
<tr>
<td>int32</td>
<td>有</td>
<td>32 位整型 (-2147483648 到 2147483647)</td>
</tr>
<tr>
<td>int64</td>
<td>有</td>
<td>64 位整型 (-9223372036854775808 到 9223372036854775807)</td>
</tr>
<tr>
<td>uint8</td>
<td>无</td>
<td>8 位整型 (0 到 255) 8位都用于表示数值</td>
</tr>
<tr>
<td>uint16</td>
<td>无</td>
<td>16 位整型 (0 到 65535)</td>
</tr>
<tr>
<td>uint32</td>
<td>无</td>
<td>32 位整型 (0 到 4294967295)</td>
</tr>
<tr>
<td>uint64</td>
<td>无</td>
<td>64 位整型 (0 到 18446744073709551615)</td>
</tr>
</tbody>
</table>
</div>
<p>go语言中，int是一种动态类型，取决于机器本身是多少位，64位机器就是int64，占8个字节：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> age <span class="type">int</span> = <span class="number">18</span></span><br><span class="line">fmt.Println(age)</span><br><span class="line">fmt.Println(unsafe.Sizeof(age))   <span class="comment">// 8</span></span><br></pre></td></tr></table></figure>
<h4 id="浮点型"><a href="#浮点型" class="headerlink" title="浮点型"></a>浮点型</h4><ul>
<li>float32  32位浮点型数</li>
<li>float64  64位浮点型数</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// float类型, float类型最大数</span></span><br><span class="line"><span class="comment">//var weight float32 = 70.5</span></span><br><span class="line">fmt.Println(math.MaxFloat32)  <span class="comment">// 3.4028234663852886e+38</span></span><br><span class="line">fmt.Println(math.MaxFloat64)  <span class="comment">// 1.7976931348623157e+308</span></span><br></pre></td></tr></table></figure>
<h4 id="其他类型"><a href="#其他类型" class="headerlink" title="其他类型"></a>其他类型</h4><ul>
<li>byte 等于 uint8，主要用来处理ASCII码的处理</li>
<li>rune 等于 int32，主要处理中文字符</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// byte is an alias for uint8 and is equivalent to uint8 in all ways. It is</span></span><br><span class="line"><span class="comment">// used, by convention, to distinguish byte values from 8-bit unsigned</span></span><br><span class="line"><span class="comment">// integer values.</span></span><br><span class="line"><span class="keyword">type</span> <span class="type">byte</span> = <span class="type">uint8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rune is an alias for int32 and is equivalent to int32 in all ways. It is</span></span><br><span class="line"><span class="comment">// used, by convention, to distinguish character values from integer values.</span></span><br><span class="line"><span class="keyword">type</span> <span class="type">rune</span> = <span class="type">int32</span></span><br></pre></td></tr></table></figure>
<h4 id="字符"><a href="#字符" class="headerlink" title="字符"></a>字符</h4><p>Golang中没有专门的字符类型，如果要存储单个字符(字母)，一般使用byte来保存。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> a <span class="type">byte</span></span><br><span class="line">    a = <span class="string">&#x27;a&#x27;</span></span><br><span class="line">    <span class="comment">//输出ascii对应码值 97</span></span><br><span class="line">    fmt.Println(a)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;a=%c&quot;</span>, a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>字符常量只能使用单引号括起来，例如：<code>var a byte = &#39;a&#39;</code>    <code>var a int = &#39;a&#39;</code></p>
<p>字符本质是一个数字， 可以进行加减乘除</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    a := <span class="string">&#x27;a&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//这里注意一下 1. a+1可以和数字计算 2.a+1的类型是32 3. int类型可以直接变成字符</span></span><br><span class="line"></span><br><span class="line">    fmt.Println(reflect.TypeOf(a+<span class="number">1</span>))  <span class="comment">// int32</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;a+1=%c&quot;</span>, a+<span class="number">1</span>)  <span class="comment">// a+1=b</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="字符串"><a href="#字符串" class="headerlink" title="字符串"></a>字符串</h4><p>字符串就是一串固定长度的字符连接起来的字符序列。Go 的字符串是由单个字节连接起来的。Go 语言的字符串的字节使用 UTF-8 编码标识 Unicode 文本。</p>
<h3 id="数据类型的转换"><a href="#数据类型的转换" class="headerlink" title="数据类型的转换"></a>数据类型的转换</h3><h4 id="简单的转换操作"><a href="#简单的转换操作" class="headerlink" title="简单的转换操作"></a>简单的转换操作</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基本类型转换</span></span><br><span class="line">a := <span class="type">int</span>(<span class="number">3.0</span>)</span><br><span class="line">fmt.Println(a)</span><br><span class="line"><span class="comment">// 这样是可以的</span></span><br></pre></td></tr></table></figure>
<p>但是，<strong>在go语言中不支持变量间的隐式类型转换</strong></p>
<p>看一段C程序代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line">using namespace <span class="built_in">std</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">int</span> a = <span class="number">5</span>;</span><br><span class="line">    <span class="type">float</span> b = <span class="number">6.2</span>;</span><br><span class="line">    a = b;</span><br><span class="line">    count&lt;&lt;a&lt;&lt;<span class="built_in">endl</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样输出的结果就是6</p>
<p>再看一看golang：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> b <span class="type">int</span> = <span class="number">5.0</span></span><br><span class="line">    fmt.Println(b)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样可以运行成功。需要说明的是：<strong><code>var b int = 5.0</code>中，对于b来说是一个变量，5.0是一个常量。常量到变量是会进行隐式类型转换</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">c := <span class="number">5.7</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, c)  <span class="comment">// float64</span></span><br><span class="line"><span class="keyword">var</span> d <span class="type">int</span> = c  <span class="comment">// 这里就会产生错误，cannot use c (type float64) as type int in assignment。这里 c 和 d 都是变量。变量赋值给另一个变量，两种类型不一致，是不会做隐式转换的</span></span><br><span class="line">fmt.Println(d)</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li><p>Go允许在底层结构相同的两个类型之间互转</p>
</li>
<li><p>不是所有数据类型都能转换的，例如字母格式的string类型”abcd”转换为int肯定会失败</p>
</li>
<li><p>低精度转换为高精度时是安全的，高精度的值转换为低精度时会丢失精度。例如int32转换为int16，float32转换为int，这样会丢失精度</p>
</li>
<li><p>这种简单的转换方式不能对int(float)和string进行互转，要跨大类型转换，可以使用strconv包提供的函数</p>
</li>
</ul>
<h4 id="strconv转换"><a href="#strconv转换" class="headerlink" title="strconv转换"></a>strconv转换</h4><p><strong>Itoa和Atoi</strong></p>
<ul>
<li>Itoa   int转换为字符串</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">println</span>(<span class="string">&quot;a&quot;</span> + strconv.Itoa(<span class="number">32</span>))  <span class="comment">// a32</span></span><br></pre></td></tr></table></figure>
<ul>
<li>string转换为int：Atoi</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 字符串转int aoti</span></span><br><span class="line">data, _:=strconv.Atoi(<span class="string">&quot;12&quot;</span>)</span><br><span class="line">fmt.Println(data)</span><br><span class="line"><span class="comment">//由于string可能无法转换为int，所以这个函数有两个返回值：第一个返回值是转换成int的值，第二个返回值判断是否转换成功。</span></span><br></pre></td></tr></table></figure>
<p><strong>Parse类函数</strong></p>
<p><strong>Parse类函数用于转换字符串为给定类型的值</strong>：ParseBool()、ParseFloat()、ParseInt()、ParseUint()</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">b, err := strconv.ParseBool(<span class="string">&quot;true&quot;</span>)</span><br><span class="line">f, err := strconv.ParseFloat(<span class="string">&quot;3.1415&quot;</span>, <span class="number">64</span>)  <span class="comment">// 转换成float64</span></span><br><span class="line">i, err := strconv.ParseInt(<span class="string">&quot;-42&quot;</span>, <span class="number">10</span>, <span class="number">64</span>)</span><br><span class="line">u, err := strconv.ParseUint(<span class="string">&quot;42&quot;</span>, <span class="number">10</span>, <span class="number">64</span>)</span><br></pre></td></tr></table></figure>
<p><strong>ParseInt()和ParseUint()有3个参数：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParseInt</span><span class="params">(s <span class="type">string</span>, base <span class="type">int</span>, bitSize <span class="type">int</span>)</span></span> (i <span class="type">int64</span>, err <span class="type">error</span>)</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">ParseUint</span><span class="params">(s <span class="type">string</span>, base <span class="type">int</span>, bitSize <span class="type">int</span>)</span></span> (<span class="type">uint64</span>, <span class="type">error</span>)</span><br></pre></td></tr></table></figure>
<p>说明：</p>
<ul>
<li><code>bitSize</code>参数表示转换为什么位的int/uint，有效值为0、8、16、32、64。当bitSize=0的时候，表示转换为int或uint类型。例如bitSize=8表示转换后的值的类型为int8或uint8。</li>
<li><code>base</code>参数表示以什么进制的方式去解析给定的字符串，有效值为0、2-36。当base=0的时候，表示根据string的前缀来判断以什么进制去解析：<code>0x</code>开头的以16进制的方式去解析，<code>0</code>开头的以8进制方式去解析，其它的以10进制方式解析。</li>
</ul>
<p><strong>Format类函数</strong></p>
<p><strong>将给定类型格式化为string类型</strong>：FormatBool()、FormatFloat()、FormatInt()、FormatUint()</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">s := strconv.FormatBool(<span class="literal">true</span>)</span><br><span class="line">s := strconv.FormatFloat(<span class="number">3.1415</span>, <span class="string">&#x27;E&#x27;</span>, <span class="number">-1</span>, <span class="number">64</span>)</span><br><span class="line">s := strconv.FormatInt(<span class="number">-42</span>, <span class="number">16</span>) <span class="comment">//表示将-42转换为16进制数，转换的结果为-2a。</span></span><br><span class="line">s := strconv.FormatUint(<span class="number">42</span>, <span class="number">16</span>)</span><br></pre></td></tr></table></figure>
<p>第二个参数base指定将第一个参数转换为多少进制，有效值为<code>2&lt;=base&lt;=36</code>。当指定的进制位大于10的时候，超出10的数值以a-z字母表示。例如16进制时，10-15的数字分别使用a-f表示，17进制时，10-16的数值分别使用a-g表示。</p>
<p>FormatFloat()参数众多：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FormatFloat</span><span class="params">(f <span class="type">float64</span>, fmt <span class="type">byte</span>, prec, bitSize <span class="type">int</span>)</span></span> <span class="type">string</span></span><br></pre></td></tr></table></figure>
<ul>
<li>bitSize表示f的来源类型（32：float32、64：float64），会据此进行舍入</li>
<li>fmt表示格式：’f’（-ddd.dddd）、’b’（-ddddp±ddd，指数为二进制）、’e’（-d.dddde±dd，十进制指数）、’E’（-d.ddddE±dd，十进制指数）、’g’（指数很大时用’e’格式，否则’f’格式）、’G’（指数很大时用’E’格式，否则’f’格式）</li>
<li>prec控制精度（排除指数部分）：对’f’、’e’、’E’，它表示小数点后的数字个数；对’g’、’G’，它控制总的数字个数。如果prec 为-1，则代表使用最少数量的、但又必需的数字来表示f</li>
</ul>
<h2 id="go的运算符和表达式"><a href="#go的运算符和表达式" class="headerlink" title="go的运算符和表达式"></a>go的运算符和表达式</h2><h3 id="算术运算符"><a href="#算术运算符" class="headerlink" title="算术运算符"></a>算术运算符</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ - * / %(求余) ++ --</span><br></pre></td></tr></table></figure>
<h3 id="关系运算符"><a href="#关系运算符" class="headerlink" title="关系运算符"></a>关系运算符</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">== != &gt; &lt; &gt;= &lt;=</span><br></pre></td></tr></table></figure>
<h3 id="逻辑运算符"><a href="#逻辑运算符" class="headerlink" title="逻辑运算符"></a>逻辑运算符</h3><div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">&amp;&amp;</th>
<th style="text-align:left">所谓逻辑与运算符。如果两个操作数都非零，则条件变为真</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">\</td>
<td style="text-align:left">\</td>
<td></td>
<td>所谓的逻辑或操作。如果任何两个操作数是非零，则条件变为真</td>
</tr>
<tr>
<td style="text-align:left">!</td>
<td style="text-align:left">所谓逻辑非运算符。使用反转操作数的逻辑状态。如果条件为真，那么逻辑非操后结果为假</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="keyword">var</span> a <span class="type">bool</span> = <span class="literal">true</span></span><br><span class="line">   <span class="keyword">var</span> b <span class="type">bool</span> = <span class="literal">false</span></span><br><span class="line">   <span class="keyword">if</span> ( a &amp;&amp; b ) &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;第一行 - 条件为 true\n&quot;</span> )</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> ( a || b ) &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;第二行 - 条件为 true\n&quot;</span> )</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">/* 修改 a 和 b 的值 */</span></span><br><span class="line">   a = <span class="literal">false</span></span><br><span class="line">   b = <span class="literal">true</span></span><br><span class="line">   <span class="keyword">if</span> ( a &amp;&amp; b ) &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;第三行 - 条件为 true\n&quot;</span> )</span><br><span class="line">   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;第三行 - 条件为 false\n&quot;</span> )</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">if</span> ( !(a &amp;&amp; b) ) &#123;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;第四行 - 条件为 true\n&quot;</span> )</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="位运算符"><a href="#位运算符" class="headerlink" title="位运算符"></a>位运算符</h3><p>位运算符对整数在内存中的二进制位进行操作</p>
<p>下表列出了位运算符<code>&amp;, |,  ^</code>的计算：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>p</th>
<th>q</th>
<th>p &amp; q</th>
<th>p \</th>
<th>q</th>
<th>p ^ q</th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr>
<td>1</td>
<td>1</td>
<td>1</td>
<td>1</td>
<td>0</td>
</tr>
<tr>
<td>1</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>
</div>
<p>Go 语言支持的位运算符如下表所示。假定 A 为60，B 为13，A = 0011 1100，B = 0000 1101：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;</td>
<td>按位与运算符”&amp;”是双目运算符。 其功能是参与运算的两数各对应的二进位相与。</td>
<td>(A &amp; B) 结果为 12, 二进制为 0000 1100</td>
</tr>
<tr>
<td>\</td>
<td></td>
<td>按位或运算符”\</td>
<td>“是双目运算符。 其功能是参与运算的两数各对应的二进位相或</td>
<td>(A \</td>
<td>B) 结果为 61, 二进制为 0011 1101</td>
</tr>
<tr>
<td>^</td>
<td>按位异或运算符”^”是双目运算符。 其功能是参与运算的两数各对应的二进位相异或，当两对应的二进位相异时，结果为1。</td>
<td>(A ^ B) 结果为 49, 二进制为 0011 0001</td>
</tr>
<tr>
<td>&lt;&lt;</td>
<td>左移运算符”&lt;&lt;”是双目运算符。左移n位就是乘以2的n次方。 其功能把”&lt;&lt;”左边的运算数的各二进位全部左移若干位，由”&lt;&lt;”右边的数指定移动的位数，高位丢弃，低位补0。</td>
<td>A &lt;&lt; 2 结果为 240 ，二进制为 1111 0000</td>
</tr>
<tr>
<td>&gt;&gt;</td>
<td>右移运算符”&gt;&gt;”是双目运算符。右移n位就是除以2的n次方。 其功能是把”&gt;&gt;”左边的运算数的各二进位全部右移若干位，”&gt;&gt;”右边的数指定移动的位数。</td>
<td>A &gt;&gt; 2 结果为 15 ，二进制为 0000 1111</td>
</tr>
</tbody>
</table>
</div>
<h3 id="赋值运算符"><a href="#赋值运算符" class="headerlink" title="赋值运算符"></a>赋值运算符</h3><div class="table-container">
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>=</td>
<td>简单的赋值运算符，将一个表达式的值赋给一个左值</td>
<td>C = A + B 将 A + B 表达式结果赋值给 C</td>
</tr>
<tr>
<td>+=</td>
<td>相加后再赋值</td>
<td>C += A 等于 C = C + A</td>
</tr>
<tr>
<td>-=</td>
<td>相减后再赋值</td>
<td>C -= A 等于 C = C - A</td>
</tr>
<tr>
<td>*=</td>
<td>相乘后再赋值</td>
<td>C <em>= A 等于 C = C </em> A</td>
</tr>
<tr>
<td>/=</td>
<td>相除后再赋值</td>
<td>C /= A 等于 C = C / A</td>
</tr>
<tr>
<td>%=</td>
<td>求余后再赋值</td>
<td>C %= A 等于 C = C % A</td>
</tr>
<tr>
<td>&lt;&lt;=</td>
<td>左移后赋值</td>
<td>C &lt;&lt;= 2 等于 C = C &lt;&lt; 2</td>
</tr>
<tr>
<td>&gt;&gt;=</td>
<td>右移后赋值</td>
<td>C &gt;&gt;= 2 等于 C = C &gt;&gt; 2</td>
</tr>
<tr>
<td>&amp;=</td>
<td>按位与后赋值</td>
<td>C &amp;= 2 等于 C = C &amp; 2</td>
</tr>
<tr>
<td>^=</td>
<td>按位异或后赋值</td>
<td>C ^= 2 等于 C = C ^ 2</td>
</tr>
<tr>
<td>\</td>
<td>=</td>
<td>按位或后赋值</td>
<td>C \</td>
<td>= 2 等于 C = C \</td>
<td>2</td>
</tr>
</tbody>
</table>
</div>
<h3 id="其他运算符"><a href="#其他运算符" class="headerlink" title="其他运算符"></a>其他运算符</h3><div class="table-container">
<table>
<thead>
<tr>
<th>运算符</th>
<th>描述</th>
<th>实例</th>
</tr>
</thead>
<tbody>
<tr>
<td>&amp;</td>
<td>返回变量存储地址</td>
<td>&a; 将给出变量的实际地址。</td>
</tr>
<tr>
<td>*</td>
<td>指针变量。</td>
<td>*a; 是一个指针变量</td>
</tr>
</tbody>
</table>
</div>
<h2 id="字符串的相关操作"><a href="#字符串的相关操作" class="headerlink" title="字符串的相关操作"></a>字符串的相关操作</h2><h3 id="基本操作"><a href="#基本操作" class="headerlink" title="基本操作"></a>基本操作</h3><p><strong>字符串的长度len</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="type">string</span> = <span class="string">&quot;cwz:中国人&quot;</span></span><br><span class="line">fmt.Println(<span class="built_in">len</span>(name))  <span class="comment">// 13</span></span><br></pre></td></tr></table></figure>
<p>字符串，返回的是字节的长度，中文一个字符占3个字节，所以长度为13</p>
<p>所以使用rune来存储中文字符：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> name <span class="type">string</span> = <span class="string">&quot;cwz:中国人&quot;</span></span><br><span class="line">name_arr := []<span class="type">rune</span>(name)</span><br><span class="line">fmt.Println(<span class="built_in">len</span>(name_arr))  <span class="comment">// 7</span></span><br></pre></td></tr></table></figure>
<h3 id="转义符"><a href="#转义符" class="headerlink" title="转义符"></a>转义符</h3><div class="table-container">
<table>
<thead>
<tr>
<th>转义字符</th>
<th>意义</th>
<th>ASCII码值（十进制）</th>
</tr>
</thead>
<tbody>
<tr>
<td>\n</td>
<td>换行(LF) ，将当前位置移到下一行开头</td>
<td>010</td>
</tr>
<tr>
<td>\r</td>
<td>回车(CR) ，将当前位置移到本行开头</td>
<td>013</td>
</tr>
<tr>
<td>\t</td>
<td>水平制表(HT) （跳到下一个TAB位置）</td>
<td>009</td>
</tr>
<tr>
<td><code>\\</code></td>
<td>代表一个反斜线字符’’\’</td>
<td>092</td>
</tr>
<tr>
<td><code>\&#39;</code></td>
<td>代表一个单引号（撇号）字符</td>
<td>039</td>
</tr>
<tr>
<td><code>\&quot;</code></td>
<td>代表一个双引号字符</td>
<td>034</td>
</tr>
<tr>
<td>\?</td>
<td>代表一个问号</td>
<td>063</td>
</tr>
</tbody>
</table>
</div>
<h3 id="字符串子串的操作"><a href="#字符串子串的操作" class="headerlink" title="字符串子串的操作"></a>字符串子串的操作</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">var</span> name <span class="type">string</span> = <span class="string">&quot;cwz:你好啊aac&quot;</span></span><br><span class="line">   <span class="keyword">var</span> date <span class="type">string</span> = <span class="string">&quot;2021\\01\\12&quot;</span></span><br><span class="line">   fmt.Println(name, date)  <span class="comment">// cwz:你好啊aac 2021\01\12</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 是否包含字符串</span></span><br><span class="line">   fmt.Println(strings.Contains(name, <span class="string">&quot;c&quot;</span>)) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line">   fmt.Println(strings.Index(name, <span class="string">&quot;你&quot;</span>))  <span class="comment">// 4</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 统计出现的次数</span></span><br><span class="line">   fmt.Println(strings.Count(name, <span class="string">&quot;c&quot;</span>))  <span class="comment">// 2</span></span><br><span class="line">   <span class="comment">// 前缀和后缀</span></span><br><span class="line">   fmt.Println(strings.HasPrefix(name, <span class="string">&quot;c&quot;</span>))  <span class="comment">// true</span></span><br><span class="line">   fmt.Println(strings.HasSuffix(name, <span class="string">&quot;h&quot;</span>)) <span class="comment">// false</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 大小写转换</span></span><br><span class="line">   fmt.Println(strings.ToUpper(<span class="string">&quot;hello&quot;</span>)) <span class="comment">// HELLO</span></span><br><span class="line">   fmt.Println(strings.ToLower(<span class="string">&quot;AAAA&quot;</span>))  <span class="comment">// aaaa</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 字符串的比较</span></span><br><span class="line">   fmt.Println(strings.Compare(<span class="string">&quot;he&quot;</span>, <span class="string">&quot;ha&quot;</span>)) <span class="comment">// 1</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 去掉空格</span></span><br><span class="line">   fmt.Println(strings.TrimSpace(<span class="string">&quot;   hhh   &quot;</span>)) <span class="comment">// hhh</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// split方法</span></span><br><span class="line">   fmt.Println(strings.Split(<span class="string">&quot;192.189.211.0&quot;</span>, <span class="string">&quot;.&quot;</span>))</span><br><span class="line"></span><br><span class="line">   <span class="comment">// 合并 join</span></span><br><span class="line">   arrs := strings.Split(<span class="string">&quot;192.189.211.0&quot;</span>, <span class="string">&quot;.&quot;</span>) <span class="comment">// [192 189 211 0]</span></span><br><span class="line">   fmt.Println(strings.Join(arrs, <span class="string">&quot;-&quot;</span>))  <span class="comment">// 192-189-211-0</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">// 字符串替换</span></span><br><span class="line">   fmt.Println(strings.Replace(<span class="string">&quot;cwz:18&quot;</span>, <span class="string">&quot;18&quot;</span>, <span class="string">&quot;20&quot;</span>, <span class="number">1</span>))   <span class="comment">// cwz:20</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="字符串的输入输出格式化"><a href="#字符串的输入输出格式化" class="headerlink" title="字符串的输入输出格式化"></a>字符串的输入输出格式化</h3><h4 id="缺省格式和类型"><a href="#缺省格式和类型" class="headerlink" title="缺省格式和类型"></a>缺省格式和类型</h4><div class="table-container">
<table>
<thead>
<tr>
<th>格式化后的效果</th>
<th>动词</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>[0 1]</td>
<td><code>%v</code></td>
<td>缺省格式</td>
</tr>
<tr>
<td>[]int64{0, 1}</td>
<td><code>%#v</code></td>
<td>go语法打印</td>
</tr>
<tr>
<td>[]int64</td>
<td><code>%T</code></td>
<td>类型打印</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">   <span class="string">&quot;fmt&quot;</span></span><br><span class="line">   <span class="string">&quot;strconv&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="comment">// printf 格式化输出</span></span><br><span class="line">   name := <span class="string">&quot;cwz&quot;</span></span><br><span class="line">   age := <span class="number">18</span></span><br><span class="line">   fmt.Println(<span class="string">&quot;name:&quot;</span> + name + <span class="string">&quot;,age:&quot;</span> + strconv.Itoa(age)) <span class="comment">// name:cwz,age:18</span></span><br><span class="line">   fmt.Printf(<span class="string">&quot;name:%v, age:%v\n&quot;</span>, name, age) <span class="comment">// name:cwz, age:18</span></span><br><span class="line">   fmt.Printf(<span class="string">&quot;name:%#v, age:%#v\n&quot;</span>, name, age)  <span class="comment">// name:&quot;cwz&quot;, age:18</span></span><br><span class="line">   fmt.Printf(<span class="string">&quot;name:%T, age:%T\n&quot;</span>, name, age) <span class="comment">// name:string, age:int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="整型-缩进-进制类型-正负符号"><a href="#整型-缩进-进制类型-正负符号" class="headerlink" title="整型(缩进, 进制类型, 正负符号)"></a>整型(缩进, 进制类型, 正负符号)</h4><div class="table-container">
<table>
<thead>
<tr>
<th>格式化后的效果</th>
<th>动词</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>15</td>
<td><code>%d</code></td>
<td>十进制</td>
</tr>
<tr>
<td>+15</td>
<td><code>%+d</code></td>
<td>必须显示正负符号</td>
</tr>
<tr>
<td>␣␣15</td>
<td><code>%4d</code></td>
<td>Pad空格(宽度为4，右对齐)</td>
</tr>
<tr>
<td>15␣␣</td>
<td><code>%-4d</code></td>
<td>Pad空格 (宽度为4，左对齐)</td>
</tr>
<tr>
<td>1111</td>
<td><code>%b</code></td>
<td>二进制</td>
</tr>
<tr>
<td>17</td>
<td><code>%o</code></td>
<td>八进制</td>
</tr>
<tr>
<td>f</td>
<td><code>%x</code></td>
<td>16进制，小写</td>
</tr>
</tbody>
</table>
</div>
<h4 id="字符-有引号-Unicode"><a href="#字符-有引号-Unicode" class="headerlink" title="字符(有引号, Unicode)"></a>字符(有引号, Unicode)</h4><div class="table-container">
<table>
<thead>
<tr>
<th>格式化后的效果</th>
<th>动词</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td><code>%c</code></td>
<td>字符</td>
</tr>
<tr>
<td>‘A’</td>
<td><code>%q</code></td>
<td>有引号的字符</td>
</tr>
<tr>
<td>U+0041</td>
<td><code>%U</code></td>
<td>Unicode</td>
</tr>
<tr>
<td>U+0041 ‘A’</td>
<td><code>%#U</code></td>
<td>Unicode 有引号</td>
</tr>
</tbody>
</table>
</div>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">data := <span class="number">65</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;%q\n&quot;</span>, data)  <span class="comment">// &#x27;A&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="浮点-缩进-精度-科学计数"><a href="#浮点-缩进-精度-科学计数" class="headerlink" title="浮点(缩进, 精度, 科学计数)"></a>浮点(缩进, 精度, 科学计数)</h4><div class="table-container">
<table>
<thead>
<tr>
<th>格式化后的效果</th>
<th>动词</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.234560e+02</td>
<td><code>%e</code></td>
<td>科学计数</td>
</tr>
<tr>
<td>123.456000</td>
<td><code>%f</code></td>
<td>十进制小数</td>
</tr>
</tbody>
</table>
</div>
<h2 id="条件语句和循环语句"><a href="#条件语句和循环语句" class="headerlink" title="条件语句和循环语句"></a>条件语句和循环语句</h2><p>go语言的常用控制流程有if和for，没有while， 而switch和goto是为了简化代码，降低重复代码，属于扩展的流程控制</p>
<h3 id="if"><a href="#if" class="headerlink" title="if"></a>if</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> 布尔表达式 &#123;</span><br><span class="line">   <span class="comment">/* 在布尔表达式为 true 时执行 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> 布尔表达式 &#123;</span><br><span class="line">   <span class="comment">/* 在布尔表达式为 true 时执行 */</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">/* 在布尔表达式为 false 时执行 */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> 布尔表达式<span class="number">1</span> &#123;</span><br><span class="line">   <span class="comment">/* 在布尔表达式1为 true 时执行 */</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> 布尔表达式<span class="number">2</span>&#123;</span><br><span class="line">   <span class="comment">/* 在布尔表达式1为 false ,布尔表达式2为true时执行 */</span></span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">   <span class="comment">/* 在上面两个布尔表达式都为false时，执行*/</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="for"><a href="#for" class="headerlink" title="for"></a>for</h3><p>Go 语言的 For 循环有 3 种形式，只有其中的一种使用分号</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//和 C 语言的 for 一样：</span></span><br><span class="line"><span class="keyword">for</span> init; condition; post &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//和 C 的 while 一样：</span></span><br><span class="line"><span class="keyword">for</span> condition &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//和 C 的 for(;;) 一样：</span></span><br><span class="line"><span class="keyword">for</span> &#123; &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    sum := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        sum += <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(sum) <span class="comment">// 9</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>for循环的range格式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    name := <span class="string">&quot;hello&quot;</span></span><br><span class="line">    <span class="keyword">for</span> _,value:=<span class="keyword">range</span> name&#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%c&quot;</span>, value)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="goto语句"><a href="#goto语句" class="headerlink" title="goto语句"></a>goto语句</h3><p>Go 语言的 goto 语句可以无条件地转移到过程中指定的行。</p>
<p>goto 语句通常与条件语句配合使用。可用来实现条件转移， 构成循环，跳出循环体等功能。</p>
<p>但是，在结构化程序设计中一般不主张使用 goto 语句， 以免造成程序流程的混乱</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">/* 定义局部变量 */</span></span><br><span class="line">   <span class="keyword">var</span> a <span class="type">int</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line">   <span class="comment">/* 循环 */</span></span><br><span class="line">   LOOP: <span class="keyword">for</span> a &lt; <span class="number">20</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> a == <span class="number">15</span> &#123;</span><br><span class="line">         <span class="comment">/* 跳过迭代 */</span></span><br><span class="line">         a = a + <span class="number">1</span></span><br><span class="line">         <span class="keyword">goto</span> LOOP</span><br><span class="line">      &#125;</span><br><span class="line">      fmt.Printf(<span class="string">&quot;a的值为 : %d\n&quot;</span>, a)</span><br><span class="line">      a++    </span><br><span class="line">   &#125;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 goto 退出多层循环：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> x := <span class="number">0</span>; x &lt; <span class="number">10</span>; x++ &#123;</span><br><span class="line">        <span class="keyword">for</span> y := <span class="number">0</span>; y &lt; <span class="number">10</span>; y++ &#123;</span><br><span class="line">            <span class="keyword">if</span> y == <span class="number">2</span> &#123;</span><br><span class="line">                <span class="comment">// 跳转到标签</span></span><br><span class="line">                <span class="keyword">goto</span> breakHere</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 手动返回, 避免执行进入标签</span></span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">    <span class="comment">// 标签</span></span><br><span class="line">    breakHere:</span><br><span class="line">        fmt.Println(<span class="string">&quot;done&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="switch语句"><a href="#switch语句" class="headerlink" title="switch语句"></a>switch语句</h3><p>switch 语句用于基于不同条件执行不同动作，每一个 case 分支都是唯一的，从上至下逐一测试，直到匹配为止。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> var1 &#123;</span><br><span class="line">    <span class="keyword">case</span> val1:</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">case</span> val2:</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">   <span class="comment">/* 定义局部变量 */</span></span><br><span class="line">   <span class="keyword">var</span> grade <span class="type">string</span> = <span class="string">&quot;B&quot;</span></span><br><span class="line">   <span class="keyword">var</span> marks <span class="type">int</span> = <span class="number">90</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">switch</span> marks &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">90</span>: grade = <span class="string">&quot;A&quot;</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">80</span>: grade = <span class="string">&quot;B&quot;</span></span><br><span class="line">      <span class="keyword">case</span> <span class="number">50</span>,<span class="number">60</span>,<span class="number">70</span> : grade = <span class="string">&quot;C&quot;</span></span><br><span class="line">      <span class="keyword">default</span>: grade = <span class="string">&quot;D&quot;</span>  </span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">switch</span> &#123;</span><br><span class="line">      <span class="keyword">case</span> grade == <span class="string">&quot;A&quot;</span> :</span><br><span class="line">         fmt.Printf(<span class="string">&quot;优秀!\n&quot;</span> )    </span><br><span class="line">      <span class="keyword">case</span> grade == <span class="string">&quot;B&quot;</span>, grade == <span class="string">&quot;C&quot;</span> :</span><br><span class="line">         fmt.Printf(<span class="string">&quot;良好\n&quot;</span> )      </span><br><span class="line">      <span class="keyword">case</span> grade == <span class="string">&quot;D&quot;</span> :</span><br><span class="line">         fmt.Printf(<span class="string">&quot;及格\n&quot;</span> )      </span><br><span class="line">      <span class="keyword">case</span> grade == <span class="string">&quot;F&quot;</span>:</span><br><span class="line">         fmt.Printf(<span class="string">&quot;不及格\n&quot;</span> )</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">         fmt.Printf(<span class="string">&quot;差\n&quot;</span> );</span><br><span class="line">   &#125;</span><br><span class="line">   fmt.Printf(<span class="string">&quot;你的等级是 %s\n&quot;</span>, grade );      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不同的 case 表达式使用逗号分隔：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = <span class="string">&quot;mum&quot;</span></span><br><span class="line"><span class="keyword">switch</span> a &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">&quot;mum&quot;</span>, <span class="string">&quot;daddy&quot;</span>:</span><br><span class="line">    fmt.Println(<span class="string">&quot;family&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>分支表达式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> r <span class="type">int</span> = <span class="number">11</span></span><br><span class="line"><span class="keyword">switch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> r &gt; <span class="number">10</span> &amp;&amp; r &lt; <span class="number">20</span>:</span><br><span class="line">    fmt.Println(r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="常用复杂的数据类型"><a href="#常用复杂的数据类型" class="headerlink" title="常用复杂的数据类型"></a>常用复杂的数据类型</h2><h3 id="go语言中的数组"><a href="#go语言中的数组" class="headerlink" title="go语言中的数组"></a>go语言中的数组</h3><p>Go 语言提供了数组类型的数据结构。 </p>
<p>数组是具有相同唯一类型的一组已编号且长度固定的数据项序列，这种类型可以是任意的原始类型例如整形、字符串或者自定义类型。</p>
<p>数组元素可以通过索引（位置）来读取（或者修改），索引从0开始，第一个元素索引为 0，第二个索引为 1，以此类推。数组的下标取值范围是从0开始，到长度减1。</p>
<p>数组一旦定义后，大小不能更改。</p>
<h4 id="声明和初始化数组"><a href="#声明和初始化数组" class="headerlink" title="声明和初始化数组"></a>声明和初始化数组</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 数组的声明</span></span><br><span class="line"><span class="keyword">var</span> courses [<span class="number">10</span>] <span class="type">string</span></span><br><span class="line"><span class="keyword">var</span> courses2 = [<span class="number">5</span>]<span class="type">string</span>&#123;<span class="string">&quot;redis&quot;</span>,<span class="string">&quot;django&quot;</span>,<span class="string">&quot;flask&quot;</span>&#125;</span><br></pre></td></tr></table></figure>
<p>初始化数组中 {} 中的元素个数不能大于 [] 中的数字。如果忽略 [] 中的数字不设置数组大小，Go 语言会根据元素的个数来设置数组的大小：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> balance = []<span class="type">float32</span>&#123;<span class="number">1000.0</span>, <span class="number">2.0</span>, <span class="number">3.4</span>, <span class="number">7.0</span>, <span class="number">50.0</span>&#125;</span><br></pre></td></tr></table></figure>
<p>数组的其他创建方式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a [<span class="number">4</span>] <span class="type">float32</span> <span class="comment">// 等价于：var arr2 = [4]float32&#123;&#125;</span></span><br><span class="line">fmt.Println(a) <span class="comment">// [0 0 0 0]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> b = [<span class="number">5</span>] <span class="type">string</span>&#123;<span class="string">&quot;ruby&quot;</span>, <span class="string">&quot;王二狗&quot;</span>, <span class="string">&quot;rose&quot;</span>&#125;</span><br><span class="line">fmt.Println(b) <span class="comment">// [ruby 王二狗 rose  ]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> c = [<span class="number">5</span>] <span class="type">int</span>&#123;<span class="string">&#x27;A&#x27;</span>, <span class="string">&#x27;B&#x27;</span>, <span class="string">&#x27;C&#x27;</span>, <span class="string">&#x27;D&#x27;</span>, <span class="string">&#x27;E&#x27;</span>&#125; <span class="comment">// byte</span></span><br><span class="line">fmt.Println(c) <span class="comment">// [65 66 67 68 69]</span></span><br><span class="line"></span><br><span class="line">d := [...] <span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;<span class="comment">// 根据元素的个数，设置数组的大小</span></span><br><span class="line">fmt.Println(d)<span class="comment">//[1 2 3 4 5]</span></span><br><span class="line"></span><br><span class="line">e := [<span class="number">5</span>] <span class="type">int</span>&#123;<span class="number">4</span>: <span class="number">100</span>&#125; <span class="comment">// [0 0 0 0 100]</span></span><br><span class="line">fmt.Println(e)</span><br><span class="line"></span><br><span class="line">f := [...] <span class="type">int</span>&#123;<span class="number">0</span>:<span class="number">1</span>, <span class="number">4</span>:<span class="number">1</span>, <span class="number">9</span>:<span class="number">1</span>&#125; <span class="comment">// [1 0 0 0 1 0 0 0 0 1]</span></span><br><span class="line">fmt.Println(f)</span><br></pre></td></tr></table></figure>
<h4 id="取值"><a href="#取值" class="headerlink" title="取值"></a>取值</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    course := [<span class="number">5</span>]<span class="type">string</span>&#123;<span class="string">&quot;golang&quot;</span>, <span class="string">&quot;mysql&quot;</span>&#125;</span><br><span class="line">    fmt.Println(course[<span class="number">0</span>])  <span class="comment">// golang</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="for遍历数组"><a href="#for遍历数组" class="headerlink" title="for遍历数组"></a>for遍历数组</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a = [<span class="number">3</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="built_in">len</span>(a); i++ &#123;</span><br><span class="line">        fmt.Println(a[i])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 循环打印出1,3,5</span></span><br></pre></td></tr></table></figure>
<h4 id="for-range-遍历数组"><a href="#for-range-遍历数组" class="headerlink" title="for range 遍历数组"></a>for range 遍历数组</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a = [<span class="number">3</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>&#125;</span><br><span class="line">    <span class="keyword">for</span> i, v := <span class="keyword">range</span> a &#123;</span><br><span class="line">        fmt.Println(i,v)   <span class="comment">// i是索引，v是值</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">0 1</span></span><br><span class="line"><span class="comment">1 3</span></span><br><span class="line"><span class="comment">2 5</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h4 id="数组是值类型"><a href="#数组是值类型" class="headerlink" title="数组是值类型"></a>数组是值类型</h4><p>Go中的数组是值类型，而不是引用类型。这意味着当它们被分配给一个新变量时，将把原始数组的副本分配给新变量。如果对新变量进行了更改，则不会在原始数组中反映。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;  </span><br><span class="line">    a := [...]<span class="type">string</span>&#123;<span class="string">&quot;USA&quot;</span>, <span class="string">&quot;China&quot;</span>, <span class="string">&quot;India&quot;</span>, <span class="string">&quot;Germany&quot;</span>, <span class="string">&quot;France&quot;</span>&#125;</span><br><span class="line">    b := a <span class="comment">// a copy of a is assigned to b</span></span><br><span class="line">    b[<span class="number">0</span>] = <span class="string">&quot;Singapore&quot;</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;a is &quot;</span>, a) <span class="comment">// a is  [USA China India Germany France]</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;b is &quot;</span>, b) <span class="comment">// b is  [Singapore China India Germany France]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="go语言中的切片"><a href="#go语言中的切片" class="headerlink" title="go语言中的切片"></a>go语言中的切片</h2><ul>
<li>Go 数组的长度不可改变，在特定场景中这样的集合就不太适用，Go中提供了一种灵活、功能强悍的内置类型切片(“动态数组”)。</li>
<li>与数组相比，切片的长度是不固定的；可以追加元素，在追加时可能使切片的容量增大</li>
</ul>
<p>Go的切片类型为处理同类型数据序列提供一个方便而高效的方式。 切片有些类似于其他语言中的数组，但是有一些不同寻常的特性。</p>
<h3 id="定义切片"><a href="#定义切片" class="headerlink" title="定义切片"></a>定义切片</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 第一种方法，直接定义</span></span><br><span class="line">    <span class="keyword">var</span> courses []<span class="type">string</span>  <span class="comment">// 定义了一个切片</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, courses)  <span class="comment">// []string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第二种方法，字面量</span></span><br><span class="line">    courses2 := []<span class="type">string</span>&#123;<span class="string">&quot;django&quot;</span>, <span class="string">&quot;scrapy&quot;</span>, <span class="string">&quot;flask&quot;</span>&#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T&quot;</span>, courses2)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//第三种，使用make</span></span><br><span class="line">    courses3 := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">5</span>)</span><br><span class="line">    fmt.Println(<span class="built_in">len</span>(courses3))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第四种方法，通过数组变成一个切片</span></span><br><span class="line">    <span class="keyword">var</span> course4 = [<span class="number">5</span>]<span class="type">string</span>&#123;<span class="string">&quot;python&quot;</span>,<span class="string">&quot;flask&quot;</span>,<span class="string">&quot;django&quot;</span>,<span class="string">&quot;golang&quot;</span>,<span class="string">&quot;beego&quot;</span>&#125;</span><br><span class="line">    subCourse := course4[<span class="number">1</span>:<span class="number">4</span>]</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, subCourse)  <span class="comment">// []string</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第五种方法：new</span></span><br><span class="line">    subCourse2 := *<span class="built_in">new</span>([]<span class="type">int</span>)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T&quot;</span>, subCourse2)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用方法"><a href="#使用方法" class="headerlink" title="使用方法"></a>使用方法</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> course4 = [<span class="number">5</span>]<span class="type">string</span>&#123;<span class="string">&quot;python&quot;</span>,<span class="string">&quot;flask&quot;</span>,<span class="string">&quot;django&quot;</span>,<span class="string">&quot;golang&quot;</span>,<span class="string">&quot;beego&quot;</span>&#125;</span><br><span class="line">    subCourse := course4[<span class="number">1</span>:<span class="number">4</span>]</span><br><span class="line">    subCourse3 := subCourse[<span class="number">1</span>:<span class="number">3</span>]</span><br><span class="line">    <span class="comment">// append 追加元素</span></span><br><span class="line">    subCourse3 = <span class="built_in">append</span>(subCourse3, <span class="string">&quot;abc&quot;</span>)</span><br><span class="line">    fmt.Println(subCourse3)  <span class="comment">// [django golang abc]</span></span><br><span class="line">    appendCourses := []<span class="type">string</span>&#123;<span class="string">&quot;a&quot;</span>, <span class="string">&quot;b&quot;</span>, <span class="string">&quot;c&quot;</span>&#125;</span><br><span class="line">    subCourse3 = <span class="built_in">append</span>(subCourse3, appendCourses...)</span><br><span class="line">    fmt.Println(subCourse3)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 拷贝的时候  目标对象长度需要设置</span></span><br><span class="line">    subCourse4 := <span class="built_in">make</span>([]<span class="type">string</span>, <span class="number">2</span>)</span><br><span class="line">    fmt.Println(<span class="built_in">len</span>(subCourse4)) <span class="comment">// 2</span></span><br><span class="line">    <span class="built_in">copy</span>(subCourse4, subCourse3)</span><br><span class="line">    fmt.Println(subCourse4)  <span class="comment">// [django golang]</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除元素</span></span><br><span class="line">    deleteCourses := [<span class="number">5</span>]<span class="type">string</span>&#123;<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;abc&quot;</span>, <span class="string">&quot;123&quot;</span>, <span class="string">&quot;golang&quot;</span>, <span class="string">&quot;word&quot;</span>&#125;</span><br><span class="line">    courseSlice := deleteCourses[:]</span><br><span class="line">    courseSlice = <span class="built_in">append</span>(courseSlice[:<span class="number">1</span>], courseSlice[<span class="number">2</span>:]...)</span><br><span class="line">    fmt.Println(courseSlice)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="slice的内部原理"><a href="#slice的内部原理" class="headerlink" title="slice的内部原理"></a>slice的内部原理</h3><p>Go 语言中的的 slice 是在数组之上的抽象数据类型，要理解slice就需要先理解数组。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a [<span class="number">4</span>]<span class="type">int</span></span><br><span class="line">a[<span class="number">0</span>] = <span class="number">1</span></span><br><span class="line">i := a[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p>数组定义了长度和元素类型。例如，<code>[4]int</code> 类型表示一个由四个整数组成的数组。数组的大小是固定的，长度是数组类型的一部分（ <code>[4]int</code> 和 <code>[5]int</code> 是完全不同的类型）</p>
<p>类型 <code>[4]int</code> 在内存中用四个连续的整数表示。</p>
<p>Go 语言中，数组是值传递。当分配或传递数组值的时候，实际上会<strong>复制整个数组</strong></p>
<p>slice 的底层数据是数组，slice 是对数组的封装，它描述一个数组的片段。两者都可以通过下标来访问单个元素。</p>
<p>在 Go 中，数组是不常见的，因为其长度是类型的一部分，限制了它的表达能力，比如 <code>[3]int</code> 和 <code>[4]int</code> 就是不同的类型。</p>
<p>而切片则非常灵活，它可以动态地扩容。切片的类型和长度无关</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210607155746.png" alt=""></p>
<p>如果使用make创建slice，首先会先创建一个底层的数组。所以修改slice的值会影响到底层数组，也就是说：切片和数组是公用一块内存的。</p>
<h3 id="切片的扩容"><a href="#切片的扩容" class="headerlink" title="切片的扩容"></a>切片的扩容</h3><ul>
<li>append 函数的参数长度可变，因此可以追加多个值到 slice 中，还可以用 <code>...</code> 传入 slice，直接追加一个切片。</li>
<li><code>append</code>函数返回值是一个新的slice，Go编译器不允许调用了 append 函数后不使用返回值。</li>
<li>使用 append 可以向 slice 追加元素，实际上是往底层数组添加元素。但是底层数组的长度是固定的，如果索引 <code>len-1</code> 所指向的元素已经是底层数组的最后一个元素，就没法再添加了。</li>
<li>这时，slice 会迁移到新的内存位置，新底层数组的长度也会增加，这样就可以放置新增的元素。同时，为了应对未来可能再次发生的 append 操作，新的底层数组的长度，也就是新 <code>slice</code> 的容量是留了一定的 <code>buffer</code> 的。否则，每次添加元素的时候，都会发生迁移，成本太高。</li>
<li>新 slice 预留的 <code>buffer</code> 大小是有一定规律的，并不是简单的：</li>
</ul>
<blockquote>
<p>当原 slice 容量小于 <code>1024</code> 的时候，新 slice 容量变成原来的 <code>2</code> 倍；原 slice 容量超过 <code>1024</code>，新 slice 容量变成原来的<code>1.25</code>倍。</p>
</blockquote>
<p>这样描述是不对的。</p>
<ul>
<li><code>append</code> 函数会在切片容量不够的情况下，会调用 <code>growslice</code> 函数获取所需要的内存，这称为扩容，扩容会改变元素原来的位置</li>
<li>扩容策略并不是简单的扩为原切片容量的 <code>2</code> 倍或 <code>1.25</code> 倍，还有内存对齐的操作。后半部分还对 <code>newcap</code> 作了一个<code>内存对齐</code>，这个和内存分配策略相关。进行内存对齐之后，新 slice 的容量是要 <code>大于等于</code> 老 slice 容量的 <code>2倍</code>或者<code>1.25倍</code>。</li>
</ul>
<p>文章推荐：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903811429957646">https://juejin.cn/post/6844903811429957646</a></p>
<h2 id="map的使用"><a href="#map的使用" class="headerlink" title="map的使用"></a>map的使用</h2><h3 id="创建map"><a href="#创建map" class="headerlink" title="创建map"></a>创建map</h3><p>要求所有的key的数据类型相同，所有value数据类型相同(注：key与value可以有不同的数据类型)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1、字面值</span></span><br><span class="line">    m1 := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;m1&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, m1)  <span class="comment">// map[m1:v1]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 2、使用make创建</span></span><br><span class="line">    m2 := <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">    m2[<span class="string">&quot;m2&quot;</span>] = <span class="string">&quot;v2&quot;</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, m2)  <span class="comment">// map[m2:v2]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 3、定义一个空的map</span></span><br><span class="line">    m3 := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, m3)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// map中的key不是所有的类型都支持，该类型需要支持 == 或者 != 操作</span></span><br><span class="line">    <span class="comment">//a := []int&#123;1,2,3&#125;</span></span><br><span class="line">    <span class="comment">//b := []int&#123;1,2,3&#125;</span></span><br><span class="line">    <span class="comment">// 两个切片之间是不能比较的，所以slice是不能做map的key的</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="map常见操作"><a href="#map常见操作" class="headerlink" title="map常见操作"></a>map常见操作</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// map的基本操作</span></span><br><span class="line">    m := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;a&quot;</span>: <span class="string">&quot;va&quot;</span>,</span><br><span class="line">        <span class="string">&quot;b&quot;</span>: <span class="string">&quot;vb&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 增加，修改</span></span><br><span class="line">    m[<span class="string">&quot;c&quot;</span>] = <span class="string">&quot;vc&quot;</span></span><br><span class="line">    m[<span class="string">&quot;b&quot;</span>] = <span class="string">&quot;vb1&quot;</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, m)  <span class="comment">// map[a:va b:vb1 c:vc]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查询</span></span><br><span class="line">    v, ok := m[<span class="string">&quot;d&quot;</span>]</span><br><span class="line">    fmt.Println(v, ok)  <span class="comment">// map[a:va b:vb1 c:vc] false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 删除</span></span><br><span class="line">    <span class="comment">//delete(m, &quot;a&quot;)</span></span><br><span class="line">    <span class="comment">//fmt.Printf(&quot;%v&quot;, m)  // map[b:vb1 c:vc]</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 遍历</span></span><br><span class="line">    <span class="keyword">for</span> k, v := <span class="keyword">range</span> m&#123;</span><br><span class="line">        fmt.Println(k, v)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>map 遍历的顺序是随机的，使用for range遍历的时候，k,v使用的同一块内存</p>
<p>将go中的map按key进行排序：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sort&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fruits := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;</span><br><span class="line">        <span class="string">&quot;oranges&quot;</span>: <span class="number">100</span>,</span><br><span class="line">        <span class="string">&quot;apples&quot;</span>:  <span class="number">200</span>,</span><br><span class="line">        <span class="string">&quot;banans&quot;</span>:  <span class="number">300</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 将key转移到切片，将切片进行排序</span></span><br><span class="line">    <span class="keyword">var</span> a [] <span class="type">string</span></span><br><span class="line">    <span class="keyword">for</span> key := <span class="keyword">range</span> fruits &#123;</span><br><span class="line">        a = <span class="built_in">append</span>(a, key)</span><br><span class="line">    &#125;</span><br><span class="line">    sort.Strings(a)</span><br><span class="line">    <span class="keyword">for</span> _, key := <span class="keyword">range</span> a &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%s:%v\n&quot;</span>, key, fruits[key])</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">apples:200</span></span><br><span class="line"><span class="comment">banans:300 </span></span><br><span class="line"><span class="comment">oranges:100</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="go语言的指针"><a href="#go语言的指针" class="headerlink" title="go语言的指针"></a>go语言的指针</h2><h3 id="什么是指针"><a href="#什么是指针" class="headerlink" title="什么是指针"></a>什么是指针</h3><p>抛砖引玉：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(a <span class="type">int</span>, b <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 用于交换a和b</span></span><br><span class="line">    c := a</span><br><span class="line">    a = b</span><br><span class="line">    b = c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    a := <span class="number">10</span></span><br><span class="line">    b := <span class="number">20</span></span><br><span class="line">    swap(a, b)</span><br><span class="line">    fmt.Println(a, b)  <span class="comment">// 10 20</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码并没有将a和b交换。我们要明白，像int这种基本类型是一个值传递，main函数中的变量和swap函数的就完全没有关系，main函数中将参数传递到swap是先拷贝一份数据，将拷贝的数据传递过去。所以就有了指针。</p>
<p>对于内存来说，每一个字节其实都有地址，可以通过16进制打印出来。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210608095343.png" alt=""></p>
<p>如上图所示，变量b的值为156，而b的内存地址为<code>0x1040a124</code>，变量a存储了b的地址，就称a指向了b</p>
<h3 id="指针的操作"><a href="#指针的操作" class="headerlink" title="指针的操作"></a>指针的操作</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 现在有一种特殊的变量类型，这个变量只能保存地址</span></span><br><span class="line"><span class="keyword">var</span> ip *<span class="type">int</span>  <span class="comment">// 这个变量里面只能保存地址类型这种值</span></span><br><span class="line">ip = &amp;a</span><br><span class="line">fmt.Println(ip)  <span class="comment">// 0xc00000a0b8</span></span><br></pre></td></tr></table></figure>
<p><strong><code>&amp;</code>操作符用于获取变量的地址。如果在类型前面加<code>*</code>，表示指向这个类型的指针</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    a := <span class="number">10</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 现在有一种特殊的变量类型，这个变量只能保存地址</span></span><br><span class="line">    <span class="keyword">var</span> ip *<span class="type">int</span>  <span class="comment">// 这个变量里面只能保存地址类型这种值</span></span><br><span class="line">    ip = &amp;a</span><br><span class="line">    fmt.Println(ip)  <span class="comment">// 0xc00000a0b8</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果要修改指针指向的变量的值，用法也比较特殊</span></span><br><span class="line">    *ip = <span class="number">50</span></span><br><span class="line">    fmt.Println(a)  <span class="comment">// 50</span></span><br><span class="line">    <span class="comment">// 如何定义指针变量，如果修改指针变量指向内存中的值</span></span><br><span class="line">    fmt.Printf(<span class="string">&quot;ip所指向的内存空间地址是：%p，内存中的值：%d&quot;</span>, ip, *ip)</span><br><span class="line">    <span class="comment">// ip所指向的内存空间地址是：0xc00000a0b8，内存中的值：50</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="数组指针和指针数组"><a href="#数组指针和指针数组" class="headerlink" title="数组指针和指针数组"></a>数组指针和指针数组</h3><p>数组指针：指向数组导入指针</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a [<span class="number">3</span>]<span class="type">int</span> = [<span class="number">3</span>]<span class="type">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;</span><br><span class="line">    <span class="keyword">var</span> b *[<span class="number">3</span>]<span class="type">int</span> = &amp;a</span><br><span class="line">    fmt.Println(b)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &amp;[1 2 3]</span></span><br></pre></td></tr></table></figure>
<p>指针数组：数组里面放入指针</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> x, y, z = <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line">    <span class="keyword">var</span> b [<span class="number">3</span>]*<span class="type">int</span> = [<span class="number">3</span>]*<span class="type">int</span>&#123;&amp;x, &amp;y, &amp;z&#125;</span><br><span class="line">    fmt.Println(b)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// [0xc00001e0c8 0xc00001e0e0 0xc00001e0e8]</span></span><br></pre></td></tr></table></figure>
<p>指针的默认值是nil，一般判断：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ip != <span class="literal">nil</span>&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>交换a和b：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">swap</span><span class="params">(a *<span class="type">int</span>, b *<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// 用于交换a和b</span></span><br><span class="line">    c := *a</span><br><span class="line">    *a = *b</span><br><span class="line">    *b = c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    a := <span class="number">10</span></span><br><span class="line">    b := <span class="number">20</span></span><br><span class="line">    swap(&amp;a, &amp;b)</span><br><span class="line">    fmt.Println(a, b)  <span class="comment">// 20 10</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="指向指针的指针"><a href="#指向指针的指针" class="headerlink" title="指向指针的指针"></a>指向指针的指针</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a <span class="type">int</span> = <span class="number">123</span></span><br><span class="line">    <span class="keyword">var</span> b *<span class="type">int</span> = &amp;a</span><br><span class="line">    <span class="keyword">var</span> c **<span class="type">int</span> = &amp;b</span><br><span class="line">    <span class="keyword">var</span> d ***<span class="type">int</span> = &amp;c</span><br><span class="line"></span><br><span class="line">    fmt.Println(d)    <span class="comment">// 0xc00000e030</span></span><br><span class="line">    fmt.Println(*d)   <span class="comment">// 0xc00000e028</span></span><br><span class="line">    fmt.Println(**d)  <span class="comment">// 0xc00001e0c8</span></span><br><span class="line">    fmt.Println(***d) <span class="comment">// 123</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="go的nil"><a href="#go的nil" class="headerlink" title="go的nil"></a>go的nil</h3><p>先看一个现象：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p *<span class="type">int</span>  <span class="comment">// 申明了一个变量p，但是这个变量没有初始值，没有内存，保留了一个占位符，但这个占位符实际上没有在内存中分配</span></span><br><span class="line">*p = <span class="number">10</span>  <span class="comment">// 往没有分配的内存赋了一个10，p没有空间</span></span><br></pre></td></tr></table></figure>
<p>上述代码会报错。这是因为初始的时候没有分配空间。当然这是对于默认值为nil的类型来说的。</p>
<p>像int byte rune float bool string 都有默认值，所以初始化的时候一开始申明就会分配内存；但是像指针，切片，map，接口这些默认值为nil，没有一开始就分配内存。</p>
<h4 id="new函数和make函数"><a href="#new函数和make函数" class="headerlink" title="new函数和make函数"></a>new函数和make函数</h4><p>对于指针这些默认值为nil的类型来说，如何一开始申明的时候就分配内存？</p>
<p>可以使用new函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> p *<span class="type">int</span> = <span class="built_in">new</span>(<span class="type">int</span>)  <span class="comment">// go的编译器就知道先申请一块内存空间，这里的内存值全部为0</span></span><br><span class="line">*p = <span class="number">10</span></span><br></pre></td></tr></table></figure>
<p>当然除了new函数，还可以使用make函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> info <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span><br><span class="line">info[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;cwz&quot;</span></span><br></pre></td></tr></table></figure>
<p><strong>make和new的区别：</strong></p>
<ul>
<li>两者都是内存的分配，但是make只用于slice、map以及channel的初始化（非零值）；而new用于类型的内存分配，不会初始化内存，只会将内存置零。</li>
<li><code>make</code>返回的还是这三个引用类型的实例；而<code>new</code>返回的是指向类型的指针</li>
</ul>
<h4 id="new函数图解"><a href="#new函数图解" class="headerlink" title="new函数图解"></a>new函数图解</h4><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210608102509.png" alt=""></p>
<ul>
<li>p变量仍然是占空间的，使用指针会增加额外空间</li>
<li>go语言遇到new之后会调用操作系统的接口要一块空余的内存空间，操作系统会把内存分配好，并把这块地址返回给go，go把这块内存地址放好</li>
</ul>
<h2 id="go的函数"><a href="#go的函数" class="headerlink" title="go的函数"></a>go的函数</h2><h3 id="函数的定义"><a href="#函数的定义" class="headerlink" title="函数的定义"></a>函数的定义</h3><p>语法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> 函数名<span class="params">(参数1 类型，参数2 类型)</span></span> 返回值 &#123;</span><br><span class="line">    函数体</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>go定义函数的方法有几种：</p>
<ul>
<li>方法1</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>带参数的函数，两个参数类型相同，可以省略</p>
<ul>
<li>方法2</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add2</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>有返回值</p>
<ul>
<li>方法3</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add2</span><span class="params">(a, b <span class="type">int</span>)</span></span> (sum <span class="type">int</span>) &#123;</span><br><span class="line">    sum = a + b</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以给返回值命名，return 可以不用带返回值</p>
<ul>
<li>方法4</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">(a <span class="type">string</span>, b <span class="type">int</span>)</span></span> (<span class="type">string</span>, <span class="type">int</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> a, b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(test(<span class="string">&quot;cwz&quot;</span>, <span class="number">3</span>))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// cwz 3</span></span><br></pre></td></tr></table></figure>
<p>返回多个值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div</span><span class="params">(a, b <span class="type">int</span>)</span></span> (result <span class="type">int</span>, err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        err = errors.New(<span class="string">&quot;被除数不能为0&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        result = a / b</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    result, err := div(<span class="number">12</span>, <span class="number">3</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fmt.Println(result)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="参数的设置"><a href="#参数的设置" class="headerlink" title="参数的设置"></a>参数的设置</h3><h4 id="通过省略号来接收任意长度的参数"><a href="#通过省略号来接收任意长度的参数" class="headerlink" title="通过省略号来接收任意长度的参数"></a>通过省略号来接收任意长度的参数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过省略号去动态设置多个参数值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(params ...<span class="type">int</span>)</span></span> (sum <span class="type">int</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> params &#123;</span><br><span class="line">        sum += v</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    fmt.Println(f1(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>))</span><br><span class="line">    fmt.Println(f1(<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="通过省略号将slice打散"><a href="#通过省略号将slice打散" class="headerlink" title="通过省略号将slice打散"></a>通过省略号将slice打散</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 通过省略号去动态设置多个参数值</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f1</span><span class="params">(params ...<span class="type">int</span>)</span></span> (sum <span class="type">int</span>) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> params &#123;</span><br><span class="line">        sum += v</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    slice := []<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125;</span><br><span class="line">    fmt.Println(f1(slice...))  <span class="comment">// 可以将slice打散成int，传过去</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="创建长度不定的数组"><a href="#创建长度不定的数组" class="headerlink" title="创建长度不定的数组"></a>创建长度不定的数组</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">arr := [...]<span class="type">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>&#125;</span><br><span class="line">fmt.Printf(<span class="string">&quot;%T&quot;</span>, arr)  <span class="comment">// [3]int</span></span><br></pre></td></tr></table></figure>
<h3 id="匿名函数"><a href="#匿名函数" class="headerlink" title="匿名函数"></a>匿名函数</h3><p>go 中我们也可以使用匿名函数，经常用在一些临时的小函数中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    <span class="comment">// 匿名函数直接加括号</span></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="params">()</span></span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;我是匿名函数&quot;</span>)</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    test()</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 我是匿名函数</span></span><br></pre></td></tr></table></figure>
<h3 id="函数类型"><a href="#函数类型" class="headerlink" title="函数类型"></a>函数类型</h3><p>go 里边函数其实也是<strong>一等公民</strong>，函数本身也是一种类型，所以我们可以定义一个函数然后赋值给一个变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    res := <span class="function"><span class="keyword">func</span><span class="params">(a <span class="type">string</span>)</span></span> &#123;fmt.Println(a)&#125;</span><br><span class="line">    res(<span class="string">&quot;hello golang&quot;</span>)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%T&quot;</span>, res)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello golang</span></span><br><span class="line"><span class="comment">// func(string)</span></span><br></pre></td></tr></table></figure>
<p>函数这个类型，它的参数，返回值，都是类型的一部分</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a <span class="function"><span class="keyword">func</span><span class="params">()</span></span></span><br><span class="line"><span class="keyword">var</span> b <span class="function"><span class="keyword">func</span><span class="params">(a,b <span class="type">int</span>)</span></span></span><br><span class="line"><span class="keyword">var</span> c <span class="function"><span class="keyword">func</span><span class="params">(a,b <span class="type">int</span>)</span></span><span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> d <span class="function"><span class="keyword">func</span><span class="params">(a,b <span class="type">int</span>)</span></span>(<span class="type">int</span>,<span class="type">string</span>)</span><br><span class="line"><span class="comment">// 这几个的函数类型是不一样的</span></span><br></pre></td></tr></table></figure>
<p>使用type 给函数类型重命名：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> sub <span class="function"><span class="keyword">func</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">subImpl</span><span class="params">(a, b <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> a - b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> mySub sub = subImpl</span><br><span class="line">    fmt.Println(mySub(<span class="number">3</span>,<span class="number">2</span>))  <span class="comment">// 1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="闭包函数"><a href="#闭包函数" class="headerlink" title="闭包函数"></a>闭包函数</h3><p>闭包函数满足两个条件：</p>
<ul>
<li>定义在函数内部</li>
<li>函数体代码对外部作用域有引用</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">test</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    su:=<span class="string">&quot;golang&quot;</span></span><br><span class="line">    addSu := <span class="function"><span class="keyword">func</span><span class="params">(name <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name + su   <span class="comment">// 这里使用到了 su 这个变量，所以 addSu 就是一个闭包</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(addSu(<span class="string">&quot;hello, &quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    test()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// hello, golang</span></span><br></pre></td></tr></table></figure>
<p>go中没有装饰器语法糖，所以要利用闭包实现装饰器</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="comment">// 测试函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">help</span><span class="params">(name <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;原函数&quot;</span>, name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 装饰器函数</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">decorator</span><span class="params">(a <span class="keyword">func</span>(name <span class="type">string</span>)</span></span>) <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">    res:= <span class="function"><span class="keyword">func</span><span class="params">(name <span class="type">string</span>)</span></span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;装饰器函数&quot;</span>)   <span class="comment">// 装饰器代码</span></span><br><span class="line">        a(name)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    help := decorator(help)</span><br><span class="line">    help(<span class="string">&quot;hello golang&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="go的异常处理"><a href="#go的异常处理" class="headerlink" title="go的异常处理"></a>go的异常处理</h2><h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>在python中使用<code>try / except</code>来进行异常的捕获和处理。还可以通过异常栈来追踪异常的调用信息从而帮助我们修复异常代码。</p>
<p>在go中，错误用内建的<code>error</code>类型来表示，错误值可以存储在变量里，作为函数的返回值。</p>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    f, err := os.Open(<span class="string">&quot;1.txt&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(f.Name(), <span class="string">&quot;成功打开&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 go 的惯例中，一般函数多个返回值的最后一个值用来返回错误，返回 nil 表示没有错误，调用者通过检查返回的错误是否是 nil 就知道是否需要处理错误了。</p>
<h3 id="go的错误error类型"><a href="#go的错误error类型" class="headerlink" title="go的错误error类型"></a>go的错误error类型</h3><p>error 是 go 的一个内置的接口类型，比如你可以使用开发工具跳进去看下 error 的定义：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The error built-in interface type is the conventional interface for</span></span><br><span class="line"><span class="comment">// representing an error condition, with the nil value representing no error.</span></span><br><span class="line"><span class="keyword">type</span> <span class="type">error</span> <span class="keyword">interface</span> &#123;</span><br><span class="line">    Error() <span class="type">string</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>error 的定义很简单，只要我们自己实现了一个类型的 Error() 方法返回一个字符串，就可以当做错误类型了。举一个简单小例子， 比如计算两个整数相除，我们知道除数是不能为 0 的，这个时候我们就可以写个函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;errors&quot;</span> <span class="comment">// 使用内置的 errors</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Divide</span><span class="params">(a, b <span class="type">int</span>)</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>, errors.New(<span class="string">&quot;divide by zero&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// fmt.Println(testDefer())</span></span><br><span class="line">    a, b := <span class="number">1</span>, <span class="number">0</span></span><br><span class="line">    res, err := Divide(a, b)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err) <span class="comment">// error 类型实现了 Error() 方法可以打印出来</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(res)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="defer语句"><a href="#defer语句" class="headerlink" title="defer语句"></a>defer语句</h3><h4 id="defer语句的使用"><a href="#defer语句的使用" class="headerlink" title="defer语句的使用"></a>defer语句的使用</h4><p>go 中提供了一个 defer 语句用来延迟一个函数(匿名函数)或者方法的执行</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">&quot;我最后执行&quot;</span>)      <span class="comment">// 延迟执行</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;来了&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">来了</span></span><br><span class="line"><span class="comment">我最后执行</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><strong>需要注意的是：derfer之后只能是函数调用，不能是表达式</strong></p>
<p>函数里可以使用多个 defer 语句，如果有多个 defer，它们会按照先进后出(Last In First Out)的顺序执行。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">testDefer</span><span class="params">()</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">&quot;defer 1&quot;</span>)</span><br><span class="line">    <span class="keyword">defer</span> fmt.Println(<span class="string">&quot;defer 2&quot;</span>)</span><br><span class="line">    fmt.Println(<span class="string">&quot;函数体&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;test&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(testDefer())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">函数体</span></span><br><span class="line"><span class="comment">defer 2</span></span><br><span class="line"><span class="comment">defer 1</span></span><br><span class="line"><span class="comment">test</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h4 id="defer语句的细节"><a href="#defer语句的细节" class="headerlink" title="defer语句的细节"></a>defer语句的细节</h4><p>defer语句执行时的拷贝机制：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// defer语句执行时的拷贝机制</span></span><br><span class="line">test := <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   fmt.Println(<span class="string">&quot;test1&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> test()</span><br><span class="line">test = <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">   fmt.Println(<span class="string">&quot;test2&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;test3&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">test3</span></span><br><span class="line"><span class="comment">test1</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>值传递：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="number">10</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(a <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(a)</span><br><span class="line">&#125;(x)</span><br><span class="line">x++</span><br><span class="line"><span class="comment">// 10</span></span><br></pre></td></tr></table></figure>
<p>这个defer把函数的逻辑和变量值都压入栈中，函数和值都有了，就与外面的x++无关了。</p>
<p>引用传递：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="number">10</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">(a *<span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    fmt.Println(*a)</span><br><span class="line">&#125;(&amp;x)</span><br><span class="line">x++</span><br><span class="line"><span class="comment">// 11</span></span><br></pre></td></tr></table></figure>
<p>压栈的时候压的是函数的代码和函数里的参数值，这里参数值是一个指针，指向x的值，外部改了值之后，函数里是顺着指针指向那块内存取值的。x已经变成11了，所以打印的也是11。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">x := <span class="number">10</span></span><br><span class="line"><span class="comment">// 此处的defer函数并没有参数，函数内部使用的值是全局的值</span></span><br><span class="line"><span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(x)</span><br><span class="line">&#125;()</span><br><span class="line">x++</span><br><span class="line"><span class="comment">// 11</span></span><br></pre></td></tr></table></figure>
<p>这里压栈是把函数压入是没有参数的，函数里的逻辑是指向x的，x是外部的x，指向的是x的变量并不是x的值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle</span><span class="params">()</span></span> <span class="type">int</span> &#123;</span><br><span class="line">    x := <span class="number">10</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        x++</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> x</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">handle2</span><span class="params">()</span></span> *<span class="type">int</span> &#123;</span><br><span class="line">    a := <span class="number">10</span></span><br><span class="line">    b := &amp;a</span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        *b++</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">return</span> b</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(handle())  <span class="comment">// 10</span></span><br><span class="line">    fmt.Println(*handle2()) <span class="comment">// 11</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 return 之前会临时保存 x 的值</p>
<p>总结：</p>
<ul>
<li>defer本质是是注册了一个延迟函数，defer函数的执行顺序已经确定</li>
<li>defer没有嵌套</li>
<li>如果函数的返回值是无名的（不带命名返回值），则go语言会在执行return的时候会执行一个类似创建一个临时变量作为保存return值的动作</li>
<li>而有名返回值的函数，由于返回值在函数定义的时候已经将该变量进行定义，在执行return的时候会先执行返回值保存操作，而后续的defer函数会改变这个返回值（虽然defer是在return之后执行的，但是由于使用的函数定义的变量，所以执行defer操作后对该变量的修改会影响到return）</li>
</ul>
<h3 id="go的异常处理-1"><a href="#go的异常处理-1" class="headerlink" title="go的异常处理"></a>go的异常处理</h3><p>go 的异常处理机制 panic(恐慌)/recover(恢复)，一般我们使用的是错误处理(error)而不是 panic。因为只有非常严重的场景 下才会发生 panic 导致代码退出</p>
<p>平常我们使用的 web 框架，一般即使出错了，我们也希望整个进程继续执行，而不是直接退出无法处理用户请求。 比如 python 的 web 框架，如果遇到了业务代码没有捕获的异常，框架会给我们捕获然后返回给客户端 500 的状态码表示代码有错。</p>
<p>go 里区分对待异常(panic)和错误(error)的，绝大部分场景下我们使用的都是错误，只有少数场景下发生了严重错误我们想让整个进程都退出了才会使用异常。</p>
<p>比如除法函数的例子，如果我们碰到了个除数为 0 被认为是严重错误，也可以使用 panic 抛出异常：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div</span><span class="params">(a, b <span class="type">int</span>)</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;被除数为0&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果我们传入除数0，但是又不想让进程退出呢？go 还提供了一个 recover 函数用来从异常中恢复，比如使用 recover 可以把一个 panic 包装成为 error 再返回，而不是让进程退出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">div</span><span class="params">(a, b <span class="type">int</span>)</span></span> (<span class="type">int</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> b == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;被除数为0&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> a / b, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    a := <span class="number">10</span></span><br><span class="line">    b := <span class="number">0</span></span><br><span class="line">    <span class="keyword">defer</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        err := <span class="built_in">recover</span>()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;异常被捕获到：%v\n&quot;</span>, err)</span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(<span class="string">&quot;正常执行&quot;</span>)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    fmt.Println(div(a, b))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">异常被捕获到：被除数为0</span></span><br><span class="line"><span class="comment">正常执行</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p><strong>使用panic的坑：</strong></p>
<ul>
<li><strong>panic会引起主线程的挂掉，同时会导致其他协程都挂掉</strong></li>
<li><strong>在父协程中无法捕获子协程中出现的异常</strong></li>
</ul>
<h2 id="go语言中的结构体"><a href="#go语言中的结构体" class="headerlink" title="go语言中的结构体"></a>go语言中的结构体</h2><h3 id="type的几种使用常见"><a href="#type的几种使用常见" class="headerlink" title="type的几种使用常见"></a>type的几种使用常见</h3><ul>
<li>给一个类型定义别名</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> myByte = <span class="type">byte</span></span><br><span class="line"><span class="keyword">var</span> b myByte</span><br><span class="line">fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, b)  <span class="comment">// uint8</span></span><br></pre></td></tr></table></figure>
<ul>
<li>基于一个已有的类型定义一个新的类型</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> myInt <span class="type">int</span></span><br><span class="line"><span class="keyword">var</span> i myInt</span><br><span class="line">fmt.Printf(<span class="string">&quot;%T\n&quot;</span>, i)  <span class="comment">// main.myInt</span></span><br></pre></td></tr></table></figure>
<ul>
<li>定义结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Course <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义接口</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Callable <span class="keyword">interface</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>定义函数别名</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> handle <span class="function"><span class="keyword">func</span><span class="params">(str <span class="type">string</span>)</span></span></span><br></pre></td></tr></table></figure>
<h3 id="结构体的定义"><a href="#结构体的定义" class="headerlink" title="结构体的定义"></a>结构体的定义</h3><p>go语言不支持传统的面向对象，go没有类class这个概念，但是go的结构体也可以实现面向对象的特性。</p>
<p>结构体只能定义数据，把数据聚合起来。</p>
<p>结构体的格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> 结构体名字 <span class="keyword">struct</span> &#123;</span><br><span class="line">    属性 类型</span><br><span class="line">    属性 类型</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    p := Person&#123;<span class="string">&quot;张三&quot;</span>, <span class="number">30</span>&#125;</span><br><span class="line">    fmt.Println(p, p.name, p.age)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#123;张三 30&#125; 张三 30</span></span><br></pre></td></tr></table></figure>
<p>这里面有一些细节，值得注意：</p>
<ul>
<li>在其他语言中，比如java是通过关键字public、private等来限制成员变量的访问权限的。在go语言中，它是通过结构体内部变量的大小写来决定访问权限的，首字母大写是公开变量，首字母小写是内部变量(只有同属于一个包下的代码才能直接访问)</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 大小写表示公有和私有</span></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 实例化 kv形式</span></span><br><span class="line">    <span class="keyword">var</span> p Person = Person&#123;</span><br><span class="line">        Name: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">        Age: <span class="number">30</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(p.Name, p.Age)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 张三 30</span></span><br></pre></td></tr></table></figure>
<h3 id="结构体的实例化"><a href="#结构体的实例化" class="headerlink" title="结构体的实例化"></a>结构体的实例化</h3><ul>
<li>kv形式 实例化结构体</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> p Person = Person&#123;</span><br><span class="line">    Name: <span class="string">&quot;张三&quot;</span>,</span><br><span class="line">    Age: <span class="number">30</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>顺序形式</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">p := Person&#123;<span class="string">&quot;张三&quot;</span>, <span class="number">30</span>&#125;</span><br></pre></td></tr></table></figure>
<p>一个指针指向结构体，通过结构体指针获取对象的值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;unsafe&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Course <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Price <span class="type">int</span></span><br><span class="line">    Url <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c3 := &amp;Course&#123;<span class="string">&quot;gin&quot;</span>, <span class="number">100</span>, <span class="string">&quot;https://www.baidu.com&quot;</span>&#125;</span><br><span class="line">    fmt.Println((*c3).Name)</span><br><span class="line">    fmt.Println(c3.Name)</span><br><span class="line">    <span class="comment">// 这里其实是go语言的语法糖  go语言内部会将 c3.Name转换成 (*c3).Name</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="结构体的零值"><a href="#结构体的零值" class="headerlink" title="结构体的零值"></a>结构体的零值</h3><p>结构体是值类型，零值是属性的零值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> p Person</span><br><span class="line">    fmt.Println(p) <span class="comment">// &#123; 0&#125;</span></span><br><span class="line">    p.name = <span class="string">&quot;cwz&quot;</span>  <span class="comment">// 赋值</span></span><br><span class="line">    p.age = <span class="number">23</span></span><br><span class="line">    fmt.Println(p, p.name, p.age) <span class="comment">// &#123;cwz 23&#125; cwz 23</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>多种方式零值初始化：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c5 Course = Course&#123;&#125;</span><br><span class="line"><span class="keyword">var</span> c6 Course</span><br><span class="line"><span class="keyword">var</span> c7 *Course = <span class="built_in">new</span>(Course)</span><br><span class="line">fmt.Println(c5.Price)</span><br><span class="line">fmt.Println(c6.Price)</span><br><span class="line">fmt.Println(c7.Price)</span><br></pre></td></tr></table></figure>
<h3 id="go语言中结构体无处不在"><a href="#go语言中结构体无处不在" class="headerlink" title="go语言中结构体无处不在"></a>go语言中结构体无处不在</h3><p>先来看一下这个现象：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">fmt.Println(unsafe.Sizeof(<span class="string">&quot;&quot;</span>))  <span class="comment">// 16</span></span><br><span class="line">fmt.Println(unsafe.Sizeof(<span class="string">&quot;asddddddddddddddddd&quot;</span>))  <span class="comment">// 16</span></span><br></pre></td></tr></table></figure>
<p>空字符串和有值的字符串占用空间是一样的。</p>
<p>通过观察 Go 语言的底层源码，可以发现所有的 Go 语言内置的高级数据结构都是由结构体来完成的。</p>
<h4 id="字符串头的结构体"><a href="#字符串头的结构体" class="headerlink" title="字符串头的结构体"></a>字符串头的结构体</h4><p>在 64 位机器上将会占用 16 个字节</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="type">string</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">    Data <span class="type">uintptr</span>  <span class="comment">// 指针占8个长度</span></span><br><span class="line">    Len <span class="type">int</span>     <span class="comment">// 64位系统  占8个长度</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="slice的结构体"><a href="#slice的结构体" class="headerlink" title="slice的结构体"></a>slice的结构体</h4><p>在 64 位机器上将会占用 24 个字节</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">    array unsafe.Pointer  <span class="comment">// 底层数组地址</span></span><br><span class="line">    <span class="built_in">len</span> <span class="type">int</span> <span class="comment">// 长度</span></span><br><span class="line">    <span class="built_in">cap</span> <span class="type">int</span>  <span class="comment">// 容量</span></span><br><span class="line">&#125;</span><br><span class="line">s1 := []<span class="type">string</span>&#123;<span class="string">&quot;django&quot;</span>, <span class="string">&quot;flask&quot;</span>, <span class="string">&quot;sanic&quot;</span>, <span class="string">&quot;fastapi&quot;</span>&#125;</span><br><span class="line">fmt.Println(<span class="string">&quot;切片占用的内存：&quot;</span>, unsafe.Sizeof(s1))  <span class="comment">// 切片占用的内存： 24</span></span><br></pre></td></tr></table></figure>
<h4 id="map的结构体"><a href="#map的结构体" class="headerlink" title="map的结构体"></a>map的结构体</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> hmap <span class="keyword">struct</span> &#123;</span><br><span class="line">  count <span class="type">int</span></span><br><span class="line">  ...</span><br><span class="line">  buckets unsafe.Pointer  <span class="comment">// hash桶地址</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">m1 := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> &#123;</span><br><span class="line">    <span class="string">&quot;k1&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;k2&quot;</span>: <span class="string">&quot;v2&quot;</span>,</span><br><span class="line">    <span class="string">&quot;k3&quot;</span>: <span class="string">&quot;v3&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(unsafe.Sizeof(m1))  <span class="comment">// 8</span></span><br></pre></td></tr></table></figure>
<p>数组只有「体」，切片除了「体」之外，还有「头」部。切片的头部和内容体是分离的，使用指针关联起来。看一下以下代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;unsafe&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ArrayStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">    value [<span class="number">10</span>]<span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SliceStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">    value []<span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> as = ArrayStruct&#123;[...]<span class="type">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;&#125;</span><br><span class="line">    <span class="keyword">var</span> ss = SliceStruct&#123;[]<span class="type">int</span>&#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>&#125;&#125;</span><br><span class="line">    fmt.Println(unsafe.Sizeof(as), unsafe.Sizeof(ss))</span><br><span class="line">    <span class="comment">// 80 24</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="结构体绑定方法"><a href="#结构体绑定方法" class="headerlink" title="结构体绑定方法"></a>结构体绑定方法</h3><p>基本语法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(t Type)</span></span> methodName(parameter list) &#123;&#125;</span><br></pre></td></tr></table></figure>
<h4 id="定义方法"><a href="#定义方法" class="headerlink" title="定义方法"></a>定义方法</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 给结构体绑定方法</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span></span> printName() &#123;</span><br><span class="line">    fmt.Println(p.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    p := Person&#123;</span><br><span class="line">        name: <span class="string">&quot;reese&quot;</span>,</span><br><span class="line">        age:  <span class="number">34</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    p.printName()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Go不是一个纯粹的面向对象编程语言，而且Go也不支持类。因此，基于类型的方法是一种实现和类 相似行为的途径。</p>
<h4 id="结构体的两种接收形式"><a href="#结构体的两种接收形式" class="headerlink" title="结构体的两种接收形式"></a>结构体的两种接收形式</h4><p><strong>值接收</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 结构体的方法只能和结构体在同一个包中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name    <span class="type">string</span></span><br><span class="line">    Age     <span class="type">int</span></span><br><span class="line">    Address <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span></span> printPersonInfo() &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;姓名：%s, 年龄：%d, 地址：%s&quot;</span>, p.Name, p.Age, p.Address)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span></span> setAge(age <span class="type">int</span>)  &#123;</span><br><span class="line">    p.Age = age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    p1 := Person&#123;<span class="string">&quot;cwz&quot;</span>, <span class="number">19</span>, <span class="string">&quot;上海&quot;</span>&#125;</span><br><span class="line">    Person.printPersonInfo(p)</span><br><span class="line">    Person.setAge(p, <span class="number">20</span>)  <span class="comment">// 参数是结构体，结构体是值传递，无法改</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>函数的参数传递都是值进行传递，也就是会拷贝参数的值，我们想要修改传入的值，就需要传递一个指针。</p>
<p><strong>指针接收</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 结构体的方法只能和结构体在同一个包中</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name    <span class="type">string</span></span><br><span class="line">    Age     <span class="type">int</span></span><br><span class="line">    Address <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span></span> printPersonInfo() &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;姓名：%s, 年龄：%d, 地址：%s&quot;</span>, p.Name, p.Age, p.Address)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 指针类型接收器修改年龄</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Person)</span></span> setAge(age <span class="type">int</span>)  &#123;</span><br><span class="line">    p.Age = age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    p1 := Person&#123;<span class="string">&quot;cwz&quot;</span>, <span class="number">19</span>, <span class="string">&quot;上海&quot;</span>&#125;</span><br><span class="line">    <span class="comment">//p1.setAge(20)</span></span><br><span class="line">    (&amp;p1).setAge(<span class="number">20</span>) <span class="comment">// p1.setAge(20)和(&amp;p1).setAge(20)是一样的</span></span><br><span class="line">    fmt.Println(p1.Age)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>不管是值类型接收器还是指针类型接收器，都可以用值和指针来调用</li>
<li>指针接收器使用场景：<ul>
<li>结构体数据比较大，拷贝一个结构体的代价过大</li>
</ul>
</li>
</ul>
<h3 id="内嵌结构体实现继承类似的效果"><a href="#内嵌结构体实现继承类似的效果" class="headerlink" title="内嵌结构体实现继承类似的效果"></a>内嵌结构体实现继承类似的效果</h3><h4 id="内嵌结构体"><a href="#内嵌结构体" class="headerlink" title="内嵌结构体"></a>内嵌结构体</h4><p>结构体作为一种变量它可以放进另外一个结构体作为一个字段来使用，这种内嵌结构体的形式在 Go 语言里称之为「组合」。下面我们来看看内嵌结构体的基本使用方法</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name  <span class="type">string</span></span><br><span class="line">    Age   <span class="type">int</span></span><br><span class="line">    Hobby Hobby <span class="comment">// person多一个爱好的信息，将另一个结构体的变量放进来</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Hobby <span class="keyword">struct</span> &#123;</span><br><span class="line">    Id   <span class="type">int</span></span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Person)</span></span> personInfo() &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;姓名：%s, 年龄：%d, 爱好：%s&quot;</span>, p.Name, p.Age, p.Hobby.Name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    p1 := Person&#123;</span><br><span class="line">        Name: <span class="string">&quot;reese&quot;</span>,</span><br><span class="line">        Age: <span class="number">18</span>,</span><br><span class="line">        Hobby: Hobby&#123;</span><br><span class="line">            Id: <span class="number">1</span>,</span><br><span class="line">            Name: <span class="string">&quot;跑步&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    p1.personInfo()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 姓名：reese, 年龄：18, 爱好：跑步</span></span><br></pre></td></tr></table></figure>
<h4 id="匿名内嵌结构体"><a href="#匿名内嵌结构体" class="headerlink" title="匿名内嵌结构体"></a>匿名内嵌结构体</h4><p>还有一种特殊的内嵌结构体形式，内嵌的结构体不提供名称。</p>
<p>这时外面的结构体将直接继承内嵌结构体所有的内部字段和方法，就好像把子结构体的一切全部都揉进了父结构体一样。</p>
<p>匿名的结构体字段将会自动获得以结构体类型的名字命名的字段名称</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Address <span class="keyword">struct</span> &#123;</span><br><span class="line">    city, state <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> People <span class="keyword">struct</span> &#123;</span><br><span class="line">    name    <span class="type">string</span></span><br><span class="line">    age     <span class="type">int</span></span><br><span class="line">    Address <span class="comment">// 匿名字段</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> p People = People&#123;</span><br><span class="line">        name: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">        age:  <span class="number">19</span>,</span><br><span class="line">        Address: Address&#123; <span class="comment">// 因为Address是匿名结构体,所以需要这样声明</span></span><br><span class="line">            <span class="string">&quot;Shanghai&quot;</span>, <span class="string">&quot;Jingan&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(p)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#123;cwz 19 &#123;Shanghai Jingan&#125;&#125;</span></span><br></pre></td></tr></table></figure>
<p>如果嵌入结构的字段和外部结构的字段相同，那么想要修改嵌入结构的字段值需要加上外部结构中声明的嵌入结构名称</p>
<h3 id="结构体的标签"><a href="#结构体的标签" class="headerlink" title="结构体的标签"></a>结构体的标签</h3><p>结构体的字段除了名字和类型外，还可以有一个可选的标签（tag）。</p>
<ul>
<li>它是一个附属于字段的字符串，可以是文档或其他的重要标记</li>
<li>比如在解析json或生成json文件时，常用到encoding/json包，它提供一些默认标签。</li>
<li>例如：<code>omitempty</code>标签可以在序列化的时候忽略0值或者空值</li>
<li>而<code>-</code>标签的作用是不进行序列化，其效果和和直接将结构体中的字段写成小写的效果一样</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Info <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age <span class="type">int</span> <span class="string">`json:&quot;age,omitempty&quot;`</span></span><br><span class="line">    Gender <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    info := Info&#123;</span><br><span class="line">        Name: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">        Gender: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    re, _ := json.Marshal(info)</span><br><span class="line">    fmt.Println(<span class="type">string</span>(re))</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// &#123;&quot;Name&quot;:&quot;cwz&quot;,&quot;Gender&quot;:&quot;男&quot;&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>自定义标签，对字段进行处理</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Info <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name   <span class="type">string</span> <span class="string">`orm:&quot;name, max_length=10, min_length=3&quot;`</span></span><br><span class="line">    Age    <span class="type">int</span>    <span class="string">`orm:&quot;age, min=18, max=80&quot;`</span></span><br><span class="line">    Gender <span class="type">string</span> <span class="string">`orm:&quot;gender, required&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    info := Info&#123;</span><br><span class="line">        Name:   <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">        Gender: <span class="string">&quot;男&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    re, _ := json.Marshal(info)</span><br><span class="line">    fmt.Println(<span class="type">string</span>(re))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过反射包去识别这些tag</span></span><br><span class="line"></span><br><span class="line">    t := reflect.TypeOf(info)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t.NumField(); i++ &#123;</span><br><span class="line">        field := t.Field(i) <span class="comment">// 获取结构体的每一个字段</span></span><br><span class="line">        tag := field.Tag.Get(<span class="string">&quot;orm&quot;</span>)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%d. %v (%v), tag: &#x27;%v&#x27;\n&quot;</span>, i+<span class="number">1</span>, field.Name, field.Type.Name(), tag)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">1. Name (string), tag: &#x27;name, max_length=10, min_length=3&#x27;</span></span><br><span class="line"><span class="comment">2. Age (int), tag: &#x27;age, min=18, max=80&#x27;</span></span><br><span class="line"><span class="comment">3. Gender (string), tag: &#x27;gender, required&#x27;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="go语言的接口"><a href="#go语言的接口" class="headerlink" title="go语言的接口"></a>go语言的接口</h2><p>go语言的接口(protol 协议) 设计参考了鸭子类型 和 java的接口来设计的</p>
<h3 id="鸭子类型"><a href="#鸭子类型" class="headerlink" title="鸭子类型"></a>鸭子类型</h3><p>鸭子类型在python中是很常见的，python本身是同时支持鸭子类型和面向对象的。而且python本身就是基于鸭子类型设计的一门语言。</p>
<p>看一个经典的鸭子类型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">walk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Dog</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">walk</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">speak</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Cat</span>(<span class="title class_ inherited__">Animal</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">dog = Dog()</span><br></pre></td></tr></table></figure>
<p>python语言本身的设计是基于鸭子类型来实现的，所以  Dog到底是不是Animal，不是由这个继承关系来确定的，而是这个类是否实现了和Animal一样的方法。</p>
<p>Animal实际上只是定义了一些方法的名称而已，其他的任何类只要实现了这个Animal里面的方法，那这个类就是Animal类型。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Company</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, employee_list</span>):</span><br><span class="line">        self.employee = employee_list</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__iter__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">iter</span>(self.employee)</span><br><span class="line"></span><br><span class="line">company = Company([<span class="string">&quot;tom&quot;</span>, <span class="string">&quot;bob&quot;</span>, <span class="string">&quot;jane&quot;</span>])</span><br><span class="line"><span class="keyword">if</span> <span class="built_in">isinstance</span>(company, Iterable):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;company是iterable类型&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>Company没有继承Iterable，但是都实现了<code>__iter__</code>方法，所以就说company是iterable类型。</p>
<p>它的类型不是由它继承关系确定的，是由实现了指定名称的方法</p>
<h3 id="go的接口是一种抽象类型"><a href="#go的接口是一种抽象类型" class="headerlink" title="go的接口是一种抽象类型"></a>go的接口是一种抽象类型</h3><p>接口是一个协议，比如我要定义一个程序员接口：会写代码、能解决bug，这就认为是程序员了，其他的属性一律不管：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口是一个协议</span></span><br><span class="line"><span class="keyword">type</span> Programmer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Coding() <span class="type">string</span> <span class="comment">// 方法只是申明</span></span><br><span class="line">    Debug() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pythoner <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Coding() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;python开发者&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;python开发者&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Debug() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;我会python的debug&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;我会python的debug&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 接口帮我们完成了go语言的多态</span></span><br><span class="line">    <span class="keyword">var</span> pro Programmer = Pythoner&#123;&#125;</span><br><span class="line">    pro.Coding()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先声明了一个接口类型的值，只要实现了这个接口的 struct 变量，都可以赋值给它， 而调用方法的时候，go 会根据实际类型选择使用哪个 struct 的方法。</p>
<p>go的接口是一种抽象类型，只是申明方法，struct是具象的。 使用的时候将具象的赋值给抽象的。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Test <span class="keyword">interface</span> &#123;</span><br><span class="line">    Tester()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MyFloat <span class="type">float64</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m MyFloat)</span></span> Tester() &#123;</span><br><span class="line">    fmt.Println(m)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">describe</span><span class="params">(t Test)</span></span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;接口类型 %T value %v\n&quot;</span>, t, t)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> t Test</span><br><span class="line">    f := MyFloat(<span class="number">23.4</span>)</span><br><span class="line">    t = f</span><br><span class="line">    describe(t)</span><br><span class="line">    t.Tester()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">输出结果：</span></span><br><span class="line"><span class="comment">接口类型 main.MyFloat value 23.4</span></span><br><span class="line"><span class="comment">23.4</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>Test 接口只有一个方法Tester()，而MyFloat 类型实现了该接口。main函数中，变量f（MyFloat类型）赋值给了t（Test类型）。现在t的具体类型为MyFloat，而t的值为23.4。describe函数打印出了接口的具体类型和值。</p>
<h3 id="接口支持组合"><a href="#接口支持组合" class="headerlink" title="接口支持组合"></a>接口支持组合</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Programmer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Coding() <span class="type">string</span></span><br><span class="line">    Debug() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Designer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Design() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pythoner <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Coding() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;python开发者&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;python开发者&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Debug() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;我会python的debug&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;我会python的debug&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Manage() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;不好意思，管理我也懂&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;不好意思，管理我也懂&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Design() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;我是一个python开发者，我也会ui设计&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;我是一个python开发者，我也会ui设计&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Manager <span class="keyword">interface</span> &#123;</span><br><span class="line">    Programmer</span><br><span class="line">    Designer</span><br><span class="line">    Manage() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 接口组合</span></span><br><span class="line">    <span class="keyword">var</span> m Manager = Pythoner&#123;&#125;</span><br><span class="line">    m.Debug()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码定义了 Manager接口，包含了Programmer、Designer接口，以及自己的Manage方法。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Programmer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Coding() <span class="type">string</span></span><br><span class="line">    Debug() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Designer <span class="keyword">interface</span> &#123;</span><br><span class="line">    Design() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Pythoner <span class="keyword">struct</span> &#123;</span><br><span class="line">    UIDesigner</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> UIDesigner <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(d UIDesigner)</span></span> Design() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;我会ui设计&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;我会ui设计&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Coding() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;python开发者&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;python开发者&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Debug() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;我会python的debug&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;我会python的debug&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p Pythoner)</span></span> Manage() <span class="type">string</span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;不好意思，管理我也懂&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;不好意思，管理我也懂&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Manager <span class="keyword">interface</span> &#123;</span><br><span class="line">    Programmer</span><br><span class="line">    Designer</span><br><span class="line">    Manage() <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> m Manager = Pythoner&#123;&#125;</span><br><span class="line">    m.Design()</span><br><span class="line">    <span class="comment">// struct组合完成了接口</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>结构体组合实现了所有接口方法</p>
<h3 id="空接口"><a href="#空接口" class="headerlink" title="空接口"></a>空接口</h3><p>没有包含方法的接口称为空接口。控接口表示为 <code>interface&#123;&#125;</code>。由于空接口没有方法，所以 所有类型都实现了空接口。</p>
<p>应用场景如下：</p>
<ul>
<li>可以把任何类型都赋值给空接口变量</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    name <span class="type">string</span></span><br><span class="line">    age <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line">i = Person&#123;&#125;</span><br><span class="line">i = <span class="number">10</span></span><br><span class="line">i = <span class="string">&quot;cwz&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>参数传递</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printAnything</span><span class="params">(i <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v\n&quot;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> i <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2、参数传递，写出了动态函数的感觉</span></span><br><span class="line">    i = <span class="number">10</span></span><br><span class="line">    printAnything(i)</span><br><span class="line">    i = <span class="string">&quot;cwz&quot;</span></span><br><span class="line">    printAnything(i)</span><br><span class="line">    i = []<span class="type">string</span>&#123;<span class="string">&quot;aa&quot;</span>, <span class="string">&quot;bb&quot;</span>&#125;</span><br><span class="line">    printAnything(i)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">10</span></span><br><span class="line"><span class="comment">cwz</span></span><br><span class="line"><span class="comment">[aa bb]</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>空接口可以作为map的值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3、空接口可以作为map的值，本来map的key的类型和value的类型都是要各自相同的</span></span><br><span class="line">    <span class="keyword">var</span> personInfo = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">string</span>]<span class="keyword">interface</span>&#123;&#125;)</span><br><span class="line">    personInfo[<span class="string">&quot;name&quot;</span>] = <span class="string">&quot;cwz&quot;</span></span><br><span class="line">    personInfo[<span class="string">&quot;age&quot;</span>] = <span class="number">19</span></span><br><span class="line">    personInfo[<span class="string">&quot;hobby&quot;</span>] = [<span class="number">3</span>]<span class="type">string</span>&#123;<span class="string">&quot;跑步&quot;</span>, <span class="string">&quot;游泳&quot;</span>&#125;</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%v&quot;</span>, personInfo)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// map[age:19 hobby:[跑步 游泳 ] name:cwz]</span></span><br></pre></td></tr></table></figure>
<h3 id="接口的类型断言"><a href="#接口的类型断言" class="headerlink" title="接口的类型断言"></a>接口的类型断言</h3><p>类型断言的语法格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">instance, ok := interfaceVal.(RealType) </span><br><span class="line"><span class="comment">// 如果 ok 为 true 的话，接口值就转成了我们需要的类型</span></span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printA</span><span class="params">(i <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> s, ok := i.(<span class="type">string</span>); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%s(字符串)\n&quot;</span>, s)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> a, ok := i.(<span class="type">int</span>); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%d(整数)\n&quot;</span>, a)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    x := <span class="number">10</span></span><br><span class="line">    printA(x)</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 10(整数)</span></span><br></pre></td></tr></table></figure>
<p>判断传的值是什么类型的</p>
<p>使用if判断写起来代码比较不工整，可以使用switch：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">doSomething</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> v := x.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="type">string</span>:</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%s(字符串)\n&quot;</span>, v)</span><br><span class="line">    <span class="keyword">case</span> <span class="type">int</span>:</span><br><span class="line">        fmt.Printf(<span class="string">&quot;%d(整数)\n&quot;</span>, v)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    x := <span class="number">10</span></span><br><span class="line">    doSomething(x)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>举一个应用场景：一个存储的接口，可能会使用很多的方式存储，比如本地存储，后期可能迁移到阿里云存储</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AliOss <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LocalFile <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">store</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> v := x.(<span class="keyword">type</span>) &#123;</span><br><span class="line">    <span class="keyword">case</span> AliOss:</span><br><span class="line">    <span class="comment">// 此处要做一些特殊的处理</span></span><br><span class="line">    <span class="keyword">case</span> LocalFile:</span><br><span class="line">        <span class="comment">// 本地存储</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="实现sort排序"><a href="#实现sort排序" class="headerlink" title="实现sort排序"></a>实现sort排序</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sort&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name <span class="type">string</span></span><br><span class="line">    Age  <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> PersonA []Person</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p PersonA)</span></span> Len() <span class="type">int</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">len</span>(p)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p PersonA)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> p[i].Age &lt; p[j].Age</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p PersonA)</span></span> Swap(i, j <span class="type">int</span>) &#123;</span><br><span class="line">    p[i], p[j] = p[j], p[i]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    pp := PersonA&#123;</span><br><span class="line">        Person&#123;<span class="string">&quot;cwz&quot;</span>, <span class="number">42</span>&#125;,</span><br><span class="line">        Person&#123;<span class="string">&quot;reese&quot;</span>, <span class="number">37</span>&#125;,</span><br><span class="line">        Person&#123;<span class="string">&quot;neo&quot;</span>, <span class="number">29</span>&#125;,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 通过sort来排序</span></span><br><span class="line">    sort.Sort(pp)</span><br><span class="line">    <span class="keyword">for</span> _, v := <span class="keyword">range</span> pp &#123;</span><br><span class="line">        fmt.Println(v)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">&#123;neo 29&#125;</span></span><br><span class="line"><span class="comment">&#123;reese 37&#125;</span></span><br><span class="line"><span class="comment">&#123;cwz 42&#125;</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="go语言的反射"><a href="#go语言的反射" class="headerlink" title="go语言的反射"></a>go语言的反射</h2><h3 id="反射介绍"><a href="#反射介绍" class="headerlink" title="反射介绍"></a>反射介绍</h3><p>反射是指在程序运行期对程序本身进行访问和修改的能力。程序在编译时，变量被转换为内存地址，变量名不会被编译器写入到可执行部分。在运行程序时，程序无法获取自身的信息。</p>
<p>支持反射的语言可以在程序编译期将变量的反射信息，如字段名称、类型信息、结构体信息等整合到可执行文件中，并给程序提供接口访问反射信息，这样就可以在程序运行期获取类型的反射信息，并且有能力修改它们。</p>
<p>Go程序在运行期使用reflect包访问程序的反射信息。</p>
<h3 id="reflect包"><a href="#reflect包" class="headerlink" title="reflect包"></a>reflect包</h3><p>在Go语言的反射机制中，任何接口值都由是<strong>一个具体类型</strong>和<strong>具体类型的值</strong>两部分组成的。</p>
<p>在Go语言中反射的相关功能由内置的reflect包提供，任意接口值在反射中都可以理解为由<code>reflect.Type</code>和<code>reflect.Value</code>两部分组成，并且reflect包提供了<code>reflect.TypeOf</code>和<code>reflect.ValueOf</code>两个函数来获取任意对象的Value和Type。</p>
<ul>
<li>reflect.TypeOf(i) ：获得接口值的类型</li>
<li>reflect.ValueOf(i)：获得接口值的值</li>
</ul>
<h4 id="Typeof"><a href="#Typeof" class="headerlink" title="Typeof"></a>Typeof</h4><p>在Go语言中，使用<code>reflect.TypeOf()</code>函数可以获得任意值的类型对象（reflect.Type），程序通过类型对象可以访问任意值的类型信息。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflectType</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    typeOf := reflect.TypeOf(x)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;type:%v\n&quot;</span>, typeOf)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> a <span class="type">int32</span> = <span class="number">20</span></span><br><span class="line">    reflectType(a)  <span class="comment">// type:int32</span></span><br><span class="line">    <span class="keyword">var</span> b <span class="type">float64</span> = <span class="number">3.1415</span></span><br><span class="line">    reflectType(b)  <span class="comment">// type:float64</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="获取类别Kind"><a href="#获取类别Kind" class="headerlink" title="获取类别Kind()"></a>获取类别Kind()</h5><p>在反射中关于类型还划分为两种：</p>
<ul>
<li>类型Type</li>
<li>种类Kind</li>
</ul>
<p>我们可以使用type关键字构造很多自定义类型，Kind种类就是指底层的类型。</p>
<p>但在反射中，当需要区分指针、结构体等类型时，就会用到<strong>种类（Kind）</strong></p>
<p>翻看Kind的源码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Kind <span class="type">uint</span></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    Invalid Kind = <span class="literal">iota</span>  <span class="comment">// 非法类型</span></span><br><span class="line">    Bool                 <span class="comment">// 布尔型</span></span><br><span class="line">    Int                  <span class="comment">// 有符号整型</span></span><br><span class="line">    Int8                 <span class="comment">// 有符号8位整型</span></span><br><span class="line">    Int16                <span class="comment">// 有符号16位整型</span></span><br><span class="line">    Int32                <span class="comment">// 有符号32位整型</span></span><br><span class="line">    Int64                <span class="comment">// 有符号64位整型</span></span><br><span class="line">    Uint                 <span class="comment">// 无符号整型</span></span><br><span class="line">    Uint8                <span class="comment">// 无符号8位整型</span></span><br><span class="line">    Uint16               <span class="comment">// 无符号16位整型</span></span><br><span class="line">    Uint32               <span class="comment">// 无符号32位整型</span></span><br><span class="line">    Uint64               <span class="comment">// 无符号64位整型</span></span><br><span class="line">    Uintptr              <span class="comment">// 指针</span></span><br><span class="line">    Float32              <span class="comment">// 单精度浮点数</span></span><br><span class="line">    Float64              <span class="comment">// 双精度浮点数</span></span><br><span class="line">    Complex64            <span class="comment">// 64位复数类型</span></span><br><span class="line">    Complex128           <span class="comment">// 128位复数类型</span></span><br><span class="line">    Array                <span class="comment">// 数组</span></span><br><span class="line">    Chan                 <span class="comment">// 通道</span></span><br><span class="line">    Func                 <span class="comment">// 函数</span></span><br><span class="line">    Interface            <span class="comment">// 接口</span></span><br><span class="line">    Map                  <span class="comment">// 映射</span></span><br><span class="line">    Ptr                  <span class="comment">// 指针</span></span><br><span class="line">    Slice                <span class="comment">// 切片</span></span><br><span class="line">    String               <span class="comment">// 字符串</span></span><br><span class="line">    Struct               <span class="comment">// 结构体</span></span><br><span class="line">    UnsafePointer        <span class="comment">// 底层指针</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>举例说明，定义指针和结构体类型，通过反射查看它们的类型和种类：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> myInt <span class="type">int64</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflectType</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    t := reflect.TypeOf(x)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;type:%v, kind:%v\n&quot;</span>, t.Name(), t.Kind())</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a *<span class="type">float32</span> <span class="comment">// 指针</span></span><br><span class="line">    <span class="keyword">var</span> b myInt    <span class="comment">// 自定义类型</span></span><br><span class="line">    <span class="keyword">var</span> c <span class="type">rune</span>     <span class="comment">// 类型别名</span></span><br><span class="line">    reflectType(a) <span class="comment">// type:, kind:ptr</span></span><br><span class="line">    reflectType(b) <span class="comment">// type:myInt, kind:int64</span></span><br><span class="line">    reflectType(c) <span class="comment">// type:int32, kind:int32</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">type</span> person <span class="keyword">struct</span> &#123;</span><br><span class="line">        name <span class="type">string</span></span><br><span class="line">        age  <span class="type">int</span></span><br><span class="line">    &#125;</span><br><span class="line">    p := person&#123;</span><br><span class="line">        name: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">        age:  <span class="number">18</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    reflectType(p)  <span class="comment">// type:person, kind:struct</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码中，a指针的<code>.Name()</code>是空。</p>
<p>Go语言的反射中像数组、切片、Map、指针等类型的变量，它们的<code>.Name()</code>都是返回空。</p>
<h4 id="ValueOf"><a href="#ValueOf" class="headerlink" title="ValueOf"></a>ValueOf</h4><p><code>reflect.ValueOf()</code>返回的是<code>reflect.Value</code>类型，其中包含了原始值的值信息。<code>reflect.Value</code>与原始值之间可以互相转换。</p>
<p><code>reflect.Value</code>类型提供的获取原始值的方法如下：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Interface() interface {}</td>
<td style="text-align:left">将值以 interface{} 类型返回，可以通过类型断言转换为指定类型</td>
</tr>
<tr>
<td style="text-align:left">Int() int64</td>
<td style="text-align:left">将值以 int 类型返回，所有有符号整型均可以此方式返回</td>
</tr>
<tr>
<td style="text-align:left">Uint() uint64</td>
<td style="text-align:left">将值以 uint 类型返回，所有无符号整型均可以此方式返回</td>
</tr>
<tr>
<td style="text-align:left">Float() float64</td>
<td style="text-align:left">将值以双精度（float64）类型返回，所有浮点数（float32、float64）均可以此方式返回</td>
</tr>
<tr>
<td style="text-align:left">Bool() bool</td>
<td style="text-align:left">将值以 bool 类型返回</td>
</tr>
<tr>
<td style="text-align:left">Bytes() []bytes</td>
<td style="text-align:left">将值以字节数组 []bytes 类型返回</td>
</tr>
<tr>
<td style="text-align:left">String() string</td>
<td style="text-align:left">将值以字符串类型返回</td>
</tr>
</tbody>
</table>
</div>
<h5 id="通过反射获取值"><a href="#通过反射获取值" class="headerlink" title="通过反射获取值"></a>通过反射获取值</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflectValue</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    valueOf := reflect.ValueOf(x)</span><br><span class="line">    k := valueOf.Kind()</span><br><span class="line">    <span class="keyword">switch</span> k &#123;</span><br><span class="line">    <span class="keyword">case</span> reflect.Int64:</span><br><span class="line">        <span class="comment">// valueOf.Int()从反射中获取整型的原始值，然后通过int64()强制类型转换</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;type is int64, value is %d\n&quot;</span>, <span class="type">int64</span>(valueOf.Int()))</span><br><span class="line">    <span class="keyword">case</span> reflect.Float32:</span><br><span class="line">        <span class="comment">// valueOf.Float()从反射中获取浮点型的原始值，然后通过float32()强制类型转换</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;type is float32, value is %f\n&quot;</span>, <span class="type">float32</span>(valueOf.Float()))</span><br><span class="line">    <span class="keyword">case</span> reflect.Float64:</span><br><span class="line">        <span class="comment">// valueOf.Float()从反射中获取浮点型的原始值，然后通过float64()强制类型转换</span></span><br><span class="line">        fmt.Printf(<span class="string">&quot;type is float64, value is %f\n&quot;</span>, <span class="type">float64</span>(valueOf.Float()))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a <span class="type">float32</span> = <span class="number">3.14</span></span><br><span class="line">    <span class="keyword">var</span> b <span class="type">int64</span> = <span class="number">100</span></span><br><span class="line">    reflectValue(a) <span class="comment">// type is float32, value is 3.140000</span></span><br><span class="line">    reflectValue(b) <span class="comment">// type is int64, value is 100</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将int类型的原始值转换为reflect.Value类型</span></span><br><span class="line">    c := reflect.ValueOf(<span class="number">10</span>)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;type c :%T\n&quot;</span>, c) <span class="comment">// type c :reflect.Value</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="通过反射设置值"><a href="#通过反射设置值" class="headerlink" title="通过反射设置值"></a>通过反射设置值</h5><p>想要在函数中通过反射修改变量的值，需要注意的是：</p>
<ul>
<li>函数参数传递的是值拷贝，必须传递变量地址才能修改变量值。而反射中使用专有的<code>Elem()</code>方法来获取指针对应的值。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflectSetValue1</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    v := reflect.ValueOf(x)</span><br><span class="line">    <span class="keyword">if</span> v.Kind() == reflect.Int64 &#123;</span><br><span class="line">        v.SetInt(<span class="number">200</span>) <span class="comment">//修改的是副本，reflect包会引发panic</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">reflectSetValue2</span><span class="params">(x <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    v := reflect.ValueOf(x)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 反射中使用 Elem()方法获取指针对应的值</span></span><br><span class="line">    <span class="keyword">if</span> v.Elem().Kind() == reflect.Int64 &#123;</span><br><span class="line">        v.Elem().SetInt(<span class="number">200</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> a <span class="type">int64</span> = <span class="number">100</span></span><br><span class="line">    <span class="comment">// reflectSetValue1(a) //panic: reflect: reflect.Value.SetInt using unaddressable value</span></span><br><span class="line">    reflectSetValue2(&amp;a)</span><br><span class="line">    fmt.Println(a)   <span class="comment">// 200</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="isNil-和isValid"><a href="#isNil-和isValid" class="headerlink" title="isNil()和isValid()"></a>isNil()和isValid()</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v Value)</span></span> IsNil() <span class="type">bool</span></span><br></pre></td></tr></table></figure>
<p><code>IsNil()</code>报告v持有的值是否为nil。v持有的值的分类必须是通道、函数、接口、映射、指针、切片之一；否则IsNil函数会导致panic</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(v Value)</span></span> IsValid() <span class="type">bool</span></span><br></pre></td></tr></table></figure>
<p><code>IsValid()</code>返回v是否持有一个值。如果v是Value零值会返回false，此时v除了IsValid、String、Kind之外的方法都会导致panic</p>
<p><code>IsNil()</code>常被用于判断指针是否为空；<code>IsValid()</code>常被用于判定返回值是否有效</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// *int类型空指针</span></span><br><span class="line">    <span class="keyword">var</span> a *<span class="type">int</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;var a *int IsNil:&quot;</span>, reflect.ValueOf(a).IsNil()) <span class="comment">// var a *int IsNil: true</span></span><br><span class="line">    <span class="comment">// nil值</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;nil IsValid:&quot;</span>, reflect.ValueOf(<span class="literal">nil</span>).IsValid())  <span class="comment">// nil IsValid: false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 实例化一个匿名结构体</span></span><br><span class="line">    b := <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">    <span class="comment">// 尝试从结构体中查找&quot;abc&quot;字段</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;不存在的结构体成员:&quot;</span>, reflect.ValueOf(b).FieldByName(<span class="string">&quot;abc&quot;</span>).IsValid()) <span class="comment">// 不存在的结构体成员: false</span></span><br><span class="line">    <span class="comment">// 尝试从结构体中查找&quot;abc&quot;方法</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;不存在的结构体方法:&quot;</span>, reflect.ValueOf(b).MethodByName(<span class="string">&quot;abc&quot;</span>).IsValid())  <span class="comment">// 不存在的结构体方法: false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// map</span></span><br><span class="line">    c := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">int</span>&#123;&#125;</span><br><span class="line">    <span class="comment">// 尝试从map中查找一个不存在的键</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;map中不存在的键：&quot;</span>, reflect.ValueOf(c).MapIndex(reflect.ValueOf(<span class="string">&quot;娜扎&quot;</span>)).IsValid())  <span class="comment">// map中不存在的键： false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="结构体反射"><a href="#结构体反射" class="headerlink" title="结构体反射"></a>结构体反射</h3><h4 id="与结构体相关的方法"><a href="#与结构体相关的方法" class="headerlink" title="与结构体相关的方法"></a>与结构体相关的方法</h4><p>任意值通过<code>reflect.TypeOf()</code>获得反射对象信息后，如果它的类型是结构体，可以通过反射值对象（<code>reflect.Type</code>）的<code>NumField()</code>和<code>Field()</code>方法获得结构体成员的详细信息。</p>
<p><code>reflect.Type</code>中与获取结构体成员相关的的方法如下表所示。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法</th>
<th style="text-align:left">说明</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">Field(i int) StructField</td>
<td style="text-align:left">根据索引，返回索引对应的结构体字段的信息。</td>
</tr>
<tr>
<td style="text-align:left">NumField() int</td>
<td style="text-align:left">返回结构体成员字段数量。</td>
</tr>
<tr>
<td style="text-align:left">FieldByName(name string) (StructField, bool)</td>
<td style="text-align:left">根据给定字符串返回字符串对应的结构体字段的信息。</td>
</tr>
<tr>
<td style="text-align:left">FieldByIndex(index []int) StructField</td>
<td style="text-align:left">多层成员访问时，根据 []int 提供的每个结构体的字段索引，返回字段的信息。</td>
</tr>
<tr>
<td style="text-align:left">FieldByNameFunc(match func(string) bool) (StructField,bool)</td>
<td style="text-align:left">根据传入的匹配函数匹配需要的字段。</td>
</tr>
<tr>
<td style="text-align:left">NumMethod() int</td>
<td style="text-align:left">返回该类型的方法集中方法的数目</td>
</tr>
<tr>
<td style="text-align:left">Method(int) Method</td>
<td style="text-align:left">返回该类型方法集中的第i个方法</td>
</tr>
<tr>
<td style="text-align:left">MethodByName(string)(Method, bool)</td>
<td style="text-align:left">根据方法名返回该类型方法集中的方法</td>
</tr>
</tbody>
</table>
</div>
<h4 id="StructField类型"><a href="#StructField类型" class="headerlink" title="StructField类型"></a>StructField类型</h4><p><code>StructField</code>类型用来描述结构体中的一个字段的信息</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> StructField <span class="keyword">struct</span> &#123;</span><br><span class="line">    <span class="comment">// Name是字段的名字。PkgPath是非导出字段的包路径，对导出字段该字段为&quot;&quot;。</span></span><br><span class="line">    <span class="comment">// 参见http://golang.org/ref/spec#Uniqueness_of_identifiers</span></span><br><span class="line">    Name    <span class="type">string</span></span><br><span class="line">    PkgPath <span class="type">string</span></span><br><span class="line">    Type      Type      <span class="comment">// 字段的类型</span></span><br><span class="line">    Tag       StructTag <span class="comment">// 字段的标签</span></span><br><span class="line">    Offset    <span class="type">uintptr</span>   <span class="comment">// 字段在结构体中的字节偏移量</span></span><br><span class="line">    Index     []<span class="type">int</span>     <span class="comment">// 用于Type.FieldByIndex时的索引切片</span></span><br><span class="line">    Anonymous <span class="type">bool</span>      <span class="comment">// 是否匿名字段</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="结构体反射示例"><a href="#结构体反射示例" class="headerlink" title="结构体反射示例"></a>结构体反射示例</h4><p>当我们使用反射得到一个结构体数据之后可以通过索引依次获取其字段信息，也可以通过字段名去获取指定的字段信息</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> student <span class="keyword">struct</span> &#123;</span><br><span class="line">    Name  <span class="type">string</span> <span class="string">`json:&quot;name&quot;`</span></span><br><span class="line">    Score <span class="type">int</span>    <span class="string">`json:&quot;score&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    stu1 := student&#123;</span><br><span class="line">        Name:  <span class="string">&quot;小王子&quot;</span>,</span><br><span class="line">        Score: <span class="number">90</span>,</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    t := reflect.TypeOf(stu1)</span><br><span class="line">    fmt.Println(t.Name(), t.Kind()) <span class="comment">// student struct</span></span><br><span class="line">    <span class="comment">// 通过for循环遍历结构体的所有字段信息</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; t.NumField(); i++ &#123;</span><br><span class="line">        field := t.Field(i)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;name:%s index:%d type:%v json tag:%v\n&quot;</span>, field.Name, field.Index, field.Type, field.Tag.Get(<span class="string">&quot;json&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过字段名获取指定结构体字段信息</span></span><br><span class="line">    <span class="keyword">if</span> scoreField, ok := t.FieldByName(<span class="string">&quot;Score&quot;</span>); ok &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;name:%s index:%d type:%v json tag:%v\n&quot;</span>, scoreField.Name, scoreField.Index, scoreField.Type, scoreField.Tag.Get(<span class="string">&quot;json&quot;</span>))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">student struct</span></span><br><span class="line"><span class="comment">name:Name index:[0] type:string json tag:name</span></span><br><span class="line"><span class="comment">name:Score index:[1] type:int json tag:score</span></span><br><span class="line"><span class="comment">name:Score index:[1] type:int json tag:score</span></span><br><span class="line"><span class="comment"> */</span></span><br></pre></td></tr></table></figure>
<h2 id="go语言的包管理"><a href="#go语言的包管理" class="headerlink" title="go语言的包管理"></a>go语言的包管理</h2><h3 id="go的import各种姿势"><a href="#go的import各种姿势" class="headerlink" title="go的import各种姿势"></a>go的import各种姿势</h3><h4 id="单行导入和多行导入"><a href="#单行导入和多行导入" class="headerlink" title="单行导入和多行导入"></a>单行导入和多行导入</h4><p>在 Go 语言中，一个包可包含多个 <code>.go</code> 文件（这些文件必须得在同一级文件夹中），只要这些 <code>.go</code> 文件的头部都使用 <code>package</code> 关键字声明了同一个包。</p>
<p>导入包的方式分为两种：</p>
<ul>
<li>单行导入</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;io/ioutil&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>多行导入</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;io/ioutil&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="使用点的方式导入"><a href="#使用点的方式导入" class="headerlink" title="使用点的方式导入"></a>使用点的方式导入</h4><p>这种格式相当于把fmt包直接合并到当前程序，在使用fmt包内的方法时可以不用加前缀<code>fmt.</code></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> . <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    Println(<span class="string">&quot;hello, world&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但这种用法，会有一定的隐患，就是导入的包里可能有函数，会和我们自己的函数发生冲突</p>
<h4 id="使用别名"><a href="#使用别名" class="headerlink" title="使用别名"></a>使用别名</h4><p>我们导入了两个具有同一包名的包时产生冲突，此时这里为其中一个包定义别名</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;crypto/rand&quot;</span></span><br><span class="line">    mrand <span class="string">&quot;math/rand&quot;</span> <span class="comment">// 将名称替换为mrand避免冲突</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="包的初始化"><a href="#包的初始化" class="headerlink" title="包的初始化"></a>包的初始化</h4><p>每个包都允许有一个 <code>init</code> 函数，当这个包被导入时，会执行该包的这个 <code>init</code> 函数，做一些初始化任务。</p>
<p>对于 <code>init</code> 函数的执行有几点需要注意：</p>
<ul>
<li><code>init</code> 函数优先于 <code>main</code> 函数执行</li>
<li><code>init()</code>函数在程序运行时自动被调用执行，不能在代码中主动调用它</li>
<li>同一个包甚至同一个源文件，可以有多个 init 函数</li>
<li>同一个包内的多个 init 顺序是不受保证的</li>
</ul>
<p><strong>包初始化执行的顺序：</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> a <span class="type">int</span> = <span class="number">10</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> pi = <span class="number">3.14</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;init：&quot;</span>, a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;hello world&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">init： 10</span></span><br><span class="line"><span class="comment">hello world</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<p>可以看出，包的初始化顺序是：</p>
<ul>
<li>包作用域的常量和变量（常量优先于变量）——&gt; init()  ——&gt; main()</li>
</ul>
<p><strong>init()函数的执行顺序：</strong></p>
<p>Go语言包会从<code>main</code>包开始检查其导入的所有包，每个包中又可能导入了其他的包。Go编译器由此构建出一个树状的包引用关系，再根据引用顺序决定编译顺序，依次编译这些包的代码。</p>
<p>在运行时，被最后导入的包会最先初始化并调用其<code>init()</code>函数：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210610113637.png" alt=""></p>
<h4 id="包的匿名导入"><a href="#包的匿名导入" class="headerlink" title="包的匿名导入"></a>包的匿名导入</h4><p>当我们导入一个包时，如果这个包没有被使用到，在编译时，是会报错的。</p>
<p>如果想执行这个包的初始化的init函数，又不希望使用这个包内部的数据，就可以使用匿名引用。</p>
<p>使用方法如下，下划线为空白标识符，并不能被访问</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ ”PackageTest/calc“</span><br></pre></td></tr></table></figure>
<p>包不能出现环形引用的情况，比如包a引用了包b，包b引用了包c，如果包c又引用了包a，则编译不能通过</p>
<p>包的重复引用是允许的，比如包a引用了包b和包c，包b和包c都引用了包d。这种场景相当于重复引用了包d，这种情况是允许的，并且go的编译器保证包d的init函数只会执行一次。</p>
<h4 id="go导入的是路径而不是包"><a href="#go导入的是路径而不是包" class="headerlink" title="go导入的是路径而不是包"></a>go导入的是路径而不是包</h4><ul>
<li>导入时，是按照目录导入。导入目录后，可以使用这个目录下的所有包。</li>
<li>出于习惯，包名和目录名通常会设置成一样，所以会让你有一种你导入的是包的错觉</li>
</ul>
<h3 id="Go-Modules的应用"><a href="#Go-Modules的应用" class="headerlink" title="Go Modules的应用"></a>Go Modules的应用</h3><p>之前Go 语言的的包依赖管理一直都被大家所诟病。Go官方也在一直在努力为开发者提供更方便易用的包管理方案，从最初的 GOPATH 到 GO VENDOR，再到最新的 GO Modules，虽然走了不少的弯路，但最终还是拿出了 Go Modules 这样像样的解决方案。</p>
<p><code>go module</code>是Go1.11版本之后官方推出的版本管理工具，并且从<code>Go1.13</code>版本开始，<code>go module</code>将是Go语言默认的依赖管理工具</p>
<h4 id="GOPATH方案"><a href="#GOPATH方案" class="headerlink" title="GOPATH方案"></a>GOPATH方案</h4><p>可以将其理解为工作目录，在这个工作目录下，通常有如下的目录结构：</p>
<ul>
<li>bin：存放编译后生成的二进制可执行文件</li>
<li>pkg：存放编译后生成的 <code>.a</code> 文件</li>
<li>src：存放项目的源代码</li>
</ul>
<p>将所有的包放在<code>$GOPATH/src</code> 目录下进行管理的方式就称为gopath模式。</p>
<p>这想想就觉得不行，这样包管理起来肯定很混乱    </p>
<h4 id="go-vendor模式的过渡"><a href="#go-vendor模式的过渡" class="headerlink" title="go vendor模式的过渡"></a>go vendor模式的过渡</h4><p>vendor模式在 go1.5开始支持，相当于gopath的一个补丁方案</p>
<p>GOPATH 方案下不同项目下无法使用多个版本库，vendor的解决方案就是：</p>
<ul>
<li>在每个项目下都创建一个 vendor 目录，每个项目所需的依赖都只会下载到自己vendor目录下，项目之间的依赖包互不影响</li>
<li>在编译时，v1.5 的 Go 在你设置了开启 <code>GO15VENDOREXPERIMENT=1</code> （注：这个变量在 v1.6 版本默认为1，但是在 v1.7 后，已去掉该环境变量，默认开启 <code>vendor</code> 特性，无需你手动设置）后，会提升 vendor 目录的依赖包搜索路径的优先级（相较于 GOPATH）。</li>
</ul>
<p>这样包的搜索顺序由高到低是这样的：</p>
<ul>
<li>当前包下的 vendor 目录</li>
<li>向上级目录查找，直到找到 src 下的 vendor 目录</li>
<li>在 GOROOT 目录下查找</li>
<li>在 GOPATH 下面查找依赖包</li>
</ul>
<p>当然这只是GOPATH方案的一个补丁方法，并没有从本质上解决包管理混乱的情况。</p>
<h4 id="go-mod"><a href="#go-mod" class="headerlink" title="go mod"></a>go mod</h4><p>go modules 在 v1.11 版本正式推出，在v1.14 版本中，官方正式发话，称其已经足够成熟，可以应用于生产上。</p>
<p>从 v1.11 开始，<code>go env</code> 多了个环境变量： <code>GO111MODULE</code> ，这里的 111，其实就是 v1.11 的象征标志</p>
<p><code>GO111MODULE</code> 是一个开关，通过它可以开启或关闭 go mod 模式：</p>
<ul>
<li><code>GO111MODULE=off</code>禁用模块支持，编译时会从<code>GOPATH</code>和<code>vendor</code>文件夹中查找包。</li>
<li><code>GO111MODULE=on</code>启用模块支持，编译时会忽略<code>GOPATH</code>和<code>vendor</code>文件夹，只根据 <code>go.mod</code>下载依赖。</li>
<li><code>GO111MODULE=auto</code>，当项目在<code>$GOPATH/src</code>外且项目根目录有<code>go.mod</code>文件时，自动开启模块支持。</li>
</ul>
<p>开启go mod的命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go <span class="built_in">env</span> -w GO111MODULE=<span class="string">&quot;on&quot;</span></span><br></pre></td></tr></table></figure>
<p>常用的 go mod 命令：</p>
<ul>
<li>go mod download    下载依赖的module到本地cache（默认为$GOPATH/pkg/mod目录）</li>
<li>go mod edit        编辑go.mod文件</li>
<li>go mod graph       打印模块依赖图</li>
<li>go mod init        初始化当前文件夹, 创建go.mod文件</li>
<li>go mod tidy        增加缺少的module，删除无用的module</li>
<li>go mod vendor      将依赖复制到vendor下</li>
<li>go mod verify      校验依赖</li>
<li>go mod why         解释为什么需要依赖</li>
</ul>
<p>go.mod文件记录了项目所有的依赖信息，结构如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module github.com/cwz/studygo/module-test</span><br><span class="line"></span><br><span class="line"><span class="keyword">go</span> <span class="number">1.16</span></span><br><span class="line"></span><br><span class="line">require (</span><br><span class="line">    github.com/gin-gonic/gin v1<span class="number">.4</span><span class="number">.0</span></span><br><span class="line">    github.com/<span class="keyword">go</span>-sql-driver/mysql v1<span class="number">.4</span><span class="number">.1</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>第一行：模块的引用路径</li>
<li>第二行：项目使用的go版本</li>
<li>第三行：项目所需的直接依赖包及其版本</li>
</ul>
<h2 id="go语言的编码规范"><a href="#go语言的编码规范" class="headerlink" title="go语言的编码规范"></a>go语言的编码规范</h2><ul>
<li>代码规范不是强制的，也就是你不遵循代码规范写出来的代码运行也是完全没有问题的</li>
<li>代码规范目的是方便团队形成一个统一的代码风格，提高代码的可读性，规范性和统一性。本规范将从命名规范，注释规范，代码风格和 Go 语言提供的常用的工具这几个方面做一个说明</li>
<li>规范并不是唯一的，也就是说理论上每个公司都可以制定自己的规范，不过一般来说整体上规范差异不会很大</li>
</ul>
<h3 id="命名规范"><a href="#命名规范" class="headerlink" title="命名规范"></a>命名规范</h3><p>命名是代码规范中很重要的一部分，统一的命名规则有利于提高的代码的可读性，好的命名仅仅通过命名就可以获取到足够多的信息。</p>
<ul>
<li>当命名（包括常量、变量、类型、函数名、结构字段等等）以一个大写字母开头，如：Group1，那么使用这种形式的标识符的对象就<strong>可以被外部包的代码所使用</strong>（客户端程序需要先导入这个包），这被称为导出（像面向对象语言中 如Java的 public）</li>
<li><strong>命名如果以小写字母开头，则对包外是不可见的，但是他们在整个包的内部是可见并且可用的</strong>（像面向对象语言中 如Java的 private ）</li>
</ul>
<h4 id="包名：package"><a href="#包名：package" class="headerlink" title="包名：package"></a>包名：package</h4><p>保持package的名字和目录保持一致，尽量采取有意义的包名，简短，有意义，尽量和标准库不要冲突。包名应该为<strong>小写</strong>单词，不要使用下划线或者混合大小写。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> model</span><br><span class="line"><span class="keyword">package</span> main</span><br></pre></td></tr></table></figure>
<h4 id="文件名"><a href="#文件名" class="headerlink" title="文件名"></a>文件名</h4><p>尽量采取有意义的文件名，简短，有意义，应该为<strong>小写</strong>单词，使用<strong>下划线</strong>分隔各个单词</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user_model.<span class="keyword">go</span></span><br></pre></td></tr></table></figure>
<h4 id="结构体命名"><a href="#结构体命名" class="headerlink" title="结构体命名"></a>结构体命名</h4><ul>
<li>采用驼峰命名法，首字母根据访问控制大写或者小写</li>
<li>struct 申明和初始化格式采用多行</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 多行申明</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span>&#123;</span><br><span class="line">    Username  <span class="type">string</span></span><br><span class="line">    Email     <span class="type">string</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 多行初始化</span></span><br><span class="line">u := User&#123;</span><br><span class="line">    Username: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">    Email:    <span class="string">&quot;admin@admin.com&quot;</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="接口命名"><a href="#接口命名" class="headerlink" title="接口命名"></a>接口命名</h4><ul>
<li>命名规则基本和上面的结构体类型</li>
<li>单个函数的结构名以 “er” 作为后缀，例如 Reader , Writer </li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Reader <span class="keyword">interface</span> &#123;</span><br><span class="line">        Read(p []<span class="type">byte</span>) (n <span class="type">int</span>, err <span class="type">error</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="变量命名"><a href="#变量命名" class="headerlink" title="变量命名"></a>变量命名</h4><p>和结构体类似，变量名称一般遵循驼峰法，首字母根据访问控制原则大写或者小写，但遇到特有名词时，需要遵循以下规则：</p>
<ul>
<li>如果变量为私有，且特有名词为首个单词，则使用小写，如 apiClient</li>
<li>其它情况都应当使用该名词原有的写法，如 APIClient、repoID、UserID</li>
<li>错误示例：UrlArray，应该写成 urlArray 或者 URLArray</li>
<li>若变量类型为 bool 类型，则名称应以 has, is, can 或 allow 开头</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> isExist <span class="type">bool</span></span><br><span class="line"><span class="keyword">var</span> hasConflict <span class="type">bool</span></span><br><span class="line"><span class="keyword">var</span> canManage <span class="type">bool</span></span><br><span class="line"><span class="keyword">var</span> allowGitHook <span class="type">bool</span></span><br></pre></td></tr></table></figure>
<h4 id="常量命名"><a href="#常量命名" class="headerlink" title="常量命名"></a>常量命名</h4><p>常量均需使用全部大写字母组成，并使用下划线分词</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> APP_VER = <span class="string">&quot;1.0&quot;</span></span><br></pre></td></tr></table></figure>
<p>如果是枚举类型的常量，需要先创建相应类型：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Scheme <span class="type">string</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">    HTTP  Scheme = <span class="string">&quot;http&quot;</span></span><br><span class="line">    HTTPS Scheme = <span class="string">&quot;https&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h3 id="注释规范"><a href="#注释规范" class="headerlink" title="注释规范"></a>注释规范</h3><p>Go提供C风格的<code>/* */</code>块注释和C ++风格的<code>//</code>行注释。行注释是常态；块注释主要显示为包注释，但在表达式中很有用或禁用大量代码。</p>
<p>go 语言自带的 godoc 工具可以根据注释生成文档，生成可以自动生成对应的网站（<a href="https://link.zhihu.com/?target=http%3A//golang.org">golang.org</a> 就是使用 godoc 工具直接生成的），注释的质量决定了生成的文档的质量。每个包都应该有一个包注释，在package子句之前有一个块注释。对于多文件包，包注释只需要存在于一个文件中，任何一个都可以。包评论应该介绍包，并提供与整个包相关的信息。它将首先出现在<code>godoc</code>页面上，并应设置下面的详细文档</p>
<h4 id="包注释"><a href="#包注释" class="headerlink" title="包注释"></a>包注释</h4><p>每个包都应该有一个包注释，一个位于package子句之前的块注释或行注释。包如果有多个go文件，只需要出现在一个go文件中（一般是和包同名的文件）即可。 包注释应该包含下面基本信息(请严格按照这个顺序，简介，创建人，创建时间）：</p>
<ul>
<li>包的基本简介（包名，简介）</li>
<li>创建者，格式： 创建人： rtx 名</li>
<li>创建时间，格式：创建时间： yyyyMMdd</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// util 包， 该包包含了项目共用的一些常量，封装了项目中一些共用函数。</span></span><br><span class="line"><span class="comment">// 创建人： hanru</span></span><br><span class="line"><span class="comment">// 创建时间： 20190419</span></span><br></pre></td></tr></table></figure>
<h4 id="结构体、接口-注释"><a href="#结构体、接口-注释" class="headerlink" title="结构体、接口 注释"></a>结构体、接口 注释</h4><p>每个自定义的结构体或者接口都应该有注释说明，该注释对结构进行简要介绍，放在结构体定义的前一行，格式为： 结构体名， 结构体说明。同时结构体内的每个成员变量都要有说明，该说明放在成员变量的后面（注意对齐），实例如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// User ， 用户对象，定义了用户的基础信息</span></span><br><span class="line"><span class="keyword">type</span> User <span class="keyword">struct</span>&#123;</span><br><span class="line">    Username  <span class="type">string</span> <span class="comment">// 用户名</span></span><br><span class="line">    Email     <span class="type">string</span> <span class="comment">// 邮箱</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="函数注释"><a href="#函数注释" class="headerlink" title="函数注释"></a>函数注释</h4><p>每个函数都应该有注释说明，函数的注释应该包括三个方面（严格按照此顺序撰写）：</p>
<ul>
<li>简要说明，格式说明：以函数名开头，“，”分隔说明部分</li>
<li>参数列表：每行一个参数，参数名开头，“，”分隔说明部分</li>
<li>返回值： 每行一个返回值</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewtAttrModel ， 属性数据层操作类的工厂方法</span></span><br><span class="line"><span class="comment">// 参数：</span></span><br><span class="line"><span class="comment">//      ctx ： 上下文信息</span></span><br><span class="line"><span class="comment">// 返回值：</span></span><br><span class="line"><span class="comment">//      属性操作类指针</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewAttrModel</span><span class="params">(ctx *common.Context)</span></span> *AttrModel &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="代码逻辑注释"><a href="#代码逻辑注释" class="headerlink" title="代码逻辑注释"></a>代码逻辑注释</h4><p>对于一些关键位置的代码逻辑，或者局部较为复杂的逻辑，需要有相应的逻辑说明，方便其他开发者阅读该段代码</p>
<h4 id="注释风格"><a href="#注释风格" class="headerlink" title="注释风格"></a>注释风格</h4><p>统一使用中文注释，对于中英文字符之间严格使用空格分隔， 这个不仅仅是中文和英文之间，英文和中文标点之间也都要使用空格分隔，例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 从 Redis 中批量读取属性，对于没有读取到的 id ， 记录到一个数组里面，准备从 DB 中读取</span></span><br></pre></td></tr></table></figure>
<p>上面 Redis 、 id 、 DB 和其他中文字符之间都是用了空格分隔</p>
<ul>
<li>建议全部使用单行注释</li>
<li>和代码的规范一样，单行注释不要过长，禁止超过 120 字符</li>
</ul>
<h3 id="import规范"><a href="#import规范" class="headerlink" title="import规范"></a>import规范</h3><p>import在多行的情况下，goimports会自动帮你格式化，但是我们这里还是规范一下import的一些规范，如果你在一个文件里面引入了一个package，还是建议采用如下格式：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>如果你的包引入了三种类型的包，标准库包，程序内部包，第三方包，建议采用如下方式进行组织你的包：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/astaxie/beego&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/go-sql-driver/mysql&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;myproject/models&quot;</span></span><br><span class="line">    <span class="string">&quot;myproject/controller&quot;</span></span><br><span class="line">    <span class="string">&quot;myproject/utils&quot;</span></span><br><span class="line">)  </span><br></pre></td></tr></table></figure>
<p>有顺序的引入包，不同的类型采用空格分离，第一种实标准库，第二是第三方包，第三是自己的项目包</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这是不好的导入</span></span><br><span class="line"><span class="keyword">import</span> “../net”</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这是正确的做法</span></span><br><span class="line"><span class="keyword">import</span> “github.com/repo/proj/src/net”</span><br></pre></td></tr></table></figure>
<h3 id="错误处理-1"><a href="#错误处理-1" class="headerlink" title="错误处理"></a>错误处理</h3><ul>
<li>错误处理的原则就是不能丢弃任何有返回err的调用，不要使用 _ 丢弃，必须全部处理。接收到错误，要么返回err，或者使用log记录下来</li>
<li>尽早return：一旦有错误发生，马上返回</li>
<li>尽量不要使用panic，除非你知道你在做什么</li>
<li>错误描述如果是英文必须为小写，不需要标点结尾</li>
<li>采用独立的错误流进行处理</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 错误写法</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// error handling</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// normal code</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 正确写法</span></span><br><span class="line"><span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// error handling</span></span><br><span class="line">    <span class="keyword">return</span> <span class="comment">// or continue, etc.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="go的并发编程"><a href="#go的并发编程" class="headerlink" title="go的并发编程"></a>go的并发编程</h2><p>Go语言的并发通过<code>goroutine</code>实现。<code>goroutine</code>类似于线程，属于用户态的线程，我们可以根据需要创建成千上万个<code>goroutine</code>并发工作。<code>goroutine</code>是由Go语言的运行时（runtime）调度完成，而线程是由操作系统调度完成。</p>
<p>Go语言还提供<code>channel</code>在多个<code>goroutine</code>间进行通信。<code>goroutine</code>和<code>channel</code>是 Go 语言秉承的 CSP（Communicating Sequential Process）并发模式的重要实现基础。</p>
<h3 id="goroutine"><a href="#goroutine" class="headerlink" title="goroutine"></a>goroutine</h3><p>在python、java中实现并发编程并不轻松，我们通常需要自己维护一个线程池，并且需要自己去包装一个又一个的任务，同时需要自己去调度线程执行任务并维护上下文切换。</p>
<p>但是Go中的goroutine机制使得在语言层面已经内置了调度和上下文切换的机制。当你需要让某个任务并发执行的时候，你只需要把这个任务包装成一个函数，开启一个<code>goroutine</code>去执行这个函数就可以了。</p>
<h4 id="简单使用goroutine"><a href="#简单使用goroutine" class="headerlink" title="简单使用goroutine"></a>简单使用goroutine</h4><p>Go语言中使用<code>goroutine</code>非常简单，只需要在调用函数的时候在前面加上<code>go</code>关键字，就可以为一个函数创建一个<code>goroutine</code>。</p>
<p>一个<code>goroutine</code>必定对应一个函数，可以创建多个<code>goroutine</code>去执行相同的函数。</p>
<h4 id="启动单个goroutine"><a href="#启动单个goroutine" class="headerlink" title="启动单个goroutine"></a>启动单个goroutine</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello Goroutine!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    hello()</span><br><span class="line">    fmt.Println(<span class="string">&quot;main goroutine done!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个示例中hello函数和下面的语句是串行的，执行的结果是打印完<code>Hello Goroutine!</code>后打印<code>main goroutine done!</code>。</p>
<p>接下来我们在调用hello函数前面加上关键字<code>go</code>，也就是启动一个goroutine去执行hello这个函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> hello() <span class="comment">// 启动另外一个goroutine去执行hello函数</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;main goroutine done!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一次的执行结果只打印了<code>main goroutine done!</code>，并没有打印<code>Hello Goroutine!</code></p>
<p>在程序启动时，Go程序就会为<code>main()</code>函数创建一个默认的<code>goroutine</code>。当main()函数返回的时候该<code>goroutine</code>就结束了，所有在<code>main()</code>函数中启动的<code>goroutine</code>会一同结束。</p>
<p>最简单的方法就是sleep：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> hello() <span class="comment">// 启动另外一个goroutine去执行hello函数</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;main goroutine done!&quot;</span>)</span><br><span class="line">    time.Sleep(time.Second*<span class="number">2</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="启动多个goroutine"><a href="#启动多个goroutine" class="headerlink" title="启动多个goroutine"></a>启动多个goroutine</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">(i <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done() <span class="comment">// goroutine结束就登记-1</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello Goroutine!&quot;</span>, i)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>) <span class="comment">// 启动一个goroutine就登记+1</span></span><br><span class="line">        <span class="keyword">go</span> hello(i)</span><br><span class="line">    &#125;</span><br><span class="line">    wg.Wait() <span class="comment">// 等待所有登记的goroutine都结束</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="goroutine调度问题"><a href="#goroutine调度问题" class="headerlink" title="goroutine调度问题"></a>goroutine调度问题</h3><p>OS线程（操作系统线程）一般都有固定的栈内存（通常为2MB）,一个<code>goroutine</code>的栈在其生命周期开始时只有很小的栈（典型情况下2KB），<code>goroutine</code>的栈不是固定的，他可以按需增大和缩小，<code>goroutine</code>的栈大小限制可以达到1GB，虽然极少会用到这么大。所以在Go语言中一次创建十万左右的<code>goroutine</code>也是可以的。</p>
<h4 id="goroutine调度"><a href="#goroutine调度" class="headerlink" title="goroutine调度"></a>goroutine调度</h4><p>GMP是Go语言运行时（runtime）层面的实现，是go语言自己实现的一套调度系统。区别于操作系统调度OS线程：</p>
<ul>
<li>G 就是goroutine，里面除了存放本goroutine信息外， 还有与所在P的绑定等信息</li>
<li>P 管理着一组goroutine队列，P里面会存储当前goroutine运行的上下文环境（函数指针，堆栈地址及地址边界），P会对自己管理的goroutine队列做一些调度（比如把占用CPU时间较长的goroutine暂停、运行后续的goroutine等等）当自己的队列消费完了就去全局队列里取，如果全局队列里也消费完了会去其他P的队列里抢任务。</li>
<li>M 是Go运行时（runtime）对操作系统内核线程的虚拟， M与内核线程一般是一一映射的关系， 一个groutine最终是要放到M上执行的</li>
</ul>
<p>P与M一般也是一一对应的。他们关系是： P管理着一组G挂载在M上运行。当一个G长久阻塞在一个M上时，runtime会新建一个M，阻塞G所在的P会把其他的G 挂载在新建的M上。当旧的G阻塞完成或者认为其已经死掉时 回收旧的M。</p>
<p>P的个数是通过<code>runtime.GOMAXPROCS</code>设定（最大256），Go1.5版本之后默认为物理线程数。 在并发量大的时候会增加一些P和M，但不会太多，切换太频繁的话得不偿失。</p>
<p>单从线程调度讲，Go语言相比起其他语言的优势在于OS线程是由OS内核来调度的，<code>goroutine</code>则是由Go运行时（runtime）自己的调度器调度的，这个调度器使用一个称为m:n调度的技术（复用/调度m个goroutine到n个OS线程）。 其一大特点是goroutine的调度是在用户态下完成的， 不涉及内核态与用户态之间的频繁切换，包括内存的分配与释放，都是在用户态维护着一块大的内存池， 不直接调用系统的malloc函数（除非内存池需要改变），成本比调度OS线程低很多。 另一方面充分利用了多核的硬件资源，近似的把若干goroutine均分在物理线程上， 再加上本身goroutine的超轻量，以上种种保证了go调度方面的性能。</p>
<p>更多了解GMP：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/sunsky303/p/9705727.html">https://www.cnblogs.com/sunsky303/p/9705727.html</a></li>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_41882200/article/details/115647095">https://blog.csdn.net/weixin_41882200/article/details/115647095</a></li>
</ul>
<h4 id="GOMAXPROCS"><a href="#GOMAXPROCS" class="headerlink" title="GOMAXPROCS"></a>GOMAXPROCS</h4><p>Go运行时的调度器使用<code>GOMAXPROCS</code>参数来确定需要使用多少个OS线程来同时执行Go代码。默认值是机器上的CPU核心数。例如在一个8核心的机器上，调度器会把Go代码同时调度到8个OS线程上（GOMAXPROCS是m:n调度中的n）。</p>
<p>Go语言中可以通过<code>runtime.GOMAXPROCS()</code>函数设置当前程序并发时占用的CPU逻辑核心数。</p>
<p>Go1.5版本之前，默认使用的是单核心执行。Go1.5版本之后，默认使用全部的CPU逻辑核心数。</p>
<p>Go语言中的操作系统线程和goroutine的关系：</p>
<ol>
<li>一个操作系统线程对应用户态多个goroutine。</li>
<li>go程序可以同时使用多个操作系统线程。</li>
<li>goroutine和OS线程是多对多的关系，即m:n。</li>
</ol>
<h3 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h3><p>Go语言的并发模型是<code>CSP（Communicating Sequential Processes）</code>，<strong>提倡通过通信共享内存而不是通过共享内存而实现通信</strong>。</p>
<p>如果说<code>goroutine</code>是Go程序并发的执行体，<code>channel</code>就是它们之间的连接。<code>channel</code>是可以让一个<code>goroutine</code>发送特定值到另一个<code>goroutine</code>的通信机制。</p>
<p>Go 语言中的通道（channel）是一种特殊的类型。通道像一个传送带或者队列，总是遵循先入先出（First In First Out）的规则，保证收发数据的顺序。每一个通道都是一个具体类型的导管，也就是声明channel的时候需要为其指定元素类型。</p>
<h4 id="channel类型"><a href="#channel类型" class="headerlink" title="channel类型"></a>channel类型</h4><p>channel是一种类型，是引用类型，申明channel类型的格式如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> 变量 <span class="keyword">chan</span> 元素类型</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ch1 <span class="keyword">chan</span> <span class="type">int</span>   <span class="comment">// 声明一个传递整型的通道</span></span><br><span class="line"><span class="keyword">var</span> ch2 <span class="keyword">chan</span> <span class="type">bool</span>  <span class="comment">// 声明一个传递布尔型的通道</span></span><br><span class="line"><span class="keyword">var</span> ch3 <span class="keyword">chan</span> []<span class="type">int</span> <span class="comment">// 声明一个传递int切片的通道</span></span><br></pre></td></tr></table></figure>
<h4 id="初始化channel"><a href="#初始化channel" class="headerlink" title="初始化channel"></a>初始化channel</h4><p>通道是引用类型，通道类型的空值是 nil 。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> ch <span class="keyword">chan</span> <span class="type">int</span></span><br><span class="line">fmt.Println(ch) <span class="comment">// &lt;nil&gt;</span></span><br></pre></td></tr></table></figure>
<p>channel使用 make 初始化之后才能使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ch4 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">ch5 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">bool</span>)</span><br><span class="line">ch6 := <span class="built_in">make</span>(<span class="keyword">chan</span> []<span class="type">int</span>)</span><br></pre></td></tr></table></figure>
<p>上面创建的都是无缓冲的channel，也可以指定缓冲大小：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch7 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h4 id="channel的操作"><a href="#channel的操作" class="headerlink" title="channel的操作"></a>channel的操作</h4><p>先定义一个channel：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br></pre></td></tr></table></figure>
<p>一些操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ch &lt;- <span class="number">10</span>  <span class="comment">// 把10发送到ch中</span></span><br><span class="line"></span><br><span class="line">x := &lt;- ch <span class="comment">// 从ch中接收值并赋值给变量x</span></span><br><span class="line">&lt;-ch       <span class="comment">// 从ch中接收值，忽略结果</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">close</span>(ch)  <span class="comment">// 关闭通道</span></span><br></pre></td></tr></table></figure>
<p>关闭后的通道有以下特点：</p>
<ul>
<li>对一个关闭的通道再发送值就会导致panic</li>
<li>对一个关闭的通道进行接收，会一直获取值直到通道为空</li>
<li>对一个关闭的并且没有值的通道，执行接收操作会得到对应类型的零值</li>
<li>关闭一个已经关闭的通道会导致panic</li>
</ul>
<h4 id="无缓冲的通道"><a href="#无缓冲的通道" class="headerlink" title="无缓冲的通道"></a>无缓冲的通道</h4><p>无缓冲的通道又称为阻塞的通道</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    ch &lt;- <span class="number">10</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;发送成功&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码运行会产生一个经典的错误：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fatal error: all goroutines are asleep - deadlock!</span><br><span class="line"></span><br><span class="line">goroutine 1 [chan send]:</span><br><span class="line">main.main()</span><br><span class="line">    D:/workspace/golang_codes/test1/test.go:8 +0x65</span><br></pre></td></tr></table></figure>
<p>使用channel不当，经常会出现deadlock！</p>
<p>我们使用<code>ch := make(chan int)</code>创建的是无缓冲的通道，无缓冲的通道只有在有人接收值的时候才能发送值。</p>
<p>上面的代码会阻塞在<code>ch &lt;- 10</code>这一行代码形成死锁，其中一个解决的方法就是启用一个goroutine去接受值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">recv</span><span class="params">(c <span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    ret := &lt;-c</span><br><span class="line">    fmt.Println(<span class="string">&quot;接收成功&quot;</span>, ret)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    <span class="keyword">go</span> recv(ch) <span class="comment">// 启用goroutine从通道接收值</span></span><br><span class="line">    ch &lt;- <span class="number">10</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;发送成功&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>无缓冲通道上的发送操作会阻塞，直到另一个<code>goroutine</code>在该通道上执行接收操作，这时值才能发送成功，两个<code>goroutine</code>将继续执行。相反，如果接收操作先执行，接收方的goroutine将阻塞，直到另一个<code>goroutine</code>在该通道上发送一个值。</p>
<p>使用无缓冲通道进行通信将导致发送和接收的<code>goroutine</code>同步化。因此，无缓冲通道也被称为<code>同步通道</code>。</p>
<h4 id="有缓冲的通道"><a href="#有缓冲的通道" class="headerlink" title="有缓冲的通道"></a>有缓冲的通道</h4><p>我们可以在使用make函数初始化通道的时候为其指定通道的容量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>) <span class="comment">// 创建一个容量为1的有缓冲区通道</span></span><br><span class="line">    ch &lt;- <span class="number">10</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;发送成功&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只要通道的容量大于零，那么该通道就是有缓冲的通道，通道的容量表示通道中能存放元素的数量。</p>
<h4 id="for-range从通道取值"><a href="#for-range从通道取值" class="headerlink" title="for range从通道取值"></a>for range从通道取值</h4><p>当向通道中发送完数据时，我们可以通过<code>close</code>函数来关闭通道。</p>
<p>当通道被关闭时，再往该通道发送值会引发<code>panic</code>，从该通道取值的操作会先取完通道中的值，再然后取到的值一直都是对应类型的零值。那如何判断一个通道是否被关闭了呢？</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    <span class="comment">// 开启goroutine将0~100的数发送到ch1中</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">            ch1 &lt;- i</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(ch1)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// 开启goroutine从ch1中接收值，并将该值的平方发送到ch2中</span></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            i, ok := &lt;-ch1 <span class="comment">// 通道关闭后再取值ok=false</span></span><br><span class="line">            <span class="keyword">if</span> !ok &#123;</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            &#125;</span><br><span class="line">            ch2 &lt;- i * i</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">close</span>(ch2)</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="comment">// 在主goroutine中从ch2中接收值打印</span></span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> ch2 &#123; <span class="comment">// 通道关闭后会退出for range循环</span></span><br><span class="line">        fmt.Println(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的例子中我们看到有两种方式在接收值的时候判断该通道是否被关闭，不过我们通常使用的是for range的方式。使用for range遍历通道，当通道被关闭的时候就会退出for range</p>
<h4 id="单向通道"><a href="#单向通道" class="headerlink" title="单向通道"></a>单向通道</h4><p>有的时候我们会将通道作为参数在多个任务函数间传递，很多时候我们在不同的任务函数中使用通道都会对其进行限制，比如限制通道在函数中只能发送或只能接收。</p>
<p>Go语言中提供了<strong>单向通道</strong>来处理这种情况：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">counter</span><span class="params">(out <span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">100</span>; i++ &#123;</span><br><span class="line">        out &lt;- i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(out)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">squarer</span><span class="params">(out <span class="keyword">chan</span>&lt;- <span class="type">int</span>, in &lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> in &#123;</span><br><span class="line">        out &lt;- i * i</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(out)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">printer</span><span class="params">(in &lt;-<span class="keyword">chan</span> <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="keyword">range</span> in &#123;</span><br><span class="line">        fmt.Println(i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    ch2 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>)</span><br><span class="line">    <span class="keyword">go</span> counter(ch1)</span><br><span class="line">    <span class="keyword">go</span> squarer(ch2, ch1)</span><br><span class="line">    printer(ch2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>chan &lt;-int</code> 是一个只写单向通道，可以对其执行发送操作但是不能执行接收操作</li>
<li><code>&lt;-chan int</code>是一个只读单向通道，可以对其执行接收操作但是不能执行发送操作</li>
</ul>
<p>在函数传参及任何赋值操作中可以将双向通道转换为单向通道，但反过来是不可以的。</p>
<h3 id="worker-pool（goroutine池）"><a href="#worker-pool（goroutine池）" class="headerlink" title="worker pool（goroutine池）"></a>worker pool（goroutine池）</h3><p>在工作中我们通常会使用可以指定启动的goroutine数量–<code>worker pool</code>模式，控制<code>goroutine</code>的数量，防止<code>goroutine</code>泄漏和暴涨。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">worker</span><span class="params">(id <span class="type">int</span>, jobs &lt;-<span class="keyword">chan</span> <span class="type">int</span>, results <span class="keyword">chan</span>&lt;- <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> j := <span class="keyword">range</span> jobs &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;worker:%d start job:%d\n&quot;</span>, id, j)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;worker:%d end job:%d\n&quot;</span>, id, j)</span><br><span class="line">        results &lt;- j * <span class="number">2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    jobs := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">100</span>)</span><br><span class="line">    results := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">100</span>)</span><br><span class="line">    <span class="comment">// 开启3个goroutine</span></span><br><span class="line">    <span class="keyword">for</span> w := <span class="number">1</span>; w &lt;= <span class="number">3</span>; w++ &#123;</span><br><span class="line">        <span class="keyword">go</span> worker(w, jobs, results)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 5个任务</span></span><br><span class="line">    <span class="keyword">for</span> j := <span class="number">1</span>; j &lt;= <span class="number">5</span>; j++ &#123;</span><br><span class="line">        jobs &lt;- j</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">close</span>(jobs)</span><br><span class="line">    <span class="comment">// 输出结果</span></span><br><span class="line">    <span class="keyword">for</span> a := <span class="number">1</span>; a &lt;= <span class="number">5</span>; a++ &#123;</span><br><span class="line">        &lt;-results</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="select多路复用"><a href="#select多路复用" class="headerlink" title="select多路复用"></a>select多路复用</h3><p>在某些场景下我们需要同时从多个通道接收数据。通道在接收数据时，如果没有数据可以接收将会发生阻塞。你也许会写出如下代码使用遍历的方式来实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>&#123;</span><br><span class="line">    <span class="comment">// 尝试从ch1接收值</span></span><br><span class="line">    data, ok := &lt;-ch1</span><br><span class="line">    <span class="comment">// 尝试从ch2接收值</span></span><br><span class="line">    data, ok := &lt;-ch2</span><br><span class="line">    …</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这种方式虽然可以实现从多个通道接收值的需求，但是运行性能会差很多。为了应对这种场景，Go内置了<code>select</code>关键字，可以同时响应多个通道的操作。</p>
<p>select的使用类似于switch语句，有一系列case分支和一个默认的分支。每个case会对应一个通道的通信（接收或发送）过程。</p>
<p>select会一直等待，直到某个case的通信操作完成时，就执行case分支对应的语句。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>&#123;</span><br><span class="line">    <span class="keyword">case</span> &lt;-ch1:</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">case</span> data := &lt;-ch2:</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">case</span> ch3&lt;-data:</span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        默认操作</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ch := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">int</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> x := &lt;-ch:</span><br><span class="line">            fmt.Println(x)</span><br><span class="line">        <span class="keyword">case</span> ch &lt;- i:</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用<code>select</code>语句能提高代码的可读性。</p>
<ul>
<li>可处理一个或多个channel的发送/接收操作。</li>
<li>如果多个<code>case</code>同时满足，<code>select</code>会随机选择一个。</li>
<li>对于没有<code>case</code>的<code>select&#123;&#125;</code>会一直等待，可用于阻塞main函数。</li>
</ul>
<h4 id="select的应用场景"><a href="#select的应用场景" class="headerlink" title="select的应用场景"></a>select的应用场景</h4><p><code>select</code>有很重要的一个应用就是超时处理。我们知道，如果没有case需要处理，select语句就会一直阻塞着。这时候我们可能就需要一个超时操作，用来处理超时的情况。</p>
<p>下面这个例子我们会在2秒后往channel c1中发送一个数据，但是<code>select</code>设置为1秒超时,因此我们会打印出<code>timeout 1</code>,而不是<code>result 1</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    c1 := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="type">string</span>, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        time.Sleep(time.Second * <span class="number">2</span>)</span><br><span class="line">        c1 &lt;- <span class="string">&quot;result 1&quot;</span></span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">select</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> res := &lt;-c1:</span><br><span class="line">        fmt.Println(res)</span><br><span class="line">    <span class="keyword">case</span> &lt;-time.After(time.Second * <span class="number">1</span>):</span><br><span class="line">        fmt.Println(<span class="string">&quot;timeout 1&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实它利用的是<code>time.After</code>方法，它返回一个类型为<code>&lt;-chan Time</code>的单向的channel，在指定的时间发送一个当前时间给返回的channel中。</p>
<h3 id="并发锁"><a href="#并发锁" class="headerlink" title="并发锁"></a>并发锁</h3><p>有时候在Go代码中可能会存在多个<code>goroutine</code>同时操作一个资源（临界区），这种情况会发生<code>竞态问题</code>（数据竞态）</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x <span class="type">int64</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++ &#123;</span><br><span class="line">        x = x + <span class="number">1</span></span><br><span class="line">    &#125;</span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> add()</span><br><span class="line">    <span class="keyword">go</span> add()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码中我们开启了两个<code>goroutine</code>去累加变量x的值，这两个<code>goroutine</code>在访问和修改<code>x</code>变量的时候就会存在数据竞争，导致最后的结果与期待的不符。</p>
<h4 id="互斥锁"><a href="#互斥锁" class="headerlink" title="互斥锁"></a>互斥锁</h4><p>互斥锁是一种常用的控制共享资源访问的方法，它能够保证同时只有一个<code>goroutine</code>可以访问共享资源。Go语言中使用<code>sync</code>包的<code>Mutex</code>类型来实现互斥锁。 使用互斥锁来修复上面代码的问题：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> x <span class="type">int64</span></span><br><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"><span class="keyword">var</span> lock sync.Mutex</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">5000</span>; i++ &#123;</span><br><span class="line">        lock.Lock() <span class="comment">// 加锁</span></span><br><span class="line">        x = x + <span class="number">1</span></span><br><span class="line">        lock.Unlock() <span class="comment">// 解锁</span></span><br><span class="line">    &#125;</span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> add()</span><br><span class="line">    <span class="keyword">go</span> add()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    fmt.Println(x)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用互斥锁能够保证同一时间有且只有一个<code>goroutine</code>进入临界区，其他的<code>goroutine</code>则在等待锁；当互斥锁释放后，等待的<code>goroutine</code>才可以获取锁进入临界区，多个<code>goroutine</code>同时等待一个锁时，唤醒的策略是随机的。</p>
<h4 id="读写互斥锁"><a href="#读写互斥锁" class="headerlink" title="读写互斥锁"></a>读写互斥锁</h4><p>互斥锁是完全互斥的，但是有很多实际的场景下是读多写少的，当我们并发的去读取一个资源不涉及资源修改的时候是没有必要加锁的，这种场景下使用读写锁是更好的一种选择。读写锁在Go语言中使用<code>sync</code>包中的<code>RWMutex</code>类型。</p>
<p>读写锁分为两种：读锁和写锁。当一个goroutine获取读锁之后，其他的<code>goroutine</code>如果是获取读锁会继续获得锁，如果是获取写锁就会等待；当一个<code>goroutine</code>获取写锁之后，其他的<code>goroutine</code>无论是获取读锁还是写锁都会等待。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    x      <span class="type">int64</span></span><br><span class="line">    wg     sync.WaitGroup</span><br><span class="line">    lock   sync.Mutex</span><br><span class="line">    rwlock sync.RWMutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">write</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// lock.Lock()   // 加互斥锁</span></span><br><span class="line">    rwlock.Lock() <span class="comment">// 加写锁</span></span><br><span class="line">    x = x + <span class="number">1</span></span><br><span class="line">    time.Sleep(<span class="number">10</span> * time.Millisecond) <span class="comment">// 假设写操作耗时10毫秒</span></span><br><span class="line">    rwlock.Unlock()                   <span class="comment">// 解写锁</span></span><br><span class="line">    <span class="comment">// lock.Unlock()                     // 解互斥锁</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">read</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// lock.Lock()                  // 加互斥锁</span></span><br><span class="line">    rwlock.RLock()               <span class="comment">// 加读锁</span></span><br><span class="line">    time.Sleep(time.Millisecond) <span class="comment">// 假设读操作耗时1毫秒</span></span><br><span class="line">    rwlock.RUnlock()             <span class="comment">// 解读锁</span></span><br><span class="line">    <span class="comment">// lock.Unlock()                // 解互斥锁</span></span><br><span class="line">    wg.Done()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    start := time.Now()</span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">10</span>; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> write()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++ &#123;</span><br><span class="line">        wg.Add(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">go</span> read()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    wg.Wait()</span><br><span class="line">    end := time.Now()</span><br><span class="line">    fmt.Println(end.Sub(start))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="sync-WaitGroup"><a href="#sync-WaitGroup" class="headerlink" title="sync.WaitGroup"></a>sync.WaitGroup</h3><p>在代码中生硬的使用<code>time.Sleep</code>肯定是不合适的，Go语言中可以使用<code>sync.WaitGroup</code>来实现并发任务的同步。 <code>sync.WaitGroup</code>有以下几个方法：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">方法名</th>
<th style="text-align:left">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">(wg * WaitGroup) Add(delta int)</td>
<td style="text-align:left">计数器+delta</td>
</tr>
<tr>
<td style="text-align:left">(wg *WaitGroup) Done()</td>
<td style="text-align:left">计数器-1</td>
</tr>
<tr>
<td style="text-align:left">(wg *WaitGroup) Wait()</td>
<td style="text-align:left">阻塞直到计数器变为0</td>
</tr>
</tbody>
</table>
</div>
<p><code>sync.WaitGroup</code>内部维护着一个计数器，计数器的值可以增加和减少。例如当我们启动了N 个并发任务时，就将计数器值增加N。每个任务完成时通过调用Done()方法将计数器减1。通过调用Wait()来等待并发任务执行完，当计数器值为0时，表示所有并发任务已经完成。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> wg sync.WaitGroup</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hello</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> wg.Done()</span><br><span class="line">    fmt.Println(<span class="string">&quot;Hello Goroutine!&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    wg.Add(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">go</span> hello() <span class="comment">// 启动另外一个goroutine去执行hello函数</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;main goroutine done!&quot;</span>)</span><br><span class="line">    wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要注意<code>sync.WaitGroup</code>是一个结构体，传递的时候要传递指针</p>
<h3 id="go语言中的Context"><a href="#go语言中的Context" class="headerlink" title="go语言中的Context"></a>go语言中的Context</h3><p>Context，也叫上下文，它的接口定义如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Context <span class="keyword">interface</span> &#123;</span><br><span class="line">    Deadline() (deadline time.Time, ok <span class="type">bool</span>)</span><br><span class="line">    Done() &lt;-<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">    Err() <span class="type">error</span></span><br><span class="line">    Value(key <span class="keyword">interface</span>&#123;&#125;) <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到 Context 接口共有 4 个方法:</p>
<ul>
<li><code>Deadline</code>：返回的第一个值是 截止时间，到了这个时间点，Context 会自动触发 Cancel 动作。返回的第二个值是 一个布尔值，true 表示设置了截止时间，false 表示没有设置截止时间，如果没有设置截止时间，就要手动调用 cancel 函数取消 Context。</li>
<li><code>Done</code>：返回一个只读的通道（只有在被cancel后才会返回），类型为 <code>struct&#123;&#125;</code>。当这个通道可读时，意味着parent context已经发起了取消请求，根据这个信号，开发者就可以做一些清理动作，退出goroutine。</li>
<li><code>Err</code>：返回 context 被 cancel 的原因。</li>
<li><code>Value</code>：返回被绑定到 Context 的值，是一个键值对，所以要通过一个Key才可以获取对应的值，这个值一般是线程安全的。</li>
</ul>
<h4 id="简单使用Context"><a href="#简单使用Context" class="headerlink" title="简单使用Context"></a>简单使用Context</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">monitor</span><span class="params">(ctx context.Context, number <span class="type">int</span>)</span></span>  &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="comment">// 其实可以写成 case &lt;- ctx.Done()</span></span><br><span class="line">        <span class="comment">// 这里仅是为了让你看到 Done 返回的内容</span></span><br><span class="line">        <span class="keyword">case</span> v :=&lt;- ctx.Done():</span><br><span class="line">            fmt.Printf(<span class="string">&quot;监控器%v，接收到通道值为：%v，监控结束。\n&quot;</span>, number,v)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            fmt.Printf(<span class="string">&quot;监控器%v，正在监控中...\n&quot;</span>, number)</span><br><span class="line">            time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx, cancel := context.WithCancel(context.Background())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i :=<span class="number">1</span> ; i &lt;= <span class="number">5</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> monitor(ctx, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    time.Sleep( <span class="number">1</span> * time.Second)</span><br><span class="line">    <span class="comment">// 关闭所有 goroutine</span></span><br><span class="line">    cancel()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 等待5s，若此时屏幕没有输出 &lt;正在监控中&gt; 就说明所有的goroutine都已经关闭</span></span><br><span class="line">    time.Sleep( <span class="number">5</span> * time.Second)</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;主程序退出！！&quot;</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里面的关键代码，也就三行：</p>
<ul>
<li>第一行：以 context.Background() 为 parent context 定义一个可取消的 context</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctx, cancel := context.WithCancel(context.Background())</span><br></pre></td></tr></table></figure>
<ul>
<li>第二行：然后你可以在所有的goroutine 里利用 for + select 搭配来不断检查 ctx.Done() 是否可读，可读就说明该 context 已经取消，你可以清理 goroutine 并退出了。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> &lt;- ctx.Done():</span><br></pre></td></tr></table></figure>
<ul>
<li>第三行：当你想到取消 context 的时候，只要调用一下 cancel 方法即可。这个 cancel 就是我们在创建 ctx 的时候返回的第二个值。</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cancel()</span><br></pre></td></tr></table></figure>
<p>运行结果输出如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">监控器2，正在监控中...</span><br><span class="line">监控器1，正在监控中...</span><br><span class="line">监控器5，正在监控中...</span><br><span class="line">监控器3，正在监控中...</span><br><span class="line">监控器4，正在监控中...</span><br><span class="line">监控器5，接收到通道值为：&#123;&#125;，监控结束。</span><br><span class="line">监控器4，接收到通道值为：&#123;&#125;，监控结束。</span><br><span class="line">监控器2，接收到通道值为：&#123;&#125;，监控结束。</span><br><span class="line">监控器1，接收到通道值为：&#123;&#125;，监控结束。</span><br><span class="line">监控器3，接收到通道值为：&#123;&#125;，监控结束。</span><br><span class="line">主程序退出！！</span><br></pre></td></tr></table></figure>
<h4 id="根Context"><a href="#根Context" class="headerlink" title="根Context"></a>根Context</h4><p>创建 Context 必须要指定一个 父 Context。</p>
<p>Go 已经帮我们实现了2个，我们代码中最开始都是以这两个内置的context作为最顶层的parent context，衍生出更多的子Context。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    background = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">    todo       = <span class="built_in">new</span>(emptyCtx)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Background</span><span class="params">()</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">return</span> background</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TODO</span><span class="params">()</span></span> Context &#123;</span><br><span class="line">    <span class="keyword">return</span> todo</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>一个是Background，主要用于main函数、初始化以及测试代码中，作为Context这个树结构的最顶层的Context，也就是根Context，它不能被取消。</li>
<li>一个是TODO，如果我们不知道该使用什么Context的时候，可以使用这个，但是实际应用中，暂时还没有使用过这个TODO。</li>
<li>他们两个本质上都是emptyCtx结构体类型，是一个不可取消，没有设置截止时间，没有携带任何值的Context。</li>
</ul>
<h4 id="Context-的继承衍生"><a href="#Context-的继承衍生" class="headerlink" title="Context 的继承衍生"></a>Context 的继承衍生</h4><p>上面在定义我们自己的 Context 时，我们使用的是 <code>WithCancel</code> 这个方法。</p>
<p>除它之外，context 包还有其他几个 With 系列的函数：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithCancel</span><span class="params">(parent Context)</span></span> (ctx Context, cancel CancelFunc)&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithDeadline</span><span class="params">(parent Context, deadline time.Time)</span></span> (Context, CancelFunc)&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithTimeout</span><span class="params">(parent Context, timeout time.Duration)</span></span> (Context, CancelFunc)&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">WithValue</span><span class="params">(parent Context, key, val <span class="keyword">interface</span>&#123;&#125;)</span></span> Context&#123;&#125;</span><br></pre></td></tr></table></figure>
<p>这四个函数有一个共同的特点，就是第一个参数，都是接收一个 父context</p>
<p>通过一次继承，就多实现了一个功能，比如使用 WithCancel 函数传入 根context ，就创建出了一个子 context，该子context 相比 父context，就多了一个 cancel context 的功能</p>
<h5 id="WithDeadline"><a href="#WithDeadline" class="headerlink" title="WithDeadline"></a>WithDeadline</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">monitor</span><span class="params">(ctx context.Context, number <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Printf(<span class="string">&quot;监控器%v，监控结束。\n&quot;</span>, number)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            fmt.Printf(<span class="string">&quot;监控器%v，正在监控中...\n&quot;</span>, number)</span><br><span class="line">            time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx01, cancel := context.WithCancel(context.Background())</span><br><span class="line">    ctx02, cancel := context.WithDeadline(ctx01, time.Now().Add(<span class="number">1</span>*time.Second))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> monitor(ctx02, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">    <span class="keyword">if</span> ctx02.Err() != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;监控器取消的原因: &quot;</span>, ctx02.Err())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;主程序退出！！&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">监控器4，正在监控中...</span><br><span class="line">监控器5，正在监控中...</span><br><span class="line">监控器3，正在监控中...</span><br><span class="line">监控器2，正在监控中...</span><br><span class="line">监控器1，正在监控中...</span><br><span class="line">监控器5，监控结束。</span><br><span class="line">监控器3，监控结束。</span><br><span class="line">监控器1，监控结束。</span><br><span class="line">监控器4，监控结束。</span><br><span class="line">监控器2，监控结束。</span><br><span class="line">监控器取消的原因:  context deadline exceeded</span><br><span class="line">主程序退出！！</span><br></pre></td></tr></table></figure>
<h5 id="WithTimeout"><a href="#WithTimeout" class="headerlink" title="WithTimeout"></a>WithTimeout</h5><p>WithTimeout 和 WithDeadline 使用方法及功能基本一致，都是表示超过一定的时间会自动 cancel context，</p>
<p>唯一不同的地方：</p>
<ul>
<li>WithDeadline 传入的第二个参数是 time.Time 类型，它是一个绝对的时间，意思是在什么时间点超时取消</li>
<li>WithTimeout 传入的第二个参数是 time.Duration 类型，它是一个相对的时间，意思是多长时间后超时取消</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">monitor</span><span class="params">(ctx context.Context, number <span class="type">int</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-ctx.Done():</span><br><span class="line">            fmt.Printf(<span class="string">&quot;监控器%v，监控结束。\n&quot;</span>, number)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            fmt.Printf(<span class="string">&quot;监控器%v，正在监控中...\n&quot;</span>, number)</span><br><span class="line">            time.Sleep(<span class="number">2</span> * time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    ctx01, cancel := context.WithCancel(context.Background())</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 相比例子1，仅有这一行改动</span></span><br><span class="line">    ctx02, cancel := context.WithTimeout(ctx01, <span class="number">1</span>*time.Second)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> cancel()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i := <span class="number">1</span>; i &lt;= <span class="number">5</span>; i++ &#123;</span><br><span class="line">        <span class="keyword">go</span> monitor(ctx02, i)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    time.Sleep(<span class="number">5</span> * time.Second)</span><br><span class="line">    <span class="keyword">if</span> ctx02.Err() != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;监控器取消的原因: &quot;</span>, ctx02.Err())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(<span class="string">&quot;主程序退出！！&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">监控器<span class="number">5</span>，正在监控中...</span><br><span class="line">监控器<span class="number">1</span>，正在监控中...</span><br><span class="line">监控器<span class="number">2</span>，正在监控中...</span><br><span class="line">监控器<span class="number">3</span>，正在监控中...</span><br><span class="line">监控器<span class="number">4</span>，正在监控中...</span><br><span class="line">监控器<span class="number">2</span>，监控结束。</span><br><span class="line">监控器<span class="number">3</span>，监控结束。</span><br><span class="line">监控器<span class="number">4</span>，监控结束。</span><br><span class="line">监控器<span class="number">1</span>，监控结束。</span><br><span class="line">监控器<span class="number">5</span>，监控结束。</span><br><span class="line">监控器取消的原因:  context deadline exceeded</span><br><span class="line">主程序退出！！</span><br></pre></td></tr></table></figure>
<h2 id="go网络编程"><a href="#go网络编程" class="headerlink" title="go网络编程"></a>go网络编程</h2><h3 id="go实现TCP通信"><a href="#go实现TCP通信" class="headerlink" title="go实现TCP通信"></a>go实现TCP通信</h3><p>服务端代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bufio&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">process</span><span class="params">(conn net.Conn)</span></span> &#123;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close() <span class="comment">// 处理完之后需要关闭连接</span></span><br><span class="line">    <span class="comment">// 针对当前的连接做数据的发送和接收操作</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        reader := bufio.NewReader(conn)</span><br><span class="line">        <span class="keyword">var</span> buf [<span class="number">128</span>]<span class="type">byte</span></span><br><span class="line">        n, err := reader.Read(buf[:])</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;read from conn failed, err: %v\n&quot;</span>, err)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        recv := <span class="type">string</span>(buf[:n])</span><br><span class="line">        fmt.Println(<span class="string">&quot;接收到的数据：&quot;</span>, recv)</span><br><span class="line">        _, _ = conn.Write([]<span class="type">byte</span>(<span class="string">&quot;ok&quot;</span>)) <span class="comment">// 把收到的数据返回给客户端</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1、启动服务</span></span><br><span class="line">    listen, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:50070&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;listen failed, err: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> listen.Close()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// 2、等待客户端来建立连接</span></span><br><span class="line">        conn, err := listen.Accept()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;accept failed, err: %v\n&quot;</span>, err)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 3、启动一个单独的goroutine去处理连接</span></span><br><span class="line">        <span class="keyword">go</span> process(conn)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bufio&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1、于服务端建立连接</span></span><br><span class="line">    conn, err := net.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;127.0.0.1:50070&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;dail failed, err: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 2、利用该连接进行数据的发送和接收</span></span><br><span class="line">    input := bufio.NewReader(os.Stdin)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        s, _ := input.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        s = strings.TrimSpace(s)</span><br><span class="line">        <span class="keyword">if</span> strings.ToUpper(s) == <span class="string">&quot;Q&quot;</span> &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 给服务端发消息</span></span><br><span class="line">        _, err := conn.Write([]<span class="type">byte</span>(s))</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;send failed, err: %v\n&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 从服务端接收回复的消息</span></span><br><span class="line">        <span class="keyword">var</span> buf [<span class="number">1024</span>]<span class="type">byte</span></span><br><span class="line">        n, err := conn.Read(buf[:])</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;read failed, err: %v\n&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(<span class="string">&quot;收到服务端回复：&quot;</span>, <span class="type">string</span>(buf[:n]))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="go实现实现UDP通信"><a href="#go实现实现UDP通信" class="headerlink" title="go实现实现UDP通信"></a>go实现实现UDP通信</h3><p>服务端代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    listen, err := net.ListenUDP(<span class="string">&quot;udp&quot;</span>, &amp;net.UDPAddr&#123;</span><br><span class="line">        IP:   net.IPv4(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>),</span><br><span class="line">        Port: <span class="number">50080</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;listen failed, err: %v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> listen.Close()</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> data [<span class="number">1024</span>]<span class="type">byte</span></span><br><span class="line">        n, addr, err := listen.ReadFromUDP(data[:])</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;read from udp failed, err: %v\n&quot;</span>, err)</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(<span class="string">&quot;接收到的数据：&quot;</span>, <span class="type">string</span>(data[:n]))</span><br><span class="line">        _, err = listen.WriteToUDP(data[:n], addr)</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Printf(<span class="string">&quot;write to %v failed, err: %v\n&quot;</span>, addr, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;bufio&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    socket, err := net.DialUDP(<span class="string">&quot;udp&quot;</span>, <span class="literal">nil</span>, &amp;net.UDPAddr&#123;</span><br><span class="line">        IP:   net.IPv4(<span class="number">127</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>),</span><br><span class="line">        Port: <span class="number">50080</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;连接服务端失败，err:&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> socket.Close()</span><br><span class="line">    input := bufio.NewReader(os.Stdin)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        s, _ := input.ReadString(<span class="string">&#x27;\n&#x27;</span>)</span><br><span class="line">        _, err = socket.Write([]<span class="type">byte</span>(s))</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;发送数据失败，err:&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 接收数据</span></span><br><span class="line">        <span class="keyword">var</span> buf [<span class="number">1024</span>]<span class="type">byte</span></span><br><span class="line">        n, addr, err := socket.ReadFromUDP(buf[:])</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;接收数据失败，err:&quot;</span>, err)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;read from %v, msg: %v\n&quot;</span>, addr, <span class="type">string</span>(buf[:n]))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="go-websocket"><a href="#go-websocket" class="headerlink" title="go websocket"></a>go websocket</h2><p>server:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gorilla/websocket&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> (</span><br><span class="line">    upgrader = websocket.Upgrader&#123;</span><br><span class="line">        <span class="comment">// 允许跨域</span></span><br><span class="line">        CheckOrigin: <span class="function"><span class="keyword">func</span><span class="params">(r *http.Request)</span></span> <span class="type">bool</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">wsHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        conn *websocket.Conn</span><br><span class="line">        err  <span class="type">error</span></span><br><span class="line">        data []<span class="type">byte</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> conn, err = upgrader.Upgrade(w, r, <span class="literal">nil</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="comment">// 类型：Text，Binary</span></span><br><span class="line">        <span class="keyword">if</span> _, data, err = conn.ReadMessage(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">goto</span> ERR</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> err = conn.WriteMessage(websocket.TextMessage, data); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">goto</span> ERR</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">ERR:</span><br><span class="line">    conn.Close()</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/ws&quot;</span>, wsHandler)</span><br><span class="line">    http.ListenAndServe(<span class="string">&quot;0.0.0.0:8080&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>html页面：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">window</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;load&quot;</span>, <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> output = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;output&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> input = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;input&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> ws;</span></span><br><span class="line"><span class="language-javascript">            <span class="keyword">var</span> print = <span class="keyword">function</span> (<span class="params">message</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">var</span> d = <span class="variable language_">document</span>.<span class="title function_">createElement</span>(<span class="string">&quot;div&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                d.<span class="property">innerHTML</span> = message;</span></span><br><span class="line"><span class="language-javascript">                output.<span class="title function_">appendChild</span>(d);</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;open&quot;</span>).<span class="property">onclick</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (ws) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&quot;ws://localhost:8080/ws&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                ws.<span class="property">onopen</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">print</span>(<span class="string">&quot;OPEN&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                ws.<span class="property">onclose</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">print</span>(<span class="string">&quot;CLOSE&quot;</span>);</span></span><br><span class="line"><span class="language-javascript">                    ws = <span class="literal">null</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                ws.<span class="property">onmessage</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">print</span>(<span class="string">&quot;RESPONSE: &quot;</span> + evt.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                ws.<span class="property">onerror</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="title function_">print</span>(<span class="string">&quot;ERROR: &quot;</span> + evt.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;send&quot;</span>).<span class="property">onclick</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (!ws) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                <span class="title function_">print</span>(<span class="string">&quot;SEND: &quot;</span> + input.<span class="property">value</span>);</span></span><br><span class="line"><span class="language-javascript">                ws.<span class="title function_">send</span>(input.<span class="property">value</span>);</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">&quot;close&quot;</span>).<span class="property">onclick</span> = <span class="keyword">function</span> (<span class="params">evt</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">if</span> (!ws) &#123;</span></span><br><span class="line"><span class="language-javascript">                    <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">                &#125;</span></span><br><span class="line"><span class="language-javascript">                ws.<span class="title function_">close</span>();</span></span><br><span class="line"><span class="language-javascript">                <span class="keyword">return</span> <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">            &#125;;</span></span><br><span class="line"><span class="language-javascript">        &#125;);</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">valign</span>=<span class="string">&quot;top&quot;</span> <span class="attr">width</span>=<span class="string">&quot;50%&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">p</span>&gt;</span>Click &quot;Open&quot; to create a connection to the server,</span><br><span class="line">                &quot;Send&quot; to send a message to the server and &quot;Close&quot; to close the connection.</span><br><span class="line">                You can change the message and send multiple times.</span><br><span class="line">            <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;open&quot;</span>&gt;</span>Open<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;close&quot;</span>&gt;</span>Close<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">id</span>=<span class="string">&quot;input&quot;</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Hello world!&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;send&quot;</span>&gt;</span>Send<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">td</span> <span class="attr">valign</span>=<span class="string">&quot;top&quot;</span> <span class="attr">width</span>=<span class="string">&quot;50%&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;output&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="go语言的单元测试"><a href="#go语言的单元测试" class="headerlink" title="go语言的单元测试"></a>go语言的单元测试</h2><h3 id="go-test工具"><a href="#go-test工具" class="headerlink" title="go test工具"></a>go test工具</h3><p>Go语言中的测试依赖<code>go test</code>命令。编写测试代码和编写普通的Go代码过程是类似的，并不需要学习新的语法、规则或工具。</p>
<p>go test命令是一个按照一定约定和组织的测试代码的驱动程序。在包目录内，所有以<code>_test.go</code>为后缀名的源代码文件都是<code>go test</code>测试的一部分，不会被<code>go build</code>编译到最终的可执行文件中。</p>
<p>在<code>*_test.go</code>文件中有三种类型的函数，单元测试函数、基准测试函数和示例函数。</p>
<div class="table-container">
<table>
<thead>
<tr>
<th style="text-align:left">类型</th>
<th style="text-align:left">格式</th>
<th style="text-align:left">作用</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">测试函数</td>
<td style="text-align:left">函数名前缀为Test</td>
<td style="text-align:left">测试程序的一些逻辑行为是否正确</td>
</tr>
<tr>
<td style="text-align:left">基准函数</td>
<td style="text-align:left">函数名前缀为Benchmark</td>
<td style="text-align:left">测试函数的性能</td>
</tr>
<tr>
<td style="text-align:left">示例函数</td>
<td style="text-align:left">函数名前缀为Example</td>
<td style="text-align:left">为文档提供示例文档</td>
</tr>
</tbody>
</table>
</div>
<p><code>go test</code>命令会遍历所有的<code>*_test.go</code>文件中符合上述命名规则的函数，然后生成一个临时的main包用于调用相应的测试函数，然后构建并运行、报告测试结果，最后清理测试中生成的临时文件。</p>
<h3 id="测试函数"><a href="#测试函数" class="headerlink" title="测试函数"></a>测试函数</h3><p>示例：</p>
<p>定义一个<code>split</code>包：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> split</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;strings&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将s按照sep进行切割，返回一个字符串的切片</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Split</span><span class="params">(s, sep <span class="type">string</span>)</span></span> (ret []<span class="type">string</span>) &#123;</span><br><span class="line">    idx := strings.Index(s, sep)</span><br><span class="line">    <span class="keyword">for</span> idx &gt; <span class="number">-1</span> &#123;</span><br><span class="line">        ret = <span class="built_in">append</span>(ret, s[:idx])</span><br><span class="line">        s = s[idx+<span class="built_in">len</span>(sep):]</span><br><span class="line">        idx = strings.Index(s, sep)</span><br><span class="line">    &#125;</span><br><span class="line">    ret = <span class="built_in">append</span>(ret, s)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在当前目录下，我们创建一个<code>split_test.go</code>的测试文件，并定义一个测试函数如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> split</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;reflect&quot;</span></span><br><span class="line">    <span class="string">&quot;testing&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 测试</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestSplit</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">    got := Split(<span class="string">&quot;我是机器人&quot;</span>, <span class="string">&quot;是&quot;</span>)</span><br><span class="line">    want := []<span class="type">string</span>&#123;<span class="string">&quot;我&quot;</span>, <span class="string">&quot;机器人&quot;</span>&#125;</span><br><span class="line">    <span class="comment">//got := Split(&quot;a:b:c&quot;, &quot;:&quot;)</span></span><br><span class="line">    <span class="comment">//want := []string&#123;&quot;a&quot;, &quot;b&quot;, &quot;c&quot;&#125;</span></span><br><span class="line">    <span class="keyword">if</span> !reflect.DeepEqual(got, want) &#123;</span><br><span class="line">        t.Errorf(<span class="string">&quot;want:%v  go:%v&quot;</span>, want, got)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在<code>split</code>包路径下，执行<code>go test</code>命令</p>
<h1 id="多语言通信的基础"><a href="#多语言通信的基础" class="headerlink" title="多语言通信的基础"></a>多语言通信的基础</h1><h2 id="RPC基础"><a href="#RPC基础" class="headerlink" title="RPC基础"></a>RPC基础</h2><h3 id="什么是RPC"><a href="#什么是RPC" class="headerlink" title="什么是RPC"></a>什么是RPC</h3><ul>
<li>RPC（Remote Procedure Call）远程过程调用，简单的理解就是一个节点请求另一个节点提供的服务</li>
<li>对应RPC的 是本地过程调用，函数调用是最常见的本地调用过程</li>
<li>将本地过程调用编程远程过程调用会面临各种问题</li>
</ul>
<h4 id="本地过程调用"><a href="#本地过程调用" class="headerlink" title="本地过程调用"></a>本地过程调用</h4><p>一个简单的本地过程调用的例子：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    total = a + b</span><br><span class="line">    <span class="keyword">return</span> total</span><br><span class="line"></span><br><span class="line">total = add(<span class="number">1</span>, <span class="number">2</span>)</span><br><span class="line"><span class="built_in">print</span>(total)</span><br></pre></td></tr></table></figure>
<p>这个函数的调用过程：</p>
<ul>
<li>将1和2压入add函数的栈中</li>
<li>进入add函数，从栈中取出1和2，分别赋值给a和b</li>
<li>执行a + b 将结果赋值给局部的total并压栈</li>
<li>将栈中的值取出来赋值给全局的total</li>
</ul>
<h4 id="远程过程调用带来的问题"><a href="#远程过程调用带来的问题" class="headerlink" title="远程过程调用带来的问题"></a>远程过程调用带来的问题</h4><p>在远程调用时，我们需要执行的函数体是在远程的机器上的，也就是说，add是在另一个进程中执行的。这就带来了几个新问题：</p>
<ul>
<li><strong>call ID 映射</strong>    我们怎么告诉远程机器我们要调用add，而不是sub或者Foo呢？<ul>
<li>在本地调用中，函数体是直接通过函数指针来指定的，我们调用add，编译器就自动帮我们调用它相应的函数指针。</li>
<li>但是在远程调用中，函数指针是不行的，因为两个进程的地址空间是完全不一样的。所以，在RPC中，所有的函数都必须有自己的一个ID。这个ID在所有进程中都是唯一确定的。</li>
<li>客户端在做远程过程调用时，必须附上这个ID。然后我们还需要在客户端和服务端分别维护一个 {函数 &lt;—&gt; Call ID} 的对应表。两者的表不一定需要完全相同，但相同的函数对应的Call ID必须相同。</li>
<li>当客户端需要进行远程调用时，它就查一下这个表，找出相应的Call ID，然后把它传给服务端，服务端也通过查表，来确定客户端需要调用的函数，然后执行相应函数的代码。</li>
</ul>
</li>
<li><strong>序列化和反序列化</strong>    客户端怎么把参数值传给远程的函数呢？<ul>
<li>在本地调用中，我们只需要把参数压到栈里，然后让函数自己去栈里读就行。但是在远程过程调用时，客户端跟服务端是不同的进程，不能通过内存来传递参数。甚至有时候客户端和服务端使用的都不是同一种语言（比如服务端用C++，客户端用Java或者Python）</li>
<li>这时候就需要客户端把参数先转成一个字节流，传给服务端后，再把字节流转成自己能读取的格式。这个过程叫序列化和反序列化。同理，从服务端返回的值也需要序列化反序列化的过程</li>
</ul>
</li>
<li><strong>网络传输</strong>     远程调用往往用在网络上，客户端和服务端是通过网络连接的。所有的数据都需要通过网络传输，因此就需要有一个网络传输层。<ul>
<li>网络传输层需要把Call ID和序列化后的参数字节流传给服务端，然后再把序列化后的调用结果传回客户端。只要能完成这两者的，都可以作为传输层使用。</li>
<li>因此，它所使用的协议其实是不限的，能完成传输就行。尽管大部分RPC框架都使用TCP协议，但其实UDP也可以，而gRPC干脆就用了HTTP2。Java的Netty也属于这层的东西。</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210615090923.png" alt=""></p>
<h4 id="如何解决"><a href="#如何解决" class="headerlink" title="如何解决"></a>如何解决</h4><p>解决了上面三个机制，就能实现RPC了，具体过程如下：</p>
<p>client端解决的问题：</p>
<ul>
<li>将这个调用映射为Call ID。这里假设用最简单的字符串当Call ID的方法</li>
<li>将Call ID，a和b序列化。可以直接将它们的值以二进制形式打包</li>
<li>把2中得到的数据包发送给ServerAddr，这需要使用网络传输层</li>
<li>等待服务器返回结果</li>
<li>如果服务器调用成功，那么就将结果反序列化，并赋给total</li>
</ul>
<p>server端解决的问题：</p>
<ul>
<li>在本地维护一个Call ID到函数指针的映射call_id_map，可以用dict完成</li>
<li>等待请求，包括多线程的并发处理能力</li>
<li>得到一个请求后，将其数据包反序列化，得到Call ID</li>
<li>通过在call_id_map中查找，得到相应的函数指针</li>
<li>将a和b反序列化后，在本地调用add函数，得到结果</li>
<li>将结果序列化后通过网络返回给Client</li>
</ul>
<p>其中：</p>
<ul>
<li>Call ID映射可以直接使用函数字符串，也可以使用整数ID。映射表一般就是一个哈希表。</li>
<li>序列化反序列化可以自己写，也可以使用Protobuf或者FlatBuffers之类的。</li>
<li>网络传输库可以自己写socket，或者用asio，ZeroMQ，Netty之类。</li>
</ul>
<h3 id="rpc、http以及restful-之间的区别"><a href="#rpc、http以及restful-之间的区别" class="headerlink" title="rpc、http以及restful 之间的区别"></a>rpc、http以及restful 之间的区别</h3><h4 id="RPC-和-REST-区别是什么"><a href="#RPC-和-REST-区别是什么" class="headerlink" title="RPC 和 REST 区别是什么"></a>RPC 和 REST 区别是什么</h4><p>REST，是Representational State Transfer 的简写，中文描述表述性状态传递（是指某个瞬间状态的资源数据的快照，包括资源数据的内容、表述格式(XML、JSON)等信息）。</p>
<p>REST 是一种软件架构风格。这种风格的典型应用，就是HTTP。其因为简单、扩展性强的特点而广受开发者的青睐。</p>
<p>而RPC 呢，是 Remote Procedure Call Protocol 的简写，中文描述是远程过程调用，它可以实现客户端像调用本地服务(方法)一样调用服务器的服务(方法)。</p>
<p>RPC 可以基于 TCP/UDP，也可以基于 HTTP 协议进行传输的，按理说它和REST不是一个层面意义上的东西，不应该放在一起讨论，但是谁让REST这么流行呢，它是目前最流行的一套互联网应用程序的API设计标准，某种意义下，我们说 REST 可以其实就是指代 HTTP 协议。</p>
<h4 id="使用方式不同"><a href="#使用方式不同" class="headerlink" title="使用方式不同"></a>使用方式不同</h4><p>从使用上来看，HTTP 接口只关注服务提供方，对于客户端怎么调用并不关心。接口只要保证有客户端调用时，返回对应的数据就行了。而RPC则要求客户端接口保持和服务端的一致。</p>
<ul>
<li>REST 是服务端把方法写好，客户端并不知道具体方法。客户端只想获取资源，所以发起HTTP请求，而服务端接收到请求后根据URI经过一系列的路由才定位到方法上面去</li>
<li>RPC是服务端提供好方法给客户端调用，客户端需要知道服务端的具体类、具体方法，然后像调用本地方法一样直接调用它。</li>
</ul>
<h4 id="面向对象不同"><a href="#面向对象不同" class="headerlink" title="面向对象不同"></a>面向对象不同</h4><ul>
<li>从设计上来看，RPC，所谓的远程过程调用 ，是面向方法的 </li>
<li>REST：所谓的 Representational state transfer ，是面向资源的</li>
</ul>
<h4 id="序列化协议不同"><a href="#序列化协议不同" class="headerlink" title="序列化协议不同"></a>序列化协议不同</h4><p>接口调用通常包含两个部分，序列化和通信协议。</p>
<p>通信协议，上面已经提及了，REST 是 基于 HTTP 协议，而 RPC 可以基于 TCP/UDP，也可以基于 HTTP 协议进行传输的。</p>
<p>常见的序列化协议，有：json、xml、hession、protobuf、thrift、text、bytes等，REST 通常使用的是 JSON或者XML，而 RPC 使用的是 JSON-RPC，或者 XML-RPC。</p>
<h3 id="通过httpserver实现rpc"><a href="#通过httpserver实现rpc" class="headerlink" title="通过httpserver实现rpc"></a>通过httpserver实现rpc</h3><p>把远程的函数变成一个http请求</p>
<p>自己实现一个简易RPC：</p>
<p>server</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> urllib.parse <span class="keyword">import</span> urlparse, parse_qsl</span><br><span class="line"><span class="keyword">from</span> http.server <span class="keyword">import</span> HTTPServer, BaseHTTPRequestHandler</span><br><span class="line"></span><br><span class="line">host = (<span class="string">&#x27;&#x27;</span>, <span class="number">8003</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AddHandler</span>(<span class="title class_ inherited__">BaseHTTPRequestHandler</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">do_GET</span>(<span class="params">self</span>):</span><br><span class="line">        parsed_url = urlparse(self.path)</span><br><span class="line">        qs = <span class="built_in">dict</span>(parse_qsl(parsed_url.query))</span><br><span class="line">        a = <span class="built_in">int</span>(qs.get(<span class="string">&quot;a&quot;</span>, <span class="number">0</span>))</span><br><span class="line">        b = <span class="built_in">int</span>(qs.get(<span class="string">&quot;b&quot;</span>, <span class="number">0</span>))</span><br><span class="line">        self.send_response(<span class="number">200</span>)</span><br><span class="line">        self.send_header(<span class="string">&quot;content-type&quot;</span>, <span class="string">&quot;application/json&quot;</span>)</span><br><span class="line">        self.end_headers()</span><br><span class="line">        self.wfile.write(json.dumps(</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="string">&quot;result&quot;</span>: a + b</span><br><span class="line">            &#125;</span><br><span class="line">        ).encode(<span class="string">&quot;utf-8&quot;</span>))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    server = HTTPServer(host, AddHandler)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;启动服务器&quot;</span>)</span><br><span class="line">    server.serve_forever()</span><br></pre></td></tr></table></figure>
<p>client:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">client</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, url</span>):</span><br><span class="line">        self.url = url</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, a, b</span>):</span><br><span class="line">        resp = requests.get(<span class="string">f&quot;<span class="subst">&#123;self.url&#125;</span>/?a=<span class="subst">&#123;a&#125;</span>&amp;b=<span class="subst">&#123;b&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> json.loads(resp.text).get(<span class="string">&quot;result&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">client = client(<span class="string">&quot;http://127.0.0.1:8003&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(client.add(<span class="number">1</span>, <span class="number">4</span>))</span><br></pre></td></tr></table></figure>
<p>总的来说，本地程序调用的过程大致可以分为几个步骤和阶段：</p>
<ul>
<li>开发者开发好的程序，并进行编译，编译成机器认可的可执行文件</li>
<li>运行可执行文件，调用对应的功能方法，期间会读取可执行文件中的机器指令，进行入栈，出栈赋值等操作。此时，计算机由可执行程序所在的进程控制</li>
<li>调用结束，所有的内存数据出栈，程序执行结束。计算机继续由操作系统进行控制</li>
</ul>
<p>远程过程调用是在两台或者多台不同的物理机器上实现的调用，其间要跨越网络进行调用。因此，我们再想通过前文本地方法调用的形式完成功能调用，就无法实现了，因为编译器无法通过编译的可执行文件来调用远程机器上的程序方法。因此需要采用RPC的方式来实现远端服务器上的程序方法的调用。</p>
<p>RPC技术内部原理是通过两种技术的组合来实现的：<strong>本地方法调用 和 网络通信技术</strong></p>
<h3 id="RPC开发的要素分析"><a href="#RPC开发的要素分析" class="headerlink" title="RPC开发的要素分析"></a>RPC开发的要素分析</h3><p>RPC技术在架构设计上有四部分组成，分别是：<strong>客户端、客户端存根、服务端、服务端存根</strong></p>
<ul>
<li><strong>客户端(Client)：</strong>服务调用发起方，也称为服务消费者</li>
<li><strong>客户端存根(Client  Stub)：</strong>该程序运行在客户端所在的计算机机器上，主要用来存储要调用的服务器的地址，另外，该程序还负责将客户端请求远端服务器程序的数据信息打包成数据包，通过网络发送给服务端Stub程序；其次，还要接收服务端Stub程序发送的调用结果数据包，并解析返回给客户端</li>
<li><strong>服务端(Server)：</strong>远端的计算机机器上运行的程序，其中有客户端要调用的方法</li>
<li><strong>服务端存根(Server Stub)：</strong>接收客户Stub程序通过网络发送的请求消息数据包，并调用服务端中真正的程序功能方法，完成功能调用；其次，将服务端执行调用的结果进行数据处理打包发送给客户端Stub程序</li>
</ul>
<p>实际上，如果我们想要在网络中的任意两台计算机上实现远程调用过程，要解决很多问题，比如：</p>
<ul>
<li>两台物理机器在网络中要建立稳定可靠的通信连接</li>
<li>两台服务器的通信协议的定义问题，即两台服务器上的程序如何识别对方的请求和返回结果。也就是说两台计算机必须都能够识别对方发来的信息，并且能够识别出其中的请求含义和返回含义，然后才能进行处理。这其实就是通信协议所要完成的工作</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210615092334.png" alt=""></p>
<p>在上述图中，通过1-10的步骤图解的形式，说明了RPC每一步的调用过程。具体描述为：</p>
<ul>
<li>1、客户端想要发起一个远程过程调用，首先通过调用本地客户端Stub程序的方式调用想要使用的功能方法名；</li>
<li>2、客户端Stub程序接收到了客户端的功能调用请求，<strong>将客户端请求调用的方法名，携带的参数等信息做序列化操作，并打包成数据包。</strong></li>
<li>3、客户端Stub查找到远程服务器程序的IP地址，调用Socket通信协议，通过网络发送给服务端。</li>
<li>4、服务端Stub程序接收到客户端发送的数据包信息，并<strong>通过约定好的协议将数据进行反序列化，得到请求的方法名和请求参数等信息。</strong></li>
<li>5、服务端Stub程序准备相关数据，<strong>调用本地Server对应的功能方法进行，并传入相应的参数，进行业务处理。</strong></li>
<li>6、服务端程序根据已有业务逻辑执行调用过程，待业务执行结束，将执行结果返回给服务端Stub程序。</li>
<li>7、服务端Stub程序<strong>将程序调用结果按照约定的协议进行序列化，</strong>并通过网络发送回客户端Stub程序。</li>
<li>8、客户端Stub程序接收到服务端Stub发送的返回数据，<strong>对数据进行反序列化操作，</strong>并将调用返回的数据传递给客户端请求发起者。</li>
<li>9、客户端请求发起者得到调用结果，整个RPC调用过程结束。</li>
</ul>
<h3 id="基于XML的RPC调用"><a href="#基于XML的RPC调用" class="headerlink" title="基于XML的RPC调用"></a>基于XML的RPC调用</h3><p>服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xmlrpc.server <span class="keyword">import</span> SimpleXMLRPCServer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Calculater</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="keyword">return</span> x + y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">multiply</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="keyword">return</span> x * y</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">subtract</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">abs</span>(x - y)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">divide</span>(<span class="params">self, x, y</span>):</span><br><span class="line">        <span class="keyword">return</span> x / y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">obj = Calculater()</span><br><span class="line">server = SimpleXMLRPCServer((<span class="string">&quot;localhost&quot;</span>, <span class="number">8088</span>))</span><br><span class="line"><span class="comment"># 将实例注册给rpc server</span></span><br><span class="line">server.register_instance(obj)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;Listening on port 8088&quot;</span>)</span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> xmlrpc <span class="keyword">import</span> client</span><br><span class="line"></span><br><span class="line">server = client.ServerProxy(<span class="string">&quot;http://localhost:8088&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(server.multiply(<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<p>通过 server_proxy 对象就可以远程调用 RPC server的函数了</p>
<h3 id="基于json实现RPC调用"><a href="#基于json实现RPC调用" class="headerlink" title="基于json实现RPC调用"></a>基于json实现RPC调用</h3><p>SimpleXMLRPCServer 是基于 xml-rpc 实现的远程调用。</p>
<p>上面我们也提到 除了 xml-rpc 之外，还有 json-rpc 协议。</p>
<p>那 python 如何实现基于 json-rpc 协议呢？</p>
<p>答案有很多，很多web框架其自身都自己实现了json-rpc，但我们要独立这些框架之外，要寻求一种较为干净的解决方案，我们使用 <code>jsonrpclib</code>：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/tcalmant/jsonrpclib/">https://github.com/tcalmant/jsonrpclib/</a></p>
<p>安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install jsonrpclib-pelix</span><br></pre></td></tr></table></figure>
<p>服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> jsonrpclib.SimpleJSONRPCServer <span class="keyword">import</span> SimpleJSONRPCServer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">a, b</span>):</span><br><span class="line">    <span class="keyword">return</span> a + b</span><br><span class="line"></span><br><span class="line"><span class="comment"># 1、实例化server</span></span><br><span class="line">server = SimpleJSONRPCServer((<span class="string">&#x27;localhost&#x27;</span>, <span class="number">8080</span>))</span><br><span class="line"><span class="comment"># 2、将函数注册到server中</span></span><br><span class="line">server.register_function(add)</span><br><span class="line"><span class="comment"># 3、启动server</span></span><br><span class="line">server.serve_forever()</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> jsonrpclib</span><br><span class="line"></span><br><span class="line">server = jsonrpclib.ServerProxy(<span class="string">&#x27;http://localhost:8080&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(server.add(<span class="number">2</span>, <span class="number">3</span>))</span><br></pre></td></tr></table></figure>
<h3 id="zerorpc实现RPC调用"><a href="#zerorpc实现RPC调用" class="headerlink" title="zerorpc实现RPC调用"></a>zerorpc实现RPC调用</h3><p>zerorpc 是利用 zeroMQ消息队列 + msgpack 消息序列化(二进制) 来实现类似 grpc 的功能，跨语言远程调用。</p>
<p>主要使用到 zeroMQ 的通信模式是 ROUTER–DEALER，模拟 grpc 的  请求-响应式 和 应答流式 RPC ：zerorpc 还支持 PUB-SUB 通信模式的远程调用。</p>
<p>zerorpc实际上会依赖msgpack-python, pyzmq, future, greenlet, gevent</p>
<p><a target="_blank" rel="noopener" href="https://github.com/0rpc/zerorpc-python">https://github.com/0rpc/zerorpc-python</a></p>
<h4 id="一元调用"><a href="#一元调用" class="headerlink" title="一元调用"></a>一元调用</h4><p>服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">HelloRPC</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">hello</span>(<span class="params">self, name</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Hello, %s&quot;</span> % name</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1、实例化一个server</span></span><br><span class="line"><span class="comment"># 2、绑定业务代码到server中</span></span><br><span class="line"><span class="comment"># 3、启动server</span></span><br><span class="line">s = zerorpc.Server(HelloRPC())</span><br><span class="line">s.bind(<span class="string">&quot;tcp://0.0.0.0:4242&quot;</span>)</span><br><span class="line">s.run()</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line">c = zerorpc.Client()</span><br><span class="line">c.connect(<span class="string">&quot;tcp://127.0.0.1:4242&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(c.hello(<span class="string">&quot;RPC&quot;</span>))</span><br></pre></td></tr></table></figure>
<h4 id="流式响应"><a href="#流式响应" class="headerlink" title="流式响应"></a>流式响应</h4><p>服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StreamingRPC</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line"><span class="meta">    @zerorpc.stream  </span><span class="comment"># @zerorpc.stream这里的函数修饰是必须的，否则会有异常，如TypeError: can’t serialize</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">streaming_range</span>(<span class="params">self, fr, to, step</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">range</span>(fr, to, step)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">s = zerorpc.Server(StreamingRPC())</span><br><span class="line">s.bind(<span class="string">&quot;tcp://0.0.0.0:4242&quot;</span>)</span><br><span class="line">s.run()</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line">c = zerorpc.Client()</span><br><span class="line">c.connect(<span class="string">&quot;tcp://127.0.0.1:4242&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> c.streaming_range(<span class="number">10</span>, <span class="number">20</span>, <span class="number">2</span>):</span><br><span class="line">    <span class="built_in">print</span>(item)</span><br></pre></td></tr></table></figure>
<h4 id="传入多个参数"><a href="#传入多个参数" class="headerlink" title="传入多个参数"></a>传入多个参数</h4><p>服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">myRPC</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">listinfo</span>(<span class="params">self,message</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;get info : %s&quot;</span>%message</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">getpow</span>(<span class="params">self,n,m</span>):</span><br><span class="line">        <span class="keyword">return</span> n**m           </span><br><span class="line"></span><br><span class="line">s = zerorpc.Server(myRPC())</span><br><span class="line">s.bind(<span class="string">&quot;tcp://0.0.0.0:4242&quot;</span>)</span><br><span class="line">s.run()</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> zerorpc</span><br><span class="line"></span><br><span class="line">c = zerorpc.Client()</span><br><span class="line">c.connect(<span class="string">&quot;tcp://127.0.0.1:4242&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(c.listinfo(<span class="string">&quot;this is test string&quot;</span>))</span><br><span class="line"><span class="built_in">print</span>(c.getpow(<span class="number">2</span>,<span class="number">5</span>))</span><br></pre></td></tr></table></figure>
<h2 id="go语言的RPC调用"><a href="#go语言的RPC调用" class="headerlink" title="go语言的RPC调用"></a>go语言的RPC调用</h2><h3 id="简单使用"><a href="#简单使用" class="headerlink" title="简单使用"></a>简单使用</h3><p>Go语言的RPC包的路径为net/rpc，也就是放在了net包目录下面。因此我们可以猜测该RPC包是建立在net包基础之上的。</p>
<p>服务端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    *reply = <span class="string">&quot;hello &quot;</span> + request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    _ = rpc.RegisterName(<span class="string">&quot;HelloService&quot;</span>, &amp;HelloService&#123;&#125;)</span><br><span class="line">    listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:1234&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;监听端口失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    conn, err := listener.Accept()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;建立链接失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.ServeConn(conn)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// go语言的rpc序列化协议是什么(Gob)？能否替换成常见的序列化</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中Hello方法必须满足Go语言的RPC规则:</p>
<ul>
<li>方法只能有两个可序列化的参数，其中第二个参数是指针类型，并且返回一个error类型，同时必须是公开的方法</li>
</ul>
<p>然后就可以将HelloService类型的对象注册为一个RPC服务：(TCP RPC服务)</p>
<p>其中<code>rpc.Register</code>函数调用会将对象类型中所有满足RPC规则的对象方法注册为RPC函数，所有注册的方法会放在“HelloService”服务空间之下。然后我们建立一个唯一的TCP链接，并且通过rpc.ServeConn函数在该TCP链接上为对方提供RPC服务</p>
<p>客户端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1、建立连接</span></span><br><span class="line">    client, err := rpc.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:1234&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;连接失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> reply *<span class="type">string</span> = <span class="built_in">new</span>(<span class="type">string</span>)</span><br><span class="line">    err = client.Call(<span class="string">&quot;HelloService.Hello&quot;</span>, <span class="string">&quot;cwz&quot;</span>, reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;调用失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(*reply)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先是通过<code>rpc.Dial</code>拨号RPC服务，然后通过<code>client.Call</code>调用具体的RPC方法。在调用<code>client.Call</code>时，第一个参数是用点号链接的RPC服务名字和方法名字，第二和第三个参数分别我们定义RPC方法的两个参数。</p>
<h3 id="RPC支持JSON"><a href="#RPC支持JSON" class="headerlink" title="RPC支持JSON"></a>RPC支持JSON</h3><p>标准库的RPC默认采用Go语言特有的gob编码，因此从其它语言调用Go语言实现的RPC服务将比较困难。</p>
<p>在互联网的微服务时代，每个RPC以及服务的使用者都可能采用不同的编程语言，因此跨语言是互联网时代RPC的一个首要条件。</p>
<p>得益于RPC的框架设计，Go语言的RPC其实也是很容易实现跨语言支持的。</p>
<p>Go语言的RPC框架有两个比较有特色的设计：</p>
<ul>
<li>一个是RPC数据打包时可以通过插件实现自定义的编码和解码</li>
<li>另一个是RPC建立在抽象的io.ReadWriteCloser接口之上的，我们可以将RPC架设在不同的通讯协议之上</li>
</ul>
<p>首先是基于json编码重新实现RPC服务：</p>
<p><strong>服务端</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc/jsonrpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    *reply = <span class="string">&quot;hello, &quot;</span> + request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    listener, _ := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:1234&quot;</span>)</span><br><span class="line">    _ = rpc.RegisterName(<span class="string">&quot;HelloService&quot;</span>, &amp;HelloService&#123;&#125;)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        conn, _ := listener.Accept()</span><br><span class="line">        <span class="keyword">go</span> rpc.ServeCodec(jsonrpc.NewServerCodec(conn))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代码中最大的变化是用rpc.ServeCodec函数替代了rpc.ServeConn函数，传入的参数是针对服务端的json编解码器</p>
<p><strong>客户端</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc/jsonrpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 1、建立连接</span></span><br><span class="line">    conn, err := net.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:1234&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;连接失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> reply <span class="type">string</span></span><br><span class="line">    client := rpc.NewClientWithCodec(jsonrpc.NewClientCodec(conn))</span><br><span class="line">    err = client.Call(<span class="string">&quot;HelloService.Hello&quot;</span>, <span class="string">&quot;cwz&quot;</span>, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;调用失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(reply)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// &#123;&quot;method&quot;: &quot;HelloService.Hello&quot;, &quot;params&quot;: [&quot;hello&quot;], &quot;id&quot;: 0&#125;</span></span><br></pre></td></tr></table></figure>
<p><strong>python客户端</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"></span><br><span class="line">req = &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;params&quot;</span>: [<span class="string">&quot;cwz&quot;</span>],</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;HelloService.Hello&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">client = socket.create_connection((<span class="string">&quot;localhost&quot;</span>, <span class="number">1234</span>))</span><br><span class="line">client.sendall(json.dumps(req).encode())</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取服务器返回的数据</span></span><br><span class="line">rsp = client.recv(<span class="number">1024</span>)</span><br><span class="line">rsp = json.loads(rsp.decode())</span><br><span class="line"><span class="built_in">print</span>(rsp)   <span class="comment"># &#123;&#x27;id&#x27;: 0, &#x27;result&#x27;: &#x27;hello, cwz&#x27;, &#x27;error&#x27;: None&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="基于http的RPC"><a href="#基于http的RPC" class="headerlink" title="基于http的RPC"></a>基于http的RPC</h3><p>前面我们使用了支持json传输的RPC，但是是基于TCP协议的，不是很好用。</p>
<p>现在使用http协议改造这个代码</p>
<p><strong>服务端</strong>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;io&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc/jsonrpc&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    *reply = <span class="string">&quot;hello, &quot;</span> + request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    _ = rpc.RegisterName(<span class="string">&quot;HelloService&quot;</span>, &amp;HelloService&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    http.HandleFunc(<span class="string">&quot;/jsonrpc&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> conn io.ReadWriteCloser = <span class="keyword">struct</span> &#123;</span><br><span class="line">            io.Writer</span><br><span class="line">            io.ReadCloser</span><br><span class="line">        &#125;&#123;</span><br><span class="line">            ReadCloser: r.Body,</span><br><span class="line">            Writer:     w,</span><br><span class="line">        &#125;</span><br><span class="line">        _ = rpc.ServeRequest(jsonrpc.NewServerCodec(conn))</span><br><span class="line">    &#125;)</span><br><span class="line">    _ = http.ListenAndServe(<span class="string">&quot;:1234&quot;</span>, <span class="literal">nil</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>python客户端</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">req = &#123;</span><br><span class="line">    <span class="string">&quot;id&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="string">&quot;params&quot;</span>: [<span class="string">&quot;cwz&quot;</span>],</span><br><span class="line">    <span class="string">&quot;method&quot;</span>: <span class="string">&quot;HelloService.Hello&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rsp = requests.post(<span class="string">&quot;http://localhost:1234/jsonrpc&quot;</span>, json=req)</span><br><span class="line"><span class="built_in">print</span>(rsp.text)  <span class="comment"># &#123;&quot;id&quot;:0,&quot;result&quot;:&quot;hello, cwz&quot;,&quot;error&quot;:null&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="进一步改进RPC调用过程"><a href="#进一步改进RPC调用过程" class="headerlink" title="进一步改进RPC调用过程"></a>进一步改进RPC调用过程</h3><p>前面的rpc调用虽然简单，但是和普通的http的调用差异不大，需要做出改进</p>
<h4 id="serviceName统一和名称冲突的问题"><a href="#serviceName统一和名称冲突的问题" class="headerlink" title="serviceName统一和名称冲突的问题"></a>serviceName统一和名称冲突的问题</h4><ul>
<li>server端和client端如何统一serviceName</li>
<li>多个server的包中serviceName同名的问题</li>
</ul>
<p>新建handler/handler.go文件内容如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handler</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HelloServiceName = <span class="string">&quot;handler/HelloService&quot;</span></span><br></pre></td></tr></table></figure>
<p>服务端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">    <span class="string">&quot;start/rpc_ch01/handler&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span> &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    *reply = <span class="string">&quot;hello &quot;</span>+ request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    _ = rpc.RegisterName(handler.HelloServiceName, &amp;HelloService&#123;&#125;)</span><br><span class="line">    listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:1234&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;监听端口失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    conn, err := listener.Accept()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;建立链接失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.ServeConn(conn)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">    <span class="string">&quot;start/rpc_ch01/handler&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    client, err := rpc.Dial(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;localhost:1234&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;连接到服务器失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> reply <span class="type">string</span></span><br><span class="line">    err = client.Call(handler.HelloServiceName+<span class="string">&quot;.Hello&quot;</span>, <span class="string">&quot;imooc&quot;</span>, &amp;reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;服务调用失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(reply)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="继续屏蔽HelloServiceName和Hello函数名称"><a href="#继续屏蔽HelloServiceName和Hello函数名称" class="headerlink" title="继续屏蔽HelloServiceName和Hello函数名称"></a>继续屏蔽HelloServiceName和Hello函数名称</h4><p>handler代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> handler</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloService <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *HelloService)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    *reply = <span class="string">&quot;hello &quot;</span> + request</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端代理：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> server_proxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HelloServiceName = <span class="string">&quot;handler/HelloService&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloServiceInterface <span class="keyword">interface</span> &#123;</span><br><span class="line">    Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">RegisterHelloService</span><span class="params">(srv HelloServiceInterface)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> rpc.RegisterName(HelloServiceName, srv)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line">    <span class="string">&quot;start/rpc_ch01/handler&quot;</span></span><br><span class="line">    <span class="string">&quot;start/rpc_ch01/server_proxy&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    hellohandler := &amp;handler.HelloService&#123;&#125;</span><br><span class="line">    _ = server_proxy.RegisterHelloService(hellohandler)</span><br><span class="line">    listener, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;:1234&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;监听端口失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    conn, err := listener.Accept()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;建立链接失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    rpc.ServeConn(conn)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端代理：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> client_proxy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;net/rpc&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> HelloServiceName = <span class="string">&quot;handler/HelloService&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> HelloServiceClient <span class="keyword">struct</span>&#123;</span><br><span class="line">    *rpc.Client</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewClient</span><span class="params">(address <span class="type">string</span>)</span></span> HelloServiceClient &#123;</span><br><span class="line">    conn, err := rpc.Dial(<span class="string">&quot;tcp&quot;</span>, address)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;连接服务器错误&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> HelloServiceClient&#123;conn&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *HelloServiceClient)</span></span> Hello(request <span class="type">string</span>, reply *<span class="type">string</span>) <span class="type">error</span> &#123;</span><br><span class="line">    err := c.Call(HelloServiceName+<span class="string">&quot;.Hello&quot;</span>, request, reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;start/rpc_ch01/client_proxy&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    client := client_proxy.NewClient(<span class="string">&quot;localhost:1234&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> reply <span class="type">string</span></span><br><span class="line">    err := client.Hello(<span class="string">&quot;cwz&quot;</span>,&amp;reply)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;调用失败&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(reply)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gRPC入门"><a href="#gRPC入门" class="headerlink" title="gRPC入门"></a>gRPC入门</h2><h3 id="gRPC和protobuf"><a href="#gRPC和protobuf" class="headerlink" title="gRPC和protobuf"></a>gRPC和protobuf</h3><p>gRPC 是一个高性能、开源和通用的 RPC 框架，面向移动和 HTTP/2 设计。目前提供 C、Java 和 Go 语言版本，分别是：<a target="_blank" rel="noopener" href="https://github.com/grpc/grpc">grpc</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-java">grpc-java</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-go">grpc-go</a>. 其中 C 版本支持 <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc">C</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/cpp">C++</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/node">Node.js</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/python">Python</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/ruby">Ruby</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/objective-c">Objective-C</a>, <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/php">PHP</a> 和 <a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/src/csharp">C#</a> 支持</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210615143530.png" alt=""></p>
<ul>
<li>习惯用 <code>Json、XML</code> 数据存储格式的你们，相信大多都没听过<code>Protocol Buffer</code></li>
<li><code>Protocol Buffer</code> 其实 是 <code>Google</code>出品的一种轻量 &amp; 高效的结构化数据存储格式，性能好</li>
<li>protobuf经历了protobuf2和protobuf3，pb3比pb2简化了很多，目前主流的版本是pb3</li>
</ul>
<p>protobuf的优点：</p>
<ul>
<li>性能<ul>
<li>压缩性好</li>
<li>序列化和反序列化快，比json和xml快2~100倍</li>
<li>传输速度快</li>
</ul>
</li>
<li>便捷性<ul>
<li>使用简单，自动生成序列化和反序列化代码</li>
<li>维护成本低，只维护proto文件</li>
<li>向后兼容，不必破快旧格式</li>
<li>加密性好</li>
</ul>
</li>
<li>跨语言<ul>
<li>跨平台</li>
<li>支持各种主流语言</li>
</ul>
</li>
</ul>
<p>protobuf的缺点：</p>
<ul>
<li>通用性差，json可以任何语言都支持，但是protobuf需要专门的解析库</li>
<li>自解释性差，只有通过proto文件才能了解数据结构</li>
</ul>
<h3 id="python下protobuf体验"><a href="#python下protobuf体验" class="headerlink" title="python下protobuf体验"></a>python下protobuf体验</h3><h4 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install grpcio #安装grpc</span><br><span class="line">python -m pip install grpcio-tools #安装grpc tools</span><br></pre></td></tr></table></figure>
<h4 id="体验protobuf3"><a href="#体验protobuf3" class="headerlink" title="体验protobuf3"></a>体验protobuf3</h4><p>新建<code>hello.proto</code>文件</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;   <span class="comment">// name表示名称，name的编号为1，1不是name的值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="生成proto的python文件"><a href="#生成proto的python文件" class="headerlink" title="生成proto的python文件"></a>生成proto的python文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m grpc_tools.protoc --python_out=. --grpc_python_out=. -I. hello.proto</span><br></pre></td></tr></table></figure>
<h4 id="查看protobuf生成的代码"><a href="#查看protobuf生成的代码" class="headerlink" title="查看protobuf生成的代码"></a>查看protobuf生成的代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> protobuf3_test.proto <span class="keyword">import</span> hello_pb2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成的pb文件不要去改</span></span><br><span class="line">request = hello_pb2.HelloRequest()</span><br><span class="line">request.name = <span class="string">&quot;cwz&quot;</span></span><br><span class="line">res_str = request.SerializeToString()</span><br><span class="line"><span class="built_in">print</span>(res_str)  <span class="comment"># b&#x27;\n\x03cwz&#x27;</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(res_str))  <span class="comment"># 5</span></span><br><span class="line"></span><br><span class="line">res_json = &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;cwz&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(json.dumps(res_json)))  <span class="comment"># 15</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如何通过字符串反向生成字符串</span></span><br><span class="line">request2 = hello_pb2.HelloRequest()</span><br><span class="line">request2.ParseFromString(res_str)</span><br><span class="line"><span class="built_in">print</span>(request2)  <span class="comment"># name: &quot;cwz&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 和json对比一下</span></span><br></pre></td></tr></table></figure>
<h3 id="python体验grpc开发"><a href="#python体验grpc开发" class="headerlink" title="python体验grpc开发"></a>python体验grpc开发</h3><p>helloworld.proto：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成proto的python文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m grpc_tools.protoc --python_out=. --grpc_python_out=. -I. helloworld.proto</span><br></pre></td></tr></table></figure>
<p><strong>python下解决grpc import路径出错的bug</strong>：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/issues/1491">https://github.com/protocolbuffers/protobuf/issues/1491</a></p>
<p>服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> grpc_hello.proto <span class="keyword">import</span> helloworld_pb2, helloworld_pb2_grpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Greeter</span>(helloworld_pb2_grpc.GreeterServicer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">SayHello</span>(<span class="params">self, request, context</span>):</span><br><span class="line">        <span class="keyword">return</span> helloworld_pb2.HelloReply(message=<span class="string">f&quot;你好, <span class="subst">&#123;request.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 1、实例化server</span></span><br><span class="line">    server = grpc.server(ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    <span class="comment"># 2、注册逻辑到server中</span></span><br><span class="line">    helloworld_pb2_grpc.add_GreeterServicer_to_server(Greeter(), server)</span><br><span class="line">    <span class="comment"># 3、启动server</span></span><br><span class="line">    server.add_insecure_port(<span class="string">&#x27;127.0.0.1:50051&#x27;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> grpc_hello.proto <span class="keyword">import</span> helloworld_pb2_grpc, helloworld_pb2</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> grpc.insecure_channel(<span class="string">&quot;localhost:50051&quot;</span>) <span class="keyword">as</span> channel:</span><br><span class="line">        stub = helloworld_pb2_grpc.GreeterStub(channel)</span><br><span class="line">        rsp: helloworld_pb2.HelloReply = stub.SayHello(helloworld_pb2.HelloRequest(name=<span class="string">&quot;cwz&quot;</span>))</span><br><span class="line">        <span class="built_in">print</span>(rsp.message)  <span class="comment"># 你好, cwz</span></span><br></pre></td></tr></table></figure>
<h3 id="go体验grpc开发"><a href="#go体验grpc开发" class="headerlink" title="go体验grpc开发"></a>go体验grpc开发</h3><p>下载工具：<a target="_blank" rel="noopener" href="https://github.com/protocolbuffers/protobuf/releases">https://github.com/protocolbuffers/protobuf/releases</a></p>
<p>注意：protoc的版本需要和golang/protobuf保持一致</p>
<p>下载完成后解压后记得将路径添加到环境变量中</p>
<p>下载go的依赖包：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/golang/protobuf/protoc-gen-go</span><br></pre></td></tr></table></figure>
<p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成go文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I . goods.proto --go_out=plugins=grpc:.</span><br></pre></td></tr></table></figure>
<p>服务端代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span></span> SayHello(ctx context.Context, request *proto.HelloRequest) (*proto.HelloReply, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;proto.HelloReply&#123;</span><br><span class="line">        Message: <span class="string">&quot;hello, &quot;</span> + request.Name,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    server := grpc.NewServer()</span><br><span class="line">    proto.RegisterGreeterServer(server, &amp;Server&#123;&#125;)</span><br><span class="line">    listen, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:8080&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to listen: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    err = server.Serve(listen)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to start grpc: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端代码：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;127.0.0.1:8000&quot;</span>, grpc.WithInsecure())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    c := proto.NewGreeterClient(conn)</span><br><span class="line">    r, err := c.SayHello(context.Background(), &amp;proto.HelloRequest&#123;Name: <span class="string">&quot;cwz&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(r.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gRPC的流模式定义"><a href="#gRPC的流模式定义" class="headerlink" title="gRPC的流模式定义"></a>gRPC的流模式定义</h3><p>grpc 中的 stream，srteam 顾名思义就是 一种流，可以源源不断的推送数据，很适合传输一些大数据，或者 服务端 和 客户端 长时间 数据交互，比如 客户端 可以向 服务端 订阅 一个数据，服务端 就 可以利用 stream ，源源不断地推送数据。</p>
<p>grpc四种模式：</p>
<ul>
<li>简单模式。客户端发起一次请求，服务端响应一个数据</li>
<li>服务端数据流。客户端发起一次请求，服务端返回一段连续的数据流</li>
<li>客户端数据流。客户端源源不断的向服务器发送数据流，发送结束后，由服务端返回一个响应</li>
<li>双向数据量。客户端和服务端都可以向对方发送数据流，这个时候双方的数据可以同时互相发送，实时交互。</li>
</ul>
<p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetStream(StreamReqData) <span class="keyword">returns</span> (stream StreamResData)</span>;  <span class="comment">// 服务端流模式</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> PutStream(stream StreamReqData) <span class="keyword">returns</span> (StreamResData)</span>;  <span class="comment">// 客户端流模式</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> AllStream(stream StreamReqData) <span class="keyword">returns</span> (stream StreamResData)</span>; <span class="comment">// 双向流模式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">StreamReqData</span>&#123;</span><br><span class="line">  <span class="type">string</span> data = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">StreamResData</span>&#123;</span><br><span class="line">  <span class="type">string</span> data = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>服务端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/stream_rpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> PORT = <span class="string">&quot;:50052&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> GetStream(req *proto.StreamReqData, res proto.Greeter_GetStreamServer) <span class="type">error</span> &#123;</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        i++</span><br><span class="line">        _ = res.Send(&amp;proto.StreamResData&#123;</span><br><span class="line">            Data: fmt.Sprintf(<span class="string">&quot;%v&quot;</span>, time.Now().Unix()),</span><br><span class="line">        &#125;)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">10</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> PutStream(cliStr proto.Greeter_PutStreamServer) <span class="type">error</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        recv, err := cliStr.Recv()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(recv)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> AllStream(allStr proto.Greeter_AllStreamServer) <span class="type">error</span> &#123;</span><br><span class="line">    wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            data, _ := allStr.Recv()</span><br><span class="line">            fmt.Println(<span class="string">&quot;收到客户端消息：&quot;</span> + data.Data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            _ = allStr.Send(&amp;proto.StreamResData&#123;Data: <span class="string">&quot;我是服务器&quot;</span>&#125;)</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    wg.Wait()</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    s := grpc.NewServer()</span><br><span class="line">    proto.RegisterGreeterServer(s, &amp;server&#123;&#125;)</span><br><span class="line">    listen, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, PORT)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    err = s.Serve(listen)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to start grpc: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;sync&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/stream_rpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;127.0.0.1:50052&quot;</span>, grpc.WithInsecure())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务端流模式</span></span><br><span class="line">    c := proto.NewGreeterClient(conn)</span><br><span class="line">    res, _ := c.GetStream(context.Background(), &amp;proto.StreamReqData&#123;Data: <span class="string">&quot;cwz&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        recv, err := res.Recv()</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        fmt.Println(recv)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 客户端流模式</span></span><br><span class="line">    putStream, _ := c.PutStream(context.Background())</span><br><span class="line">    i := <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        i++</span><br><span class="line">        _ = putStream.Send(&amp;proto.StreamReqData&#123;</span><br><span class="line">            Data: fmt.Sprintf(<span class="string">&quot;cwz%d&quot;</span>, i),</span><br><span class="line">        &#125;)</span><br><span class="line">        time.Sleep(time.Second)</span><br><span class="line">        <span class="keyword">if</span> i &gt; <span class="number">10</span> &#123;</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 双向流模式</span></span><br><span class="line">    allStr, _ := c.AllStream(context.Background())</span><br><span class="line">    wg := sync.WaitGroup&#123;&#125;</span><br><span class="line">    wg.Add(<span class="number">2</span>)</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            data, _ := allStr.Recv()</span><br><span class="line">            fmt.Println(<span class="string">&quot;收到服务端消息：&quot;</span> + data.Data)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">defer</span> wg.Done()</span><br><span class="line">        <span class="keyword">for</span> &#123;</span><br><span class="line">            _ = allStr.Send(&amp;proto.StreamReqData&#123;Data: <span class="string">&quot;我是客户端&quot;</span>&#125;)</span><br><span class="line">            time.Sleep(time.Second)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;()</span><br><span class="line">    wg.Wait()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="深入protobuf"><a href="#深入protobuf" class="headerlink" title="深入protobuf"></a>深入protobuf</h2><p>protobuf的官方文档 <a target="_blank" rel="noopener" href="https://developers.google.com/protocol-buffers/docs/proto3">https://developers.google.com/protocol-buffers/docs/proto3</a></p>
<h3 id="option-go-package的作用"><a href="#option-go-package的作用" class="headerlink" title="option go_package的作用"></a>option go_package的作用</h3><p>指明生成的这个文件放在哪个地方</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br></pre></td></tr></table></figure>
<p>go_package不会对python、java产生影响</p>
<h3 id="proto文件不同步出现的问题"><a href="#proto文件不同步出现的问题" class="headerlink" title="proto文件不同步出现的问题"></a>proto文件不同步出现的问题</h3><p>golang的hello.proto：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_proto_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;127.0.0.1:50053&quot;</span>, grpc.WithInsecure())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;连接失败：[%v]\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    client := proto.NewGreeterClient(conn)</span><br><span class="line">    rsp, _ := client.SayHello(context.Background(), &amp;proto.HelloRequest&#123;</span><br><span class="line">        Name: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">        Url:  <span class="string">&quot;https://www.baidu.com&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    fmt.Println(rsp.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>python的server端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> grpc_proto_test.proto <span class="keyword">import</span> hello_pb2, hello_pb2_grpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Greeter</span>(hello_pb2_grpc.GreeterServicer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">SayHello</span>(<span class="params">self, request, context</span>):</span><br><span class="line">        <span class="keyword">return</span> hello_pb2.HelloReply(message=<span class="string">f&quot;你好, <span class="subst">&#123;request.name&#125;</span>, url: <span class="subst">&#123;request.url&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 1、实例化server</span></span><br><span class="line">    server = grpc.server(ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    <span class="comment"># 2、注册逻辑到server中</span></span><br><span class="line">    hello_pb2_grpc.add_GreeterServicer_to_server(Greeter(), server)</span><br><span class="line">    <span class="comment"># 3、启动server</span></span><br><span class="line">    server.add_insecure_port(<span class="string">&#x27;0.0.0.0:50053&#x27;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br></pre></td></tr></table></figure>
<p>如果python中的proto有个地方写的和golang中的不一致，如：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> url = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>url和name写反了。这样重新生成proto文件，重新运行server和client端，并没有报错，只是获取的数据顺序不对了。</p>
<p><strong>上面的url和name的编号是绑定的。</strong></p>
<h3 id="proto引用其他的proto文件"><a href="#proto引用其他的proto文件" class="headerlink" title="proto引用其他的proto文件"></a>proto引用其他的proto文件</h3><p>base.proto：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Empty</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Pong</span>&#123;</span><br><span class="line">  <span class="type">string</span> id = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>hello.proto引用base.proto：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;base.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> Ping(Empty) <span class="keyword">returns</span> (Pong)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="嵌套的message对象"><a href="#嵌套的message对象" class="headerlink" title="嵌套的message对象"></a>嵌套的message对象</h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/empty.proto&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;base.proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> Ping(google.protobuf.Empty) <span class="keyword">returns</span> (Pong)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">message </span><span class="title class_">Result</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">repeated</span> Result data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="protobuf中的其他类型"><a href="#protobuf中的其他类型" class="headerlink" title="protobuf中的其他类型"></a>protobuf中的其他类型</h3><p><strong>enum枚举类型</strong></p>
<p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line">  Gender g = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">Gender</span> &#123;</span><br><span class="line">  MALE = <span class="number">0</span>;</span><br><span class="line">  FEMALE = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_proto_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;127.0.0.1:50053&quot;</span>, grpc.WithInsecure())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;连接失败：[%v]\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    client := proto.NewGreeterClient(conn)</span><br><span class="line">    rsp, _ := client.SayHello(context.Background(), &amp;proto.HelloRequest&#123;</span><br><span class="line">        Name: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">        Url:  <span class="string">&quot;https://www.baidu.com&quot;</span>,</span><br><span class="line">        G:    proto.Gender_MALE,</span><br><span class="line">    &#125;)</span><br><span class="line">    fmt.Println(rsp.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>map类型</strong></p>
<p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line">  Gender g = <span class="number">3</span>;</span><br><span class="line">  map&lt;<span class="type">string</span>, <span class="type">string</span>&gt; mp = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">Gender</span> &#123;</span><br><span class="line">  MALE = <span class="number">0</span>;</span><br><span class="line">  FEMALE = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rsp, _ := client.SayHello(context.Background(), &amp;proto.HelloRequest&#123;</span><br><span class="line">    Name: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">    Url:  <span class="string">&quot;https://www.baidu.com&quot;</span>,</span><br><span class="line">    G:    proto.Gender_MALE,</span><br><span class="line">    Mp: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;username&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;address&quot;</span>: <span class="string">&quot;SH&quot;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p><strong>timestamp类型</strong></p>
<p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/timestamp.proto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> url = <span class="number">2</span>;</span><br><span class="line">  Gender g = <span class="number">3</span>;</span><br><span class="line">  map&lt;<span class="type">string</span>, <span class="type">string</span>&gt; mp = <span class="number">4</span>;</span><br><span class="line">  google.protobuf.Timestamp addTime = <span class="number">5</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">enum </span><span class="title class_">Gender</span> &#123;</span><br><span class="line">  MALE = <span class="number">0</span>;</span><br><span class="line">  FEMALE = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;log&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">    timestamppb <span class="string">&quot;google.golang.org/protobuf/types/known/timestamppb&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_proto_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;127.0.0.1:50053&quot;</span>, grpc.WithInsecure())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        log.Printf(<span class="string">&quot;连接失败：[%v]\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    client := proto.NewGreeterClient(conn)</span><br><span class="line">    rsp, _ := client.SayHello(context.Background(), &amp;proto.HelloRequest&#123;</span><br><span class="line">        Name: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">        Url:  <span class="string">&quot;https://www.baidu.com&quot;</span>,</span><br><span class="line">        G:    proto.Gender_MALE,</span><br><span class="line">        Mp: <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">            <span class="string">&quot;username&quot;</span>: <span class="string">&quot;zhangsan&quot;</span>,</span><br><span class="line">            <span class="string">&quot;address&quot;</span>: <span class="string">&quot;SH&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        AddTime: timestamppb.New(time.Now()),</span><br><span class="line">    &#125;)</span><br><span class="line">    fmt.Println(rsp.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gRPC深入"><a href="#gRPC深入" class="headerlink" title="gRPC深入"></a>gRPC深入</h2><h3 id="python的grpc结合asyncio"><a href="#python的grpc结合asyncio" class="headerlink" title="python的grpc结合asyncio"></a>python的grpc结合asyncio</h3><p>官方地址：<a target="_blank" rel="noopener" href="https://grpc.github.io/grpc/python/index.html">https://grpc.github.io/grpc/python/index.html</a></p>
<ul>
<li>grpcio自带的aio：<a target="_blank" rel="noopener" href="https://grpc.github.io/grpc/python/grpc_asyncio.htm">https://grpc.github.io/grpc/python/grpc_asyncio.htm</a></li>
<li>直接使用proto文件：<a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/examples/python/no_codegen">https://github.com/grpc/grpc/tree/master/examples/python/no_codegen</a></li>
<li>使用grpclib：<a target="_blank" rel="noopener" href="https://github.com/vmagamedov/grpclib">https://github.com/vmagamedov/grpclib</a></li>
</ul>
<p>使用grpclib</p>
<p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>生成python源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install grpclib #安装依赖包</span><br><span class="line">#生成对应的源码</span><br><span class="line">python -m grpc_tools.protoc -I. --python_out=. --grpclib_python_out=. helloworld.proto</span><br></pre></td></tr></table></figure>
<p>服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> grpclib.utils <span class="keyword">import</span> graceful_exit</span><br><span class="line"><span class="keyword">from</span> grpclib.server <span class="keyword">import</span> Server</span><br><span class="line"></span><br><span class="line"><span class="comment"># generated by protoc</span></span><br><span class="line"><span class="keyword">from</span> .helloworld_pb2 <span class="keyword">import</span> HelloReply</span><br><span class="line"><span class="keyword">from</span> .helloworld_grpc <span class="keyword">import</span> GreeterBase</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Greeter</span>(<span class="title class_ inherited__">GreeterBase</span>):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">SayHello</span>(<span class="params">self, stream</span>):</span><br><span class="line">        request = <span class="keyword">await</span> stream.recv_message()</span><br><span class="line">        message = <span class="string">f&#x27;Hello, <span class="subst">&#123;request.name&#125;</span>!&#x27;</span></span><br><span class="line">        <span class="keyword">await</span> stream.send_message(HelloReply(message=message))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">*, host=<span class="string">&#x27;127.0.0.1&#x27;</span>, port=<span class="number">50051</span></span>):</span><br><span class="line">    server = Server([Greeter()])</span><br><span class="line">    <span class="comment"># Note: graceful_exit isn&#x27;t supported in Windows</span></span><br><span class="line">    <span class="keyword">await</span> server.start(host, port)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&#x27;Serving on <span class="subst">&#123;host&#125;</span>:<span class="subst">&#123;port&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">await</span> server.wait_closed()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> asyncio</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> grpclib.client <span class="keyword">import</span> Channel</span><br><span class="line"></span><br><span class="line"><span class="comment"># generated by protoc</span></span><br><span class="line"><span class="keyword">from</span> .helloworld_pb2 <span class="keyword">import</span> HelloRequest, HelloReply</span><br><span class="line"><span class="keyword">from</span> .helloworld_grpc <span class="keyword">import</span> GreeterStub</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    <span class="keyword">async</span> <span class="keyword">with</span> Channel(<span class="string">&#x27;127.0.0.1&#x27;</span>, <span class="number">50051</span>) <span class="keyword">as</span> channel:</span><br><span class="line">        greeter = GreeterStub(channel)</span><br><span class="line"></span><br><span class="line">        reply = <span class="keyword">await</span> greeter.SayHello(HelloRequest(name=<span class="string">&#x27;Dr. Strange&#x27;</span>))</span><br><span class="line">        <span class="built_in">print</span>(reply.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    asyncio.run(main())</span><br></pre></td></tr></table></figure>
<h3 id="gRPC的metadata机制"><a href="#gRPC的metadata机制" class="headerlink" title="gRPC的metadata机制"></a>gRPC的metadata机制</h3><p>gRPC让我们可以像本地调用一样实现远程调用，对于每一次的RPC调用中，都可能会有一些有用的数据，而这些数据就可以通过metadata来传递</p>
<p>metadata是以key-value的形式存储数据的，其中key是<code>string</code>类型，而value是<code>[]string</code>，即一个字符串数组类型。metadata使得client和server能够为对方提供关于本次调用的一些信息，就像一次http请求的RequestHeader和ResponseHeader一样。http中header的生命周周期是一次http请求，那么metadata的生命周期就是一次RPC调用。</p>
<h4 id="go控制grpc的metadata"><a href="#go控制grpc的metadata" class="headerlink" title="go控制grpc的metadata"></a>go控制grpc的metadata</h4><h5 id="go中使用metadata"><a href="#go中使用metadata" class="headerlink" title="go中使用metadata"></a>go中使用metadata</h5><p>go中使用metadata比较麻烦。</p>
<p>官方源码：<a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-go/tree/master/metadata">源码</a>                  项目文档：<a target="_blank" rel="noopener" href="https://github.com/grpc/grpc-go/blob/master/Documentation/grpc-metadata.md">文档</a></p>
<p><strong>新建metadata</strong></p>
<p>MD 类型实际上是map，key是string，value是string类型的slice</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> MD <span class="keyword">map</span>[<span class="type">string</span>][]<span class="type">string</span></span><br></pre></td></tr></table></figure>
<p>创建的时候可以像创建普通的map类型一样使用new关键字进行创建：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一种方式</span></span><br><span class="line">md := metadata.New(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;<span class="string">&quot;key1&quot;</span>: <span class="string">&quot;val1&quot;</span>, <span class="string">&quot;key2&quot;</span>: <span class="string">&quot;val2&quot;</span>&#125;)</span><br><span class="line"><span class="comment">//第二种方式 key不区分大小写，会被统一转成小写。</span></span><br><span class="line">md := metadata.Pairs(</span><br><span class="line">    <span class="string">&quot;key1&quot;</span>, <span class="string">&quot;val1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;key1&quot;</span>, <span class="string">&quot;val1-2&quot;</span>, <span class="comment">// &quot;key1&quot; will have map value []string&#123;&quot;val1&quot;, &quot;val1-2&quot;&#125;</span></span><br><span class="line">    <span class="string">&quot;key2&quot;</span>, <span class="string">&quot;val2&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p><strong>发送metadata</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">md := metadata.Pairs(<span class="string">&quot;key&quot;</span>, <span class="string">&quot;val&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 新建一个有 metadata 的 context</span></span><br><span class="line">ctx := metadata.NewOutgoingContext(context.Background(), md)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 单向 RPC</span></span><br><span class="line">response, err := client.SomeRPC(ctx, someRequest)</span><br></pre></td></tr></table></figure>
<p><strong>接收metadata</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *server)</span></span> SomeRPC(ctx context.Context, in *pb.SomeRequest) (*pb.SomeResponse, err) &#123;</span><br><span class="line">    md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line">    <span class="comment">// do something with metadata</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="grpc中使用metadata"><a href="#grpc中使用metadata" class="headerlink" title="grpc中使用metadata"></a>grpc中使用metadata</h5><p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;./;proto&quot;</span>;</span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>server:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/metadata&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span></span> SayHello(ctx context.Context, request *proto.HelloRequest) (*proto.HelloReply, <span class="type">error</span>) &#123;</span><br><span class="line">    md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line">    <span class="keyword">if</span> ok &#123;</span><br><span class="line">        fmt.Println(<span class="string">&quot;get metadata error&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> key, val := <span class="keyword">range</span> md &#123;</span><br><span class="line">        fmt.Println(key, val)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> &amp;proto.HelloReply&#123;</span><br><span class="line">        Message: <span class="string">&quot;hello, &quot;</span> + request.Name,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    server := grpc.NewServer()</span><br><span class="line">    proto.RegisterGreeterServer(server, &amp;Server&#123;&#125;)</span><br><span class="line">    listen, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:50051&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to listen: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    err = server.Serve(listen)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to start grpc: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client:</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/metadata&quot;</span></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;127.0.0.1:50051&quot;</span>, grpc.WithInsecure())</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    c := proto.NewGreeterClient(conn)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//md := metadata.Pairs(&quot;timestamp&quot;, time.Now().Format(timestampFormat))</span></span><br><span class="line">    md := metadata.New(<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>:     <span class="string">&quot;reese&quot;</span>,</span><br><span class="line">        <span class="string">&quot;password&quot;</span>: <span class="string">&quot;reese123&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    ctx := metadata.NewOutgoingContext(context.Background(), md)</span><br><span class="line"></span><br><span class="line">    r, err := c.SayHello(ctx, &amp;proto.HelloRequest&#123;Name: <span class="string">&quot;cwz&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(r.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210616123918.png" alt=""></p>
<h4 id="python中使用metadata"><a href="#python中使用metadata" class="headerlink" title="python中使用metadata"></a>python中使用metadata</h4><p>可以看官方的例子：<a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/tree/master/examples/python/metadata">https://github.com/grpc/grpc/tree/master/examples/python/metadata</a></p>
<p>proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply) </span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">  <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> grpc_metadata_test.proto <span class="keyword">import</span> helloworld_pb2_grpc, helloworld_pb2</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="keyword">with</span> grpc.insecure_channel(<span class="string">&quot;localhost:50052&quot;</span>) <span class="keyword">as</span> channel:</span><br><span class="line">        stub = helloworld_pb2_grpc.GreeterStub(channel)</span><br><span class="line">        hello_request = helloworld_pb2.HelloRequest()</span><br><span class="line">        hello_request.name = <span class="string">&quot;cwz&quot;</span></span><br><span class="line">        response, call = stub.SayHello.with_call(</span><br><span class="line">            hello_request,</span><br><span class="line">            metadata=(</span><br><span class="line">                (<span class="string">&#x27;name&#x27;</span>, <span class="string">&#x27;cwz&#x27;</span>),</span><br><span class="line">                (<span class="string">&#x27;password&#x27;</span>, <span class="string">&#x27;cwz321&#x27;</span>)</span><br><span class="line">            ))</span><br><span class="line">        <span class="comment"># rsp: helloworld_pb2.HelloReply = stub.SayHello(helloworld_pb2.HelloRequest(name=&quot;cwz&quot;))</span></span><br><span class="line">        <span class="built_in">print</span>(response.message)  <span class="comment"># 你好, cwz</span></span><br></pre></td></tr></table></figure>
<p>server端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> concurrent.futures <span class="keyword">import</span> ThreadPoolExecutor</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> grpc_metadata_test.proto <span class="keyword">import</span> helloworld_pb2, helloworld_pb2_grpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Greeter</span>(helloworld_pb2_grpc.GreeterServicer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">SayHello</span>(<span class="params">self, request, context</span>):</span><br><span class="line">        <span class="keyword">for</span> key, value <span class="keyword">in</span> context.invocation_metadata():</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&#x27;Received initial metadata: key=%s value=%s&#x27;</span> % (key, value))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> helloworld_pb2.HelloReply(message=<span class="string">f&quot;你好, <span class="subst">&#123;request.name&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment"># 1、实例化server</span></span><br><span class="line">    server = grpc.server(ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    <span class="comment"># 2、注册逻辑到server中</span></span><br><span class="line">    helloworld_pb2_grpc.add_GreeterServicer_to_server(Greeter(), server)</span><br><span class="line">    <span class="comment"># 3、启动server</span></span><br><span class="line">    server.add_insecure_port(<span class="string">&#x27;0.0.0.0:50052&#x27;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br></pre></td></tr></table></figure>
<p>运行：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210616130147.png" alt=""></p>
<h3 id="gRPC的拦截器"><a href="#gRPC的拦截器" class="headerlink" title="gRPC的拦截器"></a>gRPC的拦截器</h3><h4 id="go实现"><a href="#go实现" class="headerlink" title="go实现"></a>go实现</h4><p>proto：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//将 sessionid放入 放入cookie中 http协议</span></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">interceptor</span><span class="params">(ctx context.Context, method <span class="type">string</span>, req, reply <span class="keyword">interface</span>&#123;&#125;, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption)</span></span> <span class="type">error</span> &#123;</span><br><span class="line">    start := time.Now()</span><br><span class="line">    err := invoker(ctx, method, req, reply, cc, opts...)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;耗时：%s\n&quot;</span>, time.Since(start))</span><br><span class="line">    <span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    opt := grpc.WithUnaryInterceptor(interceptor)</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;127.0.0.1:50051&quot;</span>, grpc.WithInsecure(), opt)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    c := proto.NewGreeterClient(conn)</span><br><span class="line">    r, err := c.SayHello(context.Background(), &amp;proto.HelloRequest&#123;Name: <span class="string">&quot;cwz&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(r.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>server：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span></span> SayHello(ctx context.Context, request *proto.HelloRequest) (*proto.HelloReply, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;proto.HelloReply&#123;</span><br><span class="line">        Message: <span class="string">&quot;hello, &quot;</span> + request.Name,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">interceptor</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;接收到了一个新的请求&quot;</span>)</span><br><span class="line">    res, err := handler(ctx, req)</span><br><span class="line">    fmt.Println(<span class="string">&quot;请求完成&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> res, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    opt := grpc.UnaryInterceptor(interceptor)</span><br><span class="line">    g := grpc.NewServer(opt)</span><br><span class="line">    proto.RegisterGreeterServer(g, &amp;Server&#123;&#125;)</span><br><span class="line">    listen, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:50051&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to listen: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    err = g.Serve(listen)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to start grpc: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>拦截器的应用场景</strong>：<a target="_blank" rel="noopener" href="https://github.com/grpc-ecosystem/go-grpc-middleware">go-grpc-middleware</a></p>
<h4 id="python实现"><a href="#python实现" class="headerlink" title="python实现"></a>python实现</h4><p>proto：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> grpc_interceptor.proto <span class="keyword">import</span> helloworld_pb2</span><br><span class="line"><span class="keyword">from</span> grpc_interceptor.proto <span class="keyword">import</span> helloworld_pb2_grpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DefaultValueClientInterceptor</span>(grpc.UnaryUnaryClientInterceptor):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">intercept_unary_unary</span>(<span class="params">self, continuation, client_call_details, request</span>):</span><br><span class="line">        start = datetime.now()</span><br><span class="line">        rsp = continuation(client_call_details, request)</span><br><span class="line">        last = datetime.now()-start</span><br><span class="line">        <span class="built_in">print</span>(last)</span><br><span class="line">        <span class="built_in">print</span>(last.microseconds/<span class="number">1000</span>)</span><br><span class="line">        <span class="comment"># print(f&quot;用时: &#123;datetime.now()-start&#125;&quot;)</span></span><br><span class="line">        <span class="keyword">return</span> rsp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">run</span>():</span><br><span class="line">    default_value_interceptor = DefaultValueClientInterceptor()</span><br><span class="line">    <span class="keyword">with</span> grpc.insecure_channel(<span class="string">&#x27;localhost:50051&#x27;</span>) <span class="keyword">as</span> channel:</span><br><span class="line">        intercept_channel = grpc.intercept_channel(channel,</span><br><span class="line">                                                   default_value_interceptor)</span><br><span class="line">        stub = helloworld_pb2_grpc.GreeterStub(intercept_channel)</span><br><span class="line">        response = stub.SayHello(helloworld_pb2.HelloRequest(name=<span class="string">&#x27;you&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Greeter client received: &quot;</span> + response.message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    run()</span><br></pre></td></tr></table></figure>
<p>server：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">from concurrent <span class="keyword">import</span> futures</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line">from grpc_interceptor.proto <span class="keyword">import</span> helloworld_pb2</span><br><span class="line">from grpc_interceptor.proto <span class="keyword">import</span> helloworld_pb2_grpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class LogInterceptor(grpc.ServerInterceptor):</span><br><span class="line"></span><br><span class="line">    def intercept_service(self, continuation, handler_call_details):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;请求开始&quot;</span>)</span><br><span class="line">        rsp =  continuation(handler_call_details)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;请求结束&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> rsp</span><br><span class="line"></span><br><span class="line">class Greeter(helloworld_pb2_grpc.GreeterServicer):</span><br><span class="line"></span><br><span class="line">    def SayHello(self, request, context):</span><br><span class="line">        <span class="keyword">return</span> helloworld_pb2.HelloReply(message=<span class="string">&#x27;Hello, %s!&#x27;</span> % request.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">def serve():</span><br><span class="line">    header_validator = LogInterceptor()</span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>),</span><br><span class="line">                         interceptors=(header_validator,))</span><br><span class="line">    helloworld_pb2_grpc.add_GreeterServicer_to_server(Greeter(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">&#x27;[::]:50051&#x27;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>
<h3 id="通过拦截器和metadata实现grpc的auth认证"><a href="#通过拦截器和metadata实现grpc的auth认证" class="headerlink" title="通过拦截器和metadata实现grpc的auth认证"></a>通过拦截器和metadata实现grpc的auth认证</h3><p>对于server来说，client连接过来的时候提供id和密码，才能访问server</p>
<p>proto：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (HelloRequest) <span class="keyword">returns</span> (HelloReply)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloRequest</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">HelloReply</span> &#123;</span><br><span class="line">    <span class="type">string</span> message = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>server：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/codes&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/metadata&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/status&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span></span> SayHello(ctx context.Context, request *proto.HelloRequest) (*proto.HelloReply, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;proto.HelloReply&#123;</span><br><span class="line">        Message: <span class="string">&quot;hello, &quot;</span> + request.Name,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">interceptor</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">    fmt.Println(<span class="string">&quot;接收到了一个新的请求&quot;</span>)</span><br><span class="line"></span><br><span class="line">    md, ok := metadata.FromIncomingContext(ctx)</span><br><span class="line">    fmt.Println(md)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="comment">// gprc的错误处理</span></span><br><span class="line">        <span class="keyword">return</span> resp, status.Error(codes.Unauthenticated, <span class="string">&quot;无token认证信息&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> (</span><br><span class="line">        appid  <span class="type">string</span></span><br><span class="line">        appkey <span class="type">string</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> va1, ok := md[<span class="string">&quot;appid&quot;</span>]; ok &#123;</span><br><span class="line">        appid = va1[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> va1, ok := md[<span class="string">&quot;appkey&quot;</span>]; ok &#123;</span><br><span class="line">        appkey = va1[<span class="number">0</span>]</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> appid != <span class="string">&quot;010001&quot;</span> || appkey != <span class="string">&quot;i am key&quot;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> resp, status.Error(codes.Unauthenticated, <span class="string">&quot;无token认证信息&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 继续处理请求</span></span><br><span class="line">    res, err := handler(ctx, req)</span><br><span class="line">    fmt.Println(<span class="string">&quot;请求完成&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> res, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    opt := grpc.UnaryInterceptor(interceptor)</span><br><span class="line">    g := grpc.NewServer(opt)</span><br><span class="line">    proto.RegisterGreeterServer(g, &amp;Server&#123;&#125;)</span><br><span class="line">    listen, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:50051&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to listen: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    err = g.Serve(listen)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to start grpc: &quot;</span> + err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;grpc_test_demo/grpc_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> customCredential <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c customCredential)</span></span> GetRequestMetadata(ctx context.Context, uri ...<span class="type">string</span>) (<span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;appid&quot;</span>:  <span class="string">&quot;010001&quot;</span>,</span><br><span class="line">        <span class="string">&quot;appkey&quot;</span>: <span class="string">&quot;i am key&quot;</span>,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c customCredential)</span></span> RequireTransportSecurity() <span class="type">bool</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//func interceptor(ctx context.Context, method string, req, reply interface&#123;&#125;, cc *grpc.ClientConn, invoker grpc.UnaryInvoker, opts ...grpc.CallOption) error &#123;</span></span><br><span class="line"><span class="comment">//    start := time.Now()</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    md := metadata.New(map[string]string&#123;</span></span><br><span class="line"><span class="comment">//        &quot;appid&quot;:  &quot;010001&quot;,</span></span><br><span class="line"><span class="comment">//        &quot;appkey&quot;: &quot;i am key&quot;,</span></span><br><span class="line"><span class="comment">//    &#125;)</span></span><br><span class="line"><span class="comment">//    ctx = metadata.NewOutgoingContext(context.Background(), md)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//    err := invoker(ctx, method, req, reply, cc, opts...)</span></span><br><span class="line"><span class="comment">//    fmt.Printf(&quot;耗时：%s\n&quot;, time.Since(start))</span></span><br><span class="line"><span class="comment">//    return err</span></span><br><span class="line"><span class="comment">//&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    grpc.WithPerRPCCredentials(customCredential&#123;&#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> opts []grpc.DialOption</span><br><span class="line">    opts = <span class="built_in">append</span>(opts, grpc.WithInsecure())</span><br><span class="line">    opts = <span class="built_in">append</span>(opts, grpc.WithPerRPCCredentials(customCredential&#123;&#125;))</span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;127.0.0.1:50051&quot;</span>, opts...)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="literal">nil</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    c := proto.NewGreeterClient(conn)</span><br><span class="line">    r, err := c.SayHello(context.Background(), &amp;proto.HelloRequest&#123;Name: <span class="string">&quot;cwz&quot;</span>&#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(r.Message)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="grpc的验证器"><a href="#grpc的验证器" class="headerlink" title="grpc的验证器"></a>grpc的验证器</h3><p><a target="_blank" rel="noopener" href="https://github.com/envoyproxy/protoc-gen-validate">https://github.com/envoyproxy/protoc-gen-validate</a></p>
<h4 id="安装和配置"><a href="#安装和配置" class="headerlink" title="安装和配置"></a>安装和配置</h4><p>linux：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">fetches this repo into <span class="variable">$GOPATH</span></span></span><br><span class="line">go get -d github.com/envoyproxy/protoc-gen-validate</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">installs PGV into <span class="variable">$GOPATH</span>/bin</span></span><br><span class="line">make build</span><br></pre></td></tr></table></figure>
<p>windows：</p>
<p>exe下载地址：<a target="_blank" rel="noopener" href="https://oss.sonatype.org/content/repositories/snapshots/io/envoyproxy/protoc-gen-validate/protoc-gen-validate/">https://oss.sonatype.org/content/repositories/snapshots/io/envoyproxy/protoc-gen-validate/protoc-gen-validate/</a></p>
<p>将解压后的exe文件拷贝到go的根目录的bin下</p>
<p>生成go源码：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I .  --go_out=plugins=grpc:. --validate_out=&quot;lang=go:.&quot; helloworld.proto</span><br></pre></td></tr></table></figure>
<h4 id="proto文件"><a href="#proto文件" class="headerlink" title="proto文件"></a>proto文件</h4><ul>
<li>新建validate.proto文件内容从 <a target="_blank" rel="noopener" href="https://github.com/envoyproxy/protoc-gen-validate/blob/master/validate/validate.proto">https://github.com/envoyproxy/protoc-gen-validate/blob/master/validate/validate.proto</a> 拷贝</li>
<li>新建helloworld.proto文件</li>
</ul>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;validate.proto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package=<span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">Greeter</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">rpc</span> SayHello (Person) <span class="keyword">returns</span> (Person)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="type">uint64</span> id    = <span class="number">1</span> [(validate.rules).<span class="type">uint64</span>.gt    = <span class="number">999</span>];</span><br><span class="line"></span><br><span class="line">    <span class="type">string</span> email = <span class="number">2</span> [(validate.rules).<span class="type">string</span>.email = <span class="literal">true</span>];</span><br><span class="line">    <span class="type">string</span> name  = <span class="number">3</span> [(validate.rules).<span class="type">string</span> = &#123;</span><br><span class="line">                      pattern:   <span class="string">&quot;^[^[0-9]A-Za-z]+( [^[0-9]A-Za-z]+)*$&quot;</span>,max_bytes: <span class="number">256</span>,&#125;];</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/codes&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc/status&quot;</span></span><br><span class="line">    <span class="string">&quot;net&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;start/pgv_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Server <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *Server)</span></span> SayHello(ctx context.Context, request *proto.Person) (*proto.Person,</span><br><span class="line">    <span class="type">error</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;proto.Person&#123;</span><br><span class="line">        Id: <span class="number">32</span>,</span><br><span class="line">    &#125;, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Validator <span class="keyword">interface</span> &#123;</span><br><span class="line">    Validate() <span class="type">error</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">var</span> interceptor grpc.UnaryServerInterceptor</span><br><span class="line">    interceptor = <span class="function"><span class="keyword">func</span><span class="params">(ctx context.Context, req <span class="keyword">interface</span>&#123;&#125;, info *grpc.UnaryServerInfo, handler grpc.UnaryHandler)</span></span> (resp <span class="keyword">interface</span>&#123;&#125;, err <span class="type">error</span>) &#123;</span><br><span class="line">        <span class="comment">// 继续处理请求</span></span><br><span class="line">        <span class="keyword">if</span> r, ok := req.(Validator); ok &#123;</span><br><span class="line">            <span class="keyword">if</span> err := r.Validate(); err != <span class="literal">nil</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">nil</span>, status.Error(codes.InvalidArgument, err.Error())</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> handler(ctx, req)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> opts []grpc.ServerOption</span><br><span class="line">    opts = <span class="built_in">append</span>(opts, grpc.UnaryInterceptor(interceptor))</span><br><span class="line"></span><br><span class="line">    g := grpc.NewServer(opts...)</span><br><span class="line">    proto.RegisterGreeterServer(g, &amp;Server&#123;&#125;)</span><br><span class="line">    lis, err := net.Listen(<span class="string">&quot;tcp&quot;</span>, <span class="string">&quot;0.0.0.0:50051&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to listen:&quot;</span>+err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">    err = g.Serve(lis)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span>&#123;</span><br><span class="line">        <span class="built_in">panic</span>(<span class="string">&quot;failed to start grpc:&quot;</span>+err.Error())</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span>  main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;context&quot;</span></span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;google.golang.org/grpc&quot;</span></span><br><span class="line">    <span class="string">&quot;start/pgv_test/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> customCredential <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> opts []grpc.DialOption</span><br><span class="line"></span><br><span class="line">    <span class="comment">//opts = append(opts, grpc.WithUnaryInterceptor(interceptor))</span></span><br><span class="line">    opts = <span class="built_in">append</span>(opts, grpc.WithInsecure())</span><br><span class="line"></span><br><span class="line">    conn, err := grpc.Dial(<span class="string">&quot;localhost:50051&quot;</span>, opts...)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">defer</span> conn.Close()</span><br><span class="line"></span><br><span class="line">    c := proto.NewGreeterClient(conn)</span><br><span class="line">    <span class="comment">//rsp, _ := c.Search(context.Background(), &amp;empty.Empty&#123;&#125;)</span></span><br><span class="line">    rsp, err := c.SayHello(context.Background(), &amp;proto.Person&#123;</span><br><span class="line">        Email: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(rsp.Id)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gRPC中的异常处理"><a href="#gRPC中的异常处理" class="headerlink" title="gRPC中的异常处理"></a>gRPC中的异常处理</h3><p>gRPC的状态码：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/grpc/grpc/blob/master/doc/statuscodes.md">https://github.com/grpc/grpc/blob/master/doc/statuscodes.md</a></p>
<h4 id="python中的异常处理"><a href="#python中的异常处理" class="headerlink" title="python中的异常处理"></a>python中的异常处理</h4><p>服务端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">context.set_code(grpc.StatusCode.NOT_FOUND)</span><br><span class="line">context.set_details(<span class="string">&#x27;记录不存在&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    stub.SayHello(Request())</span><br><span class="line">    <span class="built_in">print</span>(rsp.status)</span><br><span class="line"><span class="keyword">except</span> grpc.RpcError <span class="keyword">as</span> e:</span><br><span class="line">    d = e.details()</span><br><span class="line">    <span class="built_in">print</span>(d)</span><br><span class="line">    status_code = e.code()</span><br><span class="line">    <span class="built_in">print</span>(status_code.name)</span><br><span class="line">    <span class="built_in">print</span>(status_code.value)</span><br></pre></td></tr></table></figure>
<h4 id="go中的异常处理"><a href="#go中的异常处理" class="headerlink" title="go中的异常处理"></a>go中的异常处理</h4><p>服务端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">st := status.New(codes.InvalidArgument, <span class="string">&quot;invalid username&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>客户端：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">st, ok := status.FromError(err)</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line">    <span class="comment">// Error was not a status error</span></span><br><span class="line">&#125;</span><br><span class="line">st.Message()</span><br><span class="line">st.Code()</span><br></pre></td></tr></table></figure>
<h3 id="gRPC的超时机制"><a href="#gRPC的超时机制" class="headerlink" title="gRPC的超时机制"></a>gRPC的超时机制</h3><p>python</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response = stub.SayHello(helloworld_pb2.HelloRequest(name=<span class="string">&#x27;you&#x27;</span>), timeout=<span class="number">30</span>)</span><br></pre></td></tr></table></figure>
<p>go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ctx, cancel := context.WithTimeout(context.TODO(), time.Second*<span class="number">3</span>)</span><br><span class="line"><span class="keyword">defer</span> cancel()</span><br><span class="line">r, err := c.SayHello(ctx, &amp;pb.HelloRequest&#123;Name: name&#125;)</span><br></pre></td></tr></table></figure>
<h1 id="python的orm：peewee"><a href="#python的orm：peewee" class="headerlink" title="python的orm：peewee"></a>python的orm：peewee</h1><h2 id="简单使用-1"><a href="#简单使用-1" class="headerlink" title="简单使用"></a>简单使用</h2><h3 id="安装-1"><a href="#安装-1" class="headerlink" title="安装"></a>安装</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install peewee</span><br><span class="line">pip install pymysql</span><br></pre></td></tr></table></figure>
<h3 id="定义表结构"><a href="#定义表结构" class="headerlink" title="定义表结构"></a>定义表结构</h3><p>官网文档：<a target="_blank" rel="noopener" href="http://docs.peewee-orm.com/en/latest/peewee/models.html">http://docs.peewee-orm.com/en/latest/peewee/models.html</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">db = MySQLDatabase(<span class="string">&#x27;peewee&#x27;</span>,host =<span class="string">&#x27;127.0.0.1&#x27;</span>,user=<span class="string">&#x27;root&#x27;</span>,passwd=<span class="string">&#x27;root&#x27;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    username = CharField(unique=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tweet</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    user = ForeignKeyField(User, backref=<span class="string">&#x27;tweets&#x27;</span>)</span><br><span class="line">    message = TextField()</span><br><span class="line">    created_date = DateTimeField(default=datetime.datetime.now)</span><br><span class="line">    is_published = BooleanField(default=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = db</span><br></pre></td></tr></table></figure>
<h3 id="生成数据表"><a href="#生成数据表" class="headerlink" title="生成数据表"></a>生成数据表</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">db.connect()</span><br><span class="line">db.create_tables([User, Tweet])</span><br></pre></td></tr></table></figure>
<h3 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、添加</span></span><br><span class="line">charlie = User.create(username=<span class="string">&#x27;charlie&#x27;</span>)</span><br><span class="line">charlie.save() <span class="comment"># 这里会失败。 save方法既可以完成新建，也可以完成更新的操作（你的对象中主键值是否有设置，你是一个更新的操作）</span></span><br><span class="line"><span class="comment"># 可以这么改：</span></span><br><span class="line">charlie.save(force_insert=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 一般这么添加：</span></span><br><span class="line">huey = User.create(username=<span class="string">&#x27;huey&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、查询</span></span><br><span class="line"><span class="comment"># 2.1  get，返回的是直接的User对象，如果查询不到就会排除异常</span></span><br><span class="line">User.get(User.username == <span class="string">&#x27;charlie&#x27;</span>)</span><br><span class="line">query = User.get_by_id(User.username == <span class="string">&quot;chali&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.2  查询所有</span></span><br><span class="line">users = User.select()  <span class="comment"># 1、没有看到sql查询语句，用来组装sql  2、对象是ModelSelect</span></span><br><span class="line"><span class="built_in">print</span>(users, <span class="built_in">type</span>(users))</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> User.select():</span><br><span class="line">    <span class="built_in">print</span>(user.username)</span><br><span class="line"></span><br><span class="line">usernames = [<span class="string">&quot;chali&quot;</span>, <span class="string">&quot;huey&quot;</span>, <span class="string">&quot;micky&quot;</span>]</span><br><span class="line">users = User.select().where(User.username.in_(usernames))</span><br><span class="line"><span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">    <span class="built_in">print</span>(user.username)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新</span></span><br><span class="line">Counter.update(count=Counter.count + <span class="number">1</span>).where(Counter.url == request.url)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除</span></span><br><span class="line">user = User.get(User.<span class="built_in">id</span> == <span class="number">1</span>)</span><br><span class="line">user.delete_instance()</span><br><span class="line"></span><br><span class="line">query = Tweet.delete().where(Tweet.creation_date &lt; one_year_ago)</span><br><span class="line">query.execute() </span><br></pre></td></tr></table></figure>
<h2 id="peewee更多功能"><a href="#peewee更多功能" class="headerlink" title="peewee更多功能"></a>peewee更多功能</h2><h3 id="表继承"><a href="#表继承" class="headerlink" title="表继承"></a>表继承</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(<span class="string">&quot;peewee&quot;</span>)</span><br><span class="line">logger.setLevel(logging.DEBUG)</span><br><span class="line">logger.addHandler(logging.StreamHandler())</span><br><span class="line"></span><br><span class="line">db = MySQLDatabase(<span class="string">&#x27;peewee&#x27;</span>, host=<span class="string">&#x27;127.0.0.1&#x27;</span>, user=<span class="string">&#x27;root&#x27;</span>, passwd=<span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    add_time = DateTimeField(default=datetime.datetime.now(), verbose_name=<span class="string">&quot;添加时间&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    name = CharField(verbose_name=<span class="string">&#x27;姓名&#x27;</span>, max_length=<span class="number">10</span>, null=<span class="literal">False</span>, index=<span class="literal">True</span>)</span><br><span class="line">    passwd = CharField(verbose_name=<span class="string">&#x27;密码&#x27;</span>, max_length=<span class="number">20</span>, null=<span class="literal">False</span>, default=<span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line">    email = CharField(verbose_name=<span class="string">&#x27;邮件&#x27;</span>, max_length=<span class="number">50</span>, null=<span class="literal">True</span>, unique=<span class="literal">True</span>)</span><br><span class="line">    gender = IntegerField(verbose_name=<span class="string">&#x27;姓别&#x27;</span>, null=<span class="literal">False</span>, default=<span class="number">1</span>)</span><br><span class="line">    birthday = DateField(verbose_name=<span class="string">&#x27;生日&#x27;</span>, null=<span class="literal">True</span>, default=<span class="literal">None</span>)</span><br><span class="line">    is_admin = BooleanField(verbose_name=<span class="string">&#x27;是否是管理员&#x27;</span>, default=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = db  <span class="comment"># 这里是数据库链接，为了方便建立多个表，可以把这个部分提炼出来形成一个新的类</span></span><br><span class="line">        table_name = <span class="string">&#x27;persons&#x27;</span>  <span class="comment"># 这里可以自定义表名</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    db.connection()</span><br><span class="line">    db.create_tables([Person])</span><br></pre></td></tr></table></figure>
<h3 id="主键和约束"><a href="#主键和约束" class="headerlink" title="主键和约束"></a>主键和约束</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主键和约束</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    first = CharField()</span><br><span class="line">    last = CharField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        primary_key = CompositeKey(<span class="string">&#x27;first&#x27;</span>, <span class="string">&#x27;last&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Pet</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    owner_first = CharField()</span><br><span class="line">    owner_last = CharField()</span><br><span class="line">    pet_name = CharField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        constraints = [SQL(<span class="string">&#x27;FOREIGN KEY(owner_first, owner_last) REFERENCES person(first, last)&#x27;</span>)]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 复合主键</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BlogToTag</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;A simple &quot;through&quot; table for many-to-many relationship.&quot;&quot;&quot;</span></span><br><span class="line">    blog = ForeignKeyField(Blog)</span><br><span class="line">    tag = ForeignKeyField(Tag)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        primary_key = CompositeKey(<span class="string">&#x27;blog&#x27;</span>, <span class="string">&#x27;tag&#x27;</span>)</span><br></pre></td></tr></table></figure>
<h3 id="数据插入"><a href="#数据插入" class="headerlink" title="数据插入"></a>数据插入</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">p_id = Person.insert(&#123;<span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;bobby&#x27;</span>&#125;).execute() <span class="comment"># 插入一条数据，返回主键</span></span><br><span class="line"><span class="built_in">print</span>(p_id) <span class="comment"># 打印出新插入数据的id</span></span><br><span class="line"></span><br><span class="line">data_source = [</span><br><span class="line">    &#123;<span class="string">&#x27;field1&#x27;</span>: <span class="string">&#x27;val1-1&#x27;</span>, <span class="string">&#x27;field2&#x27;</span>: <span class="string">&#x27;val1-2&#x27;</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;field1&#x27;</span>: <span class="string">&#x27;val2-1&#x27;</span>, <span class="string">&#x27;field2&#x27;</span>: <span class="string">&#x27;val2-2&#x27;</span>&#125;,</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> data_dict <span class="keyword">in</span> data_source:</span><br><span class="line">    Model.create(**data_dict)</span><br><span class="line"></span><br><span class="line"><span class="comment">#若是有很多数据需要插入，例如几万条数据，为了性能，这时就需要使用insert_many()，如下：</span></span><br><span class="line"></span><br><span class="line">data = [</span><br><span class="line">    &#123;<span class="string">&#x27;facid&#x27;</span>: <span class="number">9</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Spa&#x27;</span>, <span class="string">&#x27;membercost&#x27;</span>: <span class="number">20</span>, <span class="string">&#x27;guestcost&#x27;</span>: <span class="number">30</span>,<span class="string">&#x27;initialoutlay&#x27;</span>: <span class="number">100000</span>, <span class="string">&#x27;monthlymaintenance&#x27;</span>: <span class="number">800</span>&#125;,</span><br><span class="line">    &#123;<span class="string">&#x27;facid&#x27;</span>: <span class="number">10</span>, <span class="string">&#x27;name&#x27;</span>: <span class="string">&#x27;Squash Court 2&#x27;</span>, <span class="string">&#x27;membercost&#x27;</span>: <span class="number">3.5</span>,<span class="string">&#x27;guestcost&#x27;</span>: <span class="number">17.5</span>, <span class="string">&#x27;initialoutlay&#x27;</span>: <span class="number">5000</span>, <span class="string">&#x27;monthlymaintenance&#x27;</span>: <span class="number">80</span>&#125;]</span><br><span class="line">query = Facility.insert_many(data) <span class="comment"># 插入了多个</span></span><br></pre></td></tr></table></figure>
<h3 id="各种查询"><a href="#各种查询" class="headerlink" title="各种查询"></a>各种查询</h3><h4 id="单条查询"><a href="#单条查询" class="headerlink" title="单条查询"></a>单条查询</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">User.get(User.<span class="built_in">id</span> == <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">User.get_by_id(<span class="number">1</span>)  <span class="comment"># Same as above.</span></span><br><span class="line"></span><br><span class="line">User[<span class="number">1</span>]  <span class="comment"># Also same as above.</span></span><br><span class="line">g = Person.select().where(Person.name == <span class="string">&#x27;Grandma L.&#x27;</span>).get()   <span class="comment"># where是查询一个集合, select是查询字段</span></span><br><span class="line"></span><br><span class="line">g = Person.get(Person.name == <span class="string">&#x27;fff.&#x27;</span>)   <span class="comment"># get是得到第一个</span></span><br><span class="line"></span><br><span class="line">g = Person.select().where(Person.age &gt; <span class="number">23</span>).get()</span><br><span class="line"><span class="comment"># select 代表sql语句中select后面的语句表示要展示的字段 # where 代表where条件语句 得到一个数据集合，用for循环遍历 # get()代表找第一个</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">person, created = Person.get_or_create(</span><br><span class="line">    first_name=first_name,</span><br><span class="line">    last_name=last_name,</span><br><span class="line">    defaults=&#123;<span class="string">&#x27;dob&#x27;</span>: dob, <span class="string">&#x27;favorite_color&#x27;</span>: <span class="string">&#x27;green&#x27;</span>&#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h4 id="复合条件查询"><a href="#复合条件查询" class="headerlink" title="复合条件查询"></a>复合条件查询</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query1 = Person.select().where((Person.name == <span class="string">&quot;fff0&quot;</span>) | (Person.name == <span class="string">&quot;sss1&quot;</span>))</span><br><span class="line"></span><br><span class="line">query2 = Person.select().where((Person.name == <span class="string">&quot;fff&quot;</span>) &amp; (Person.is_relative == <span class="literal">True</span>))</span><br></pre></td></tr></table></figure>
<h4 id="模糊查询"><a href="#模糊查询" class="headerlink" title="模糊查询"></a>模糊查询</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query = Facility.select().where(Facility.name.contains(<span class="string">&#x27;tennis&#x27;</span>))</span><br></pre></td></tr></table></figure>
<h4 id="in查询"><a href="#in查询" class="headerlink" title="in查询"></a>in查询</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">query = Facility.select().where(Facility.facid.in_([<span class="number">1</span>, <span class="number">5</span>]))</span><br></pre></td></tr></table></figure>
<h3 id="字典展示"><a href="#字典展示" class="headerlink" title="字典展示"></a>字典展示</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query = User.select().dicts()</span><br><span class="line"><span class="keyword">for</span> row <span class="keyword">in</span> query:</span><br><span class="line">    <span class="built_in">print</span>(row)</span><br></pre></td></tr></table></figure>
<h3 id="排序、limit、去重"><a href="#排序、limit、去重" class="headerlink" title="排序、limit、去重"></a>排序、limit、去重</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query = (Person.select(Person.name).order_by(Person.name).limit(<span class="number">10</span>).distinct())  <span class="comment"># 几乎和sql一模一样</span></span><br><span class="line">Person.select().order_by(Person.birthday.desc())  <span class="comment"># 日期排序</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Tweet.select().order_by(-Tweet.created_date) </span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询整张表的数据条数</span></span><br><span class="line">total_num = Person.select().count()</span><br></pre></td></tr></table></figure>
<h3 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SELECT MAX(birthday) FROM person;</span></span><br><span class="line">query = Person.select(fn.MAX(Person.birthday))</span><br><span class="line"></span><br><span class="line"><span class="comment"># SELECT name, is_relative FROM person WHERE birthday = (SELECT MAX(birthday) FROM person);</span></span><br><span class="line">MemberAlias = Member.alias()  <span class="comment"># 如果一个查询中用了两个表，需要这个Alias作为影子</span></span><br><span class="line"></span><br><span class="line">subq = MemberAlias.select(fn.MAX(MemberAlias.joindate))</span><br><span class="line"></span><br><span class="line">query = (Member.select(Person.is_relative, Person.name, ).where(Person.birthday == subq))</span><br></pre></td></tr></table></figure>
<h3 id="分页和计数"><a href="#分页和计数" class="headerlink" title="分页和计数"></a>分页和计数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># paginate两个参数：page_number 和 items_per_page</span></span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> Tweet.select().order_by(Tweet.<span class="built_in">id</span>).paginate(<span class="number">2</span>, <span class="number">10</span>):</span><br><span class="line">    <span class="built_in">print</span>(tweet.message)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 返回查到了多少条记录</span></span><br><span class="line">Tweet.select().where(Tweet.<span class="built_in">id</span> &gt; <span class="number">50</span>).count()</span><br></pre></td></tr></table></figure>
<h3 id="执行原生SQL"><a href="#执行原生SQL" class="headerlink" title="执行原生SQL"></a>执行原生SQL</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">query = MyModel.raw(<span class="string">&#x27;SELECT * FROM my_table WHERE data = %s&#x27;</span>, user_data)</span><br><span class="line"></span><br><span class="line">query = MyModel.select().where(SQL(<span class="string">&#x27;Some SQL expression %s&#x27;</span> % user_data))</span><br></pre></td></tr></table></figure>
<h3 id="查询多条"><a href="#查询多条" class="headerlink" title="查询多条"></a>查询多条</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询Person整张表的数据</span></span><br><span class="line">persons = Person.select()</span><br><span class="line"><span class="comment"># 遍历数据</span></span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> persons:</span><br><span class="line">    <span class="built_in">print</span>(p.name, p.birthday, p.is_relative)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取is_relative为True的数据</span></span><br><span class="line"><span class="comment"># 我们可以在select()后面添加where()当做查询条件</span></span><br><span class="line">persons = Person.select().where(Person.is_relative == <span class="literal">True</span>)</span><br><span class="line"><span class="keyword">for</span> p <span class="keyword">in</span> persons:</span><br><span class="line">    <span class="built_in">print</span>(p.name, p.birthday, p.is_relative)</span><br><span class="line"></span><br><span class="line"><span class="comment">#打印sql</span></span><br><span class="line">persons = Person.select().where(Person.is_relative == <span class="literal">True</span>)</span><br><span class="line"><span class="comment"># 打印出的结果为：(&#x27;SELECT `t1`.`id`, `t1`.`name`, `t1`.`is_relative` FROM `Person` AS `t1` WHERE (`t1`.`is_relative` = %s)&#x27;, [True])</span></span><br><span class="line"><span class="built_in">print</span>(persons.sql())</span><br></pre></td></tr></table></figure>
<h3 id="limit和offset"><a href="#limit和offset" class="headerlink" title="limit和offset"></a>limit和offset</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 相当于sql语句: select * from person order by create_time desc limit 5</span></span><br><span class="line">persons = Person.select().order_by(Person.create_time.asc()).limit(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 相当于sql语句中：select * from person order by create_time desc limit 2, 5</span></span><br><span class="line">persons = Person.select().order_by(Person.create_time.asc()).limit(<span class="number">5</span>).offset(<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<h3 id="表连接"><a href="#表连接" class="headerlink" title="表连接"></a>表连接</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = db</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    username = TextField()</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Tweet</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    content = TextField()</span><br><span class="line">    timestamp = DateTimeField(default=datetime.datetime.now)</span><br><span class="line">    user = ForeignKeyField(User, backref=<span class="string">&#x27;tweets&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Favorite</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    user = ForeignKeyField(User, backref=<span class="string">&#x27;favorites&#x27;</span>)</span><br><span class="line">    tweet = ForeignKeyField(Tweet, backref=<span class="string">&#x27;favorites&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#数据准备</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">populate_test_data</span>():</span><br><span class="line">    db.create_tables([User, Tweet, Favorite])</span><br><span class="line"></span><br><span class="line">    data = (</span><br><span class="line">        (<span class="string">&#x27;huey&#x27;</span>, (<span class="string">&#x27;meow&#x27;</span>, <span class="string">&#x27;hiss&#x27;</span>, <span class="string">&#x27;purr&#x27;</span>)),</span><br><span class="line">        (<span class="string">&#x27;mickey&#x27;</span>, (<span class="string">&#x27;woof&#x27;</span>, <span class="string">&#x27;whine&#x27;</span>)),</span><br><span class="line">        (<span class="string">&#x27;zaizee&#x27;</span>, ()))</span><br><span class="line">    <span class="keyword">for</span> username, tweets <span class="keyword">in</span> data:</span><br><span class="line">        user = User.create(username=username)</span><br><span class="line">        <span class="keyword">for</span> tweet <span class="keyword">in</span> tweets:</span><br><span class="line">            Tweet.create(user=user, content=tweet)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Populate a few favorites for our users, such that:</span></span><br><span class="line">    favorite_data = (</span><br><span class="line">        (<span class="string">&#x27;huey&#x27;</span>, [<span class="string">&#x27;whine&#x27;</span>]),</span><br><span class="line">        (<span class="string">&#x27;mickey&#x27;</span>, [<span class="string">&#x27;purr&#x27;</span>]),</span><br><span class="line">        (<span class="string">&#x27;zaizee&#x27;</span>, [<span class="string">&#x27;meow&#x27;</span>, <span class="string">&#x27;purr&#x27;</span>]))</span><br><span class="line">    <span class="keyword">for</span> username, favorites <span class="keyword">in</span> favorite_data:</span><br><span class="line">        user = User.get(User.username == username)</span><br><span class="line">        <span class="keyword">for</span> content <span class="keyword">in</span> favorites:</span><br><span class="line">            tweet = Tweet.get(Tweet.content == content)</span><br><span class="line">            Favorite.create(user=user, tweet=tweet)</span><br><span class="line"></span><br><span class="line">query = Tweet.select().join(User).where(User.username == <span class="string">&#x27;huey&#x27;</span>)</span><br><span class="line"><span class="comment">#等价于</span></span><br><span class="line">query = (Tweet</span><br><span class="line">         .select()</span><br><span class="line">         .join(User, on=(Tweet.user == User.<span class="built_in">id</span>))</span><br><span class="line">         .where(User.username == <span class="string">&#x27;huey&#x27;</span>))</span><br><span class="line">huey.tweets.sql()</span><br></pre></td></tr></table></figure>
<h3 id="外键"><a href="#外键" class="headerlink" title="外键"></a>外键</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#正查</span></span><br><span class="line">dog1 = Pet.get(name=<span class="string">&quot;dog1&quot;</span>)</span><br><span class="line">dog1.owner.name</span><br><span class="line"></span><br><span class="line"><span class="comment"># 反查</span></span><br><span class="line">tweets = User.get(User.username==<span class="string">&quot;huey&quot;</span>).tweets</span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> tweets:</span><br><span class="line">    <span class="built_in">print</span>(tweet.content)</span><br><span class="line">favs = User.get(User.username==<span class="string">&quot;huey&quot;</span>).favorites</span><br><span class="line"><span class="keyword">for</span> fav <span class="keyword">in</span> favs:</span><br><span class="line">    <span class="built_in">print</span>(fav.user.username, fav.tweet.content)</span><br></pre></td></tr></table></figure>
<h3 id="避免N-1查询"><a href="#避免N-1查询" class="headerlink" title="避免N+1查询"></a>避免N+1查询</h3><p>N+1查询指的是当应用提交一次查询获取结果，然后在取得结果数据集的每一行时，应用至少再次查询一次（也可以看做是嵌套循环）</p>
<p>大多数情况下，n 查询可以通过使用SQL join或子查询来避免。数据库本身可能做了嵌套循环，但是它比在你的应用代码本身里做这些n查询更高效，后者通常会导致与数据库再次潜在通讯，没有利用数据库本身关联和执行子查询时会进行切片等优化工作。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">query = (Tweet</span><br><span class="line">         .select(Tweet, User)  <span class="comment"># Note that we are selecting both models.</span></span><br><span class="line">         .join(User)  <span class="comment"># Use an INNER join because every tweet has an author.</span></span><br><span class="line">         .order_by(Tweet.<span class="built_in">id</span>.desc())  <span class="comment"># Get the most recent tweets.</span></span><br><span class="line">         .limit(<span class="number">10</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> tweet <span class="keyword">in</span> query:</span><br><span class="line">    <span class="built_in">print</span> tweet.user.username, <span class="string">&#x27;-&#x27;</span>, tweet.message</span><br></pre></td></tr></table></figure>
<p>没有用join时，得到tweet.user.username会触发一次查询去解析外键tweet.user从而得到相关联的user。</p>
<p>由于我们在User上关联并选择，peewee自动为我们解析外键</p>
<h1 id="go的web框架"><a href="#go的web框架" class="headerlink" title="go的web框架"></a>go的web框架</h1><h2 id="gin"><a href="#gin" class="headerlink" title="gin"></a>gin</h2><h3 id="gin的helloworld体验"><a href="#gin的helloworld体验" class="headerlink" title="gin的helloworld体验"></a>gin的helloworld体验</h3><p>官网地址：<a target="_blank" rel="noopener" href="https://gin-gonic.com/docs/quickstart/">https://gin-gonic.com/docs/quickstart/</a></p>
<p>安装：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">go</span> get -u github.com/gin-gonic/gin</span><br></pre></td></tr></table></figure>
<p>实现：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 实例化gin的server对象</span></span><br><span class="line">    r := gin.Default()</span><br><span class="line">    r.GET(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;pong&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    r.Run() <span class="comment">// listen and serve on 0.0.0.0:8080</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用get、post、put等http方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 使用默认中间件创建一个gin路由器</span></span><br><span class="line">    <span class="comment">// logger and recovery (crash-free) 中间件</span></span><br><span class="line">    router := gin.Default()</span><br><span class="line"></span><br><span class="line">    router.GET(<span class="string">&quot;/someGet&quot;</span>, getting)</span><br><span class="line">    router.POST(<span class="string">&quot;/somePost&quot;</span>, posting)</span><br><span class="line">    router.PUT(<span class="string">&quot;/somePut&quot;</span>, putting)</span><br><span class="line">    router.DELETE(<span class="string">&quot;/someDelete&quot;</span>, deleting)</span><br><span class="line">    router.PATCH(<span class="string">&quot;/somePatch&quot;</span>, patching)</span><br><span class="line">    router.HEAD(<span class="string">&quot;/someHead&quot;</span>, head)</span><br><span class="line">    router.OPTIONS(<span class="string">&quot;/someOptions&quot;</span>, options)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 默认启动的是 8080端口，也可以自己定义启动端口</span></span><br><span class="line">    router.Run()</span><br><span class="line">    <span class="comment">// router.Run(&quot;:3000&quot;) for a hard coded port</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用New和Default初始化路由器的区别：</p>
<p>创建一个路由器实例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>还可以使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.New()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>区别就是Default会默认开启两个中间件：logger and recovery (crash-free) 中间件</p>
<h3 id="gin的路由分组和url"><a href="#gin的路由分组和url" class="headerlink" title="gin的路由分组和url"></a>gin的路由分组和url</h3><h4 id="路由分组"><a href="#路由分组" class="headerlink" title="路由分组"></a>路由分组</h4><p>安装服务的前缀分组</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := gin.Default()</span><br><span class="line">    goodsGroup := r.Group(<span class="string">&quot;/goods&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        goodsGroup.GET(<span class="string">&quot;/list&quot;</span>, goodsList)</span><br><span class="line">        goodsGroup.GET(<span class="string">&quot;/1&quot;</span>, goodsDetail)</span><br><span class="line">    &#125;</span><br><span class="line">    r.Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">goodsDetail</span><span class="params">(context *gin.Context)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">goodsList</span><span class="params">(context *gin.Context)</span></span> &#123;</span><br><span class="line">    context.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;goodsList&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="带参数的url"><a href="#带参数的url" class="headerlink" title="带参数的url"></a>带参数的url</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := gin.Default()</span><br><span class="line">    goodsGroup := r.Group(<span class="string">&quot;/goods&quot;</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        goodsGroup.GET(<span class="string">&quot;/list&quot;</span>, goodsList)</span><br><span class="line">        <span class="comment">//goodsGroup.GET(&quot;/1&quot;, goodsDetail)</span></span><br><span class="line">        goodsGroup.GET(<span class="string">&quot;/:id/:action&quot;</span>, goodsDetail)</span><br><span class="line">    &#125;</span><br><span class="line">    r.Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">goodsDetail</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    id := c.Param(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">    action := c.Param(<span class="string">&quot;action&quot;</span>)</span><br><span class="line">    c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;id&quot;</span>:     id,</span><br><span class="line">        <span class="string">&quot;action&quot;</span>: action,</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// http://127.0.0.1:8080/goods/1/detail</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">goodsList</span><span class="params">(context *gin.Context)</span></span> &#123;</span><br><span class="line">    context.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;goodsList&quot;</span>,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="获取路由分组的参数"><a href="#获取路由分组的参数" class="headerlink" title="获取路由分组的参数"></a>获取路由分组的参数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Person <span class="keyword">struct</span> &#123;</span><br><span class="line">    ID   <span class="type">int</span>    <span class="string">`uri:&quot;id&quot; binding:&quot;required&quot;`</span></span><br><span class="line">    Name <span class="type">string</span> <span class="string">`uri:&quot;name&quot; binding:&quot;required&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line">    router.GET(<span class="string">&quot;/:name/:id&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> person Person</span><br><span class="line">        <span class="keyword">if</span> err := c.ShouldBindUri(&amp;person); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            c.Status(<span class="number">404</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: person.Name,</span><br><span class="line">            <span class="string">&quot;id&quot;</span>:   person.ID,</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="comment">// http://127.0.0.1:8080/cwz/12</span></span><br><span class="line">    &#125;)</span><br><span class="line">    router.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获取get和post表单信息"><a href="#获取get和post表单信息" class="headerlink" title="获取get和post表单信息"></a>获取get和post表单信息</h3><h4 id="获取get参数"><a href="#获取get参数" class="headerlink" title="获取get参数"></a>获取get参数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line">    router.GET(<span class="string">&quot;/welcome&quot;</span>, welcome)</span><br><span class="line">    router.Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">welcome</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    first := c.DefaultQuery(<span class="string">&quot;first&quot;</span>, <span class="string">&quot;cwz&quot;</span>)</span><br><span class="line">    last := c.DefaultQuery(<span class="string">&quot;last&quot;</span>, <span class="string">&quot;jack&quot;</span>)</span><br><span class="line">    c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;first_name&quot;</span>: first,</span><br><span class="line">        <span class="string">&quot;last_name&quot;</span>:  last,</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/welcome，显示默认值：">http://127.0.0.1:8080/welcome，显示默认值：</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    first_name<span class="punctuation">:</span> <span class="string">&quot;cwz&quot;</span><span class="punctuation">,</span></span><br><span class="line">    last_name<span class="punctuation">:</span> <span class="string">&quot;jack&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>访问：<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/welcome?first=zs&amp;last=lisi，获取get请求的值：">http://127.0.0.1:8080/welcome?first=zs&amp;last=lisi，获取get请求的值：</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    first_name<span class="punctuation">:</span> <span class="string">&quot;zs&quot;</span><span class="punctuation">,</span></span><br><span class="line">    last_name<span class="punctuation">:</span> <span class="string">&quot;lisi&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="获取post参数"><a href="#获取post参数" class="headerlink" title="获取post参数"></a>获取post参数</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line"></span><br><span class="line">    router.POST(<span class="string">&quot;/form_post&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        message := c.PostForm(<span class="string">&quot;message&quot;</span>)</span><br><span class="line">        nick := c.DefaultPostForm(<span class="string">&quot;nick&quot;</span>, <span class="string">&quot;anonymous&quot;</span>) <span class="comment">// 此方法可以设置默认值</span></span><br><span class="line"></span><br><span class="line">        c.JSON(<span class="number">200</span>, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;status&quot;</span>:  <span class="string">&quot;posted&quot;</span>,</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: message,</span><br><span class="line">            <span class="string">&quot;nick&quot;</span>:    nick,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    router.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="get-post混合"><a href="#get-post混合" class="headerlink" title="get post混合"></a>get post混合</h4><p>POST /post?id=1234&amp;page=1 HTTP/1.1<br>Content-Type: application/x-www-form-urlencoded</p>
<p>name=manu&amp;message=this_is_great</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line"></span><br><span class="line">    router.POST(<span class="string">&quot;/post&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        id := c.Query(<span class="string">&quot;id&quot;</span>)</span><br><span class="line">        page := c.DefaultQuery(<span class="string">&quot;page&quot;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">        name := c.PostForm(<span class="string">&quot;name&quot;</span>)</span><br><span class="line">        message := c.PostForm(<span class="string">&quot;message&quot;</span>)</span><br><span class="line"></span><br><span class="line">        fmt.Printf(<span class="string">&quot;id: %s; page: %s; name: %s; message: %s&quot;</span>, id, page, name, message)</span><br><span class="line">    &#125;)</span><br><span class="line">    router.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="JSON、ProtoBuf-渲染"><a href="#JSON、ProtoBuf-渲染" class="headerlink" title="JSON、ProtoBuf 渲染"></a>JSON、ProtoBuf 渲染</h3><h4 id="输出JSON"><a href="#输出JSON" class="headerlink" title="输出JSON"></a>输出JSON</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line">    router.GET(<span class="string">&quot;/moreJSON&quot;</span>, moreJSON)</span><br><span class="line">    router.Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">moreJSON</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">    <span class="keyword">var</span> msg <span class="keyword">struct</span> &#123;</span><br><span class="line">        Name    <span class="type">string</span> <span class="string">`json:&quot;user&quot;`</span>   <span class="comment">// 利用结构体的标签特性</span></span><br><span class="line">        Message <span class="type">string</span></span><br><span class="line">        Number  <span class="type">int</span></span><br><span class="line">    &#125;</span><br><span class="line">    msg.Name = <span class="string">&quot;cwz&quot;</span></span><br><span class="line">    msg.Message = <span class="string">&quot;这是一个测试json&quot;</span></span><br><span class="line">    msg.Number = <span class="number">20</span></span><br><span class="line"></span><br><span class="line">    c.JSON(http.StatusOK, msg)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>访问<a target="_blank" rel="noopener" href="http://127.0.0.1:8080/moreJSON，输出：">http://127.0.0.1:8080/moreJSON，输出：</a></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    user<span class="punctuation">:</span> <span class="string">&quot;cwz&quot;</span><span class="punctuation">,</span></span><br><span class="line">    Message<span class="punctuation">:</span> <span class="string">&quot;这是一个测试json&quot;</span><span class="punctuation">,</span></span><br><span class="line">    Number<span class="punctuation">:</span> <span class="number">20</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<h4 id="输出ProtoBuf"><a href="#输出ProtoBuf" class="headerlink" title="输出ProtoBuf"></a>输出ProtoBuf</h4><p>新建user.proto文件：</p>
<figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">Teacher</span> &#123;</span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">repeated</span> <span class="type">string</span> course = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;start/gin_t/proto&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := gin.Default()</span><br><span class="line"></span><br><span class="line">    r.GET(<span class="string">&quot;/someProtoBuf&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        courses := []<span class="type">string</span>&#123;<span class="string">&quot;python&quot;</span>, <span class="string">&quot;django&quot;</span>, <span class="string">&quot;go&quot;</span>&#125;</span><br><span class="line">        <span class="comment">// The specific definition of protobuf is written in the testdata/protoexample file.</span></span><br><span class="line">        data := &amp;proto.Teacher&#123;</span><br><span class="line">            Name: <span class="string">&quot;justgo&quot;</span>,</span><br><span class="line">            Course:  courses,</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Note that data becomes binary data in the response</span></span><br><span class="line">        <span class="comment">// Will output protoexample.Test protobuf serialized data</span></span><br><span class="line">        c.ProtoBuf(http.StatusOK, data)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="comment">// Listen and serve on 0.0.0.0:8080</span></span><br><span class="line">    r.Run(<span class="string">&quot;:8083&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="PureJSON"><a href="#PureJSON" class="headerlink" title="PureJSON"></a>PureJSON</h4><p>通常情况下，JSON会将特殊的HTML字符替换为对应的unicode字符，比如<code>&lt;</code>替换为<code>\u003c</code>，如果想原样输出html，则使用PureJSON</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    r := gin.Default()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Serves unicode entities</span></span><br><span class="line">    r.GET(<span class="string">&quot;/json&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(<span class="number">200</span>, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;html&quot;</span>: <span class="string">&quot;&lt;b&gt;Hello, world!&lt;/b&gt;&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Serves literal characters</span></span><br><span class="line">    r.GET(<span class="string">&quot;/purejson&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.PureJSON(<span class="number">200</span>, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;html&quot;</span>: <span class="string">&quot;&lt;b&gt;Hello, world!&lt;/b&gt;&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// listen and serve on 0.0.0.0:8080</span></span><br><span class="line">    r.Run(<span class="string">&quot;:8080&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="表单验证"><a href="#表单验证" class="headerlink" title="表单验证"></a>表单验证</h3><p>validator库参数校验若干实用技巧</p>
<h4 id="表单的基本验证"><a href="#表单的基本验证" class="headerlink" title="表单的基本验证"></a>表单的基本验证</h4><p>若要将请求主体绑定到结构体中，请使用模型绑定，目前支持JSON、XML、YAML和标准表单值(foo=bar&amp;boo=baz)的绑定。</p>
<p>Gin使用 <a target="_blank" rel="noopener" href="https://github.com/go-playground/validator">go-playground/validator</a> 验证参数，<a target="_blank" rel="noopener" href="https://godoc.org/github.com/go-playground/validator">查看完整文档</a></p>
<p>需要在绑定的字段上设置tag，比如，绑定格式为json，需要这样设置 <code>json:&quot;fieldname&quot;</code></p>
<p>此外，Gin还提供了两套绑定方法：</p>
<ul>
<li>Must bind<ul>
<li>这些方法底层使用 <code>MustBindWith</code>，如果存在绑定错误，请求将被以下指令中止，响应状态代码会被设置为400，请求头Content-Type被设置为<code>text/plain; charset=utf-8</code></li>
</ul>
</li>
<li>Should bind<ul>
<li>这些方法底层使用 <code>ShouldBindWith</code>，如果存在绑定错误，则返回错误，开发人员可以正确处理请求和错误</li>
</ul>
</li>
</ul>
<p>当我们使用绑定方法时，Gin会根据Content-Type推断出使用哪种绑定器，如果你确定你绑定的是什么，你可以使用<code>MustBindWith</code>或者<code>BindingWith</code>。</p>
<p>你还可以给字段指定特定规则的修饰符，如果一个字段用<code>binding:&quot;required&quot;</code>修饰，并且在绑定时该字段的值为空，那么将返回一个错误。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> LoginForm <span class="keyword">struct</span> &#123;</span><br><span class="line">    User     <span class="type">string</span> <span class="string">`json:&quot;user&quot; binding:&quot;required,min=3,max=10&quot;`</span></span><br><span class="line">    Password <span class="type">string</span> <span class="string">`json:&quot;password&quot; binding:&quot;required&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SignUpForm <span class="keyword">struct</span> &#123;</span><br><span class="line">    Age        <span class="type">uint8</span>  <span class="string">`json:&quot;age&quot; binding:&quot;gte=1,lte=150&quot;`</span></span><br><span class="line">    Name       <span class="type">string</span> <span class="string">`json:&quot;name&quot; binding:&quot;required,min=2&quot;`</span></span><br><span class="line">    Email      <span class="type">string</span> <span class="string">`json:&quot;email&quot; binding:&quot;required,email&quot;`</span></span><br><span class="line">    Password   <span class="type">string</span> <span class="string">`json:&quot;password&quot; binding:&quot;required&quot;`</span></span><br><span class="line">    RePassword <span class="type">string</span> <span class="string">`json:&quot;re_password&quot; binding:&quot;required,eqfield=Password&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    router := gin.Default()</span><br><span class="line">    router.POST(<span class="string">&quot;/loginJSON&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> loginForm LoginForm</span><br><span class="line">        <span class="keyword">if</span> err := c.ShouldBind(&amp;loginForm); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err.Error())</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: err.Error(),</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;登录成功&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    router.POST(<span class="string">&quot;/signup&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> signUpForm SignUpForm</span><br><span class="line">        <span class="keyword">if</span> err := c.ShouldBind(&amp;signUpForm); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            fmt.Println(err.Error())</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;</span><br><span class="line">                <span class="string">&quot;error&quot;</span>: err.Error(),</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;注册成功&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    router.Run()</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="表单验证错误翻译成中文"><a href="#表单验证错误翻译成中文" class="headerlink" title="表单验证错误翻译成中文"></a>表单验证错误翻译成中文</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin/binding&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/go-playground/locales/en&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/go-playground/locales/zh&quot;</span></span><br><span class="line">    ut <span class="string">&quot;github.com/go-playground/universal-translator&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/go-playground/validator/v10&quot;</span></span><br><span class="line">    enTranslations <span class="string">&quot;github.com/go-playground/validator/v10/translations/en&quot;</span></span><br><span class="line">    zhTranslations <span class="string">&quot;github.com/go-playground/validator/v10/translations/zh&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 定义一个全局翻译器T</span></span><br><span class="line"><span class="keyword">var</span> trans ut.Translator</span><br><span class="line"></span><br><span class="line"><span class="comment">// InitTrans 初始化翻译器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitTrans</span><span class="params">(locale <span class="type">string</span>)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 修改gin框架中的Validator引擎属性，实现自定制</span></span><br><span class="line">    <span class="keyword">if</span> v, ok := binding.Validator.Engine().(*validator.Validate); ok &#123;</span><br><span class="line"></span><br><span class="line">        zhT := zh.New() <span class="comment">// 中文翻译器</span></span><br><span class="line">        enT := en.New() <span class="comment">// 英文翻译器</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个参数是备用（fallback）的语言环境</span></span><br><span class="line">        <span class="comment">// 后面的参数是应该支持的语言环境（支持多个）</span></span><br><span class="line">        <span class="comment">// uni := ut.New(zhT, zhT) 也是可以的</span></span><br><span class="line">        uni := ut.New(enT, zhT, enT)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// locale 通常取决于 http 请求头的 &#x27;Accept-Language&#x27;</span></span><br><span class="line">        <span class="keyword">var</span> ok <span class="type">bool</span></span><br><span class="line">        <span class="comment">// 也可以使用 uni.FindTranslator(...) 传入多个locale进行查找</span></span><br><span class="line">        trans, ok = uni.GetTranslator(locale)</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;uni.GetTranslator(%s) failed&quot;</span>, locale)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册翻译器</span></span><br><span class="line">        <span class="keyword">switch</span> locale &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;en&quot;</span>:</span><br><span class="line">            err = enTranslations.RegisterDefaultTranslations(v, trans)</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&quot;zh&quot;</span>:</span><br><span class="line">            err = zhTranslations.RegisterDefaultTranslations(v, trans)</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            err = enTranslations.RegisterDefaultTranslations(v, trans)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> SignUpParam <span class="keyword">struct</span> &#123;</span><br><span class="line">    Age        <span class="type">uint8</span>  <span class="string">`json:&quot;age&quot; binding:&quot;gte=1,lte=130&quot;`</span></span><br><span class="line">    Name       <span class="type">string</span> <span class="string">`json:&quot;name&quot; binding:&quot;required&quot;`</span></span><br><span class="line">    Email      <span class="type">string</span> <span class="string">`json:&quot;email&quot; binding:&quot;required,email&quot;`</span></span><br><span class="line">    Password   <span class="type">string</span> <span class="string">`json:&quot;password&quot; binding:&quot;required&quot;`</span></span><br><span class="line">    RePassword <span class="type">string</span> <span class="string">`json:&quot;re_password&quot; binding:&quot;required,eqfield=Password&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> err := InitTrans(<span class="string">&quot;zh&quot;</span>); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Printf(<span class="string">&quot;init trans failed, err:%v\n&quot;</span>, err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    r := gin.Default()</span><br><span class="line"></span><br><span class="line">    r.POST(<span class="string">&quot;/signup&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> u SignUpParam</span><br><span class="line">        <span class="keyword">if</span> err := c.ShouldBind(&amp;u); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// 获取validator.ValidationErrors类型的errors</span></span><br><span class="line">            errs, ok := err.(validator.ValidationErrors)</span><br><span class="line">            <span class="keyword">if</span> !ok &#123;</span><br><span class="line">                <span class="comment">// 非validator.ValidationErrors类型错误直接返回</span></span><br><span class="line">                c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">                    <span class="string">&quot;msg&quot;</span>: err.Error(),</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// validator.ValidationErrors类型错误则进行翻译</span></span><br><span class="line">            c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">                <span class="string">&quot;msg&quot;</span>:errs.Translate(trans),</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 保存入库等具体业务逻辑代码...</span></span><br><span class="line"></span><br><span class="line">        c.JSON(http.StatusOK, <span class="string">&quot;success&quot;</span>)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    _ = r.Run(<span class="string">&quot;:8999&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="进一步改进校验"><a href="#进一步改进校验" class="headerlink" title="进一步改进校验"></a>进一步改进校验</h4><p>上面的错误提示看起来是可以了，但是还是差点意思，首先是错误提示中的字段并不是请求中使用的字段，例如：<code>RePassword</code>是我们后端定义的结构体中的字段名，而请求中使用的是<code>re_password</code>字段。如何是错误提示中的字段使用自定义的名称，例如<code>json</code>tag指定的值呢？</p>
<p>只需要在初始化翻译器的时候像下面一样添加一个获取<code>json</code> tag的自定义方法即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InitTrans 初始化翻译器</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">InitTrans</span><span class="params">(locale <span class="type">string</span>)</span></span> (err <span class="type">error</span>) &#123;</span><br><span class="line">    <span class="comment">// 修改gin框架中的Validator引擎属性，实现自定制</span></span><br><span class="line">    <span class="keyword">if</span> v, ok := binding.Validator.Engine().(*validator.Validate); ok &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册一个获取json tag的自定义方法</span></span><br><span class="line">        v.RegisterTagNameFunc(<span class="function"><span class="keyword">func</span><span class="params">(fld reflect.StructField)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">            name := strings.SplitN(fld.Tag.Get(<span class="string">&quot;json&quot;</span>), <span class="string">&quot;,&quot;</span>, <span class="number">2</span>)[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> name == <span class="string">&quot;-&quot;</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> name</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        zhT := zh.New() <span class="comment">// 中文翻译器</span></span><br><span class="line">        enT := en.New() <span class="comment">// 英文翻译器</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 第一个参数是备用（fallback）的语言环境</span></span><br><span class="line">        <span class="comment">// 后面的参数是应该支持的语言环境（支持多个）</span></span><br><span class="line">        <span class="comment">// uni := ut.New(zhT, zhT) 也是可以的</span></span><br><span class="line">        uni := ut.New(enT, zhT, enT)</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是还是有点瑕疵，那就是最终的错误提示信息中心还是有我们后端定义的结构体名称——<code>SignUpParam</code>，这个名称其实是不需要随错误提示返回给前端的，前端并不需要这个值。我们需要想办法把它去掉。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">removeTopStruct</span><span class="params">(fields <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>)</span></span> <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span> &#123;</span><br><span class="line">    res := <span class="keyword">map</span>[<span class="type">string</span>]<span class="type">string</span>&#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> field, err := <span class="keyword">range</span> fields &#123;</span><br><span class="line">        res[field[strings.Index(field, <span class="string">&quot;.&quot;</span>)+<span class="number">1</span>:]] = err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> err := c.ShouldBind(&amp;u); err != <span class="literal">nil</span> &#123;</span><br><span class="line">    <span class="comment">// 获取validator.ValidationErrors类型的errors</span></span><br><span class="line">    errs, ok := err.(validator.ValidationErrors)</span><br><span class="line">    <span class="keyword">if</span> !ok &#123;</span><br><span class="line">        <span class="comment">// 非validator.ValidationErrors类型错误直接返回</span></span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;msg&quot;</span>: err.Error(),</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// validator.ValidationErrors类型错误则进行翻译</span></span><br><span class="line">    <span class="comment">// 并使用removeTopStruct函数去除字段名中的结构体名称标识</span></span><br><span class="line">    c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        <span class="string">&quot;msg&quot;</span>: removeTopStruct(errs.Translate(trans)),</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gin中间件"><a href="#gin中间件" class="headerlink" title="gin中间件"></a>gin中间件</h3><h4 id="自定义中间件"><a href="#自定义中间件" class="headerlink" title="自定义中间件"></a>自定义中间件</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义中间件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MyLogger</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        t := time.Now()</span><br><span class="line"></span><br><span class="line">        c.Set(<span class="string">&quot;example&quot;</span>, <span class="string">&quot;123&quot;</span>)</span><br><span class="line">        <span class="comment">// 让原本该执行的逻辑继续执行</span></span><br><span class="line">        c.Next()</span><br><span class="line"></span><br><span class="line">        end := time.Since(t)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;耗时：%v\n&quot;</span>, end)</span><br><span class="line">        status := c.Writer.Status()</span><br><span class="line">        fmt.Println(<span class="string">&quot;状态：&quot;</span>, status)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.New()</span><br><span class="line">    <span class="comment">// 使用logger和recovery中间件，全局使用</span></span><br><span class="line">    router.Use(gin.Logger(), gin.Recovery())</span><br><span class="line"></span><br><span class="line">    router.Use(MyLogger())</span><br><span class="line"></span><br><span class="line">    router.GET(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;pong&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    router.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过abort终止中间件后续逻辑的执行</p>
<p>比如我加一个token的验证逻辑，只有通过token验证，才能执行后续操作：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自定义中间件</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MyLogger</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        t := time.Now()</span><br><span class="line"></span><br><span class="line">        c.Set(<span class="string">&quot;example&quot;</span>, <span class="string">&quot;123&quot;</span>)</span><br><span class="line">        <span class="comment">// 让原本该执行的逻辑继续执行</span></span><br><span class="line">        c.Next()</span><br><span class="line"></span><br><span class="line">        end := time.Since(t)</span><br><span class="line">        fmt.Printf(<span class="string">&quot;耗时：%v\n&quot;</span>, end)</span><br><span class="line">        status := c.Writer.Status()</span><br><span class="line">        fmt.Println(<span class="string">&quot;状态：&quot;</span>, status)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TokenRequired</span><span class="params">()</span></span> gin.HandlerFunc &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> token <span class="type">string</span></span><br><span class="line">        <span class="keyword">for</span> k, v := <span class="keyword">range</span> c.Request.Header &#123;</span><br><span class="line">            <span class="keyword">if</span> k == <span class="string">&quot;X-Token&quot;</span> &#123;</span><br><span class="line">                token = v[<span class="number">0</span>]</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                fmt.Println(k, v)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> token != <span class="string">&quot;cwz&quot;</span> &#123;</span><br><span class="line">            c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">                <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;未登录&quot;</span>,</span><br><span class="line">            &#125;)</span><br><span class="line">            <span class="keyword">return</span>  <span class="comment">// 这里的return阻止不了 中间件后续逻辑的执行</span></span><br><span class="line">        &#125;</span><br><span class="line">        c.Next()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    router := gin.Default()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 查看token</span></span><br><span class="line">    router.Use(TokenRequired())</span><br><span class="line"></span><br><span class="line">    router.GET(<span class="string">&quot;/ping&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;message&quot;</span>: <span class="string">&quot;pong&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    router.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>中间件那边的return不能停止后面逻辑的执行，需要使用<code>c.Abort()</code></p>
<h4 id="gin的中间件原理源码分析"><a href="#gin的中间件原理源码分析" class="headerlink" title="gin的中间件原理源码分析"></a>gin的中间件原理源码分析</h4><p>点进Use源码：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210621152846.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210621153330.png" alt=""></p>
<p>调用RouterGroup的User方法，点进去：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210621164751.png" alt=""></p>
<p>会给group加一个Handlers，这个handlers是一个切片</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210621164836.png" alt=""></p>
<p>所以当你调用Use这个方法把你的中间件注册进来的时候，就是把中间件的函数放到Handlers这个切片的后面，追加到尾部。</p>
<p>所以当使用如<code>router.GET()</code>时，点击GET源码查看，查看里面的handler：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210621165706.png" alt=""></p>
<p>查看combineHandlers：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210621165841.png" alt=""></p>
<p>把原来的grouphandlers拷贝到更大的空间，再把你传递的handler放到切片尾部。</p>
<p>当调用中间件时，执行的是<code>c.Next()</code>，看一下Next源码：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210621170054.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210621170157.png" alt=""></p>
<p>在Auth中间件中如果使用了return，只会在Auth中结束，往后的中间件函数不会停止的。即使Auth结束了，index仍然可以++，会依次调用后面的中间件。</p>
<h3 id="设置静态文件路径和html"><a href="#设置静态文件路径和html" class="headerlink" title="设置静态文件路径和html"></a>设置静态文件路径和html</h3><p>官方地址：<a target="_blank" rel="noopener" href="https://golang.org/pkg/html/template/">https://golang.org/pkg/html/template/</a></p>
<p>翻译： <a target="_blank" rel="noopener" href="https://colobu.com/2019/11/05/Golang-Templates-Cheatsheet/">https://colobu.com/2019/11/05/Golang-Templates-Cheatsheet/</a></p>
<h4 id="gin返回html"><a href="#gin返回html" class="headerlink" title="gin返回html"></a>gin返回html</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;path/filepath&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    router := gin.Default()</span><br><span class="line"></span><br><span class="line">    dir, _ := filepath.Abs(filepath.Dir(os.Args[<span class="number">0</span>]))</span><br><span class="line">    fmt.Println(<span class="string">&quot;路径：&quot;</span>, dir)  <span class="comment">// 路径： C:\Users\cwz\AppData\Local\Temp, 是一个临时路径</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// LoadHTMLFiles会将指定的目录下的文件加载好</span></span><br><span class="line">    router.LoadHTMLFiles(<span class="string">&quot;templates/index.tmpl&quot;</span>)</span><br><span class="line"></span><br><span class="line">    router.GET(<span class="string">&quot;/index&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.HTML(http.StatusOK, <span class="string">&quot;index.tmpl&quot;</span>, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;cwz&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    router.Run(<span class="string">&quot;:8083&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>templates/index.tmpl</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">&quot;en&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>&#123;&#123;.name&#125;&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="加载多个html"><a href="#加载多个html" class="headerlink" title="加载多个html"></a>加载多个html</h4><p>router.LoadHTMLFiles可以传多个html文件路径：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">router.LoadHTMLFiles(<span class="string">&quot;templates/index.tmpl&quot;</span>, <span class="string">&quot;templates/goods.tmpl&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>如果文件过多可以使用 LoadHTMLGlob</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 创建一个默认的路由引擎</span></span><br><span class="line">    r := gin.Default()</span><br><span class="line">        <span class="comment">// 配置模板</span></span><br><span class="line">    r.LoadHTMLGlob(<span class="string">&quot;templates/**/*&quot;</span>)</span><br><span class="line">     <span class="comment">//router.LoadHTMLFiles(&quot;templates/template1.html&quot;, &quot;templates/template2.html&quot;)</span></span><br><span class="line">    <span class="comment">// 配置静态文件夹路径 第一个参数是api，第二个是文件夹路径</span></span><br><span class="line">    r.StaticFS(<span class="string">&quot;/static&quot;</span>, http.Dir(<span class="string">&quot;./static&quot;</span>))</span><br><span class="line">    <span class="comment">// GET：请求方式；/hello：请求的路径</span></span><br><span class="line">    <span class="comment">// 当客户端以GET方法请求/hello路径时，会执行后面的匿名函数</span></span><br><span class="line">    r.GET(<span class="string">&quot;/posts/index&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        <span class="comment">// c.JSON：返回JSON格式的数据</span></span><br><span class="line">        c.HTML(http.StatusOK, <span class="string">&quot;posts/index.tmpl&quot;</span>, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;posts/index&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    r.GET(<span class="string">&quot;gets/login&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.HTML(http.StatusOK, <span class="string">&quot;posts/login.tmpl&quot;</span>, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;title&quot;</span>: <span class="string">&quot;gets/login&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 启动HTTP服务，默认在0.0.0.0:8080启动服务</span></span><br><span class="line">    r.Run()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">        &#123;&#123; .title &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>templates/posts/index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; define &quot;posts/index.tmpl&quot; &#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;&#123; .title &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Using posts/index.tmpl<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<p>templates/users/index.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; define &quot;users/index.tmpl&quot; &#125;&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span></span><br><span class="line">    &#123;&#123; .title &#125;&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Using users/index.tmpl<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line">&#123;&#123; end &#125;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="gin的优雅退出"><a href="#gin的优雅退出" class="headerlink" title="gin的优雅退出"></a>gin的优雅退出</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class="line">    <span class="string">&quot;net/http&quot;</span></span><br><span class="line">    <span class="string">&quot;os&quot;</span></span><br><span class="line">    <span class="string">&quot;os/signal&quot;</span></span><br><span class="line">    <span class="string">&quot;syscall&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 优雅退出，当我们关闭程序的时候应该做的后续处理</span></span><br><span class="line">    <span class="comment">// 微服务启动之前 或者 启动之后会做一件事：将当前的服务ip和端口注册到注册中心</span></span><br><span class="line">    <span class="comment">// 我们当前的服务停止了以后并没有告知注册中心</span></span><br><span class="line"></span><br><span class="line">    router := gin.Default()</span><br><span class="line">    router.GET(<span class="string">&quot;/&quot;</span>, <span class="function"><span class="keyword">func</span><span class="params">(c *gin.Context)</span></span> &#123;</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;pong&quot;</span>,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        router.Run(<span class="string">&quot;:8083&quot;</span>)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果想接收到信号</span></span><br><span class="line">    quit := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal)</span><br><span class="line">    <span class="comment">// SIGINT和SIGTERM任意一个信号有了之后会向channel发送一个消息</span></span><br><span class="line">    signal.Notify(quit, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">    &lt;-quit</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 退出之后，处理后续的逻辑</span></span><br><span class="line">    fmt.Println(<span class="string">&quot;关闭server中。。。&quot;</span>)</span><br><span class="line">    fmt.Println(<span class="string">&quot;注销服务。。。&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="微服务开发"><a href="#微服务开发" class="headerlink" title="微服务开发"></a>微服务开发</h1><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210622101138.png" alt=""></p>
<h2 id="第一个微服务：用户服务"><a href="#第一个微服务：用户服务" class="headerlink" title="第一个微服务：用户服务"></a>第一个微服务：用户服务</h2><h3 id="用户服务准备"><a href="#用户服务准备" class="headerlink" title="用户服务准备"></a>用户服务准备</h3><p>项目目录</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210622101241.png" alt=""></p>
<p>定义用户模型：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> user_srv.settings <span class="keyword">import</span> settings</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BaseModel</span>(<span class="title class_ inherited__">Model</span>):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        database = settings.DB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span>(<span class="title class_ inherited__">BaseModel</span>):</span><br><span class="line">    <span class="comment"># 用户模型</span></span><br><span class="line">    GENDER_CHOICES = (</span><br><span class="line">        (<span class="string">&quot;male&quot;</span>, <span class="string">&quot;男&quot;</span>),</span><br><span class="line">        (<span class="string">&quot;female&quot;</span>, <span class="string">&quot;女&quot;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    ROLE_CHOICES = (</span><br><span class="line">        (<span class="number">1</span>, <span class="string">&quot;普通用户&quot;</span>),</span><br><span class="line">        (<span class="number">2</span>, <span class="string">&quot;管理员&quot;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    mobile = CharField(max_length=<span class="number">11</span>, index=<span class="literal">True</span>, unique=<span class="literal">True</span>, verbose_name=<span class="string">&quot;手机号码&quot;</span>)</span><br><span class="line">    password = CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">&quot;密码&quot;</span>)</span><br><span class="line">    nick_name = CharField(max_length=<span class="number">20</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;昵称&quot;</span>)</span><br><span class="line">    head_url = CharField(max_length=<span class="number">200</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;头像&quot;</span>)</span><br><span class="line">    birthday = DateField(null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;生日&quot;</span>)</span><br><span class="line">    address = CharField(max_length=<span class="number">200</span>, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;地址&quot;</span>)</span><br><span class="line">    desc = TextField(null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;个人简介&quot;</span>)</span><br><span class="line">    gender = CharField(max_length=<span class="number">6</span>, choices=GENDER_CHOICES, null=<span class="literal">True</span>, verbose_name=<span class="string">&quot;性别&quot;</span>)</span><br><span class="line">    role = IntegerField(default=<span class="number">1</span>, choices=ROLE_CHOICES, verbose_name=<span class="string">&quot;用户角色&quot;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    settings.DB.create_tables([User])</span><br></pre></td></tr></table></figure>
<p>settings/settings.py:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> playhouse.pool <span class="keyword">import</span> PooledMySQLDatabase</span><br><span class="line"><span class="keyword">from</span> playhouse.shortcuts <span class="keyword">import</span> ReconnectMixin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用peewee的连接池，使用ReconnectMixin来防止连接断开查询失败</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReconnectMysqlDatabase</span>(ReconnectMixin, PooledMySQLDatabase):</span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">MYSQL_DB = <span class="string">&quot;mxshop_user_srv&quot;</span></span><br><span class="line">MYSQL_HOST = <span class="string">&quot;192.168.33.27&quot;</span></span><br><span class="line">MYSQL_PORT = <span class="number">3306</span></span><br><span class="line">MYSQL_USER = <span class="string">&quot;root&quot;</span></span><br><span class="line">MYSQL_PASSWORD = <span class="string">&quot;root&quot;</span></span><br><span class="line"></span><br><span class="line">DB = ReconnectMysqlDatabase(MYSQL_DB, host=MYSQL_HOST, port=MYSQL_PORT, user=MYSQL_USER, password=MYSQL_PASSWORD)</span><br></pre></td></tr></table></figure>
<h3 id="MD5盐值加密解决用户密码安全问题"><a href="#MD5盐值加密解决用户密码安全问题" class="headerlink" title="MD5盐值加密解决用户密码安全问题"></a>MD5盐值加密解决用户密码安全问题</h3><h4 id="MD5信息摘要"><a href="#MD5信息摘要" class="headerlink" title="MD5信息摘要"></a>MD5信息摘要</h4><p>Message Digest Algorithm 5，信息摘要算法</p>
<ul>
<li>压缩性：任意长度的数据，算出MD5值长度都是固定的</li>
<li>容易计算：从原数据计算MD5值很容易</li>
<li>抗修改性：对原数据进行任何修改，哪怕1个字节，MD5值差异都很大</li>
<li>强碰撞：想找到两个不太的数据，使他们具有相同的MD5值很困难</li>
<li>不可逆性：不可反解</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line">m = hashlib.md5()</span><br><span class="line">salt = <span class="string">&quot;gwoow&quot;</span></span><br><span class="line">password = <span class="string">&quot;123456&quot;</span></span><br><span class="line">m.update((salt+password).encode(<span class="string">&quot;utf8&quot;</span>))</span><br><span class="line"><span class="comment">#暴力破解 彩虹表</span></span><br><span class="line"><span class="built_in">print</span>(m.hexdigest())</span><br></pre></td></tr></table></figure>
<h4 id="MD5盐值加密"><a href="#MD5盐值加密" class="headerlink" title="MD5盐值加密"></a>MD5盐值加密</h4><ul>
<li>通过生成随机数和MD5生成字符串进行组合</li>
<li>数据库同时存储MD5值和salt值，验证正确性使用salt值进行MD5即可</li>
</ul>
<p>passlib文档 <a target="_blank" rel="noopener" href="https://passlib.readthedocs.io/en/stable/">https://passlib.readthedocs.io/en/stable/</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#首先pip install passlib</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> passlib.<span class="built_in">hash</span> <span class="keyword">import</span> pbkdf2_sha256</span><br><span class="line"><span class="built_in">hash</span> = pbkdf2_sha256.<span class="built_in">hash</span>(<span class="string">&quot;123456&quot;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hash</span>)</span><br><span class="line"><span class="built_in">print</span>(pbkdf2_sha256.verify(<span class="string">&quot;123456&quot;</span>, <span class="built_in">hash</span>))</span><br><span class="line"><span class="built_in">print</span>(pbkdf2_sha256.verify(<span class="string">&quot;122121&quot;</span>, <span class="built_in">hash</span>))</span><br></pre></td></tr></table></figure>
<p>go语言下的加密：<a target="_blank" rel="noopener" href="https://gowebexamples.com/password-hashing/">https://gowebexamples.com/password-hashing/</a></p>
<h3 id="proto接口定义和生成"><a href="#proto接口定义和生成" class="headerlink" title="proto接口定义和生成"></a>proto接口定义和生成</h3><figure class="highlight protobuf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">syntax = <span class="string">&quot;proto3&quot;</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;google/protobuf/empty.proto&quot;</span>;</span><br><span class="line"><span class="keyword">option</span> go_package = <span class="string">&quot;.;proto&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">service </span><span class="title class_">User</span> &#123;</span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetUserList(PageInfo) <span class="keyword">returns</span> (UserListResponse)</span>;   <span class="comment">// 用户列表</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetUserByMobile(MobileRequest) <span class="keyword">returns</span> (UserListResponse)</span>;  <span class="comment">// 通过mobile查询用户</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> GetUserById(IdRequest) <span class="keyword">returns</span> (UserInfoResponse)</span>;   <span class="comment">// 通过id查询用户</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> CreateUser(CreateUserInfo) <span class="keyword">returns</span> (UserInfoResponse)</span>;  <span class="comment">// 添加用户</span></span><br><span class="line">  <span class="function"><span class="keyword">rpc</span> UpdateUser(UpdateUserInfo) <span class="keyword">returns</span> (google.protobuf.Empty)</span>;  <span class="comment">//更新用户</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">PageInfo</span> &#123;</span><br><span class="line">  <span class="type">uint32</span> pn = <span class="number">1</span>;</span><br><span class="line">  <span class="type">uint32</span> pSize = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">MobileRequest</span> &#123;</span><br><span class="line">  <span class="type">string</span> mobile = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">IdRequest</span> &#123;</span><br><span class="line">  <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">CreateUserInfo</span> &#123;</span><br><span class="line">  <span class="type">string</span> nickName = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> password = <span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> mobile = <span class="number">3</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">UpdateUserInfo</span> &#123;</span><br><span class="line">  <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> nickName = <span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> gender = <span class="number">3</span>;</span><br><span class="line">  <span class="type">uint64</span> birthDay = <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">UserInfoResponse</span> &#123;</span><br><span class="line">  <span class="type">int32</span> id = <span class="number">1</span>;</span><br><span class="line">  <span class="type">string</span> password = <span class="number">2</span>;</span><br><span class="line">  <span class="type">string</span> mobile = <span class="number">3</span>;</span><br><span class="line">  <span class="type">string</span> nickName = <span class="number">4</span>;</span><br><span class="line">  <span class="type">uint64</span> birthDay = <span class="number">5</span>;</span><br><span class="line">  <span class="type">string</span> gender = <span class="number">6</span>;</span><br><span class="line">  <span class="type">int32</span> role = <span class="number">7</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">UserListResponse</span> &#123;</span><br><span class="line">  <span class="type">int32</span> total = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">repeated</span> UserInfoResponse data = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m grpc_tools.protoc --python_out=. --grpc_python_out=. -I . user.proto</span><br></pre></td></tr></table></figure>
<h3 id="用户列表接口"><a href="#用户列表接口" class="headerlink" title="用户列表接口"></a>用户列表接口</h3><p>handler/user.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.model.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2, user_pb2_grpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserServicer</span>(user_pb2_grpc.UserServicer):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetUserList</span>(<span class="params">self, request: user_pb2.PageInfo, context</span>):</span><br><span class="line">        <span class="comment"># 获取用户的列表</span></span><br><span class="line">        rsp = user_pb2.UserListResponse()</span><br><span class="line"></span><br><span class="line">        users = User.select()</span><br><span class="line">        rsp.total = users.count()</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 分页</span></span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        page = <span class="number">1</span></span><br><span class="line">        per_page_nums = <span class="number">10</span>  <span class="comment"># 每页的数量</span></span><br><span class="line">        <span class="keyword">if</span> request.pSize:</span><br><span class="line">            per_page_nums = request.pSize</span><br><span class="line">        <span class="keyword">if</span> request.pn:</span><br><span class="line">            start = per_page_nums * (request.pn - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        users = users.limit(per_page_nums).offset(start)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">            user_info_rsp = user_pb2.UserInfoResponse()</span><br><span class="line"></span><br><span class="line">            user_info_rsp.<span class="built_in">id</span> = user.<span class="built_in">id</span></span><br><span class="line">            user_info_rsp.password = user.password</span><br><span class="line">            user_info_rsp.mobile = user.mobile</span><br><span class="line">            user_info_rsp.role = user.role</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> user.nick_name:</span><br><span class="line">                user_info_rsp.nickName = user.nick_name</span><br><span class="line">            <span class="keyword">if</span> user.gender:</span><br><span class="line">                user_info_rsp.gender = user.gender</span><br><span class="line">            <span class="keyword">if</span> user.birthday:</span><br><span class="line">                user_info_rsp.birthDay = <span class="built_in">int</span>(time.mktime(user.birthday.timetuple()))</span><br><span class="line"></span><br><span class="line">            rsp.data.append(user_info_rsp)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rsp</span><br></pre></td></tr></table></figure>
<p>启动grpc服务</p>
<p>server.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2, user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.handler.user <span class="keyword">import</span> UserServicer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve</span>():</span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    user_pb2_grpc.add_UserServicer_to_server(UserServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">&quot;[::]:50051&quot;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>
<p>启动客户端，测试服务</p>
<p>client.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc, user_pb2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserTest</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 连接grpc服务器</span></span><br><span class="line">        channel = grpc.insecure_channel(<span class="string">&quot;127.0.0.1:50051&quot;</span>)</span><br><span class="line">        self.stub = user_pb2_grpc.UserStub(channel)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">user_list</span>(<span class="params">self</span>):</span><br><span class="line">        rsp: user_pb2.UserListResponse = self.stub.GetUserList(user_pb2.PageInfo(pn=<span class="number">2</span>, pSize=<span class="number">2</span>))</span><br><span class="line">        <span class="built_in">print</span>(rsp.total)</span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> rsp.data:</span><br><span class="line">            <span class="built_in">print</span>(user.mobile, user.birthDay)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    user = UserTest()</span><br><span class="line">    user.user_list()</span><br></pre></td></tr></table></figure>
<h3 id="日志库loguru"><a href="#日志库loguru" class="headerlink" title="日志库loguru"></a>日志库loguru</h3><p><a target="_blank" rel="noopener" href="https://loguru.readthedocs.io/en/stable/overview.html">https://loguru.readthedocs.io/en/stable/overview.html</a></p>
<p>grpc服务加入日志</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.handler.user <span class="keyword">import</span> UserServicer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve</span>():</span><br><span class="line">    <span class="comment"># 日志打入文件</span></span><br><span class="line">    logger.add(<span class="string">&quot;logs/user_srv_&#123;time&#125;.log&quot;</span>)</span><br><span class="line"></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    user_pb2_grpc.add_UserServicer_to_server(UserServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">&quot;[::]:50051&quot;</span>)</span><br><span class="line">    logger.info(<span class="string">&quot;启动服务：127.0.0.1:50051&quot;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>
<p>不同颜色的信息：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210622144907.png" alt=""></p>
<h3 id="优雅退出"><a href="#优雅退出" class="headerlink" title="优雅退出"></a>优雅退出</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.handler.user <span class="keyword">import</span> UserServicer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目路径</span></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(os.path.dirname(__name__)))</span><br><span class="line"><span class="built_in">print</span>(BASE_DIR)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, BASE_DIR)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_exit</span>(<span class="params">signo, frame</span>):</span><br><span class="line">    logger.info(<span class="string">&quot;进程中断&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve</span>():</span><br><span class="line">    logger.add(<span class="string">&quot;logs/user_srv_&#123;time&#125;.log&quot;</span>)</span><br><span class="line"></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    user_pb2_grpc.add_UserServicer_to_server(UserServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">&quot;[::]:50051&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主进程退出信号监听</span></span><br><span class="line">    signal.signal(signal.SIGINT, on_exit)</span><br><span class="line">    signal.signal(signal.SIGTERM, on_exit)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">&quot;启动服务：127.0.0.1:50051&quot;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>
<h3 id="通过argparse解析传递进入的参数"><a href="#通过argparse解析传递进入的参数" class="headerlink" title="通过argparse解析传递进入的参数"></a>通过argparse解析传递进入的参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">import</span> signal</span><br><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">from</span> concurrent <span class="keyword">import</span> futures</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2_grpc</span><br><span class="line"><span class="keyword">from</span> user_srv.handler.user <span class="keyword">import</span> UserServicer</span><br><span class="line"></span><br><span class="line"><span class="comment"># 项目路径</span></span><br><span class="line">BASE_DIR = os.path.dirname(os.path.abspath(os.path.dirname(__name__)))</span><br><span class="line"><span class="built_in">print</span>(BASE_DIR)</span><br><span class="line">sys.path.insert(<span class="number">0</span>, BASE_DIR)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">on_exit</span>(<span class="params">signo, frame</span>):</span><br><span class="line">    logger.info(<span class="string">&quot;进程中断&quot;</span>)</span><br><span class="line">    sys.exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">serve</span>():</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--ip&quot;</span>,</span><br><span class="line">                        nargs=<span class="string">&quot;?&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">str</span>,</span><br><span class="line">                        default=<span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;binding ip&quot;</span></span><br><span class="line">                        )</span><br><span class="line">    parser.add_argument(<span class="string">&quot;--port&quot;</span>,</span><br><span class="line">                        nargs=<span class="string">&quot;?&quot;</span>,</span><br><span class="line">                        <span class="built_in">type</span>=<span class="built_in">int</span>,</span><br><span class="line">                        default=<span class="number">50051</span>,</span><br><span class="line">                        <span class="built_in">help</span>=<span class="string">&quot;the listening port&quot;</span></span><br><span class="line">                        )</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    logger.add(<span class="string">&quot;logs/user_srv_&#123;time&#125;.log&quot;</span>)</span><br><span class="line"></span><br><span class="line">    server = grpc.server(futures.ThreadPoolExecutor(max_workers=<span class="number">10</span>))</span><br><span class="line">    user_pb2_grpc.add_UserServicer_to_server(UserServicer(), server)</span><br><span class="line">    server.add_insecure_port(<span class="string">f&quot;<span class="subst">&#123;args.ip&#125;</span>:<span class="subst">&#123;args.port&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 主进程退出信号监听</span></span><br><span class="line">    signal.signal(signal.SIGINT, on_exit)</span><br><span class="line">    signal.signal(signal.SIGTERM, on_exit)</span><br><span class="line"></span><br><span class="line">    logger.info(<span class="string">f&quot;启动服务：<span class="subst">&#123;args.ip&#125;</span>:<span class="subst">&#123;args.port&#125;</span>&quot;</span>)</span><br><span class="line">    server.start()</span><br><span class="line">    server.wait_for_termination()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    logging.basicConfig()</span><br><span class="line">    serve()</span><br></pre></td></tr></table></figure>
<h3 id="根据id和mobile查询用户是否存在"><a href="#根据id和mobile查询用户是否存在" class="headerlink" title="根据id和mobile查询用户是否存在"></a>根据id和mobile查询用户是否存在</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> date</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> grpc</span><br><span class="line"><span class="keyword">from</span> loguru <span class="keyword">import</span> logger</span><br><span class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> DoesNotExist</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> user_srv.model.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> user_srv.proto <span class="keyword">import</span> user_pb2, user_pb2_grpc</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserServicer</span>(user_pb2_grpc.UserServicer):</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">convert_user_to_rsp</span>(<span class="params">self, user</span>):</span><br><span class="line">        <span class="comment"># 将user的model对象转换成message对象</span></span><br><span class="line">        user_info_rsp = user_pb2.UserInfoResponse()</span><br><span class="line">        user_info_rsp.<span class="built_in">id</span> = user.<span class="built_in">id</span></span><br><span class="line">        user_info_rsp.password = user.password</span><br><span class="line">        user_info_rsp.mobile = user.mobile</span><br><span class="line">        user_info_rsp.role = user.role</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> user.nick_name:</span><br><span class="line">            user_info_rsp.nickName = user.nick_name</span><br><span class="line">        <span class="keyword">if</span> user.gender:</span><br><span class="line">            user_info_rsp.gender = user.gender</span><br><span class="line">        <span class="keyword">if</span> user.birthday:</span><br><span class="line">            user_info_rsp.birthDay = <span class="built_in">int</span>(time.mktime(user.birthday.timetuple()))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> user_info_rsp</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetUserList</span>(<span class="params">self, request: user_pb2.PageInfo, context</span>):</span><br><span class="line">        <span class="comment"># 获取用户的列表</span></span><br><span class="line">        rsp = user_pb2.UserListResponse()</span><br><span class="line"></span><br><span class="line">        users = User.select()</span><br><span class="line">        rsp.total = users.count()</span><br><span class="line">        <span class="comment"># 分页</span></span><br><span class="line">        start = <span class="number">0</span></span><br><span class="line">        per_page_nums = <span class="number">10</span>  <span class="comment"># 每页的数量</span></span><br><span class="line">        <span class="keyword">if</span> request.pSize:</span><br><span class="line">            per_page_nums = request.pSize</span><br><span class="line">        <span class="keyword">if</span> request.pn:</span><br><span class="line">            start = per_page_nums * (request.pn - <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        users = users.limit(per_page_nums).offset(start)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> user <span class="keyword">in</span> users:</span><br><span class="line">            rsp.data.append(self.convert_user_to_rsp(user))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> rsp</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetUserByid</span>(<span class="params">self, request: user_pb2.IdRequest, context</span>):</span><br><span class="line">        <span class="comment"># 通过id查询用户</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.get(User.<span class="built_in">id</span> == request.<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> self.convert_user_to_rsp(user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> DoesNotExist:</span><br><span class="line">            context.set_code(grpc.StatusCode.NOT_FOUND)</span><br><span class="line">            context.set_details(<span class="string">&quot;用户不存在&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> user_pb2.UserInfoResponse()</span><br><span class="line"></span><br><span class="line"><span class="meta">    @logger.catch</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">GetUserByMobile</span>(<span class="params">self, request: user_pb2.MobileRequest, context</span>):</span><br><span class="line">        <span class="comment"># 通过mobile查询用户</span></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.get(User.mobile == request.mobile)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> self.convert_user_to_rsp(user)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> DoesNotExist:</span><br><span class="line">            context.set_code(grpc.StatusCode.NOT_FOUND)</span><br><span class="line">            context.set_details(<span class="string">&quot;用户不存在&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> user_pb2.UserInfoResponse()</span><br></pre></td></tr></table></figure>
<h3 id="新建用户接口"><a href="#新建用户接口" class="headerlink" title="新建用户接口"></a>新建用户接口</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> passlib.<span class="built_in">hash</span> <span class="keyword">import</span> pbkdf2_sha256</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">CreateUser</span>(<span class="params">self, request: user_pb2.CreateUserInfo, context</span>):</span><br><span class="line">    <span class="comment"># 新建用户</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        User.get(User.mobile == request.mobile)</span><br><span class="line"></span><br><span class="line">        context.set_code(grpc.StatusCode.ALREADY_EXISTS)</span><br><span class="line">        context.set_details(<span class="string">&quot;用户已存在&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> user_pb2.UserInfoResponse()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> DoesNotExist:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">    user = User()</span><br><span class="line">    user.nick_name = request.nickName</span><br><span class="line">    user.mobile = request.mobile</span><br><span class="line">    user.password = pbkdf2_sha256.<span class="built_in">hash</span>(request.password)</span><br><span class="line">    user.save()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> self.convert_user_to_rsp(user)</span><br></pre></td></tr></table></figure>
<h3 id="更新用户"><a href="#更新用户" class="headerlink" title="更新用户"></a>更新用户</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> google.protobuf <span class="keyword">import</span> empty_pb2</span><br><span class="line"></span><br><span class="line"><span class="meta">@logger.catch</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">UpdateUser</span>(<span class="params">self, request: user_pb2.UpdateUserInfo, context</span>):</span><br><span class="line">    <span class="comment"># 更新用户</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        user = User.get(User.<span class="built_in">id</span> == request.<span class="built_in">id</span>)</span><br><span class="line"></span><br><span class="line">        user.nick_name = request.nickName</span><br><span class="line">        user.gender = request.gender</span><br><span class="line">        user.birthday = date.fromtimestamp(request.birthDay)</span><br><span class="line">        user.save()</span><br><span class="line">        <span class="keyword">return</span> empty_pb2.Empty()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> DoesNotExist:</span><br><span class="line">        context.set_code(grpc.StatusCode.NOT_FOUND)</span><br><span class="line">        context.set_details(<span class="string">&quot;用户不存在&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> user_pb2.UserInfoResponse()</span><br></pre></td></tr></table></figure>
<h2 id="用户服务的web层开发"><a href="#用户服务的web层开发" class="headerlink" title="用户服务的web层开发"></a>用户服务的web层开发</h2><p>项目目录：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210623091601.png" alt=""></p>
<h3 id="go高性能日志库-zap"><a href="#go高性能日志库-zap" class="headerlink" title="go高性能日志库-zap"></a>go高性能日志库-zap</h3><p>github地址：<a target="_blank" rel="noopener" href="https://github.com/uber-go/zap">https://github.com/uber-go/zap</a></p>
<p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get -u go.uber.org/zap</span><br></pre></td></tr></table></figure>
<h4 id="简单使用-2"><a href="#简单使用-2" class="headerlink" title="简单使用"></a>简单使用</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    logger, _ := zap.NewProduction() <span class="comment">// 生产环境</span></span><br><span class="line">    <span class="comment">//logger, _ = zap.NewDevelopment()  // 开发环境</span></span><br><span class="line">    <span class="keyword">defer</span> logger.Sync() <span class="comment">// flushes buffer, if any</span></span><br><span class="line">    url := <span class="string">&quot;https://www.baidu.com&quot;</span></span><br><span class="line">    sugar := logger.Sugar()</span><br><span class="line">    sugar.Infow(<span class="string">&quot;failed to fetch URL&quot;</span>,</span><br><span class="line">        <span class="comment">// Structured context as loosely typed key-value pairs.</span></span><br><span class="line">        <span class="string">&quot;url&quot;</span>, url,</span><br><span class="line">        <span class="string">&quot;attempt&quot;</span>, <span class="number">3</span>,</span><br><span class="line">    )</span><br><span class="line">    sugar.Infof(<span class="string">&quot;Failed to fetch URL: %s&quot;</span>, url)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Zap提供了两种类型的日志记录器—<code>Sugared Logger</code>和<code>Logger</code>。</p>
<p>在性能很好但不是很关键的上下文中，使用<code>SugaredLogger</code>。它比其他结构化日志记录包快4-10倍，并且支持结构化和printf风格的日志记录。</p>
<p>在每一微秒和每一次内存分配都很重要的上下文中，使用<code>Logger</code>。它甚至比<code>SugaredLogger</code>更快，内存分配次数也更少，但它只支持强类型的结构化日志记录</p>
<h4 id="zap的文件输出"><a href="#zap的文件输出" class="headerlink" title="zap的文件输出"></a>zap的文件输出</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;go.uber.org/zap&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewLogger</span><span class="params">()</span></span> (*zap.Logger, <span class="type">error</span>) &#123;</span><br><span class="line">    cfg := zap.NewProductionConfig()</span><br><span class="line">    cfg.OutputPaths = []<span class="type">string</span>&#123;</span><br><span class="line">        <span class="string">&quot;./myproject.log&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> cfg.Build()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>  &#123;</span><br><span class="line">    <span class="comment">//logger, _ := zap.NewProduction()</span></span><br><span class="line">    logger, err := NewLogger()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">        <span class="comment">//panic(&quot;初始化logger失败&quot;)</span></span><br><span class="line">    &#125;</span><br><span class="line">    su := logger.Sugar()</span><br><span class="line">    <span class="keyword">defer</span> su.Sync()</span><br><span class="line">    url := <span class="string">&quot;https://www.baidu.com&quot;</span></span><br><span class="line">    su.Info(<span class="string">&quot;failed to fetch URL&quot;</span>,</span><br><span class="line">        <span class="comment">// Structured context as strongly typed Field values.</span></span><br><span class="line">        zap.String(<span class="string">&quot;url&quot;</span>, url),</span><br><span class="line">        zap.Int(<span class="string">&quot;attempt&quot;</span>, <span class="number">3</span>),</span><br><span class="line">        zap.Duration(<span class="string">&quot;backoff&quot;</span>, time.Second),</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="go的配置文件管理-viper"><a href="#go的配置文件管理-viper" class="headerlink" title="go的配置文件管理-viper"></a>go的配置文件管理-viper</h3><p>Viper是适用于Go应用程序的完整配置解决方案。它被设计用于在应用程序中工作，并且可以处理所有类型的配置需求和格式。它支持以下特性：</p>
<ul>
<li><p>设置默认值</p>
</li>
<li><p>从<code>JSON</code>、<code>TOML</code>、<code>YAML</code>、<code>HCL</code>、<code>envfile</code>和<code>Java properties</code>格式的配置文件读取配置信息</p>
</li>
<li><p>实时监控和重新读取配置文件（可选）</p>
</li>
<li><p>从环境变量中读取</p>
</li>
<li><p>从远程配置系统（etcd或Consul）读取并监控配置变化</p>
</li>
<li><p>从命令行参数读取配置</p>
</li>
<li><p>从buffer读取配置</p>
</li>
<li><p>显式配置值</p>
</li>
</ul>
<p>安装：<a target="_blank" rel="noopener" href="https://github.com/spf13/viper">https://github.com/spf13/viper</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/spf13/viper</span><br></pre></td></tr></table></figure>
<h4 id="将配置文件映射成struct"><a href="#将配置文件映射成struct" class="headerlink" title="将配置文件映射成struct"></a>将配置文件映射成struct</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> ServerConfig <span class="keyword">struct</span>&#123;</span><br><span class="line">    ServiceName <span class="type">string</span> <span class="string">`mapstructure:&quot;name&quot;`</span></span><br><span class="line">    Port <span class="type">int</span> <span class="string">`mapstructure:&quot;port&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    v := viper.New()</span><br><span class="line">    <span class="comment">//文件的路径如何设置</span></span><br><span class="line">    v.SetConfigFile(<span class="string">&quot;viper_test/ch01/config.yaml&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> err := v.ReadInConfig(); err != <span class="literal">nil</span>&#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    serverConfig := ServerConfig&#123;&#125;</span><br><span class="line">    <span class="keyword">if</span> err := v.Unmarshal(&amp;serverConfig); err != <span class="literal">nil</span>&#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(serverConfig)</span><br><span class="line">    fmt.Printf(<span class="string">&quot;%V&quot;</span>, v.Get(<span class="string">&quot;name&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置文件config.yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;user-web&#x27;</span></span><br><span class="line"><span class="attr">port:</span> <span class="number">8021</span></span><br></pre></td></tr></table></figure>
<h4 id="开发环境与生产环境隔离："><a href="#开发环境与生产环境隔离：" class="headerlink" title="开发环境与生产环境隔离："></a>开发环境与生产环境隔离：</h4><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    <span class="string">&quot;fmt&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/fsnotify/fsnotify&quot;</span></span><br><span class="line">    <span class="string">&quot;github.com/spf13/viper&quot;</span></span><br><span class="line">    <span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> MysqlConfig <span class="keyword">struct</span> &#123;</span><br><span class="line">    Host <span class="type">string</span> <span class="string">`mapstructure:&quot;host&quot;`</span></span><br><span class="line">    Port <span class="type">int</span> <span class="string">`mapstructure:&quot;port&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> ServerConfig <span class="keyword">struct</span>&#123;</span><br><span class="line">    Name <span class="type">string</span> <span class="string">`mapstructure:&quot;name&quot;`</span></span><br><span class="line">    MysqlInfo MysqlConfig <span class="string">`mapstructure:&quot;mysql&quot;`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 读取环境变量</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">GetEnvInfo</span><span class="params">(env <span class="type">string</span>)</span></span> <span class="type">string</span> &#123;</span><br><span class="line">    viper.AutomaticEnv()</span><br><span class="line">    <span class="keyword">return</span> viper.GetString(env)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    data := GetEnvInfo(<span class="string">&quot;Debug&quot;</span>)</span><br><span class="line">    <span class="keyword">var</span> configFileName <span class="type">string</span></span><br><span class="line">    configFileNamePrefix := <span class="string">&quot;config&quot;</span></span><br><span class="line">    <span class="keyword">if</span> data == <span class="string">&quot;true&quot;</span> &#123;</span><br><span class="line">        configFileName = fmt.Sprintf(<span class="string">&quot;viper_test/%s-debug.yaml&quot;</span>, configFileNamePrefix)</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        configFileName = fmt.Sprintf(<span class="string">&quot;viper_test/%s-pro.yaml&quot;</span>, configFileNamePrefix)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    serverConfig := ServerConfig&#123;&#125;</span><br><span class="line"></span><br><span class="line">    fmt.Println(data)</span><br><span class="line"></span><br><span class="line">    v := viper.New()</span><br><span class="line">    v.SetConfigFile(configFileName)</span><br><span class="line">    err := v.ReadInConfig()</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := v.Unmarshal(&amp;serverConfig); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="built_in">panic</span>(err)</span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(serverConfig)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="comment">// viper的功能-动态监控变化</span></span><br><span class="line">        v.WatchConfig()</span><br><span class="line">        v.OnConfigChange(<span class="function"><span class="keyword">func</span><span class="params">(e fsnotify.Event)</span></span> &#123;</span><br><span class="line">            fmt.Println(<span class="string">&quot;Config file changed:&quot;</span>, e.Name)</span><br><span class="line">            _ = v.ReadInConfig() <span class="comment">// 读取配置数据</span></span><br><span class="line">            _ = v.Unmarshal(&amp;serverConfig)</span><br><span class="line">            fmt.Println(serverConfig)</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;()</span><br><span class="line"></span><br><span class="line">    time.Sleep(time.Second*<span class="number">3000</span>)</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置文件：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">name:</span> <span class="string">&#x27;user-web&#x27;</span></span><br><span class="line"><span class="attr">mysql:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">&#x27;127.0.0.1&#x27;</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3306</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://setcreed.github.io">SetCreed</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://setcreed.github.io/posts/5a8b0b1c/">https://setcreed.github.io/posts/5a8b0b1c/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://setcreed.github.io" target="_blank">伊甸园</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-12.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/768e69ef/" title="golang面试题"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-14.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">golang面试题</div></div></a></div><div class="next-post pull-right"><a href="/posts/55d7cef/" title="Golang开发"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311041108629.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Golang开发</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">SetCreed</div><div class="author-info__description">读书、写代码、看电影</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/setcreed"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/img/qq.jpg" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/img/wechat_account.jpg" target="_blank" title="微信"><i class="fab fa-weixin"></i></a><a class="social-icon" href="https://github.com/setcreed" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:cwzdzg@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#golang%E5%9F%BA%E7%A1%80"><span class="toc-number">1.</span> <span class="toc-text">golang基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%92%8C%E5%B8%B8%E9%87%8F"><span class="toc-number">1.1.</span> <span class="toc-text">变量和常量</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">如何定义变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">单声明变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%9A%E5%A3%B0%E6%98%8E%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">多声明变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BF%E5%90%8D%E5%8F%98%E9%87%8F"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">匿名变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.1.2.</span> <span class="toc-text">常量的定义</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F"><span class="toc-number">1.1.2.1.</span> <span class="toc-text">常量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#iota"><span class="toc-number">1.1.2.2.</span> <span class="toc-text">iota</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E5%9F%BA%E6%9C%AC%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.</span> <span class="toc-text">go基本数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bool%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.1.</span> <span class="toc-text">bool类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E5%80%BC%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text">数值类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E5%9E%8B"><span class="toc-number">1.2.2.1.</span> <span class="toc-text">整数型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%AE%E7%82%B9%E5%9E%8B"><span class="toc-number">1.2.2.2.</span> <span class="toc-text">浮点型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.2.3.</span> <span class="toc-text">其他类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6"><span class="toc-number">1.2.2.4.</span> <span class="toc-text">字符</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2"><span class="toc-number">1.2.2.5.</span> <span class="toc-text">字符串</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B%E7%9A%84%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.2.3.</span> <span class="toc-text">数据类型的转换</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E8%BD%AC%E6%8D%A2%E6%93%8D%E4%BD%9C"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">简单的转换操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#strconv%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">strconv转换</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E7%9A%84%E8%BF%90%E7%AE%97%E7%AC%A6%E5%92%8C%E8%A1%A8%E8%BE%BE%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">go的运算符和表达式</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E6%9C%AF%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">1.3.1.</span> <span class="toc-text">算术运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E7%B3%BB%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">1.3.2.</span> <span class="toc-text">关系运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">1.3.3.</span> <span class="toc-text">逻辑运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%8D%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">1.3.4.</span> <span class="toc-text">位运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B5%8B%E5%80%BC%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">1.3.5.</span> <span class="toc-text">赋值运算符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96%E8%BF%90%E7%AE%97%E7%AC%A6"><span class="toc-number">1.3.6.</span> <span class="toc-text">其他运算符</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E7%9B%B8%E5%85%B3%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.</span> <span class="toc-text">字符串的相关操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.1.</span> <span class="toc-text">基本操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AC%E4%B9%89%E7%AC%A6"><span class="toc-number">1.4.2.</span> <span class="toc-text">转义符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%AD%90%E4%B8%B2%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">1.4.3.</span> <span class="toc-text">字符串子串的操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E7%9A%84%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E6%A0%BC%E5%BC%8F%E5%8C%96"><span class="toc-number">1.4.4.</span> <span class="toc-text">字符串的输入输出格式化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BC%BA%E7%9C%81%E6%A0%BC%E5%BC%8F%E5%92%8C%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.4.4.1.</span> <span class="toc-text">缺省格式和类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B4%E5%9E%8B-%E7%BC%A9%E8%BF%9B-%E8%BF%9B%E5%88%B6%E7%B1%BB%E5%9E%8B-%E6%AD%A3%E8%B4%9F%E7%AC%A6%E5%8F%B7"><span class="toc-number">1.4.4.2.</span> <span class="toc-text">整型(缩进, 进制类型, 正负符号)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6-%E6%9C%89%E5%BC%95%E5%8F%B7-Unicode"><span class="toc-number">1.4.4.3.</span> <span class="toc-text">字符(有引号, Unicode)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%AE%E7%82%B9-%E7%BC%A9%E8%BF%9B-%E7%B2%BE%E5%BA%A6-%E7%A7%91%E5%AD%A6%E8%AE%A1%E6%95%B0"><span class="toc-number">1.4.4.4.</span> <span class="toc-text">浮点(缩进, 精度, 科学计数)</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E8%AF%AD%E5%8F%A5%E5%92%8C%E5%BE%AA%E7%8E%AF%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.5.</span> <span class="toc-text">条件语句和循环语句</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#if"><span class="toc-number">1.5.1.</span> <span class="toc-text">if</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#for"><span class="toc-number">1.5.2.</span> <span class="toc-text">for</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#goto%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.5.3.</span> <span class="toc-text">goto语句</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#switch%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.5.4.</span> <span class="toc-text">switch语句</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B8%B8%E7%94%A8%E5%A4%8D%E6%9D%82%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.</span> <span class="toc-text">常用复杂的数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E6%95%B0%E7%BB%84"><span class="toc-number">1.6.1.</span> <span class="toc-text">go语言中的数组</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A3%B0%E6%98%8E%E5%92%8C%E5%88%9D%E5%A7%8B%E5%8C%96%E6%95%B0%E7%BB%84"><span class="toc-number">1.6.1.1.</span> <span class="toc-text">声明和初始化数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%96%E5%80%BC"><span class="toc-number">1.6.1.2.</span> <span class="toc-text">取值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for%E9%81%8D%E5%8E%86%E6%95%B0%E7%BB%84"><span class="toc-number">1.6.1.3.</span> <span class="toc-text">for遍历数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for-range-%E9%81%8D%E5%8E%86%E6%95%B0%E7%BB%84"><span class="toc-number">1.6.1.4.</span> <span class="toc-text">for range 遍历数组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E6%98%AF%E5%80%BC%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.6.1.5.</span> <span class="toc-text">数组是值类型</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E5%88%87%E7%89%87"><span class="toc-number">1.7.</span> <span class="toc-text">go语言中的切片</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E5%88%87%E7%89%87"><span class="toc-number">1.7.1.</span> <span class="toc-text">定义切片</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.7.2.</span> <span class="toc-text">使用方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#slice%E7%9A%84%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86"><span class="toc-number">1.7.3.</span> <span class="toc-text">slice的内部原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%87%E7%89%87%E7%9A%84%E6%89%A9%E5%AE%B9"><span class="toc-number">1.7.4.</span> <span class="toc-text">切片的扩容</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#map%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.8.</span> <span class="toc-text">map的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAmap"><span class="toc-number">1.8.1.</span> <span class="toc-text">创建map</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#map%E5%B8%B8%E8%A7%81%E6%93%8D%E4%BD%9C"><span class="toc-number">1.8.2.</span> <span class="toc-text">map常见操作</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E7%9A%84%E6%8C%87%E9%92%88"><span class="toc-number">1.9.</span> <span class="toc-text">go语言的指针</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AF%E6%8C%87%E9%92%88"><span class="toc-number">1.9.1.</span> <span class="toc-text">什么是指针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E9%92%88%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">1.9.2.</span> <span class="toc-text">指针的操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84%E6%8C%87%E9%92%88%E5%92%8C%E6%8C%87%E9%92%88%E6%95%B0%E7%BB%84"><span class="toc-number">1.9.3.</span> <span class="toc-text">数组指针和指针数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E5%90%91%E6%8C%87%E9%92%88%E7%9A%84%E6%8C%87%E9%92%88"><span class="toc-number">1.9.4.</span> <span class="toc-text">指向指针的指针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E7%9A%84nil"><span class="toc-number">1.9.5.</span> <span class="toc-text">go的nil</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#new%E5%87%BD%E6%95%B0%E5%92%8Cmake%E5%87%BD%E6%95%B0"><span class="toc-number">1.9.5.1.</span> <span class="toc-text">new函数和make函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#new%E5%87%BD%E6%95%B0%E5%9B%BE%E8%A7%A3"><span class="toc-number">1.9.5.2.</span> <span class="toc-text">new函数图解</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E7%9A%84%E5%87%BD%E6%95%B0"><span class="toc-number">1.10.</span> <span class="toc-text">go的函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.10.1.</span> <span class="toc-text">函数的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%82%E6%95%B0%E7%9A%84%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.10.2.</span> <span class="toc-text">参数的设置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%9C%81%E7%95%A5%E5%8F%B7%E6%9D%A5%E6%8E%A5%E6%94%B6%E4%BB%BB%E6%84%8F%E9%95%BF%E5%BA%A6%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">1.10.2.1.</span> <span class="toc-text">通过省略号来接收任意长度的参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%9C%81%E7%95%A5%E5%8F%B7%E5%B0%86slice%E6%89%93%E6%95%A3"><span class="toc-number">1.10.2.2.</span> <span class="toc-text">通过省略号将slice打散</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E9%95%BF%E5%BA%A6%E4%B8%8D%E5%AE%9A%E7%9A%84%E6%95%B0%E7%BB%84"><span class="toc-number">1.10.2.3.</span> <span class="toc-text">创建长度不定的数组</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8C%BF%E5%90%8D%E5%87%BD%E6%95%B0"><span class="toc-number">1.10.3.</span> <span class="toc-text">匿名函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.10.4.</span> <span class="toc-text">函数类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%97%AD%E5%8C%85%E5%87%BD%E6%95%B0"><span class="toc-number">1.10.5.</span> <span class="toc-text">闭包函数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">1.11.</span> <span class="toc-text">go的异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86"><span class="toc-number">1.11.1.</span> <span class="toc-text">错误处理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E7%9A%84%E9%94%99%E8%AF%AFerror%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.11.2.</span> <span class="toc-text">go的错误error类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#defer%E8%AF%AD%E5%8F%A5"><span class="toc-number">1.11.3.</span> <span class="toc-text">defer语句</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#defer%E8%AF%AD%E5%8F%A5%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.11.3.1.</span> <span class="toc-text">defer语句的使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#defer%E8%AF%AD%E5%8F%A5%E7%9A%84%E7%BB%86%E8%8A%82"><span class="toc-number">1.11.3.2.</span> <span class="toc-text">defer语句的细节</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-1"><span class="toc-number">1.11.4.</span> <span class="toc-text">go的异常处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.12.</span> <span class="toc-text">go语言中的结构体</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#type%E7%9A%84%E5%87%A0%E7%A7%8D%E4%BD%BF%E7%94%A8%E5%B8%B8%E8%A7%81"><span class="toc-number">1.12.1.</span> <span class="toc-text">type的几种使用常见</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%AE%9A%E4%B9%89"><span class="toc-number">1.12.2.</span> <span class="toc-text">结构体的定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E5%AE%9E%E4%BE%8B%E5%8C%96"><span class="toc-number">1.12.3.</span> <span class="toc-text">结构体的实例化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E9%9B%B6%E5%80%BC"><span class="toc-number">1.12.4.</span> <span class="toc-text">结构体的零值</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%BB%93%E6%9E%84%E4%BD%93%E6%97%A0%E5%A4%84%E4%B8%8D%E5%9C%A8"><span class="toc-number">1.12.5.</span> <span class="toc-text">go语言中结构体无处不在</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E4%B8%B2%E5%A4%B4%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.12.5.1.</span> <span class="toc-text">字符串头的结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#slice%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.12.5.2.</span> <span class="toc-text">slice的结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#map%E7%9A%84%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.12.5.3.</span> <span class="toc-text">map的结构体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%BB%91%E5%AE%9A%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.6.</span> <span class="toc-text">结构体绑定方法</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%96%B9%E6%B3%95"><span class="toc-number">1.12.6.1.</span> <span class="toc-text">定义方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E4%B8%A4%E7%A7%8D%E6%8E%A5%E6%94%B6%E5%BD%A2%E5%BC%8F"><span class="toc-number">1.12.6.2.</span> <span class="toc-text">结构体的两种接收形式</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%B5%8C%E7%BB%93%E6%9E%84%E4%BD%93%E5%AE%9E%E7%8E%B0%E7%BB%A7%E6%89%BF%E7%B1%BB%E4%BC%BC%E7%9A%84%E6%95%88%E6%9E%9C"><span class="toc-number">1.12.7.</span> <span class="toc-text">内嵌结构体实现继承类似的效果</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%B5%8C%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.12.7.1.</span> <span class="toc-text">内嵌结构体</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%BF%E5%90%8D%E5%86%85%E5%B5%8C%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.12.7.2.</span> <span class="toc-text">匿名内嵌结构体</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E7%9A%84%E6%A0%87%E7%AD%BE"><span class="toc-number">1.12.8.</span> <span class="toc-text">结构体的标签</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E7%9A%84%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.13.</span> <span class="toc-text">go语言的接口</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%B8%AD%E5%AD%90%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.13.1.</span> <span class="toc-text">鸭子类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E7%9A%84%E6%8E%A5%E5%8F%A3%E6%98%AF%E4%B8%80%E7%A7%8D%E6%8A%BD%E8%B1%A1%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.13.2.</span> <span class="toc-text">go的接口是一种抽象类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E6%94%AF%E6%8C%81%E7%BB%84%E5%90%88"><span class="toc-number">1.13.3.</span> <span class="toc-text">接口支持组合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E6%8E%A5%E5%8F%A3"><span class="toc-number">1.13.4.</span> <span class="toc-text">空接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E7%9A%84%E7%B1%BB%E5%9E%8B%E6%96%AD%E8%A8%80"><span class="toc-number">1.13.5.</span> <span class="toc-text">接口的类型断言</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0sort%E6%8E%92%E5%BA%8F"><span class="toc-number">1.13.6.</span> <span class="toc-text">实现sort排序</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E7%9A%84%E5%8F%8D%E5%B0%84"><span class="toc-number">1.14.</span> <span class="toc-text">go语言的反射</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.14.1.</span> <span class="toc-text">反射介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reflect%E5%8C%85"><span class="toc-number">1.14.2.</span> <span class="toc-text">reflect包</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Typeof"><span class="toc-number">1.14.2.1.</span> <span class="toc-text">Typeof</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E7%B1%BB%E5%88%ABKind"><span class="toc-number">1.14.2.1.1.</span> <span class="toc-text">获取类别Kind()</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ValueOf"><span class="toc-number">1.14.2.2.</span> <span class="toc-text">ValueOf</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8F%8D%E5%B0%84%E8%8E%B7%E5%8F%96%E5%80%BC"><span class="toc-number">1.14.2.2.1.</span> <span class="toc-text">通过反射获取值</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%8F%8D%E5%B0%84%E8%AE%BE%E7%BD%AE%E5%80%BC"><span class="toc-number">1.14.2.2.2.</span> <span class="toc-text">通过反射设置值</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#isNil-%E5%92%8CisValid"><span class="toc-number">1.14.2.3.</span> <span class="toc-text">isNil()和isValid()</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%8F%8D%E5%B0%84"><span class="toc-number">1.14.3.</span> <span class="toc-text">结构体反射</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8E%E7%BB%93%E6%9E%84%E4%BD%93%E7%9B%B8%E5%85%B3%E7%9A%84%E6%96%B9%E6%B3%95"><span class="toc-number">1.14.3.1.</span> <span class="toc-text">与结构体相关的方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#StructField%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.14.3.2.</span> <span class="toc-text">StructField类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%8F%8D%E5%B0%84%E7%A4%BA%E4%BE%8B"><span class="toc-number">1.14.3.3.</span> <span class="toc-text">结构体反射示例</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E7%9A%84%E5%8C%85%E7%AE%A1%E7%90%86"><span class="toc-number">1.15.</span> <span class="toc-text">go语言的包管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E7%9A%84import%E5%90%84%E7%A7%8D%E5%A7%BF%E5%8A%BF"><span class="toc-number">1.15.1.</span> <span class="toc-text">go的import各种姿势</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E8%A1%8C%E5%AF%BC%E5%85%A5%E5%92%8C%E5%A4%9A%E8%A1%8C%E5%AF%BC%E5%85%A5"><span class="toc-number">1.15.1.1.</span> <span class="toc-text">单行导入和多行导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%82%B9%E7%9A%84%E6%96%B9%E5%BC%8F%E5%AF%BC%E5%85%A5"><span class="toc-number">1.15.1.2.</span> <span class="toc-text">使用点的方式导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%88%AB%E5%90%8D"><span class="toc-number">1.15.1.3.</span> <span class="toc-text">使用别名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85%E7%9A%84%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.15.1.4.</span> <span class="toc-text">包的初始化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85%E7%9A%84%E5%8C%BF%E5%90%8D%E5%AF%BC%E5%85%A5"><span class="toc-number">1.15.1.5.</span> <span class="toc-text">包的匿名导入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#go%E5%AF%BC%E5%85%A5%E7%9A%84%E6%98%AF%E8%B7%AF%E5%BE%84%E8%80%8C%E4%B8%8D%E6%98%AF%E5%8C%85"><span class="toc-number">1.15.1.6.</span> <span class="toc-text">go导入的是路径而不是包</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Go-Modules%E7%9A%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.15.2.</span> <span class="toc-text">Go Modules的应用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GOPATH%E6%96%B9%E6%A1%88"><span class="toc-number">1.15.2.1.</span> <span class="toc-text">GOPATH方案</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#go-vendor%E6%A8%A1%E5%BC%8F%E7%9A%84%E8%BF%87%E6%B8%A1"><span class="toc-number">1.15.2.2.</span> <span class="toc-text">go vendor模式的过渡</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#go-mod"><span class="toc-number">1.15.2.3.</span> <span class="toc-text">go mod</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E7%9A%84%E7%BC%96%E7%A0%81%E8%A7%84%E8%8C%83"><span class="toc-number">1.16.</span> <span class="toc-text">go语言的编码规范</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%91%BD%E5%90%8D%E8%A7%84%E8%8C%83"><span class="toc-number">1.16.1.</span> <span class="toc-text">命名规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85%E5%90%8D%EF%BC%9Apackage"><span class="toc-number">1.16.1.1.</span> <span class="toc-text">包名：package</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%90%8D"><span class="toc-number">1.16.1.2.</span> <span class="toc-text">文件名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E5%91%BD%E5%90%8D"><span class="toc-number">1.16.1.3.</span> <span class="toc-text">结构体命名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A5%E5%8F%A3%E5%91%BD%E5%90%8D"><span class="toc-number">1.16.1.4.</span> <span class="toc-text">接口命名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%98%E9%87%8F%E5%91%BD%E5%90%8D"><span class="toc-number">1.16.1.5.</span> <span class="toc-text">变量命名</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E9%87%8F%E5%91%BD%E5%90%8D"><span class="toc-number">1.16.1.6.</span> <span class="toc-text">常量命名</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A%E8%A7%84%E8%8C%83"><span class="toc-number">1.16.2.</span> <span class="toc-text">注释规范</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8C%85%E6%B3%A8%E9%87%8A"><span class="toc-number">1.16.2.1.</span> <span class="toc-text">包注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93%E3%80%81%E6%8E%A5%E5%8F%A3-%E6%B3%A8%E9%87%8A"><span class="toc-number">1.16.2.2.</span> <span class="toc-text">结构体、接口 注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%87%BD%E6%95%B0%E6%B3%A8%E9%87%8A"><span class="toc-number">1.16.2.3.</span> <span class="toc-text">函数注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E9%80%BB%E8%BE%91%E6%B3%A8%E9%87%8A"><span class="toc-number">1.16.2.4.</span> <span class="toc-text">代码逻辑注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B3%A8%E9%87%8A%E9%A3%8E%E6%A0%BC"><span class="toc-number">1.16.2.5.</span> <span class="toc-text">注释风格</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#import%E8%A7%84%E8%8C%83"><span class="toc-number">1.16.3.</span> <span class="toc-text">import规范</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-1"><span class="toc-number">1.16.4.</span> <span class="toc-text">错误处理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E7%9A%84%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B"><span class="toc-number">1.17.</span> <span class="toc-text">go的并发编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#goroutine"><span class="toc-number">1.17.1.</span> <span class="toc-text">goroutine</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8goroutine"><span class="toc-number">1.17.1.1.</span> <span class="toc-text">简单使用goroutine</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%8D%95%E4%B8%AAgoroutine"><span class="toc-number">1.17.1.2.</span> <span class="toc-text">启动单个goroutine</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E5%A4%9A%E4%B8%AAgoroutine"><span class="toc-number">1.17.1.3.</span> <span class="toc-text">启动多个goroutine</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#goroutine%E8%B0%83%E5%BA%A6%E9%97%AE%E9%A2%98"><span class="toc-number">1.17.2.</span> <span class="toc-text">goroutine调度问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#goroutine%E8%B0%83%E5%BA%A6"><span class="toc-number">1.17.2.1.</span> <span class="toc-text">goroutine调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#GOMAXPROCS"><span class="toc-number">1.17.2.2.</span> <span class="toc-text">GOMAXPROCS</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#channel"><span class="toc-number">1.17.3.</span> <span class="toc-text">channel</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#channel%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.17.3.1.</span> <span class="toc-text">channel类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96channel"><span class="toc-number">1.17.3.2.</span> <span class="toc-text">初始化channel</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#channel%E7%9A%84%E6%93%8D%E4%BD%9C"><span class="toc-number">1.17.3.3.</span> <span class="toc-text">channel的操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%A0%E7%BC%93%E5%86%B2%E7%9A%84%E9%80%9A%E9%81%93"><span class="toc-number">1.17.3.4.</span> <span class="toc-text">无缓冲的通道</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%89%E7%BC%93%E5%86%B2%E7%9A%84%E9%80%9A%E9%81%93"><span class="toc-number">1.17.3.5.</span> <span class="toc-text">有缓冲的通道</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#for-range%E4%BB%8E%E9%80%9A%E9%81%93%E5%8F%96%E5%80%BC"><span class="toc-number">1.17.3.6.</span> <span class="toc-text">for range从通道取值</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%90%91%E9%80%9A%E9%81%93"><span class="toc-number">1.17.3.7.</span> <span class="toc-text">单向通道</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#worker-pool%EF%BC%88goroutine%E6%B1%A0%EF%BC%89"><span class="toc-number">1.17.4.</span> <span class="toc-text">worker pool（goroutine池）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#select%E5%A4%9A%E8%B7%AF%E5%A4%8D%E7%94%A8"><span class="toc-number">1.17.5.</span> <span class="toc-text">select多路复用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#select%E7%9A%84%E5%BA%94%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="toc-number">1.17.5.1.</span> <span class="toc-text">select的应用场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E9%94%81"><span class="toc-number">1.17.6.</span> <span class="toc-text">并发锁</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">1.17.6.1.</span> <span class="toc-text">互斥锁</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%AF%BB%E5%86%99%E4%BA%92%E6%96%A5%E9%94%81"><span class="toc-number">1.17.6.2.</span> <span class="toc-text">读写互斥锁</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#sync-WaitGroup"><span class="toc-number">1.17.7.</span> <span class="toc-text">sync.WaitGroup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E4%B8%AD%E7%9A%84Context"><span class="toc-number">1.17.8.</span> <span class="toc-text">go语言中的Context</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8Context"><span class="toc-number">1.17.8.1.</span> <span class="toc-text">简单使用Context</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%B9Context"><span class="toc-number">1.17.8.2.</span> <span class="toc-text">根Context</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Context-%E7%9A%84%E7%BB%A7%E6%89%BF%E8%A1%8D%E7%94%9F"><span class="toc-number">1.17.8.3.</span> <span class="toc-text">Context 的继承衍生</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#WithDeadline"><span class="toc-number">1.17.8.3.1.</span> <span class="toc-text">WithDeadline</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#WithTimeout"><span class="toc-number">1.17.8.3.2.</span> <span class="toc-text">WithTimeout</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E7%BD%91%E7%BB%9C%E7%BC%96%E7%A8%8B"><span class="toc-number">1.18.</span> <span class="toc-text">go网络编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E5%AE%9E%E7%8E%B0TCP%E9%80%9A%E4%BF%A1"><span class="toc-number">1.18.1.</span> <span class="toc-text">go实现TCP通信</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E5%AE%9E%E7%8E%B0%E5%AE%9E%E7%8E%B0UDP%E9%80%9A%E4%BF%A1"><span class="toc-number">1.18.2.</span> <span class="toc-text">go实现实现UDP通信</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go-websocket"><span class="toc-number">1.19.</span> <span class="toc-text">go websocket</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">1.20.</span> <span class="toc-text">go语言的单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#go-test%E5%B7%A5%E5%85%B7"><span class="toc-number">1.20.1.</span> <span class="toc-text">go test工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E5%87%BD%E6%95%B0"><span class="toc-number">1.20.2.</span> <span class="toc-text">测试函数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%A4%9A%E8%AF%AD%E8%A8%80%E9%80%9A%E4%BF%A1%E7%9A%84%E5%9F%BA%E7%A1%80"><span class="toc-number">2.</span> <span class="toc-text">多语言通信的基础</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#RPC%E5%9F%BA%E7%A1%80"><span class="toc-number">2.1.</span> <span class="toc-text">RPC基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%98%AFRPC"><span class="toc-number">2.1.1.</span> <span class="toc-text">什么是RPC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%AC%E5%9C%B0%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.1.1.</span> <span class="toc-text">本地过程调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%BF%87%E7%A8%8B%E8%B0%83%E7%94%A8%E5%B8%A6%E6%9D%A5%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.1.1.2.</span> <span class="toc-text">远程过程调用带来的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3"><span class="toc-number">2.1.1.3.</span> <span class="toc-text">如何解决</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rpc%E3%80%81http%E4%BB%A5%E5%8F%8Arestful-%E4%B9%8B%E9%97%B4%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">2.1.2.</span> <span class="toc-text">rpc、http以及restful 之间的区别</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RPC-%E5%92%8C-REST-%E5%8C%BA%E5%88%AB%E6%98%AF%E4%BB%80%E4%B9%88"><span class="toc-number">2.1.2.1.</span> <span class="toc-text">RPC 和 REST 区别是什么</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E5%BC%8F%E4%B8%8D%E5%90%8C"><span class="toc-number">2.1.2.2.</span> <span class="toc-text">使用方式不同</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9D%A2%E5%90%91%E5%AF%B9%E8%B1%A1%E4%B8%8D%E5%90%8C"><span class="toc-number">2.1.2.3.</span> <span class="toc-text">面向对象不同</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%8D%8F%E8%AE%AE%E4%B8%8D%E5%90%8C"><span class="toc-number">2.1.2.4.</span> <span class="toc-text">序列化协议不同</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87httpserver%E5%AE%9E%E7%8E%B0rpc"><span class="toc-number">2.1.3.</span> <span class="toc-text">通过httpserver实现rpc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RPC%E5%BC%80%E5%8F%91%E7%9A%84%E8%A6%81%E7%B4%A0%E5%88%86%E6%9E%90"><span class="toc-number">2.1.4.</span> <span class="toc-text">RPC开发的要素分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8EXML%E7%9A%84RPC%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.5.</span> <span class="toc-text">基于XML的RPC调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ejson%E5%AE%9E%E7%8E%B0RPC%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.6.</span> <span class="toc-text">基于json实现RPC调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zerorpc%E5%AE%9E%E7%8E%B0RPC%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.7.</span> <span class="toc-text">zerorpc实现RPC调用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%80%E5%85%83%E8%B0%83%E7%94%A8"><span class="toc-number">2.1.7.1.</span> <span class="toc-text">一元调用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%81%E5%BC%8F%E5%93%8D%E5%BA%94"><span class="toc-number">2.1.7.2.</span> <span class="toc-text">流式响应</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%A0%E5%85%A5%E5%A4%9A%E4%B8%AA%E5%8F%82%E6%95%B0"><span class="toc-number">2.1.7.3.</span> <span class="toc-text">传入多个参数</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#go%E8%AF%AD%E8%A8%80%E7%9A%84RPC%E8%B0%83%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">go语言的RPC调用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8"><span class="toc-number">2.2.1.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#RPC%E6%94%AF%E6%8C%81JSON"><span class="toc-number">2.2.2.</span> <span class="toc-text">RPC支持JSON</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ehttp%E7%9A%84RPC"><span class="toc-number">2.2.3.</span> <span class="toc-text">基于http的RPC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%94%B9%E8%BF%9BRPC%E8%B0%83%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="toc-number">2.2.4.</span> <span class="toc-text">进一步改进RPC调用过程</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#serviceName%E7%BB%9F%E4%B8%80%E5%92%8C%E5%90%8D%E7%A7%B0%E5%86%B2%E7%AA%81%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.2.4.1.</span> <span class="toc-text">serviceName统一和名称冲突的问题</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%A7%E7%BB%AD%E5%B1%8F%E8%94%BDHelloServiceName%E5%92%8CHello%E5%87%BD%E6%95%B0%E5%90%8D%E7%A7%B0"><span class="toc-number">2.2.4.2.</span> <span class="toc-text">继续屏蔽HelloServiceName和Hello函数名称</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC%E5%85%A5%E9%97%A8"><span class="toc-number">2.3.</span> <span class="toc-text">gRPC入门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gRPC%E5%92%8Cprotobuf"><span class="toc-number">2.3.1.</span> <span class="toc-text">gRPC和protobuf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python%E4%B8%8Bprotobuf%E4%BD%93%E9%AA%8C"><span class="toc-number">2.3.2.</span> <span class="toc-text">python下protobuf体验</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">2.3.2.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%93%E9%AA%8Cprotobuf3"><span class="toc-number">2.3.2.2.</span> <span class="toc-text">体验protobuf3</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%9F%E6%88%90proto%E7%9A%84python%E6%96%87%E4%BB%B6"><span class="toc-number">2.3.2.3.</span> <span class="toc-text">生成proto的python文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8Bprotobuf%E7%94%9F%E6%88%90%E7%9A%84%E4%BB%A3%E7%A0%81"><span class="toc-number">2.3.2.4.</span> <span class="toc-text">查看protobuf生成的代码</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#python%E4%BD%93%E9%AA%8Cgrpc%E5%BC%80%E5%8F%91"><span class="toc-number">2.3.3.</span> <span class="toc-text">python体验grpc开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E4%BD%93%E9%AA%8Cgrpc%E5%BC%80%E5%8F%91"><span class="toc-number">2.3.4.</span> <span class="toc-text">go体验grpc开发</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gRPC%E7%9A%84%E6%B5%81%E6%A8%A1%E5%BC%8F%E5%AE%9A%E4%B9%89"><span class="toc-number">2.3.5.</span> <span class="toc-text">gRPC的流模式定义</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%B1%E5%85%A5protobuf"><span class="toc-number">2.4.</span> <span class="toc-text">深入protobuf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#option-go-package%E7%9A%84%E4%BD%9C%E7%94%A8"><span class="toc-number">2.4.1.</span> <span class="toc-text">option go_package的作用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proto%E6%96%87%E4%BB%B6%E4%B8%8D%E5%90%8C%E6%AD%A5%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-number">2.4.2.</span> <span class="toc-text">proto文件不同步出现的问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proto%E5%BC%95%E7%94%A8%E5%85%B6%E4%BB%96%E7%9A%84proto%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.3.</span> <span class="toc-text">proto引用其他的proto文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B5%8C%E5%A5%97%E7%9A%84message%E5%AF%B9%E8%B1%A1"><span class="toc-number">2.4.4.</span> <span class="toc-text">嵌套的message对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#protobuf%E4%B8%AD%E7%9A%84%E5%85%B6%E4%BB%96%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.4.5.</span> <span class="toc-text">protobuf中的其他类型</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#gRPC%E6%B7%B1%E5%85%A5"><span class="toc-number">2.5.</span> <span class="toc-text">gRPC深入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#python%E7%9A%84grpc%E7%BB%93%E5%90%88asyncio"><span class="toc-number">2.5.1.</span> <span class="toc-text">python的grpc结合asyncio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gRPC%E7%9A%84metadata%E6%9C%BA%E5%88%B6"><span class="toc-number">2.5.2.</span> <span class="toc-text">gRPC的metadata机制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#go%E6%8E%A7%E5%88%B6grpc%E7%9A%84metadata"><span class="toc-number">2.5.2.1.</span> <span class="toc-text">go控制grpc的metadata</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#go%E4%B8%AD%E4%BD%BF%E7%94%A8metadata"><span class="toc-number">2.5.2.1.1.</span> <span class="toc-text">go中使用metadata</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#grpc%E4%B8%AD%E4%BD%BF%E7%94%A8metadata"><span class="toc-number">2.5.2.1.2.</span> <span class="toc-text">grpc中使用metadata</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python%E4%B8%AD%E4%BD%BF%E7%94%A8metadata"><span class="toc-number">2.5.2.2.</span> <span class="toc-text">python中使用metadata</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gRPC%E7%9A%84%E6%8B%A6%E6%88%AA%E5%99%A8"><span class="toc-number">2.5.3.</span> <span class="toc-text">gRPC的拦截器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#go%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.3.1.</span> <span class="toc-text">go实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#python%E5%AE%9E%E7%8E%B0"><span class="toc-number">2.5.3.2.</span> <span class="toc-text">python实现</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%8B%A6%E6%88%AA%E5%99%A8%E5%92%8Cmetadata%E5%AE%9E%E7%8E%B0grpc%E7%9A%84auth%E8%AE%A4%E8%AF%81"><span class="toc-number">2.5.4.</span> <span class="toc-text">通过拦截器和metadata实现grpc的auth认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grpc%E7%9A%84%E9%AA%8C%E8%AF%81%E5%99%A8"><span class="toc-number">2.5.5.</span> <span class="toc-text">grpc的验证器</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">2.5.5.1.</span> <span class="toc-text">安装和配置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#proto%E6%96%87%E4%BB%B6"><span class="toc-number">2.5.5.2.</span> <span class="toc-text">proto文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E7%AB%AF"><span class="toc-number">2.5.5.3.</span> <span class="toc-text">服务端</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF"><span class="toc-number">2.5.5.4.</span> <span class="toc-text">客户端</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gRPC%E4%B8%AD%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.5.6.</span> <span class="toc-text">gRPC中的异常处理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#python%E4%B8%AD%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.5.6.1.</span> <span class="toc-text">python中的异常处理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#go%E4%B8%AD%E7%9A%84%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="toc-number">2.5.6.2.</span> <span class="toc-text">go中的异常处理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gRPC%E7%9A%84%E8%B6%85%E6%97%B6%E6%9C%BA%E5%88%B6"><span class="toc-number">2.5.7.</span> <span class="toc-text">gRPC的超时机制</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#python%E7%9A%84orm%EF%BC%9Apeewee"><span class="toc-number">3.</span> <span class="toc-text">python的orm：peewee</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-1"><span class="toc-number">3.1.</span> <span class="toc-text">简单使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-1"><span class="toc-number">3.1.1.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E8%A1%A8%E7%BB%93%E6%9E%84"><span class="toc-number">3.1.2.</span> <span class="toc-text">定义表结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%95%B0%E6%8D%AE%E8%A1%A8"><span class="toc-number">3.1.3.</span> <span class="toc-text">生成数据表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A2%9E%E5%88%A0%E6%94%B9%E6%9F%A5"><span class="toc-number">3.1.4.</span> <span class="toc-text">增删改查</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#peewee%E6%9B%B4%E5%A4%9A%E5%8A%9F%E8%83%BD"><span class="toc-number">3.2.</span> <span class="toc-text">peewee更多功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E7%BB%A7%E6%89%BF"><span class="toc-number">3.2.1.</span> <span class="toc-text">表继承</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E9%94%AE%E5%92%8C%E7%BA%A6%E6%9D%9F"><span class="toc-number">3.2.2.</span> <span class="toc-text">主键和约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%8F%92%E5%85%A5"><span class="toc-number">3.2.3.</span> <span class="toc-text">数据插入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E7%A7%8D%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.4.</span> <span class="toc-text">各种查询</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E6%9D%A1%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.4.1.</span> <span class="toc-text">单条查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%8D%E5%90%88%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.4.2.</span> <span class="toc-text">复合条件查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A8%A1%E7%B3%8A%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.4.3.</span> <span class="toc-text">模糊查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#in%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.4.4.</span> <span class="toc-text">in查询</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E5%85%B8%E5%B1%95%E7%A4%BA"><span class="toc-number">3.2.5.</span> <span class="toc-text">字典展示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%92%E5%BA%8F%E3%80%81limit%E3%80%81%E5%8E%BB%E9%87%8D"><span class="toc-number">3.2.6.</span> <span class="toc-text">排序、limit、去重</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0"><span class="toc-number">3.2.7.</span> <span class="toc-text">聚合函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E5%92%8C%E8%AE%A1%E6%95%B0"><span class="toc-number">3.2.8.</span> <span class="toc-text">分页和计数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E5%8E%9F%E7%94%9FSQL"><span class="toc-number">3.2.9.</span> <span class="toc-text">执行原生SQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%A4%9A%E6%9D%A1"><span class="toc-number">3.2.10.</span> <span class="toc-text">查询多条</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#limit%E5%92%8Coffset"><span class="toc-number">3.2.11.</span> <span class="toc-text">limit和offset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E8%BF%9E%E6%8E%A5"><span class="toc-number">3.2.12.</span> <span class="toc-text">表连接</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%96%E9%94%AE"><span class="toc-number">3.2.13.</span> <span class="toc-text">外键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%81%BF%E5%85%8DN-1%E6%9F%A5%E8%AF%A2"><span class="toc-number">3.2.14.</span> <span class="toc-text">避免N+1查询</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#go%E7%9A%84web%E6%A1%86%E6%9E%B6"><span class="toc-number">4.</span> <span class="toc-text">go的web框架</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#gin"><span class="toc-number">4.1.</span> <span class="toc-text">gin</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#gin%E7%9A%84helloworld%E4%BD%93%E9%AA%8C"><span class="toc-number">4.1.1.</span> <span class="toc-text">gin的helloworld体验</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gin%E7%9A%84%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84%E5%92%8Curl"><span class="toc-number">4.1.2.</span> <span class="toc-text">gin的路由分组和url</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84"><span class="toc-number">4.1.2.1.</span> <span class="toc-text">路由分组</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%A6%E5%8F%82%E6%95%B0%E7%9A%84url"><span class="toc-number">4.1.2.2.</span> <span class="toc-text">带参数的url</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E8%B7%AF%E7%94%B1%E5%88%86%E7%BB%84%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">4.1.2.3.</span> <span class="toc-text">获取路由分组的参数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96get%E5%92%8Cpost%E8%A1%A8%E5%8D%95%E4%BF%A1%E6%81%AF"><span class="toc-number">4.1.3.</span> <span class="toc-text">获取get和post表单信息</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96get%E5%8F%82%E6%95%B0"><span class="toc-number">4.1.3.1.</span> <span class="toc-text">获取get参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96post%E5%8F%82%E6%95%B0"><span class="toc-number">4.1.3.2.</span> <span class="toc-text">获取post参数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#get-post%E6%B7%B7%E5%90%88"><span class="toc-number">4.1.3.3.</span> <span class="toc-text">get post混合</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#JSON%E3%80%81ProtoBuf-%E6%B8%B2%E6%9F%93"><span class="toc-number">4.1.4.</span> <span class="toc-text">JSON、ProtoBuf 渲染</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BAJSON"><span class="toc-number">4.1.4.1.</span> <span class="toc-text">输出JSON</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BE%93%E5%87%BAProtoBuf"><span class="toc-number">4.1.4.2.</span> <span class="toc-text">输出ProtoBuf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PureJSON"><span class="toc-number">4.1.4.3.</span> <span class="toc-text">PureJSON</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81"><span class="toc-number">4.1.5.</span> <span class="toc-text">表单验证</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E7%9A%84%E5%9F%BA%E6%9C%AC%E9%AA%8C%E8%AF%81"><span class="toc-number">4.1.5.1.</span> <span class="toc-text">表单的基本验证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%A1%A8%E5%8D%95%E9%AA%8C%E8%AF%81%E9%94%99%E8%AF%AF%E7%BF%BB%E8%AF%91%E6%88%90%E4%B8%AD%E6%96%87"><span class="toc-number">4.1.5.2.</span> <span class="toc-text">表单验证错误翻译成中文</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E4%B8%80%E6%AD%A5%E6%94%B9%E8%BF%9B%E6%A0%A1%E9%AA%8C"><span class="toc-number">4.1.5.3.</span> <span class="toc-text">进一步改进校验</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gin%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">4.1.6.</span> <span class="toc-text">gin中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">4.1.6.1.</span> <span class="toc-text">自定义中间件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#gin%E7%9A%84%E4%B8%AD%E9%97%B4%E4%BB%B6%E5%8E%9F%E7%90%86%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">4.1.6.2.</span> <span class="toc-text">gin的中间件原理源码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E9%9D%99%E6%80%81%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E5%92%8Chtml"><span class="toc-number">4.1.7.</span> <span class="toc-text">设置静态文件路径和html</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gin%E8%BF%94%E5%9B%9Ehtml"><span class="toc-number">4.1.7.1.</span> <span class="toc-text">gin返回html</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E8%BD%BD%E5%A4%9A%E4%B8%AAhtml"><span class="toc-number">4.1.7.2.</span> <span class="toc-text">加载多个html</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#gin%E7%9A%84%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA"><span class="toc-number">4.1.8.</span> <span class="toc-text">gin的优雅退出</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%BC%80%E5%8F%91"><span class="toc-number">5.</span> <span class="toc-text">微服务开发</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AC%AC%E4%B8%80%E4%B8%AA%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1"><span class="toc-number">5.1.</span> <span class="toc-text">第一个微服务：用户服务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E5%87%86%E5%A4%87"><span class="toc-number">5.1.1.</span> <span class="toc-text">用户服务准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MD5%E7%9B%90%E5%80%BC%E5%8A%A0%E5%AF%86%E8%A7%A3%E5%86%B3%E7%94%A8%E6%88%B7%E5%AF%86%E7%A0%81%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="toc-number">5.1.2.</span> <span class="toc-text">MD5盐值加密解决用户密码安全问题</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#MD5%E4%BF%A1%E6%81%AF%E6%91%98%E8%A6%81"><span class="toc-number">5.1.2.1.</span> <span class="toc-text">MD5信息摘要</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MD5%E7%9B%90%E5%80%BC%E5%8A%A0%E5%AF%86"><span class="toc-number">5.1.2.2.</span> <span class="toc-text">MD5盐值加密</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#proto%E6%8E%A5%E5%8F%A3%E5%AE%9A%E4%B9%89%E5%92%8C%E7%94%9F%E6%88%90"><span class="toc-number">5.1.3.</span> <span class="toc-text">proto接口定义和生成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E5%88%97%E8%A1%A8%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.1.4.</span> <span class="toc-text">用户列表接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E5%BA%93loguru"><span class="toc-number">5.1.5.</span> <span class="toc-text">日志库loguru</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA"><span class="toc-number">5.1.6.</span> <span class="toc-text">优雅退出</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87argparse%E8%A7%A3%E6%9E%90%E4%BC%A0%E9%80%92%E8%BF%9B%E5%85%A5%E7%9A%84%E5%8F%82%E6%95%B0"><span class="toc-number">5.1.7.</span> <span class="toc-text">通过argparse解析传递进入的参数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AEid%E5%92%8Cmobile%E6%9F%A5%E8%AF%A2%E7%94%A8%E6%88%B7%E6%98%AF%E5%90%A6%E5%AD%98%E5%9C%A8"><span class="toc-number">5.1.8.</span> <span class="toc-text">根据id和mobile查询用户是否存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B0%E5%BB%BA%E7%94%A8%E6%88%B7%E6%8E%A5%E5%8F%A3"><span class="toc-number">5.1.9.</span> <span class="toc-text">新建用户接口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9B%B4%E6%96%B0%E7%94%A8%E6%88%B7"><span class="toc-number">5.1.10.</span> <span class="toc-text">更新用户</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%9C%8D%E5%8A%A1%E7%9A%84web%E5%B1%82%E5%BC%80%E5%8F%91"><span class="toc-number">5.2.</span> <span class="toc-text">用户服务的web层开发</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E9%AB%98%E6%80%A7%E8%83%BD%E6%97%A5%E5%BF%97%E5%BA%93-zap"><span class="toc-number">5.2.1.</span> <span class="toc-text">go高性能日志库-zap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8-2"><span class="toc-number">5.2.1.1.</span> <span class="toc-text">简单使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#zap%E7%9A%84%E6%96%87%E4%BB%B6%E8%BE%93%E5%87%BA"><span class="toc-number">5.2.1.2.</span> <span class="toc-text">zap的文件输出</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#go%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86-viper"><span class="toc-number">5.2.2.</span> <span class="toc-text">go的配置文件管理-viper</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B0%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%98%A0%E5%B0%84%E6%88%90struct"><span class="toc-number">5.2.2.1.</span> <span class="toc-text">将配置文件映射成struct</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E4%B8%8E%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%9A%94%E7%A6%BB%EF%BC%9A"><span class="toc-number">5.2.2.2.</span> <span class="toc-text">开发环境与生产环境隔离：</span></a></li></ol></li></ol></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/4f91bd66/" title="kube-apiserver更改鉴权方式"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-13.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kube-apiserver更改鉴权方式"/></a><div class="content"><a class="title" href="/posts/4f91bd66/" title="kube-apiserver更改鉴权方式">kube-apiserver更改鉴权方式</a><time datetime="2024-02-27T14:17:38.000Z" title="发表于 2024-02-27 22:17:38">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/fec34943/" title="kube-apiserver本地启动"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-14.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kube-apiserver本地启动"/></a><div class="content"><a class="title" href="/posts/fec34943/" title="kube-apiserver本地启动">kube-apiserver本地启动</a><time datetime="2024-02-27T12:44:47.000Z" title="发表于 2024-02-27 20:44:47">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7b5f308e/" title="kubernetes组件之apiserver"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202402272048351.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kubernetes组件之apiserver"/></a><div class="content"><a class="title" href="/posts/7b5f308e/" title="kubernetes组件之apiserver">kubernetes组件之apiserver</a><time datetime="2024-02-27T12:36:09.000Z" title="发表于 2024-02-27 20:36:09">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d99f2ea2/" title="云原生软件开发模式"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-3.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="云原生软件开发模式"/></a><div class="content"><a class="title" href="/posts/d99f2ea2/" title="云原生软件开发模式">云原生软件开发模式</a><time datetime="2023-11-25T14:31:18.000Z" title="发表于 2023-11-25 22:31:18">2023-11-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b43710ac/" title="容器共享进程命名空间的应用"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-12.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="容器共享进程命名空间的应用"/></a><div class="content"><a class="title" href="/posts/b43710ac/" title="容器共享进程命名空间的应用">容器共享进程命名空间的应用</a><time datetime="2023-11-22T22:39:35.000Z" title="发表于 2023-11-23 06:39:35">2023-11-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By SetCreed</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://unpkg.com/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>