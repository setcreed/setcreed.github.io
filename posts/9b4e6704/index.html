<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>django实战 | 伊甸园</title><meta name="author" content="SetCreed"><meta name="copyright" content="SetCreed"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="职位管理系统创建一个可以管理职位的后台安装 1pip install django 创建项目 1django-admin startproject startproject  初始化： 123# 先进入项目下python manage.py makemigrationspython manage.py migrate 启动项目： 1python manage.py runserver 0.0.0.">
<meta property="og:type" content="article">
<meta property="og:title" content="django实战">
<meta property="og:url" content="https://setcreed.github.io/posts/9b4e6704/index.html">
<meta property="og:site_name" content="伊甸园">
<meta property="og:description" content="职位管理系统创建一个可以管理职位的后台安装 1pip install django 创建项目 1django-admin startproject startproject  初始化： 123# 先进入项目下python manage.py makemigrationspython manage.py migrate 启动项目： 1python manage.py runserver 0.0.0.">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-4.png">
<meta property="article:published_time" content="2022-03-03T16:07:54.000Z">
<meta property="article:modified_time" content="2023-11-04T03:15:29.881Z">
<meta property="article:author" content="SetCreed">
<meta property="article:tag" content="django">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-4.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://setcreed.github.io/posts/9b4e6704/index.html"><link rel="preconnect" href="//unpkg.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章所描述的内容可能已经发生变化，请留意。"},
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://unpkg.com/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'django实战',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2023-11-04 11:15:29'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/custom/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/custom/icon.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="伊甸园" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">80</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-4.png')"><nav id="nav"><span id="blog-info"><a href="/" title="伊甸园"><span class="site-name">伊甸园</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">django实战</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2022-03-03T16:07:54.000Z" title="发表于 2022-03-04 00:07:54">2022-03-04</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/django/">django</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">27.2k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>112分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="django实战"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="职位管理系统"><a href="#职位管理系统" class="headerlink" title="职位管理系统"></a>职位管理系统</h1><h2 id="创建一个可以管理职位的后台"><a href="#创建一个可以管理职位的后台" class="headerlink" title="创建一个可以管理职位的后台"></a>创建一个可以管理职位的后台</h2><p>安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django</span><br></pre></td></tr></table></figure>
<p>创建项目</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject startproject </span><br></pre></td></tr></table></figure>
<p>初始化：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 先进入项目下</span></span><br><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<p>启动项目：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
<p>创建管理员账号:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py createsuperuser</span><br></pre></td></tr></table></figure>
<p>打开django的管理后台：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/admin">http://127.0.0.1:8000/admin</a></p>
<p>输入用户名和密码：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210205211534.png" alt=""></p>
<p>招聘系统里面的职位管理</p>
<ul>
<li>管理员能够发布职位</li>
<li>匿名用户(候选人)能够浏览职位</li>
<li>匿名用户能够投递职位</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206165227.png" alt=""></p>
<p> 职位管理系统-建模</p>
<p>职位名称、类别、工作地点、职位职责、职位要求、发布人、发布日期、修改日期</p>
<p>创建应用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp jobs</span><br><span class="line"><span class="comment"># 在配置文件settings中 INSTALLED_APPS添加这个应用</span></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206104426.png" alt=""></p>
<p>jobs应用的model：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line">JobTypes = [</span><br><span class="line">    (<span class="number">0</span>, <span class="string">&quot;技术类&quot;</span>),</span><br><span class="line">    (<span class="number">1</span>, <span class="string">&quot;产品类&quot;</span>),</span><br><span class="line">    (<span class="number">2</span>, <span class="string">&quot;运营类&quot;</span>),</span><br><span class="line">    (<span class="number">3</span>, <span class="string">&quot;设计类&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">Cities = [</span><br><span class="line">    (<span class="number">0</span>, <span class="string">&quot;北京&quot;</span>),</span><br><span class="line">    (<span class="number">1</span>, <span class="string">&quot;上海&quot;</span>),</span><br><span class="line">    (<span class="number">2</span>, <span class="string">&quot;深圳&quot;</span>)</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Job</span>(models.Model):</span><br><span class="line">    job_type = models.SmallIntegerField(blank=<span class="literal">False</span>, choices=JobTypes, verbose_name=<span class="string">&quot;职位列表&quot;</span>)</span><br><span class="line">    job_name = models.CharField(max_length=<span class="number">250</span>, blank=<span class="literal">False</span>, verbose_name=<span class="string">&quot;职位名称&quot;</span>)</span><br><span class="line">    job_city = models.SmallIntegerField(blank=<span class="literal">False</span>, choices=Cities, verbose_name=<span class="string">&quot;工作地点&quot;</span>)</span><br><span class="line">    job_responsibility = models.TextField(max_length=<span class="number">1024</span>, verbose_name=<span class="string">&quot;职位职责&quot;</span>)</span><br><span class="line">    job_requirement = models.TextField(max_length=<span class="number">1024</span>, blank=<span class="literal">False</span>, verbose_name=<span class="string">&quot;职位要求&quot;</span>)</span><br><span class="line">    creator = models.ForeignKey(User, verbose_name=<span class="string">&quot;创建人&quot;</span>, null=<span class="literal">True</span>, on_delete=models.SET_NULL)</span><br><span class="line">    create_date = models.DateTimeField(verbose_name=<span class="string">&quot;创建时间&quot;</span>)</span><br><span class="line">    modify_date = models.DateTimeField(verbose_name=<span class="string">&quot;修改时间&quot;</span>)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206124519.png" alt=""></p>
<p>在admin中注册：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># admin.py</span></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> jobs.models <span class="keyword">import</span> Job</span><br><span class="line"></span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line">admin.site.register(Job)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>同步数据库</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206125918.png" alt=""></p>
<h2 id="快速迭代完善应用"><a href="#快速迭代完善应用" class="headerlink" title="快速迭代完善应用"></a>快速迭代完善应用</h2><p>我们希望创建时间、创建人有一个默认值</p>
<p>在job应用的Model类中添加默认值，用<code>default</code>来指代</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">create_date = models.DateTimeField(verbose_name=<span class="string">&quot;创建时间&quot;</span>, default=datetime.now)</span><br><span class="line">    modify_date = models.DateTimeField(verbose_name=<span class="string">&quot;修改时间&quot;</span>, default=datetime.now)</span><br></pre></td></tr></table></figure>
<p>在admin.py中更改</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> jobs.models <span class="keyword">import</span> Job</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># Register your models here.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JobAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    exclude = (<span class="string">&#x27;creator&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>, <span class="string">&#x27;modify_date&#x27;</span>)</span><br><span class="line">    list_display = (<span class="string">&#x27;job_name&#x27;</span>, <span class="string">&#x27;job_type&#x27;</span>, <span class="string">&#x27;job_city&#x27;</span>, <span class="string">&#x27;creator&#x27;</span>, <span class="string">&#x27;create_date&#x27;</span>, <span class="string">&#x27;modify_date&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 在保存模型之前可以做一些操作</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_model</span>(<span class="params">self, request, obj, form, change</span>):</span><br><span class="line">        <span class="comment"># 把当前登录的用户设置成这个Model的创建人</span></span><br><span class="line">        obj.creator = request.user</span><br><span class="line">        <span class="built_in">super</span>().save_model(request, obj, form, change)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">admin.site.register(Job, JobAdmin)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206133432.png" alt=""></p>
<h2 id="让匿名用户可以浏览职位列表页"><a href="#让匿名用户可以浏览职位列表页" class="headerlink" title="让匿名用户可以浏览职位列表页"></a>让匿名用户可以浏览职位列表页</h2><p>职位列表展示</p>
<ul>
<li>列表页是独立页面，使用自定义的页面</li>
<li>添加如下页面<ul>
<li>职位列表页</li>
<li>职位详情页</li>
</ul>
</li>
<li>匿名用户可以访问</li>
</ul>
<p>Django的自定义模板</p>
<ul>
<li>Django 模板包含了输出的 HTML 页面的静态部分的内容</li>
<li>模板里面的动态内容在运行时被替换</li>
<li>在 views 里面指定每个 URL 使用哪个模板来渲染页面</li>
</ul>
<p>模版继承与块（Template Inheritance &amp; Block）</p>
<ul>
<li>模板继承允许定义一个骨架模板，骨架包含站点上的公共元素（如头部导航，尾部链接）</li>
<li>骨架模板里面可以定义 Block 块，每一个 Block 块都可以在继承的页面上重新定义/覆盖</li>
<li>一个页面可以继承自另一个页面</li>
</ul>
<p>定义一个匿名访问页面的基础页面，基础页面中定义页头</p>
<p>添加页面 job/templates/base.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- base.html --&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;margin: auto;width: 50%;&quot;</span>&gt;</span>匠国科技开放职位<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>添加职位列表页模板-继承自base.html</p>
<p>joblist.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">终于等到你，期待加入我们，用技术探索一个新世界</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% if job_list %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for job in job_list %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123;job.type_name&#125;&#125;  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/job/&#123;&#123; job.id &#125;&#125;/&quot;</span> <span class="attr">style</span>=<span class="string">&quot;color:blue&quot;</span>&gt;</span>&#123;&#123; job.job_name &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span>   &#123;&#123;job.city_name&#125;&#125;  <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>No jobs are available.<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<p>使用 extends 指令来表示，这个模板继承自 base.html 模板</p>
<ul>
<li>Block content 里面重新定义了 content 这个块</li>
<li>变量：运行时会被替换， 变量用  表示，变量是 views 层取到内容后 填充到模板中的参数</li>
<li>Tag：控制模板的逻辑，包括 if, for, block 都是 tab</li>
</ul>
<p>职位列表的视图</p>
<p>jobs/views.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> loader</span><br><span class="line"><span class="keyword">from</span> jobs.models <span class="keyword">import</span> Job, Cities, JobTypes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">job_list</span>(<span class="params">request</span>):</span><br><span class="line">    job_list = Job.objects.order_by(<span class="string">&#x27;job_type&#x27;</span>)</span><br><span class="line">    template = loader.get_template(<span class="string">&#x27;joblist.html&#x27;</span>)</span><br><span class="line">    context = &#123;<span class="string">&quot;job_list&quot;</span>: job_list&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> job <span class="keyword">in</span> job_list:</span><br><span class="line">        job.city_name = Cities[job.job_city][<span class="number">1</span>]</span><br><span class="line">        job.job_type = JobTypes[job.job_type][<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.render(context))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>视图里面获取数据，把数据传入到模板中</li>
<li>使用 Django 的 model 来获取数据，数据按照职位类型排序</li>
<li>模板渲染指定了使用前面定义的 joblist.html，把 一个含有 job_list 这个 key 的 map 传入到模板</li>
</ul>
<p>添加 URL 路径映射</p>
<ul>
<li>让添加的页面，能够通过 URL 访问到</li>
<li>/joblist/ 的路径访问到 views 里面定义的 joblist 视图</li>
<li>这个视图是一个 Method View，方法表示一个视图</li>
</ul>
<p>jobs/urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> jobs <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 职位列表</span></span><br><span class="line">    url(<span class="string">r&quot;^joblist/&quot;</span>, views.job_list, name=<span class="string">&quot;joblist&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>应用（app）的所有 URL 定义加入到项目（recruitment）中</p>
<ul>
<li>收到请求时，先走 jobs 应用下面的 URL 路由找页面，然后再按照 admin/ 路径匹配请求 URL</li>
</ul>
<p>recruitment/urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url, include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&quot;^&quot;</span>, include(<span class="string">&quot;jobs.urls&quot;</span>)),</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>模板添加定义，View 页面添加完，URL 中也定义路由之后，再访问页面：<a target="_blank" rel="noopener" href="http://127.0.0.1:8000/joblist/">http://127.0.0.1:8000/joblist/</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206170150.png" alt=""></p>
<p>职位详情页面</p>
<ul>
<li>前面列表页，每个职位上有一个链接，指向职位详情页</li>
<li>同样添加如下 3 块内容：<ul>
<li>详情页模板 – 定义内容呈现（Template）</li>
<li>详情页视图 – 获取数据逻辑 （View）</li>
<li>定义 URL 路由</li>
</ul>
</li>
</ul>
<p>jobs/templates/job.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;margin:auto; width:50%;&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% if job %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;position_name&quot;</span> <span class="attr">z</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h2</span>&gt;</span>岗位名称：&#123;&#123;job.job_name&#125;&#125; <span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        城市：</span><br><span class="line">        &#123;&#123;job.city_name&#125;&#125; <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;position_responsibility&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:600px;&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>岗位职责：<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pre</span> <span class="attr">style</span>=<span class="string">&quot;font-size:16px&quot;</span>&gt;</span>&#123;&#123;job.job_responsibility&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;position_requirement&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:600px; &quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">h3</span>&gt;</span>任职要求：<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">pre</span> <span class="attr">style</span>=<span class="string">&quot;font-size:16px&quot;</span>&gt;</span>&#123;&#123;job.job_requirement&#125;&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">pre</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;apply_position&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:120px;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;申请&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;location.href=&#x27;/resume/add/?apply_position=&#123;&#123;job.job_name&#125;&#125;&amp;city=&#123;&#123;job.city_name&#125;&#125;&#x27;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>职位不存在<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在 views.py, urls.py 中分别定义了 View 视图，以及 URL 的路由规则 /job/job_id 来访问详情</p>
<p>jobs/views.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render, HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> loader</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> Http404</span><br><span class="line"><span class="keyword">from</span> jobs.models <span class="keyword">import</span> Job, Cities, JobTypes</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">job_list</span>(<span class="params">request</span>):</span><br><span class="line">    job_list = Job.objects.order_by(<span class="string">&#x27;job_type&#x27;</span>)</span><br><span class="line">    template = loader.get_template(<span class="string">&#x27;joblist.html&#x27;</span>)</span><br><span class="line">    context = &#123;<span class="string">&quot;job_list&quot;</span>: job_list&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> job <span class="keyword">in</span> job_list:</span><br><span class="line">        job.city_name = Cities[job.job_city][<span class="number">1</span>]</span><br><span class="line">        job.job_type = JobTypes[job.job_type][<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(template.render(context))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detail</span>(<span class="params">request, job_id</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        job = Job.objects.get(pk=job_id)</span><br><span class="line">        job.city_name = Cities[job.job_city][<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">except</span> Job.DoesNotExist:</span><br><span class="line">        <span class="keyword">raise</span> Http404(<span class="string">&quot;Job does not exist&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;job.html&#x27;</span>, &#123;<span class="string">&#x27;job&#x27;</span>: job&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>jobs/urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> jobs <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 职位列表</span></span><br><span class="line">    url(<span class="string">r&quot;^joblist/&quot;</span>, views.job_list, name=<span class="string">&quot;joblist&quot;</span>),</span><br><span class="line">    <span class="comment"># 职位详情</span></span><br><span class="line">    url(<span class="string">r&quot;^job/(?P&lt;job_id&gt;\d+)/$&quot;</span>, views.detail, name=<span class="string">&quot;detail&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206170542.png" alt=""></p>
<h1 id="招聘评估系统"><a href="#招聘评估系统" class="headerlink" title="招聘评估系统"></a>招聘评估系统</h1><h2 id="产品迭代思想"><a href="#产品迭代思想" class="headerlink" title="产品迭代思想"></a>产品迭代思想</h2><p>产品的需求背景：</p>
<ul>
<li>为了解决招聘面试的过程中线下面试管理效率低，面试结果不方便跟踪的痛点</li>
<li>以校园招聘的面试为例，做MVP产品迭代</li>
</ul>
<p>线下面试流程：</p>
<p>准备简历 &amp; 面试评估表 </p>
<ul>
<li>HR：发出面试评估表模板（Word）到一面面试官 （邮箱发出来）</li>
<li>一面面试官：登录邮箱下载 Word 模板，每个学生拷贝一份 </li>
<li>按学生名字命名文件， 录入学生名字，学校，电话，学历等 </li>
</ul>
<p>第一轮面试 </p>
<ul>
<li>一面官：每面完一个学生，填写 Word 格式的评估表中 </li>
<li>一面官：面完一天的学生后，批量把 Word 文档 Email 到 HR </li>
<li>HR：晚上查收下载评估表，汇总结果到 Excel，通知学生复试 </li>
<li>HR：同时把已经通知复试的学生信息，发送到技术二面复试官 </li>
</ul>
<p>第二轮面试和 HR 面试</p>
<ul>
<li>二面官：查收 Email，下载 Word 格式的一面评估记录 </li>
<li>二面官：复试后追加复试的评估到 Word 记录中，邮件到 HR</li>
<li>类似如上步骤的 HR 复试</li>
</ul>
<p>迭代思维与 MVP 产品规划方法（OOPD）</p>
<ul>
<li>MVP：minimum viable product， 最小可用产品</li>
<li>OOPD：Online &amp; Offline Product Development， 线上线下相结合的产品开发方法<ul>
<li>内裤原则：MVP 包含了产品的轮廓，核心的功能，让业务可以运转</li>
<li>优先线下：能够走线下的，优先走线下流程，让核心的功能先跑起来，快速做用户验证和方案验证</li>
<li>MVP 的核心：忽略掉一切的细枝末节，做合适的假设和简化，使用最短的时间开发出来</li>
</ul>
</li>
<li>迭代思维是最强大的产品思维逻辑，互联网上唯快不破的秘诀</li>
<li>优秀的工程师和优秀的产品经理，善于找出产品 MVP 的功能范围</li>
</ul>
<p>如何找出产品的 MVP 功能范围？</p>
<p>使用这些问题来帮助确定范围 </p>
<ul>
<li>产品的核心目标是什么? 核心用户是谁？核心的场景是什么？</li>
<li>产品目标都需要在线上完成或者呈现吗? </li>
<li>最小 MVP 产品要做哪些事情，能够达到业务目标? </li>
<li>哪些功能不是在用户流程的核心路径上的？</li>
<li>做哪些简化，和假设，能够在最短的时间交付产品，并且可以让业务流程跑起来？</li>
</ul>
<h2 id="在产品中使用产品迭代思想"><a href="#在产品中使用产品迭代思想" class="headerlink" title="在产品中使用产品迭代思想"></a>在产品中使用产品迭代思想</h2><p>招聘面试系统核心的目标：这个产品是为了提高面试过程的效率，让面试过程和结果可以跟踪。围绕着核心目标，我们只需要两个功能：</p>
<ul>
<li>能够维护候选人的信息，让候选人的信息进到系统里</li>
<li>能够填写面试反馈</li>
</ul>
<p>第一个功能维护候选人的信息有两种方式实现：</p>
<ul>
<li>HR通过已有的excel表导入信息</li>
<li>HR手工输入信息</li>
</ul>
<p>根据MVP产品迭代思想，可以快速开发核心功能。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206191514.png" alt=""></p>
<h2 id="数据建模和企业级数据库设计原则"><a href="#数据建模和企业级数据库设计原则" class="headerlink" title="数据建模和企业级数据库设计原则"></a>数据建模和企业级数据库设计原则</h2><p>在招聘面试的系统中，有两个主要的模型，一个是用户的信息，包括面试官，另一个是候选人信息和面试评估反馈。候选人信息和面试评估反馈通常会放在两张表中，对于一个MVP版本来说，为了能够快速开发，我们把候选人信息和面试评估反馈放在一张表中，等到后续产品有权限控制时，我们在分成两张表。</p>
<p>对候选人信息做一个建模：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206193031.png" alt=""></p>
<p>企业级数据库设计原则</p>
<p>包括3 个基础原则，4 个扩展性原则，3 个完备性原则</p>
<p>3个基础原则：</p>
<ul>
<li>结构清晰：表名、字段命名没有歧义，能一眼看懂</li>
<li>唯一职责：一表一用，领域定义清晰，不存储无关信息，相关数据在一张表中</li>
<li>主键原则：设计不带物理意义的主键；有唯一约束，确保幂等</li>
</ul>
<p>4 个扩展性原则（影响系统的性能和容量）：</p>
<ul>
<li>长短分离：可以扩展，长文本独立存储；有合适的容量设计</li>
<li>冷热分离：当前数据与历史数据分离</li>
<li>索引完备：有合适索引方便查询</li>
<li>不使用关联查询：不使用一切的 SQL Join 操作，不做 2 个表或者更多表的关联查询<ul>
<li>示例：查询商家每一个订单的金额</li>
<li><code>select s.shop_name, o.id as order_id, o.total_amount from shop s, order o where s.id = o.shop_id</code></li>
</ul>
</li>
</ul>
<p>3 个完备性原则：</p>
<ul>
<li>完整性：保证数据的准确性和完整性，重要的内容都有记录</li>
<li>可追溯：可追溯创建时间，修改时间，可以逻辑删除</li>
<li>一致性原则：数据之间保持一致，尽可能避免同样的数据存储在不同表中</li>
</ul>
<h2 id="创建应用和模型，分组展示页面内容"><a href="#创建应用和模型，分组展示页面内容" class="headerlink" title="创建应用和模型，分组展示页面内容"></a>创建应用和模型，分组展示页面内容</h2><p>创建应用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp interview</span><br></pre></td></tr></table></figure>
<p>注冊应用</p>
<ul>
<li>在 settings.py 中添加 interview 应用</li>
</ul>
<p>添加模型</p>
<ul>
<li>在 interview/models.py 里面定义 Candidate 类</li>
</ul>
<h2 id="从Excel文件批量导入候选人数据"><a href="#从Excel文件批量导入候选人数据" class="headerlink" title="从Excel文件批量导入候选人数据"></a>从Excel文件批量导入候选人数据</h2><p>实现候选人数据导入</p>
<ul>
<li>怎么样实现一个数据导入的功能最简洁<ul>
<li>开发一个自定义的 Web 页面，让用户能够上传 excel/csv 文件</li>
<li>开发一个命令行工具，读取 excel/csv，再访问数据库写入 DB</li>
<li>从数据库的客户端，比如 MySQL 的客户端里面导入数据</li>
</ul>
</li>
<li>Django 框架已经考虑到（需要使用到命令行的场景）<ul>
<li>使用自定义的 django management 命令来导入数据</li>
<li>应用下面创建 management/commands 目录，</li>
<li>commands 目录下添加脚本，创建类，继承自 BaseCommand，实现命令行逻辑</li>
</ul>
</li>
</ul>
<p>命令行导入：python manage.py import_candidates —path /path/to/your/file.csv</p>
<h2 id="候选人列表筛选和查询"><a href="#候选人列表筛选和查询" class="headerlink" title="候选人列表筛选和查询"></a>候选人列表筛选和查询</h2><ul>
<li>能够按照名字、手机号码、学校来查询候选人信息</li>
<li>能够按照初试结果，复试结果，HR复试结果，面试官来筛选；能按照复试结果来排序</li>
</ul>
<p>使用内置的<code>search_field</code>属性来设置哪些可以搜索的字段，用<code>list_filter</code>属性来设置做筛选、过滤的字段，用<code>ordering</code>字段来设置字段的排序。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210206211523.png" alt=""></p>
<h2 id="企业域账号集成"><a href="#企业域账号集成" class="headerlink" title="企业域账号集成"></a>企业域账号集成</h2><ul>
<li>什么是目录服务，英文名是Directory Service，目录服务是一个提供资源服务的定位查找功能的存储系统。在软件工程里面一个目录是指一组名字和值的映射，它允许根据一个给定的名字来查找对应的值，以词典类似。目录可以有树状结构，典型的目录有域名、企业的组织架构，这些都可以使用目录服务来存储其中的信息。</li>
<li>OpenLDAP是开发的LDAP服务，Lightweight Directory Access Protocol，轻量级的目录访问协议</li>
<li>可以直接使用域账号登陆</li>
<li>不用手工添加账号、维护独立密码</li>
<li>可以集成 OpenLDAP/ActiveDirecotry</li>
<li>DN: 目录服务中的一个唯一的对象<ul>
<li>CN=David,OU=Shanghai,DC=ihopeit,DC=com</li>
</ul>
</li>
</ul>
<p>Open LDAP服务搭建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker启动OpenLDAP</span></span><br><span class="line">docker run -d -p 389:389 -p 636:636 --name my_openldap --<span class="built_in">env</span> LDAP_ORGANISATION=<span class="string">&quot;myhome&quot;</span> --<span class="built_in">env</span> LDAP_DOMAIN=<span class="string">&quot;myhome.com&quot;</span> --<span class="built_in">env</span> LDAP_ADMIN_PASSWORD=<span class="string">&quot;cwz123456&quot;</span> --detach osixia/openldap</span><br></pre></td></tr></table></figure>
<p>参数解释：</p>
<ul>
<li>配置LDAP组织者：–-env LDAP_ORGANISATION=”myhome”</li>
<li>配置LDAP域：–-env LDAP_DOMAIN=”myhome.com”</li>
<li>配置LDAP密码：–-env LDAP_ADMIN_PASSWORD=”cwz123456”</li>
<li>默认登录用户名：admin</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># docker启动phpLDAPadmin</span></span><br><span class="line">docker run -d -p 81:80 -p 443:443 --name phpldapadmin_service --<span class="built_in">env</span> PHPLDAPADMIN_LDAP_HOSTS=49.235.76.103 --<span class="built_in">link</span> my_openldap:ldap-host --<span class="built_in">env</span> PHPLDAPADMIN_LDAP_HOSTS=ldap-host --detach osixia/phpldapadmin</span><br></pre></td></tr></table></figure>
<p>参数解释：</p>
<ul>
<li>配置的Ldap地址：–-env PHPLDAPADMIN_LDAP_HOSTS=49.235.76.103</li>
</ul>
<p>访问：<a target="_blank" rel="noopener" href="https://49.235.76.103，">https://49.235.76.103，</a></p>
<ul>
<li>Login DN：cn=admin,dc=myhome,dc=com</li>
<li>password：cwz123456</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210207130628.png" alt=""></p>
<p>django配置ldap</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装</span></span><br><span class="line">pip install django-python3-ldap</span><br></pre></td></tr></table></figure>
<p>在settings文件中配置</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210207085608.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># LDAP</span></span><br><span class="line"><span class="comment"># The URL of the LDAP server.</span></span><br><span class="line">LDAP_AUTH_URL = <span class="string">&quot;ldap://49.235.76.103:389&quot;</span></span><br><span class="line"><span class="comment"># Initiate TLS on connection.</span></span><br><span class="line">LDAP_AUTH_USE_TLS = <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The LDAP search base for looking up users.</span></span><br><span class="line">LDAP_AUTH_SEARCH_BASE = <span class="string">&quot;dc=myhome,dc=com&quot;</span></span><br><span class="line"><span class="comment"># The LDAP class that represents a user.</span></span><br><span class="line">LDAP_AUTH_OBJECT_CLASS = <span class="string">&quot;inetOrgPerson&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># User model fields mapped to the LDAP</span></span><br><span class="line"><span class="comment"># attributes that represent them.</span></span><br><span class="line">LDAP_AUTH_USER_FIELDS = &#123;</span><br><span class="line">    <span class="string">&quot;username&quot;</span>: <span class="string">&quot;cn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;first_name&quot;</span>: <span class="string">&quot;givenName&quot;</span>,</span><br><span class="line">    <span class="string">&quot;last_name&quot;</span>: <span class="string">&quot;sn&quot;</span>,</span><br><span class="line">    <span class="string">&quot;email&quot;</span>: <span class="string">&quot;mail&quot;</span>,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># A tuple of django model fields used to uniquely identify a user.</span></span><br><span class="line">LDAP_AUTH_USER_LOOKUP_FIELDS = (<span class="string">&quot;username&quot;</span>,)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Path to a callable that takes a dict of &#123;model_field_name: value&#125;,</span></span><br><span class="line"><span class="comment"># returning a dict of clean model data.</span></span><br><span class="line"><span class="comment"># Use this to customize how data loaded from LDAP is saved to the User model.</span></span><br><span class="line">LDAP_AUTH_CLEAN_USER_DATA = <span class="string">&quot;django_python3_ldap.utils.clean_user_data&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The LDAP username and password of a user for querying the LDAP database for user</span></span><br><span class="line"><span class="comment"># details. If None, then the authenticated user will be used for querying, and</span></span><br><span class="line"><span class="comment"># the `ldap_sync_users` command will perform an anonymous query.</span></span><br><span class="line">LDAP_AUTH_CONNECTION_USERNAME = <span class="string">&quot;admin&quot;</span></span><br><span class="line">LDAP_AUTH_CONNECTION_PASSWORD = <span class="string">&quot;cwz123456&quot;</span></span><br><span class="line"></span><br><span class="line">AUTHENTICATION_BACKENDS = &#123;<span class="string">&quot;django_python3_ldap.auth.LDAPBackend&quot;</span>, <span class="string">&#x27;django.contrib.auth.backends.ModelBackend&#x27;</span>, &#125;</span><br></pre></td></tr></table></figure>
<p>在django后台用ldap账号登录，会自动同步到django</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210207130722.png" alt=""></p>
<h2 id="批量导入面试官信息、权限"><a href="#批量导入面试官信息、权限" class="headerlink" title="批量导入面试官信息、权限"></a>批量导入面试官信息、权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将ldap中的信息导入</span></span><br><span class="line">python manage.py ldap_sync_users</span><br></pre></td></tr></table></figure>
<p>这时查看django 后台管理就会有用户加进来</p>
<p>增加组  interviewer组，赋予查看和修改应聘者的权限。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210207155658.png" alt=""></p>
<p>增加组 hr组，赋予对应聘者操作和对工作操作的权限。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210207155838.png" alt=""></p>
<h2 id="到处候选人的数据到CSV"><a href="#到处候选人的数据到CSV" class="headerlink" title="到处候选人的数据到CSV"></a>到处候选人的数据到CSV</h2><p>增加自定义的数据操作菜单 （数据导出为 CSV）</p>
<ul>
<li>需要对数据进行操作，比如导出，状态变更</li>
<li>定义按钮的实现逻辑（处理函数）， 在 ModelAdmin 中注册函数到 actions</li>
</ul>
<p>interview/admin.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将候选人信息到处为csv</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">export_model_as_csv</span>(<span class="params">model_admin, request, queryset</span>):</span><br><span class="line">    response = HttpResponse(content_type=<span class="string">&#x27;text/csv&#x27;</span>)</span><br><span class="line">    field_list = exportable_fields</span><br><span class="line">    response[<span class="string">&#x27;Content-Disposition&#x27;</span>] = <span class="string">&#x27;attachment; filename=%s-list-%s.csv&#x27;</span> % (</span><br><span class="line">        <span class="string">&#x27;recruitment-candidates&#x27;</span>,</span><br><span class="line">        datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d-%H-%M-%S&#x27;</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 写入表头</span></span><br><span class="line">    writer = csv.writer(response)</span><br><span class="line">    writer.writerow(</span><br><span class="line">        [queryset.model._meta.get_field(f).verbose_name.title() <span class="keyword">for</span> f <span class="keyword">in</span> field_list],</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> queryset:</span><br><span class="line">        <span class="comment"># 单行 的记录（各个字段的值）， 根据字段对象，从当前实例 (obj) 中获取字段值</span></span><br><span class="line">        csv_line_values = []</span><br><span class="line">        <span class="keyword">for</span> field <span class="keyword">in</span> field_list:</span><br><span class="line">            field_obj = queryset.model._meta.get_field(field)</span><br><span class="line">            field_value = field_obj.value_from_object(obj)</span><br><span class="line">            csv_line_values.append(field_value)</span><br><span class="line">        writer.writerow(csv_line_values)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="comment"># 给export_model_as_csv方法做一个定制，修改它的名字</span></span><br><span class="line">export_model_as_csv.short_description = <span class="string">&#x27;导出为CSV文件&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 候选人管理类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CandidateAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    exclude = (<span class="string">&#x27;creator&#x27;</span>, <span class="string">&#x27;created_date&#x27;</span>, <span class="string">&#x27;modified_date&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    actions = [export_model_as_csv]</span><br><span class="line">    …………</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210207184839.png" alt=""></p>
<h2 id="增加日志记录"><a href="#增加日志记录" class="headerlink" title="增加日志记录"></a>增加日志记录</h2><p>日志级别：</p>
<ul>
<li>DEBUG: 调试</li>
<li>INFO: 常用的系统信息</li>
<li>WARNING: 小的告警，不影响主要功能</li>
<li>ERROR: 系统出现不可忽视的错误</li>
<li>CRITICAL: 非常严重的错误</li>
</ul>
<p>在settings.py配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;disable_existing_logger&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&quot;handlers&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;console&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;class&quot;</span>: <span class="string">&quot;logging.StreamHandler&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;loggers&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;django_python3_ldap&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;handlers&quot;</span>: [<span class="string">&quot;console&quot;</span>],</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: <span class="string">&quot;DEBUG&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>dictconfig是用一个字典形式的格式来定义日志记录的内容。</p>
<ul>
<li>version 定义了日志记录的版本号，到目前为止，日志记录只有一个版本1</li>
<li>disable_existing_loggers  是否要禁用现在已有的其他logger，一般为False</li>
<li>有四个组件：Handlers、Loggers、Filters、Formmaters<ul>
<li>Filters 是过滤器，可以定义一些列的处理链，可以把handlers/loggers放到Filters里</li>
<li>Handlers是日志处理器 对于每一条日志消息如何处理，记录到 文件，控制台，还是网络</li>
<li>Loggers 定义了日志的记录器，它里面定义了一个个的键值对。比如 上面定义了一个<code>django_python3_ldap</code>的日志记录器，使用了这个名称作为记录的类，会往控制台输出。</li>
<li>Formmaters 定义日志文本记录的格式</li>
</ul>
</li>
</ul>
<p>完善后的日志配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">&quot;disable_existing_logger&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">    <span class="string">&quot;formatters&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;simple&quot;</span>: &#123;   <span class="comment"># 定义打印格式</span></span><br><span class="line">          <span class="string">&#x27;format&#x27;</span>: <span class="string">&#x27;%(asctime)s %(name)-12s %(lineno)d %(levelname)-8s %(message)s&#x27;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;handlers&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;console&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;class&quot;</span>: <span class="string">&quot;logging.StreamHandler&quot;</span>,</span><br><span class="line">            <span class="string">&quot;formatter&quot;</span>: <span class="string">&quot;simple&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 定义错误级别的日志发送到邮件处理器</span></span><br><span class="line">        <span class="string">&quot;mail_admins&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: <span class="string">&quot;ERROR&quot;</span>,</span><br><span class="line">            <span class="string">&quot;class&quot;</span>: <span class="string">&quot;django.utils.log.AdminEmailHandler&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment"># 记录到文件</span></span><br><span class="line">        <span class="string">&quot;file&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;class&quot;</span>: <span class="string">&quot;logging.FileHandler&quot;</span>,</span><br><span class="line">            <span class="string">&quot;formatter&quot;</span>: <span class="string">&quot;simple&quot;</span>,</span><br><span class="line">            <span class="string">&quot;filename&quot;</span>: os.path.join(os.path.dirname(BASE_DIR), <span class="string">&#x27;recruitment.admin.log&#x27;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="comment"># root是一个系统全局级别默认的日志记录器，是loggers里特殊的记录器</span></span><br><span class="line">    <span class="string">&quot;root&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;handles&quot;</span>: [<span class="string">&quot;console&quot;</span>, <span class="string">&quot;file&quot;</span>],</span><br><span class="line">      <span class="string">&quot;level&quot;</span>: <span class="string">&quot;INFO&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;loggers&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;django_python3_ldap&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;handlers&quot;</span>: [<span class="string">&quot;console&quot;</span>],</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: <span class="string">&quot;DEBUG&quot;</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>给导出csv文件增加日志:</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210207193125.png" alt=""></p>
<h2 id="生产环境与开发环境配置分离"><a href="#生产环境与开发环境配置分离" class="headerlink" title="生产环境与开发环境配置分离"></a>生产环境与开发环境配置分离</h2><p>配置文件的问题：</p>
<ul>
<li>生产环境的配置与开发环境配置隔离开， 开发环境允许 Debugging</li>
<li>敏感信息不提交到代码库中，比如数据库连接，secret key, LDAP连接信息等</li>
<li>生产、开发环境使用的配置可能不一样，比如 分别使用 MySQL/Sqlite 数据库</li>
</ul>
<p>把 settings.py 抽出来，创建3个配置文件：</p>
<ul>
<li>base.py 基础配置</li>
<li>local.py 本地开发环境配置，允许 Debug</li>
<li>production.py 生产环境配置， 不进到 代码库版本控制</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210207214718.png" alt=""></p>
<p>命令行启动时指定环境配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>:<span class="number">8000</span> --settings=settings.local</span><br></pre></td></tr></table></figure>
<h2 id="产品细节完善"><a href="#产品细节完善" class="headerlink" title="产品细节完善"></a>产品细节完善</h2><ul>
<li>修改站点标题</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在url.py</span></span><br><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> gettext <span class="keyword">as</span> _</span><br><span class="line"></span><br><span class="line">admin.site.site_header = _(<span class="string">&quot;招聘管理系统&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>设置只读字段，面试官不能修改，但是hr可以修改</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># interview/admin.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_group_names</span>(<span class="params">self, user</span>):</span><br><span class="line">    group_names = []</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> user.groups.<span class="built_in">all</span>():</span><br><span class="line">        group_names.append(i.name)</span><br><span class="line">    <span class="keyword">return</span> group_names</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_readonly_fields</span>(<span class="params">self, request, obj=<span class="literal">None</span></span>):</span><br><span class="line">    group_names = self.get_group_names(request.user)</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;interviewer&quot;</span> <span class="keyword">in</span> group_names:</span><br><span class="line">        logger.info(<span class="string">&quot;interviewer is in user&#x27;s group for %s&quot;</span> % request.user.username)</span><br><span class="line">        <span class="keyword">return</span> (<span class="string">&#x27;first_interviewer&#x27;</span>, <span class="string">&#x27;second_interviewer&#x27;</span>,)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ()</span><br></pre></td></tr></table></figure>
<ul>
<li>让hr直接在列表修改候选人的面试官，而面试官自己不能修改</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># interviewer/admin.py</span></span><br><span class="line"></span><br><span class="line">default_list_editable = (<span class="string">&#x27;first_interviewer&#x27;</span>, <span class="string">&#x27;second_interviewer&#x27;</span>,)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_list_editable</span>(<span class="params">self, request</span>):</span><br><span class="line">    group_names = self.get_group_names(request.user)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.user.is_superuser <span class="keyword">or</span> <span class="string">&#x27;hr&#x27;</span> <span class="keyword">in</span> group_names:</span><br><span class="line">        <span class="keyword">return</span> self.default_list_editable</span><br><span class="line">    <span class="keyword">return</span> ()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_changelist_instance</span>(<span class="params">self, request</span>):</span><br><span class="line">    self.list_editable = self.get_list_editable(request)</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">super</span>().get_changelist_instance(request)</span><br></pre></td></tr></table></figure>
<h1 id="简历投递和面试流程闭环"><a href="#简历投递和面试流程闭环" class="headerlink" title="简历投递和面试流程闭环"></a>简历投递和面试流程闭环</h1><h2 id="定制更美观的主题"><a href="#定制更美观的主题" class="headerlink" title="定制更美观的主题"></a>定制更美观的主题</h2><ul>
<li>安装django-grappelli 主题</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-grappelli</span><br></pre></td></tr></table></figure>
<ul>
<li>settings.py 中配置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注册到app</span></span><br><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;grappelli&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django_python3_ldap&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jobs&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;interview&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>在urls.py注册</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&quot;^&quot;</span>, include(<span class="string">&quot;jobs.urls&quot;</span>)),</span><br><span class="line">    url(<span class="string">&#x27;grappelli&#x27;</span>, include(<span class="string">&#x27;grappelli.urls&#x27;</span>)),</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210208092415.png" alt=""></p>
<h2 id="定制面试官权限"><a href="#定制面试官权限" class="headerlink" title="定制面试官权限"></a>定制面试官权限</h2><ul>
<li>数据权限，专业面试官仅能评估自己负责的环节</li>
</ul>
<p>一面面试官仅填写一面反馈， 二面面试官可以填写二面反馈 def get_fieldsets(self, request, obj=None):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 一面面试官仅填写一面反馈， 二面面试官可以填写二面反馈</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_fieldsets</span>(<span class="params">self, request, obj=<span class="literal">None</span></span>):</span><br><span class="line">    group_names = self.get_group_names(request.user)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;interviewer&#x27;</span> <span class="keyword">in</span> group_names <span class="keyword">and</span> obj.first_interviewer == request.user:</span><br><span class="line">        <span class="keyword">return</span> self.default_fieldsets_first</span><br><span class="line">    <span class="keyword">if</span> <span class="string">&#x27;interviewer&#x27;</span> <span class="keyword">in</span> group_names <span class="keyword">and</span> obj.second_interviewer == request.user:</span><br><span class="line">        <span class="keyword">return</span> self.default_fieldsets_second</span><br><span class="line">    <span class="keyword">return</span> self.default_fieldsets</span><br></pre></td></tr></table></figure>
<ul>
<li>数据集权限(querySet)，专业面试官只能看到分到自己的候选人</li>
</ul>
<p>对于面试官，获取自己是一面面试官或者二面面试官的候选人集合 def get_queryset(self, request):</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 对于非管理员，非HR，获取自己是一面面试官或者二面面试官的候选人集合:</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_queryset</span>(<span class="params">self, request</span>):  <span class="comment"># show data only owned by the user</span></span><br><span class="line">    qs = <span class="built_in">super</span>().get_queryset(request)</span><br><span class="line"></span><br><span class="line">    group_names = self.get_group_names(request.user)</span><br><span class="line">    <span class="keyword">if</span> request.user.is_superuser <span class="keyword">or</span> <span class="string">&#x27;hr&#x27;</span> <span class="keyword">in</span> group_names:</span><br><span class="line">        <span class="keyword">return</span> qs</span><br><span class="line">    <span class="keyword">return</span> Candidate.objects.<span class="built_in">filter</span>(</span><br><span class="line">        Q(first_interviewer=request.user) | Q(second_interviewer=request.user)</span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<ul>
<li>功能权限（菜单/按钮），数据导出权限仅 HR 和超级管理员可用<ul>
<li>自定义权限： 在 Model 类的 Meta 中定义自定义的 permissions </li>
<li>在 action 上限制权限： export_model_as_csv.allowed_permissions = (‘export’,) </li>
<li>在 Admin 上检查权限： def has_export_permission(self, request)</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在models.py中的Meta中定义权限</span></span><br><span class="line">permissions = [</span><br><span class="line">            (<span class="string">&quot;export&quot;</span>, <span class="string">&quot;Can export candidate list&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;notify&quot;</span>, <span class="string">&quot;notify interviewer for candidate review&quot;</span>),</span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在admin.py中队导出csv文件做权限限制</span></span><br><span class="line"><span class="comment"># 给导出csv文件的功能做权限控制</span></span><br><span class="line">export_model_as_csv.allowed_permissions = (<span class="string">&#x27;export&#x27;</span>,)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在管理类下</span></span><br><span class="line"><span class="comment"># 当前用户是否有导出权限：</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">has_export_permission</span>(<span class="params">self, request</span>):</span><br><span class="line">    opts = self.opts</span><br><span class="line">    <span class="keyword">return</span> request.user.has_perm(<span class="string">&#x27;%s.%s&#x27;</span> % (opts.app_label, <span class="string">&quot;export&quot;</span>))</span><br></pre></td></tr></table></figure>
<h2 id="系统报错功能：钉钉群集成"><a href="#系统报错功能：钉钉群集成" class="headerlink" title="系统报错功能：钉钉群集成"></a>系统报错功能：钉钉群集成</h2><p>发送通知：钉钉群消息集成</p>
<ul>
<li>为什么不使用 Email/SMS 通知：<ul>
<li>由于邮件、短信没有限制，可以给任何人发；网络上对于 API 调用有了各种限制</li>
<li>阿里云封禁 25 端口</li>
</ul>
</li>
<li>为什么使用钉钉群消息<ul>
<li>可以使用 Web Hook 直接发送，简单易用</li>
</ul>
</li>
<li>其他推荐消息方式<ul>
<li>Slack 消息</li>
<li>企业微信消息</li>
</ul>
</li>
</ul>
<p>测试钉钉群消息</p>
<ul>
<li>安装钉钉聊天机器人：pip install DingtalkChatbot</li>
<li>测试群消息</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python manage.py shell --settings=settings.local</span><br><span class="line"><span class="comment"># 进入交互式</span></span><br><span class="line"><span class="keyword">from</span> interview <span class="keyword">import</span> dingtalk</span><br><span class="line">dingtalk.send(<span class="string">&quot;天维招聘面试启动通知, 开始招聘。。。&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>定制管理后台的操作按钮：通知面试官准备面试</p>
<ul>
<li>定义通知面试官的方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">notify_interviewer</span>(<span class="params">model_admin, request, queryset</span>):</span><br><span class="line">    candidates = <span class="string">&quot;&quot;</span></span><br><span class="line">    interviewers = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> obj <span class="keyword">in</span> queryset:</span><br><span class="line">        candidates = obj.username + <span class="string">&quot;;&quot;</span> + candidates</span><br><span class="line">        interviewers = obj.first_interviewer.username + <span class="string">&quot;;&quot;</span> + interviewers</span><br><span class="line">    dingtalk.send(<span class="string">&quot;候选人 %s 进入面试环节，亲爱的面试官，请准备好面试： %s&quot;</span> % (candidates, interviewers))</span><br></pre></td></tr></table></figure>
<ul>
<li>注册到modeladmin中</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">actions = (export_model_as_csv, notify_interviewer, )</span><br></pre></td></tr></table></figure>
<h2 id="允许候选人注册登录：集成Registration"><a href="#允许候选人注册登录：集成Registration" class="headerlink" title="允许候选人注册登录：集成Registration"></a>允许候选人注册登录：集成Registration</h2><ul>
<li>允许注册：安装 registration      pip install django-registration-redux</li>
<li>添加到 apps 中</li>
<li>注册到urls中</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&quot;^&quot;</span>, include(<span class="string">&quot;jobs.urls&quot;</span>)),</span><br><span class="line">    url(<span class="string">&#x27;grappelli&#x27;</span>, include(<span class="string">&#x27;grappelli.urls&#x27;</span>)),</span><br><span class="line">    url(<span class="string">r&#x27;^accounts/&#x27;</span>, include(<span class="string">&#x27;registration.backends.simple.urls&#x27;</span>)),</span><br><span class="line">    path(<span class="string">&#x27;admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>同步数据库</li>
<li>注册成功后跳转到登录页面</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># setings.py配置文件配置</span></span><br><span class="line">LOGIN_REDIRECT_URL = <span class="string">&#x27;/&#x27;</span></span><br><span class="line">SIMPLE_BACKEND_REDIRECT_URL = <span class="string">&#x27;/accounts/login/&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="候选人简历存储"><a href="#候选人简历存储" class="headerlink" title="候选人简历存储"></a>候选人简历存储</h2><p>创建简历Model</p>
<ul>
<li>创建 Model</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Resume</span>(models.Model):</span><br><span class="line">    <span class="comment"># Translators: 简历实体的翻译</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">135</span>, verbose_name=<span class="string">&#x27;姓名&#x27;</span>)</span><br><span class="line">    applicant = models.ForeignKey(User, verbose_name=<span class="string">&quot;申请人&quot;</span>, null=<span class="literal">True</span>, on_delete=models.SET_NULL)</span><br><span class="line">    city = models.CharField(max_length=<span class="number">135</span>, verbose_name=<span class="string">&#x27;城市&#x27;</span>)</span><br><span class="line">    phone = models.CharField(max_length=<span class="number">135</span>, verbose_name=<span class="string">&#x27;手机号码&#x27;</span>)</span><br><span class="line">    email = models.EmailField(max_length=<span class="number">135</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;邮箱&#x27;</span>)</span><br><span class="line">    apply_position = models.CharField(max_length=<span class="number">135</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;应聘职位&#x27;</span>)</span><br><span class="line">    born_address = models.CharField(max_length=<span class="number">135</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;生源地&#x27;</span>)</span><br><span class="line">    gender = models.CharField(max_length=<span class="number">135</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;性别&#x27;</span>)</span><br><span class="line">    picture = models.ImageField(upload_to=<span class="string">&#x27;images/&#x27;</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;个人照片&#x27;</span>)</span><br><span class="line">    attachment = models.FileField(upload_to=<span class="string">&#x27;file/&#x27;</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;简历附件&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 学校与学历信息</span></span><br><span class="line">    bachelor_school = models.CharField(max_length=<span class="number">135</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;本科学校&#x27;</span>)</span><br><span class="line">    master_school = models.CharField(max_length=<span class="number">135</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;研究生学校&#x27;</span>)</span><br><span class="line">    doctor_school = models.CharField(max_length=<span class="number">135</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;博士生学校&#x27;</span>)</span><br><span class="line">    major = models.CharField(max_length=<span class="number">135</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;专业&#x27;</span>)</span><br><span class="line">    degree = models.CharField(max_length=<span class="number">135</span>, choices=DEGREE_TYPE, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;学历&#x27;</span>)</span><br><span class="line">    created_date = models.DateTimeField(verbose_name=<span class="string">&quot;创建日期&quot;</span>, default=datetime.now)</span><br><span class="line">    modified_date = models.DateTimeField(verbose_name=<span class="string">&quot;修改日期&quot;</span>, auto_now=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 候选人自我介绍，工作经历，项目经历</span></span><br><span class="line">    candidate_introduction = models.TextField(max_length=<span class="number">1024</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;自我介绍&#x27;</span>)</span><br><span class="line">    work_experience = models.TextField(max_length=<span class="number">1024</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;工作经历&#x27;</span>)</span><br><span class="line">    project_experience = models.TextField(max_length=<span class="number">1024</span>, blank=<span class="literal">True</span>, verbose_name=<span class="string">&#x27;项目经历&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        verbose_name = <span class="string">&#x27;简历&#x27;</span></span><br><span class="line">        verbose_name_plural = <span class="string">&#x27;简历列表&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.username</span><br></pre></td></tr></table></figure>
<ul>
<li>注册 Model 到 Admin 中，设置展示字段</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简历管理类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResumeAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    list_display = (</span><br><span class="line">        <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;applicant&#x27;</span>, <span class="string">&#x27;city&#x27;</span>, <span class="string">&#x27;apply_position&#x27;</span>, <span class="string">&#x27;bachelor_school&#x27;</span>, <span class="string">&#x27;master_school&#x27;</span>, <span class="string">&#x27;major&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;created_date&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    readonly_fields = (<span class="string">&#x27;applicant&#x27;</span>, <span class="string">&#x27;created_date&#x27;</span>, <span class="string">&#x27;modified_date&#x27;</span>,)</span><br><span class="line">    fieldsets = (</span><br><span class="line">        (<span class="literal">None</span>, &#123;<span class="string">&#x27;fields&#x27;</span>: (</span><br><span class="line">            <span class="string">&quot;applicant&quot;</span>, (<span class="string">&quot;username&quot;</span>, <span class="string">&quot;city&quot;</span>, <span class="string">&quot;phone&quot;</span>),</span><br><span class="line">            (<span class="string">&quot;email&quot;</span>, <span class="string">&quot;apply_position&quot;</span>, <span class="string">&quot;born_address&quot;</span>, <span class="string">&quot;gender&quot;</span>,), (<span class="string">&quot;picture&quot;</span>, <span class="string">&quot;attachment&quot;</span>,),</span><br><span class="line">            (<span class="string">&quot;bachelor_school&quot;</span>, <span class="string">&quot;master_school&quot;</span>), (<span class="string">&quot;major&quot;</span>, <span class="string">&quot;degree&quot;</span>), (<span class="string">&#x27;created_date&#x27;</span>, <span class="string">&#x27;modified_date&#x27;</span>),</span><br><span class="line">            <span class="string">&quot;candidate_introduction&quot;</span>, <span class="string">&quot;work_experience&quot;</span>, <span class="string">&quot;project_experience&quot;</span>,)&#125;),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">save_model</span>(<span class="params">self, request, obj, form, change</span>):</span><br><span class="line">        obj.applicant = request.user</span><br><span class="line">        <span class="built_in">super</span>().save_model(request, obj, form, change)</span><br><span class="line"></span><br><span class="line">admin.site.register(Job, JobAdmin)</span><br><span class="line">admin.site.register(Resume, ResumeAdmin)</span><br></pre></td></tr></table></figure>
<ul>
<li>同步数据库</li>
<li>授予管理权限到 HR</li>
</ul>
<h2 id="候选人在线投递简历"><a href="#候选人在线投递简历" class="headerlink" title="候选人在线投递简历"></a>候选人在线投递简历</h2><p>职位详情页：候选人简历投递</p>
<p>目标：</p>
<ul>
<li>注册的用户可以提交简历</li>
<li>简历跟当前用户关联</li>
<li>能够追溯到谁投递的简历</li>
</ul>
<p>步骤：</p>
<ul>
<li>定义简历创建 View (继承自通用的CreateView)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jobs/view.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.mixins <span class="keyword">import</span> LoginRequiredMixin</span><br><span class="line"><span class="keyword">from</span> django.views.generic.edit <span class="keyword">import</span> CreateView</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResumeCreateView</span>(LoginRequfrom django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> jobs <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 职位列表</span></span><br><span class="line">    url(<span class="string">r&quot;^joblist/&quot;</span>, views.job_list, name=<span class="string">&quot;joblist&quot;</span>),</span><br><span class="line">    <span class="comment"># 职位详情</span></span><br><span class="line">    url(<span class="string">r&quot;^job/(?P&lt;job_id&gt;\d+)/$&quot;</span>, views.detail, name=<span class="string">&quot;detail&quot;</span>),</span><br><span class="line">    <span class="comment"># 提交简历</span></span><br><span class="line">    path(<span class="string">&#x27;resume/add/&#x27;</span>, views.ResumeCreateView.as_view(), name=<span class="string">&#x27;resume-add&#x27;</span>),</span><br><span class="line">    <span class="comment"># 首页自动跳转 职位列表</span></span><br><span class="line">    url(<span class="string">r&quot;^$&quot;</span>, views.job_list, name=<span class="string">&quot;name&quot;</span>),</span><br><span class="line">]iredMixin, CreateView):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;    简历职位页面  &quot;&quot;&quot;</span></span><br><span class="line">    template_name = <span class="string">&#x27;resume_form.html&#x27;</span></span><br><span class="line">    success_url = <span class="string">&#x27;/joblist/&#x27;</span></span><br><span class="line">    model = Resume</span><br><span class="line">    fields = [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;city&quot;</span>, <span class="string">&quot;phone&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>, <span class="string">&quot;apply_position&quot;</span>, <span class="string">&quot;gender&quot;</span>,</span><br><span class="line">        <span class="string">&quot;bachelor_school&quot;</span>, <span class="string">&quot;master_school&quot;</span>, <span class="string">&quot;major&quot;</span>, <span class="string">&quot;degree&quot;</span>,</span><br><span class="line">        <span class="string">&quot;candidate_introduction&quot;</span>, <span class="string">&quot;work_experience&quot;</span>, <span class="string">&quot;project_experience&quot;</span>]</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line"><span class="comment"># jobs/urls.py</span></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> jobs <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 职位列表</span></span><br><span class="line">    url(<span class="string">r&quot;^joblist/&quot;</span>, views.job_list, name=<span class="string">&quot;joblist&quot;</span>),</span><br><span class="line">    <span class="comment"># 职位详情</span></span><br><span class="line">    url(<span class="string">r&quot;^job/(?P&lt;job_id&gt;\d+)/$&quot;</span>, views.detail, name=<span class="string">&quot;detail&quot;</span>),</span><br><span class="line">    <span class="comment"># 提交简历</span></span><br><span class="line">    path(<span class="string">&#x27;resume/add/&#x27;</span>, views.ResumeCreateView.as_view(), name=<span class="string">&#x27;resume-add&#x27;</span>),</span><br><span class="line">    <span class="comment"># 首页自动跳转 职位列表</span></span><br><span class="line">    url(<span class="string">r&quot;^$&quot;</span>, views.job_list, name=<span class="string">&quot;name&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>定义简历创建页面的表单模板</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>提交简历<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &#123;&#123; form.as_p &#125;&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&quot;提交&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>关联“申请职位”按钮的点击事件到简历提交页</li>
</ul>
<p>jobs/templates/job.html，申请按钮绑定事件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:120px;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;申请&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;location.href=&#x27;/resume/add/?apply_position=&#123;&#123;job.job_name&#125;&#125;&amp;city=&#123;&#123;job.city_name&#125;&#125;&#x27;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>进一步完善， 可以带参数跳转 &amp;&amp; 关联登陆用户到简历</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jobs/view.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> Http404, HttpResponseRedirect</span><br><span class="line"><span class="comment"># 从 URL 请求参数带入默认值</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_initial</span>(<span class="params">self</span>):</span><br><span class="line">    initial = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> x <span class="keyword">in</span> self.request.GET:</span><br><span class="line">        initial[x] = self.request.GET[x]</span><br><span class="line">    <span class="keyword">return</span> initial</span><br><span class="line"></span><br><span class="line"><span class="comment"># 简历与当前用户关联</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">form_valid</span>(<span class="params">self, form</span>):</span><br><span class="line">    self.<span class="built_in">object</span> = form.save(commit=<span class="literal">False</span>)</span><br><span class="line">    self.<span class="built_in">object</span>.applicant = self.request.user</span><br><span class="line">    self.<span class="built_in">object</span>.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponseRedirect(self.get_success_url())</span><br></pre></td></tr></table></figure>
<h2 id="使用-Bootstrap-来定制页面样式"><a href="#使用-Bootstrap-来定制页面样式" class="headerlink" title="使用 Bootstrap 来定制页面样式"></a>使用 Bootstrap 来定制页面样式</h2><ul>
<li>安装依赖包： pip install django-bootstrap4</li>
<li>添加到 apps 中: bootstrap4</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;grappelli&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;registration&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;bootstrap4&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.admin&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.contenttypes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.messages&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django_python3_ldap&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;jobs&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;interview&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>模板里面使用 bootstrap 标签</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;# Load the tag library #&#125;</span><br><span class="line">&#123;% load bootstrap4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# Load CSS and JavaScript #&#125;</span><br><span class="line">&#123;% bootstrap_css %&#125;</span><br><span class="line">&#123;% bootstrap_javascript jquery=&#x27;full&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# Display django.contrib.messages as Bootstrap alerts #&#125;</span><br><span class="line">&#123;% bootstrap_messages %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h2</span>&gt;</span>提交简历<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">class</span>=<span class="string">&quot;form&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width: 600px;margin-left: 5px&quot;</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &#123;% bootstrap_form form %&#125;</span><br><span class="line"></span><br><span class="line">    &#123;% buttons %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span></span><br><span class="line">        提交</span><br><span class="line">    <span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">    &#123;% endbuttons %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="简历评估和安排一面面试官"><a href="#简历评估和安排一面面试官" class="headerlink" title="简历评估和安排一面面试官"></a>简历评估和安排一面面试官</h2><ul>
<li>目标：打通简历投递与面试流程，让简历实体 (Resume) 流转到候选人实体 (Candidate)</li>
<li>添加一个数据操作菜单“进入面试流程”</li>
<li>定义 enter_interview_process方法<ul>
<li>def enter_interview_process(modeladmin, request, queryset)</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jobs/admin.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> messages</span><br><span class="line"><span class="keyword">from</span> datetime <span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> jobs.models <span class="keyword">import</span> Job, Resume</span><br><span class="line"><span class="keyword">from</span> interview.models <span class="keyword">import</span> Candidate</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">enter_interview_process</span>(<span class="params">modeladmin, request, queryset</span>):</span><br><span class="line">    candidate_names = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">for</span> resume <span class="keyword">in</span> queryset:</span><br><span class="line">        candidate = Candidate()</span><br><span class="line">        <span class="comment"># 把 obj 对象中的所有属性拷贝到 candidate 对象中:</span></span><br><span class="line">        candidate.__dict__.update(resume.__dict__)</span><br><span class="line">        candidate.created_date = datetime.now()</span><br><span class="line">        candidate.modified_date = datetime.now()</span><br><span class="line">        candidate_names = candidate.username + <span class="string">&quot;,&quot;</span> + candidate_names</span><br><span class="line">        candidate.creator = request.user.username</span><br><span class="line">        candidate.save()</span><br><span class="line">    messages.add_message(request, messages.INFO, <span class="string">&#x27;候选人: %s 已成功进入面试流程&#x27;</span> % (candidate_names))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">enter_interview_process.short_description = <span class="string">&quot;进入面试流程&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注册到 modeladmin中</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 简历管理类</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResumeAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    actions = (enter_interview_process,)</span><br></pre></td></tr></table></figure>
<h2 id="定制列表字段，查看简历详情"><a href="#定制列表字段，查看简历详情" class="headerlink" title="定制列表字段，查看简历详情"></a>定制列表字段，查看简历详情</h2><ul>
<li>添加 ResumeDetailView 的详情页视图，使用 Django的通用视图，继承自 DetailView</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> DetailView</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResumeDetailView</span>(<span class="title class_ inherited__">DetailView</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;   简历详情页    &quot;&quot;&quot;</span></span><br><span class="line">    model = Resume</span><br><span class="line">    template_name = <span class="string">&#x27;resume_detail.html&#x27;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>添加 Detail 页模板： resume_detail.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">&#123;# Load the tag library #&#125;</span><br><span class="line">&#123;% load bootstrap4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# Load CSS and JavaScript #&#125;</span><br><span class="line">&#123;% bootstrap_css %&#125;</span><br><span class="line">&#123;% bootstrap_javascript jquery=&#x27;full&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# Display django.contrib.messages as Bootstrap alerts #&#125;</span><br><span class="line">&#123;% bootstrap_messages %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>简历详细信息 <span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span> 姓名: &#123;&#123; object.username &#125;&#125; <span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span>&gt;</span>城市： &#123;&#123; object.city &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span> <span class="tag">&lt;<span class="name">div</span>&gt;</span>手机号码: &#123;&#123; object.phone &#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>邮件地址: &#123;&#123; object.email&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>申请职位: &#123;&#123; object.apply_position&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>出生地: &#123;&#123; object.born_address&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>性别: &#123;&#123; object.gender&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>本科学校: &#123;&#123; object.bachelor_school&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>研究所学校: &#123;&#123; object.master_school&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>专业: &#123;&#123; object.major&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span>学历: &#123;&#123; object.degree&#125;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>候选人介绍: &#123;&#123; object.candidate_introduction&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>工作经历: &#123;&#123; object.work_experience&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span>项目经历: &#123;&#123; object.project_experience&#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加路由跳转:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">from</span> jobs <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># 职位列表</span></span><br><span class="line">    url(<span class="string">r&quot;^joblist/&quot;</span>, views.job_list, name=<span class="string">&quot;joblist&quot;</span>),</span><br><span class="line">    <span class="comment"># 职位详情</span></span><br><span class="line">    url(<span class="string">r&quot;^job/(?P&lt;job_id&gt;\d+)/$&quot;</span>, views.detail, name=<span class="string">&quot;detail&quot;</span>),</span><br><span class="line">    <span class="comment"># 提交简历</span></span><br><span class="line">    path(<span class="string">&#x27;resume/add/&#x27;</span>, views.ResumeCreateView.as_view(), name=<span class="string">&#x27;resume-add&#x27;</span>),</span><br><span class="line">    <span class="comment"># 简历详情</span></span><br><span class="line">    path(<span class="string">&#x27;resume/&lt;int:pk&gt;/&#x27;</span>, views.ResumeDetailView.as_view(), name=<span class="string">&#x27;resume-detail&#x27;</span>),</span><br><span class="line">    <span class="comment"># 首页自动跳转 职位列表</span></span><br><span class="line">    url(<span class="string">r&quot;^$&quot;</span>, views.job_list, name=<span class="string">&quot;name&quot;</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>候选人列表页， 对于每一行来自简历投递的数据，添加一个“查看简历”的链接:<ul>
<li>列表页，使用 函数名称 作为 list_display 中的字段</li>
<li>定义一个函数， 获取 简历详情页链接</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># interview/admin.py</span></span><br><span class="line"><span class="comment"># 在简历管理类下写一个方法</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 面试官查看简历</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_resume</span>(<span class="params">self, obj</span>):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> obj.phone:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    resumes = Resume.objects.<span class="built_in">filter</span>(phone=obj.phone)</span><br><span class="line">    <span class="keyword">if</span> resumes:</span><br><span class="line">        <span class="keyword">return</span> mark_safe(<span class="string">&#x27;&lt;a href=&quot;/resume/%s&quot; target=&quot;_blank&quot;&gt;%s&lt;/a&gt;&#x27;</span> % (resumes[<span class="number">0</span>].<span class="built_in">id</span>, <span class="string">&quot;查看简历&quot;</span>))</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">get_resume.short_description = <span class="string">&quot;查看简历&quot;</span></span><br><span class="line">get_resume.allow_tags = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在list_display 加上这个方法</span></span><br></pre></td></tr></table></figure>
<h1 id="Django进阶开发复杂场景"><a href="#Django进阶开发复杂场景" class="headerlink" title="Django进阶开发复杂场景"></a>Django进阶开发复杂场景</h1><h2 id="为已有系统数据库生成管理功能"><a href="#为已有系统数据库生成管理功能" class="headerlink" title="为已有系统数据库生成管理功能"></a>为已有系统数据库生成管理功能</h2><p>问题：</p>
<ul>
<li>已经有内部系统在运行了，缺少管理功能，希望能有一个权利后台</li>
<li>比如 人事系统，CRM，ERP 的产品，缺少部分数据的维护功能</li>
</ul>
<p>为已有数据库生成管理后台</p>
<ul>
<li>创建项目: django-admin startproject empmanager</li>
<li>编辑settings.py中的数据库配置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;mydatabase&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;mydatabaseuser&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;mypassword&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>: <span class="string">&#x27;5432&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>生成 model 类: python manage.py inspectdb &gt; models.py</li>
</ul>
<h2 id="Django中间件"><a href="#Django中间件" class="headerlink" title="Django中间件"></a>Django中间件</h2><p>Django中间件Middleware：</p>
<ul>
<li>注入在 Django 请求/响应 处理流程中的钩子框架，能对 request/response 作处理</li>
</ul>
<p>使用场景：</p>
<ul>
<li>登录认证，安全拦截</li>
<li>日志记录，性能上报</li>
<li>缓存处理，监控告警</li>
</ul>
<p>自定义中间件的2种方法：使用函数或者类来实现</p>
<p>使用函数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">simple_middleware</span>(<span class="params">get_response</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">middleware</span>(<span class="params">request</span>):</span><br><span class="line">        <span class="comment"># 每个请求之前执行的代码</span></span><br><span class="line">        response = get_response(request)</span><br><span class="line">        <span class="comment"># request/response之后</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">return</span> middleware</span><br></pre></td></tr></table></figure>
<p>类实现，Django提供的get_response方法，可能是一个真实的视图，也可能是请求处理链中的下一个中间件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">SimpleMiddleware</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, get_response</span>):</span><br><span class="line">        self.get_response = get_response</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="comment"># 每个请求之前执行的代码</span></span><br><span class="line">        response = self.get_response(resquest)</span><br><span class="line">        <span class="comment"># 之后</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h2 id="创建请求日志、性能日志记录中间件"><a href="#创建请求日志、性能日志记录中间件" class="headerlink" title="创建请求日志、性能日志记录中间件"></a>创建请求日志、性能日志记录中间件</h2><ul>
<li>定义实现中间件: def performance_logger_middleware(get_response)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># interview应用新建文件performance.py</span></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">performance_logger_middleware</span>(<span class="params">get_response</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">middleware</span>(<span class="params">request</span>):</span><br><span class="line">        start_time = time.time()</span><br><span class="line">        response = get_response(request)</span><br><span class="line">        duration = time.time() - start_time</span><br><span class="line">        <span class="comment"># 通过response头将耗时时间返回出去</span></span><br><span class="line">        response[<span class="string">&quot;X-Page-Duration-ms&quot;</span>] = <span class="built_in">int</span>(duration * <span class="number">1000</span>)</span><br><span class="line">        logger.info(<span class="string">&quot;%s %s %s&quot;</span>, duration, request.path, request.GET.<span class="built_in">dict</span>())</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> middleware</span><br></pre></td></tr></table></figure>
<ul>
<li>记录请求 URL， 参数， 响应时间</li>
<li>注册 middleware 到 settings 中</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">&#x27;interview.performance.performance_logger_middleware&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>配置 日志文件路径</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    ......</span><br><span class="line">    <span class="string">&quot;handlers&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;console&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;class&quot;</span>: <span class="string">&quot;logging.StreamHandler&quot;</span>,</span><br><span class="line">            <span class="string">&quot;formatter&quot;</span>: <span class="string">&quot;simple&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 记录到文件</span></span><br><span class="line">        <span class="string">&quot;file&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;class&quot;</span>: <span class="string">&quot;logging.FileHandler&quot;</span>,</span><br><span class="line">            <span class="string">&quot;formatter&quot;</span>: <span class="string">&quot;simple&quot;</span>,</span><br><span class="line">            <span class="string">&quot;filename&quot;</span>: os.path.join(os.path.dirname(BASE_DIR), <span class="string">&#x27;recruitment.admin.log&#x27;</span>)</span><br><span class="line">        &#125;,</span><br><span class="line"></span><br><span class="line">        <span class="string">&#x27;performance&#x27;</span>: &#123;</span><br><span class="line">            <span class="comment">#&#x27;level&#x27;: &#x27;INFO&#x27;,</span></span><br><span class="line">            <span class="string">&#x27;class&#x27;</span>: <span class="string">&#x27;logging.FileHandler&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;formatter&#x27;</span>: <span class="string">&#x27;simple&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;filename&#x27;</span>: os.path.join(os.path.dirname(BASE_DIR), <span class="string">&#x27;recruitment.performance.log&#x27;</span>),</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="string">&quot;loggers&quot;</span>: &#123;</span><br><span class="line">		.......</span><br><span class="line">        <span class="string">&quot;interview.performance&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;handlers&quot;</span>: [<span class="string">&quot;console&quot;</span>, <span class="string">&quot;performance&quot;</span>],</span><br><span class="line">            <span class="string">&quot;level&quot;</span>: <span class="string">&quot;INFO&quot;</span>,</span><br><span class="line">            <span class="string">&quot;propagate&quot;</span>: <span class="literal">False</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210208220830.png" alt=""></p>
<h2 id="Django中使用多语言"><a href="#Django中使用多语言" class="headerlink" title="Django中使用多语言"></a>Django中使用多语言</h2><p>使用多语言：</p>
<ul>
<li>代码中使用 gettext, gettext_lazy 获取多语言资源对应的文本内容</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> gettext_lazy <span class="keyword">as</span> _</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Resume</span>(models.Model):</span><br><span class="line">    <span class="comment"># Translators: 简历实体的翻译</span></span><br><span class="line">    username = models.CharField(max_length=<span class="number">135</span>, verbose_name=_(<span class="string">&#x27;姓名&#x27;</span>))</span><br></pre></td></tr></table></figure>
<p>职位列表页使用多语言:</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- base.html --&gt;</span></span><br><span class="line">&#123;# Load the tag library #&#125;</span><br><span class="line">&#123;% load bootstrap4 %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% load i18n %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# Load CSS and JavaScript #&#125;</span><br><span class="line">&#123;% bootstrap_css %&#125;</span><br><span class="line">&#123;% bootstrap_javascript jquery=&#x27;full&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;# Display django.contrib.messages as Bootstrap alerts #&#125;</span><br><span class="line">&#123;% bootstrap_messages %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span> <span class="attr">style</span>=<span class="string">&quot;margin: auto;width: 50%;&quot;</span>&gt;</span>&#123;% translate &quot;天维科技开放职位&quot; %&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% block header %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-decoration: none; color:#007bff&quot;</span>&gt;</span>&#123;% translate &quot;Homepage&quot; %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/joblist&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-decoration: none; color:#007bff&quot;</span>&gt;</span>&#123;% translate &quot;job list&quot; %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% if user.is_authenticated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/accounts/logout&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-decoration: none; color:#007bff&quot;</span>&gt;</span>&quot;&#123;% translate &quot;Logout&quot; %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;/accounts/login&quot;</span> <span class="attr">style</span>=<span class="string">&quot;text-decoration: none; color:#007bff&quot;</span>&gt;</span>&#123;% translate &quot;Login&quot; %&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% if user.is_authenticated %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;% blocktranslate with user_name=user.username %&#125; 终于等到你 &#123;&#123; user_name &#125;&#125;,期待加入我们，用技术去探索一个新世界 &#123;% endblocktranslate  %&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% else %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;% translate &quot;欢迎你，期待加入我们，登陆后可以提交简历.&quot; %&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>生成多语言资源文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> locale     <span class="comment"># 在项目根目录创建存放多语言文件的目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 生成文本格式的多语言资源文件 .po 文件</span></span><br><span class="line">django-admin makemessages -l zh_HANS -l en</span><br><span class="line"><span class="comment"># 可能会报错，需要安装 gettext, http://gnuwin32.sourceforge.net/packages/gettext.htm</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>翻译多语言内容</li>
<li>编译生成二进制多语言资源文件</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin compilemessages</span><br></pre></td></tr></table></figure>
<p>在项目urls.py文件配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">path(<span class="string">&#x27;i18n/&#x27;</span>, include(<span class="string">&#x27;django.conf.urls.i18n&#x27;</span>)),</span><br></pre></td></tr></table></figure>
<p>在settings.py配置文件：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.translation <span class="keyword">import</span> gettext_lazy <span class="keyword">as</span> _</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">LANGUAGES = [</span><br><span class="line">    (<span class="string">&#x27;zh-hans&#x27;</span>, _(<span class="string">&#x27;Chinese&#x27;</span>)),</span><br><span class="line">    (<span class="string">&#x27;en&#x27;</span>, _(<span class="string">&#x27;English&#x27;</span>)),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">LANGUAGE_CODE = <span class="string">&#x27;zh-hans&#x27;</span></span><br><span class="line"></span><br><span class="line">TIME_ZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line"></span><br><span class="line">USE_I18N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_L10N = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">USE_TZ = <span class="literal">True</span></span><br><span class="line"></span><br><span class="line">LOCALE_PATHS = (</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">&#x27;locale&#x27;</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在页面上添加可以选择语言的按钮</p>
<p>在职位列表首页加上一个表单 base.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&quot;flex: 1; align-content:right;&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">&quot;&#123;% url &#x27;set_language&#x27; %&#125;&quot;</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-block-end: 0em;&quot;</span>&gt;</span>&#123;% csrf_token %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">name</span>=<span class="string">&quot;next&quot;</span> <span class="attr">type</span>=<span class="string">&quot;hidden&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; redirect_to &#125;&#125;&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">name</span>=<span class="string">&quot;language&quot;</span>&gt;</span></span><br><span class="line">        &#123;% get_current_language as LANGUAGE_CODE %&#125;</span><br><span class="line">        &#123;% get_available_languages as LANGUAGES %&#125;</span><br><span class="line">        &#123;% get_language_info_list for LANGUAGES as languages %&#125;</span><br><span class="line">        &#123;% for language in languages %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">&quot;&#123;&#123; language.code &#125;&#125;&quot;</span>&#123;% <span class="attr">if</span> <span class="attr">language.code</span> == <span class="string">LANGUAGE_CODE</span> %&#125; <span class="attr">selected</span>&#123;% <span class="attr">endif</span> %&#125;&gt;</span></span><br><span class="line">                &#123;&#123; language.name_local &#125;&#125; (&#123;&#123; language.code &#125;&#125;)</span><br><span class="line">            <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">value</span>=<span class="string">&#123;%</span> <span class="attr">translate</span> &quot;<span class="attr">Switch</span>&quot; %&#125; <span class="attr">style</span>=<span class="string">&quot;font-size:12;height:20px&quot;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在settings.py文件配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 加上中间件</span></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line">    ......</span><br><span class="line">    <span class="string">&#x27;django.contrib.sessions.middleware.SessionMiddleware&#x27;</span>,</span><br><span class="line">    <span class="comment"># 在session前面common后面加上配置</span></span><br><span class="line">    <span class="string">&#x27;django.middleware.locale.LocaleMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="错误和异常日志上报"><a href="#错误和异常日志上报" class="headerlink" title="错误和异常日志上报"></a>错误和异常日志上报</h2><h3 id="Sentry集成"><a href="#Sentry集成" class="headerlink" title="Sentry集成"></a>Sentry集成</h3><p>使用 Docker 来安装 sentry, 使用 release 版本</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/getsentry/onpremise/releases">https://github.com/getsentry/onpremise/releases</a></li>
<li>./install.sh</li>
<li>docker-compose up -d</li>
</ul>
<p>Django 配置集成 sentry ， 自动上报未捕获异常， 错误日志</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210209102445.png" alt=""></p>
<h3 id="异常发送钉钉群"><a href="#异常发送钉钉群" class="headerlink" title="异常发送钉钉群"></a>异常发送钉钉群</h3><p>自定义中间件来实现</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># performance.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">import</span> traceback</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> sentry_sdk <span class="keyword">import</span> capture_exception</span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> dingtalk</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 性能和异常 日志记录的中间件</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PerformanceAndExceptionLoggerMiddleware</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, get_response</span>):</span><br><span class="line">        self.get_response = get_response</span><br><span class="line">        <span class="comment"># One-time configuration and initialization.</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># __call__相当于 前面处理resuest的函数</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__call__</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="comment"># Code to be executed for each request before</span></span><br><span class="line">        <span class="comment"># the view (and later middleware) are called.</span></span><br><span class="line"></span><br><span class="line">        start_time = time.time()</span><br><span class="line">        response = self.get_response(request)</span><br><span class="line">        duration = time.time() - start_time</span><br><span class="line">        <span class="comment"># 将耗时时间记录下来，放到响应头里</span></span><br><span class="line">        response[<span class="string">&quot;X-Page-Duration-ms&quot;</span>] = <span class="built_in">int</span>(duration * <span class="number">1000</span>)</span><br><span class="line">        logger.info(<span class="string">&quot;duration:%s url:%s parameters:%s&quot;</span>, duration, request.path, request.GET.<span class="built_in">dict</span>() )</span><br><span class="line">        <span class="comment"># 当耗时超过500ms，就认为响应慢，记录到sentry</span></span><br><span class="line">        <span class="keyword">if</span> duration &gt; <span class="number">500</span>:</span><br><span class="line">            capture_message(<span class="string">&quot;slow request for url: %s with duration: %s&quot;</span> % (request.build_absolute_uri(), duration))</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Code to be executed for each request/response after</span></span><br><span class="line">        <span class="comment"># the view is called.</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 处理异常</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">process_exception</span>(<span class="params">self, request, exception</span>):</span><br><span class="line">        <span class="keyword">if</span> exception:</span><br><span class="line">                </span><br><span class="line">            message = <span class="string">&quot;url:&#123;url&#125; ** msg:&#123;error&#125; ````&#123;tb&#125;````&quot;</span>.<span class="built_in">format</span>(</span><br><span class="line">                url = request.build_absolute_uri(),</span><br><span class="line">                error = <span class="built_in">repr</span>(exception),</span><br><span class="line">                tb = traceback.format_exc()</span><br><span class="line">            )</span><br><span class="line">            </span><br><span class="line">            logger.warning(message)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># send dingtalk message</span></span><br><span class="line">            dingtalk.send(message)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># capture exception to sentry:</span></span><br><span class="line">            capture_exception(exception)</span><br><span class="line">                </span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">&quot;Error processing the request, please contact the system administrator.&quot;</span>, status=<span class="number">500</span>)</span><br></pre></td></tr></table></figure>
<p>在settings.py配置中间件</p>
<h2 id="Django安全防护"><a href="#Django安全防护" class="headerlink" title="Django安全防护"></a>Django安全防护</h2><h3 id="防止XSS跨站脚本攻击"><a href="#防止XSS跨站脚本攻击" class="headerlink" title="防止XSS跨站脚本攻击"></a>防止XSS跨站脚本攻击</h3><ul>
<li>恶意攻击者将代码通过网站注入到其他用户浏览器中的 攻击方式</li>
<li>攻击者会把恶意 JavaScript 代码作为普通数据放入 到网站数据库中；</li>
<li>其他用户在获取和展示数据的过程中，运行 JavaScript 代码；</li>
<li>JavaScript 代码执行恶意代码（调用恶意请求，发送 数据到攻击者等等）</li>
</ul>
<p>举例说明：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jobs/view.py</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 直接返回  HTML 内容的视图 （这段代码返回的页面有 XSS 漏洞，能够被攻击者利用）</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">detail_resume</span>(<span class="params">request, resume_id</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        resume = Resume.objects.get(pk=resume_id)</span><br><span class="line">        content = <span class="string">&quot;name: %s &lt;br&gt;  introduction: %s &lt;br&gt;&quot;</span> % (resume.username, resume.candidate_introduction)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(content)</span><br><span class="line">    <span class="keyword">except</span> Resume.DoesNotExist:</span><br><span class="line">        <span class="keyword">raise</span> Http404(<span class="string">&quot;resume does not exist&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>在jobs/url.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> settings.DEBUG :</span><br><span class="line">    <span class="comment"># 有 XSS 漏洞的视图页面，</span></span><br><span class="line">    urlpatterns += [url(<span class="string">r&#x27;^detail_resume/(?P&lt;resume_id&gt;\d+)/$&#x27;</span>, views.detail_resume, name=<span class="string">&#x27;detail_resume&#x27;</span>),]</span><br></pre></td></tr></table></figure>
<p>在简历上加上这么一段js脚本:</p>
<p><code>&lt;script&gt;alert(&#39;page cookies:\n&#39; + document.cookie;)&lt;/script&gt;</code></p>
<p>可以利用django自带的模板渲染机制，来渲染页面。</p>
<h3 id="CSRF-跨站请求伪造"><a href="#CSRF-跨站请求伪造" class="headerlink" title="CSRF 跨站请求伪造"></a>CSRF 跨站请求伪造</h3><ul>
<li>CSRF（Cross-site request forgery，简称：CSRF 或 XSRF）</li>
<li>恶意攻击者在用户不知情的情况下，使用用户的身份来操作</li>
<li>黑客创建一个 请求网站 A 类的 URL 的 Web 页面，放在恶意网站 B 中 ，这个文件包含了一个创建 用户的表单。这个表单加载完毕就会立即进行提交</li>
<li>黑客把这个恶意 Web 页面的 URL 发送至超级管理员，诱导超级管理员打开这个 Web 页面</li>
</ul>
<p>django在中间件 CsrfViewMiddleware</p>
<h3 id="SQL-注入攻击"><a href="#SQL-注入攻击" class="headerlink" title="SQL 注入攻击"></a>SQL 注入攻击</h3><ul>
<li>SQL 注入漏洞: 攻击者直接对网站数据库执行任意 SQL语句，在无需 用户权限的情况下即可实现对数据的访问、修改甚至是删除</li>
<li>Django 的 ORM 系统自动规避了 SQL 注入攻击</li>
<li>原始 SQL 语句，切记避免拼接字符串，这是错误的调用方式：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">query = <span class="string">&#x27;select * from employee where last_name=%s&#x27;</span> % name</span><br><span class="line">Person.objects.raw(query)</span><br></pre></td></tr></table></figure>
<ul>
<li>正确的调用方式， 使用参数绑定:</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name_map = &#123;<span class="string">&#x27;first&#x27;</span>: <span class="string">&#x27;first_name&#x27;</span>, <span class="string">&#x27;last&#x27;</span>: <span class="string">&#x27;last_name&#x27;</span>, <span class="string">&#x27;pk&#x27;</span>: <span class="string">&#x27;id&#x27;</span>&#125;</span><br><span class="line">Person.objects.raw(<span class="string">&#x27;select * from employee&#x27;</span>, translations=name_map)</span><br></pre></td></tr></table></figure>
<h2 id="Django-Rest-Framework-开放API"><a href="#Django-Rest-Framework-开放API" class="headerlink" title="Django Rest Framework 开放API"></a>Django Rest Framework 开放API</h2><p>按Django Rest Framework文档上的说明：<a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/">https://www.django-rest-framework.org/</a></p>
<ul>
<li>安装依赖包</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">pip install djangorestframework</span><br><span class="line">pip install markdown       <span class="comment"># Markdown support for the browsable API.</span></span><br><span class="line">pip install django-filter  <span class="comment"># Filtering support</span></span><br></pre></td></tr></table></figure>
<ul>
<li>注册app</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>添加url</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">&#x27;api-auth/&#x27;</span>, include(<span class="string">&#x27;rest_framework.urls&#x27;</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>在settings.py中配置权限</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># Use Django&#x27;s standard `django.contrib.auth` permissions,</span></span><br><span class="line">    <span class="comment"># or allow read-only access for unauthenticated users.</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_PERMISSION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;rest_framework.permissions.DjangoModelPermissionsOrAnonReadOnly&#x27;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将用户信息和职位信息通过API暴露出去，需要对用户的Model和职位的Model提供相应的序列化方式。</p>
<p>在项目的urls.py中定义序列化方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line"><span class="keyword">from</span> jobs.models <span class="keyword">import</span> Job</span><br><span class="line"></span><br><span class="line"><span class="comment"># Serializers define the API representation.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserSerializer</span>(serializers.HyperlinkedModelSerializer):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = User</span><br><span class="line">        fields = [<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;is_staff&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment"># ViewSets define the view behavior.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserViewSet</span>(viewsets.ModelViewSet):</span><br><span class="line">    queryset = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = UserSerializer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JobSerializer</span>(serializers.HyperlinkedModelSerializer):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Job</span><br><span class="line">        fields = <span class="string">&#x27;__all__&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JobViewSet</span>(viewsets.ModelViewSet):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    API endpoint that allows groups to be viewed or edited.</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    queryset = Job.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = JobSerializer</span><br><span class="line"></span><br><span class="line"><span class="comment"># Routers provide an easy way of automatically determining the URL conf.</span></span><br><span class="line">router = routers.DefaultRouter()</span><br><span class="line">router.register(<span class="string">r&#x27;users&#x27;</span>, UserViewSet)</span><br><span class="line">router.register(<span class="string">r&#x27;jobs&#x27;</span>, JobViewSet)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">	......</span><br><span class="line">    <span class="comment"># django rest api &amp; api auth (login/logout)</span></span><br><span class="line">    path(<span class="string">&#x27;api/&#x27;</span>, include(router.urls)),</span><br><span class="line">    path(<span class="string">&#x27;api-auth/&#x27;</span>, include(<span class="string">&#x27;rest_framework.urls&#x27;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210209133957.png" alt=""></p>
<h2 id="在Django中使用缓存"><a href="#在Django中使用缓存" class="headerlink" title="在Django中使用缓存"></a>在Django中使用缓存</h2><p>Django 缓存的存储方式：</p>
<ul>
<li>Memcached 缓存</li>
<li>Redis 缓存 （需要安装 django-redis 包）</li>
<li>数据库缓存</li>
<li>文件系统缓存</li>
<li>本地内存缓存</li>
<li>伪缓存( Dummy Cache， 用于开发、测试)</li>
<li>自定义缓存</li>
</ul>
<p>缓存的策略：</p>
<ul>
<li>整站缓存</li>
<li>视图缓存（使用CachePage来标记）</li>
<li>模板片段缓存</li>
</ul>
<p>django-redis 中文文档：<a target="_blank" rel="noopener" href="https://django-redis-chs.readthedocs.io/zh_CN/latest/">https://django-redis-chs.readthedocs.io/zh_CN/latest/</a></p>
<ul>
<li>安装：pip install django-redis</li>
<li>配置：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在settings.py</span></span><br><span class="line"></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;django_redis.cache.RedisCache&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LOCATION&quot;</span>: <span class="string">&quot;redis://127.0.0.1:6379/1&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;CLIENT_CLASS&quot;</span>: <span class="string">&quot;django_redis.client.DefaultClient&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 整站缓存，加上中间件</span></span><br><span class="line">MIDDLEWARE = [</span><br><span class="line"></span><br><span class="line">    <span class="string">&#x27;django.middleware.cache.UpdateCacheMiddleware&#x27;</span></span><br><span class="line">    <span class="string">&#x27;django.middleware.common.CommonMiddleware&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.middleware.cache.FetchFromCacheMiddleware&#x27;</span>,</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="Django与Celery集成"><a href="#Django与Celery集成" class="headerlink" title="Django与Celery集成"></a>Django与Celery集成</h2><p>Celery简单介绍：</p>
<ul>
<li>一个分布式的任务队列</li>
<li>简单： 几行代码可以创建一个简单的 Celery 任务</li>
<li>高可用：工作机会自动重试</li>
<li>快速：可以执行一分钟上百万的任务</li>
<li>灵活：每一块都可以扩展</li>
</ul>
<p>Celery使用场景，使用异步任务的场景：</p>
<ul>
<li>发送电子邮件，发送 IM 消息通知</li>
<li>爬取网页， 数据分析</li>
<li>图像、视频处理</li>
<li>生成报告，深度学习</li>
</ul>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.celeryproject.org/en/stable/getting-started/introduction.html#what-s-a-task-queue">https://docs.celeryproject.org/en/stable/getting-started/introduction.html#what-s-a-task-queue</a></p>
<p>安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install celery</span><br><span class="line">pip install <span class="string">&quot;celery[librabbitmq,redis,auth,msgpack]&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第一个参数是当前运行脚本的名字</span></span><br><span class="line"><span class="comment"># backend存储是把每一个异步任务运行的结果存储在什么地方</span></span><br><span class="line"><span class="comment"># broker是存储任务的系统代理，也是一个消息队列</span></span><br><span class="line">app = Celery(<span class="string">&#x27;tasks&#x27;</span>, backend=<span class="string">&#x27;redis://127.0.0.1&#x27;</span>, broker=<span class="string">&#x27;redis://127.0.0.1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">x, y</span>):</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br></pre></td></tr></table></figure>
<p>运行celery</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># linux是这么运行的</span></span><br><span class="line">celery -A tasks worker --loglevel=INFO</span><br><span class="line"></span><br><span class="line"><span class="comment"># celery高版本不支持Windows</span></span><br></pre></td></tr></table></figure>
<p>添加运行任务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># run.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> tasks <span class="keyword">import</span> add</span><br><span class="line"></span><br><span class="line">result = add.delay(<span class="number">4</span>, <span class="number">4</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;Is task ready: %s&#x27;</span> % result.ready())</span><br><span class="line"></span><br><span class="line">run_result = result.get(timeout=<span class="number">1</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&#x27;task result: %s&#x27;</span> % run_result)</span><br></pre></td></tr></table></figure>
<p>Flower: 一个实时的 Celery 任务监控系统</p>
<p>安装：pip install flower</p>
<p>官方文档：<a target="_blank" rel="noopener" href="https://docs.celeryproject.org/en/stable/userguide/monitoring.html">https://docs.celeryproject.org/en/stable/userguide/monitoring.html</a></p>
<h3 id="Django与Celery集成：异步任务"><a href="#Django与Celery集成：异步任务" class="headerlink" title="Django与Celery集成：异步任务"></a>Django与Celery集成：异步任务</h3><p>文档：<a target="_blank" rel="noopener" href="https://docs.celeryproject.org/en/stable/django/first-steps-with-django.html">https://docs.celeryproject.org/en/stable/django/first-steps-with-django.html</a></p>
<ul>
<li>Celery 4.0 的版本支持 Django 集成</li>
<li>不需要安装额外的库</li>
<li>使用 Celery 的自动发现机制: 自动发现 tasks.py</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210209161038.png" alt=""></p>
<p>在项目主应用下新建celery.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import, unicode_literals</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">from</span> celery.schedules <span class="keyword">import</span> crontab</span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the default Django settings module for the &#x27;celery&#x27; program.</span></span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="string">&#x27;settings.base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">&#x27;recruitment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Using a string here means the worker doesn&#x27;t have to serialize</span></span><br><span class="line"><span class="comment"># the configuration object to child processes.</span></span><br><span class="line"><span class="comment"># - namespace=&#x27;CELERY&#x27; means all celery-related configuration keys</span></span><br><span class="line"><span class="comment">#   should have a `CELERY_` prefix.</span></span><br><span class="line">app.config_from_object(<span class="string">&#x27;django.conf:settings&#x27;</span>, namespace=<span class="string">&#x27;CELERY&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Load task modules from all registered Django app configs.</span></span><br><span class="line">app.autodiscover_tasks()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task(<span class="params">bind=<span class="literal">True</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">debug_task</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;Request: &#123;0!r&#125;&#x27;</span>.<span class="built_in">format</span>(self.request))</span><br></pre></td></tr></table></figure>
<p>在项目主应用<code>__init__.py</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># This will make sure the app is always imported when</span></span><br><span class="line"><span class="comment"># Django starts so that shared_task will use this app.</span></span><br><span class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app <span class="keyword">as</span> celery_app</span><br><span class="line"></span><br><span class="line">__all__ = (<span class="string">&#x27;celery_app&#x27;</span>,)</span><br></pre></td></tr></table></figure>
<p>在配置文件上配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CELERY_BROKER_URL = <span class="string">&#x27;redis://redis:6379/0&#x27;</span></span><br><span class="line">CELERY_RESULT_BACKEND = <span class="string">&#x27;redis://redis:6379/1&#x27;</span></span><br><span class="line">CELERY_ACCEPT_CONTENT = [<span class="string">&#x27;application/json&#x27;</span>]</span><br><span class="line">CELERY_RESULT_SERIALIZER = <span class="string">&#x27;json&#x27;</span></span><br><span class="line">CELERY_TASK_SERIALIZER = <span class="string">&#x27;json&#x27;</span></span><br><span class="line">CELERY_TIMEZONE = <span class="string">&#x27;Asia/Shanghai&#x27;</span></span><br><span class="line">CELERYD_MAX_TASKS_PER_CHILD = <span class="number">10</span></span><br><span class="line">CELERYD_LOG_FILE = os.path.join(BASE_DIR, <span class="string">&quot;logs&quot;</span>, <span class="string">&quot;celery_work.log&quot;</span>)</span><br><span class="line">CELERYBEAT_LOG_FILE = os.path.join(BASE_DIR, <span class="string">&quot;logs&quot;</span>, <span class="string">&quot;celery_beat.log&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>通知面试官面试，发送钉钉群消息的地方加上celery</p>
<p>在interview应用下新建tasks.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> shared_task</span><br><span class="line"><span class="keyword">from</span> .dingtalk <span class="keyword">import</span> send</span><br><span class="line"></span><br><span class="line"><span class="meta">@shared_task</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">send_dingtalk_message</span>(<span class="params">message</span>):</span><br><span class="line">    send(message)</span><br></pre></td></tr></table></figure>
<p>在admin.py下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 异步去执行</span></span><br><span class="line">send_dingtalk_message.delay(<span class="string">&quot;......&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>在项目根目录下启动：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 指定django的配置路径</span></span><br><span class="line">DJANGO_SETTINGS_MODULE=settings.local celery --app recruitment worker -l info</span><br></pre></td></tr></table></figure>
<h3 id="Django-与-Celery-集成：定时任务"><a href="#Django-与-Celery-集成：定时任务" class="headerlink" title="Django 与 Celery 集成：定时任务"></a>Django 与 Celery 集成：定时任务</h3><ul>
<li>任务心跳管理进程 Beat</li>
<li>任务调度器<ul>
<li>PersistentScheduler （默认）</li>
<li>DatabaseScheduler</li>
</ul>
</li>
<li>任务存储<ul>
<li>File Configuration</li>
<li>Database</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210209162633.png" alt=""></p>
<ul>
<li>安装 beat: pip install django-celery-beat</li>
<li>将django-celery-beat注册到app中</li>
<li>数据库迁移</li>
<li>使用 DatabaseScheduler 启动 beat 或者在 配置中设置 beat_scheduler</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DJANGO_SETTINGS_MODULE=settings.local celery -A recruitment beat --scheduler django_celery_beat.scheduler:DatabaseScheduler</span><br></pre></td></tr></table></figure>
<ul>
<li>管理定时任务的方法<ul>
<li>在 Admin 后台添加管理定时任务</li>
<li>系统启动时自动注册定时任务</li>
<li>直接设置应用的 beat_schedule</li>
<li>运行时添加定时任务</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210209164528.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210209164543.png" alt=""></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210209164617.png" alt=""></p>
<p>系统启动时自动注册定时任务：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery, shared_task</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> celery.schedules <span class="keyword">import</span> crontab</span><br><span class="line"></span><br><span class="line"><span class="comment"># set the default Django settings module for the &#x27;celery&#x27; program.</span></span><br><span class="line">os.environ.setdefault(<span class="string">&#x27;DJANGO_SETTINGS_MODULE&#x27;</span>, <span class="string">&#x27;settings.base&#x27;</span>)</span><br><span class="line"></span><br><span class="line">app = Celery(<span class="string">&#x27;recruitment&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在系统启动的时候运行</span></span><br><span class="line"><span class="meta">@app.on_after_configure.connect</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">setup_periodic_tasks</span>(<span class="params">sender, **kwargs</span>):</span><br><span class="line">    <span class="comment"># Calls test(&#x27;hello&#x27;) every 10 seconds.</span></span><br><span class="line">    sender.add_periodic_task(<span class="number">10.0</span>, test.s(<span class="string">&#x27;hello&#x27;</span>), name=<span class="string">&#x27;hello every 10&#x27;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Calls test(&#x27;world&#x27;) every 30 seconds</span></span><br><span class="line">    sender.add_periodic_task(<span class="number">30.0</span>, test.s(<span class="string">&#x27;world&#x27;</span>), expires=<span class="number">10</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># Executes every Monday morning at 7:30 a.m.</span></span><br><span class="line">    sender.add_periodic_task(</span><br><span class="line">        crontab(hour=<span class="number">7</span>, minute=<span class="number">30</span>, day_of_week=<span class="number">1</span>),</span><br><span class="line">        test.s(<span class="string">&#x27;Happy Mondays!&#x27;</span>),</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">arg</span>):</span><br><span class="line">    <span class="built_in">print</span>(arg)</span><br></pre></td></tr></table></figure>
<p>直接配置：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> recruitment.tasks <span class="keyword">import</span> add</span><br><span class="line"></span><br><span class="line">app.conf.beat_schedule = &#123;</span><br><span class="line">    <span class="string">&#x27;add-every-10-seconds&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;task&#x27;</span>: <span class="string">&#x27;recruitment.tasks.add&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;schedule&#x27;</span>: <span class="number">10.0</span>,</span><br><span class="line">        <span class="string">&#x27;args&#x27;</span>: (<span class="number">16</span>, <span class="number">4</span>, )</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>系统运行时动态添加定时任务：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">from</span> django_celery_beat.models <span class="keyword">import</span> PeriodicTask, IntervalSchedule</span><br><span class="line"></span><br><span class="line"><span class="comment"># 先创建定时策略</span></span><br><span class="line">schedule, created = IntervalSchedule.objects.get_or_create(every=<span class="number">10</span>, period=IntervalSchedule.SECONDS,)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再创建任务</span></span><br><span class="line">task = PeriodicTask.objects.create(interval=schedule, name=<span class="string">&#x27;say welcome 2021&#x27;</span>, task=<span class="string">&#x27;recruitment.celery.test&#x27;</span>, args=json.dumps([<span class="string">&#x27;welcome&#x27;</span>]))</span><br><span class="line"></span><br><span class="line"><span class="meta">@app.task</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">test</span>(<span class="params">arg</span>):</span><br><span class="line">    <span class="built_in">print</span>(arg)</span><br></pre></td></tr></table></figure>
<h2 id="文件和图片上传功能"><a href="#文件和图片上传功能" class="headerlink" title="文件和图片上传功能"></a>文件和图片上传功能</h2><p>场景/目标：</p>
<ul>
<li>投递简历的页面， 可以上传个人的照片， 以及附件简历</li>
<li>上传的文件存储在服务器上，文件服务可以扩展</li>
</ul>
<p>存储方案选型：</p>
<ul>
<li>使用服务器本地磁盘</li>
<li>自建分布式文件服务器</li>
<li>阿里云 OSS</li>
</ul>
<h3 id="使用本地磁盘存储"><a href="#使用本地磁盘存储" class="headerlink" title="使用本地磁盘存储"></a>使用本地磁盘存储</h3><ul>
<li>设置图片、文件存储路径 &amp; URL 映射，settings 里面添加 /media 路径， urls.py 中添加图片路径映射</li>
<li>准备 model, form, view 和 HTML 表单模板<ul>
<li>model 里面添加图片/文件字段（如 个人照片， 个人简历字段到 Resume）</li>
<li>form.py 中增加图片，附件字段</li>
<li>创建简历的视图中展示 picture, attachment 字段</li>
<li>HTML 表单模板中增加 enctype 属性 （resume_form.html ）</li>
</ul>
</li>
<li>变更数据库</li>
<li>Admin里面 添加展示字段， 简历列表中加上照片展示</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在配置文件上</span></span><br><span class="line">MEDIA_ROOT =  os.path.join(BASE_DIR, <span class="string">&#x27;media&#x27;</span>)</span><br><span class="line">MEDIA_URL = <span class="string">&#x27;/media/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在项目主应用下urls.py</span></span><br><span class="line">urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在jobs下新建forms.py</span></span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> ModelForm</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Resume</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResumeForm</span>(<span class="title class_ inherited__">ModelForm</span>):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = Resume</span><br><span class="line"></span><br><span class="line">        fields = [<span class="string">&quot;username&quot;</span>, <span class="string">&quot;city&quot;</span>, <span class="string">&quot;phone&quot;</span>,</span><br><span class="line">        <span class="string">&quot;email&quot;</span>, <span class="string">&quot;apply_position&quot;</span>, <span class="string">&quot;born_address&quot;</span>, <span class="string">&quot;gender&quot;</span>, <span class="string">&quot;picture&quot;</span>, <span class="string">&quot;attachment&quot;</span>,</span><br><span class="line">        <span class="string">&quot;bachelor_school&quot;</span>, <span class="string">&quot;master_school&quot;</span>, <span class="string">&quot;major&quot;</span>, <span class="string">&quot;degree&quot;</span>, </span><br><span class="line">        <span class="string">&quot;candidate_introduction&quot;</span>, <span class="string">&quot;work_experience&quot;</span>, <span class="string">&quot;project_experience&quot;</span>]</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="comment"># 在html页面的form表单上加上参数</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在简历列表管理类</span></span><br><span class="line"><span class="keyword">from</span> django.utils.html <span class="keyword">import</span> format_html</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResumeAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    actions = (enter_interview_process,)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">image_tag</span>(<span class="params">self, obj</span>):</span><br><span class="line">        <span class="keyword">if</span> obj.picture:</span><br><span class="line">            <span class="keyword">return</span> format_html(<span class="string">&#x27;&lt;img src=&quot;&#123;&#125;&quot; style=&quot;width:100px;height:80px;&quot;/&gt;&#x27;</span>.<span class="built_in">format</span>(obj.picture.url))</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line">    image_tag.allow_tags = <span class="literal">True</span></span><br><span class="line">    image_tag.short_description = <span class="string">&#x27;Image</span></span><br></pre></td></tr></table></figure>
<h3 id="使用阿里云-OSS-存储"><a href="#使用阿里云-OSS-存储" class="headerlink" title="使用阿里云 OSS 存储"></a>使用阿里云 OSS 存储</h3><p>复用前面创建好的类， 把存储替换为 OSS 存储，提升系统扩展性、可靠性</p>
<ul>
<li>安装 OSS 库，pip install django-oss-storage</li>
<li>OSS 的依赖添加 django_oss_storage 到 APPS</li>
<li>settings 里面添加 OSS 设置    </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">DEFAULT_FILE_STORAGE = <span class="string">&#x27;django_oss_storage.backends.OssMediaStorage&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># AliCloud access key ID</span></span><br><span class="line">OSS_ACCESS_KEY_ID = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># AliCloud access key secret</span></span><br><span class="line">OSS_ACCESS_KEY_SECRET = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># The name of the bucket to store files in</span></span><br><span class="line">OSS_BUCKET_NAME = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="comment"># The URL of AliCloud OSS endpoint</span></span><br><span class="line">OSS_ENDPOINT = <span class="string">&#x27;&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="多数据路由"><a href="#多数据路由" class="headerlink" title="多数据路由"></a>多数据路由</h2><p>对已有系统数据进行管理</p>
<p>应用场景：</p>
<ul>
<li>现有的一个业务应用，使用的 MySQL 数据库， 数据库名为 running </li>
<li>需要对数据库中的部分 model 进行管理。 包括 area, city, country, province 进行管理</li>
<li>使用 Django 主应用的数据库 （SQLite）管理 Django 基础账号权限数据</li>
<li>两个数据库，需要对 model 的操作做路由</li>
</ul>
<p>操作过程：</p>
<ul>
<li>多数据库配置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line"></span><br><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.sqlite3&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: BASE_DIR / <span class="string">&#x27;db.sqlite3&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&#x27;running&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;django.db.backends.mysql&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;running&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;USER&#x27;</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PASSWORD&#x27;</span>: <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;HOST&#x27;</span>: <span class="string">&#x27;127.0.0.1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PORT&#x27;</span>: <span class="string">&#x27;3306&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>指定数据库表生成 model (inspectdb)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py inspectdb --database=running --settings=settings.local area city country province &gt;&gt; running/models.py</span><br></pre></td></tr></table></figure>
<ul>
<li>注册到 Admin 中 (running/admin.py)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增一个应用app</span></span><br><span class="line">django-admin startapp running</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在running/admin.py注册model</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>添加 Router 类 &amp; settings 中配置 Router</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在settings文件夹下新建route.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">DatabaseRouter</span>:</span><br><span class="line">    route_app_labels = &#123;<span class="string">&#x27;running&#x27;</span>&#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">db_for_read</span>(<span class="params">self, model, **hints</span>):</span><br><span class="line">        <span class="keyword">if</span> model._meta.app_label <span class="keyword">in</span> self.route_app_labels:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;running&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">db_for_write</span>(<span class="params">self, model, **hints</span>):</span><br><span class="line">        <span class="keyword">if</span> model._meta.app_label <span class="keyword">in</span> self.route_app_labels:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;running&#x27;</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;default&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">allow_relation</span>(<span class="params">self, obj1, obj2, **hints</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">allow_migrate</span>(<span class="params">self, db, app_label, model_name=<span class="literal">None</span>, **hints</span>):</span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">        遗留数据库中的表不允许迁移</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        <span class="keyword">if</span> app_label <span class="keyword">in</span> self.route_app_labels:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 在配置文件配置</span></span><br><span class="line"></span><br><span class="line">DATABASE_ROUTERS = [<span class="string">&#x27;settings.router.DatabaseRouter&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="支持大数据量的关联外键"><a href="#支持大数据量的关联外键" class="headerlink" title="支持大数据量的关联外键"></a>支持大数据量的关联外键</h2><p>场景/解决问题</p>
<ul>
<li>依赖外键数据量过大导致管理后台卡顿甚至死机<ul>
<li>比如添加一个员工，员工的出生地依赖于城市表，全球的城市数据有1w多</li>
<li>添加员工的时候，要从上万的城市中选择出生地</li>
<li>Django 默认会把依赖外键中的所有数据全部加载， 浏览器会停顿乃至没有反应，导致死机</li>
<li>关系：Province 依赖于 Country, City 从属于 Province</li>
</ul>
</li>
</ul>
<p>期望：选择依赖的数据时（比如员工所属城市），可输入字符查找</p>
<ul>
<li>准备：设置 Province， City 的外键依赖<ul>
<li>countryid = models.ForeignKey(Country, db_column=’countryid’, null=True, on_delete=models.SET_NULL)</li>
</ul>
</li>
<li>设置自动完成的关联外键 (admin.py)<ul>
<li>autocomplete_fields = [‘provinceid’]</li>
</ul>
</li>
<li>依赖的 model Admin 类中设置可以搜索的字段</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CountryAdmin</span>(admin.ModelAdmin):</span><br><span class="line">	search_fields = (<span class="string">&#x27;chn_name&#x27;</span>, <span class="string">&#x27;eng_name&#x27;</span>,)</span><br></pre></td></tr></table></figure>
<p>running/model.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Area</span>(models.Model):</span><br><span class="line">    areaid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    countryid = models.PositiveIntegerField()</span><br><span class="line">    chn_name = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    eng_name = models.CharField(max_length=<span class="number">64</span>, blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    sort = models.PositiveIntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        managed = <span class="literal">False</span></span><br><span class="line">        db_table = <span class="string">&#x27;area&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Country</span>(models.Model):</span><br><span class="line">    countryid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    chn_name = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    eng_name = models.CharField(max_length=<span class="number">64</span>, blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    country_logo = models.CharField(max_length=<span class="number">120</span>, blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    sort = models.PositiveIntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        managed = <span class="literal">False</span></span><br><span class="line">        db_table = <span class="string">&#x27;country&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.chn_name <span class="keyword">if</span> self.chn_name <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Province</span>(models.Model):</span><br><span class="line">    provinceid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    countryid = models.ForeignKey(Country, db_column=<span class="string">&#x27;countryid&#x27;</span>, null=<span class="literal">True</span>, on_delete=models.SET_NULL)</span><br><span class="line">    areaid = models.PositiveIntegerField(blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    chn_name = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    eng_name = models.CharField(max_length=<span class="number">64</span>, blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    sort = models.PositiveIntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        managed = <span class="literal">False</span></span><br><span class="line">        db_table = <span class="string">&#x27;province&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.chn_name <span class="keyword">if</span> self.chn_name <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> smart_selects.db_fields <span class="keyword">import</span> ChainedForeignKey</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">City</span>(models.Model):</span><br><span class="line">    cityid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    countryid = models.ForeignKey(Country, db_column=<span class="string">&#x27;countryid&#x27;</span>, null=<span class="literal">True</span>, on_delete=models.SET_NULL)</span><br><span class="line">    areaid = models.PositiveIntegerField(blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    provinceid = models.ForeignKey(Province, db_column=<span class="string">&#x27;provinceid&#x27;</span>, null=<span class="literal">True</span>, on_delete=models.SET_NULL)</span><br><span class="line"></span><br><span class="line">    chn_name = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line">    eng_name = models.CharField(max_length=<span class="number">64</span>, blank=<span class="literal">True</span>, null=<span class="literal">True</span>)</span><br><span class="line">    sort = models.PositiveIntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        managed = <span class="literal">False</span></span><br><span class="line">        db_table = <span class="string">&#x27;city&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__str__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">return</span> self.chn_name <span class="keyword">if</span> self.chn_name <span class="keyword">else</span> self.eng_name <span class="keyword">if</span> self.eng_name <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<p>国家-城市 多级关联的场景，django中有一个 smart-selects的插件</p>
<p><a target="_blank" rel="noopener" href="https://github.com/jazzband/django-smart-selects">https://github.com/jazzband/django-smart-selects</a></p>
<ul>
<li>安装 django-smart-selects 插件，pip install django-smart-selects</li>
<li>添加 smart_selects 到安装的 APPS 中</li>
<li>在项目的 urls.py 中添加 chaining/ 的URL路径</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = patterns(<span class="string">&#x27;&#x27;</span>,</span><br><span class="line">	url(<span class="string">r&#x27;^admin/&#x27;</span>, include(admin.site.urls)),</span><br><span class="line">	url(<span class="string">r&#x27;^chaining/&#x27;</span>, include(<span class="string">&#x27;smart_selects.urls&#x27;</span>)),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>Model 中定义 ChainedForeignKey</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> smart_selects.db_fields <span class="keyword">import</span> ChainedForeignKey</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">City</span>(models.Model):</span><br><span class="line">    cityid = models.AutoField(primary_key=<span class="literal">True</span>)</span><br><span class="line">    countryid = models.ForeignKey(Country, db_column=<span class="string">&#x27;countryid&#x27;</span>, null=<span class="literal">True</span>, on_delete=model.SET_NULL)</span><br><span class="line">    </span><br><span class="line">    provinceid = ChainedForeignKey(</span><br><span class="line">    	Province,</span><br><span class="line">        chained_field=<span class="string">&#x27;countryid&#x27;</span>,</span><br><span class="line">        chained_model_field=<span class="string">&#x27;countryid&#x27;</span>,</span><br><span class="line">        show_all=<span class="literal">False</span>,</span><br><span class="line">        auto_choose=<span class="literal">True</span>,</span><br><span class="line">        sort=<span class="literal">True</span>,</span><br><span class="line">        db_column=<span class="string">&#x27;provinceid&#x27;</span></span><br><span class="line">    )</span><br></pre></td></tr></table></figure>
<h2 id="实现只读站点-ReadOnlyAdmin"><a href="#实现只读站点-ReadOnlyAdmin" class="headerlink" title="实现只读站点 ReadOnlyAdmin"></a>实现只读站点 ReadOnlyAdmin</h2><p>场景</p>
<ul>
<li>集成遗留的已有系统</li>
<li>已有系统的数据涉及到核心数据</li>
<li>为了确保数据安全，管理后台只提供数据的浏览功能</li>
</ul>
<p>解决问题：</p>
<ul>
<li>设置列表页 list_display 展示所有字段</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># running/admin.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ReadOnlyAdmin</span>(admin.ModelAdmin):</span><br><span class="line">    readonly_fields = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_list_display</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="keyword">return</span> [field.name <span class="keyword">for</span> field <span class="keyword">in</span> self.model._meta.concrete_fields]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get_readonly_fields</span>(<span class="params">self, request, obj=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">list</span>(self.readonly_fields) + \</span><br><span class="line">               [field.name <span class="keyword">for</span> field <span class="keyword">in</span> obj._meta.fields] + \</span><br><span class="line">               [field.name <span class="keyword">for</span> field <span class="keyword">in</span> obj._meta.many_to_many]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">has_add_permission</span>(<span class="params">self, request</span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">has_delete_permission</span>(<span class="params">self, request, obj=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">has_change_permission</span>(<span class="params">self, request, obj=<span class="literal">None</span></span>):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 直接继承ReadOnlyAdmin类即可</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CountryAdmin</span>(<span class="title class_ inherited__">ReadOnlyAdmin</span>):</span><br><span class="line">    search_fields = (<span class="string">&#x27;chn_name&#x27;</span>, <span class="string">&#x27;eng_name&#x27;</span>,)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="自动注册所有Model到管理后台"><a href="#自动注册所有Model到管理后台" class="headerlink" title="自动注册所有Model到管理后台"></a>自动注册所有Model到管理后台</h2><p>场景：</p>
<ul>
<li>实际的业务场景中， 往往Model 多大几十个</li>
<li>一个个写Admin， 再Register， 效率低 </li>
<li>期望：能够自动注册 Model 到管理后台</li>
</ul>
<p>不好的解决方案：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 直接for循环遍历所有的model，注册到app里面</span></span><br><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> apps</span><br><span class="line"></span><br><span class="line">models = apps.get_models()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> model <span class="keyword">in</span> models:</span><br><span class="line">    admin.site.register(model)</span><br></pre></td></tr></table></figure>
<p>这样直接注册产生的问题：</p>
<ul>
<li>settings 里面可能已经注册了 App，它是按照顺序加载的</li>
<li>重复注册时会出现异常，需要处理重复注册的逻辑</li>
</ul>
<p>解决方案1：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在项目主应用下apps.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> apps, AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AdminClass</span>(admin.ModelAdmin):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model, admin_site</span>):</span><br><span class="line">        <span class="comment"># 列表页自动显示所有的字段：</span></span><br><span class="line">        self.list_display = [field.name <span class="keyword">for</span> field <span class="keyword">in</span> model._meta.fields]</span><br><span class="line">        <span class="built_in">super</span>(AdminClass, self).__init__(model, admin_site)</span><br><span class="line"></span><br><span class="line"><span class="comment"># automatically register all models</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UniversalManagerApp</span>(<span class="title class_ inherited__">AppConfig</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    应用配置在 所有应用的 Admin 都加载完之后执行</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># the name of the AppConfig must be the same as current application</span></span><br><span class="line">    name = <span class="string">&#x27;recruitment&#x27;</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 重写ready方法，在应用加载完成之后会调用ready方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ready</span>(<span class="params">self</span>):</span><br><span class="line">        models = apps.get_app_config(<span class="string">&#x27;running&#x27;</span>).get_models() </span><br><span class="line">        <span class="keyword">for</span> model <span class="keyword">in</span> models:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment"># 这里的AdminClass是静态的，继承自ModelAdmin</span></span><br><span class="line">                admin.site.register(model, AdminClass)</span><br><span class="line">            <span class="keyword">except</span> admin.sites.AlreadyRegistered:</span><br><span class="line">                <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>解决方案2:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> admin</span><br><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> apps, AppConfig</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ListAdminMixin</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, model, admin_site</span>):</span><br><span class="line">        <span class="comment"># 列表页自动显示所有的字段</span></span><br><span class="line">        self.list_display = [field.name <span class="keyword">for</span> field <span class="keyword">in</span> model._meta.fields]</span><br><span class="line">        <span class="built_in">super</span>().__init__(model, admin_site)</span><br><span class="line"></span><br><span class="line"><span class="comment"># automatically register all models</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UniversalManagerApp</span>(<span class="title class_ inherited__">AppConfig</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    应用配置在 所有应用的 Admin 都加载完之后执行</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># the name of the AppConfig must be the same as current application</span></span><br><span class="line">    name = <span class="string">&#x27;recruitment&#x27;</span></span><br><span class="line">	</span><br><span class="line">    <span class="comment"># 重写ready方法，在应用加载完成之后会调用ready方法</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ready</span>(<span class="params">self</span>):</span><br><span class="line">        models = apps.get_app_config(<span class="string">&#x27;running&#x27;</span>).get_models() </span><br><span class="line">        <span class="keyword">for</span> model <span class="keyword">in</span> models:</span><br><span class="line">            admin_class = <span class="built_in">type</span>(<span class="string">&#x27;AdminClass&#x27;</span>, (ListAdminMixin, admin.ModelAdmin,), &#123;&#125;)</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                admin.site.register(model, admin_class)</span><br><span class="line">            <span class="keyword">except</span> admin.sites.AlreadyRegistered:</span><br><span class="line">                <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<p>既然我们把所有的Model都注册进来，我们不用去创建Django的应用，不用写代码就能去管理一个数据库里面指定的表，可以使用python动态类的方法，使用动态的model把数据库中所有的model找到，在把这个model通过动态定义的方法把它定义注册进来，这样可以实现一个通用的应用，在这个应用可以定义一些设置，去设置我是对所有的表进行维护还是只要维护部份表。这样就可以做到不用写代码，直接加配置，对已有的系统进行维护</p>
<ul>
<li>使用python中的动态特性</li>
<li>使用type()函数去定义一个类：</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">model = <span class="built_in">type</span>(name, (models.Model,), attrs)</span><br></pre></td></tr></table></figure>
<p>举例说明：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 普通的类定义：</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span>(models.Model):</span><br><span class="line">    name = models.CharField(max_length=<span class="number">255</span>)</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 动态类的定义</span></span><br><span class="line">Person = <span class="built_in">type</span>(<span class="string">&#x27;Person&#x27;</span>, (models.Model, ), &#123;</span><br><span class="line">    name = models.CharField(max_length=<span class="number">255</span>),</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>开源应用 sandman2，可以对已有数据库提供增、删、改、查功能 和 Rest API</p>
<p>安装：pip install sandman2</p>
<p>以 SQLite 数据库为例子， 启动 sandman2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sandman2ctl sqlite+pysqlite:///db.sqlite3</span><br></pre></td></tr></table></figure>
<p>访问 restapi 和 管理后台:</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:5000/">http://127.0.0.1:5000/</a></li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:5000/admin/">http://127.0.0.1:5000/admin/</a></li>
</ul>
<h2 id="Django的-signals信号"><a href="#Django的-signals信号" class="headerlink" title="Django的 signals信号"></a>Django的 signals信号</h2><p>什么是Signals</p>
<ul>
<li>Django的信号</li>
<li>Django 框架内置的信号发送器，这个信号发送器在框架里面</li>
<li>有动作发生的时候，帮助解耦的应用接收到消息通知</li>
<li>当动作发生时，允许特定的信号发送者发送消息到一系列的消息接收者</li>
<li>Signals 是同步调用</li>
</ul>
<p>信号的应用场景：</p>
<ul>
<li>系统解耦；代码复用：实现统一处理逻辑的框架中间件； -&gt; 可维护性提升</li>
<li>记录操作日志，增加/清除缓存，数据变化接入审批流程；评论通知；</li>
<li>关联业务变化通知</li>
<li>例：通讯录变化的异步事件处理，比如员工入职时发送消息通知团队新人入职，员工离 职时异步清理员工的权限等等；</li>
</ul>
<p>Signals 类的子类 （Django内置的常用信号）:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 模型实例初始化前</span></span><br><span class="line">django.db.models.signals.pre_init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型实例初始化后</span></span><br><span class="line">django.db.models.signals.post_init</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型保存前</span></span><br><span class="line">django.db.models.signals.pre_save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型保存后</span></span><br><span class="line">django.db.models.signals.post_save</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型删除前</span></span><br><span class="line">django.db.models.signals.pre_delete</span><br><span class="line"></span><br><span class="line"><span class="comment"># 模型删除后</span></span><br><span class="line">django.db.models.signals.post_delete</span><br><span class="line"></span><br><span class="line"><span class="comment">#  多对多字段被修改</span></span><br><span class="line">django.db.models.signals.m2m_changed</span><br><span class="line"></span><br><span class="line"><span class="comment"># 接收到 HTTP 请求</span></span><br><span class="line">django.core.signals.request_started</span><br><span class="line"></span><br><span class="line"><span class="comment"># HTTP 请求处理完毕</span></span><br><span class="line">django.core.signals.request_finished HTTP</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有的 Signals 都是 django.dispatch.Signal 的实例/子类</span></span><br></pre></td></tr></table></figure>
<p>如何注册信号处理器/接收器:</p>
<p>调用 Signals 任意一个子类的 connect方法</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Signal.connect(receiver, sender=<span class="literal">None</span>, weak=<span class="literal">True</span>, dispatch_uid=<span class="literal">None</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># receiver: 信号接收器，一个回调函数，即处理信号的函数。</span></span><br><span class="line"><span class="comment"># sender： 信号的发送源，哪个发送方发出的信号</span></span><br><span class="line"><span class="comment"># weak：是否是弱引用，默认是弱引用；当receiver为局部变量时，接收器可能会被回收</span></span><br><span class="line"><span class="comment"># dispatch_uid：信号接收器的唯一标识符，用来避免接收器被重复注册</span></span><br></pre></td></tr></table></figure>
<p>除了使用 Signal.connect() 方法注册处理器外，也可以使用 @receiver 的装饰器来注册</p>
<p>示例：使用装饰器来注册，修改数据时，发送消息通知到钉钉</p>
<ul>
<li>在apps 的 ready() 函数中加载信号处理器</li>
<li>settings 中使用完整的名称注册 AppConfig，去掉原先注册的 jobs 应用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在jobs下新建文件 signal_processor.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.db.models.signals <span class="keyword">import</span> post_save, post_delete</span><br><span class="line"><span class="keyword">from</span> django.dispatch <span class="keyword">import</span> receiver</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> .models <span class="keyword">import</span> Job, Resume</span><br><span class="line"><span class="keyword">from</span> interview.dingtalk <span class="keyword">import</span> send</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> json, logging</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 decorator 来注册 信号处理器</span></span><br><span class="line"><span class="meta">@receiver(<span class="params">signal=post_save, sender=Resume, dispatch_uid=<span class="string">&quot;resume_post_save_dispatcher&quot;</span></span>)</span></span><br><span class="line"><span class="meta">@receiver(<span class="params">signal=post_save, sender=Job, dispatch_uid=<span class="string">&quot;job_post_save_dispatcher&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_save_callback</span>(<span class="params">sender, instance=<span class="literal">None</span>, created=<span class="literal">False</span>, **kwarg</span>):</span><br><span class="line">    message = <span class="string">&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(instance, Job):</span><br><span class="line">        message = <span class="string">&quot;Job for %s has been saved&quot;</span> % instance.job_name</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        message = <span class="string">&quot;Resume for %s %s has been saved &quot;</span> % (instance.username , instance.apply_position)</span><br><span class="line">    </span><br><span class="line">    logger.info(message)</span><br><span class="line">    send(message)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.forms.models <span class="keyword">import</span> model_to_dict</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">post_delete_callback</span>(<span class="params">sender, instance=<span class="literal">None</span>, using=<span class="literal">None</span>, **kwarg</span>):</span><br><span class="line">    dict_obj = model_to_dict( instance, exclude=(<span class="string">&quot;picture&quot;</span>,<span class="string">&quot;attachment&quot;</span>, <span class="string">&quot;created_date&quot;</span>, <span class="string">&quot;modified_date&quot;</span>) )</span><br><span class="line">    message = <span class="string">&quot;Instance of %s has been deleted: %s&quot;</span> % (<span class="built_in">type</span>(instance), json.dumps(dict_obj, ensure_ascii=<span class="literal">False</span>))</span><br><span class="line">    logger.info(message)</span><br><span class="line">    send(message)</span><br><span class="line"></span><br><span class="line"><span class="comment">## 手工注册信号处理器</span></span><br><span class="line">post_delete.connect(post_delete_callback, sender=Resume, dispatch_uid=<span class="string">&quot;resume_post_delete_dispatcher&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>在jobs/apps.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.apps <span class="keyword">import</span> AppConfig</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JobConfig</span>(<span class="title class_ inherited__">AppConfig</span>):</span><br><span class="line">    name = <span class="string">&#x27;jobs&#x27;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">ready</span>(<span class="params">self</span>):</span><br><span class="line">        logger.info(<span class="string">&quot;JobConfig ready&quot;</span>)</span><br><span class="line">        <span class="keyword">from</span> jobs.signal_processor <span class="keyword">import</span> post_save_callback</span><br></pre></td></tr></table></figure>
<p>在settings.py中配置</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    ......</span><br><span class="line">    <span class="comment"># &#x27;jobs&#x27;,  # 应用不能重复注册</span></span><br><span class="line">    <span class="string">&#x27;jobs.apps.JobConfig&#x27;</span>,</span><br><span class="line">    </span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>自定义信号：</p>
<ul>
<li>定义信号： 在项目根目录新建文件self_signal.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> django.dispatch</span><br><span class="line">my_signal = django.dispatch.Signals(providing_args=[<span class="string">&quot;argument1&quot;</span>,<span class="string">&quot;argument2&quot;</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li>触发信号：业务逻辑中触发信息</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> self_signal <span class="keyword">import</span> my_signal</span><br><span class="line">my_signal.send(sender=<span class="string">&quot;Recruitment&quot;</span>, argument1=<span class="number">111</span>, argument2=<span class="number">2</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>注册信号处理器/接收器</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> self_signal <span class="keyword">import</span> my_signal</span><br><span class="line">my_signal.connect(callback_of_my_signal)</span><br></pre></td></tr></table></figure>
<h2 id="优雅的架构设计"><a href="#优雅的架构设计" class="headerlink" title="优雅的架构设计"></a>优雅的架构设计</h2><h3 id="CSR-架构总结-Celery"><a href="#CSR-架构总结-Celery" class="headerlink" title="CSR 架构总结 Celery"></a>CSR 架构总结 Celery</h3><p>Celery架构：</p>
<ul>
<li>解决的问题： 异步任务调度，定时任务调度</li>
</ul>
<p>Celery架构之美：</p>
<ul>
<li>清晰的定义来几个基础概念</li>
<li>API使用起来清晰、简洁</li>
<li>关键设计可以扩展，具备高可用性</li>
<li>定义了一套协议/API，跨平台（Python/Node/PHP 客户端，Python/Go/Rust 服务端）</li>
</ul>
<p>Celery中核心的概念：</p>
<ul>
<li>Task: 一个需要执行的任务，任务通常异步执行</li>
<li>Period Task: 需要定时执行的任务，定时一定间隔执行，也可以使用 crontab 表达式设定执 行周期和时间点</li>
<li>Message Broker: 消息代理，临时存储，传输任务到工作节点的消息队列。可以用 Redis, RabbitMQ, Amazon SQS 作为消息代理。消息代理可以有多个，以保障系统的高可用</li>
<li>Worker：工作节点，执行任务的进程，worker可以有多个，保障系统的高可用和扩展性</li>
<li>Result Store: 结果存储</li>
<li>Scheduler/Beat： 调度器进程, Beat是定时任务调度器</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210153601.png" alt=""></p>
<p>Celery 的跨平台 - 不同语言的客户端/服务器端实现：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210153842.png" alt=""></p>
<p>Celery 的高可用架构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210153909.png" alt=""></p>
<h3 id="CSR-架构总结-Sentry"><a href="#CSR-架构总结-Sentry" class="headerlink" title="CSR 架构总结 Sentry"></a>CSR 架构总结 Sentry</h3><p>解决的问题： 应用的错误，异常监控统计，报警通知；性能监控统计，对问题进行跟踪</p>
<p>Sentry架构之美：</p>
<ul>
<li>API 简单、易用，自动集成；安装简单：架构依赖多，但使用 Docker 可以一个命令安装</li>
<li>自动对错误，异常进行统计聚合，按照上下文的Tag进行聚合</li>
<li>可以对性能进行统计分析，可抽样;可视化的趋势分析</li>
<li>多租户，支持双因素认证，敏感内容自动脱敏</li>
<li>开放的架构：可与 AD 域账号集成，与 Google/Stackoverflow 等账号集成</li>
<li>开放的架构：有完善的插件支持：Webhook/Gitlab/Jira/Slack/PushOver/….</li>
<li>支持不同环境（开发、测试、预发、线上）；可以配置灵活的告警</li>
<li>跨平台，跨端的支持</li>
</ul>
<p>Sentry中的概念</p>
<ul>
<li>Symbolicator: 用来解析函数名，堆栈中的文件位置，代码上下文</li>
<li>Relay: 用来处理收到的请求，会立刻返回200或者429， 然后把事件放在内存中排队， 然后发到 Kafka ingest-events</li>
<li>ingest-consumer: 消费处理 Relay 发出的消息</li>
<li>process_event: 堆栈处理，插件预处理</li>
<li>postgresql: 用来保存完整的事件数据</li>
<li>Snuba： 事件数据的存储和查询服务</li>
<li>clickhouse: 用作数据仓库，用于 OLAP，搜索，聚合，标签统计</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210154821.png" alt=""></p>
<p>应用这边发送Crash的日志或者异常日志，发送到服务器端的web容器，发送到Nginx的网关，Nginx收到请求之后，发送到Sentry中的relay。relay是一个中继，会处理收到的请求，收到之后会立刻返回200或者429。relay会把事件放在内存队列中，发送到Kafka的ingest-events里面去。然后在Sentry的ingest-consumer那边会去消费中继发送过来的消息，进一步到后面去处理。后面的处理是由Celery的Task去处理的。Celery Task去取到消息之后做预处理，之后会去调用符号服务，符号服务是一个symbolicate，它可以解析我们代码里面的函数名、类名、包括堆栈里面的文件信息、每一行代码跟文件之间的关系和代码的上下文。解析完成之后再去处理这个事件，处理事件的时候，插件的预处理都会在这里去处理掉，process_event环节都会在这里运行，处理完了会保存事件。然后接下来的话，Celery的task任务会把事件发送到Snuba的Kafka的消息流里面去。snuba有一个消费端，会读取Kafka的消息，然后把这个数据存储到clickhouse，clickhouse用作数据仓库，用于做OLAP的分析，做数据的搜索聚合标签的统计。，包括我们按照不同的状态、Tag去查询数据都是走clickhouse。像这种错误信息收集，然后Crash信息收集的数据量很大的情况，我们用PostgreSQL不是太适合，特别是像跟着日志一起的相关的上下文的信息，这种数据在关系型数据库里面查询起来会相当慢。</p>
<p>Snuba是事件数据的一个查询跟存储服务，它的作用是为了隐藏Clickhouse对于上面应用层的一个复杂度，对clickhouse做了一个封装。</p>
<p>Sentry整体的架构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210160641.png" alt=""></p>
<p>在Sentry的核心架构里面，有几个重要的概念，包括Relay消息处理的中继。Ingest Kafka就是最前端接受消息的Kafka队列，Ingest consumer前端消息的消费者，然后Celery的这些task会去处理每一个消息，做这个符号解析，最后把数据保存到PostgreSQL之后，再把数据发一份到Snuba那边，产生Snuba Kafka消息，然后Snuba的消费者去一条一条消息消费，完了之后把完整的数据丢到clickhouse，同时也会去做一个事件的post_process，它里面回去遍历所有的插件，使用每一个插件对数据进行一个后处理。</p>
<p>Snuba的作用：</p>
<ul>
<li>用作搜索、图计算、规则处理查询的一个服务</li>
<li>这个服务实际上对clickhouse做了一个抽象跟隔离</li>
<li>Snuba有两个部分组成的服务<ul>
<li>一个是Reading的服务，通过clickhouse的查询语法去clickhouse查询，做分析，做聚合统计</li>
<li>一个是Writing的服务，首先是接收到Kafka的消息，然后把数据写到clickhouse里面去</li>
</ul>
</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210162636.png" alt=""></p>
<h3 id="Rest-framework总结"><a href="#Rest-framework总结" class="headerlink" title="Rest framework总结"></a>Rest framework总结</h3><p>解决的问题： 为应用提供Restful API</p>
<p>DRF 架构之美：</p>
<ul>
<li>简单易用，既可以使用自动的 CRUD API，也可以自定义实现API</li>
<li>提供可浏览的 HTML API; 一套实现同时提供 HTML/JSON/XML 展现</li>
<li>灵活的用户认证，支持 Token/OAuth/OAuth2/JWT 等认证方式</li>
<li>提供流量控制，结果过滤筛选，分页，API 版本控制能力</li>
<li>灵活的权限控制：登陆用户，管理员，Django内置权限，只读权限，匿名用户</li>
</ul>
<p>简单定义一个model的API</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">UserSerializer</span>(serializers.HyperlinkedModelSerializer):</span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Meta</span>:</span><br><span class="line">        model = User</span><br><span class="line">        fields = [<span class="string">&#x27;url&#x27;</span>, <span class="string">&#x27;username&#x27;</span>, <span class="string">&#x27;email&#x27;</span>, <span class="string">&#x27;is_staff&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">UserViewSet</span>(viewsets.ModelViewSet):</span><br><span class="line">    queryset = User.objects.<span class="built_in">all</span>()</span><br><span class="line">    serializer_class = UserSerializer</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210163409.png" alt=""></p>
<p>整体架构：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210163503.png" alt=""></p>
<h2 id="Django常用的插件"><a href="#Django常用的插件" class="headerlink" title="Django常用的插件"></a>Django常用的插件</h2><ul>
<li>Django debug toolbar : 提供一个可以查看debug 信息的面板（包括SQL执行时间，页面耗时），开发环境可以使用，但线上环境不能使用</li>
<li>django-silk ：性能瓶颈分析，可以查看SQL执行的时间</li>
<li>Simple UI：基于Element UI 和 VUE 的 Django Admin 主题</li>
<li>Haystack Django ：模块化搜索方案</li>
<li>Django notifications： 发送消息通知，你有 xx 条未处理简历</li>
<li>Django markdown editor ：Markdown 编辑器</li>
<li>django-crispy-forms : Crispy 表单，以一种非常优雅、干净的方式来创建美观的表单</li>
<li>django-simple-captcha：Django表单验证码</li>
</ul>
<h3 id="Django-debug-toolbar"><a href="#Django-debug-toolbar" class="headerlink" title="Django_debug_toolbar"></a>Django_debug_toolbar</h3><p>文档：<a target="_blank" rel="noopener" href="https://django-debug-toolbar.readthedocs.io/en/latest/">https://django-debug-toolbar.readthedocs.io/en/latest/</a></p>
<p>安装：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install django-debug-toolbar</span><br></pre></td></tr></table></figure>
<p>注册到app：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="string">&#x27;django.contrib.staticfiles&#x27;</span>,</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="string">&#x27;debug_toolbar&#x27;</span>,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">STATIC_URL = <span class="string">&#x27;/static/&#x27;</span></span><br></pre></td></tr></table></figure>
<p>url：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> debug_toolbar</span><br><span class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> include, path</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    path(<span class="string">&#x27;__debug__/&#x27;</span>, include(debug_toolbar.urls)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>启用middleware</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="string">&#x27;debug_toolbar.middleware.DebugToolbarMiddleware&#x27;</span>,</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>页面右侧就会有相关信息</p>
<h3 id="Simple-UI"><a href="#Simple-UI" class="headerlink" title="Simple UI"></a>Simple UI</h3><p>文档：<a target="_blank" rel="noopener" href="https://simpleui.72wo.com/docs/simpleui/quick.html">https://simpleui.72wo.com/docs/simpleui/quick.html</a></p>
<p>安装：pip install django-simpleui</p>
<p>注册app：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="string">&#x27;simpleui&#x27;</span>,</span><br><span class="line"> 	......</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210165612.png" alt=""></p>
<h3 id="Django模块化搜索Haystack"><a href="#Django模块化搜索Haystack" class="headerlink" title="Django模块化搜索Haystack"></a>Django模块化搜索Haystack</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210192703.png" alt=""></p>
<ul>
<li>安装Package: pip install django-haystack</li>
<li>把 Haystack 添加到 settings 中</li>
<li>配置 HAYSTACK_CONNECTIONS， 指定使用哪种搜索引擎 （Solr, ES, Whoosh, Xapian）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line">HAYSTACK_CONNECTIONS = &#123;</span><br><span class="line">    <span class="string">&#x27;default&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;ENGINE&#x27;</span>: <span class="string">&#x27;haystack.backends.whoosh_backend.WhooshEngine&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;PATH&#x27;</span>: os.path.join(os.path.dirname(__file__), <span class="string">&#x27;whoosh_index&#x27;</span>),</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>创建 SearchIndex 来指定 model 的索引策略<ul>
<li>每一个 model 创建一个 SearchIndex : indexes.SearchIndex, indexes.Indexable</li>
</ul>
</li>
<li>设置搜索的 页面 View 和 URL</li>
<li>创建索引，通常设置定时任务来创建全量索引，动态索引</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py rebuild_index</span><br><span class="line">python manage.py update_index</span><br></pre></td></tr></table></figure>
<h1 id="生产环境部署和应用监控告警"><a href="#生产环境部署和应用监控告警" class="headerlink" title="生产环境部署和应用监控告警"></a>生产环境部署和应用监控告警</h1><p>生产环境部署之前：</p>
<ul>
<li>单元测试：版本质量评估</li>
<li>生产环境 Django 配置</li>
</ul>
<h2 id="单元测试"><a href="#单元测试" class="headerlink" title="单元测试"></a>单元测试</h2><p>测试用例基类层次：</p>
<ul>
<li>SimplTestCase:  继承自python的 TestCase基类，可以发起 HTTP 请求，跟页面， 模板，URL 交互，禁止了数据库的访问</li>
<li>TransactionTestCase：在用例运行之后，清理 所有表来重置数据库; 可以运行提交、回滚 来观 察中间状态（需要测试事务时使用）</li>
<li>TestCase: 测试用例执行完后不清理表数据； 在 一个事务中执行用例，最后自动回滚事务</li>
<li>LiveServerTestCase: 在后台自动启动一个 Server，以便使用外部工具如 Selenium 做测试 </li>
</ul>
<h3 id="一个简单的测试用例："><a href="#一个简单的测试用例：" class="headerlink" title="一个简单的测试用例："></a>一个简单的测试用例：</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTestCase</span>(<span class="title class_ inherited__">TestCase</span>):</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUpTestData</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="built_in">super</span>().setUpTestData()</span><br><span class="line">        ....</span><br><span class="line">    </span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">tearDownClass</span>(<span class="params">cls</span>):</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">super</span>().setUpTestData()</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUp</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># setup run before every test method</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">tearDown</span>(<span class="params">self</span>) -&gt; <span class="literal">None</span>:</span><br><span class="line">        <span class="comment"># clean up run after every test method</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_something_that_will_pass</span>(<span class="params">self</span>):</span><br><span class="line">        self.assertFalse(<span class="literal">False</span>)</span><br></pre></td></tr></table></figure>
<h3 id="目录结构组织"><a href="#目录结构组织" class="headerlink" title="目录结构组织"></a>目录结构组织</h3><p>哪些逻辑需要测试</p>
<ul>
<li>Django 自带的代码（框架中实现的）逻辑不需要测试</li>
<li>自己写的代码需要测试，比如自定义的页面的访问，自定义的功能菜单</li>
</ul>
<p>测试用例目录组织：</p>
<ul>
<li>Django 使用 unittest 模块的内置测试查找机制</li>
<li>它将在当前工作目录下， 查找任何匹配模式test*.py 命名的文件作为 Test Case</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210210233.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># jobs/testcase/test_views.py</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> TestCase</span><br><span class="line"><span class="keyword">from</span> django.test <span class="keyword">import</span> Client</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> jobs.models <span class="keyword">import</span> Job, JobTypes, Cities</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">JobTests</span>(<span class="title class_ inherited__">TestCase</span>):</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">setUpTestData</span>(<span class="params">cls</span>):</span><br><span class="line">        <span class="comment"># Set up data for the whole TestCase</span></span><br><span class="line">        <span class="comment"># 使用job的model去创建一个对象</span></span><br><span class="line">        cls.job = Job.objects.create(job_name=<span class="string">&quot;Java开发工程师&quot;</span>, job_type=JobTypes[<span class="number">0</span>][<span class="number">0</span>], job_city=Cities[<span class="number">1</span>][<span class="number">0</span>], job_requirement=<span class="string">&quot;精通Java开发&quot;</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test1</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># Some test using self.job</span></span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line"></span><br><span class="line">	<span class="comment"># 测试职位列表页是否访问正常</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_index</span>(<span class="params">self</span>):</span><br><span class="line">        client = Client()</span><br><span class="line">        response = client.get(<span class="string">&#x27;/joblist/&#x27;</span>)</span><br><span class="line">        self.assertEqual(response.status_code, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">test_detail</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="comment"># 使用 TestCase.self.client 作为 HTTP Client:</span></span><br><span class="line">        response = self.client.get(<span class="string">&#x27;/job/1/&#x27;</span>)</span><br><span class="line">        self.assertEqual(response.status_code, <span class="number">200</span>)</span><br><span class="line"></span><br><span class="line">        job = response.context[<span class="string">&#x27;job&#x27;</span>]</span><br><span class="line">        self.assertEqual(job.job_name, JobTests.job.job_name)</span><br></pre></td></tr></table></figure>
<h3 id="执行测试用例"><a href="#执行测试用例" class="headerlink" title="执行测试用例"></a>执行测试用例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 运行项目下面所有 test</span></span><br><span class="line">python manage.py test</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试指定模块</span></span><br><span class="line">python manage.py test jobs.testcase</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试单个模块中的文件</span></span><br><span class="line">python manage.py test jobs.testcase.test_views</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定类</span></span><br><span class="line">python manage.py test jobs.testcase.test_views.JobTests</span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试指定方法</span></span><br><span class="line">python manage.py test jobs.testcase.test_views.JobTests.test_detail</span><br></pre></td></tr></table></figure>
<h2 id="生产环境的应用部署"><a href="#生产环境的应用部署" class="headerlink" title="生产环境的应用部署"></a>生产环境的应用部署</h2><h3 id="发布到生产环境的步骤"><a href="#发布到生产环境的步骤" class="headerlink" title="发布到生产环境的步骤"></a>发布到生产环境的步骤</h3><ul>
<li>配置生产环境配置 (settings)：DEBUG &amp; Secret 相关信息</li>
<li>选择Django App的托管环境 (IaaS/PaaS，比如 阿里云/AWS/Azure/GAE/Heroku 等等)</li>
<li>部署前的安全检查</li>
<li>选择静态资源文件的托管环境（包括JS/CSS/图片/文件等） &amp; 部署静态资源</li>
<li>部署 Django 应用容器 &amp; Web服务器</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210214941.png" alt=""></p>
<h3 id="配置生产环境配置：让网站准备好发布"><a href="#配置生产环境配置：让网站准备好发布" class="headerlink" title="配置生产环境配置：让网站准备好发布"></a>配置生产环境配置：让网站准备好发布</h3><p>必须调整的关键配置是：</p>
<ul>
<li>DEBUG. 在生产环境中设置为 False（DEBUG = False）。避免在 web 页面上显示敏感的调试 跟踪和变量信息</li>
<li>SECRET_KEY. 这是用于CSRF保护的随机值</li>
<li>ALLOWED_HOSTS, 生产环境必须设置 允许访问的域名</li>
</ul>
<p>生成 SECRET KEY：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;from django.core.management.utils import get_random_secret_key; print(get_random_secret_key())&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="配置生产环境配置：密钥的存储和管理"><a href="#配置生产环境配置：密钥的存储和管理" class="headerlink" title="配置生产环境配置：密钥的存储和管理"></a>配置生产环境配置：密钥的存储和管理</h3><ul>
<li>从环境变量读取配置， 或从配置文件中读取</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line">DEBUG = FALSE</span><br><span class="line">SECRET_KEY = os.environ.get(<span class="string">&#x27;DJANGO_SECRET_KEY&#x27;</span>, <span class="string">&#x27;xxxxx&#x27;</span>)</span><br><span class="line">ALLOWED_HOSTS = [<span class="string">&quot;127.0.0.1&quot;</span>, <span class="string">&quot;setcreed.com&quot;</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>从 KMS 系统中读取配置的密钥<ul>
<li>自己部署的 KMS 系统</li>
<li>云服务的 KMS 服务： 阿里云/AWS 的 KMS 服务</li>
</ul>
</li>
</ul>
<h3 id="部署前的安全检查"><a href="#部署前的安全检查" class="headerlink" title="部署前的安全检查"></a>部署前的安全检查</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py check --deploy</span><br></pre></td></tr></table></figure>
<h3 id="部署到生产环境"><a href="#部署到生产环境" class="headerlink" title="部署到生产环境"></a>部署到生产环境</h3><p>静态资源文件的托管环境</p>
<ul>
<li>静态内容 Web 服务器： Apache/Nginx</li>
<li>CDN 服务器</li>
</ul>
<p>collectstatic 工具：用来收集静态资源文件, settings 中的相关设置:</p>
<ul>
<li>STATIC_URL: 能够访问到静态文件的 URL 路径。</li>
<li>STATIC_ROOT: collectstatic 工具用来保存收集到的项目引用到的任何静态文件的路径</li>
<li>STATICFILES_DIRS: 这列出了 Django 的 collectstatic 工具应该搜索静态文件的其他目</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py collectstatic --settings=settings.local</span><br></pre></td></tr></table></figure>
<p>收集完成后，可以将这些静态文件，上传到托管文件的服务器/CDN</p>
<h3 id="Django-应用容器"><a href="#Django-应用容器" class="headerlink" title="Django 应用容器"></a>Django 应用容器</h3><p>同步应用</p>
<ul>
<li>uWSGI: C 实现的 Python Web 容器；Web 服务器 Apache/Nginx 与 django-uwsgi 进程通信 来提供动态的内容</li>
<li>gunicorn：纯 Python 实现的高性能 Python 应用容器，无外部依赖，简单容易配置； 还没有遇到性能问题的时候，推荐使用 gunicorn.</li>
</ul>
<p>异步应用，django3.0之后才有</p>
<ul>
<li>Daphne: twisted 实现</li>
<li>Hypercorn: 基于 sans-io hyper, h11, h2, wsproto实现</li>
<li>Uvicorn: 基于 uvloop and httptools 实现</li>
</ul>
<p>异步支持 Roadmap:</p>
<ul>
<li>Django 的异步支持 Roadmap<ul>
<li>Django 3.0 - ASGI Server</li>
<li>Django 3.1 - Async Views </li>
<li>Django 3.2/4.0 - Async ORM</li>
</ul>
</li>
<li>异步视图</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">async</span> <span class="keyword">def</span> <span class="title function_">view</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">await</span> asyncio.sleep(<span class="number">0.5</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">&quot;hello, async&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>启动服务器:</p>
<p>同步应用服务器，以 gunicorn 为例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install gunicorn</span><br><span class="line"><span class="built_in">export</span> DJANGO_SETTINGS_MODULE=settings.local</span><br><span class="line">gunicorn -w 3 -b 127.0.0.1:8000 recruitment.wsgi:application</span><br><span class="line"></span><br><span class="line"><span class="comment"># 以上启动 3 个 worker进程, 绑定到 本机的8000端口</span></span><br></pre></td></tr></table></figure>
<p>异步应用服务器，以uvcorn 为例:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install uvicorn</span><br><span class="line"><span class="built_in">export</span> DJANGO_SETTINGS_MODULE=settings.local</span><br><span class="line">uvicorn recruitment.asgi:application --workers 3</span><br></pre></td></tr></table></figure>
<h2 id="应用水平扩展：使用负载均衡"><a href="#应用水平扩展：使用负载均衡" class="headerlink" title="应用水平扩展：使用负载均衡"></a>应用水平扩展：使用负载均衡</h2><h3 id="安装配置Tenine"><a href="#安装配置Tenine" class="headerlink" title="安装配置Tenine"></a>安装配置Tenine</h3><p>使用Tengine，<a target="_blank" rel="noopener" href="https://tengine.taobao.org/">https://tengine.taobao.org/</a></p>
<ul>
<li>Tengine完全兼容Nginx, 同时提供了额外的强大功能</li>
<li>增强相关运维、监控能力,比如异步打印日志及回滚,本地DNS缓存,内存监控等</li>
<li>动态脚本语言Lua支持。扩展功能简单高效</li>
<li>更加强大的负载均衡能力，包括一致性hash模块、会话保持模块</li>
<li>主动健康检查，根据服务器状态自动上线下线，以及动态解析upstream中出现的域名</li>
<li>输入过滤器机制支持，更强大的防攻击（访问速度限制）模块；方便实现应用防火墙</li>
</ul>
<p>安装 Tengine:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装依赖 pcre</span></span><br><span class="line">wget https://ftp.pcre.org/pub/pcre/pcre-8.44.tar.gz</span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/pcre &amp;&amp; make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定pcre源码目录安装tengine</span></span><br><span class="line">wget https://tengine.taobao.org/download/tengine-2.3.2.tar.gz</span><br><span class="line"></span><br><span class="line">tar zxvf tengine-2.3.2.tar.gz &amp;&amp; <span class="built_in">cd</span> /data/tengine-2.3.0</span><br><span class="line"></span><br><span class="line">./configure --prefix=/data/tengine/ --with-http_realip_module --</span><br><span class="line">with-http_gzip_static_module --with-pcre=/data/pcre-8.44</span><br><span class="line"></span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>简单配置：路由转发请求到 Gunicorn/uWSGI 服务</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> recruit.setcreed.com;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">localtion</span> / &#123;</span><br><span class="line">        <span class="comment"># 转发请求到gunicorn进程</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://127.0.0.1:8000;</span><br><span class="line">        </span><br><span class="line">        <span class="attribute">proxy_set_header</span>	Host</span><br><span class="line">        proxy_set_header	X-Real-IP</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 包含了 客户端的地址，以及各级代理IP 完整的 IP链</span></span><br><span class="line">        proxy_set_header	X-Forwarded-For	<span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用Tengine/Nginx 负载均衡</p>
<p>相关的配置：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /data/tengine/conf.d/recruitment.conf</span></span><br><span class="line"></span><br><span class="line"><span class="section">upstream</span> django-server &#123;</span><br><span class="line">    <span class="comment"># max_fails = 3 为允许失败的次数，默认为1.对后端节点做健康检查</span></span><br><span class="line">    <span class="comment"># 20s内，当max_fails失败后，暂停将请求分发到该服务器</span></span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.100:8001</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">20s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.100:8002</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">20s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.101:8001</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">20s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.101:8002</span> max_fails=<span class="number">3</span> fail_timeout=<span class="number">20s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>	<span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>	www.mysite.com;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">access_log</span>	/data/tengine/logs/recruitment-access.log	main;</span><br><span class="line">    <span class="attribute">error_log</span>	/data/tengine/logs/recruitment-<span class="literal">error</span>.log;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://django-server;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>	Host	<span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>	X-Real-IP	<span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>	REMOTE-HOST	<span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>	X-Forwarder-For	<span class="variable">$proxy_add_x_forwarder_for</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Tengine-的分流策略"><a href="#Tengine-的分流策略" class="headerlink" title="Tengine 的分流策略"></a>Tengine 的分流策略</h3><p>负载分流策略：</p>
<ul>
<li>round-robin — 平均分配流量：轮询模式</li>
<li>least-connected — 最少连接优先，下一个请求分到活跃连接最少的服务器 </li>
<li>ip-hash — 按照客户端 IP 哈希来分配服务器 IP</li>
<li>带权重流量分配</li>
<li>一致性哈希 （Tengine）</li>
<li>会话保持 （Tengine 特性）</li>
</ul>
<p>最少连接优先：</p>
<ul>
<li>前面配置的为平均分配流量</li>
<li>按照最少连接优先/ip hash 的配置：</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> django-<span class="section">upstream</span> &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.100:8001</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.100:8002</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.101:8001</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.101:8002</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>按权重分配：</p>
<ul>
<li>按照权重分配（适合机器配置不一样时）</li>
<li>6个请求里面，3个走到第一台，其它3台没台1个请求</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> django-<span class="section">upstream</span> &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.100:8001</span> weight=<span class="number">3</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.100:8002</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.101:8001</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.101:8002</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>会话保持：</p>
<ul>
<li>尽可能保证同一个客户端访问的都是同一个后端服务器</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认配置：cookie=route mode=insert fallback=on</span></span><br><span class="line"><span class="section">upstream</span> django-<span class="section">upstream</span> &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.100</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.101</span>;</span><br><span class="line">    session_sticky;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://django-upstream;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="健康检查自动容错"><a href="#健康检查自动容错" class="headerlink" title="健康检查自动容错"></a>健康检查自动容错</h3><p>被动健康检查: ngx_http_upstream_module 实现了被动的健康检查功能</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 被动健康检查</span></span><br><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8080</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">20s</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">127.0.0.1:8081</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">20s</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>	www.mysite.com;</span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span>	http://backend;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>主动健康检查： http_upstream_check_module，主动定时检查:</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主动健康检查</span></span><br><span class="line"><span class="section">upstream</span> django-<span class="section">upstream</span> &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.100</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.101</span>;</span><br><span class="line">    <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">3</span> timeout=<span class="number">1000</span> type=http;</span><br><span class="line">    <span class="attribute">check_http_send</span> <span class="string">&quot;HEAD /HTTP/1.0\r\n\r\n&quot;</span>;</span><br><span class="line">    <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>上面的参数含义</p>
<ul>
<li>interval: 向后端发送的健康检查包的间隔</li>
<li>fall(fall_count)：如果连续失败次数达到fall_count，服务就被认为是down</li>
<li>rise(rise_count)：如果连续成功次数达到rise_count，服务就被认为是up</li>
<li>timeout：后端健康请求的超时时间</li>
</ul>
<p>上面配置的意思：对django-upstream的所有节点，每隔3秒检测一次，请求2次正常则标记 realserver状态为up，如果检测3次都失败，则标记realserver的状态为down，超时时间为1秒。</p>
<h2 id="使用CDN加速"><a href="#使用CDN加速" class="headerlink" title="使用CDN加速"></a>使用CDN加速</h2><p>为什么要使用 CDN：</p>
<ul>
<li>页面卡顿</li>
<li>高并发情况下服务器压力大</li>
</ul>
<p>CDN 访问的两阶段：</p>
<ul>
<li>域名解析</li>
<li>内容请求</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210210225737.png" alt=""></p>
<p>当用户发起URL请求时，第一阶段会做域名解析，通常会在服务器上配置一个域名，静态资源对应的域名的一个cname，cname指向另外一个不同的域名，这个域名是由CDN提供的。当CDN服务器解析收到域名请求的时候，它会根据用户的IP地址去判断用户的IP在哪个区域，然后去找到跟用户所在IP最近的一台CDN节点的IP地址，作为解析得到的域名的地址，然后把域名对应的IP地址返回给用户；然后第二阶段再去发起HTTP请求，这个时候就近的CDN节点会收到它的请求，会去取内容，要么从它的缓存里面取内容返回，要么去从原始的内容原站取到内容最后返回给用户。取到内容之后，CDN会做缓存，而且缓存时间比较长。手工清除缓存可能会导致不同节点不一致的问题，一般使用版本控制的策略，每一次资源有更新的时候，去使用不同的版本。</p>
<p>加速静态资源访问的两种方法：</p>
<ul>
<li>使用云端的静态资源 （能够解决国外网站访问慢的问题）</li>
<li>使用 CDN 加速</li>
</ul>
<p>例：使用阿里云的 OSS 存储静态资源文件， Django 会自动替换所有静态资源文件的路径为 OSS 文件的路径，并且对 URL 添加鉴权参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings里面添加OSS</span></span><br><span class="line">STATIC_ROOT = ‘static<span class="string">&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">STATICFILES_STORAGE = &#x27;</span>django_oss_storage.backends.OssStaticStorage<span class="string">&#x27;</span></span><br></pre></td></tr></table></figure>
<p>使用 CDN 的两种方式:</p>
<ul>
<li>手工上传静态资源文件到 CDN</li>
<li>通过 Tengine 把本机的静态资源开放到 Web上， CDN自动回流到 Tengine</li>
</ul>
<p>以手工上传静态资源文件为例，Django 启用 CDN 静态资源加速的步骤</p>
<ul>
<li>生成静态资源文件， 上传静态资源到 OSS</li>
<li>配置 CDN 域名，回源地址指向 OSS Bucket， 配置 Referer 防盗链的白名单</li>
<li>配置 OSS Bucket 匿名可以读</li>
<li>设置 STATIC_URL，直接指向 CDN 地址，同时注释掉 OssStaticStorage 避免冲突</li>
</ul>
<p>启用 CDN 加速静态资源文件:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings.py</span></span><br><span class="line">STATIC_URL = <span class="string">&#x27;http://icdn.setcreed.com/static/&#x27;</span></span><br></pre></td></tr></table></figure>
<h2 id="接入监控告警"><a href="#接入监控告警" class="headerlink" title="接入监控告警"></a>接入监控告警</h2><ul>
<li>Sentry 错误监控 与告警</li>
<li>告警趋势可视化: Prometheus &amp; Grafana 概念介绍</li>
<li>告警趋势可视化: Prometheus &amp; Grafana 架构</li>
<li>Prometheus &amp; Grafana 接入</li>
<li>配置 Grafana 大盘</li>
</ul>
<p>Prometheus &amp; Grafana 概念介绍：</p>
<p>Prometheus 数据类型：</p>
<ul>
<li>Counter：计数器，总是增长的整数值；请求数，订单量，错误数等</li>
<li>Gauge：可以上下波动的计量值，比如温度，内存使用量，处理中的请求；</li>
<li>Summary：提供观测样本的摘要，包含样本数量，样本值的和； 滑动窗口计算:请求耗时，响应数据大小</li>
<li>Histogram：把观测值放到配置好的桶中做统计，请求耗时，响应数据大小等</li>
</ul>
<p>Prometheus &amp; Grafana 架构：</p>
<ul>
<li>Prometheus服务： 采集和存储时序数据</li>
<li>客户端类库： 用作注入应用端代码</li>
<li>Push gateway： 用于采集朝生暮死的作业数据</li>
<li>特殊用途的Exporter Service： 如Nginx/HAProxy/StatsD等</li>
<li>Alertmanager：处理告警</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211072722.png" alt=""></p>
<p>Prometheus 与 Grafana 的调用关系：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211072815.png" alt=""></p>
<p>Prometheus &amp; Grafana 接入：</p>
<ul>
<li>安装 Prometheus &amp; Grafana</li>
<li>启动 Prometheus &amp; Grafana</li>
<li>接入Django: Prometheus 插件集成 <a target="_blank" rel="noopener" href="https://github.com/korfuri/django-prometheus">https://github.com/korfuri/django-prometheus</a></li>
<li>Promethues 配置 Django 应用的Endpoint</li>
<li>Grafana 中配置应用的监控图</li>
</ul>
<p>配置 Grafana 大盘：</p>
<p>下载 Dashbaord 的Json ，导入到 Grafana 中：<a target="_blank" rel="noopener" href="https://grafana.com/grafana/dashboards/9528">https://grafana.com/grafana/dashboards/9528</a></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211072950.png" alt=""></p>
<h1 id="生产环境中的安全"><a href="#生产环境中的安全" class="headerlink" title="生产环境中的安全"></a>生产环境中的安全</h1><h2 id="生产环境的安全设计"><a href="#生产环境的安全设计" class="headerlink" title="生产环境的安全设计"></a>生产环境的安全设计</h2><p>生产环境安全要考虑的因素：</p>
<ul>
<li>防火墙：把攻击挡在外面，建立安全区</li>
<li>应用安全：密码攻击 &amp; 访问限流 – 防恶意攻击</li>
<li>架构安全：部署架构的安全性，应用架构安全设计</li>
<li>数据安全：SSL，敏感数据加密 与 日志脱敏</li>
<li>密码安全与业务安全：权限控制 &amp; 密码安全策略</li>
</ul>
<p>防火墙的作用：建立安全区，把攻击挡在外面</p>
<p>防火墙的类别：</p>
<ul>
<li>硬件防火墙</li>
<li>WAF防火墙</li>
<li>操作系统防火墙</li>
</ul>
<h3 id="WAF-防火墙"><a href="#WAF-防火墙" class="headerlink" title="WAF 防火墙"></a>WAF 防火墙</h3><ul>
<li>WAF: Web application firewall，基于预先定义的规则， 如预先定义的正则表 达式的黑名单，不安全URL 请求等</li>
<li>防止 SQL 注入，XSS， SSRF等web攻击</li>
<li>防止CC攻击 屏蔽常见的扫描黑客工具，扫描器</li>
<li>屏蔽异常的网络请求 屏蔽图片附件类目录php执行权限</li>
<li>防止 web shell 上传</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211082423.png" alt=""></p>
<h3 id="系统防火墙"><a href="#系统防火墙" class="headerlink" title="系统防火墙"></a>系统防火墙</h3><p>常用的 Linux 系统防火墙</p>
<ul>
<li>iptables: Linux原始自带的防火墙工具iptables</li>
<li>ufw: Ubuntu的防火墙工具ufw. uncomplicated firewall 的简称，简单防火墙</li>
<li>firewalld: CentOS的防火墙工具firewalld</li>
</ul>
<p>Ubuntu 的 ufw：</p>
<ul>
<li>Linux原始的防火墙工具 iptables 过于繁琐</li>
<li>Ubuntu 提供了基于iptables 之上的防火墙 ufw</li>
<li>ufw 支持图形界面操作</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211083318.png" alt=""></p>
<p>规则：</p>
<ul>
<li>开启 ufw 后，默认是允许所有连接通讯</li>
<li>且配置的策略也有先后顺序，每一条策略都有序号</li>
<li>服务器上配置，建议先 deny from any，再放开需要开放的访问</li>
</ul>
<h2 id="应用安全"><a href="#应用安全" class="headerlink" title="应用安全"></a>应用安全</h2><ul>
<li>防恶意密码攻击</li>
<li>应用访问限流</li>
</ul>
<p>防恶意密码攻击策略：</p>
<ul>
<li>在用户连续登陆 n 次失败后， 要求输入验证码登陆</li>
</ul>
<p>可选方案：使用 simple captcha 插件：<a target="_blank" rel="noopener" href="https://django-simple-captcha.readthedocs.io/en/latest/usage.html">https://django-simple-captcha.readthedocs.io/en/latest/usage.html</a></p>
<h3 id="防恶意密码攻击"><a href="#防恶意密码攻击" class="headerlink" title="防恶意密码攻击"></a>防恶意密码攻击</h3><ul>
<li>安装 &amp; 配置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pip install django-simple-captcha</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注册到app</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># captcha 加到 settings/base.py 中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># url.py 中添加路径映射</span></span><br><span class="line">path(<span class="string">&#x27;captcha/&#x27;</span>, include(<span class="string">&#x27;captcha.urls&#x27;</span>)),</span><br><span class="line"><span class="comment"># 假设 clogin的页面来让用户登录</span></span><br><span class="line">path(<span class="string">&quot;clogin/&quot;</span>, views.login_with_captcha, name=<span class="string">&quot;clogin&quot;</span>),</span><br></pre></td></tr></table></figure>
<ul>
<li>添加 登陆验证 Form 和 Views 视图</li>
<li>添加登陆 模板页</li>
<li>添加登陆失败的频次控制</li>
<li>设置管理员的登陆页， 默认使用带连续失败需要验证码的页面</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在view视图上加一个登录的逻辑</span></span><br><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> authenticate, login</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth.forms <span class="keyword">import</span> AuthenticationForm</span><br><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> messages</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> captcha.fields <span class="keyword">import</span> CaptchaField <span class="comment"># 导入模块</span></span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.http.response <span class="keyword">import</span> HttpResponseRedirect</span><br><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> reverse_lazy</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"></span><br><span class="line">logger = logging.getLogger(__name__)</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CaptchaLoginForm</span>(<span class="title class_ inherited__">AuthenticationForm</span>):</span><br><span class="line">    <span class="comment"># username = forms.CharField(label=&#x27;用户名&#x27;)</span></span><br><span class="line">    <span class="comment"># password = forms.CharField(widget=forms.PasswordInput, label=&#x27;密码&#x27;)</span></span><br><span class="line">    captcha = CaptchaField(label=<span class="string">&#x27;验证码&#x27;</span>)</span><br><span class="line"></span><br><span class="line">max_failed_login_count = <span class="number">3</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login_with_captcha</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">if</span> request.POST:</span><br><span class="line">        failed_login_count = request.session.get(<span class="string">&#x27;failed_login_count&#x27;</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 没有连续的登陆失败， 使用默认的登陆页； 连续 n 次登陆失败， 要求输入验证码</span></span><br><span class="line">        <span class="keyword">if</span> failed_login_count &gt;= max_failed_login_count :</span><br><span class="line">            form = CaptchaLoginForm(data=request.POST)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            form = AuthenticationForm(data=request.POST)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Validate the form: the captcha field will automatically</span></span><br><span class="line">        <span class="comment"># check the input</span></span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            request.session[<span class="string">&#x27;failed_login_count&#x27;</span>] = <span class="number">0</span></span><br><span class="line">            <span class="comment"># authenticate user with credentials</span></span><br><span class="line">            user = authenticate(username=form.cleaned_data[<span class="string">&quot;username&quot;</span>], password=form.cleaned_data[<span class="string">&quot;password&quot;</span>])</span><br><span class="line">            <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="literal">None</span>:</span><br><span class="line">                <span class="comment"># attach the authenticated user to the current session</span></span><br><span class="line">               login(request,user)</span><br><span class="line">               <span class="keyword">return</span> HttpResponseRedirect(reverse_lazy(<span class="string">&#x27;admin:index&#x27;</span>))</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            failed_login_count += <span class="number">1</span></span><br><span class="line">            request.session[<span class="string">&#x27;failed_login_count&#x27;</span>] = failed_login_count</span><br><span class="line">            logger.warning(<span class="string">&quot; ----- failed login for user: %s, failed times:%s&quot;</span> %  (form.data[<span class="string">&quot;username&quot;</span>], failed_login_count) )</span><br><span class="line">            <span class="keyword">if</span> failed_login_count &gt;= max_failed_login_count :</span><br><span class="line">                form = CaptchaLoginForm(request.POST)</span><br><span class="line">            messages.add_message(request, messages.INFO, <span class="string">&#x27;Not a valid request&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment">## 没有连续的登陆失败， 使用默认的登陆页； 连续 n 次登陆失败， 要求输入验证码</span></span><br><span class="line">        failed_login_count = request.session.get(<span class="string">&#x27;failed_login_count&#x27;</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> failed_login_count &gt;= max_failed_login_count :</span><br><span class="line">            form = CaptchaLoginForm(request.POST)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            form = AuthenticationForm()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">&#x27;login.html&#x27;</span>, &#123;<span class="string">&#x27;form&#x27;</span>: form&#125;)</span><br></pre></td></tr></table></figure>
<p>项目主应用下的templates/login.html</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends &#x27;base.html&#x27; %&#125;</span><br><span class="line"></span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">method</span>=<span class="string">&quot;post&quot;</span> <span class="attr">style</span>=<span class="string">&quot;margin-left: 10px;&quot;</span>&gt;</span></span><br><span class="line">  &#123;% csrf_token %&#125;</span><br><span class="line">  &#123;&#123; form.as_p &#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;form-actions&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;submit&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:120px;&quot;</span> <span class="attr">value</span>=<span class="string">&quot;Login&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;% endblock %&#125;</span><br></pre></td></tr></table></figure>
<h3 id="访问限流-–-防恶意攻击"><a href="#访问限流-–-防恶意攻击" class="headerlink" title="访问限流 – 防恶意攻击:"></a>访问限流 – 防恶意攻击:</h3><ul>
<li>Rest Framework API 限流</li>
<li>应用限流: 对页面的访问频次进行限流</li>
</ul>
<p>Rest API 限流</p>
<ul>
<li>可以对匿名用户，具名用户进行限流</li>
<li>可以设置峰值流量（如每分钟60次请求）</li>
<li>也可以设置连续一段时间的流量限制（比如每天3000次）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="string">&#x27;example.throttles.BurstRateThrottle&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;example.throttles.SustainedRateThrottle&#x27;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&#x27;DEFAULT_THROTTLE_RATES&#x27;</span>: &#123;</span><br><span class="line">        <span class="string">&#x27;burst&#x27;</span>: <span class="string">&#x27;60/min&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;sustained&#x27;</span>: <span class="string">&#x27;3000/day&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对页面的访问频次进行限流:</p>
<p>示例策略： 一分钟最多请求5次登陆页，防止暴力攻击登陆页</p>
<p>可以选方案： 使用 django-ratelimit 插件，<a target="_blank" rel="noopener" href="https://django-ratelimit.readthedocs.io/en/stable/index.html">https://django-ratelimit.readthedocs.io/en/stable/index.html</a></p>
<p>例如在对验证码登录的方法进行限流，每分钟最多可以访问5次：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ratelimit.decorators <span class="keyword">import</span> ratelimit</span><br><span class="line"></span><br><span class="line"><span class="meta">@ratelimit(<span class="params">key=<span class="string">&#x27;ip&#x27;</span>, rate=<span class="string">&#x27;5/m&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">login_with_captcha</span>(<span class="params">request</span>):</span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<h2 id="架构安全"><a href="#架构安全" class="headerlink" title="架构安全"></a>架构安全</h2><ul>
<li>防火墙</li>
<li>XSS攻击的中间件</li>
<li>CSRF攻击的中间件</li>
<li>SQL注入的中间件</li>
<li>应用的部署架构</li>
<li>密钥存储原则</li>
</ul>
<h3 id="应用的部署架构"><a href="#应用的部署架构" class="headerlink" title="应用的部署架构"></a>应用的部署架构</h3><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211140118.png" alt=""></p>
<ul>
<li>这是典型中小型互联网应用部署架构</li>
<li>服务器内部组成私有网络</li>
</ul>
<h3 id="密钥存储"><a href="#密钥存储" class="headerlink" title="密钥存储"></a>密钥存储</h3><p>密钥信息的存储原则：</p>
<ul>
<li>基础的用法： 使用环境变量/独立的配置文件， 不放在代码库中</li>
<li>使用 Key Server：使用开源的 Key Server， 或 阿里云/AWS 的 KMS 服务</li>
</ul>
<p>从独立的配置文件中读取配置密钥</p>
<ul>
<li>从独立的配置文件中读取配置密钥</li>
<li>容器环境，启动容器时作为环境变量传入 – 密钥不落地到容器存储中</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># read secret key from a file</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(<span class="string">&#x27;/etc/secret_key.txt&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    SECRET_KEY = f.read().strip()</span><br></pre></td></tr></table></figure>
<p>使用 Key Server:</p>
<ul>
<li>vault <a target="_blank" rel="noopener" href="https://github.com/hashicorp/vault">https://github.com/hashicorp/vault</a></li>
<li>keywhiz <a target="_blank" rel="noopener" href="https://github.com/square/keywhiz">https://github.com/square/keywhiz</a></li>
<li>knox <a target="_blank" rel="noopener" href="https://github.com/pinterest/knox">https://github.com/pinterest/knox</a></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211144647.png" alt=""></p>
<h2 id="数据安全"><a href="#数据安全" class="headerlink" title="数据安全"></a>数据安全</h2><ul>
<li>SSL 证书的使用</li>
<li>敏感数据加密</li>
<li>日志脱敏</li>
</ul>
<h3 id="Let’s-Encrypt-SSL-证书的使用"><a href="#Let’s-Encrypt-SSL-证书的使用" class="headerlink" title="Let’s Encrypt SSL 证书的使用"></a>Let’s Encrypt SSL 证书的使用</h3><ul>
<li>Let’s Encrypt是一家非盈利机构， 免费提供 SSL 证书。</li>
<li>Let’s encrypt的目标是为了构建一个安全的互联网</li>
<li>Let’s Encrypt的证书被各大主流的浏览器和网络服务商支持</li>
<li>提供的证书90天过期，需要自动重新申请。 有相应的工具可以使用</li>
</ul>
<p>Let’s Encrypt 的两种使用方式：</p>
<ul>
<li>Webroot 方式： certbot 会利用既有的 web server，在其 web root 目录下创 建隐藏文件，Lets Encrypt 服务端会通过域名来访问这些隐藏文件，以确认你的 确拥有对应域名的控制权</li>
<li>Standalone 方式： Certbot 会自己运行一个 web server 来进行验证。如果我 们自己的服务器上已经有 web server 正在运行 （比如 Nginx 或 Apache ）， 用 standalone 方式的话需要先关掉它，以免冲突</li>
</ul>
<p>安装使用：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Debian 上面安装 certbot 工具</span></span><br><span class="line">sudo apt install snapd</span><br><span class="line">sudo snap install core</span><br><span class="line"></span><br><span class="line">sudo snap install --classic cerbot</span><br><span class="line">sudo <span class="built_in">ln</span> -s /snap/bin/cerbot /usr/bin/cerbot</span><br></pre></td></tr></table></figure>
<p>Web root 方式:</p>
<ul>
<li>编辑 nginx.conf 配置文件, 确保可以访问 /.well-known/ 路径及里边存放的验证文件</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /.well-known/acme-challenge/ &#123;</span><br><span class="line">    <span class="attribute">default_type</span> <span class="string">&quot;text/plain&quot;</span>;</span><br><span class="line">    <span class="attribute">root</span> /data/www/example;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>重新加载 nginx      nginx -s reload</li>
<li>调用命令生成证书</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/certbot certonly --email admin@example.com --webroot -w</span><br><span class="line">/data/www/example -d example.com -d www.example.com</span><br></pre></td></tr></table></figure>
<ul>
<li>命令会在 web root 目录中创建 .well-known 文件夹，其中包含了域名所有权的 验证文件</li>
<li>Certbot 会访问域名下面 /.well-known/acme-challenge/ 来验证域名是否绑 定，并生成证<ul>
<li>—email 为申请者邮箱</li>
<li>—webroot 为 webroot 方式，-w 为站点目录，-d 为要加 https 证书的域名</li>
</ul>
</li>
</ul>
<p>在nginx中开启https</p>
<ul>
<li>证书生成完成后可以到 /etc/letsencrypt/live/ 目录下查看对应域名的证书文件。 编辑 nginx 配置文件监听 443 端口，启用 SSL，并配置 SSL 的公钥、私钥证书 路径。</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211161853.png" alt=""></p>
<ul>
<li>Nginx 配置文件中配置 SSL 证书， 以及监听端口， 重新加载 nginx</li>
</ul>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">    <span class="attribute">listen</span> [::]:<span class="number">443</span> ssl;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">server_name</span> example.com www.example.com;</span><br><span class="line">    <span class="attribute">index</span> index.html index.htm index.php;</span><br><span class="line">    <span class="attribute">root</span> /home/wwwroot/example.com;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">ssl_certificate</span>	/etc/letsencrypt/live/example.com/fullchain.pem;</span><br><span class="line">    <span class="attribute">ssl_certificate_key</span>	/etc/letsencrypt/live/example.com/privkey.pem;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Let’s-Encrypt-SSL-证书续期"><a href="#Let’s-Encrypt-SSL-证书续期" class="headerlink" title="Let’s Encrypt SSL 证书续期"></a>Let’s Encrypt SSL 证书续期</h3><ul>
<li>证书 3个月过期一次</li>
<li>使用 snapd 安装的 certbot, 会启动一个 cron job 或者 systemd 的定时任务，在证 书过期前自动续期</li>
<li>运行这个命令测试自动续期</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 测试自动续期命令</span></span><br><span class="line">cerbot renew --dry-run</span><br><span class="line"></span><br><span class="line"><span class="comment"># 检查定时任务</span></span><br><span class="line">systemctl list-timers</span><br></pre></td></tr></table></figure>
<h3 id="敏感数据加密"><a href="#敏感数据加密" class="headerlink" title="敏感数据加密"></a>敏感数据加密</h3><ul>
<li>对敏感数据，比如用户提交的内容，财务报告，第三方合同等数据进行加密</li>
<li>使用 Python 的 cryptography 库      pip install cryptography</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> cryptography.fernet <span class="keyword">import</span> Fernet</span><br><span class="line"></span><br><span class="line">key = Fernet.generate_key()</span><br><span class="line"></span><br><span class="line">f = Fernet(key)</span><br><span class="line"></span><br><span class="line">token = f.encrypt(<span class="string">b&quot;welcome to django&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(token)</span><br><span class="line"></span><br><span class="line">d = f.decrypt(token)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(d)</span><br></pre></td></tr></table></figure>
<h3 id="日志脱敏"><a href="#日志脱敏" class="headerlink" title="日志脱敏"></a>日志脱敏</h3><p>在日志记录中，过滤掉敏感信息存储，避免敏感信息泄漏</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.decorators.debug <span class="keyword">import</span> sensitive_variables</span><br><span class="line"></span><br><span class="line"><span class="meta">@sensitive_variables(<span class="params"><span class="string">&#x27;user&#x27;</span>, <span class="string">&#x27;pw&#x27;</span>, <span class="string">&#x27;cc&#x27;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_info</span>(<span class="params">user</span>):</span><br><span class="line">    pw = user.pass_word</span><br><span class="line">    cc = user.credit_card_number</span><br><span class="line">    name = user.name</span><br><span class="line">   	...</span><br></pre></td></tr></table></figure>
<p>可以用 sensitive_variables 装饰器阻止错误日志内容包含这些变量的值</p>
<p>具体参考 sensitive_post_parameters, sensitive_post_parameters   <a target="_blank" rel="noopener" href="https://docs.djangoproject.com/zh-hans/3.1/howto/error-reporting/#filteringsensitive-information">https://docs.djangoproject.com/zh-hans/3.1/howto/error-reporting/#filteringsensitive-information</a></p>
<h2 id="密码安全与业务安全"><a href="#密码安全与业务安全" class="headerlink" title="密码安全与业务安全"></a>密码安全与业务安全</h2><ul>
<li>权限控制<ul>
<li>遵循最小原则， 长时间没用自动回收</li>
<li>思路： 定时任务检查所有用户，找到长时间没有登陆的用户，回收相应的权限， 或删除账号</li>
</ul>
</li>
<li>密码策略<ul>
<li>密码复杂度策略</li>
<li>定期更新策略</li>
</ul>
</li>
</ul>
<h3 id="密码策略"><a href="#密码策略" class="headerlink" title="密码策略"></a>密码策略</h3><p>密码验证策略 AUTH_PASSWORD_VALIDATORS</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用django中自带的配置</span></span><br><span class="line"></span><br><span class="line">AUTH_PASSWORD_VALIDATORS = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.UserAttributeSimilarityValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.MinimumLengthValidator&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;min_length&#x27;</span>: <span class="number">9</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.CommonPasswordValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;NAME&#x27;</span>: <span class="string">&#x27;django.contrib.auth.password_validation.NumericPasswordValidator&#x27;</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h3 id="密码过期策略"><a href="#密码过期策略" class="headerlink" title="密码过期策略"></a>密码过期策略</h3><p>可以使用 django-user-accounts 插件 <a target="_blank" rel="noopener" href="https://github.com/pinax/django-user-accounts">https://github.com/pinax/django-user-accounts</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启用中间件</span></span><br><span class="line">MIDDLEWARE_CLASSES = [</span><br><span class="line">    ......</span><br><span class="line">    <span class="string">&quot;account.middleware.ExpiredPasswordMiddleware&quot;</span>,</span><br><span class="line">    ......</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置国企策略</span></span><br><span class="line">ACCOUNT_PASSWORD_USE_HISTORY = <span class="literal">True</span></span><br><span class="line">ACCOUNT_PASSWORD_EXPIRY = <span class="number">60</span>*<span class="number">60</span>*<span class="number">25</span>*<span class="number">5</span></span><br></pre></td></tr></table></figure>
<h1 id="云环境中的部署"><a href="#云环境中的部署" class="headerlink" title="云环境中的部署"></a>云环境中的部署</h1><h2 id="docker容器"><a href="#docker容器" class="headerlink" title="docker容器"></a>docker容器</h2><ul>
<li>docker：<ul>
<li>码头工人，轻量级的，可移植，自包含的容器，来自动化、版本化应用的发布</li>
<li>Docker上跑的容器是一个个的集装箱</li>
</ul>
</li>
<li>Docker的基础是LXC<ul>
<li>LXC用于应用程序的隔离，每个应用程序分配独立的命名空间，隔离的CPU, 内存，磁盘，网络资源</li>
<li>每个应用内部可以单跑一套容器系统，功能上相当于传统的虚拟机，但本质上是内核层面对资源的隔离</li>
</ul>
</li>
<li>Docker 容器的分层和版本管理<ul>
<li>Docker把应用和系统打包到一起（image镜像），进行版本化管理</li>
<li>应用之于Docker，如同代码之于Git/SVN，一个命令可以把应用部署到docker上</li>
</ul>
</li>
</ul>
<p>Docker 容器的几个重要概念：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211183001.png" alt=""></p>
<h3 id="用容器部署应用-Dockerfile"><a href="#用容器部署应用-Dockerfile" class="headerlink" title="用容器部署应用 Dockerfile"></a>用容器部署应用 Dockerfile</h3><p>举例说明：<a target="_blank" rel="noopener" href="https://docs.docker.com/compose/gettingstarted/">https://docs.docker.com/compose/gettingstarted/</a></p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.7</span>-alpine</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /code</span></span><br><span class="line"><span class="keyword">ENV</span> FLASK_APP=app.py</span><br><span class="line"><span class="keyword">ENV</span> FLASK_RUN_HOST=<span class="number">0.0</span>.<span class="number">0.0</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --no-cache gcc musl-dev linux-headers</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt requirements.txt</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> pip install -r requirements.txt</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">5000</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;flask&quot;</span>, <span class="string">&quot;run&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<ul>
<li>使用 Python 3.7 作为基础镜像</li>
<li>把 /code 设置为工作目录</li>
<li>设置 flask 命令运行的环境变量</li>
<li>安装 gcc 和其它依赖</li>
<li>拷贝 requirements.txt 并安装其它依赖包</li>
<li>添加元数据来到镜像，声明监听 5000 端口</li>
<li>拷贝当前目录下所有文件，到镜像的工作目录</li>
<li>设置容器的默认运行命令：flask run</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把当前目录作为上下文， 构建镜像</span></span><br><span class="line">docker build .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定一个 Dockerfile 构建镜像</span></span><br><span class="line">docker build -f /path/to/a/Dockerfile .</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定一个仓库， 以及一个 tag 保存镜像</span></span><br><span class="line"> docker build -t shykes/myapp .</span><br></pre></td></tr></table></figure>
<h3 id="用容器部署应用-Docker-compose"><a href="#用容器部署应用-Docker-compose" class="headerlink" title="用容器部署应用 Docker compose"></a>用容器部署应用 Docker compose</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.8&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span> <span class="string">.</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5000:5000&quot;</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;redis:alpine&quot;</span></span><br><span class="line">		</span><br></pre></td></tr></table></figure>
<h2 id="容器化-Django-应用"><a href="#容器化-Django-应用" class="headerlink" title="容器化 Django 应用"></a>容器化 Django 应用</h2><p>Django 应用容器化优势：</p>
<ul>
<li>效率提升：开发环境可以复用</li>
<li>简单：一个命令搭建可以运行的开发环境</li>
<li>每个应用隔离的容器环境，无 Python/Pip包 版本冲突</li>
</ul>
<p>代码调整：</p>
<ul>
<li>settings文件配置：ALLOWED_HOSTS = [‘*’]</li>
<li>配置项放到环境变量中，通过读取配置启动</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver 0.0.0.0:8000 <span class="variable">$server_params</span></span><br></pre></td></tr></table></figure>
<p>构建小镜像Dockerfile</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">FROM</span> python:<span class="number">3.9</span>-alpine</span><br><span class="line"><span class="keyword">WORKDIR</span><span class="language-bash"> /data/recruitment</span></span><br><span class="line"><span class="keyword">ENV</span> server_params=</span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> requirements.txt ./</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> apk add --update --no-cache curl jq py3-configobj py3-pip py3-setuptools python3 python3-dev \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; apk add --no-cache gcc g++ jpeg-dev zlib-dev libc-dev libressl-dev musl-dev libffi-dev \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; python -m pip install --upgrade pip \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; pip install -r requirements.txt \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; apk del gcc g++ libressl-dev musl-dev libffi-dev python3-dev \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; apk del curl jq py3-configobj py3-pip py3-setuptools \</span></span><br><span class="line"><span class="language-bash">  &amp;&amp; <span class="built_in">rm</span> -rf /var/cache/apk/*</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> . .</span></span><br><span class="line"><span class="keyword">EXPOSE</span> <span class="number">8000</span></span><br><span class="line"><span class="keyword">CMD</span><span class="language-bash"> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;/data/recruitment/start.local.bat&quot;</span>]</span></span><br></pre></td></tr></table></figure>
<p>构建小镜像要点:</p>
<ul>
<li>使用 alpine 的基础镜像</li>
<li>多个 命令使用一个 RUN 命令，这样只会产生一个 layer</li>
<li>在 RUN 命令的最后面删除不用的包，以及cache的包，减小镜像大小</li>
<li>使用 .dockerigonre 文件，把不需要打包到镜像的文件剔除，镜像会小很多</li>
</ul>
<p>运行容器：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 构建镜像</span></span><br><span class="line">docker build -t setcreed/recruitment-base:v1.0.</span><br><span class="line"></span><br><span class="line"><span class="comment"># 交互运行</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> -p 8000:8000 --entrypoint /bin/sh setcreed/recruitment-base:v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开发环境， 开发阶段，指定本地源码目录</span></span><br><span class="line">docker run -it --<span class="built_in">rm</span> -p 8000:8000 -v <span class="string">&quot;<span class="subst">$(pwd)</span>&quot;</span>:/data/recruitment --entrypoint /bin/sh</span><br><span class="line">setcreed/recruitment-base:v1.0</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定加载源码 &amp;&amp; 环境变量</span></span><br><span class="line">docker run --<span class="built_in">rm</span> -p 8000:8000 -v <span class="string">&quot;<span class="subst">$(pwd)</span>&quot;</span>:/data/recruitment --<span class="built_in">env</span> server_params=<span class="string">&quot;--</span></span><br><span class="line"><span class="string">settings=settings.local&quot;</span> setcreed/recruitment-base:v1.0</span><br></pre></td></tr></table></figure>
<h2 id="容器编排-–-docker-compose"><a href="#容器编排-–-docker-compose" class="headerlink" title="容器编排 – docker compose"></a>容器编排 – docker compose</h2><p>Docker compose 单机编排:</p>
<ul>
<li>想要在一台主机上， 一下子跑起来多个容器， 且容器之间有调用关系</li>
</ul>
<p>在一个 docker-compose.yml 文件中配置4个容器:</p>
<ul>
<li>web: django 的应用， 使用 start.local.bat 来启动</li>
<li>redis: 缓存，以及 Celery 的broker 要用到的数据存储</li>
<li>celery: 异步任务 worker （用于异步发送钉钉消息通知）</li>
<li>flower：异步任务的监控应用 （监控异步任务的执行情况）</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">&quot;3.2&quot;</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">build:</span></span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">command:</span> <span class="string">/bin/sh</span> <span class="string">/data/recruitment/start.local.bat</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">server_params=--settings=settings.local</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/data/recruitment</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/logs/recruitment/</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8000:8000&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">celery</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">flower</span></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;redis:alpine&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">recruit-redis</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;6379:6379&quot;</span></span><br><span class="line">  <span class="attr">celery:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;setcreed/recruitment-base:v1.0&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">recruit-celery</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/data/recruitment</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/logs/recruitment/</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;/data/recruitment/worker.start.sh&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">flower:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;setcreed/recruitment-base:v1.0&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">recruit-flower</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;5555:5555&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">.:/data/recruitment</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">/data/logs/recruitment/</span></span><br><span class="line">    <span class="attr">entrypoint:</span> [<span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;/data/recruitment/flower.start.sh&quot;</span>]</span><br><span class="line">    <span class="attr">depends_on:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br></pre></td></tr></table></figure>
<p>启动：docker-compse up –d</p>
<p>停止：docker-compose stop</p>
<p>删除：docker-compose rm</p>
<p>docker docker-compose  kubernates的关系</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211202954.png" alt=""></p>
<h2 id="kubernates的介绍"><a href="#kubernates的介绍" class="headerlink" title="kubernates的介绍"></a>kubernates的介绍</h2><p>k8s 的架构</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211205019.png" alt=""></p>
<p>k8s的分层架构</p>
<ul>
<li>核心层：Kubernetes 最核心的功能，对外提 供 API 构建高层的应用，对内提供插件式应用 执行环境</li>
<li>应用层： 部署（无状态、有状态应用、job 等） 路由</li>
<li>管理层： 系统度量（如基础设施、容器和网络的度量） 自动化（如自动扩展、动态 Provision 等） 策略管理（RBAC、Quota、PSP、 NetworkPolicy 等）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211205205.png" alt=""></p>
<p>核心组件：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211205310.png" alt=""></p>
<p>k8s 的核心概念：</p>
<ul>
<li>声明式管理： 通过 yml 声明期望的状态，k8s 自动根据定义的状态进行调度 （相对命令式管理而言， k8s 也提供命令式管理的方式）<ul>
<li>声明式： kubectl apply -f  </li>
<li>命令式： kubectl run xxx ，kubectl expose ..</li>
</ul>
</li>
<li>Master node：集群主控节点，上面运行调度容器，管理容器</li>
<li>Worker node：工作节点，上面运行应用的容器</li>
<li>Pods：容器，k8s 对容器进行管理，自动创建、销毁容器</li>
<li>Service：使用 标签 选择算符（selectors）标识的一组 Pod，在集群内有固定 IP；可以用于为集群 内部容器/应用提供 稳定的访问入口，可以通过 service 名称访问到服务</li>
<li>Deployment：一套部署的容器集合</li>
<li>ReplicationController：可以复制的容器，功能集比 ReplicaSet 少，已不推荐使用</li>
<li>ReplicaSet：可以扩容、缩容的容器副本集，在容器集不需要状态，也不需要被其它容器访问的时候， 可以使用 ReplicaSet。其它容器无法直接访问 RS，可以通过 Service 来访问</li>
<li>StatefullSet：有状态的服务，比如 zookeeper，集群被外部使用的时候， 需要指定多个 zookeeper 服务的 ip 或者 hostname。由于是有状态的，比如 3 个节点的 zookeeper，不论如何 扩缩容（包括宕机恢复），3个节点容器名称/主机名总是 zk-0, zk-1, zk-2</li>
<li>Ingress：对外暴露可以访问的入口，为服务提供外网（从集群外）的访问入口</li>
<li>Namespace：资源可以放在 namespace 下面， 不同 namespace 之间相互隔离</li>
<li>Controller: 包括有节点控制器 , 路由控制器 , 服务控制器</li>
</ul>
<p>创建 k8s 声明式配置</p>
<p>把 compose 文件转换为 k8s 声明式配置文件。 on mac :</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">curl -L https://github.com/kubernetes/kompose/releases/download/v1.16.0/k ompose-darwin-amd64 -o kompose</span><br><span class="line"><span class="built_in">chmod</span> +x compose &amp;&amp; sudo <span class="built_in">mv</span> kompose /usr/local/bin/</span><br><span class="line">kompose convert</span><br><span class="line">mkidr k8s</span><br><span class="line"><span class="built_in">mv</span> *.yaml k8s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后安装 应用到 k8s 集群:：</span></span><br><span class="line">kubectl apply -f k8s</span><br></pre></td></tr></table></figure>
<h2 id="在阿里云上搭建kubernates集群"><a href="#在阿里云上搭建kubernates集群" class="headerlink" title="在阿里云上搭建kubernates集群"></a>在阿里云上搭建kubernates集群</h2><p>K8s 环境创建 &amp; 部署流程：</p>
<ul>
<li>创建 Kubernetes 集群， 创建镜像仓库</li>
<li>配置本地 kubeconfig</li>
<li>Docker login 到 镜像仓库</li>
<li>Docker build &amp; docker push 推送镜像到镜像仓库</li>
<li>K8s 部署到集群： kubectl apply -f k8s</li>
</ul>
<p>在阿里云 k8s 控制台， 创建路由（ingress 路由），指向 Django 应用，即可访问</p>
<h2 id="管理监控容器中的Django应用"><a href="#管理监控容器中的Django应用" class="headerlink" title="管理监控容器中的Django应用"></a>管理监控容器中的Django应用</h2><p>云环境的复杂性：</p>
<ul>
<li>应用被分布在了容器上运行，大量容器不断得创建销毁，升级</li>
<li>应用的可观测性，可见性变得更加重要</li>
</ul>
<p>监控方案：</p>
<ul>
<li>kubectl 命令行</li>
<li>可视化监控方案<ul>
<li>GUI 的 kubernetes dashboard </li>
<li>云厂商的控制台</li>
<li>Sentry</li>
<li>ELK</li>
<li>Prometheus</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/94622.html">https://help.aliyun.com/document_detail/94622.html</a></p>
<p>阿里云环境：手工安装 ack-prometheus-operator：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/94622.html">https://help.aliyun.com/document_detail/94622.html</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 执行以下命令，将集群中的Prometheus映射到本地9090端口</span></span><br><span class="line">kubectl -n monitoring port-forward svc/ack-prometheus-operator-prometheus 9090:9090</span><br><span class="line"></span><br><span class="line"><span class="comment"># Grafana 查看与展示数据聚合, 执行以下命令，将集群中的Grafana映射到本地3000端口。（admin/prom-operator）</span></span><br><span class="line">kubectl -n monitoring port-forward svc/ack-prometheus-operator-grafana 3000:80</span><br></pre></td></tr></table></figure>
<h2 id="应用日志收集与查询"><a href="#应用日志收集与查询" class="headerlink" title="应用日志收集与查询"></a>应用日志收集与查询</h2><p>云环境的复杂性:</p>
<ul>
<li>应用被分布在了容器上运行，大量容器不断得创建销毁，升级</li>
<li>应用的可观测性，可见性变得更加重要</li>
</ul>
<p>日志收集 &amp; 查询的不同方案:</p>
<ul>
<li>使用Kubelet收集容器化应用输出到标准输出的日志</li>
<li>使用 sidecar 收集输出到文件中的日志，输出到标准输出 &amp;&amp; tail –f<ul>
<li>ELK/EFK 采集日志</li>
<li>阿里云Logtail 日志采集</li>
</ul>
</li>
</ul>
<p>k8s 下面的各种日志:</p>
<ul>
<li>Pod logs</li>
<li>Node logs -&gt; 宿主机的 /var/log/containers目录</li>
<li>K8s components logging (api server ,scheduler …)</li>
<li>K8s events</li>
<li>Audit logs</li>
<li>k8s 默认会将容器的stdout和stderr录入node的/var/log/containers目录下</li>
<li>而 k8s 组件的日志默认放置在/var/log目录下</li>
</ul>
<p>阿里云 logtail 日志采集:</p>
<ul>
<li>为集群启用Logtail，确保 logtail-ds 组件已安装</li>
<li>登陆 SLS， 确保能看到采集的 k8s 系统日志</li>
<li>在 deployment.yaml 配置中指定 Logtail 相关配置变量</li>
<li>参考文档：<a target="_blank" rel="noopener" href="https://help.aliyun.com/document_detail/87540.html">https://help.aliyun.com/document_detail/87540.html</a></li>
</ul>
<p>代码中的调整：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211214229.png" alt=""></p>
<ul>
<li>日志输出到独立的目录中</li>
<li>Settings 文件中更改日志路径</li>
<li>通过环境变量来创建您的采集配置和自定义Tag，所有与配置相关的环境变量都 采用aliyun<em>logs</em>作为前缀</li>
<li>创建采集配置的规则如下：- name: aliyun<em>logs</em>{Logstore名称} value: {日志采集路径}</li>
<li>签名创建了两个采集配置</li>
<li>其中 aliyun_logs_recruitment-web 这个env表示创建一个Logstore名字为 recruitment-web，日志采集路径为stdout的配置，从而将容器的标准输出采集 到 recruitment-web 这个Logstore中</li>
</ul>
<h1 id="云环境下的持续集成"><a href="#云环境下的持续集成" class="headerlink" title="云环境下的持续集成"></a>云环境下的持续集成</h1><h2 id="CI-CD的工作流程"><a href="#CI-CD的工作流程" class="headerlink" title="CI/CD的工作流程"></a>CI/CD的工作流程</h2><p>CICD 包含如下流程：</p>
<ul>
<li>Build &amp; Package</li>
<li>Test</li>
<li>Deployment</li>
</ul>
<p>需要的服务：</p>
<ul>
<li>Git仓库：使用 Github</li>
<li>Docker 镜像仓库：使用阿里云镜像仓库</li>
<li>Jenkins：使用阿里云 k8s 上搭建的 jenkins</li>
<li>K8s: 使用阿里云 k8s</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210211214537.png" alt=""></p>
<p>CICD 工具：Jenkins、Spinnaker、Harness</p>
<p>Jenkins pipeline 流水线：</p>
<ul>
<li>CICD Pipeline: 包含一系列按照指定顺序执行的脚本</li>
<li>包含有用来完成任务的多个阶段（stages）</li>
</ul>
<p>CD 阶段不同的部署策略：</p>
<ul>
<li>Rolling Upgrade: 滚动更新，多个实例，下线一台升级一台，直至升级完</li>
<li>Blue/Green Deployment: 蓝绿部署，部署到新集群，部署完切流量到新集群</li>
<li>Canary Deployment：金丝雀部署，过程中新老版本共存，持续做灰度验证</li>
</ul>
<h2 id="CI-CD的使用"><a href="#CI-CD的使用" class="headerlink" title="CI/CD的使用"></a>CI/CD的使用</h2><p>如何对 Django Web 应用进行 CICD， 自动化镜像打包，测试，发布，部署</p>
<ul>
<li>前提：镜像的构建不依赖于本地的文件</li>
<li>安全策略：账号密码不保存在代码库中</li>
<li>账号密码保存到哪里？ 密码如何使用<ul>
<li>Kubernetes Secrets</li>
<li>KMS 系统： 如 Vault, 阿里云 KMS 等</li>
</ul>
</li>
</ul>
<p>使用 Kubernetes Secrets 管理账号密码：</p>
<p>使用账号密码使用的流程：</p>
<ul>
<li>K8s secrets 中管理密码，k8s 配置文件中引用密码，代码中通过环境变量来引用</li>
</ul>
<p>什么是 Kubernetes Secrets? <a target="_blank" rel="noopener" href="https://kubernetes.io/zh/docs/concepts/configuration/secret/">https://kubernetes.io/zh/docs/concepts/configuration/secret/</a></p>
<p>如何使用：</p>
<ul>
<li>基于文件创建 Secret : kubectl apply -f mysecret.yaml</li>
<li>基于命令创建：kubectl create secret generic</li>
<li>在云厂商 k8s 的管理控制台创建 secrets</li>
</ul>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kubectl create secret generic prod-db-secret --fromliteral=username=produser --from-literal=password=Y4nys7f11</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl get secret prod-db-secret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl describe secret prod-db-secret</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl delete secret prod-db-secret</span><br></pre></td></tr></table></figure>
<p>阿里云创建密钥:</p>
<ul>
<li>创建密钥: 配置管理 – 保密字典</li>
<li>使用密钥: K8s 文件中 引用 secrets</li>
<li>Python 代码从环境变量读取配置</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210212064436.png" alt=""></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># settings/production.py</span></span><br><span class="line"></span><br><span class="line">LDAP_AUTH_URL = os.environ.get(<span class="string">&#x27;LDAPA_AUTH_URL&#x27;</span>, <span class="string">&#x27;ldap://localhost:389&#x27;</span>)</span><br><span class="line">LDAP_AUTH_CONNECTION_USERNAME = os.environ.get(<span class="string">&#x27;LDAP_AUTH_CONNECTION_USERNAME&#x27;</span>)</span><br><span class="line">LDAP_AUTH_CONNECTION_PASSWORD = os.environ.get(<span class="string">&#x27;LDAP_AUTH_CONNECTION_PASSWORD&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AliCloud access key ID</span></span><br><span class="line">OSS_ACCESS_KEY_ID = os.environ.get(<span class="string">&#x27;OSS_ACCESS_KEY_ID&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># AliCloud access key secret</span></span><br><span class="line">OSS_ACCESS_KEY_SECRET = os.environ.get(<span class="string">&#x27;OSS_ACCESS_KEY_SECRET&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>搭建 k8s 中的 Jenkins 环境</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 Jenkins DoD 版本 (Docker on Docker），部署到 k8s</span></span><br><span class="line"><span class="built_in">cd</span> Jenkins-dod</span><br><span class="line">docker pull ihopeit/jenkins-dod:1.1</span><br><span class="line">docker tag ihopeit/jenkins-dod:1.1 registry.cnbeijing.aliyuncs.com/ihopeit/jenkins-dod:1.1</span><br><span class="line">docker push registry.cn-beijing.aliyuncs.com/ihopeit/jenkins-dod:1.1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化完成后，部署到 k8s :</span></span><br><span class="line">kubectl apply -f jenkins-service.yaml</span><br><span class="line">kubectl apply -f jenkins-deployment.yaml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># jenkins 的启动日志里面会自动产生初始化的 admin 密码，可用于登陆</span></span><br></pre></td></tr></table></figure>
<ul>
<li>阿里云 K8s 创建 Jenkins 路由（ingress路由）</li>
<li>访问 Jenkins， 配置 kubeconfig， 配置 阿里云 镜像仓库账号密码</li>
<li>创建 Jenkins 项目， Pipeline 项目，设置 Pipeline</li>
<li>Build 项目</li>
</ul>
<h1 id="快速迭代开发过程"><a href="#快速迭代开发过程" class="headerlink" title="快速迭代开发过程"></a>快速迭代开发过程</h1><h2 id="快速迭代的价值与挑战"><a href="#快速迭代的价值与挑战" class="headerlink" title="快速迭代的价值与挑战"></a>快速迭代的价值与挑战</h2><p>快速迭代：以天，甚至小时为单位，持续完善产品，交付到用户的循环过程</p>
<p>快速迭代的价值:</p>
<ul>
<li>时间是最大的成本：机会瞬息即逝，赢得市场先机</li>
<li>快速验证需求，减少不对用户产生价值的投入（Fail fast, fail better）</li>
<li>快速验证方案，提高研发效率</li>
<li>加速反馈回路，给到团队和自己即时的激励</li>
</ul>
<p>快速迭代的挑战:</p>
<ul>
<li>产品设计者：能梳理清楚业务流程，抓住客户的重点需求，能把客户需求转化为系统需求</li>
<li>开发者：充分理解用户需求;有足够的能力，能用简洁的方案来设计出易维护的系统</li>
</ul>
<p>根本挑战:</p>
<ul>
<li>市场、用户、技术、环境变化太快，产品开发赶不上节奏</li>
<li>几乎不能从一开始就设计出一个完美的，能够适应未来长时间变化的方案</li>
<li>几乎没有人愿意承认，自己没有足够的能力（或条件）设计出一个完美的产品（系统）</li>
</ul>
<h2 id="使用-OOPD-方法识别产品核心功能"><a href="#使用-OOPD-方法识别产品核心功能" class="headerlink" title="使用 OOPD 方法识别产品核心功能"></a>使用 OOPD 方法识别产品核心功能</h2><p>OOPD （Online and Offline integrated Product development）产品开发流程</p>
<p>OOPD 快速迭代的原则:</p>
<ul>
<li>自助原则：做自己用的产品，自己用自己的产品，吃自己的狗食</li>
<li>0day 原则：找到明确的核心问题 拆解目标，抓住核心的问题，忽略掉一切细节，0day 发布</li>
<li>时限原则：设定时限，挑战自我 不给自己写 Bug 的时间</li>
<li>不完美原则：不做完美的产品（没有完美的产品，不去为了完美而浪费宝贵的资源）</li>
<li>谦卑原则：能够看到自己的局限性，获取用户反馈，持续迭代，听取用户声音</li>
</ul>
<h2 id="如何做好技术方案设计与工作拆解"><a href="#如何做好技术方案设计与工作拆解" class="headerlink" title="如何做好技术方案设计与工作拆解"></a>如何做好技术方案设计与工作拆解</h2><p>做技术方案设计的前提条件</p>
<ul>
<li>有明确的用户场景，用户如何跟产品交互，期望拿到什么样的预期结果</li>
<li>有清晰定义的业务流程</li>
</ul>
<p>技术方案设计流程</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/CDN@latest/img/20210212074835.png" alt=""></p>
<p>产出的技术方案设计文档要素:</p>
<ul>
<li>产品背景（用户场景，产品目标，引用到的业务流程，产品需求文档）</li>
<li>要解决的问题列表，系统不解决的问题列表，系统的限制</li>
<li>对于问题的不同解决方案的对比，阐述各个主要的问题如何被解决</li>
<li>所选整体的流程图（序列图），模块关系图，重要的接口、实体的概念定义</li>
<li>除了功能之外的其它方面的设计，包括安全，性能，可维护性，稳定性，监控，扩展性，易用性等</li>
</ul>
<p>工作拆解的原则:</p>
<ul>
<li>优先级：主流程上，不确定的工作优先完成（建议提前一个迭代做调研）</li>
<li>核心流程优先：核心工作优先，先把主流程跑通</li>
<li>依赖：减少不同人之间的工作依赖；并且保持团队工作拆解的透明，预留20% Buffer</li>
<li>拆解粒度：拆解到每项子任务 0.5-1天的粒度，最长不超过2天</li>
</ul>
<h2 id="如何保证交付质量和持续迭代"><a href="#如何保证交付质量和持续迭代" class="headerlink" title="如何保证交付质量和持续迭代"></a>如何保证交付质量和持续迭代</h2><ul>
<li>定义好清晰产品需求，产品需求从根本上决定了软件的质量</li>
<li>系统有整体上的架构方案的设计，评估，评审；系统设计决定了软件实现的质量</li>
<li>工程的角度持续交付的最佳实践推荐<ul>
<li>Code Review： 每一次提交都有 CR，每次 commit 代码量 &lt; 200 行，频繁commit</li>
<li>单元测试：项目开始建立好单元测试的机制，在持续集成中自动运行</li>
<li>自动化回归：对预发/线上系统做 API/页面自动化测试 (Postman/Robot Framework)</li>
<li>使用 CICD 机制对系统进行自动化的打包、测试、部署、线上验证</li>
</ul>
</li>
<li>发布过程做到可监控，可回滚</li>
<li>对于大量用户使用的产品，使用灰度机制</li>
<li>架构上对于意外的并发访问进行限流，降级</li>
<li>架构上使用配置开关，对系统功能提供实时的开启/关闭的服务</li>
<li>对产品建立 A/B Test机制，通过数据来快速对比不同版本，不同方案的效果</li>
<li>自动化所有事情，代码化所有过程：代码化配置，代码化部署流程，代码化基础设施<ul>
<li>声明式 API，CICD Pipeline, K8S, Helm, Terraform</li>
</ul>
</li>
</ul>
<p>Hacker</p>
<p><a target="_blank" rel="noopener" href="https://translations.readthedocs.io/en/latest/hacker_howto.html">https://translations.readthedocs.io/en/latest/hacker_howto.html</a></p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://setcreed.github.io">SetCreed</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://setcreed.github.io/posts/9b4e6704/">https://setcreed.github.io/posts/9b4e6704/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://setcreed.github.io" target="_blank">伊甸园</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/django/">django</a></div><div class="post_share"><div class="social-share" data-image="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-4.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/417406ac/" title="vim学习目录"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/pic_img/cdn_img/20200212093719.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">vim学习目录</div></div></a></div><div class="next-post pull-right"><a href="/posts/c092dbc6/" title="python核心"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-13.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">python核心</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">SetCreed</div><div class="author-info__description">读书、写代码、看电影</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">80</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">24</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/setcreed"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/img/qq.jpg" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/img/wechat_account.jpg" target="_blank" title="微信"><i class="fab fa-weixin"></i></a><a class="social-icon" href="https://github.com/setcreed" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:cwzdzg@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%81%8C%E4%BD%8D%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.</span> <span class="toc-text">职位管理系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E5%8F%AF%E4%BB%A5%E7%AE%A1%E7%90%86%E8%81%8C%E4%BD%8D%E7%9A%84%E5%90%8E%E5%8F%B0"><span class="toc-number">1.1.</span> <span class="toc-text">创建一个可以管理职位的后台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3%E5%AE%8C%E5%96%84%E5%BA%94%E7%94%A8"><span class="toc-number">1.2.</span> <span class="toc-text">快速迭代完善应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%A9%E5%8C%BF%E5%90%8D%E7%94%A8%E6%88%B7%E5%8F%AF%E4%BB%A5%E6%B5%8F%E8%A7%88%E8%81%8C%E4%BD%8D%E5%88%97%E8%A1%A8%E9%A1%B5"><span class="toc-number">1.3.</span> <span class="toc-text">让匿名用户可以浏览职位列表页</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%8B%9B%E8%81%98%E8%AF%84%E4%BC%B0%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.</span> <span class="toc-text">招聘评估系统</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A7%E5%93%81%E8%BF%AD%E4%BB%A3%E6%80%9D%E6%83%B3"><span class="toc-number">2.1.</span> <span class="toc-text">产品迭代思想</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E4%BA%A7%E5%93%81%E4%B8%AD%E4%BD%BF%E7%94%A8%E4%BA%A7%E5%93%81%E8%BF%AD%E4%BB%A3%E6%80%9D%E6%83%B3"><span class="toc-number">2.2.</span> <span class="toc-text">在产品中使用产品迭代思想</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%BB%BA%E6%A8%A1%E5%92%8C%E4%BC%81%E4%B8%9A%E7%BA%A7%E6%95%B0%E6%8D%AE%E5%BA%93%E8%AE%BE%E8%AE%A1%E5%8E%9F%E5%88%99"><span class="toc-number">2.3.</span> <span class="toc-text">数据建模和企业级数据库设计原则</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E5%BA%94%E7%94%A8%E5%92%8C%E6%A8%A1%E5%9E%8B%EF%BC%8C%E5%88%86%E7%BB%84%E5%B1%95%E7%A4%BA%E9%A1%B5%E9%9D%A2%E5%86%85%E5%AE%B9"><span class="toc-number">2.4.</span> <span class="toc-text">创建应用和模型，分组展示页面内容</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%8EExcel%E6%96%87%E4%BB%B6%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5%E5%80%99%E9%80%89%E4%BA%BA%E6%95%B0%E6%8D%AE"><span class="toc-number">2.5.</span> <span class="toc-text">从Excel文件批量导入候选人数据</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%99%E9%80%89%E4%BA%BA%E5%88%97%E8%A1%A8%E7%AD%9B%E9%80%89%E5%92%8C%E6%9F%A5%E8%AF%A2"><span class="toc-number">2.6.</span> <span class="toc-text">候选人列表筛选和查询</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%81%E4%B8%9A%E5%9F%9F%E8%B4%A6%E5%8F%B7%E9%9B%86%E6%88%90"><span class="toc-number">2.7.</span> <span class="toc-text">企业域账号集成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%B9%E9%87%8F%E5%AF%BC%E5%85%A5%E9%9D%A2%E8%AF%95%E5%AE%98%E4%BF%A1%E6%81%AF%E3%80%81%E6%9D%83%E9%99%90"><span class="toc-number">2.8.</span> <span class="toc-text">批量导入面试官信息、权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B0%E5%A4%84%E5%80%99%E9%80%89%E4%BA%BA%E7%9A%84%E6%95%B0%E6%8D%AE%E5%88%B0CSV"><span class="toc-number">2.9.</span> <span class="toc-text">到处候选人的数据到CSV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A2%9E%E5%8A%A0%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95"><span class="toc-number">2.10.</span> <span class="toc-text">增加日志记录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%8E%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%E5%88%86%E7%A6%BB"><span class="toc-number">2.11.</span> <span class="toc-text">生产环境与开发环境配置分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%A7%E5%93%81%E7%BB%86%E8%8A%82%E5%AE%8C%E5%96%84"><span class="toc-number">2.12.</span> <span class="toc-text">产品细节完善</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E5%8E%86%E6%8A%95%E9%80%92%E5%92%8C%E9%9D%A2%E8%AF%95%E6%B5%81%E7%A8%8B%E9%97%AD%E7%8E%AF"><span class="toc-number">3.</span> <span class="toc-text">简历投递和面试流程闭环</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E6%9B%B4%E7%BE%8E%E8%A7%82%E7%9A%84%E4%B8%BB%E9%A2%98"><span class="toc-number">3.1.</span> <span class="toc-text">定制更美观的主题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E9%9D%A2%E8%AF%95%E5%AE%98%E6%9D%83%E9%99%90"><span class="toc-number">3.2.</span> <span class="toc-text">定制面试官权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%8A%A5%E9%94%99%E5%8A%9F%E8%83%BD%EF%BC%9A%E9%92%89%E9%92%89%E7%BE%A4%E9%9B%86%E6%88%90"><span class="toc-number">3.3.</span> <span class="toc-text">系统报错功能：钉钉群集成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%81%E8%AE%B8%E5%80%99%E9%80%89%E4%BA%BA%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%EF%BC%9A%E9%9B%86%E6%88%90Registration"><span class="toc-number">3.4.</span> <span class="toc-text">允许候选人注册登录：集成Registration</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%99%E9%80%89%E4%BA%BA%E7%AE%80%E5%8E%86%E5%AD%98%E5%82%A8"><span class="toc-number">3.5.</span> <span class="toc-text">候选人简历存储</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%80%99%E9%80%89%E4%BA%BA%E5%9C%A8%E7%BA%BF%E6%8A%95%E9%80%92%E7%AE%80%E5%8E%86"><span class="toc-number">3.6.</span> <span class="toc-text">候选人在线投递简历</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-Bootstrap-%E6%9D%A5%E5%AE%9A%E5%88%B6%E9%A1%B5%E9%9D%A2%E6%A0%B7%E5%BC%8F"><span class="toc-number">3.7.</span> <span class="toc-text">使用 Bootstrap 来定制页面样式</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%80%E5%8E%86%E8%AF%84%E4%BC%B0%E5%92%8C%E5%AE%89%E6%8E%92%E4%B8%80%E9%9D%A2%E9%9D%A2%E8%AF%95%E5%AE%98"><span class="toc-number">3.8.</span> <span class="toc-text">简历评估和安排一面面试官</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E5%88%97%E8%A1%A8%E5%AD%97%E6%AE%B5%EF%BC%8C%E6%9F%A5%E7%9C%8B%E7%AE%80%E5%8E%86%E8%AF%A6%E6%83%85"><span class="toc-number">3.9.</span> <span class="toc-text">定制列表字段，查看简历详情</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Django%E8%BF%9B%E9%98%B6%E5%BC%80%E5%8F%91%E5%A4%8D%E6%9D%82%E5%9C%BA%E6%99%AF"><span class="toc-number">4.</span> <span class="toc-text">Django进阶开发复杂场景</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%BA%E5%B7%B2%E6%9C%89%E7%B3%BB%E7%BB%9F%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%9F%E6%88%90%E7%AE%A1%E7%90%86%E5%8A%9F%E8%83%BD"><span class="toc-number">4.1.</span> <span class="toc-text">为已有系统数据库生成管理功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">4.2.</span> <span class="toc-text">Django中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%AF%B7%E6%B1%82%E6%97%A5%E5%BF%97%E3%80%81%E6%80%A7%E8%83%BD%E6%97%A5%E5%BF%97%E8%AE%B0%E5%BD%95%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="toc-number">4.3.</span> <span class="toc-text">创建请求日志、性能日志记录中间件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%A4%9A%E8%AF%AD%E8%A8%80"><span class="toc-number">4.4.</span> <span class="toc-text">Django中使用多语言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%99%E8%AF%AF%E5%92%8C%E5%BC%82%E5%B8%B8%E6%97%A5%E5%BF%97%E4%B8%8A%E6%8A%A5"><span class="toc-number">4.5.</span> <span class="toc-text">错误和异常日志上报</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Sentry%E9%9B%86%E6%88%90"><span class="toc-number">4.5.1.</span> <span class="toc-text">Sentry集成</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%82%E5%B8%B8%E5%8F%91%E9%80%81%E9%92%89%E9%92%89%E7%BE%A4"><span class="toc-number">4.5.2.</span> <span class="toc-text">异常发送钉钉群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django%E5%AE%89%E5%85%A8%E9%98%B2%E6%8A%A4"><span class="toc-number">4.6.</span> <span class="toc-text">Django安全防护</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E6%AD%A2XSS%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB"><span class="toc-number">4.6.1.</span> <span class="toc-text">防止XSS跨站脚本攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF-%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0"><span class="toc-number">4.6.2.</span> <span class="toc-text">CSRF 跨站请求伪造</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#SQL-%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="toc-number">4.6.3.</span> <span class="toc-text">SQL 注入攻击</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django-Rest-Framework-%E5%BC%80%E6%94%BEAPI"><span class="toc-number">4.7.</span> <span class="toc-text">Django Rest Framework 开放API</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8Django%E4%B8%AD%E4%BD%BF%E7%94%A8%E7%BC%93%E5%AD%98"><span class="toc-number">4.8.</span> <span class="toc-text">在Django中使用缓存</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django%E4%B8%8ECelery%E9%9B%86%E6%88%90"><span class="toc-number">4.9.</span> <span class="toc-text">Django与Celery集成</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Django%E4%B8%8ECelery%E9%9B%86%E6%88%90%EF%BC%9A%E5%BC%82%E6%AD%A5%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.9.1.</span> <span class="toc-text">Django与Celery集成：异步任务</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Django-%E4%B8%8E-Celery-%E9%9B%86%E6%88%90%EF%BC%9A%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1"><span class="toc-number">4.9.2.</span> <span class="toc-text">Django 与 Celery 集成：定时任务</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%92%8C%E5%9B%BE%E7%89%87%E4%B8%8A%E4%BC%A0%E5%8A%9F%E8%83%BD"><span class="toc-number">4.10.</span> <span class="toc-text">文件和图片上传功能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E6%9C%AC%E5%9C%B0%E7%A3%81%E7%9B%98%E5%AD%98%E5%82%A8"><span class="toc-number">4.10.1.</span> <span class="toc-text">使用本地磁盘存储</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E9%98%BF%E9%87%8C%E4%BA%91-OSS-%E5%AD%98%E5%82%A8"><span class="toc-number">4.10.2.</span> <span class="toc-text">使用阿里云 OSS 存储</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%9A%E6%95%B0%E6%8D%AE%E8%B7%AF%E7%94%B1"><span class="toc-number">4.11.</span> <span class="toc-text">多数据路由</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%94%AF%E6%8C%81%E5%A4%A7%E6%95%B0%E6%8D%AE%E9%87%8F%E7%9A%84%E5%85%B3%E8%81%94%E5%A4%96%E9%94%AE"><span class="toc-number">4.12.</span> <span class="toc-text">支持大数据量的关联外键</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E7%8E%B0%E5%8F%AA%E8%AF%BB%E7%AB%99%E7%82%B9-ReadOnlyAdmin"><span class="toc-number">4.13.</span> <span class="toc-text">实现只读站点 ReadOnlyAdmin</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E6%B3%A8%E5%86%8C%E6%89%80%E6%9C%89Model%E5%88%B0%E7%AE%A1%E7%90%86%E5%90%8E%E5%8F%B0"><span class="toc-number">4.14.</span> <span class="toc-text">自动注册所有Model到管理后台</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django%E7%9A%84-signals%E4%BF%A1%E5%8F%B7"><span class="toc-number">4.15.</span> <span class="toc-text">Django的 signals信号</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E9%9B%85%E7%9A%84%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1"><span class="toc-number">4.16.</span> <span class="toc-text">优雅的架构设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSR-%E6%9E%B6%E6%9E%84%E6%80%BB%E7%BB%93-Celery"><span class="toc-number">4.16.1.</span> <span class="toc-text">CSR 架构总结 Celery</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CSR-%E6%9E%B6%E6%9E%84%E6%80%BB%E7%BB%93-Sentry"><span class="toc-number">4.16.2.</span> <span class="toc-text">CSR 架构总结 Sentry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Rest-framework%E6%80%BB%E7%BB%93"><span class="toc-number">4.16.3.</span> <span class="toc-text">Rest framework总结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Django%E5%B8%B8%E7%94%A8%E7%9A%84%E6%8F%92%E4%BB%B6"><span class="toc-number">4.17.</span> <span class="toc-text">Django常用的插件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Django-debug-toolbar"><span class="toc-number">4.17.1.</span> <span class="toc-text">Django_debug_toolbar</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Simple-UI"><span class="toc-number">4.17.2.</span> <span class="toc-text">Simple UI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Django%E6%A8%A1%E5%9D%97%E5%8C%96%E6%90%9C%E7%B4%A2Haystack"><span class="toc-number">4.17.3.</span> <span class="toc-text">Django模块化搜索Haystack</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%92%8C%E5%BA%94%E7%94%A8%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6"><span class="toc-number">5.</span> <span class="toc-text">生产环境部署和应用监控告警</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95"><span class="toc-number">5.1.</span> <span class="toc-text">单元测试</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%B8%AA%E7%AE%80%E5%8D%95%E7%9A%84%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B%EF%BC%9A"><span class="toc-number">5.1.1.</span> <span class="toc-text">一个简单的测试用例：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84%E7%BB%84%E7%BB%87"><span class="toc-number">5.1.2.</span> <span class="toc-text">目录结构组织</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E6%B5%8B%E8%AF%95%E7%94%A8%E4%BE%8B"><span class="toc-number">5.1.3.</span> <span class="toc-text">执行测试用例</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2"><span class="toc-number">5.2.</span> <span class="toc-text">生产环境的应用部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%91%E5%B8%83%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E6%AD%A5%E9%AA%A4"><span class="toc-number">5.2.1.</span> <span class="toc-text">发布到生产环境的步骤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%9A%E8%AE%A9%E7%BD%91%E7%AB%99%E5%87%86%E5%A4%87%E5%A5%BD%E5%8F%91%E5%B8%83"><span class="toc-number">5.2.2.</span> <span class="toc-text">配置生产环境配置：让网站准备好发布</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE%EF%BC%9A%E5%AF%86%E9%92%A5%E7%9A%84%E5%AD%98%E5%82%A8%E5%92%8C%E7%AE%A1%E7%90%86"><span class="toc-number">5.2.3.</span> <span class="toc-text">配置生产环境配置：密钥的存储和管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%89%8D%E7%9A%84%E5%AE%89%E5%85%A8%E6%A3%80%E6%9F%A5"><span class="toc-number">5.2.4.</span> <span class="toc-text">部署前的安全检查</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E5%88%B0%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83"><span class="toc-number">5.2.5.</span> <span class="toc-text">部署到生产环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Django-%E5%BA%94%E7%94%A8%E5%AE%B9%E5%99%A8"><span class="toc-number">5.2.6.</span> <span class="toc-text">Django 应用容器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%B0%B4%E5%B9%B3%E6%89%A9%E5%B1%95%EF%BC%9A%E4%BD%BF%E7%94%A8%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">5.3.</span> <span class="toc-text">应用水平扩展：使用负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AETenine"><span class="toc-number">5.3.1.</span> <span class="toc-text">安装配置Tenine</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Tengine-%E7%9A%84%E5%88%86%E6%B5%81%E7%AD%96%E7%95%A5"><span class="toc-number">5.3.2.</span> <span class="toc-text">Tengine 的分流策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5%E8%87%AA%E5%8A%A8%E5%AE%B9%E9%94%99"><span class="toc-number">5.3.3.</span> <span class="toc-text">健康检查自动容错</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8CDN%E5%8A%A0%E9%80%9F"><span class="toc-number">5.4.</span> <span class="toc-text">使用CDN加速</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%A5%E5%85%A5%E7%9B%91%E6%8E%A7%E5%91%8A%E8%AD%A6"><span class="toc-number">5.5.</span> <span class="toc-text">接入监控告警</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E5%AE%89%E5%85%A8"><span class="toc-number">6.</span> <span class="toc-text">生产环境中的安全</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%9F%E4%BA%A7%E7%8E%AF%E5%A2%83%E7%9A%84%E5%AE%89%E5%85%A8%E8%AE%BE%E8%AE%A1"><span class="toc-number">6.1.</span> <span class="toc-text">生产环境的安全设计</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#WAF-%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">6.1.1.</span> <span class="toc-text">WAF 防火墙</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E9%98%B2%E7%81%AB%E5%A2%99"><span class="toc-number">6.1.2.</span> <span class="toc-text">系统防火墙</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E5%AE%89%E5%85%A8"><span class="toc-number">6.2.</span> <span class="toc-text">应用安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E6%81%B6%E6%84%8F%E5%AF%86%E7%A0%81%E6%94%BB%E5%87%BB"><span class="toc-number">6.2.1.</span> <span class="toc-text">防恶意密码攻击</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BF%E9%97%AE%E9%99%90%E6%B5%81-%E2%80%93-%E9%98%B2%E6%81%B6%E6%84%8F%E6%94%BB%E5%87%BB"><span class="toc-number">6.2.2.</span> <span class="toc-text">访问限流 – 防恶意攻击:</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84%E5%AE%89%E5%85%A8"><span class="toc-number">6.3.</span> <span class="toc-text">架构安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E7%9A%84%E9%83%A8%E7%BD%B2%E6%9E%B6%E6%9E%84"><span class="toc-number">6.3.1.</span> <span class="toc-text">应用的部署架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E9%92%A5%E5%AD%98%E5%82%A8"><span class="toc-number">6.3.2.</span> <span class="toc-text">密钥存储</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%AE%89%E5%85%A8"><span class="toc-number">6.4.</span> <span class="toc-text">数据安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Let%E2%80%99s-Encrypt-SSL-%E8%AF%81%E4%B9%A6%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">6.4.1.</span> <span class="toc-text">Let’s Encrypt SSL 证书的使用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Let%E2%80%99s-Encrypt-SSL-%E8%AF%81%E4%B9%A6%E7%BB%AD%E6%9C%9F"><span class="toc-number">6.4.2.</span> <span class="toc-text">Let’s Encrypt SSL 证书续期</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%8F%E6%84%9F%E6%95%B0%E6%8D%AE%E5%8A%A0%E5%AF%86"><span class="toc-number">6.4.3.</span> <span class="toc-text">敏感数据加密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%84%B1%E6%95%8F"><span class="toc-number">6.4.4.</span> <span class="toc-text">日志脱敏</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E5%AE%89%E5%85%A8%E4%B8%8E%E4%B8%9A%E5%8A%A1%E5%AE%89%E5%85%A8"><span class="toc-number">6.5.</span> <span class="toc-text">密码安全与业务安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E7%AD%96%E7%95%A5"><span class="toc-number">6.5.1.</span> <span class="toc-text">密码策略</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5"><span class="toc-number">6.5.2.</span> <span class="toc-text">密码过期策略</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%91%E7%8E%AF%E5%A2%83%E4%B8%AD%E7%9A%84%E9%83%A8%E7%BD%B2"><span class="toc-number">7.</span> <span class="toc-text">云环境中的部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#docker%E5%AE%B9%E5%99%A8"><span class="toc-number">7.1.</span> <span class="toc-text">docker容器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8-Dockerfile"><span class="toc-number">7.1.1.</span> <span class="toc-text">用容器部署应用 Dockerfile</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%A8%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8-Docker-compose"><span class="toc-number">7.1.2.</span> <span class="toc-text">用容器部署应用 Docker compose</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E5%8C%96-Django-%E5%BA%94%E7%94%A8"><span class="toc-number">7.2.</span> <span class="toc-text">容器化 Django 应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92-%E2%80%93-docker-compose"><span class="toc-number">7.3.</span> <span class="toc-text">容器编排 – docker compose</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kubernates%E7%9A%84%E4%BB%8B%E7%BB%8D"><span class="toc-number">7.4.</span> <span class="toc-text">kubernates的介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E9%98%BF%E9%87%8C%E4%BA%91%E4%B8%8A%E6%90%AD%E5%BB%BAkubernates%E9%9B%86%E7%BE%A4"><span class="toc-number">7.5.</span> <span class="toc-text">在阿里云上搭建kubernates集群</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E7%9B%91%E6%8E%A7%E5%AE%B9%E5%99%A8%E4%B8%AD%E7%9A%84Django%E5%BA%94%E7%94%A8"><span class="toc-number">7.6.</span> <span class="toc-text">管理监控容器中的Django应用</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86%E4%B8%8E%E6%9F%A5%E8%AF%A2"><span class="toc-number">7.7.</span> <span class="toc-text">应用日志收集与查询</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BA%91%E7%8E%AF%E5%A2%83%E4%B8%8B%E7%9A%84%E6%8C%81%E7%BB%AD%E9%9B%86%E6%88%90"><span class="toc-number">8.</span> <span class="toc-text">云环境下的持续集成</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#CI-CD%E7%9A%84%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">8.1.</span> <span class="toc-text">CI&#x2F;CD的工作流程</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CI-CD%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">8.2.</span> <span class="toc-text">CI&#x2F;CD的使用</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3%E5%BC%80%E5%8F%91%E8%BF%87%E7%A8%8B"><span class="toc-number">9.</span> <span class="toc-text">快速迭代开发过程</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BF%AB%E9%80%9F%E8%BF%AD%E4%BB%A3%E7%9A%84%E4%BB%B7%E5%80%BC%E4%B8%8E%E6%8C%91%E6%88%98"><span class="toc-number">9.1.</span> <span class="toc-text">快速迭代的价值与挑战</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-OOPD-%E6%96%B9%E6%B3%95%E8%AF%86%E5%88%AB%E4%BA%A7%E5%93%81%E6%A0%B8%E5%BF%83%E5%8A%9F%E8%83%BD"><span class="toc-number">9.2.</span> <span class="toc-text">使用 OOPD 方法识别产品核心功能</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E5%81%9A%E5%A5%BD%E6%8A%80%E6%9C%AF%E6%96%B9%E6%A1%88%E8%AE%BE%E8%AE%A1%E4%B8%8E%E5%B7%A5%E4%BD%9C%E6%8B%86%E8%A7%A3"><span class="toc-number">9.3.</span> <span class="toc-text">如何做好技术方案设计与工作拆解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E4%BA%A4%E4%BB%98%E8%B4%A8%E9%87%8F%E5%92%8C%E6%8C%81%E7%BB%AD%E8%BF%AD%E4%BB%A3"><span class="toc-number">9.4.</span> <span class="toc-text">如何保证交付质量和持续迭代</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/afe9ffa9/" title="家用服务器搭建使用指南"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202311032207863.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="家用服务器搭建使用指南"/></a><div class="content"><a class="title" href="/posts/afe9ffa9/" title="家用服务器搭建使用指南">家用服务器搭建使用指南</a><time datetime="2023-11-03T14:02:36.000Z" title="发表于 2023-11-03 22:02:36">2023-11-03</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7ac9a020/" title="k8s-informer深入学习"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-8.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="k8s-informer深入学习"/></a><div class="content"><a class="title" href="/posts/7ac9a020/" title="k8s-informer深入学习">k8s-informer深入学习</a><time datetime="2022-12-01T09:56:52.000Z" title="发表于 2022-12-01 17:56:52">2022-12-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/89a3df7f/" title="go刷题基础篇"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-12.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="go刷题基础篇"/></a><div class="content"><a class="title" href="/posts/89a3df7f/" title="go刷题基础篇">go刷题基础篇</a><time datetime="2022-09-18T22:21:26.000Z" title="发表于 2022-09-19 06:21:26">2022-09-19</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d36c6e2c/" title="istio基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-2.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="istio基础"/></a><div class="content"><a class="title" href="/posts/d36c6e2c/" title="istio基础">istio基础</a><time datetime="2022-08-04T14:42:19.000Z" title="发表于 2022-08-04 22:42:19">2022-08-04</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/e385a1/" title="rust基础"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-10.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="rust基础"/></a><div class="content"><a class="title" href="/posts/e385a1/" title="rust基础">rust基础</a><time datetime="2022-07-26T00:01:34.000Z" title="发表于 2022-07-26 08:01:34">2022-07-26</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By SetCreed</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://unpkg.com/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>