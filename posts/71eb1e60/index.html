<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>集群技术 | 伊甸园</title><meta name="author" content="SetCreed"><meta name="copyright" content="SetCreed"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="群集技术介绍 保证业务可用性是一切工作的基础 丧失可用性的安全毫无意义 消灭单点故障隐患是提高可用性的主要手段 从单机、多机再到网络所有节点的冗余 多机实现容错通常被称为群集（Cluster） 负载均衡群集 &#x2F; HA （高可用）&#x2F; 服务器群集（关键在于是否同步数据），服务器群集能达到数据和会话的同步，而负载均衡群集第一台服务器宕机了，第二台服务器你就要重新和它建立连接。  服务器群集 共享存储（存">
<meta property="og:type" content="article">
<meta property="og:title" content="集群技术">
<meta property="og:url" content="https://setcreed.github.io/posts/71eb1e60/index.html">
<meta property="og:site_name" content="伊甸园">
<meta property="og:description" content="群集技术介绍 保证业务可用性是一切工作的基础 丧失可用性的安全毫无意义 消灭单点故障隐患是提高可用性的主要手段 从单机、多机再到网络所有节点的冗余 多机实现容错通常被称为群集（Cluster） 负载均衡群集 &#x2F; HA （高可用）&#x2F; 服务器群集（关键在于是否同步数据），服务器群集能达到数据和会话的同步，而负载均衡群集第一台服务器宕机了，第二台服务器你就要重新和它建立连接。  服务器群集 共享存储（存">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-6.png">
<meta property="article:published_time" content="2022-03-02T15:04:24.000Z">
<meta property="article:modified_time" content="2022-03-02T15:04:24.000Z">
<meta property="article:author" content="SetCreed">
<meta property="article:tag" content="hexo、code、dream">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-6.png"><link rel="shortcut icon" href="/img/favicon.ico"><link rel="canonical" href="https://setcreed.github.io/posts/71eb1e60/index.html"><link rel="preconnect" href="//cdnjs.cloudflare.com"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.33/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"距离上次更新已经过了","messageNext":"天，文章所描述的内容可能已经发生变化，请留意。"},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":500},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#1f1f1f","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdnjs.cloudflare.com/ajax/libs/egjs-infinitegrid/4.11.1/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '集群技术',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-03-02 23:04:24'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
        if (t === 'dark') activateDarkMode()
        else if (t === 'light') activateLightMode()
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/custom/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/custom/icon.css" media="defer" onload="this.media='all'"><meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="伊甸园" type="application/atom+xml">
</head><body><div id="loading-box"><div class="loading-left-bg"></div><div class="loading-right-bg"></div><div class="spinner-box"><div class="configure-border-1"><div class="configure-core"></div></div><div class="configure-border-2"><div class="configure-core"></div></div><div class="loading-word">加载中...</div></div></div><script>(()=>{
  const $loadingBox = document.getElementById('loading-box')
  const $body = document.body
  const preloader = {
    endLoading: () => {
      $body.style.overflow = ''
      $loadingBox.classList.add('loaded')
    },
    initLoading: () => {
      $body.style.overflow = 'hidden'
      $loadingBox.classList.remove('loaded')
    }
  }

  preloader.initLoading()
  window.addEventListener('load',() => { preloader.endLoading() })

  if (false) {
    document.addEventListener('pjax:send', () => { preloader.initLoading() })
    document.addEventListener('pjax:complete', () => { preloader.endLoading() })
  }
})()</script><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/cloudnative/"><i class="fa-fw fas fa-cloud"></i><span> 云原生</span></a></li><li><a class="site-page child" href="/golang/"><i class="fa-fw fa-brands fa-golang"></i><span> Golang编程</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-6.png')"><nav id="nav"><span id="blog-info"><a href="/" title="伊甸园"><span class="site-name">伊甸园</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fa fa-book"></i><span> 文章</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 归档</span></a></li><li><a class="site-page child" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> 标签</span></a></li><li><a class="site-page child" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></li><li><a class="site-page child" href="/cloudnative/"><i class="fa-fw fas fa-cloud"></i><span> 云原生</span></a></li><li><a class="site-page child" href="/golang/"><i class="fa-fw fa-brands fa-golang"></i><span> Golang编程</span></a></li></ul></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 生活</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/books/"><i class="fa-fw fas fa-book"></i><span> 读书</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> 影视</span></a></li><li><a class="site-page child" href="/games/"><i class="fa-fw fas fa-gamepad"></i><span> 游戏</span></a></li><li><a class="site-page child" href="/Gallery/"><i class="fa-fw fas fa-images"></i><span> 图库</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">集群技术</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2022-03-02T15:04:24.000Z" title="发表于 2022-03-02 23:04:24">2022-03-02</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-03-02T15:04:24.000Z" title="更新于 2022-03-02 23:04:24">2022-03-02</time></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.1k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>26分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="集群技术"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="群集技术介绍"><a href="#群集技术介绍" class="headerlink" title="群集技术介绍"></a>群集技术介绍</h1><ul>
<li>保证业务可用性是一切工作的基础</li>
<li>丧失可用性的安全毫无意义</li>
<li>消灭单点故障隐患是提高可用性的主要手段</li>
<li>从单机、多机再到网络所有节点的冗余</li>
<li>多机实现容错通常被称为群集（Cluster）</li>
<li>负载均衡群集 / HA （高可用）/ 服务器群集（关键在于是否同步数据），服务器群集能达到数据和会话的同步，而负载均衡群集第一台服务器宕机了，第二台服务器你就要重新和它建立连接。</li>
</ul>
<h2 id="服务器群集"><a href="#服务器群集" class="headerlink" title="服务器群集"></a>服务器群集</h2><ul>
<li>共享存储（存储设备价格比较贵）</li>
<li>基于块设备复制（趋势、廉价）</li>
</ul>
<p>原来构建群集服务器的时候有两台服务器，A、B服务器同时连上一个很贵的存储设备，必须要有三个硬件盒子，把它们连接起来配置好，才能构成以前的群集的。因为中间的存储盒子是很贵的，现在为了节省成本，把中间的存储设备砍掉，砍掉之后变成了A、B两台服务器，那怎么实现数据的同步、数据的移植呢？以前所有的数据所有的群集数据资源都是放在共享的磁盘存储柜里面的，数据就存在那，你只是前端换了一个应用来读取刚才的数据、会话。所以之前的群集这么构建，原因就在于数据永远存在后端的存储设备里面，而存储设备从硬件打造上面可用性非常的强，它出现故障的可能性非常低，磁盘柜里面又有大量的磁盘做冗余和备份，所以基于它自身存储设备的可用性很高，拿它就不当单点故障隐患了，再配合前端几个跑应用的服务器，这样共同来搭建群集。之前之所以这么做，就是因为数据永远存在那一个地方，数据在那个地方是永远不会变的，通过一个集中的数据存储点来保证数据的一致性。</p>
<p>现在把中间的存储设备砍掉，你访问A服务器的时候数据和会话都存储在A服务器里的硬盘里面，如果A服务器出故障了，所有的访问都切换到B服务器上去，应用你是可以正常工作的，但是A里面的数据怎么才能变到B服务器里面呢？技术界里面的研发人员就想到基于块设备，所谓块设备，就像是我们计算机里面的硬盘就是一种块设备。 不是拷贝一个文件到另一个机器的硬盘上，它是把A服务器上整个硬盘存储数据的每一个扇区、每一个存储设备的块，完全照搬映射到同样大小的存储设备上。它把你整个硬盘，硬盘上每一块存储扇区，每一个存储数据的位都完完整整的复制到另一个设备上，这种方式我们就成为块设备的复制。如果A服务器和B服务器上面各有一块硬盘，做成了块设备的复制关系，这个时候，你在A服务器的硬盘上删掉一个为文件，（我们都知道，删掉一个文件操作系统并不会把这个文件对应存储上面的存储空间清零，操作系统只会把这个文件的索引位的第一个字符把它标记成删除了，但其实所有的数据都还存在硬盘里面。）B服务器上硬盘里面也有一块区域被标记删除了。所以只用服务器本地硬盘通过块复制实现彼此数据的保持。来实现群集，那么这个成本会便宜很多。</p>
<p>完整的集群并不只是解决了磁盘的数据同步这一件事情，集群其实是由多种资源组合起来构成的一个集合体。磁盘的数据同步问题可能是一个最重要的问题。</p>
<h2 id="群集资源"><a href="#群集资源" class="headerlink" title="群集资源"></a>群集资源</h2><p>群集中所有服务器共同享有的一组资源</p>
<ul>
<li>域名</li>
<li>地址</li>
<li>存储</li>
<li>硬件</li>
<li>路径</li>
<li>名称</li>
<li>在主机间漂移</li>
</ul>
<p>如果说现在A服务器作为主服务器向外提供服务访问，那B服务器就可以把自己对群集资源使用权放弃，B先不干活就在这呆着。这就好比两个人干一份工作，第一个人先干着，等干累了或者生病了，第二个人接着干。</p>
<p>所以这个服务器集群，如果就拿最简单的双节点主备集群这种最经典的、最简单的就去哪构建方式，两台服务器一台作为主节点，一台作为备用节点，平时工作只有主节点一台服务器，虽然两台机器都开机，该装的软件都装了，该配置的都配置了，但是平时只有一台服务器在干活。所以在构建群集的时候，有一半的资源是浪费的，只要发生故障了切换应用的一瞬间群集的价值才体现出来。</p>
<p>如果说构成群集的A服务器是主节点的话，所有的群集资源都由A占有。如果A出现故障了，主板烧掉了，这个时候由B节点来接管A的资源。那么B怎么知道A节点出故障了呢？构成集群的A、B两台服务器是由心跳信息来实时的互相监控的。B服务器虽然在这呆着不干活，但一直盯着A服务器，B是发送心跳数据包来探测A是否还在、应用是否正常，突然发现A不行了，B马上把A的资源抢夺过来，放在自己身上，继续向外提供服务。</p>
<ul>
<li>主机之间基于设备复制</li>
<li>保持主机间的数据同步是一切的基础</li>
</ul>
<h1 id="DRBD介绍"><a href="#DRBD介绍" class="headerlink" title="DRBD介绍"></a>DRBD介绍</h1><p>实现主机之间块设备复制的技术：</p>
<p>DRBD（Distributed Replicated Block Device），免费开源</p>
<ul>
<li>分布式设备的复制技术</li>
<li>由linbit开源</li>
<li>由Linux内核模块 +用户空间管理工具组成</li>
<li>实现服务器间设备的同步镜像（相当于跨主机的RAID 1）</li>
<li>通常采用主 / 备模式部署（Primary / Slave）</li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/pic_img/cdn_img/20200223121553.png" alt=""></p>
<p>DRBD对下，来管理物理硬盘、物理存储；对上来提供应用的访问接口；对左对右，通过网线来实现数据在不同主机之间的同步。DRBD作为一个中间节点，对上对下对左对右都是它来集中管理。另外它工作在内核层面，速度比较快。</p>
<p>在一主一备构成的群集，A服务器是主节点，对外提供服务，客户端发来的请求都给A服务器，这不是单机情况下只要把数据保存到本地那么简单了。A服务器首先要把数据写到本机的硬盘里面保存下来，通过网络将A服务器上的数据拷贝到B服务器上缓存里面，再从缓存里面写到B服务器上的硬盘里面。这要比单节点存储数据的时间要长。</p>
<p>为了同时满足，既能响应速度快一点，又能保证数据的一致性这一目标，DRBD设计了三种协议方法：</p>
<ul>
<li>A：异步复制，本地写成功后即确认，发送buffer中的数据可能丢失。由客户端发来数据给我，我就本地写，本地硬盘数据写成功了，就给客户端返回确认，数据已经接收到了。客户端就发起数据的下一次请求。但是A节点向客户端确认的时候，还没有向B节点同步数据，只是在A本地硬盘上写入了，这时候我要把它发给B节点的数据放到A节点的buffer（写缓存）中，但是写缓存没有发给B节点。如果A节点出现故障，A节点中的buffer数据就会丢失，B节点的数据可能会和A节点的数据不一致。 这个方法的响应速度是最快的，相当于单节点的速度，但是丢失数据的可能性也是最大的。</li>
<li>B：内存同步，本地写入并发送成功即确认，如掉电则数据丢失。由客户端发来数据写到本地硬盘里面，不但要写到本地硬盘，我还要把数据通过网络从A节点发送到B节点，B节点这时候接收到了，可能还没有来得及往硬盘里面去写入数据，这种情况也会存在一个短暂的时间片段A节点的数据和B节点的数据不一致。如果刚卡在那一个时间点上，A节点突然宕机，B节点也突然宕机，这时候B节点刚把数据同步到自己的内存里面，就断电了。这时候也会造成数据丢失。B方法比A方法好的一点在于，接收到的数据不但在自己确认硬盘写入了，也同时成功的将数据发给了B节点，但是B节点可能还没成功的将数据写入到硬盘里面。使用B协议的时候，响应速度可能就会比A协议慢了，因为多一步发给B节点数据的操作。</li>
<li>C：同步复制，节点全部写入成功后确认。当有客户端发来数据给第一个节点，第一个节点要把数据从内存里、缓存里写入到本地硬盘里面，然后再把数据通过网络发给第二个节点，第二个节点接收到数据再从内存里写缓存，把数据写入到硬盘里面再到确认，两个节点都确认写入后，再向客户端返回一个确认。这种做法是最能保证数据的一致性。如果说A节点B节点都宕机了，那么数据丢失AB节点数据都会丢，不会出现数据不一样的情况。要丢都丢，要写都写。这种做法响应速度是三种方法是最慢的，但能保证数据的一致性。</li>
</ul>
<p>C可最高确保数据的同步，但写入时间长，性能出于劣势。</p>
<p>作为要构成的群集的两个服务器，要各放置一个硬盘，这两个硬盘的大小无关紧要，但是要保证来两个一致，比如说都是20G硬盘。</p>
<p>要做块设备的映像，块设备的镜像是从一个服务器的硬盘上的每一个扇区、每一个block去一块一块的完全相同的给它映射复制到另一个服务器的硬盘上。因为要完整的同步，中间要有数据同步的过程。尤其当你硬盘比较大时，数据同步就比较耗时，还可能将硬盘里面原有的已经删除的数据给同步到另一台服务器的硬盘上。为了避免这些问题，会对两块硬盘做如下的操作：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">dd</span> <span class="keyword">if</span>=/dev/zero of=/dev/sdb1     <span class="comment"># 用操作系统的零生成器，产生0，填满要做块设备的硬盘，保证硬盘上没有任何的数据，这就相当于给硬盘做了一次数据擦除，给硬盘上每一个扇区每一个位填了0。</span></span><br></pre></td></tr></table></figure>
<p>这个操作是为了避免构建磁盘做数据同步的时候出现的异常情况，或者读写硬盘的混乱。</p>
<p>硬盘只能一次给一个服务器集群的节点使用，不能两个服务器同时对它读写。同时读写就会造成数据的混乱，数据的混乱对于构建群集是致命的伤害。 出现数据混乱：当硬盘挂载到A服务器的时候，你会看到一个文件，当你将硬盘挂载到B节点的时候，这个文件就没有了。原本两边的数据是应该是镜像同步一致的，但是出现读写硬盘混乱，就会导致不正常。</p>
<h1 id="DRBD安装准备"><a href="#DRBD安装准备" class="headerlink" title="DRBD安装准备"></a>DRBD安装准备</h1><h2 id="准备两台节点："><a href="#准备两台节点：" class="headerlink" title="准备两台节点："></a>准备两台节点：</h2><ul>
<li>Node 1：usrv01</li>
<li>Node 2：usrv02</li>
</ul>
<p>两个节点各增加一块硬盘，用于镜像（大小必须一致），物理磁盘、分区、RAID、LVM都可作为镜像块设备</p>
<h2 id="修改主机名"><a href="#修改主机名" class="headerlink" title="修改主机名"></a>修改主机名</h2><p>注意：因为两台节点是virtualbox克隆过来的，主机的ip地址一样，需要修改，主机名也要修改成不一样的</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/machine-id    <span class="comment"># 修改成不一样的，然后重启ip就变了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo vi /etc/cloud/cloud.cfg</span><br><span class="line"><span class="comment"># 将preserve_hostname 改为true，在修改主机名</span></span><br><span class="line">sudo vi /etc/hostname</span><br></pre></td></tr></table></figure>
<h2 id="配置域名解析"><a href="#配置域名解析" class="headerlink" title="配置域名解析"></a>配置域名解析</h2><p>我们现实的网络里面是有DNS服务器的，那么就可以给两台主机定义好名称，创建主机名和ip地址的对应关系，大家都通过DNS去域名解析。自己用虚拟机试验，可以用hosts主机文件来做域名解析</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/hosts</span><br><span class="line"><span class="comment"># 两台都增加</span></span><br><span class="line">192.168.1.110 usrv01</span><br><span class="line">192.168.1.111 usrv02</span><br></pre></td></tr></table></figure>
<h1 id="磁盘复制镜像同步"><a href="#磁盘复制镜像同步" class="headerlink" title="磁盘复制镜像同步"></a>磁盘复制镜像同步</h1><h2 id="安装drbd"><a href="#安装drbd" class="headerlink" title="安装drbd"></a>安装drbd</h2><p>安装之前先安装ntp，因为群集工作过程也要对两台服务器的时间做同步检查，保证群集里面两台服务器的系统时间一致，也是非常重要。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install ntp  <span class="comment"># 安装时间服务器</span></span><br><span class="line"></span><br><span class="line">sudo apt install drbd8-utils      <span class="comment"># 安装drbd，ubuntu仓库里面是8这个版本，也可以自己去drbd官网下载9版本</span></span><br></pre></td></tr></table></figure>
<h2 id="修改主配置文件："><a href="#修改主配置文件：" class="headerlink" title="修改主配置文件："></a>修改主配置文件：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/drbd.conf   <span class="comment"># drbd是有多个配置文件组合在一起的，但是为了省事可以把配置都写到主配置文件中。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">global &#123; usage-count no; &#125;    <span class="comment"># 全局global配置，意思就是不希望drbd的厂商收集运行在这里的系统信息</span></span><br><span class="line">common &#123; syncer &#123; rate 100M; &#125; &#125;   <span class="comment"># 磁盘做镜像同步时，对复制的速率做了限制</span></span><br><span class="line">resource r0 &#123;     <span class="comment"># 群集资源 r0，第一个复制集</span></span><br><span class="line">    protocol C;    <span class="comment"># 磁盘资源，使用C协议，同步复制</span></span><br><span class="line">    startup &#123;</span><br><span class="line">        wfc-timeout 15;      <span class="comment"># 启动了，设置两个超时时间，第一台服务器多长时间不响应了，第二台服务器去接管第一台服务器的资源使用权</span></span><br><span class="line">        degr-wfc-timeout 60;</span><br><span class="line">    &#125;</span><br><span class="line">    net &#123;</span><br><span class="line">        cram-hmac-alg sha1;      </span><br><span class="line">        shared-secret <span class="string">&quot;secret&quot;</span>;   <span class="comment"># 两台服务器复制的时候，从安全性的角度来讲，希望能够实现一下身份认证，否则网络里任何一个人都可以和我同步数据，所以必须知道密码的服务器才能跟我同步数据。两端都必须使用相同的密码才能同步数据。第一台服务器要和第二台同步数据，那第一台服务器先发一个身份信息给第二台服务器，如果第二台服务器认证了也有这个密码，就允许第一台服务器同步数据。</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    on usrv01 &#123;        <span class="comment"># 群集资源</span></span><br><span class="line">        device /dev/drbd0;      <span class="comment"># drbd0只是一个逻辑的概念</span></span><br><span class="line">        disk /dev/sdb1;</span><br><span class="line">        address 192.168.1.110:7788;</span><br><span class="line">        meta-disk internal;</span><br><span class="line">    &#125;</span><br><span class="line">    on usrv02 &#123;</span><br><span class="line">        device /dev/drbd0;</span><br><span class="line">        disk /dev/sdb1;</span><br><span class="line">        address 192.168.1.111:7788;</span><br><span class="line">        meta-disk internal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="先对硬盘sdb先分区"><a href="#先对硬盘sdb先分区" class="headerlink" title="先对硬盘sdb先分区"></a>先对硬盘sdb先分区</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo fdisk /dev/sdb</span><br></pre></td></tr></table></figure>
<h2 id="初始化元数据存储（两节点分别执行）"><a href="#初始化元数据存储（两节点分别执行）" class="headerlink" title="初始化元数据存储（两节点分别执行）"></a>初始化元数据存储（两节点分别执行）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo drbdadm create-md r0</span><br></pre></td></tr></table></figure>
<h2 id="启动服务"><a href="#启动服务" class="headerlink" title="启动服务"></a>启动服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl start drbd.service</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> drbd.service</span><br><span class="line"></span><br><span class="line">sudo drbdadm up r0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看运行状态</span></span><br><span class="line">sudo drbd-overview</span><br></pre></td></tr></table></figure>
<h2 id="指定主节点"><a href="#指定主节点" class="headerlink" title="指定主节点"></a>指定主节点</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo drbdadm -- --overwrite-data-of-peer primary all</span><br></pre></td></tr></table></figure>
<h2 id="观察同步进程（在另一节点上执行）"><a href="#观察同步进程（在另一节点上执行）" class="headerlink" title="观察同步进程（在另一节点上执行）"></a>观察同步进程（在另一节点上执行）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">watch -n1 <span class="built_in">cat</span> /proc/drbd    <span class="comment"># 每隔一秒显示一次</span></span><br></pre></td></tr></table></figure>
<h1 id="测试主备"><a href="#测试主备" class="headerlink" title="测试主备"></a>测试主备</h1><h2 id="查看每个节点的状态"><a href="#查看每个节点的状态" class="headerlink" title="查看每个节点的状态"></a>查看每个节点的状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">lsblk</span><br><span class="line">sudo drbd-overview</span><br><span class="line">sudo <span class="built_in">cat</span> /proc/drbd</span><br></pre></td></tr></table></figure>
<h2 id="格式化并挂载"><a href="#格式化并挂载" class="headerlink" title="格式化并挂载"></a>格式化并挂载</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo mkfs.ext4 /dev/drbd0     <span class="comment"># 格式化</span></span><br><span class="line"></span><br><span class="line">sudo mount /dev/drbd0 /srv/      <span class="comment"># 挂载</span></span><br></pre></td></tr></table></figure>
<h2 id="测试（主节点）"><a href="#测试（主节点）" class="headerlink" title="测试（主节点）"></a>测试（主节点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /srv/index.html     <span class="comment"># 可以写一个页面测试一下</span></span><br><span class="line">sudo umount /srv/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把自己变成备节点， 模拟主节点宕机</span></span><br><span class="line">sudo drbdadm secondary r0</span><br></pre></td></tr></table></figure>
<h2 id="测试（备节点）"><a href="#测试（备节点）" class="headerlink" title="测试（备节点）"></a>测试（备节点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo drbdadm primary r0     <span class="comment"># 把自己变成主节点</span></span><br><span class="line">sudo mount /dev/drbd0 /srv/    <span class="comment"># 发现srv下有主节点创建的页面</span></span><br></pre></td></tr></table></figure>
<ul>
<li>节点主备不会自动切换</li>
<li>不可同时做主节点并挂载</li>
<li>需要群集管理器来实现资源的在不同节点间自动切换</li>
</ul>
<h1 id="Pacemaker介绍"><a href="#Pacemaker介绍" class="headerlink" title="Pacemaker介绍"></a>Pacemaker介绍</h1><pre><code>    DRBD构建的磁盘镜像的群集只是实现了数据的同步,从一台服务器可以实时的写入到另一台服务器的硬盘里面。通过DRBD只是实现了数据的同步，但它并没有实现当一边的web服务应用宕机了，另外一遍的web服务应用会自动的起来。在终端用户看来，这时候是无法做到数据的无缝衔接的，这时候服务就会当掉，管理员必须手动参与。这不是我们想要的。

    我们想要的是完整的应用级别上的群集。我们对外提供一个服务，后端可以通过DRBD实现不同服务器上数据的同步，保证一致性。同时我们需要有一个软件或一个进程，它能够实现不同节点运行状态的判断。当第一个节点挂掉的时候，服务应用挂掉，对磁盘使用占用权已经失效的时候，工作在第二台服务器的程序或进程，它应该能及时发现这件事，这个时候，它应该主动地把这些资源的使用权以及应用服务的资源在原本备用节点的机器上抢占过来，把服务启动、硬盘挂载。

    DRBD只是实现磁盘同步数据一致的基础，有了它，我们具备了构建应用层面群集的基础，但是只有DRBD还不够，还需要群集资源管理的程序。

    构建一个应用层面的群集需要很多的资源，首先是数据，不同节点之间的数据要保持一致，这个已经通过DRBD得到解决了，可以实现数据在多台服务器上镜像同步。还有应用的服务，比如说web服务、数据库服务，那这些服务也需要作为资源加入到群集里面，由群集对它进行管理。群集资源由群集资源管理器来判断，如果第一个节点工作正常，那群集资源管理器就继续监视；但是一旦发现第一个节点工作状态出现了问题，不能对外提供服务了，群集资源管理器就会立刻在备用节点上将资源从第一台节点抢占过来，硬盘挂载、启动服务，让数据还能一致的对外提供。这是群集资源管理器该做的事情。

    而DRBD构建了磁盘镜像，它把磁盘作为一种群集资源，在多个服务器之间实现同步镜像。还需要应用服务的资源，一旦发现主节点数据库服务挂了，备用节点赶紧把服务起起来。还有一个问题就是IP地址。假如说我们构建了一个数据库服务的群集，对外提供一个数据库的服务，但是在数据库最终用户、最终使用者那边看来，他使用的其实是一个唯一的数据库服务，他连接的是一个数据库服务的ip地址。如果一台服务器的数据库服务挂了，那这个时候对外提供数据库服务的ip地址是不能发生变化的。ip地址一旦发生变化，数据库服务的使用者应用程序那边来调用你数据库服务的时候，数据库服务的ip都变了，使用者就得想办法更改ip去连接了。但是我们做群集的目的就是想让应用、使用者这一端不知道后端隐藏着多少个复杂的群集结构。他只知道去访问一个不变的ip地址。这是我们想要的达到的效果。我们想让，对用户来讲是高可用的，但是对用户的使用体验上却保持和之前完全一样，不希望当群集那边资源切换到另一边，IP地址发生了变化。

    所以这边群集资源里还包含另外一个基础的、底层的群集资源——ip地址资源，它和磁盘资源的重要性是一致的。不但磁盘数据要保持一致，还要群集对外提供服务的时候要有唯一的一个ip。当群集里一台服务器宕机，备用节点就要把那台服务器的ip地址资源抢占过来。 
</code></pre><p>群集资源统一管理：磁盘、ip地址、应用服务资源</p>
<pre><code>    群集资源管理器一方面要监视群集中每个节点的运行状态，并且由它来判断在某一时刻里面交由哪个节点去使用，同时要不停地监控群集中节点的所有状态。群集资源管理器起到一个仲裁的作用。一旦这个节点出现故障，这个资源接下来以多快的速度、什么方式把群集资源抢占到另一台服务器上，重新启用应用服务。

    在开源世界里面，在Linux上使用最多的群集资源管理器就是pacemaker。它可以构建各种大小类型的，也可以构建主主群集、主备群集等。群集资源管理器在每一个群集节点的服务器上都运行，它们之间互相通信。一旦第一台服务器出故障了，运行在第二个节点的群集资源管理器就要不断地探测第一个节点，探测了几个周期之后，如果第一个节点都没有没有回应，就判断第一个节点完蛋了，那第二个节点就马上抢占资源。如果第一个节点故障处理好了，这时候工作在第一个节点上的群集资源管理器也会和其他节点的群集资源管理器通信，知道第二个节点资源成了主节点。
</code></pre><ul>
<li>群集资源管理（CRM—— Cluster Resource Manager）</li>
<li>开源，适合各种大小（类型）群集管理（主 / 主、主 / 备）</li>
<li>基于资源级别的监测和恢复保证应用最大可用性</li>
<li>基础组件（Corosync、Heartbeat）实现群集各成员间通信和关系管理</li>
<li>Corosync：消息层组件（心跳传输），管理成员间关系、消息和仲裁</li>
<li>可使用共享存储或基于块设备的复制（DRBD）</li>
</ul>
<h1 id="pacemaker安装（两台节点）"><a href="#pacemaker安装（两台节点）" class="headerlink" title="pacemaker安装（两台节点）"></a>pacemaker安装（两台节点）</h1><p>pacemaker成为了其他群集资源的控制程序，默认情况下，希望drbd在所有的服务器上都关上，谁启用、谁占有资源由pacemaker决定。不同节点的pacemaker彼此通信，先由第一个节点工作，由第一个节点的pacemaker启动下面drbd的服务，配置群集的ip地址，启用群集相应的应用资源。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在两台节点上</span></span><br><span class="line">sudo systemctl stop drbd     <span class="comment"># 将原有的资源停掉</span></span><br><span class="line">sudo umount /srv/</span><br><span class="line">sudo drbdadm down r0</span><br><span class="line">sudo apt install -y pacemaker   <span class="comment"># 安装pacemaker</span></span><br></pre></td></tr></table></figure>
<h1 id="使用corosync信息传递组件"><a href="#使用corosync信息传递组件" class="headerlink" title="使用corosync信息传递组件"></a>使用corosync信息传递组件</h1><p>所谓的底层的信息传递组件，就是在不同节点之间互相地发送心跳信息，互相确认。在构建成群集多个节点之间，会有大量的心跳信息周期性的、不间断的发送。这些心跳信息是用来监控彼此的状态的。只有通过网络实时监视，不停的探测彼此的状态，基于这种机制，其中有一主节点挂掉之后，其他节点就会发现，发现之后才会选取一个新的节点作为主节点。</p>
<h2 id="pacemaker配置（两台节点）"><a href="#pacemaker配置（两台节点）" class="headerlink" title="pacemaker配置（两台节点）"></a>pacemaker配置（两台节点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置corosync，群集的心跳机制</span></span><br><span class="line">sudo vi /etc/corosync/corosync.conf</span><br><span class="line"><span class="comment"># 可以用下面的配置替换</span></span><br><span class="line"></span><br><span class="line">totem&#123;</span><br><span class="line">	version: 2</span><br><span class="line">	cluster_name: ubuntu    <span class="comment"># 群集名称</span></span><br><span class="line">	secauth: off     <span class="comment"># 是否启用安全身份验证的机制</span></span><br><span class="line">	transport: udpu  <span class="comment"># 通信方式</span></span><br><span class="line">	interface &#123;      <span class="comment"># 接口</span></span><br><span class="line">		ringnumber: 0</span><br><span class="line">		bindnetaddr: 172.30.91.3     <span class="comment"># bindnetaddr 就是群集中的IP地址资源，将成为统一对外提供服务的ip地址，不是本机配置的ip地址，将来 谁是主节点，就绑定在谁的网卡上。那台机器原来的ip地址不变，只是会再创建一个网卡子接口，把这个地址配置到那个子接口上</span></span><br><span class="line">		broadcast: <span class="built_in">yes</span></span><br><span class="line">		mcastport: 5405</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">nodelist &#123;       <span class="comment"># 定义群集中的两个节点</span></span><br><span class="line">	node &#123;</span><br><span class="line">		ring0_addr: 172.30.91.102</span><br><span class="line">		name: usrv01</span><br><span class="line">		nodeid: 1</span><br><span class="line">	&#125;</span><br><span class="line">	node &#123;</span><br><span class="line">		ring0_addr: 172.30.91.103</span><br><span class="line">		name: usrv02</span><br><span class="line">		nodeid: 2</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">quorum &#123;   <span class="comment"># 仲裁相关的信息</span></span><br><span class="line">	provider: corosync_votequorum</span><br><span class="line">	two_node: 1     <span class="comment"># 双节点群集</span></span><br><span class="line">	wait_for_all: 1  <span class="comment"># 群集启动是否要协调所有的节点</span></span><br><span class="line">	last_man_standing: 1</span><br><span class="line">	auto_tie_breaker: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="启动服务（两台节点）"><a href="#启动服务（两台节点）" class="headerlink" title="启动服务（两台节点）"></a>启动服务（两台节点）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart corosync</span><br><span class="line">sudo systemctl restart pacemaker</span><br></pre></td></tr></table></figure>
<p>群集管理器的框架已经搭建好了，需要把之前的ip资源、磁盘资源等纳入到群集管理器中。</p>
<h2 id="查看群集状态"><a href="#查看群集状态" class="headerlink" title="查看群集状态"></a>查看群集状态</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install crmsh</span><br><span class="line"></span><br><span class="line">sudo crm status    <span class="comment"># 需要安装crmsh</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h1 id="配置和创建群集资源"><a href="#配置和创建群集资源" class="headerlink" title="配置和创建群集资源"></a>配置和创建群集资源</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">sudo crm configure       <span class="comment"># 进入了crm的配置界面</span></span><br><span class="line"></span><br><span class="line">property stonish-enabled=<span class="literal">false</span>    <span class="comment"># 是否把出现宕机情况的节点踢出群集，改为true表示当出现故障的节点恢复之后也不会加入到群集中，被踢出群集了</span></span><br><span class="line"></span><br><span class="line">property no-quorum-policy=ignore     <span class="comment"># 多节点仲裁，选举主节点（至少三个节点），现在是在双节点上玩，就不需要了</span></span><br><span class="line"></span><br><span class="line">primitive drbd_res ocf:linbit:drbd params drbd_resource=r0 op monitor interval=29s role=Master op monitor interval=31s role=Slave</span><br><span class="line"><span class="comment"># 通过primitive指令来创建磁盘资源，使用驱动是ocf:linbit</span></span><br><span class="line"></span><br><span class="line">ms drbd_master_slave drbd_res meta master-max=1 master-node-max=1 clone-max=2 clone-node-max=1 notify=<span class="literal">true</span>     <span class="comment"># master / salve主备节点</span></span><br><span class="line"></span><br><span class="line">primitive fs_res ocf:heartbeat:Filesystem params device=/dev/drbd0 directory=/var/www/html fstype=ext4       <span class="comment"># 文件系统挂载点</span></span><br><span class="line"></span><br><span class="line">colocation fs_drbd_colo INFINITY: fs_res drbd_master_slave:Master <span class="comment"># 主备节点互相协同工作</span></span><br><span class="line"></span><br><span class="line">order fs_after_drbd mandatory: drbd_master_slave:promote fs_res:start    <span class="comment"># 启动顺序的配置</span></span><br><span class="line"></span><br><span class="line">commit    <span class="comment"># 提交</span></span><br><span class="line">show   <span class="comment"># 查看</span></span><br><span class="line">quit   <span class="comment"># 退出</span></span><br></pre></td></tr></table></figure>
<p>重启主节点测试自动切换</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart corosync.service</span><br><span class="line">sudo systemctl restart pacemaker.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待一定的时间，再重启另一个节点</span></span><br><span class="line">sudo systemctl restart corosync.service</span><br><span class="line">sudo systemctl restart pacemaker.service</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时在主节点，查看群集的磁盘是否挂载上来</span></span><br><span class="line">mount | grep drbd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 把第一个节点关机（模拟宕机），第二个节点将自己切换为主节点</span></span><br><span class="line">sudo drbd-overview      <span class="comment"># 第二个节点</span></span><br></pre></td></tr></table></figure>
<h1 id="基于heartbeat信息传递组件创建MySQL群集"><a href="#基于heartbeat信息传递组件创建MySQL群集" class="headerlink" title="基于heartbeat信息传递组件创建MySQL群集"></a>基于heartbeat信息传递组件创建MySQL群集</h1><p>主机添加第二块网卡，用作DRBD数据复制</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/setcreed/pic_img/cdn_img/20200305220532.png" alt=""></p>
<p>当有一个数据写入到第一个服务器上，按照DRBD使用协议的不同，如果使用的是C协议的话，C协议就要求数据必须在第一个节点完成写入，并且同时在第二个节点写入，两个节点都完成写入后才认为数据已经写入到硬盘，给应用返回响应。如果群集对外提供的服务比较繁忙，写入数据的操作非常的频繁，时时刻刻有大量的数据写到群集里。群集数据首先是写入到活动的第一个节点，这个节点的服务器会通过DRBD的磁盘复制机制，通过网络复制到第二个节点的磁盘上。当数据量比较少的时候，这一块网卡既要对外提供服务，又要完成数据的同步，数据量少的时候是完全可以接受的，性能上也不会有太多的影响。如果创建的是数据量访问大、像数据库应用服务的话，建议构建服务器群集时至少使用两块网卡，一块网卡对外提供应用服务，另一块网卡用作DRBD数据的同步。</p>
<h2 id="实验环境："><a href="#实验环境：" class="headerlink" title="实验环境："></a>实验环境：</h2><p>两台Ubuntu server的节点：db1、db2</p>
<ul>
<li>db1：添加1G存储硬盘，网络两个网卡，一个桥接模式，一个是内部网络</li>
<li>db2和db1一样</li>
</ul>
<h3 id="首先修改主机名"><a href="#首先修改主机名" class="headerlink" title="首先修改主机名"></a>首先修改主机名</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/cloud/cloud.cfg</span><br><span class="line"></span><br><span class="line">preserve_hostname: <span class="literal">true</span>      <span class="comment"># 改为true</span></span><br><span class="line"></span><br><span class="line">sudo vi /etc/hostname       <span class="comment"># 修改主机名 ，一台是db1，一台是db2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 我们要将节点的主机名解析到第二块网卡上绑定的ip地址</span></span><br><span class="line">sudo vi /etc/hosts      <span class="comment"># 两台都要修改</span></span><br><span class="line"><span class="comment"># 增加下列解析</span></span><br><span class="line">172.16.0.1 db1</span><br><span class="line">172.16.0.2 db2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置第二块网卡ip地址</span></span><br><span class="line">sudo vi /etc/netplan/50-cloud-init.yaml</span><br><span class="line"><span class="comment"># 我们将两台节点的第二块网卡直接用网线直连，因为它们两个之间互相数据同步，这是为了排除干扰，所以配置网络时只需要配置ip地址即可。</span></span><br><span class="line"></span><br><span class="line">network:</span><br><span class="line">    ethernets:</span><br><span class="line">        enp0s3:</span><br><span class="line">            dhcp4: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">        enp0s8:</span><br><span class="line">            addresses: [172.16.0.1/24]</span><br><span class="line">    version: 2</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment"># 重启网络</span></span><br><span class="line">sudo netplan apply</span><br></pre></td></tr></table></figure>
<h2 id="在db1和db2上安装服务"><a href="#在db1和db2上安装服务" class="headerlink" title="在db1和db2上安装服务"></a>在db1和db2上安装服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 格式化硬盘</span></span><br><span class="line">sudo <span class="built_in">echo</span> -e <span class="string">&#x27;n\np\n1\n\n\nw&#x27;</span> | sudo fdisk /dev/sdb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装DRBD和hearbeat</span></span><br><span class="line">sudo apt install drbd8-utils heartbeat -y</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动服务</span></span><br><span class="line">sudo systemctl start drbd</span><br><span class="line">sudo systemctl start heartbeat</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> drbd</span><br><span class="line">sudo systemctl <span class="built_in">enable</span> heartbeat</span><br></pre></td></tr></table></figure>
<h2 id="群集配置文件，db1和db2都配置相同"><a href="#群集配置文件，db1和db2都配置相同" class="headerlink" title="群集配置文件，db1和db2都配置相同"></a>群集配置文件，db1和db2都配置相同</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/drbd.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">global &#123; usage-count no; &#125;</span><br><span class="line">common &#123; syncer &#123; rate 100M; &#125; &#125;</span><br><span class="line">resource r0 &#123;</span><br><span class="line">    protocol C;</span><br><span class="line">    startup &#123;</span><br><span class="line">        wfc-timeout 15;</span><br><span class="line"></span><br><span class="line">        degr-wfc-timeout 60;</span><br><span class="line">    &#125;</span><br><span class="line">    net &#123;</span><br><span class="line">        cram-hmac-alg sha1;</span><br><span class="line">        shared-secret <span class="string">&quot;secret&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    on db1 &#123;</span><br><span class="line">        device /dev/drbd0;</span><br><span class="line">        disk /dev/sdb1;</span><br><span class="line">        address 172.16.0.1:7788;</span><br><span class="line">        meta-disk internal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    on db2 &#123;</span><br><span class="line">        device /dev/drbd0;</span><br><span class="line">        disk /dev/sdb1;</span><br><span class="line">        address 172.16.0.2:7788;</span><br><span class="line">        meta-disk internal;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/ha.d/ha.cf        <span class="comment"># 群集资源管理器(heartbeat)的配置</span></span><br><span class="line"><span class="comment"># 配置如下：</span></span><br><span class="line"></span><br><span class="line">keepalive 1			<span class="comment"># Check Interval   保持节点活动，每隔1秒节点之间互相检查</span></span><br><span class="line">deadtime 10			<span class="comment"># Time before server declared dead   群集节点的服务器已经确认死了等待多长时间</span></span><br><span class="line">initdead 60			<span class="comment"># Secondary wait delay at boot   启动延迟的时间，多等60秒确定对方资源服务是否已经上线</span></span><br><span class="line">auto_failback off	<span class="comment"># Auto_failback    </span></span><br><span class="line">bcast enp0s3		<span class="comment"># Heartbeat Interface</span></span><br><span class="line">node db1			<span class="comment"># Nodes to monitor</span></span><br><span class="line">node db2</span><br></pre></td></tr></table></figure>
<h2 id="群集资源-1"><a href="#群集资源-1" class="headerlink" title="群集资源"></a>群集资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 两个节点都要创建这个文件haresources</span></span><br><span class="line">sudo vi /etc/ha.d/haresources</span><br><span class="line"><span class="comment"># 写入下面的配置</span></span><br><span class="line">db1 192.168.1.200/24 drbddisk::r0 Filesystem::/dev/drbd0::/var/lib/mysql::ext4::noatime</span><br><span class="line"><span class="comment"># 192.168.1.200/24作为群集资源的ip地址，drbd的磁盘资源，文件系统/dev/drbd0，挂载上来的数据库放在/var/lib/mysql。</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="身份认证"><a href="#身份认证" class="headerlink" title="身份认证"></a>身份认证</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/ha.d/authkeys</span><br><span class="line"><span class="comment"># 加入如下配置</span></span><br><span class="line">auth1</span><br><span class="line">1 sha1 40bd001563085fc35165329ea1ff5c5ecbdbbeef</span><br><span class="line"></span><br><span class="line"><span class="comment"># sha1的哈希计算</span></span><br><span class="line"><span class="built_in">echo</span> -n 123 | <span class="built_in">sha1sum</span></span><br></pre></td></tr></table></figure>
<h2 id="设置身份认证的权限"><a href="#设置身份认证的权限" class="headerlink" title="设置身份认证的权限"></a>设置身份认证的权限</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo <span class="built_in">chmod</span> 600 /etc/ha.d/authkeys</span><br></pre></td></tr></table></figure>
<h2 id="创建drbd磁盘资源"><a href="#创建drbd磁盘资源" class="headerlink" title="创建drbd磁盘资源"></a>创建drbd磁盘资源</h2><p>节点1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo drbdadm create-md r0</span><br><span class="line">sudo systemctl restart drbd</span><br><span class="line">sudo drbdadm -- --overwrite-data-of-peer primary all</span><br><span class="line">sudo drbdadm primary r0</span><br><span class="line">sudo mkfs.ext4 /dev/drbd0</span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /etc/ha.d/authkeys</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">mkdir</span> /var/lib/mysql</span><br></pre></td></tr></table></figure>
<p>在节点2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo drbdadm create-md r0</span><br><span class="line">sudo systemctl restart drbd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">chmod</span> 600 /etc/ha.d/authkeys</span><br><span class="line"></span><br><span class="line">sudo <span class="built_in">mkdir</span> /var/lib/mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 等待硬盘的同步</span></span><br></pre></td></tr></table></figure>
<h2 id="启动服务（BOTH）"><a href="#启动服务（BOTH）" class="headerlink" title="启动服务（BOTH）"></a>启动服务（BOTH）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart heartbeat</span><br></pre></td></tr></table></figure>
<h2 id="验证IP资源、硬盘资源"><a href="#验证IP资源、硬盘资源" class="headerlink" title="验证IP资源、硬盘资源"></a>验证IP资源、硬盘资源</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ip a    <span class="comment"># 查看ip资源是否在</span></span><br><span class="line"></span><br><span class="line">sudo mount | grep drbd   <span class="comment"># 查看硬盘资源</span></span><br></pre></td></tr></table></figure>
<h2 id="安装MariaDB"><a href="#安装MariaDB" class="headerlink" title="安装MariaDB"></a>安装MariaDB</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install mariadb-server   <span class="comment"># 在两台节点上安装</span></span><br><span class="line"></span><br><span class="line">sudo mysql_secure_installation     <span class="comment"># 安全设置</span></span><br></pre></td></tr></table></figure>
<p>禁用MySQL服务自动启动</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl <span class="built_in">disable</span> mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这是为了 服务启动控制权交给群集控制，两个节点都要禁用掉</span></span><br></pre></td></tr></table></figure>
<p>停止备用节点服务</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl stop mysql     <span class="comment"># 将db2的mysql服务停止</span></span><br><span class="line">sudo <span class="built_in">rm</span> -rf /var/lib/mysql/*     <span class="comment"># db2的数据都应该来自db1主节点的数据同步，不应该是自己产生的</span></span><br></pre></td></tr></table></figure>
<p>在第一个节点进行MySQL配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo mysql</span><br><span class="line">create user <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;192.168.1.%&#x27;</span> identified by <span class="string">&#x27;password&#x27;</span>;</span><br><span class="line">grant all privileges on *.* to <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;192.168.1.%&#x27;</span> with grant option;</span><br><span class="line">flush privileges;</span><br><span class="line">quit;</span><br></pre></td></tr></table></figure>
<p>将节点修改侦听端口，两个都要修改</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo sed -i <span class="string">&#x27;s/127.0.0.1/0.0.0.0/g&#x27;</span> /etc/mysql/mariadb.conf.d/*.cnf</span><br></pre></td></tr></table></figure>
<p>将数据库服务资源加入到群集，两个节点都要做</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo vi /etc/ha.d/haresources</span><br><span class="line"></span><br><span class="line">db1 192.168.1.200/24 drbddisk::r0 Filesystem::/dev/drbd0::/var/lib/mysql::ext4::noatime mysql</span><br></pre></td></tr></table></figure>
<p>双节点重启服务(先db1后db2)</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo systemctl restart heartbeat</span><br><span class="line"><span class="comment"># db1 重启之后等待 1分钟左右，再重启db2</span></span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在宿主机上远程连接数据库, ip是群集的ip地址</span></span><br><span class="line">mysql -h 192.168.1.200 -u root -p</span><br><span class="line"><span class="comment"># 创建一个测试库，验证使用</span></span><br><span class="line">create database <span class="built_in">test</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 模拟第一个节点出现故障</span></span><br><span class="line">sudo reboot</span><br><span class="line"></span><br><span class="line"><span class="comment"># 再次远程连接数据库</span></span><br></pre></td></tr></table></figure>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://setcreed.github.io">SetCreed</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://setcreed.github.io/posts/71eb1e60/">https://setcreed.github.io/posts/71eb1e60/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://setcreed.github.io" target="_blank">伊甸园</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-6.png" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdnjs.cloudflare.com/ajax/libs/butterfly-extsrc/1.1.3/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/51c3235/" title="LDAP"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-7.jpeg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">LDAP</div></div></a></div><div class="next-post pull-right"><a href="/posts/2043ab6e/" title="centos7安装使用容器"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-4.png" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">centos7安装使用容器</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="/img/avatar.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">SetCreed</div><div class="author-info__description">读书、写代码、看电影</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">89</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">37</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">27</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/setcreed"><i class="fab fa-github"></i><span>Follow Me</span></a><div class="card-info-social-icons is-center"><a class="social-icon" href="/img/qq.jpg" target="_blank" title="QQ"><i class="fab fa-qq"></i></a><a class="social-icon" href="/img/wechat_account.jpg" target="_blank" title="微信"><i class="fab fa-weixin"></i></a><a class="social-icon" href="https://github.com/setcreed" target="_blank" title="Github"><i class="fab fa-github"></i></a><a class="social-icon" href="mailto:cwzdzg@foxmail.com" target="_blank" title="Email"><i class="fas fa-envelope"></i></a><a class="social-icon" href="/atom.xml" target="_blank" title="RSS"><i class="fas fa-rss"></i></a></div></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">This is my Blog</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BE%A4%E9%9B%86%E6%8A%80%E6%9C%AF%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">群集技术介绍</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%BE%A4%E9%9B%86"><span class="toc-number">1.1.</span> <span class="toc-text">服务器群集</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BE%A4%E9%9B%86%E8%B5%84%E6%BA%90"><span class="toc-number">1.2.</span> <span class="toc-text">群集资源</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DRBD%E4%BB%8B%E7%BB%8D"><span class="toc-number">2.</span> <span class="toc-text">DRBD介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#DRBD%E5%AE%89%E8%A3%85%E5%87%86%E5%A4%87"><span class="toc-number">3.</span> <span class="toc-text">DRBD安装准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%87%86%E5%A4%87%E4%B8%A4%E5%8F%B0%E8%8A%82%E7%82%B9%EF%BC%9A"><span class="toc-number">3.1.</span> <span class="toc-text">准备两台节点：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">3.2.</span> <span class="toc-text">修改主机名</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%9F%9F%E5%90%8D%E8%A7%A3%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text">配置域名解析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%A3%81%E7%9B%98%E5%A4%8D%E5%88%B6%E9%95%9C%E5%83%8F%E5%90%8C%E6%AD%A5"><span class="toc-number">4.</span> <span class="toc-text">磁盘复制镜像同步</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85drbd"><span class="toc-number">4.1.</span> <span class="toc-text">安装drbd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%AE%E6%94%B9%E4%B8%BB%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-number">4.2.</span> <span class="toc-text">修改主配置文件：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%88%E5%AF%B9%E7%A1%AC%E7%9B%98sdb%E5%85%88%E5%88%86%E5%8C%BA"><span class="toc-number">4.3.</span> <span class="toc-text">先对硬盘sdb先分区</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96%E5%85%83%E6%95%B0%E6%8D%AE%E5%AD%98%E5%82%A8%EF%BC%88%E4%B8%A4%E8%8A%82%E7%82%B9%E5%88%86%E5%88%AB%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-number">4.4.</span> <span class="toc-text">初始化元数据存储（两节点分别执行）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1"><span class="toc-number">4.5.</span> <span class="toc-text">启动服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8C%87%E5%AE%9A%E4%B8%BB%E8%8A%82%E7%82%B9"><span class="toc-number">4.6.</span> <span class="toc-text">指定主节点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%A7%82%E5%AF%9F%E5%90%8C%E6%AD%A5%E8%BF%9B%E7%A8%8B%EF%BC%88%E5%9C%A8%E5%8F%A6%E4%B8%80%E8%8A%82%E7%82%B9%E4%B8%8A%E6%89%A7%E8%A1%8C%EF%BC%89"><span class="toc-number">4.7.</span> <span class="toc-text">观察同步进程（在另一节点上执行）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%E4%B8%BB%E5%A4%87"><span class="toc-number">5.</span> <span class="toc-text">测试主备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E6%AF%8F%E4%B8%AA%E8%8A%82%E7%82%B9%E7%9A%84%E7%8A%B6%E6%80%81"><span class="toc-number">5.1.</span> <span class="toc-text">查看每个节点的状态</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%B9%B6%E6%8C%82%E8%BD%BD"><span class="toc-number">5.2.</span> <span class="toc-text">格式化并挂载</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%EF%BC%88%E4%B8%BB%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">5.3.</span> <span class="toc-text">测试（主节点）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95%EF%BC%88%E5%A4%87%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">5.4.</span> <span class="toc-text">测试（备节点）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Pacemaker%E4%BB%8B%E7%BB%8D"><span class="toc-number">6.</span> <span class="toc-text">Pacemaker介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pacemaker%E5%AE%89%E8%A3%85%EF%BC%88%E4%B8%A4%E5%8F%B0%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">pacemaker安装（两台节点）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8corosync%E4%BF%A1%E6%81%AF%E4%BC%A0%E9%80%92%E7%BB%84%E4%BB%B6"><span class="toc-number">8.</span> <span class="toc-text">使用corosync信息传递组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#pacemaker%E9%85%8D%E7%BD%AE%EF%BC%88%E4%B8%A4%E5%8F%B0%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">8.1.</span> <span class="toc-text">pacemaker配置（两台节点）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%EF%BC%88%E4%B8%A4%E5%8F%B0%E8%8A%82%E7%82%B9%EF%BC%89"><span class="toc-number">8.2.</span> <span class="toc-text">启动服务（两台节点）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E7%BE%A4%E9%9B%86%E7%8A%B6%E6%80%81"><span class="toc-number">8.3.</span> <span class="toc-text">查看群集状态</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E5%92%8C%E5%88%9B%E5%BB%BA%E7%BE%A4%E9%9B%86%E8%B5%84%E6%BA%90"><span class="toc-number">9.</span> <span class="toc-text">配置和创建群集资源</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Eheartbeat%E4%BF%A1%E6%81%AF%E4%BC%A0%E9%80%92%E7%BB%84%E4%BB%B6%E5%88%9B%E5%BB%BAMySQL%E7%BE%A4%E9%9B%86"><span class="toc-number">10.</span> <span class="toc-text">基于heartbeat信息传递组件创建MySQL群集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E7%8E%AF%E5%A2%83%EF%BC%9A"><span class="toc-number">10.1.</span> <span class="toc-text">实验环境：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A6%96%E5%85%88%E4%BF%AE%E6%94%B9%E4%B8%BB%E6%9C%BA%E5%90%8D"><span class="toc-number">10.1.1.</span> <span class="toc-text">首先修改主机名</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8db1%E5%92%8Cdb2%E4%B8%8A%E5%AE%89%E8%A3%85%E6%9C%8D%E5%8A%A1"><span class="toc-number">10.2.</span> <span class="toc-text">在db1和db2上安装服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BE%A4%E9%9B%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%EF%BC%8Cdb1%E5%92%8Cdb2%E9%83%BD%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%90%8C"><span class="toc-number">10.3.</span> <span class="toc-text">群集配置文件，db1和db2都配置相同</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BE%A4%E9%9B%86%E8%B5%84%E6%BA%90-1"><span class="toc-number">10.4.</span> <span class="toc-text">群集资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81"><span class="toc-number">10.5.</span> <span class="toc-text">身份认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E7%9A%84%E6%9D%83%E9%99%90"><span class="toc-number">10.6.</span> <span class="toc-text">设置身份认证的权限</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAdrbd%E7%A3%81%E7%9B%98%E8%B5%84%E6%BA%90"><span class="toc-number">10.7.</span> <span class="toc-text">创建drbd磁盘资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8%E6%9C%8D%E5%8A%A1%EF%BC%88BOTH%EF%BC%89"><span class="toc-number">10.8.</span> <span class="toc-text">启动服务（BOTH）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81IP%E8%B5%84%E6%BA%90%E3%80%81%E7%A1%AC%E7%9B%98%E8%B5%84%E6%BA%90"><span class="toc-number">10.9.</span> <span class="toc-text">验证IP资源、硬盘资源</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85MariaDB"><span class="toc-number">10.10.</span> <span class="toc-text">安装MariaDB</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95"><span class="toc-number">10.11.</span> <span class="toc-text">测试</span></a></li></ol></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/4f91bd66/" title="kube-apiserver更改鉴权方式"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-4.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kube-apiserver更改鉴权方式"/></a><div class="content"><a class="title" href="/posts/4f91bd66/" title="kube-apiserver更改鉴权方式">kube-apiserver更改鉴权方式</a><time datetime="2024-02-27T14:17:38.000Z" title="发表于 2024-02-27 22:17:38">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/fec34943/" title="kube-apiserver本地启动"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-1.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kube-apiserver本地启动"/></a><div class="content"><a class="title" href="/posts/fec34943/" title="kube-apiserver本地启动">kube-apiserver本地启动</a><time datetime="2024-02-27T12:44:47.000Z" title="发表于 2024-02-27 20:44:47">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/7b5f308e/" title="kubernetes组件之apiserver"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/202402272048351.jpg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="kubernetes组件之apiserver"/></a><div class="content"><a class="title" href="/posts/7b5f308e/" title="kubernetes组件之apiserver">kubernetes组件之apiserver</a><time datetime="2024-02-27T12:36:09.000Z" title="发表于 2024-02-27 20:36:09">2024-02-27</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/d99f2ea2/" title="云原生软件开发模式"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-11.png" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="云原生软件开发模式"/></a><div class="content"><a class="title" href="/posts/d99f2ea2/" title="云原生软件开发模式">云原生软件开发模式</a><time datetime="2023-11-25T14:31:18.000Z" title="发表于 2023-11-25 22:31:18">2023-11-25</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b43710ac/" title="容器共享进程命名空间的应用"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://setcreed.oss-cn-shanghai.aliyuncs.com/images/material-13.jpeg" onerror="this.onerror=null;this.src='/img/404.jpg'" alt="容器共享进程命名空间的应用"/></a><div class="content"><a class="title" href="/posts/b43710ac/" title="容器共享进程命名空间的应用">容器共享进程命名空间的应用</a><time datetime="2023-11-22T22:39:35.000Z" title="发表于 2023-11-23 06:39:35">2023-11-23</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By SetCreed</div><div class="footer_custom_text"><p><a style="margin-inline:5px" target="_blank" href="https://hexo.io/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Frame-Hexo-blue?style=flat&logo=hexo" title="博客框架为 Hexo" alt="HEXO"></a><a style="margin-inline:5px" target="_blank" href="https://butterfly.js.org/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Theme-Butterfly-6513df?style=flat&logo=bitdefender" title="主题采用 Butterfly" alt="Butterfly"></a><a style="margin-inline:5px" target="_blank" href="https://github.com/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Source-Github-d021d6?style=flat&logo=GitHub" title="本站项目由 GitHub 托管" alt="GitHub"></a><a style="margin-inline:5px" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://img.shields.io/badge/Copyright-BY--NC--SA%204.0-d42328?style=flat&logo=Claris" alt="img" title="本站采用知识共享署名-非商业性使用-相同方式共享4.0国际许可协议进行许可"></a></p></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fancyapps-ui/5.0.33/fancybox/fancybox.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/vanilla-lazyload/17.8.8/lazyload.iife.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/node-snackbar/0.1.16/snackbar.min.js"></script><div class="js-pjax"></div><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js"></script></div></div></body></html>